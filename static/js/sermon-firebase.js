/**
 * sermon-firebase.js
 * Firebase ì´ˆê¸°í™”, ì €ì¥/ë¡œë“œ, ë™ê¸°í™”, ë°±ì—…/ë³µì›
 */

// ===== ë°ì´í„° ë²„ì „ ê´€ë¦¬ =====
const CONFIG_VERSION = 3; // ë²„ì „ ì—…ë°ì´íŠ¸ ì‹œ ì¦ê°€

// ===== ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì •ì˜ (ë³µêµ¬ìš©) =====
const DEFAULT_STYLES = {
  general: [
    {
      id: "dawn_expository",
      name: "ìƒˆë²½ì˜ˆë°° - ê°•í•´ì„¤êµ",
      description: "ë³¸ë¡  ì¤‘ì‹¬",
      steps: [
        {id: "title", name: "ì œëª© ì¶”ì²œ", order: 1, stepType: "step1"},
        {id: "analysis", name: "ë³¸ë¬¸ ë¶„ì„", order: 2, stepType: "step1"},
        {id: "outline", name: "ê°œìš” ì‘ì„±", order: 3, stepType: "step2"}
      ]
    },
    {
      id: "sunday_topical",
      name: "ì£¼ì¼ì˜ˆë°° - ì£¼ì œì„¤êµ",
      description: "ì£¼ì œ ì¤‘ì‹¬",
      steps: [
        {id: "title", name: "ì œëª© ì¶”ì²œ", order: 1, stepType: "step1"},
        {id: "analysis", name: "ë³¸ë¬¸ ë¶„ì„", order: 2, stepType: "step1"},
        {id: "outline", name: "ê°œìš” ì‘ì„±", order: 3, stepType: "step2"}
      ]
    }
  ],
  series: [
    {
      id: "series_continuous",
      name: "ìˆ˜ìš”ì˜ˆë°° - ì—°ì†ê°•í•´",
      description: "ì‹œë¦¬ì¦ˆí˜• ê°•í•´",
      steps: [
        {id: "title", name: "ì œëª© ì¶”ì²œ", order: 1, stepType: "step1"},
        {id: "analysis", name: "ë³¸ë¬¸ ë¶„ì„", order: 2, stepType: "step1"},
        {id: "outline", name: "ê°œìš” ì‘ì„±", order: 3, stepType: "step2"}
      ]
    }
  ]
};

// ===== ê¸°ë³¸ ì§€ì¹¨ ì •ì˜ (ìŠ¤íƒ€ì¼ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘) =====
const DEFAULT_GUIDES = {
  "3ëŒ€ì§€": {
    "step1": {
      "style": "3ëŒ€ì§€",
      "step": "step1",
      "role": "ë³¸ë¬¸ ë¶„ì„ê°€",
      "principle": "ë³¸ë¬¸ì˜ ì˜ë¯¸ë¥¼ ê°ê´€ì ìœ¼ë¡œ í•´ì„í•˜ë˜, ì ìš©ì´ë‚˜ ì„¤êµ êµ¬ì¡°ëŠ” ë‹¤ë£¨ì§€ ì•ŠëŠ”ë‹¤",
      "output_format": {
        "ë³¸ë¬¸_ê°œìš”": {
          "label": "ë³¸ë¬¸ ê°œìš”",
          "description": "ë³¸ë¬¸ì˜ ì—­ì‚¬ì  ë°°ê²½, ì €ì ì˜ë„, ë¬¸ë§¥ ìš”ì•½ì„ 3-5ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±"
        },
        "í•µì‹¬_ë‹¨ì–´_ë¶„ì„": {
          "label": "í•µì‹¬ ë‹¨ì–´ ë¶„ì„",
          "description": "ë³¸ë¬¸ì˜ ì£¼ìš” ë‹¨ì–´ 3-5ê°œì— ëŒ€í•œ ì›ì–´ ë¶„ì„",
          "per_term": {
            "ë‹¨ì–´": "í•œê¸€ ë‹¨ì–´",
            "ì›ì–´": "í—¬ë¼ì–´/íˆë¸Œë¦¬ì–´",
            "ì˜ë¯¸": "ê¸°ë³¸ ì˜ë¯¸ì™€ ë³¸ë¬¸ì—ì„œì˜ ë‰˜ì•™ìŠ¤",
            "ì‹ í•™ì _í•¨ì˜": "ì‹ í•™ì  ì˜ë¯¸ (ìˆëŠ” ê²½ìš°)"
          }
        },
        "êµ¬ì¡°_ë¶„ì„": {
          "label": "êµ¬ì¡° ë¶„ì„",
          "description": "ë³¸ë¬¸ì˜ ìì—°ìŠ¤ëŸ¬ìš´ ë‹¨ë½ êµ¬ë¶„ê³¼ íë¦„",
          "items": ["ë‹¨ë½ êµ¬ë¶„ (ì ˆ ë²”ìœ„ ëª…ì‹œ)", "ê° ë‹¨ë½ì˜ í•µì‹¬ ë‚´ìš©", "ë‹¨ë½ ê°„ ë…¼ë¦¬ì  ì—°ê²°"]
        },
        "ì£¼ìš”_ì ˆ_í•´ì„¤": {
          "label": "ì£¼ìš” ì ˆ í•´ì„¤",
          "description": "í•µì‹¬ ì ˆ 3-5ê°œì— ëŒ€í•œ ìƒì„¸ í•´ì„¤",
          "per_verse": {
            "ì ˆë²ˆí˜¸": "í•´ë‹¹ ì ˆ",
            "ë³¸ë¬¸": "ì ˆ ë‚´ìš©",
            "í•´ì„": "ë¬¸ë²•ì Â·ì‹ í•™ì  ì˜ë¯¸"
          }
        },
        "ëŒ€ì§€_í›„ë³´": {
          "label": "ëŒ€ì§€ í›„ë³´",
          "description": "ë³¸ë¬¸ì—ì„œ ë„ì¶œ ê°€ëŠ¥í•œ 3-5ê°œ í•µì‹¬ í¬ì¸íŠ¸ (ì ˆ ë²ˆí˜¸ í¬í•¨)"
        },
        "í•µì‹¬_ë©”ì‹œì§€": {
          "label": "í•µì‹¬ ë©”ì‹œì§€",
          "description": "ë³¸ë¬¸ ì „ì²´ê°€ ì „ë‹¬í•˜ëŠ” ì¤‘ì‹¬ ì§„ë¦¬ 1-2ë¬¸ì¥"
        },
        "ì‹ í•™ì _ì£¼ì œ": {
          "label": "ì‹ í•™ì  ì£¼ì œ",
          "description": "ë³¸ë¬¸ì—ì„œ ë„ì¶œë˜ëŠ” ì£¼ìš” ì‹ í•™ì  ì£¼ì œ 2-3ê°œ"
        }
      },
      "interpretation_rules": {
        "í—ˆìš©": ["ì›ì–´ ë¶„ì„", "ì—­ì‚¬ì  ë°°ê²½ ì„¤ëª…", "ë¬¸ë§¥ í•´ì„", "ì‹ í•™ì  ì˜ë¯¸ ë„ì¶œ"],
        "ê¸ˆì§€": ["í˜„ëŒ€ì  ì ìš©", "ì„¤êµ êµ¬ì¡° ì œì•ˆ", "ì˜ˆí™” ì‚½ì…", "ì²­ì¤‘ ì–¸ê¸‰"]
      },
      "quality_criteria": [
        "ë³¸ë¬¸ì— ì¶©ì‹¤í•œ í•´ì„ì¸ê°€",
        "ì£¼ìš” ì ˆì— ëŒ€í•œ í•´ì„¤ì´ ëª…í™•í•œê°€",
        "ëŒ€ì§€ í›„ë³´ê°€ 3~5ê°œ ì œê³µë˜ì—ˆëŠ”ê°€",
        "í•µì‹¬ ë©”ì‹œì§€ê°€ ë³¸ë¬¸ì—ì„œ ë„ì¶œë˜ì—ˆëŠ”ê°€"
      ]
    },
    "step2": {
      "style": "3ëŒ€ì§€",
      "step": "step2",
      "role": "ì„¤êµ êµ¬ì¡° ì„¤ê³„ì",
      "principle": "Step1ì˜ í•´ì„ê³¼ ëŒ€ì§€ í›„ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ 3ê°œì˜ ëŒ€ì§€ë¡œ êµ¬ì¡°í™”í•˜ë˜, ìƒˆë¡œìš´ í•´ì„ì„ ì¶”ê°€í•˜ì§€ ì•ŠëŠ”ë‹¤",
      "required_input": [
        "step1.í•µì‹¬_ë©”ì‹œì§€",
        "step1.ëŒ€ì§€_í›„ë³´",
        "step1.ì£¼ìš”_ì ˆ_í•´ì„¤",
        "step1.ì‹ í•™ì _ì£¼ì œ"
      ],
      "output_format": {
        "ì„¤êµ_ì œëª©": {
          "label": "ì„¤êµ ì œëª©",
          "description": "ë³¸ë¬¸ì˜ í•µì‹¬ ë©”ì‹œì§€ë¥¼ ë°˜ì˜í•œ ì œëª©"
        },
        "ì„œë¡ _ë°©í–¥": {
          "label": "ì„œë¡  ë°©í–¥",
          "description": "ì²­ì¤‘ì˜ ê´€ì‹¬ì„ ëŒê³  ë³¸ë¬¸ìœ¼ë¡œ ì´ë„ëŠ” ë„ì… ë°©í–¥ 2-3ë¬¸ì¥"
        },
        "ëŒ€ì§€_1": {
          "label": "ëŒ€ì§€ 1",
          "description": "ì²« ë²ˆì§¸ í•µì‹¬ í¬ì¸íŠ¸",
          "sub_items": {
            "ì†Œì œëª©": "ëŒ€ì§€ ì œëª©",
            "ë³¸ë¬¸_ê·¼ê±°": "ì ˆ ë²ˆí˜¸",
            "í•µì‹¬_ë‚´ìš©": "Step1 í•´ì„¤ ê¸°ë°˜ ì •ë¦¬ 3-4ë¬¸ì¥",
            "ì „ê°œ_ë°©í–¥": "ì„¤ëª…-ì˜ˆì¦-ì ìš©ì˜ ë°©í–¥ì„±"
          }
        },
        "ëŒ€ì§€_2": {
          "label": "ëŒ€ì§€ 2",
          "description": "ë‘ ë²ˆì§¸ í•µì‹¬ í¬ì¸íŠ¸",
          "sub_items": {
            "ì†Œì œëª©": "ëŒ€ì§€ ì œëª©",
            "ë³¸ë¬¸_ê·¼ê±°": "ì ˆ ë²ˆí˜¸",
            "í•µì‹¬_ë‚´ìš©": "Step1 í•´ì„¤ ê¸°ë°˜ ì •ë¦¬ 3-4ë¬¸ì¥",
            "ì „ê°œ_ë°©í–¥": "ì„¤ëª…-ì˜ˆì¦-ì ìš©ì˜ ë°©í–¥ì„±"
          }
        },
        "ëŒ€ì§€_3": {
          "label": "ëŒ€ì§€ 3",
          "description": "ì„¸ ë²ˆì§¸ í•µì‹¬ í¬ì¸íŠ¸",
          "sub_items": {
            "ì†Œì œëª©": "ëŒ€ì§€ ì œëª©",
            "ë³¸ë¬¸_ê·¼ê±°": "ì ˆ ë²ˆí˜¸",
            "í•µì‹¬_ë‚´ìš©": "Step1 í•´ì„¤ ê¸°ë°˜ ì •ë¦¬ 3-4ë¬¸ì¥",
            "ì „ê°œ_ë°©í–¥": "ì„¤ëª…-ì˜ˆì¦-ì ìš©ì˜ ë°©í–¥ì„±"
          }
        },
        "ê²°ë¡ _ë°©í–¥": {
          "label": "ê²°ë¡  ë°©í–¥",
          "description": "3ëŒ€ì§€ë¥¼ ì¢…í•©í•˜ê³  ì‚¶ì˜ ì ìš©ìœ¼ë¡œ ë§ˆë¬´ë¦¬í•˜ëŠ” ë°©í–¥ 2-3ë¬¸ì¥"
        },
        "ëŒ€ì§€_ì—°ê²°_íë¦„": {
          "label": "ëŒ€ì§€ ì—°ê²° íë¦„",
          "description": "3ê°œ ëŒ€ì§€ê°€ ì–´ë–»ê²Œ ìœ ê¸°ì ìœ¼ë¡œ ì—°ê²°ë˜ëŠ”ì§€ 2-3ë¬¸ì¥"
        }
      },
      "constraints": {
        "no_new_interpretation": "Step1ì— ì—†ëŠ” ìƒˆë¡œìš´ í•´ì„ ì¶”ê°€ ê¸ˆì§€",
        "balanced_points": "ì„¸ ëŒ€ì§€ëŠ” ë¶„ëŸ‰ê³¼ ë…¼ë¦¬ ë¹„ì¤‘ì´ ê· í˜• ìˆê²Œ",
        "from_step1_candidates": "ëŒ€ì§€ëŠ” ë°˜ë“œì‹œ Step1ì˜ ëŒ€ì§€_í›„ë³´ì—ì„œ ì„ íƒ"
      }
    },
    "step3": {
      "style": "3ëŒ€ì§€",
      "step": "step3",
      "role": "ì„¤êµë¬¸ ì‘ì„±ì",
      "principle": "Step1ì˜ í•´ì„ê³¼ Step2ì˜ êµ¬ì¡°ë¥¼ ì¶©ì‹¤íˆ ë”°ë¼ ì„¤êµë¬¸ì„ ì‘ì„±í•˜ë©°, ìƒˆë¡œìš´ í•´ì„ì´ë‚˜ êµ¬ì¡° ë³€ê²½ ì—†ì´ ê¸€ë¡œ ì™„ì„±í•œë‹¤",
      "task": "Step1+Step2 ìë£Œë¥¼ ë°”íƒ•ìœ¼ë¡œ ì™„ì„±ëœ ì„¤êµë¬¸ ì‘ì„±",
      "input_reference": {
        "Step1ì—ì„œ_ê°€ì ¸ì˜¬_ê²ƒ": "ë³¸ë¬¸_ê°œìš”, í•µì‹¬_ë‹¨ì–´_ë¶„ì„, ì£¼ìš”_ì ˆ_í•´ì„¤, í•µì‹¬_ë©”ì‹œì§€",
        "Step2ì—ì„œ_ê°€ì ¸ì˜¬_ê²ƒ": "ì„¤êµ_ì œëª©, ì„œë¡ _ë°©í–¥, ëŒ€ì§€_1/2/3, ê²°ë¡ _ë°©í–¥, ëŒ€ì§€_ì—°ê²°_íë¦„",
        "ì‹œìŠ¤í…œ_ì„¤ì •_ì°¸ì¡°": "ë¶„ëŸ‰, ëŒ€ìƒ, ì˜ˆë°°ìœ í˜• ì •ë³´ ë°˜ì˜"
      },
      "output_format": {
        "type": "ì™„ì„±ëœ ì„¤êµë¬¸ (ë§ˆí¬ë‹¤ìš´)",
        "structure": {
          "ì œëª©": "Step2ì˜ ì„¤êµ_ì œëª© ì‚¬ìš©",
          "ì•„ì´ìŠ¤ë¸Œë ˆì´í‚¹": "ì„œë¡  ì „ ì²­ì¤‘ê³¼ì˜ ë¼í¬ í˜•ì„± (ì¼ìƒ ì´ì•¼ê¸°, ê°€ë²¼ìš´ ìœ ë¨¸, ê³µê° ì§ˆë¬¸ ë“±)",
          "ì„œë¡ ": "Step2 ì„œë¡ _ë°©í–¥ì„ êµ¬ì²´ì  ê¸€ë¡œ ì „ê°œ (ì²­ì¤‘ ê³µê°, ë³¸ë¬¸ ë„ì…)",
          "ë³¸ë¡ ": {
            "ëŒ€ì§€1": "Step2 ëŒ€ì§€_1ì„ ì„¤ëª…-ì˜ˆì¦-ì ìš© êµ¬ì¡°ë¡œ ì „ê°œ",
            "ëŒ€ì§€2": "Step2 ëŒ€ì§€_2ë¥¼ ì„¤ëª…-ì˜ˆì¦-ì ìš© êµ¬ì¡°ë¡œ ì „ê°œ",
            "ëŒ€ì§€3": "Step2 ëŒ€ì§€_3ì„ ì„¤ëª…-ì˜ˆì¦-ì ìš© êµ¬ì¡°ë¡œ ì „ê°œ"
          },
          "ê²°ë¡ ": "Step2 ê²°ë¡ _ë°©í–¥ì„ êµ¬ì²´ì  ê¸€ë¡œ ì „ê°œ (ìš”ì•½, ë„ì „, ê¸°ë„)"
        },
        "ê¸¸ì´_ì¡°ì ˆ": "ì‹œìŠ¤í…œì—ì„œ ì§€ì •ëœ ë¶„ëŸ‰ì— ë§ì¶° ê° ì„¹ì…˜ ê¸¸ì´ ì¡°ì ˆ"
      },
      "writing_guidelines": {
        "ì•„ì´ìŠ¤ë¸Œë ˆì´í‚¹": {
          "ëª©ì ": "ì²­ì¤‘ì˜ ì£¼ì˜ë¥¼ ì§‘ì¤‘ì‹œí‚¤ê³  ì„¤êµìì™€ì˜ ë¼í¬ í˜•ì„±",
          "ë‚´ìš©": ["ìµœê·¼ ì¼ìƒ ì´ì•¼ê¸°", "ê°€ë²¼ìš´ ìœ ë¨¸ë‚˜ ì—í”¼ì†Œë“œ", "ì²­ì¤‘ì—ê²Œ ë˜ì§€ëŠ” ê³µê° ì§ˆë¬¸", "ì‹œì‚¬ì  ì´ìŠˆë‚˜ ê³„ì ˆ ì´ì•¼ê¸°"],
          "ë¶„ëŸ‰": "2-4ë¬¸ì¥",
          "ì£¼ì˜": "ë³¸ë¬¸ ë‚´ìš©ê³¼ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°ë˜ë„ë¡ êµ¬ì„±"
        },
        "ë¬¸ì²´": "êµ¬ì–´ì²´, ì„¤êµ í˜„ì¥ì—ì„œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ í†¤",
        "ì˜ˆí™”": "ê° ëŒ€ì§€ë‹¹ 1ê°œì˜ ì ì ˆí•œ ì˜ˆí™” ë˜ëŠ” ë¹„ìœ  í¬í•¨",
        "ì ìš©": "ê° ëŒ€ì§€ ëì— ì²­ì¤‘ì´ ì‹¤ì²œí•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì  ì ìš© í¬í•¨",
        "ì „í™˜": "ëŒ€ì§€ ê°„ ìì—°ìŠ¤ëŸ¬ìš´ ì—°ê²° ë¬¸ì¥ ì‚¬ìš©"
      },
      "interpretation_rules": {
        "í—ˆìš©": ["Step1/Step2 ë‚´ìš©ì„ ë¬¸ì¥ìœ¼ë¡œ í’€ì–´ì“°ê¸°", "ì˜ˆí™” ì¶”ê°€", "ì ìš© êµ¬ì²´í™”", "ìˆ˜ì‚¬ì  í‘œí˜„"],
        "ê¸ˆì§€": ["Step1ì— ì—†ëŠ” ìƒˆë¡œìš´ ì„±ê²½ í•´ì„", "Step2 êµ¬ì¡° ë³€ê²½", "ëŒ€ì§€ ìˆœì„œ ë³€ê²½", "ìƒˆë¡œìš´ ëŒ€ì§€ ì¶”ê°€"]
      },
      "quality_criteria": [
        "Step2ì˜ 3ëŒ€ì§€ êµ¬ì¡°ë¥¼ ì •í™•íˆ ë”°ëëŠ”ê°€",
        "Step1ì˜ í•´ì„ì´ ì™œê³¡ ì—†ì´ ë°˜ì˜ë˜ì—ˆëŠ”ê°€",
        "ê° ëŒ€ì§€ì— ì„¤ëª…-ì˜ˆì¦-ì ìš©ì´ í¬í•¨ë˜ì—ˆëŠ”ê°€",
        "ì§€ì •ëœ ë¶„ëŸ‰ì— ë§ê²Œ ì‘ì„±ë˜ì—ˆëŠ”ê°€",
        "ì„¤êµ í˜„ì¥ì—ì„œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ ë¬¸ì²´ì¸ê°€"
      ]
    }
  },
  "ê°•í•´ì„¤êµ": {
    "step1": {
      "step": "step1",
      "style": "ê°•í•´ì„¤êµ",
      "role": "ì„±ê²½ ë³¸ë¬¸ ë¶„ì„ê°€",
      "principle": "ê°•í•´ì„¤êµëŠ” ë³¸ë¬¸ì´ ë§í•˜ëŠ” ê·¸ëŒ€ë¡œ í•´ì„í•˜ëŠ” ë° ì´ˆì ì„ ë‘”ë‹¤. Step1ì€ ì„¤êµë¥¼ ìœ„í•œ í•´ì„ ì›ìë£Œë§Œ ì œê³µí•˜ë©°, ì ìš©ì´ë‚˜ ì„¤êµì  ì–¸ì–´ëŠ” í¬í•¨í•˜ì§€ ì•ŠëŠ”ë‹¤.",
      "output_format": {
        "historical_background": {
          "label": "ì—­ì‚¬Â·ì •í™© ë°°ê²½",
          "description": "ë³¸ë¬¸ì˜ ì‹œëŒ€Â·ì €ìÂ·ìˆ˜ì‹ ìÂ·ì •ì¹˜Â·ì‚¬íšŒÂ·ì§€ë¦¬Â·ì‹ ì•™ì  ìƒí™©ì„ 6-10ë¬¸ì¥ìœ¼ë¡œ ì •ë¦¬",
          "required_items": [
            "ê¸°ë¡ ì‹œê¸°",
            "ì €ìì™€ ìˆ˜ì‹ ì",
            "ë¬¸ë§¥(ì•ë’¤ ë‹¨ë½ê³¼ì˜ ì—°ê²°)",
            "ë‹¹ì‹œ ê³µë™ì²´ê°€ ì§ë©´í•œ ë¬¸ì œ",
            "ì§€ë¦¬ì Â·ë¬¸í™”ì  ë°°ê²½",
            "ì‘ì„± ëª©ì "
          ]
        },
        "literary_structure": {
          "label": "ë¬¸í•™ êµ¬ì¡°",
          "description": "ë³¸ë¬¸ì˜ ìì—°ìŠ¤ëŸ¬ìš´ ë‹¨ë½ êµ¬ë¶„ê³¼ íë¦„",
          "required_items": [
            "ë‹¨ë½ êµ¬ë¶„ (ì ˆ ë²”ìœ„ ëª…ì‹œ)",
            "ê° ë‹¨ë½ì˜ í•µì‹¬ ë‚´ìš©",
            "ë‹¨ë½ ê°„ ë…¼ë¦¬ì  ì—°ê²°"
          ],
          "example": "1-3ì ˆ: ê°ì‚¬ â†’ 4-6ì ˆ: ê¶Œë©´ â†’ 7-10ì ˆ: ê²°ë¡ "
        },
        "verse_structure": {
          "label": "ì ˆë³„ ë¶„ì„",
          "description": "ê° ì ˆì˜ ê´€ì°°(Observation) ì¤‘ì‹¬ ë¶„ì„",
          "per_verse": {
            "observation": "ë¬¸ë²•Â·ì£¼ì–´Â·ë™ì‚¬Â·í•µì‹¬ í‘œí˜„ ë¶„ì„",
            "meaning": "ë¬¸ì¥ì´ ë§í•˜ëŠ” ê°ê´€ì  ì˜ë¯¸",
            "connection": "ì•ë’¤ ì ˆê³¼ ì—°ê²°ë˜ëŠ” ë…¼ë¦¬ì  íë¦„"
          },
          "purpose": "ê°•í•´ì„¤êµì˜ í•µì‹¬ì¸ ì ˆ-by-ì ˆ í•´ì„ì˜ ê¸°ì´ˆ ìë£Œ"
        },
        "section_grouping": {
          "label": "ëŒ€ì§€ ë‹¨ìœ„ ì ˆ ê·¸ë£¹í•‘",
          "description": "Step2ì˜ 3ëŒ€ì§€ êµ¬ì„±ì„ ìœ„í•´ ì ˆì„ 3ê°œ ì„¹ì…˜ìœ¼ë¡œ ì‚¬ì „ ê·¸ë£¹í•‘",
          "format": {
            "section1": { "verses": "ì ˆ ë²”ìœ„", "theme": "ì„¹ì…˜ ì£¼ì œ í•œ ë¬¸ì¥" },
            "section2": { "verses": "ì ˆ ë²”ìœ„", "theme": "ì„¹ì…˜ ì£¼ì œ í•œ ë¬¸ì¥" },
            "section3": { "verses": "ì ˆ ë²”ìœ„", "theme": "ì„¹ì…˜ ì£¼ì œ í•œ ë¬¸ì¥" }
          },
          "note": "ì´ ê·¸ë£¹í•‘ì€ ë³¸ë¬¸ì˜ ìì—°ìŠ¤ëŸ¬ìš´ íë¦„ì„ ë”°ë¥´ë©°, Step2ì—ì„œ ì¡°ì • ê°€ëŠ¥"
        },
        "key_terms": {
          "label": "í•µì‹¬ ë‹¨ì–´Â·ì›ì–´ ë¶„ì„",
          "description": "ë³¸ë¬¸ì˜ ì£¼ìš” ë‹¨ì–´ 5-8ê°œì— ëŒ€í•œ ì›ì–´ ë¶„ì„",
          "per_term": {
            "word": "ë³¸ë¬¸ì— ë‚˜ì˜¨ ë‹¨ì–´",
            "original": "ì›ì–´ (í—¬ë¼ì–´/íˆë¸Œë¦¬ì–´)",
            "basic_meaning": "ê¸°ë³¸ ì‚¬ì „ì  ì˜ë¯¸",
            "contextual_meaning": "ë³¸ë¬¸ ì•ˆì—ì„œì˜ ë‰˜ì•™ìŠ¤",
            "theological_significance": "ì‹ í•™ì  ì˜ë¯¸ (ìˆëŠ” ê²½ìš°)"
          }
        },
        "cross_references": {
          "label": "ë³´ì¶© ì„±ê²½êµ¬ì ˆ",
          "description": "ë³¸ë¬¸ í•´ì„ì„ ê°•í™”í•˜ëŠ” ì§ì ‘ ì—°ê²° êµ¬ì ˆ 4-6ê°œ",
          "format": {
            "reference": "ì„±ê²½êµ¬ì ˆ (ì˜ˆ: ë¡¬ 8:15)",
            "connection_reason": "ë³¸ë¬¸ê³¼ ì—°ê²°ë˜ëŠ” ì´ìœ  í•œ ë¬¸ì¥"
          },
          "purpose": "ì„±ê²½ì´ ì„±ê²½ì„ í•´ì„í•˜ê²Œ í•˜ëŠ” ì›ì¹™ ì ìš©"
        },
        "author_intent": {
          "label": "ì €ì ì˜ë„",
          "description": "ì €ìê°€ ì´ ë³¸ë¬¸ì„ ê¸°ë¡í•œ ëª©ì ì„ 3-5ë¬¸ì¥ìœ¼ë¡œ ì •ë¦¬",
          "focus": "ìˆ˜ì‹ ìì—ê²Œ ì „ë‹¬í•˜ê³ ì í•œ í•µì‹¬ ë©”ì‹œì§€"
        },
        "theological_summary": {
          "label": "ì‹ í•™ì  ìš”ì•½",
          "description": "ë³¸ë¬¸ì´ ë§í•˜ëŠ” í•˜ë‚˜ë‹˜Â·ì¸ê°„Â·êµ¬ì›Â·ìˆœì¢…ì— ê´€í•œ ì‹ í•™ì  í•µì‹¬ 3-5ë¬¸ì¥",
          "exclude": ["ì ìš©", "ê¶Œë©´", "ê°ì„±ì  í‘œí˜„"],
          "focus": "ì˜¤ì§ 'ì´ ë³¸ë¬¸ì´ ì‹ í•™ì ìœ¼ë¡œ ë¬´ì—‡ì„ ë§í•˜ëŠ”ê°€'"
        },
        "logical_flow": {
          "label": "ë³¸ë¬¸ ë…¼ë¦¬ íë¦„",
          "description": "ë³¸ë¬¸ ì „ì²´ì˜ ë…¼ë¦¬ì  íë¦„ì„ í•œ ì¤„ë¡œ ì •ë¦¬",
          "example": "ìƒí™© ì œì‹œ â†’ ë¬¸ì œ ì¸ì‹ â†’ í•´ê²° ë°©í–¥ â†’ ê²°ë¡ "
        }
      }
    },
    "step2": {
      "step": "step2",
      "style": "ê°•í•´ì„¤êµ",
      "role": "ì„¤êµ êµ¬ì¡° ì„¤ê³„ì",
      "principle": "Step1ì˜ ë¶„ì„ ìë£Œë¥¼ ë°”íƒ•ìœ¼ë¡œ ì„¤êµ êµ¬ì¡°ë§Œì„ ì„¤ê³„í•œë‹¤. ìƒˆë¡œìš´ í•´ì„ì´ë‚˜ ì‹ í•™ì  ì£¼ì¥ì„ ì¶”ê°€í•˜ì§€ ì•ŠëŠ”ë‹¤.",
      "required_input": [
        "step1.section_grouping",
        "step1.literary_structure",
        "step1.theological_summary",
        "step1.key_terms (ëŒ€ì§€ë³„ 1ê°œì”©, ì´ 3ê°œ ì„ íƒ)",
        "step1.cross_references"
      ],
      "output_format": {
        "title": {
          "label": "ì„¤êµ ì œëª©",
          "description": "ë³¸ë¬¸ ì „ì²´ ë‚´ìš©ì„ ì••ì¶•í•œ ì œëª©"
        },
        "scripture_text": {
          "label": "ë³¸ë¬¸",
          "description": "ì¥ê³¼ ì ˆ ë²”ìœ„ (ì˜ˆ: ë””ëª¨ë°í›„ì„œ 1:3-8)"
        },
        "introduction": {
          "label": "ì„œë¡  êµ¬ì„±",
          "components": {
            "hook": {
              "label": "ë„ì…",
              "description": "ì²­ì¤‘ì˜ ê´€ì‹¬ì„ ë„ëŠ” ì§ˆë¬¸ì´ë‚˜ ìƒí™© 1-2ë¬¸ì¥"
            },
            "previous_context": {
              "label": "ì´ì „ ë³¸ë¬¸ ìš”ì•½",
              "description": "ì§ì „ ë³¸ë¬¸ê³¼ì˜ ì—°ê²° 3-4ë¬¸ì¥"
            },
            "historical_link": {
              "label": "ì—­ì‚¬ì  ë°°ê²½",
              "description": "ë³¸ë¬¸ ì´í•´ì— í•„ìš”í•œ ìµœì†Œí•œì˜ ë°°ê²½ 2-3ë¬¸ì¥",
              "source": "step1.historical_backgroundì—ì„œ ë°œì·Œ"
            },
            "sermon_direction": {
              "label": "ì„¤êµ ë°©í–¥",
              "description": "ì´ ì„¤êµê°€ ë‹¤ë£¨ëŠ” í•µì‹¬ ì§ˆë¬¸ ë˜ëŠ” ë©”ì‹œì§€ 1ë¬¸ì¥"
            }
          }
        },
        "big_idea": {
          "label": "í•µì‹¬ ì£¼ì œ (Big Idea)",
          "description": "ì„¤êµ ì „ì²´ë¥¼ ê´€í†µí•˜ëŠ” ë‹¨ í•˜ë‚˜ì˜ ë©”ì‹œì§€",
          "example": "í•˜ë‚˜ë‹˜ì€ ë‘ë ¤ì›€ì— ë¹ ì§„ ìë…€ì—ê²Œ ë‹´ëŒ€í•¨ì˜ ì˜ì„ ì£¼ì‹ ë‹¤"
        },
        "sermon_outline": {
          "label": "3ëŒ€ì§€ êµ¬ì¡°",
          "description": "ë³¸ë¬¸ì„ 3ê°œì˜ ëŒ€ì§€ë¡œ ë‚˜ëˆ”. Step1ì˜ section_groupingì„ ê¸°ë°˜ìœ¼ë¡œ êµ¬ì„±",
          "format": {
            "point1": {
              "title": "ëŒ€ì§€1 ì œëª©",
              "verses": "ì ˆ ë²”ìœ„ (ì˜ˆ: 3-5ì ˆ)",
              "summary": "í•µì‹¬ ë‚´ìš© 3-4ë¬¸ì¥",
              "key_term": "ì´ ëŒ€ì§€ì—ì„œ ê°•ì¡°í•  ì›ì–´ ë‹¨ì–´ (step1.key_termsì—ì„œ ì„ íƒ)",
              "supporting_verses": ["ë³´ì¶© êµ¬ì ˆ1", "ë³´ì¶© êµ¬ì ˆ2"]
            },
            "point2": {
              "title": "ëŒ€ì§€2 ì œëª©",
              "verses": "ì ˆ ë²”ìœ„",
              "summary": "í•µì‹¬ ë‚´ìš© 3-4ë¬¸ì¥",
              "key_term": "ì›ì–´ ë‹¨ì–´",
              "supporting_verses": ["ë³´ì¶© êµ¬ì ˆ1", "ë³´ì¶© êµ¬ì ˆ2"]
            },
            "point3": {
              "title": "ëŒ€ì§€3 ì œëª©",
              "verses": "ì ˆ ë²”ìœ„",
              "summary": "í•µì‹¬ ë‚´ìš© 3-4ë¬¸ì¥",
              "key_term": "ì›ì–´ ë‹¨ì–´",
              "supporting_verses": ["ë³´ì¶© êµ¬ì ˆ1", "ë³´ì¶© êµ¬ì ˆ2"]
            }
          }
        },
        "flow_connection": {
          "label": "ëŒ€ì§€ ì—°ê²° íë¦„",
          "description": "ëŒ€ì§€1 â†’ ëŒ€ì§€2 â†’ ëŒ€ì§€3ì´ ì–´ë–¤ ë…¼ë¦¬ë¡œ ì—°ê²°ë˜ëŠ”ì§€ 2-3ë¬¸ì¥"
        },
        "application_direction": {
          "label": "ì ìš© ë°©í–¥",
          "description": "Step3ì—ì„œ ì ìš©ì„ ì‘ì„±í•  ë•Œ ì°¸ê³ í•  ë°©í–¥ 2-3ë¬¸ì¥",
          "note": "êµ¬ì²´ì  ì ìš©ì€ Step3ì—ì„œ ì‘ì„±"
        },
        "conclusion_direction": {
          "label": "ê²°ë¡  ë°©í–¥",
          "description": "ì„¤êµ ê²°ë¡ ì—ì„œ ê°•ì¡°í•  í•µì‹¬ ë©”ì‹œì§€ ë°©í–¥ 1-2ë¬¸ì¥"
        }
      },
      "writing_spec": {
        "style": "ê°•í•´ì„¤êµ",
        "tone": "ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥ íë¦„, ëŒ€í™”í˜•",
        "interpretation": "ë³¸ë¬¸ì— ì¶©ì‹¤í•œ í•´ì„",
        "vocabulary": "60-80ëŒ€ ì„±ë„ë„ ì´í•´ ê°€ëŠ¥í•œ ì–´íœ˜",
        "avoid": ["ê³¼ë„í•œ ìˆ˜ì‚¬", "ê°ì •ì  ê³¼ì¥", "ë³¸ë¬¸ì— ì—†ëŠ” ìƒìƒ"]
      },
      "constraints": {
        "no_new_interpretation": "Step1ì— ì—†ëŠ” ìƒˆë¡œìš´ ì‹ í•™Â·í•´ì„ ì¶”ê°€ ê¸ˆì§€",
        "balanced_points": "ì„¸ ëŒ€ì§€ëŠ” ë¶„ëŸ‰ê³¼ ë…¼ë¦¬ ë¹„ì¤‘ì´ ê· í˜• ìˆê²Œ",
        "verse_coverage": "ë³¸ë¬¸ì˜ ëª¨ë“  ì ˆì´ ëŒ€ì§€ ì•ˆì— í¬í•¨ë˜ì–´ì•¼ í•¨"
      }
    },
    "step3": {
      "step": "step3",
      "style": "ê°•í•´ì„¤êµ",
      "role": "ì„¤êµë¬¸ ì‘ì„±ì",
      "principle": "Step1ì˜ í•´ì„ ìë£Œì™€ Step2ì˜ êµ¬ì¡°ë¥¼ ë³€ê²½ ì—†ì´ ê·¸ëŒ€ë¡œ ë°˜ì˜í•˜ì—¬ ì„¤êµë¬¸ì„ ì‘ì„±í•œë‹¤.",
      "priority_order": {
        "1_ìµœìš°ì„ ": "í™ˆí™”ë©´ ì„¤ì • (ë¶„ëŸ‰, ì˜ˆë°°ìœ í˜•, ëŒ€ìƒ, íŠ¹ë³„ì°¸ê³ ì‚¬í•­)",
        "2_í•„ìˆ˜ë°˜ì˜": "Step2 êµ¬ì¡° (3ëŒ€ì§€, ì ˆ ë²”ìœ„, supporting_verses)",
        "3_í•µì‹¬í™œìš©": "Step1 ì ˆë³„ ë¶„ì„ (verse_structure) + ì›ì–´ (key_terms)",
        "4_ì°¸ê³ í™œìš©": "Step1 ë³´ì¶© êµ¬ì ˆ (cross_references), ì €ì ì˜ë„ (author_intent)"
      },
      "required_input": [
        "step1.verse_structure",
        "step1.key_terms",
        "step1.cross_references",
        "step1.author_intent",
        "step2.sermon_outline",
        "step2.big_idea",
        "step2.introduction",
        "step2.writing_spec",
        "system_settings: frontendì—ì„œ ì „ë‹¬ë˜ëŠ” ì„¤ì •ê°’(ë¶„ëŸ‰, ëŒ€ìƒ, ì˜ˆë°°ìœ í˜•)ì„ ê·¸ëŒ€ë¡œ ë°˜ì˜"
      ],
      "use_from_step1": {
        "verse_structure": {
          "instruction": "ê° ì ˆì˜ observationÂ·meaningì„ ì„¤êµ ë³¸ë¡ ì— ìì—°ìŠ¤ëŸ½ê²Œ í’€ì–´ì„œ ê°•í•´",
          "format": "~ì ˆì„ ë³´ë©´, '~'ë¼ê³  ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì´ê²ƒì€ ~ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.",
          "priority": "í•„ìˆ˜"
        },
        "key_terms": {
          "instruction": "ê° ëŒ€ì§€ì—ì„œ ì§€ì •ëœ ì›ì–´(key_term)ë¥¼ ì„¤ëª…ì— í¬í•¨",
          "format": "ì—¬ê¸°ì„œ '~'ë¼ëŠ” ë‹¨ì–´ëŠ” í—¬ë¼ì–´ë¡œ '~'ì¸ë°, ì´ëŠ” ~ë¥¼ ëœ»í•©ë‹ˆë‹¤.",
          "frequency": "ëŒ€ì§€ë³„ 1íšŒ ì´ìƒ",
          "priority": "í•„ìˆ˜"
        },
        "cross_references": {
          "instruction": "ê° ëŒ€ì§€ì˜ supporting_versesë¥¼ ì¸ìš©í•˜ì—¬ í•´ì„ ê°•í™”",
          "format": "~ì—ì„œë„ ì´ë ‡ê²Œ ë§ì”€í•©ë‹ˆë‹¤.",
          "priority": "ê¶Œì¥"
        },
        "author_intent": {
          "instruction": "ê²°ë¡ ë¶€ì—ì„œ ì €ì ì˜ë„ë¥¼ ê°•ì¡°",
          "priority": "ê¶Œì¥"
        }
      },
      "use_from_step2": {
        "sermon_outline": {
          "instruction": "3ëŒ€ì§€ êµ¬ì¡°ì™€ ì ˆ ë²”ìœ„ë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€",
          "priority": "í•„ìˆ˜ - ë³€ê²½ ê¸ˆì§€"
        },
        "big_idea": {
          "instruction": "ì„¤êµ ì „ì²´ë¥¼ ê´€í†µí•˜ëŠ” ë©”ì‹œì§€ë¡œ ìœ ì§€, ê²°ë¡ ì—ì„œ ì¬ê°•ì¡°",
          "priority": "í•„ìˆ˜"
        },
        "introduction": {
          "instruction": "hook, previous_context, historical_link, sermon_directionì„ ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥ìœ¼ë¡œ í™•ì¥",
          "priority": "í•„ìˆ˜"
        },
        "supporting_verses": {
          "instruction": "ê° ëŒ€ì§€ì—ì„œ ì§€ì •ëœ ë³´ì¶© êµ¬ì ˆ ì¸ìš©",
          "priority": "í•„ìˆ˜"
        },
        "writing_spec": {
          "instruction": "tone, vocabulary, avoid ê·œì¹™ì„ ì„¤êµë¬¸ ì „ì²´ì— ì ìš©",
          "priority": "í•„ìˆ˜"
        }
      },
      "writing_rules": {
        "ice_breaking": {
          "label": "ì•„ì´ìŠ¤ë¸Œë ˆì´í‚¹",
          "rules": [
            "ì„œë¡  ì‹œì‘ ì „ ì²­ì¤‘ê³¼ì˜ ë¼í¬ í˜•ì„±ì„ ìœ„í•œ ì§§ì€ ë„ì…",
            "ìµœê·¼ ì¼ìƒ ì´ì•¼ê¸°, ê°€ë²¼ìš´ ìœ ë¨¸, ê³µê° ì§ˆë¬¸ ë“± í™œìš©",
            "2-4ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ êµ¬ì„±",
            "ë³¸ë¬¸ ë‚´ìš©ê³¼ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°ë˜ë„ë¡ êµ¬ì„±"
          ]
        },
        "structure": {
          "label": "ì„¤êµ êµ¬ì¡°",
          "rules": [
            "ì•„ì´ìŠ¤ë¸Œë ˆì´í‚¹ â†’ ì„œë¡  â†’ ë³¸ë¡ (ëŒ€ì§€1 â†’ ëŒ€ì§€2 â†’ ëŒ€ì§€3) â†’ ê²°ë¡  ìˆœì„œ ìœ ì§€",
            "ê° ëŒ€ì§€ëŠ” í•´ë‹¹ ì ˆ ë²”ìœ„ì˜ ë‚´ìš©ë§Œ ë‹¤ë£¸",
            "ëŒ€ì§€ ì „í™˜ ì‹œ ì—°ê²° ë¬¸ì¥ í•„ìˆ˜ (ì˜ˆ: 'ì´ì œ ë‹¤ìŒ ë¶€ë¶„ìœ¼ë¡œ ë„˜ì–´ê°€ê² ìŠµë‹ˆë‹¤')"
          ]
        },
        "verse_exposition": {
          "label": "ì ˆë³„ ê°•í•´",
          "rules": [
            "ì ˆì„ ì¸ìš©í•œ í›„ meaning ì„¤ëª…",
            "verse_structureì˜ connectionì„ í™œìš©í•˜ì—¬ íë¦„ ì—°ê²°",
            "ì ˆ ìˆœì„œëŒ€ë¡œ ì§„í–‰ (ì—­ìˆœ ë˜ëŠ” ê±´ë„ˆë›°ê¸° ê¸ˆì§€)"
          ]
        },
        "original_language": {
          "label": "ì›ì–´ í™œìš©",
          "rules": [
            "ê° ëŒ€ì§€ì—ì„œ ì§€ì •ëœ key_termì„ 1íšŒ ì´ìƒ ì„¤ëª…",
            "ì›ì–´ëŠ” ì‰¬ìš´ ì„¤ëª…ê³¼ í•¨ê»˜ ì œì‹œ",
            "ê³¼ë„í•œ í•™ë¬¸ì  ìš©ì–´ ì‚¬ìš© ê¸ˆì§€"
          ]
        },
        "scripture_citation": {
          "label": "ì„±ê²½ ì¸ìš©",
          "rules": [
            "ê° ëŒ€ì§€ì˜ supporting_verses ì¸ìš©",
            "ê°™ì€ êµ¬ì ˆ ë°˜ë³µ ì¸ìš© ê¸ˆì§€",
            "ë³¸ë¬¸ ì™¸ êµ¬ì ˆì€ supporting_versesì—ì„œë§Œ ì„ íƒ"
          ]
        },
        "application": {
          "label": "ì ìš©",
          "rules": [
            "ê° ëŒ€ì§€ ëì— ì‹ ì•™ ì ìš© ë˜ëŠ” ì¼ìƒ ì ìš© 1ê°œ",
            "ì¶”ìƒì  ê¶Œë©´ì´ ì•„ë‹Œ êµ¬ì²´ì  í–‰ë™ ì œì‹œ",
            "ê²°ë¡ ì—ì„œ ì „ì²´ ì ìš© ìš”ì•½"
          ]
        },
        "tone": {
          "label": "ì–´ì¡°",
          "rules": [
            "ëŒ€í™”í˜•Â·ì„¤ë“í˜• í†¤ ìœ ì§€",
            "ê³¼ë„í•œ ìˆ˜ì‚¬, ê°ì •ì  ê³¼ì¥ ê¸ˆì§€",
            "ëŒ€ìƒ(ì¥ë…„/ì²­ë…„/ìƒˆë²½)ì— ë§ëŠ” ì–´íœ˜ ì‚¬ìš©"
          ]
        }
      },
      "prohibitions": [
        "Step2ì˜ ëŒ€ì§€ êµ¬ì¡° ë³€ê²½ ê¸ˆì§€",
        "Step1ì— ì—†ëŠ” ìƒˆë¡œìš´ ì‹ í•™ì  ì£¼ì¥ ê¸ˆì§€",
        "ë³¸ë¬¸ì— ì—†ëŠ” ë‚´ìš© ìƒìƒ ê¸ˆì§€",
        "ëŒ€ì§€ ìˆœì„œ ë³€ê²½ ê¸ˆì§€",
        "í•´ë‹¹ ì ˆ ë²”ìœ„ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ëª…í•˜ë˜, ìì—°ìŠ¤ëŸ¬ìš´ ì—°ê²°ì„ ìœ„í•œ ìµœì†Œí•œì˜ ì•ë’¤ ì–¸ê¸‰ì€ í—ˆìš©"
      ],
      "output_structure": {
        "description": "ìˆœìˆ˜ í…ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥ (ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ ì‚¬ìš© ê¸ˆì§€)",
        "sections": [
          "ì•„ì´ìŠ¤ë¸Œë ˆì´í‚¹ (ì²­ì¤‘ ë¼í¬ í˜•ì„±, 2-4ë¬¸ì¥)",
          "ì„œë¡ ",
          "ë³¸ë¡  - ëŒ€ì§€1 (ì œëª©, ì ˆ ê°•í•´, ì›ì–´ ì„¤ëª…, ë³´ì¶© êµ¬ì ˆ, ì ìš©)",
          "ë³¸ë¡  - ëŒ€ì§€2 (ë™ì¼ êµ¬ì¡°)",
          "ë³¸ë¡  - ëŒ€ì§€3 (ë™ì¼ êµ¬ì¡°)",
          "ê²°ë¡  (ìš”ì•½, big_idea ì¬ê°•ì¡°, ê²°ë‹¨ ì´‰êµ¬)"
        ]
      }
    }
  },
  "ì£¼ì œì„¤êµ": {
    "step1": {
      "step": "step1",
      "style": "ì£¼ì œì„¤êµ",
      "role": "ì„±ê²½ ì£¼ì œ ë¶„ì„ê°€",
      "principle": "ì£¼ì œì„¤êµëŠ” 'ì£¼ì œë¥¼ ì„±ê²½ ì „ì²´ì—ì„œ ì¶”ì 'í•˜ì—¬ ì¡°ì§ì ìœ¼ë¡œ ì„¤ëª…í•´ì•¼ í•˜ë¯€ë¡œ, ë¶„ì„ í•­ëª©ì´ ê°•í•´ì„¤êµì™€ ë‹¤ë¥´ë‹¤.",
      "output_format": {
        "topic_definition": {
          "label": "ì£¼ì œ ì •ì˜",
          "description": "ì£¼ì œì˜ ì„±ê²½ì  ì˜ë¯¸ë¥¼ ì •í™•í•˜ê²Œ ì •ì˜",
          "items": [
            "ì‚¬ìš©ìê°€ ì§€ì •í•œ ì£¼ì œì˜ ì„±ê²½ì  ì •ì˜",
            "í•µì‹¬ ê°œë…ê³¼ ì‹ í•™ì  ì˜ë¯¸",
            "ì¼ë°˜ ì–¸ì–´ê°€ ì•„ë‹Œ ì„±ê²½ ì „ì²´ ê¸°ì¤€ì˜ ì •ì˜"
          ],
          "purpose": "ì£¼ì œ ë²”ìœ„ë¥¼ ëª…í™•íˆ í•˜ì—¬ í˜¼ë€ì„ ë°©ì§€"
        },
        "biblical_scope": {
          "label": "ì„±ê²½ ì „ì²´ íë¦„",
          "description": "ì„±ê²½ ì „ì²´(êµ¬ì•½â†’ì‹ ì•½)ì—ì„œ ì£¼ì œê°€ ì–´ë–»ê²Œ ì „ê°œÂ·ë°œì „í–ˆëŠ”ì§€ ì„¤ëª…",
          "items": [
            "êµ¬ì•½ì—ì„œì˜ ì£¼ì œ ì¶œë°œì ",
            "ì§€í˜œë¬¸í•™Â·ì˜ˆì–¸ì„œì—ì„œì˜ ì‹¬í™”",
            "ì˜ˆìˆ˜ë‹˜ì´ ë‹¤ë£¨ì‹  ë°©ì‹",
            "ì‚¬ë„í–‰ì „Â·ì„œì‹ ì„œì—ì„œì˜ ë°œì „",
            "ì–¸ì•½ì Â·ì—­ì‚¬ì  í™•ì¥"
          ],
          "purpose": "ì£¼ì œì„¤êµëŠ” ì„±ê²½ ì „ì²´ë¥¼ ê´€í†µí•´ì•¼ í•˜ê¸° ë•Œë¬¸"
        },
        "key_passages": {
          "label": "í•µì‹¬ ë³¸ë¬¸ 3â€“5ê°œ",
          "description": "ì£¼ì œë¥¼ ëŒ€í‘œí•˜ëŠ” ë³¸ë¬¸ ì„ ì • í›„ 2â€“3ë¬¸ì¥ ìš”ì•½",
          "items": [
            "ë³¸ë¬¸ê³¼ ì£¼ì œì˜ ê´€ê³„",
            "ì£¼ì œ í•´ì„ì— ì œê³µí•˜ëŠ” ë°©í–¥ì„±"
          ],
          "purpose": "ì„¤êµì˜ ì‹ í•™ì  ë¿Œë¦¬ ì œê³µ",
          "format": [
            {"reference": "ì„±ê²½êµ¬ì ˆ", "summary": "2-3ë¬¸ì¥ ìš”ì•½"}
          ]
        },
        "key_terms": {
          "label": "í•µì‹¬ ë‹¨ì–´Â·ì›ì–´ ë¶„ì„",
          "description": "ì£¼ì œì— ì§ì ‘ ì—°ê²°ë˜ëŠ” ì›ì–´ ë‹¨ì–´ë¥¼ ì—°êµ¬",
          "items": [
            "ì›ì–´(íˆ/í—¬)",
            "ê¸°ë³¸ ì˜ë¯¸",
            "ì„±ê²½ ì „ì²´ ì‚¬ìš© ë°©ì‹",
            "ì£¼ì œì™€ì˜ ì‹ í•™ì  ì—°ê²°ì„±"
          ],
          "purpose": "ì£¼ì œì˜ ê¹Šì´ë¥¼ í™•ë³´í•˜ê¸° ìœ„í•¨"
        },
        "theological_points": {
          "label": "ì‹ í•™ì  í•µì‹¬ 3â€“5ê°œ",
          "description": "ì£¼ì œë¥¼ ì„±ê²½Â·ì‹ í•™ì ìœ¼ë¡œ ì •ë¦¬í•˜ëŠ” í•µì‹¬ ëª…ì œë“¤",
          "purpose": "ì„¤êµì˜ ì¤‘ì‹¬ ëª…ì œë¥¼ êµ¬ì„±í•˜ëŠ” ì¬ë£Œ"
        },
        "problem_diagnosis": {
          "label": "í˜„ëŒ€ ì‹ ì•™ì¸ì˜ ë¬¸ì œ ì§„ë‹¨",
          "description": "ì´ ì£¼ì œì™€ ê´€ë ¨í•´ í˜„ëŒ€ ì„±ë„ë“¤ì´ ê²ªëŠ” ë¬¸ì œë¥¼ ë¶„ì„",
          "items": [
            "ì‹¤íŒ¨Â·ë¯¸ë˜ì— ëŒ€í•œ ê³¼ë„í•œ ë¶ˆì•ˆ",
            "ì •ì²´ì„± ê¸°ë°˜ì˜ ì•½í•¨",
            "ê´€ê³„ì™€ ê²½ìŸ êµ¬ì¡°ì—ì„œ ì˜¤ëŠ” ì§€ì†ì  ì••ë°•"
          ],
          "purpose": "ìƒìœ„ ì„¤êµ AIì˜ ì ìš© ë°©í–¥ì„ ì •í™•íˆ ì¡ê¸° ìœ„í•´"
        },
        "summary": {
          "label": "ì£¼ì œ í•´ì„ ìš”ì•½",
          "description": "ì£¼ì œì˜ ë³¸ì§ˆì„ 3â€“5ë¬¸ì¥ìœ¼ë¡œ ì‹ í•™ì ìœ¼ë¡œ ìš”ì•½",
          "exclude": ["ì ìš©", "ê°ì •", "ê¶Œë©´"],
          "focus": "ì˜¤ì§ ì‹ í•™ì  ë³¸ì§ˆë§Œ ì„œìˆ ",
          "purpose": "ìƒìœ„ ì„¤êµ ë‹¨ê³„(step2/3)ë¡œ ë„˜ì–´ê°€ê¸° ìœ„í•œ ìµœì¢… ìš”ì•½"
        }
      }
    },
    "step2": {
      "step": "step2",
      "style": "ì£¼ì œì„¤êµ",
      "role": "ì„¤êµ êµ¬ì¡° ì„¤ê³„ì",
      "principle": "Step1ì—ì„œ ì •ë¦¬ëœ ì£¼ì œ ë¶„ì„ ìë£Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„¤êµ êµ¬ì¡°ë¥¼ ì„¤ê³„í•œë‹¤. Step3ì€ ì´ êµ¬ì¡°ë¥¼ ë°˜ì˜í•´ ì„¤êµë¬¸ì„ ì‘ì„±í•œë‹¤.",
      "output_format": {
        "title": {
          "label": "ì„¤êµ ì œëª©",
          "description": "ì„¤êµì˜ ì£¼ì œë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ ëª…í™•í•˜ê²Œ í‘œí˜„"
        },
        "topic": {
          "label": "ì£¼ì œ",
          "description": "ì‚¬ìš©ìê°€ ìš”ì²­í•œ ì„¤êµ ì£¼ì œ"
        },
        "introduction_context": {
          "label": "ì„œë¡ ì„ ìœ„í•œ ë°°ê²½ ì„¤ëª…",
          "sub_items": {
            "topic_definition_summary": {
              "label": "ì£¼ì œ ì •ì˜ ìš”ì•½",
              "description": "Step1ì˜ topic_definitionì„ 3-5ë¬¸ì¥ìœ¼ë¡œ ê°„ë‹¨íˆ ìš”ì•½"
            },
            "biblical_scope_summary": {
              "label": "ì„±ê²½ ì „ì²´ íë¦„ ìš”ì•½",
              "description": "êµ¬ì•½â†’ì‹ ì•½ì˜ ì£¼ì œ íë¦„ì„ 3-5ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½"
            }
          }
        },
        "big_idea": {
          "label": "ì„¤êµ í•µì‹¬ ëª…ì œ",
          "description": "ì£¼ì œë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ëŠ” ê°•ë ¥í•œ ë©”ì‹œì§€"
        },
        "sermon_outline": {
          "label": "ì£¼ì œì„¤êµ 3ëŒ€ì§€ êµ¬ì¡°",
          "description": "ë³¸ë¬¸ íë¦„ì´ ì•„ë‹ˆë¼ 'ì£¼ì œì˜ ë…¼ë¦¬ íë¦„'ì— ë”°ë¼ 3ê°œì˜ ëŒ€ì§€ë¥¼ êµ¬ì„±",
          "format": [
            "1. ì£¼ì œì˜ ë³¸ì§ˆì€ ë¬´ì—‡ì¸ê°€?",
            "2. ì£¼ì œê°€ ì„±ê²½ ì „ì²´ì—ì„œ ì–´ë–»ê²Œ ë‚˜íƒ€ë‚˜ëŠ”ê°€?",
            "3. ì´ ì£¼ì œê°€ ì˜¤ëŠ˜ ìš°ë¦¬ì˜ ì‹ ì•™ì—ì„œ ì–´ë–¤ ì˜ë¯¸ë¥¼ ê°€ì§€ëŠ”ê°€?"
          ]
        },
        "each_point_summary": {
          "label": "ê° ëŒ€ì§€ ìš”ì•½",
          "description": "ê° ëŒ€ì§€ê°€ ë§í•˜ëŠ” í•µì‹¬ ë…¼ë¦¬ë¥¼ 5-8ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½",
          "constraints": {
            "focus": "í•´ì„ ì¤‘ì‹¬",
            "exclude": ["ì˜ˆí™”", "ê°ì •", "ì ìš©"]
          }
        },
        "key_supporting_verses_per_point": {
          "label": "ëŒ€ì§€ë³„ ë³´ì¶© ì„±ê²½êµ¬ì ˆ",
          "description": "ê° ëŒ€ì§€ë§ˆë‹¤ 2-3ê°œì”© Step1ì˜ key_passagesì—ì„œ ì„ ì •",
          "format": {
            "point1": ["êµ¬ì ˆ1", "êµ¬ì ˆ2", "êµ¬ì ˆ3"],
            "point2": ["êµ¬ì ˆ1", "êµ¬ì ˆ2"],
            "point3": ["êµ¬ì ˆ1", "êµ¬ì ˆ2", "êµ¬ì ˆ3"]
          }
        },
        "application_direction": {
          "label": "ì ìš© ë°©í–¥ì„±",
          "description": "Step3ì—ì„œ ì–´ë–¤ ë°©í–¥ìœ¼ë¡œ ì ìš©ì„ ì „ê°œí•˜ë©´ ì¢‹ì€ì§€ 3-5ì¤„ë¡œ ì œì‹œ"
        }
      },
      "writing_spec": {
        "style": "ì£¼ì œì„¤êµ",
        "tone": "ëª…ë£Œí•˜ê³  ë…¼ë¦¬ì ì´ë©° ëª©íšŒì ìœ¼ë¡œ ë”°ëœ»í•œ í†¤",
        "interpretation": "ì£¼ì œë¥¼ ì„±ê²½ ì „ì²´ì—ì„œ ê· í˜• ìˆê²Œ í•´ì„",
        "application": "ì‹¤ì œ ì‹ ì•™ì— ì—°ê²°ë˜ë„ë¡ êµ¬ì²´ì ìœ¼ë¡œ ì•ˆë‚´",
        "vocabulary": "60-80ëŒ€ ì„±ë„ë„ ì´í•´í•˜ê¸° ì‰¬ìš´ ì–´íœ˜",
        "avoid": ["ë¶ˆí•„ìš”í•œ ìˆ˜ì‚¬", "ê³¼í•œ ê°ì • í‘œí˜„", "í•™ë¬¸ì  ë‚œí•´í•¨"]
      }
    },
    "step3": {
      "step": "step3",
      "style": "ì£¼ì œì„¤êµ",
      "role": "ì„¤êµë¬¸ ì‘ì„±ì",
      "principle": "í™ˆí™”ë©´ ì„¤ì •ê°’ì„ ìµœìš°ì„ ìœ¼ë¡œ, Step1/Step2 ê²°ê³¼ë¥¼ í™œìš©í•˜ì—¬ ì£¼ì œì„¤êµë¬¸ ì‘ì„±",
      "priority_order": {
        "1_ìµœìš°ì„ ": "í™ˆí™”ë©´ ì„¤ì • (ì œëª©, ì˜ˆë°°ìœ í˜•, ë¶„ëŸ‰, ëŒ€ìƒ, íŠ¹ë³„ì°¸ê³ ì‚¬í•­)",
        "2_í•„ìˆ˜ë°˜ì˜": "Step2 êµ¬ì¡° (3ëŒ€ì§€, ê° ëŒ€ì§€ ìš”ì•½, ëŒ€ì§€ë³„ ë³´ì¶©êµ¬ì ˆ)",
        "3_ì°¸ê³ í™œìš©": "Step1 ë¶„ì„ (key_passages, key_terms, theological_points, biblical_scope)"
      },
      "use_from_step1": {
        "key_passages": {
          "instruction": "ê° ëŒ€ì§€ì—ì„œ í•µì‹¬ ë³¸ë¬¸ìœ¼ë¡œ ì¸ìš©",
          "format": "~ë§ì”€ì—ì„œ ë³´ë“¯ì´"
        },
        "key_terms": {
          "instruction": "í•µì‹¬ ë‹¨ì–´ì˜ ì›ì–´ ì˜ë¯¸ë¥¼ ì„¤êµì— ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ë‚´ê¸°",
          "format": "íˆë¸Œë¦¬ì–´/í—¬ë¼ì–´ ì›ì–´ë¡œ ~ë¼ëŠ” ëœ»ì…ë‹ˆë‹¤"
        },
        "biblical_scope": {
          "instruction": "êµ¬ì•½â†’ì‹ ì•½ íë¦„ì„ ì„œë¡ ì´ë‚˜ 2ëŒ€ì§€ì—ì„œ í™œìš©"
        },
        "theological_points": {
          "instruction": "ê° ëŒ€ì§€ì˜ í•µì‹¬ ëª…ì œë¡œ í™œìš©"
        },
        "problem_diagnosis": {
          "instruction": "ì ìš©ë¶€ì—ì„œ í˜„ëŒ€ ì„±ë„ì˜ ë¬¸ì œì™€ ì—°ê²°"
        }
      },
      "use_from_step2": {
        "sermon_outline": {
          "instruction": "3ëŒ€ì§€ êµ¬ì¡° ë°˜ë“œì‹œ ìœ ì§€ (ë…¼ë¦¬ íë¦„ ê¸°ë°˜)",
          "priority": "í•„ìˆ˜"
        },
        "each_point_summary": {
          "instruction": "ê° ëŒ€ì§€ ìš”ì•½ì„ í™•ì¥í•˜ì—¬ ë³¸ë¡  ì‘ì„±",
          "priority": "í•„ìˆ˜"
        },
        "key_supporting_verses_per_point": {
          "instruction": "ê° ëŒ€ì§€ì—ì„œ ë³´ì¶© ì„±ê²½êµ¬ì ˆ ë°˜ë“œì‹œ ì¸ìš©",
          "priority": "í•„ìˆ˜"
        },
        "big_idea": {
          "instruction": "ì„¤êµ ì „ì²´ë¥¼ ê´€í†µí•˜ëŠ” ë©”ì‹œì§€ë¡œ ìœ ì§€"
        },
        "application_direction": {
          "instruction": "ê²°ë¡ ë¶€ ì ìš©ì— ë°˜ì˜"
        }
      },
      "writing_rules": {
        "ice_breaking": {
          "label": "ì•„ì´ìŠ¤ë¸Œë ˆì´í‚¹",
          "rules": [
            "ì„œë¡  ì‹œì‘ ì „ ì²­ì¤‘ê³¼ì˜ ë¼í¬ í˜•ì„±ì„ ìœ„í•œ ì§§ì€ ë„ì…",
            "ìµœê·¼ ì¼ìƒ ì´ì•¼ê¸°, ê°€ë²¼ìš´ ìœ ë¨¸, ê³µê° ì§ˆë¬¸ ë“± í™œìš©",
            "2-4ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ êµ¬ì„±",
            "ì£¼ì œì™€ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°ë˜ë„ë¡ êµ¬ì„±"
          ]
        },
        "structure": {
          "label": "ì£¼ì œì„¤êµ êµ¬ì¡°",
          "rules": [
            "ì•„ì´ìŠ¤ë¸Œë ˆì´í‚¹ â†’ ì„œë¡  â†’ ë³¸ë¡  â†’ ê²°ë¡  ìˆœì„œ ìœ ì§€",
            "1ëŒ€ì§€: ì£¼ì œì˜ ë³¸ì§ˆ (ì„±ê²½ì  ì •ì˜)",
            "2ëŒ€ì§€: ì£¼ì œì˜ ì„±ê²½ì  ì „ê°œ (êµ¬ì•½â†’ì‹ ì•½)",
            "3ëŒ€ì§€: ì£¼ì œì˜ ì˜¤ëŠ˜ ì˜ë¯¸ (ì ìš©)"
          ]
        },
        "connection": {
          "label": "ëŒ€ì§€ ì—°ê²°",
          "rules": [
            "ëŒ€ì§€ ì „í™˜ ì‹œ ì—°ê²° ë¬¸ì¥ í•„ìˆ˜",
            "ì˜ˆ: '~ì˜ ë³¸ì§ˆì„ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤. ì´ì œ ì´ ì£¼ì œê°€ ì„±ê²½ ì „ì²´ì—ì„œ ì–´ë–»ê²Œ ë‚˜íƒ€ë‚˜ëŠ”ì§€ ë³´ê² ìŠµë‹ˆë‹¤.'"
          ]
        },
        "scripture_usage": {
          "label": "ì„±ê²½ ì¸ìš©",
          "rules": [
            "ê° ëŒ€ì§€ë§ˆë‹¤ 2-3ê°œì˜ ë³´ì¶© ì„±ê²½êµ¬ì ˆ ì¸ìš©",
            "êµ¬ì•½-ì‹ ì•½ ê· í˜• ìˆê²Œ ì¸ìš©",
            "ì£¼ì œì™€ ì§ì ‘ ì—°ê²°ëœ êµ¬ì ˆë§Œ ì‚¬ìš©"
          ]
        },
        "no_duplication": {
          "label": "ì¤‘ë³µ ë°©ì§€",
          "rules": [
            "ëŒ€ì§€ ê°„ ë‚´ìš© ì¤‘ë³µ ê¸ˆì§€",
            "ê°™ì€ ì„±ê²½êµ¬ì ˆ ë°˜ë³µ ì¸ìš© ê¸ˆì§€"
          ]
        },
        "application": {
          "label": "ì ìš©",
          "rules": [
            "3ëŒ€ì§€ì—ì„œ í˜„ëŒ€ ì‹ ì•™ì¸ì˜ ì‚¶ê³¼ ì—°ê²°",
            "Step1ì˜ problem_diagnosis í™œìš©",
            "êµ¬ì²´ì ì´ê³  ì‹¤ì²œ ê°€ëŠ¥í•œ ì ìš© ì œì‹œ"
          ]
        }
      },
      "output_structure": {
        "description": "ìˆœìˆ˜ í…ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥",
        "sections": [
          "ì•„ì´ìŠ¤ë¸Œë ˆì´í‚¹ (ì²­ì¤‘ ë¼í¬ í˜•ì„±, 2-4ë¬¸ì¥)",
          "ì„œë¡  (ì£¼ì œ ì •ì˜, ì„±ê²½ ì „ì²´ íë¦„ ìš”ì•½)",
          "ë³¸ë¡  - 1ëŒ€ì§€ (ì£¼ì œì˜ ë³¸ì§ˆ)",
          "ë³¸ë¡  - 2ëŒ€ì§€ (ì£¼ì œì˜ ì„±ê²½ì  ì „ê°œ)",
          "ë³¸ë¡  - 3ëŒ€ì§€ (ì£¼ì œì˜ ì˜¤ëŠ˜ ì˜ë¯¸, ì ìš©)",
          "ê²°ë¡  (big_idea ì¬ê°•ì¡°, ê²°ë‹¨ ì´‰êµ¬)"
        ]
      }
    }
  }
};

// ===== Firebase ì´ˆê¸°í™” =====
const firebaseConfig = {
  apiKey: "AIzaSyBacmJDk-PG5FaoqnXV8Rg3P__AKOS2vu4",
  authDomain: "my-sermon-guides.firebaseapp.com",
  projectId: "my-sermon-guides",
  storageBucket: "my-sermon-guides.firebasestorage.app",
  messagingSenderId: "539520456089",
  appId: "1:539520456089:web:d6aceb7838baa89e70af08",
  measurementId: "G-KWN8TH7Z26"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const USER_CODE = 'samuel123';
const PAGE_NAME = 'sermon';
const CONFIG_KEY = '_sermon-config';
const AUTO_SAVE_KEY = '_sermon-autosave';

// ===== Config ê²€ì¦ ë° ë§ˆì´ê·¸ë ˆì´ì…˜ =====
function validateAndMigrateConfig(config) {
  console.log('[Config] ê²€ì¦ ì‹œì‘, í˜„ì¬ ë²„ì „:', config?._version || 'ì—†ìŒ');

  // configê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ ë°˜í™˜
  if (!config || typeof config !== 'object') {
    console.log('[Config] configê°€ ì—†ìŒ - ê¸°ë³¸ê°’ ì‚¬ìš©');
    return null; // ê¸°ë³¸ê°’ ì‚¬ìš©
  }

  // í•„ìˆ˜ í•„ë“œ ê²€ì¦
  if (!config.categories || !Array.isArray(config.categories) || config.categories.length === 0) {
    console.log('[Config] categories ì—†ìŒ - ê¸°ë³¸ê°’ ì‚¬ìš©');
    return null;
  }

  if (!config.categorySettings || typeof config.categorySettings !== 'object') {
    console.log('[Config] categorySettings ì—†ìŒ - ê¸°ë³¸ê°’ ì‚¬ìš©');
    return null;
  }

  // ë²„ì „ë³„ ë§ˆì´ê·¸ë ˆì´ì…˜
  let needsSave = false;

  // ë²„ì „ 1 -> 2: stylesì— stepType í•„ë“œ ì¶”ê°€
  if (!config._version || config._version < 2) {
    console.log('[Config] ë²„ì „ ë§ˆì´ê·¸ë ˆì´ì…˜: 1 -> 2');
    Object.values(config.categorySettings).forEach(catSettings => {
      if (catSettings?.styles) {
        catSettings.styles.forEach(style => {
          if (style.steps) {
            style.steps.forEach((step, idx) => {
              // stepTypeì´ ì—†ìœ¼ë©´ ì¶”ê°€
              if (!step.stepType) {
                step.stepType = idx < 2 ? 'step1' : 'step2';
              }
            });
          }
        });
      }
    });
    config._version = 2;
    needsSave = true;
  }

  // ë²„ì „ 2 -> 3: ë¹ˆ ìŠ¤íƒ€ì¼ ë³µêµ¬ ë° steps stepType ë³´ì¥
  if (config._version < 3) {
    console.log('[Config] ë²„ì „ ë§ˆì´ê·¸ë ˆì´ì…˜: 2 -> 3');

    // generalê³¼ series ì¹´í…Œê³ ë¦¬ì— ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë³µêµ¬
    ['general', 'series'].forEach(catValue => {
      const catSettings = config.categorySettings[catValue];
      if (catSettings && (!catSettings.styles || catSettings.styles.length === 0)) {
        if (DEFAULT_STYLES[catValue]) {
          console.log(`[Config] ${catValue} ì¹´í…Œê³ ë¦¬ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë³µêµ¬`);
          catSettings.styles = JSON.parse(JSON.stringify(DEFAULT_STYLES[catValue]));
          needsSave = true;
        }
      }
    });

    // ëª¨ë“  ìŠ¤íƒ€ì¼ì˜ stepsì— stepType ë³´ì¥
    Object.values(config.categorySettings).forEach(catSettings => {
      if (catSettings?.styles) {
        catSettings.styles.forEach(style => {
          if (style.steps) {
            style.steps.forEach((step, idx) => {
              if (!step.stepType) {
                step.stepType = idx < 2 ? 'step1' : 'step2';
              }
            });
          }
        });
      }
    });

    config._version = 3;
    needsSave = true;
  }

  // ê° ì¹´í…Œê³ ë¦¬ ì„¤ì • ê²€ì¦ ë° ë³µêµ¬
  config.categories.forEach(cat => {
    if (!config.categorySettings[cat.value]) {
      console.log('[Config] ì¹´í…Œê³ ë¦¬ ì„¤ì • ìƒì„±:', cat.value);
      config.categorySettings[cat.value] = {
        masterGuide: '',
        styles: DEFAULT_STYLES[cat.value] ? JSON.parse(JSON.stringify(DEFAULT_STYLES[cat.value])) : []
      };
      needsSave = true;
    }
  });

  // ë””ë²„ê·¸: í˜„ì¬ ì„¤ì • ìƒíƒœ ì¶œë ¥
  console.log('[Config] ê²€ì¦ ì™„ë£Œ - ì¹´í…Œê³ ë¦¬:', config.categories.map(c => c.value));
  Object.keys(config.categorySettings).forEach(cat => {
    const styles = config.categorySettings[cat]?.styles || [];
    console.log(`[Config] ${cat}: ${styles.length}ê°œ ìŠ¤íƒ€ì¼`);
  });

  if (needsSave) {
    console.log('[Config] ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ - ì €ì¥ í•„ìš”');
    // ë¹„ë™ê¸°ë¡œ ì €ì¥ (ë‚˜ì¤‘ì— í˜¸ì¶œë¨)
    setTimeout(() => {
      if (typeof saveConfig === 'function') {
        saveConfig();
        console.log('[Config] ë§ˆì´ê·¸ë ˆì´ì…˜ëœ ì„¤ì • ì €ì¥ë¨');
      }
    }, 1000);
  }

  return config;
}

// ===== ìŠ¤íƒ€ì¼ ìë™ ì„ íƒ =====
function ensureStyleSelected() {
  console.log('[ensureStyleSelected] í˜¸ì¶œë¨');
  console.log('[ensureStyleSelected] currentCategory:', window.currentCategory);
  console.log('[ensureStyleSelected] currentStyleId:', window.currentStyleId);

  // currentCategoryì˜ ì²« ë²ˆì§¸ ìŠ¤íƒ€ì¼ ìë™ ì„ íƒ
  const catSettings = window.config?.categorySettings?.[window.currentCategory];
  const styles = catSettings?.styles || [];

  console.log('[ensureStyleSelected] ìŠ¤íƒ€ì¼ ìˆ˜:', styles.length);
  if (styles.length > 0) {
    console.log('[ensureStyleSelected] ì‚¬ìš© ê°€ëŠ¥í•œ ìŠ¤íƒ€ì¼:', styles.map(s => s.id).join(', '));
  }

  if (styles.length > 0 && !window.currentStyleId) {
    window.currentStyleId = styles[0].id;
    console.log('[ensureStyleSelected] ìŠ¤íƒ€ì¼ ìë™ ì„ íƒ:', window.currentStyleId);
    return true;
  }

  // ì„ íƒëœ ìŠ¤íƒ€ì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
  if (window.currentStyleId && styles.length > 0) {
    const exists = styles.some(s => s.id === window.currentStyleId);
    if (!exists) {
      window.currentStyleId = styles[0].id;
      console.log('[ensureStyleSelected] ìŠ¤íƒ€ì¼ ì¬ì„ íƒ (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì—†ìŒ):', window.currentStyleId);
      return true;
    }
    console.log('[ensureStyleSelected] í˜„ì¬ ìŠ¤íƒ€ì¼ ìœ íš¨í•¨:', window.currentStyleId);
  }

  // ìŠ¤íƒ€ì¼ì´ ì—†ëŠ” ê²½ìš° ê²½ê³ 
  if (styles.length === 0) {
    console.warn('[ensureStyleSelected] ê²½ê³ : ì¹´í…Œê³ ë¦¬ì— ìŠ¤íƒ€ì¼ì´ ì—†ìŠµë‹ˆë‹¤ -', window.currentCategory);
  }

  return false;
}

// ===== Firebase ë¡œë“œ =====
async function loadFromFirebase() {
  try {
    const snapshot = await db.collection('users').doc(USER_CODE).collection(PAGE_NAME).get();

    if (!snapshot.empty) {
      snapshot.forEach(doc => {
        localStorage.setItem(doc.id, doc.data().value);
      });

      const configData = localStorage.getItem(CONFIG_KEY);
      if (configData) {
        try {
          const parsed = JSON.parse(configData);
          const validated = validateAndMigrateConfig(parsed);
          if (validated) {
            window.config = validated;
          }
          // validatedê°€ nullì´ë©´ ê¸°ë³¸ config ìœ ì§€
        } catch (parseErr) {
          console.error('[Config] JSON íŒŒì‹± ì‹¤íŒ¨:', parseErr);
          // íŒŒì‹± ì‹¤íŒ¨ì‹œ ê¸°ë³¸ config ìœ ì§€
        }
      }

      // ìŠ¤íƒ€ì¼ ìë™ ì„ íƒ
      ensureStyleSelected();

      console.log('âœ… Firebase ë™ê¸°í™” ì™„ë£Œ');
      return true;
    }
    return false;
  } catch (err) {
    console.error('Firebase ë¡œë“œ ì‹¤íŒ¨:', err);
    return false;
  }
}

// ===== Firebase ì €ì¥ (ì¬ì‹œë„ ë¡œì§ í¬í•¨) =====
async function saveToFirebase(key, value, retries = 0) {
  const MAX_RETRIES = 4;
  const RETRY_DELAYS = [2000, 4000, 8000, 16000]; // exponential backoff

  try {
    await db.collection('users').doc(USER_CODE).collection(PAGE_NAME).doc(key).set({
      value: value,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    return true;
  } catch (err) {
    console.error(`Firebase ì €ì¥ ì‹¤íŒ¨ (ì‹œë„ ${retries + 1}/${MAX_RETRIES + 1}):`, err);

    // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì¸ ê²½ìš°ì—ë§Œ ì¬ì‹œë„
    const isNetworkError = err.code === 'unavailable' || err.code === 'deadline-exceeded' ||
                           err.message.includes('network') || err.message.includes('offline');

    if (isNetworkError && retries < MAX_RETRIES) {
      const delay = RETRY_DELAYS[retries];
      console.log(`${delay}ms í›„ ì¬ì‹œë„...`);
      await new Promise(resolve => setTimeout(resolve, delay));
      return saveToFirebase(key, value, retries + 1);
    }

    return false;
  }
}

// ===== Config ì €ì¥ =====
async function saveConfig() {
  // ë²„ì „ ì •ë³´ ì¶”ê°€
  if (!window.config._version) {
    window.config._version = CONFIG_VERSION;
  }

  const configStr = JSON.stringify(window.config);
  localStorage.setItem(CONFIG_KEY, configStr);
  const success = await saveToFirebase(CONFIG_KEY, configStr);
  if (!success) {
    console.warn('âš ï¸ Firebase ì €ì¥ ì‹¤íŒ¨ - ë¡œì»¬ì—ë§Œ ì €ì¥ë¨');
  }
}

// ===== ìë™ ì €ì¥ í•¨ìˆ˜ =====
let autoSaveTimeout = null;

async function autoSaveStepResults() {
  // debounce: ë§ˆì§€ë§‰ ë³€ê²½ í›„ 2ì´ˆ ë’¤ì— ì €ì¥
  if (autoSaveTimeout) {
    clearTimeout(autoSaveTimeout);
  }

  autoSaveTimeout = setTimeout(async () => {
    const autoSaveData = {
      category: window.currentCategory,
      styleId: window.currentStyleId,
      stepResults: window.stepResults,
      titleOptions: window.titleOptions,
      selectedTitle: window.selectedTitle,
      timestamp: new Date().toISOString()
    };

    const autoSaveStr = JSON.stringify(autoSaveData);
    localStorage.setItem(AUTO_SAVE_KEY, autoSaveStr);

    const success = await saveToFirebase(AUTO_SAVE_KEY, autoSaveStr);
    if (success) {
      console.log('ğŸ’¾ ìë™ ì €ì¥ ì™„ë£Œ');
    } else {
      console.warn('âš ï¸ ìë™ ì €ì¥ ì‹¤íŒ¨ - ë¡œì»¬ì—ë§Œ ì €ì¥ë¨');
    }
  }, 2000);
}

function loadAutoSave() {
  try {
    const autoSaveStr = localStorage.getItem(AUTO_SAVE_KEY);
    if (!autoSaveStr) return false;

    const autoSaveData = JSON.parse(autoSaveStr);

    // ìë™ ì €ì¥ëœ ë°ì´í„°ê°€ í˜„ì¬ ì¹´í…Œê³ ë¦¬/ìŠ¤íƒ€ì¼ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
    if (autoSaveData.category === window.currentCategory && autoSaveData.styleId === window.currentStyleId) {
      window.stepResults = autoSaveData.stepResults || {};
      window.titleOptions = autoSaveData.titleOptions || [];
      window.selectedTitle = autoSaveData.selectedTitle || '';

      console.log('âœ… ìë™ ì €ì¥ëœ ë°ì´í„° ë³µì› ì™„ë£Œ');
      return true;
    }

    return false;
  } catch (err) {
    console.error('ìë™ ì €ì¥ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', err);
    return false;
  }
}

// ===== ì‹¤ì‹œê°„ ë™ê¸°í™” =====
let realtimeListeners = [];
let isUpdatingFromRemote = false;

function setupRealtimeSync() {
  // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
  realtimeListeners.forEach(unsubscribe => unsubscribe());
  realtimeListeners = [];

  // CONFIG_KEY ì‹¤ì‹œê°„ ë™ê¸°í™”
  const configListener = db.collection('users').doc(USER_CODE).collection(PAGE_NAME).doc(CONFIG_KEY)
    .onSnapshot((doc) => {
      if (doc.exists && !isUpdatingFromRemote) {
        const remoteData = doc.data();
        const localTimestamp = localStorage.getItem(`${CONFIG_KEY}_timestamp`) || '0';
        const remoteTimestamp = remoteData.updatedAt?.toMillis().toString() || '0';

        // ì›ê²© ë°ì´í„°ê°€ ë¡œì»¬ë³´ë‹¤ ìµœì‹ ì¸ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
        if (remoteTimestamp > localTimestamp) {
          isUpdatingFromRemote = true;
          localStorage.setItem(CONFIG_KEY, remoteData.value);
          localStorage.setItem(`${CONFIG_KEY}_timestamp`, remoteTimestamp);
          window.config = JSON.parse(remoteData.value);

          console.log('ğŸ”„ ì„¤ì • ë™ê¸°í™”: ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì—…ë°ì´íŠ¸ë¨');

          // UI ì—…ë°ì´íŠ¸
          if (typeof renderCategories === 'function') renderCategories();
          if (typeof renderStyles === 'function') renderStyles();
          if (typeof renderProcessingSteps === 'function') renderProcessingSteps();
          if (typeof renderResultBoxes === 'function') renderResultBoxes();
          if (typeof renderGuideTabs === 'function') renderGuideTabs();

          setTimeout(() => {
            isUpdatingFromRemote = false;
          }, 1000);
        }
      }
    }, (error) => {
      console.error('ì‹¤ì‹œê°„ ë™ê¸°í™” ì˜¤ë¥˜ (CONFIG):', error);
    });

  realtimeListeners.push(configListener);

  // AUTO_SAVE_KEY ì‹¤ì‹œê°„ ë™ê¸°í™”
  const autoSaveListener = db.collection('users').doc(USER_CODE).collection(PAGE_NAME).doc(AUTO_SAVE_KEY)
    .onSnapshot((doc) => {
      if (doc.exists && !isUpdatingFromRemote) {
        const remoteData = doc.data();
        const localTimestamp = localStorage.getItem(`${AUTO_SAVE_KEY}_timestamp`) || '0';
        const remoteTimestamp = remoteData.updatedAt?.toMillis().toString() || '0';

        // ì›ê²© ë°ì´í„°ê°€ ë¡œì»¬ë³´ë‹¤ ìµœì‹ ì¸ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
        if (remoteTimestamp > localTimestamp) {
          isUpdatingFromRemote = true;
          localStorage.setItem(AUTO_SAVE_KEY, remoteData.value);
          localStorage.setItem(`${AUTO_SAVE_KEY}_timestamp`, remoteTimestamp);

          const autoSaveData = JSON.parse(remoteData.value);

          // í˜„ì¬ ì¹´í…Œê³ ë¦¬/ìŠ¤íƒ€ì¼ê³¼ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ì—ë§Œ ì ìš©
          if (autoSaveData.category === window.currentCategory && autoSaveData.styleId === window.currentStyleId) {
            window.stepResults = autoSaveData.stepResults || {};
            window.titleOptions = autoSaveData.titleOptions || [];
            window.selectedTitle = autoSaveData.selectedTitle || '';

            console.log('ğŸ”„ ì‘ì—… ë‚´ìš© ë™ê¸°í™”: ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì—…ë°ì´íŠ¸ë¨');
            if (typeof renderResultBoxes === 'function') renderResultBoxes();
          }

          setTimeout(() => {
            isUpdatingFromRemote = false;
          }, 1000);
        }
      }
    }, (error) => {
      console.error('ì‹¤ì‹œê°„ ë™ê¸°í™” ì˜¤ë¥˜ (AUTOSAVE):', error);
    });

  realtimeListeners.push(autoSaveListener);
}

// ===== ë°±ì—… ë° ë³µì› =====
function exportBackup() {
  try {
    const backupData = {
      version: '1.0',
      exportDate: new Date().toISOString(),
      config: window.config,
      guides: {},
      savedSermons: JSON.parse(localStorage.getItem('sermon-saved') || '[]')
    };

    // ëª¨ë“  ì§€ì¹¨ ë°ì´í„° ë°±ì—…
    for (const key of Object.keys(localStorage)) {
      if (key.startsWith('guide-')) {
        backupData.guides[key] = localStorage.getItem(key);
      }
    }

    const dataStr = JSON.stringify(backupData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `sermon-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showStatus('âœ… ë°±ì—… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!');
    setTimeout(hideStatus, 2000);
  } catch (err) {
    console.error('ë°±ì—… ì‹¤íŒ¨:', err);
    alert('ë°±ì—… ìƒì„± ì‹¤íŒ¨: ' + err.message);
  }
}

async function importBackup(file) {
  try {
    const reader = new FileReader();

    reader.onload = async (e) => {
      try {
        const backupData = JSON.parse(e.target.result);

        if (!backupData.version || !backupData.config) {
          throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤.');
        }

        const confirmed = confirm(
          `ë°±ì—… ë³µì› ì‹œ í˜„ì¬ ëª¨ë“  ì„¤ì •ì´ ë®ì–´ì“°ì—¬ì§‘ë‹ˆë‹¤.\n\n` +
          `ë°±ì—… ë‚ ì§œ: ${new Date(backupData.exportDate).toLocaleString('ko-KR')}\n\n` +
          `ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
        );

        if (!confirmed) return;

        showStatus('â™»ï¸ ë°±ì—… ë³µì› ì¤‘...');

        // Config ë³µì›
        window.config = backupData.config;
        await saveConfig();

        // ì§€ì¹¨ ë³µì›
        if (backupData.guides) {
          for (const [key, value] of Object.entries(backupData.guides)) {
            localStorage.setItem(key, value);
            await saveToFirebase(key, value);
          }
        }

        // ì €ì¥ëœ ì„¤êµ ë³µì›
        if (backupData.savedSermons) {
          localStorage.setItem('sermon-saved', JSON.stringify(backupData.savedSermons));
        }

        showStatus('âœ… ë°±ì—… ë³µì› ì™„ë£Œ!');

        // UI ìƒˆë¡œê³ ì¹¨
        setTimeout(() => {
          location.reload();
        }, 1500);

      } catch (err) {
        console.error('ë°±ì—… ë³µì› ì‹¤íŒ¨:', err);
        alert('ë°±ì—… ë³µì› ì‹¤íŒ¨: ' + err.message);
        hideStatus();
      }
    };

    reader.readAsText(file);
  } catch (err) {
    console.error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨:', err);
    alert('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + err.message);
  }
}

// ì „ì—­ ë…¸ì¶œ
window.db = db;
window.USER_CODE = USER_CODE;
window.PAGE_NAME = PAGE_NAME;
window.CONFIG_KEY = CONFIG_KEY;
window.AUTO_SAVE_KEY = AUTO_SAVE_KEY;
window.CONFIG_VERSION = CONFIG_VERSION;
window.DEFAULT_STYLES = DEFAULT_STYLES;
window.DEFAULT_GUIDES = DEFAULT_GUIDES;
window.validateAndMigrateConfig = validateAndMigrateConfig;
window.ensureStyleSelected = ensureStyleSelected;
window.loadFromFirebase = loadFromFirebase;
window.saveToFirebase = saveToFirebase;
window.saveConfig = saveConfig;
window.autoSaveStepResults = autoSaveStepResults;
window.loadAutoSave = loadAutoSave;
window.setupRealtimeSync = setupRealtimeSync;
window.exportBackup = exportBackup;
window.importBackup = importBackup;
