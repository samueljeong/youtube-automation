"""
GPT-5.2 ê¸°ë°˜ ëŒ€ë³¸ ìë™ ìƒì„± ëª¨ë“ˆ

2025-01 ì‹ ê·œ:
- 4ê°œ ê³µì‹ ë ¥ ìˆëŠ” ì†ŒìŠ¤ì—ì„œ ìˆ˜ì§‘í•œ ìë£Œ ê¸°ë°˜
- 20,000ì ë¶„ëŸ‰ì˜ ì—­ì‚¬ ë‹¤íë©˜í„°ë¦¬ ëŒ€ë³¸ ìƒì„±
- í•™ìˆ ì  ì‹ ì¤‘í•¨ + ê°ê´€ì  ì„œìˆ  ìŠ¤íƒ€ì¼

2025-01 ì—…ë°ì´íŠ¸:
- GPT-5.1 â†’ GPT-5.2 ëª¨ë¸ ì—…ê·¸ë ˆì´ë“œ
- ë¹„ìš©: $1.75/1M input, $14/1M output
"""

import os
from typing import Dict, Any, Optional

# GPT-5.2 Responses API ì‚¬ìš©
from openai import OpenAI


# ============================================================
# ëŒ€ë³¸ ì„¤ì •
# ============================================================
SCRIPT_TARGET_LENGTH = 20000  # ëª©í‘œ ê¸€ììˆ˜
SCRIPT_MIN_LENGTH = 18000     # ìµœì†Œ ê¸€ììˆ˜
SCRIPT_MAX_LENGTH = 22000     # ìµœëŒ€ ê¸€ììˆ˜

# í•œêµ­ì–´ TTS ê¸°ì¤€: 910ì â‰ˆ 1ë¶„
# 20,000ì â‰ˆ 22ë¶„ ì˜ìƒ


# ============================================================
# ëŒ€ë³¸ ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ (ê´‘ê°œí† ëŒ€ì™• ëŒ€ë³¸ ìŠ¤íƒ€ì¼ ê¸°ë°˜)
# ============================================================
SCRIPT_STYLE_PROMPT = """ë‹¹ì‹ ì€ í•œêµ­ì‚¬ ì „ë¬¸ ìœ íŠœë¸Œ ì±„ë„ì˜ ëŒ€ë³¸ ì‘ê°€ì…ë‹ˆë‹¤.
ì•„ë˜ ìˆ˜ì§‘ëœ ìë£Œë¥¼ ë°”íƒ•ìœ¼ë¡œ ì—­ì‚¬ ë‹¤íë©˜í„°ë¦¬ ë‚˜ë ˆì´ì…˜ ëŒ€ë³¸ì„ ì‘ì„±í•˜ì„¸ìš”.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[ëŒ€ë³¸ ìŠ¤íƒ€ì¼ - í•„ìˆ˜ ì¤€ìˆ˜]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. í•™ìˆ ì  ì‹ ì¤‘í•¨
   âœ… í—ˆìš© í‘œí˜„:
   - "~ë¡œ ë³´ëŠ” ê²¬í•´ê°€ ìˆìŠµë‹ˆë‹¤"
   - "~ì— ëŒ€í•´ì„œëŠ” ë…¼ì˜ê°€ ìˆìŠµë‹ˆë‹¤"
   - "~ë¡œ ì „í•´ì§‘ë‹ˆë‹¤"
   - "~ë¡œ ê¸°ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
   - "~ë¡œ ì¶”ì •ë©ë‹ˆë‹¤"
   - "ì•„ì§ ì™„ì „í•œ ê²°ë¡ ì´ ë‚˜ì™”ë‹¤ê³  ë³´ê¸°ëŠ” ì–´ë µìŠµë‹ˆë‹¤"

   âŒ ê¸ˆì§€ í‘œí˜„:
   - ë‹¨ì •ì  í‘œí˜„: "~ì…ë‹ˆë‹¤", "~ì˜€ìŠµë‹ˆë‹¤" (í™•ì‹¤í•œ ì‚¬ì‹¤ë§Œ)
   - ê³¼ì¥: "ë†€ëê²Œë„", "ì¶©ê²©ì ì´ê²Œë„", "ë¯¿ê¸° ì–´ë µì§€ë§Œ"

2. ì¶œì²˜ ëª…ì‹œ
   âœ… í—ˆìš©:
   - "ì‚¼êµ­ì‚¬ê¸°ì— ë”°ë¥´ë©´"
   - "ë¹„ë¬¸ì—ëŠ” ~ ê¸°ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
   - "í•œêµ­ë¯¼ì¡±ë¬¸í™”ëŒ€ë°±ê³¼ì‚¬ì „ì— ì˜í•˜ë©´"
   - "ë¬¸í™”ì¬ì²­ ìë£Œì— ë”°ë¥´ë©´"

3. ê°ì •/íŒë‹¨ ë°°ì œ
   âŒ ì ˆëŒ€ ê¸ˆì§€:
   - ê°ì •: "ìœ„ëŒ€í•˜ë‹¤", "ì•ˆíƒ€ê¹ë‹¤", "ë†€ëë‹¤", "í¥ë¯¸ë¡­ë‹¤"
   - ë¯¼ì¡±ì£¼ì˜: "ìë‘ìŠ¤ëŸ¬ìš´", "ì°¬ë€í•œ", "ë¯¼ì¡±ì˜ ìì¡´ì‹¬"
   - êµí›ˆ: "~í•´ì•¼ í•©ë‹ˆë‹¤", "~ë¥¼ ê¸°ì–µí•´ì•¼ í•©ë‹ˆë‹¤"
   - í˜¸ì¹­: "ì—¬ëŸ¬ë¶„", "ìš°ë¦¬"

4. ë¬¸ì¥ ìŠ¤íƒ€ì¼
   - ê°„ê²°í•œ ë¬¸ì¥ (í•œ ë¬¸ì¥ 50ì ì´ë‚´ ê¶Œì¥)
   - ì„œìˆ í˜• ì¢…ê²° (~í•©ë‹ˆë‹¤, ~ì…ë‹ˆë‹¤)
   - ì§ˆë¬¸í˜• ë„ì… ê°€ëŠ¥ ("ì™œ ì´ëŸ° ì¼ì´ ë²Œì–´ì¡Œì„ê¹Œìš”")

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[ëŒ€ë³¸ êµ¬ì¡°]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. [ë„ì…ë¶€] 5% (~1,000ì)
   - ì§ˆë¬¸í˜• ì˜¤í”„ë‹ìœ¼ë¡œ ì‹œì‘
   - ì´ ì—í”¼ì†Œë“œì—ì„œ ë‹¤ë£° í•µì‹¬ ì§ˆë¬¸ ì œì‹œ
   - ì˜ˆ: "ì„œê¸° 391ë…„, ê³ êµ¬ë ¤ì— ì—´ì—¬ëŸ ì‚´ì˜ ì Šì€ ì™•ì´ ì¦‰ìœ„í•©ë‹ˆë‹¤..."

2. [ë°°ê²½ ì„¤ëª…] 15% (~3,000ì)
   - ì‹œëŒ€ì  ë§¥ë½ ì„¤ëª…
   - ì´ì „ ì‚¬ê±´ê³¼ì˜ ì—°ê²°
   - ì£¼ìš” ì¸ë¬¼/ì„¸ë ¥ ì†Œê°œ

3. [ë³¸ë¡ ] 60% (~12,000ì)
   - ì‚¬ê±´ì˜ ì „ê°œë¥¼ ì‹œê°„ìˆœ/ë…¼ë¦¬ìˆœìœ¼ë¡œ ì„œìˆ 
   - ê° ì‚¬ê±´ë§ˆë‹¤ ì¶œì²˜ ëª…ì‹œ
   - í•™ìˆ ì  ë…¼ìŸì´ ìˆëŠ” ë¶€ë¶„ì€ ì—¬ëŸ¬ ê²¬í•´ ì†Œê°œ
   - êµ¬ì²´ì ì¸ ì—°ë„, ì§€ëª…, ì¸ë¬¼ëª… í¬í•¨

4. [ë…¼ìŸ/í•´ì„] 10% (~2,000ì)
   - í•™ê³„ì˜ ë‹¤ì–‘í•œ í•´ì„ ì†Œê°œ
   - "~ë¡œ ë³´ëŠ” ê²¬í•´ì™€ ~ë¡œ ë³´ëŠ” ê²¬í•´ê°€ ìˆìŠµë‹ˆë‹¤"
   - ê²°ë¡ ì„ ë‚´ë¦¬ì§€ ì•Šê³  ì—´ë¦° ì§ˆë¬¸ìœ¼ë¡œ ë§ˆë¬´ë¦¬

5. [ë§ˆë¬´ë¦¬] 10% (~2,000ì)
   - ì´ ì£¼ì œì˜ ì—­ì‚¬ì  ì˜ì˜ (ê°ì • ì—†ì´)
   - í›„ëŒ€ì— ë¯¸ì¹œ ì˜í–¥
   - ë‹¤ìŒ ì—í”¼ì†Œë“œ ì˜ˆê³ 
   - ì˜ˆ: "ë‹¤ìŒ ì‹œê°„ì—ëŠ” ~ì— ëŒ€í•´ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[ë¶„ëŸ‰ ê·œì •]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ëª©í‘œ: 20,000ì (18,000~22,000ì)
- ë„ˆë¬´ ì§§ìœ¼ë©´ ë‚´ìš©ì„ ë” ìƒì„¸íˆ
- ë„ˆë¬´ ê¸¸ë©´ í•µì‹¬ë§Œ ë‚¨ê¸°ê³  ì••ì¶•
- TTSë¡œ ì½ì—ˆì„ ë•Œ ì•½ 22ë¶„ ë¶„ëŸ‰

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[ìµœì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â–¡ ìˆ˜ì§‘ëœ ìë£Œì— ìˆëŠ” ë‚´ìš©ë§Œ ì‚¬ìš©í–ˆëŠ”ê°€?
â–¡ ì¶œì²˜ê°€ ëª…ì‹œë˜ì—ˆëŠ”ê°€?
â–¡ ê°ì •ì /íŒë‹¨ì  í‘œí˜„ì´ ì—†ëŠ”ê°€?
â–¡ ë¯¼ì¡±ì£¼ì˜ì  í‘œí˜„ì´ ì—†ëŠ”ê°€?
â–¡ í•™ìˆ ì  ë…¼ìŸì€ ì—¬ëŸ¬ ê²¬í•´ë¥¼ ì†Œê°œí–ˆëŠ”ê°€?
â–¡ ë‹¤ìŒ ì—í”¼ì†Œë“œ ì˜ˆê³ ê°€ ìˆëŠ”ê°€?
â–¡ ë¶„ëŸ‰ì´ 18,000~22,000ìì¸ê°€?
"""


def generate_script_by_parts(
    era_name: str,
    episode: int,
    total_episodes: int,
    title: str,
    topic: str,
    full_content: str,
    sources: list,
    next_episode_info: Dict[str, Any] = None,
    prev_episode_info: Dict[str, Any] = None,  # â˜… ì´ì „ ì—í”¼ì†Œë“œ ì •ë³´ (API ì¥ì  í™œìš©)
    series_context: Dict[str, Any] = None,     # â˜… ì‹œë¦¬ì¦ˆ ì „ì²´ ë§¥ë½ (API ì¥ì  í™œìš©)
) -> Dict[str, Any]:
    """
    GPT-5.2ë¡œ íŒŒíŠ¸ë³„ ëŒ€ë³¸ ìƒì„± (API ì¥ì  ê·¹ëŒ€í™”)

    â˜…â˜…â˜… API í™œìš© ì¥ì  â˜…â˜…â˜…
    - prev_episode_info: ì´ì „ ì—í”¼ì†Œë“œ ë‚´ìš© (ìì—°ìŠ¤ëŸ¬ìš´ ì—°ê²°)
    - next_episode_info: ë‹¤ìŒ ì—í”¼ì†Œë“œ ì˜ˆê³  (ê¸°ëŒ€ê° ì¡°ì„±)
    - series_context: ì‹œë¦¬ì¦ˆ ì „ì²´ ë§¥ë½ (ìœ„ì¹˜ ì¸ì‹, íë¦„ íŒŒì•…)

    íŒŒíŠ¸ êµ¬ì¡°:
    1. ì¸íŠ¸ë¡œ (ë„ì…ë¶€) - 1,500ì â˜… ê°•ì¡°
       - ì´ì „ ì—í”¼ì†Œë“œ ì—°ê²° ("ì§€ë‚œ ì‹œê°„ì—...")
    2. ë°°ê²½ ì„¤ëª… - 3,000ì
    3. ë³¸ë¡  - 12,000ì
    4. ë§ˆë¬´ë¦¬ - 3,500ì
       - ë‹¤ìŒ ì—í”¼ì†Œë“œ ì˜ˆê³  (ìì—°ìŠ¤ëŸ¬ìš´ ì—°ê²°)

    ì´ 20,000ì
    """
    api_key = os.environ.get("OPENAI_API_KEY")
    if not api_key:
        return {"error": "OPENAI_API_KEY í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."}

    if not full_content or len(full_content) < 500:
        return {"error": f"ìˆ˜ì§‘ëœ ìë£Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í˜„ì¬: {len(full_content)}ì)"}

    source_list = "\n".join([f"  - {s}" for s in sources[:10]]) if sources else "(ì—†ìŒ)"

    # ë‹¤ìŒ ì—í”¼ì†Œë“œ ì˜ˆê³  í…ìŠ¤íŠ¸
    next_preview = _build_next_preview(next_episode_info, era_name)

    # â˜… ì´ì „ ì—í”¼ì†Œë“œ ì»¨í…ìŠ¤íŠ¸ (API ì¥ì  í™œìš©)
    prev_context = _build_prev_context(prev_episode_info, era_name)

    # â˜… ì‹œë¦¬ì¦ˆ ì „ì²´ ì»¨í…ìŠ¤íŠ¸ (API ì¥ì  í™œìš©)
    series_position = _build_series_position(series_context, era_name, episode, total_episodes)

    total_cost = 0.0
    all_parts = []

    print(f"[SCRIPT] === íŒŒíŠ¸ë³„ ëŒ€ë³¸ ìƒì„± ì‹œì‘ (API ì»¨í…ìŠ¤íŠ¸ í™œìš©) ===")
    print(f"[SCRIPT] ì œëª©: {title}")
    print(f"[SCRIPT] ì‹œë¦¬ì¦ˆ ìœ„ì¹˜: {era_name} {episode}/{total_episodes}í™”")
    print(f"[SCRIPT] ì…ë ¥ ìë£Œ: {len(full_content):,}ì")
    print(f"[SCRIPT] ì´ì „ ì—í”¼ì†Œë“œ ì—°ê²°: {'ìˆìŒ' if prev_episode_info else 'ì—†ìŒ(ì²« í™”)'}")
    print(f"[SCRIPT] ë‹¤ìŒ ì—í”¼ì†Œë“œ ì˜ˆê³ : {'ìˆìŒ' if next_episode_info else 'ì—†ìŒ(ë§ˆì§€ë§‰ í™”)'}")

    try:
        client = OpenAI(api_key=api_key)

        # ========================================
        # Part 1: ì¸íŠ¸ë¡œ (ë„ì…ë¶€) - 1,500ì â˜…â˜…â˜… ìµœê°• ê°•í™”
        # ========================================
        print(f"[SCRIPT] Part 1: ì¸íŠ¸ë¡œ ìƒì„± ì¤‘ (ì´íƒˆë°©ì§€ + ì—í”¼ì†Œë“œ ì—°ê²°)...")
        intro_prompt = f"""ë‹¹ì‹ ì€ í•œêµ­ì‚¬ ì „ë¬¸ ìœ íŠœë¸Œ ì±„ë„ì˜ ìµœê³  ëŒ€ë³¸ ì‘ê°€ì…ë‹ˆë‹¤.

[ì—í”¼ì†Œë“œ ì •ë³´]
- ì‹œë¦¬ì¦ˆ: í•œêµ­ì‚¬ - {era_name}
- í˜„ì¬: {episode}/{total_episodes}í™”
- ì œëª©: {title}
- ì£¼ì œ: {topic}

{series_position}

{prev_context}

[ìˆ˜ì§‘ëœ ìë£Œ ì¤‘ í•µì‹¬ ë¶€ë¶„]
{full_content[:3000]}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â˜…â˜…â˜… ì¸íŠ¸ë¡œ ì‘ì„± ì§€ì¹¨ (API ì¥ì  ìµœëŒ€ í™œìš©) â˜…â˜…â˜…
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ì´ íŒŒíŠ¸ëŠ” ì‹œì²­ìê°€ ì˜ìƒì„ ì´íƒˆí• ì§€ ê²°ì •í•˜ëŠ” ê°€ì¥ ì¤‘ìš”í•œ 30ì´ˆì…ë‹ˆë‹¤.

ã€API ì¥ì  í™œìš© - ì—í”¼ì†Œë“œ ì—°ê²°ã€‘
ì´ì „ ì—í”¼ì†Œë“œ ì •ë³´ê°€ ìˆë‹¤ë©´ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°í•˜ì„¸ìš”:
- ì²« í™”: "í•œêµ­ì‚¬ì˜ ì‹œì‘, ê³ ì¡°ì„  ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."
- 2í™” ì´í›„: "ì§€ë‚œ ì‹œê°„, [ì´ì „ ë‚´ìš© í•œ ì¤„ ìš”ì•½]... ì˜¤ëŠ˜ì€ ê·¸ ì´í›„ ì´ì•¼ê¸°ì…ë‹ˆë‹¤."
- ì‹œëŒ€ ì²« í™”: "[ì´ì „ ì‹œëŒ€]ê°€ ì €ë¬¼ê³  ìƒˆë¡œìš´ ì‹œëŒ€ê°€ ì—´ë¦½ë‹ˆë‹¤."

â˜… ë‹¨, "ì§€ë‚œ ì‹œê°„ì—" ë¬¸êµ¬ëŠ” ì²« 2-3ë¬¸ì¥ì—ì„œë§Œ ì‚¬ìš©í•˜ê³  ë¹ ë¥´ê²Œ ë³¸ë¡ ìœ¼ë¡œ ì „í™˜í•˜ì„¸ìš”.

ì•„ë˜ 5ê°€ì§€ ê¸°ë²•ì„ ë°˜ë“œì‹œ ì ìš©í•˜ì„¸ìš”:

ã€ê¸°ë²• 1: Cold Open (ì½œë“œ ì˜¤í”ˆ)ã€‘
ê°€ì¥ ê·¹ì ì¸ ìˆœê°„ë¶€í„° ì‹œì‘í•˜ì„¸ìš”. ë°°ê²½ ì„¤ëª… ì—†ì´ ë°”ë¡œ ì‚¬ê±´ ì†ìœ¼ë¡œ.
âŒ "ì˜¤ëŠ˜ì€ ê´‘ê°œí† ëŒ€ì™•ì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤"
âœ… "ì„œê¸° 391ë…„, ì—´ì—¬ëŸ ì‚´ì˜ ì™•ì´ ì²« ì¶œì •ì— ë‚˜ì„­ë‹ˆë‹¤. ê·¸ì˜ ì•ì—ëŠ” ë°±ì œì˜ ëŒ€êµ°ì´ ê¸°ë‹¤ë¦¬ê³  ìˆì—ˆìŠµë‹ˆë‹¤."

ã€ê¸°ë²• 2: Open Loop (ì—´ë¦° ì§ˆë¬¸)ã€‘
ì²« 30ì´ˆ ì•ˆì— í•´ê²°ë˜ì§€ ì•Šì€ ì§ˆë¬¸ì„ ë˜ì§€ì„¸ìš”. ì‹œì²­ìëŠ” ë‹µì„ ì•Œê¸° ìœ„í•´ ë¨¸ë­…ë‹ˆë‹¤.
âœ… "ì™œ ì´ ì–´ë¦° ì™•ì€ ì¦‰ìœ„í•˜ìë§ˆì ì „ìŸì— ë‚˜ì„°ì„ê¹Œìš”?"
âœ… "ê¸°ë¡ì—ëŠ” ì´ë ‡ê²Œ ì í˜€ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ë¬´ì–¸ê°€ ì´ìƒí•©ë‹ˆë‹¤."

ã€ê¸°ë²• 3: Curiosity Gap (í˜¸ê¸°ì‹¬ ê°„ê·¹)ã€‘
"ì•Œë ¤ì§„ ì‚¬ì‹¤"ê³¼ "ìˆ¨ê²¨ì§„ ì§„ì‹¤" ì‚¬ì´ì˜ ê°„ê·¹ì„ ë§Œë“œì„¸ìš”.
âœ… "ì‚¼êµ­ì‚¬ê¸°ì—ëŠ” ì´ë ‡ê²Œ ê¸°ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ°ë° ê´‘ê°œí† ëŒ€ì™•ë¹„ì—ëŠ” ì „í˜€ ë‹¤ë¥¸ ì´ì•¼ê¸°ê°€ ìƒˆê²¨ì ¸ ìˆìŠµë‹ˆë‹¤."
âœ… "ìš°ë¦¬ê°€ ì•Œê³  ìˆëŠ” ì´ì•¼ê¸°ëŠ” ì—¬ê¸°ê¹Œì§€ì…ë‹ˆë‹¤. í•˜ì§€ë§Œ..."

ã€ê¸°ë²• 4: Stakes Reveal (ì¤‘ìš”ì„± ì•”ì‹œ)ã€‘
ì´ ì‚¬ê±´ì´ ì™œ ì¤‘ìš”í•œì§€ ë¨¼ì € ì•Œë ¤ì£¼ì„¸ìš”.
âœ… "ì´ ì „íˆ¬ì˜ ê²°ê³¼ê°€ ë™ì•„ì‹œì•„ì˜ íŒë„ë¥¼ ë°”ê¾¸ê²Œ ë©ë‹ˆë‹¤."
âœ… "ì´ ê²°ì • í•˜ë‚˜ê°€ ì´í›„ ìˆ˜ë°± ë…„ì˜ ì—­ì‚¬ë¥¼ ê²°ì •ì§“ìŠµë‹ˆë‹¤."

ã€ê¸°ë²• 5: Pattern Interrupt (ì˜ˆìƒ íŒŒê´´)ã€‘
ì‹œì²­ìì˜ ì˜ˆìƒì„ ê¹¨ëŠ” ë¬¸ì¥ìœ¼ë¡œ ì£¼ì˜ë¥¼ ëŒìœ¼ì„¸ìš”.
âœ… "ì™•ì´ ì•„ë‹ˆì—ˆìŠµë‹ˆë‹¤. ì ì–´ë„, ì•„ì§ì€."
âœ… "ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì•„ë¬´ë„ ì¶•í•˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[ì¸íŠ¸ë¡œ êµ¬ì¡° - 1,500ì]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ì˜¤í”„ë‹ í›… (0-300ì)
   - Cold Openìœ¼ë¡œ ì‹œì‘
   - ê°€ì¥ ê·¹ì ì¸ ì¥ë©´/ìˆœê°„ì„ ë¨¼ì €
   - ì—°ë„, ì¸ë¬¼, ì¥ì†Œ êµ¬ì²´ì ìœ¼ë¡œ

2. ë¯¸ìŠ¤í„°ë¦¬ ì œì‹œ (300-600ì)
   - Open Loop ë˜ëŠ” Curiosity Gap ì ìš©
   - "ì™œ?", "ì–´ë–»ê²Œ?", "ë¬´ì—‡ì´?" ì§ˆë¬¸
   - ì‹œì²­ìê°€ ê¶ê¸ˆí•´í•  í•µì‹¬ í¬ì¸íŠ¸

3. Stakes ì•”ì‹œ (600-900ì)
   - ì´ ì‚¬ê±´ì˜ ì—­ì‚¬ì  ì¤‘ìš”ì„±
   - "ì´ ì „íˆ¬ê°€... ì´ ê²°ì •ì´..."
   - ì‹œì²­ìê°€ ì™œ ê³„ì† ë´ì•¼ í•˜ëŠ”ì§€ ì´ìœ 

4. ì—í”¼ì†Œë“œ ë¡œë“œë§µ (900-1500ì)
   - ì´ ì˜ìƒì—ì„œ ë‹¤ë£° ë‚´ìš© ì˜ˆê³ 
   - "ì§€ê¸ˆë¶€í„°... ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤"
   - ì–´ë–¤ ì§ˆë¬¸ì— ë‹µì„ ì–»ì„ ìˆ˜ ìˆëŠ”ì§€

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[ìŠ¤íƒ€ì¼ ê·œì¹™]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- í¥ë¯¸ë¡œìš´ ìŠ¤í† ë¦¬í…”ë§: ë§ˆì¹˜ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ë“¯ ìì—°ìŠ¤ëŸ½ê²Œ
- ì¶œì²˜ ëª…ì‹œ ê¸ˆì§€: "~ì— ë”°ë¥´ë©´", "~ì— ê¸°ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤" âŒ (ì¶œì²˜ëŠ” ìœ íŠœë¸Œ ì„¤ëª…ë€ì— ë³„ë„ ì •ë¦¬)
- ê°ì •ì  í‘œí˜„ ê¸ˆì§€: ë†€ëë‹¤, ìœ„ëŒ€í•˜ë‹¤, ì¶©ê²©ì  ë“± âŒ
- ì‚¬ì‹¤ ê¸°ë°˜: ìˆ˜ì§‘ëœ ìë£Œì˜ ë‚´ìš©ë§Œ ì‚¬ìš© (ìƒìƒ ê¸ˆì§€)
- ì§§ì€ ë¬¸ì¥: í•œ ë¬¸ì¥ 50ì ì´ë‚´
- ì„œìˆ í˜• ì¢…ê²°: ~í•©ë‹ˆë‹¤, ~ì…ë‹ˆë‹¤

ëŒ€ë³¸ë§Œ ì‘ì„±í•˜ì„¸ìš”. ë‹¤ë¥¸ ì„¤ëª… ì—†ì´ ë‚˜ë ˆì´ì…˜ ëŒ€ë³¸ë§Œ ì¶œë ¥í•˜ì„¸ìš”."""

        intro_result = _call_gpt51(client, intro_prompt)
        if "error" in intro_result:
            return intro_result
        all_parts.append(intro_result["text"])
        total_cost += intro_result["cost"]
        print(f"[SCRIPT] Part 1 ì™„ë£Œ: {len(intro_result['text']):,}ì")

        # ========================================
        # Part 2: ë°°ê²½ ì„¤ëª… - 3,000ì + ë¦¬í…ì…˜ í›…
        # ========================================
        print(f"[SCRIPT] Part 2: ë°°ê²½ ì„¤ëª… ìƒì„± ì¤‘ (ë¦¬í…ì…˜ í›… í¬í•¨)...")
        background_prompt = f"""[ì´ì „ íŒŒíŠ¸ - ì¸íŠ¸ë¡œ]
{intro_result['text'][-500:]}

[ìˆ˜ì§‘ëœ ìë£Œ]
{full_content[:5000]}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[ì‘ì„± ì§€ì‹œ - ë°°ê²½ ì„¤ëª…] â˜… ìŠ¤í† ë¦¬í…”ë§ + ìë£Œ ê¸°ë°˜
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â˜…â˜…â˜… í•µì‹¬ ì›ì¹™ â˜…â˜…â˜…
- ìˆ˜ì§‘ëœ ìë£Œì— ìˆëŠ” ë‚´ìš©ë§Œ ì‚¬ìš© (ìƒìƒ ê¸ˆì§€)
- ì¶œì²˜ í‘œê¸° ê¸ˆì§€ ("~ì— ë”°ë¥´ë©´" âŒ) â†’ ì¶œì²˜ëŠ” ìœ íŠœë¸Œ ì„¤ëª…ë€ì— ë³„ë„ ì •ë¦¬
- ë§ˆì¹˜ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ë“¯ ìì—°ìŠ¤ëŸ½ê²Œ ì„œìˆ 

ã€ë‚´ìš© êµ¬ì„±ã€‘
1. ì‹œëŒ€ì  ë§¥ë½ (1,000ì)
   - ìë£Œì— ìˆëŠ” ì‹œëŒ€ ìƒí™©ì„ ì´ì•¼ê¸°ì²˜ëŸ¼ ì„œìˆ 
   - ì—°ë„, ì™•, ì£¼ìš” ì‚¬ê±´ ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ì„œ

2. ì¸ë¬¼/ì„¸ë ¥ ì†Œê°œ (1,000ì)
   - ë“±ì¥ì¸ë¬¼ì„ ì´ì•¼ê¸° ì† ìºë¦­í„°ì²˜ëŸ¼ ì†Œê°œ
   - ë”±ë”±í•œ ì„¤ëª… âŒ, ìƒìƒí•œ ì„œìˆ  âœ…

3. ì´ì „ ì‚¬ê±´ê³¼ ì—°ê²° (1,000ì)
   - ì›ì¸ â†’ ê²°ê³¼ì˜ ì¸ê³¼ê´€ê³„ë¥¼ ì´ì•¼ê¸°ë¡œ

ã€ì´íƒˆ ë°©ì§€ - 2ê°œ í›… ì‚½ì…ã€‘
ë°°ê²½ ì„¤ëª…ì´ ì§€ë£¨í•´ì§€ì§€ ì•Šë„ë¡:

í›… ìœ„ì¹˜ 1 (ì•½ 1,000ì ì§€ì ):
âœ… "ê·¸ëŸ°ë° ì—¬ê¸°ì„œ í•œ ê°€ì§€ ì˜ë¬¸ì´ ìƒê¹ë‹ˆë‹¤."
âœ… "í•˜ì§€ë§Œ ì—¬ê¸°ì„œ ì´ìƒí•œ ì ì´ ìˆìŠµë‹ˆë‹¤."

í›… ìœ„ì¹˜ 2 (ì•½ 2,000ì ì§€ì ):
âœ… "ì´ ìƒí™©ì´ ì–´ë–»ê²Œ ì „ê°œë˜ì—ˆì„ê¹Œìš”?"
âœ… "ì´ì œ ë³¸ê²©ì ì¸ ì´ì•¼ê¸°ê°€ ì‹œì‘ë©ë‹ˆë‹¤."

[ìŠ¤íƒ€ì¼]
- í¥ë¯¸ë¡œìš´ ìŠ¤í† ë¦¬í…”ë§
- ì¶œì²˜ í‘œê¸° ê¸ˆì§€
- ê°ì • í‘œí˜„ ê¸ˆì§€
- ì§§ì€ ë¬¸ì¥ (50ì ì´ë‚´)

[ë¶„ëŸ‰] ì•½ 3,000ì

ëŒ€ë³¸ë§Œ ì‘ì„±í•˜ì„¸ìš”."""

        bg_result = _call_gpt51(client, background_prompt)
        if "error" in bg_result:
            return bg_result
        all_parts.append(bg_result["text"])
        total_cost += bg_result["cost"]
        print(f"[SCRIPT] Part 2 ì™„ë£Œ: {len(bg_result['text']):,}ì")

        # ========================================
        # Part 3-1: ë³¸ë¡  ì „ë°˜ë¶€ - 6,000ì + ë¦¬í…ì…˜ í›…
        # ========================================
        print(f"[SCRIPT] Part 3-1: ë³¸ë¡  ì „ë°˜ë¶€ ìƒì„± ì¤‘ (ë¦¬í…ì…˜ í›… í¬í•¨)...")
        body1_prompt = f"""[ì´ì „ íŒŒíŠ¸ ë§ˆì§€ë§‰ ë¶€ë¶„]
{bg_result['text'][-500:]}

[ìˆ˜ì§‘ëœ ìë£Œ]
{full_content}

[ì¶œì²˜ ëª©ë¡]
{source_list}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[ì‘ì„± ì§€ì‹œ - ë³¸ë¡  ì „ë°˜ë¶€] â˜… ìŠ¤í† ë¦¬í…”ë§ + ìë£Œ ê¸°ë°˜
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â˜…â˜…â˜… ì ˆëŒ€ ì›ì¹™ â˜…â˜…â˜…
- ìˆ˜ì§‘ëœ ìë£Œì— ìˆëŠ” ë‚´ìš©ë§Œ ì‚¬ìš© (ìƒìƒ ê¸ˆì§€)
- ì¶œì²˜ í‘œê¸° ê¸ˆì§€ ("~ì— ë”°ë¥´ë©´" âŒ) â†’ íë¦„ì„ ëŠì§€ ì•Šë„ë¡
- ë§ˆì¹˜ ì—­ì‚¬ ë‹¤íë©˜í„°ë¦¬ ë‚˜ë ˆì´ì…˜ì²˜ëŸ¼ ì´ì•¼ê¸°ë¥¼ ì „ë‹¬

ã€ë‚´ìš© êµ¬ì„± - ì‹œê°„ìˆœ ì „ê°œã€‘
ê° ì‚¬ê±´ì„ ì´ì•¼ê¸°ì²˜ëŸ¼ í’€ì–´ì„œ:
- ì—°ë„/ì‹œê¸°ëŠ” ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ì„œ ("ì„œê¸° 391ë…„, ~")
- ì¸ë¬¼ì˜ í–‰ë™ê³¼ ê²°ì •ì„ ì¤‘ì‹¬ìœ¼ë¡œ
- ì›ì¸ â†’ ì „ê°œ â†’ ê²°ê³¼ë¥¼ ë“œë¼ë§ˆí‹±í•˜ê²Œ

ã€ì´íƒˆ ë°©ì§€ - 3ê°œ í›… ì‚½ì…ã€‘
ë³¸ë¡ ì´ ì§€ë£¨í•´ì§€ì§€ ì•Šë„ë¡ 2,000ìë§ˆë‹¤ í›…:

í›… ìœ„ì¹˜ 1 (ì•½ 2,000ì ì§€ì ):
âœ… "ê·¸ëŸ°ë° ì—¬ê¸°ì„œ ì˜ˆìƒì¹˜ ëª»í•œ ì¼ì´ ë²Œì–´ì§‘ë‹ˆë‹¤."
âœ… "í•˜ì§€ë§Œ ìƒí™©ì€ ê¸‰ë³€í•©ë‹ˆë‹¤."

í›… ìœ„ì¹˜ 2 (ì•½ 4,000ì ì§€ì ):
âœ… "ìƒí™©ì€ ì ì  ë³µì¡í•´ì§‘ë‹ˆë‹¤."
âœ… "í•˜ì§€ë§Œ ì´ê²ƒì€ ì‹œì‘ì— ë¶ˆê³¼í–ˆìŠµë‹ˆë‹¤."

í›… ìœ„ì¹˜ 3 (ì•½ 6,000ì ì§€ì ):
âœ… "ê²°ì •ì ì¸ ìˆœê°„ì´ ë‹¤ê°€ì˜µë‹ˆë‹¤."
âœ… "ì´ì œ ëª¨ë“  ê²ƒì´ ë‹¬ë¼ì§€ë ¤ í•©ë‹ˆë‹¤."

[ìŠ¤íƒ€ì¼]
- í¥ë¯¸ë¡œìš´ ìŠ¤í† ë¦¬í…”ë§
- ì¶œì²˜ í‘œê¸° ê¸ˆì§€ (íë¦„ ìœ ì§€)
- ê°ì • í‘œí˜„ ê¸ˆì§€ (ê°ê´€ì  ì„œìˆ )
- ì§§ì€ ë¬¸ì¥ (50ì ì´ë‚´)

[ë¶„ëŸ‰] ì•½ 6,000ì

ëŒ€ë³¸ë§Œ ì‘ì„±í•˜ì„¸ìš”."""

        body1_result = _call_gpt51(client, body1_prompt)
        if "error" in body1_result:
            return body1_result
        all_parts.append(body1_result["text"])
        total_cost += body1_result["cost"]
        print(f"[SCRIPT] Part 3-1 ì™„ë£Œ: {len(body1_result['text']):,}ì")

        print(f"[SCRIPT] Part 3-2: ë³¸ë¡  í›„ë°˜ë¶€ ìƒì„± ì¤‘ (ë¦¬í…ì…˜ í›… í¬í•¨)...")
        body2_prompt = f"""[ì´ì „ íŒŒíŠ¸ ë§ˆì§€ë§‰ ë¶€ë¶„]
{body1_result['text'][-500:]}

[ìˆ˜ì§‘ëœ ìë£Œ ì¤‘ ì•„ì§ ë‹¤ë£¨ì§€ ì•Šì€ ë¶€ë¶„]
{full_content[len(full_content)//2:]}

[ì¶œì²˜ ëª©ë¡]
{source_list}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[ì‘ì„± ì§€ì‹œ - ë³¸ë¡  í›„ë°˜ë¶€] â˜… ìŠ¤í† ë¦¬í…”ë§ + ìë£Œ ê¸°ë°˜
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â˜…â˜…â˜… ì ˆëŒ€ ì›ì¹™ â˜…â˜…â˜…
- ìˆ˜ì§‘ëœ ìë£Œì— ìˆëŠ” ë‚´ìš©ë§Œ ì‚¬ìš© (ìƒìƒ ê¸ˆì§€)
- ì¶œì²˜ í‘œê¸° ê¸ˆì§€ â†’ íë¦„ì„ ëŠì§€ ì•Šë„ë¡
- ì´ì•¼ê¸°ì˜ í´ë¼ì´ë§¥ìŠ¤ë¥¼ í–¥í•´ ì „ê°œ

ã€ë‚´ìš© êµ¬ì„±ã€‘
1. ì‚¬ê±´ì˜ ì „ê°œ ê³„ì† (3,000ì)
   - ì´ì „ íŒŒíŠ¸ì—ì„œ ì´ì–´ì§€ëŠ” ì´ì•¼ê¸°
   - ê¸´ì¥ê° ìœ ì§€í•˜ë©° ì „ê°œ

2. í´ë¼ì´ë§¥ìŠ¤ì™€ ê²°ë§ (2,000ì)
   - ê°€ì¥ ê·¹ì ì¸ ìˆœê°„
   - ì‚¬ê±´ì˜ ìµœì¢… ê²°ê³¼

3. ì—´ë¦° ì§ˆë¬¸ (1,000ì)
   - "ì™œ ê·¸ëŸ° ì„ íƒì„ í–ˆì„ê¹Œìš”?"
   - "ë§Œì•½ ~í–ˆë‹¤ë©´ ì–´ë• ì„ê¹Œìš”?"
   - ì‹œì²­ìê°€ ìƒê°í•´ë³¼ ì—¬ì§€ ë‚¨ê¸°ê¸°

ã€ì´íƒˆ ë°©ì§€ - 3ê°œ í›… ì‚½ì…ã€‘

í›… ìœ„ì¹˜ 1 (ì•½ 2,000ì ì§€ì ):
âœ… "ê·¸ëŸ¬ë‚˜ ìƒí™©ì€ ì—¬ê¸°ì„œ ë°˜ì „ë©ë‹ˆë‹¤."
âœ… "ì˜ˆìƒê³¼ ë‹¤ë¥¸ ì¼ì´ ë²Œì–´ì§‘ë‹ˆë‹¤."

í›… ìœ„ì¹˜ 2 (ì•½ 4,000ì ì§€ì ):
âœ… "ì´ ê²°ì •ì´ ì–´ë–¤ ê²°ê³¼ë¥¼ ê°€ì ¸ì™”ì„ê¹Œìš”?"
âœ… "ë‹¹ì‹œ ì‚¬ëŒë“¤ì€ ì–´ë–»ê²Œ ë°›ì•„ë“¤ì˜€ì„ê¹Œìš”?"

í›… ìœ„ì¹˜ 3 (ì•½ 6,000ì ì§€ì ):
âœ… "í•˜ì§€ë§Œ ì—¬ê¸°ì„œ ì˜ë¬¸ì´ ë‚¨ìŠµë‹ˆë‹¤."
âœ… "ê³¼ì—° ìµœì„ ì˜ ì„ íƒì´ì—ˆì„ê¹Œìš”?"

[ìŠ¤íƒ€ì¼]
- í¥ë¯¸ë¡œìš´ ìŠ¤í† ë¦¬í…”ë§
- ì¶œì²˜ í‘œê¸° ê¸ˆì§€ (íë¦„ ìœ ì§€)
- ê°ì • í‘œí˜„ ê¸ˆì§€ (ê°ê´€ì  ì„œìˆ )
- ì§§ì€ ë¬¸ì¥ (50ì ì´ë‚´)

[ë¶„ëŸ‰] ì•½ 6,000ì

ëŒ€ë³¸ë§Œ ì‘ì„±í•˜ì„¸ìš”."""

        body2_result = _call_gpt51(client, body2_prompt)
        if "error" in body2_result:
            return body2_result
        all_parts.append(body2_result["text"])
        total_cost += body2_result["cost"]
        print(f"[SCRIPT] Part 3-2 ì™„ë£Œ: {len(body2_result['text']):,}ì")

        # ========================================
        # Part 4: ë§ˆë¬´ë¦¬ - 3,500ì + ë‹¤ìŒ ì˜ˆê³ 
        # ========================================
        print(f"[SCRIPT] Part 4: ë§ˆë¬´ë¦¬ ìƒì„± ì¤‘...")
        ending_prompt = f"""[ì´ì „ íŒŒíŠ¸ ë§ˆì§€ë§‰ ë¶€ë¶„]
{body2_result['text'][-500:]}

{next_preview}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[ì‘ì„± ì§€ì‹œ - ë§ˆë¬´ë¦¬] â˜… ì—¬ìš´ + ë‹¤ìŒ ì˜ˆê³ 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â˜…â˜…â˜… í•µì‹¬ ì›ì¹™ â˜…â˜…â˜…
- ìˆ˜ì§‘ëœ ìë£Œì— ìˆëŠ” ë‚´ìš©ë§Œ ì‚¬ìš© (ìƒìƒ ê¸ˆì§€)
- ì¶œì²˜ í‘œê¸° ê¸ˆì§€ â†’ íë¦„ ìœ ì§€
- ì‹œì²­ìê°€ ë‹¤ìŒ ì˜ìƒë„ ë³´ê³  ì‹¶ê²Œ ë§Œë“¤ê¸°

ã€ë‚´ìš© êµ¬ì„±ã€‘
1. ì—­ì‚¬ì  ì˜í–¥ (1,500ì)
   - ì´ ì‚¬ê±´ì´ ì´í›„ì— ë¯¸ì¹œ ì˜í–¥
   - "ê·¸ë¡œë¶€í„° ~ë…„ í›„..."
   - ì´ì•¼ê¸°ì²˜ëŸ¼ ìì—°ìŠ¤ëŸ½ê²Œ ì„œìˆ 

2. ì—´ë¦° ì§ˆë¬¸ (1,000ì)
   - ì‹œì²­ìê°€ ìƒê°í•´ë³¼ ì§ˆë¬¸
   - "ë§Œì•½ ~í–ˆë‹¤ë©´ ì–´ë• ì„ê¹Œìš”?"
   - "ê³¼ì—° ìµœì„ ì˜ ì„ íƒì´ì—ˆì„ê¹Œìš”?"
   - ëŒ“ê¸€ë¡œ ì˜ê²¬ì„ ë‚¨ê¸°ê³  ì‹¶ê²Œ ë§Œë“¤ê¸°

3. ë‹¤ìŒ ì—í”¼ì†Œë“œ ì˜ˆê³  (1,000ì)
   - ë‹¤ìŒ ì´ì•¼ê¸°ì— ëŒ€í•œ ê¸°ëŒ€ê° ì¡°ì„±
   - "ë‹¤ìŒ ì‹œê°„ì—ëŠ” ë” ê·¹ì ì¸ ì´ì•¼ê¸°ê°€ í¼ì³ì§‘ë‹ˆë‹¤"
   - Open Loopë¡œ ë§ˆë¬´ë¦¬ (ê¶ê¸ˆì¦ ë‚¨ê¸°ê¸°)

ã€ë§ˆë¬´ë¦¬ í›…ã€‘
ì˜ìƒ ëê¹Œì§€ ë³´ê²Œ ë§Œë“œëŠ” ë§ˆë¬´ë¦¬:
âœ… "ì´ ì„ íƒì´ ì´í›„ ì—­ì‚¬ë¥¼ ì–´ë–»ê²Œ ë°”ê¿¨ì„ê¹Œìš”?"
âœ… "ë‹¤ìŒ ì‹œê°„ì—ëŠ” ë” ë†€ë¼ìš´ ì´ì•¼ê¸°ê°€ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤."
âœ… "ê³¼ì—° ê·¸ë“¤ì˜ ê²°ì •ì€ ì˜³ì•˜ì„ê¹Œìš”? ì—¬ëŸ¬ë¶„ì˜ ìƒê°ì€ ì–´ë– ì‹ ê°€ìš”?"

[ìŠ¤íƒ€ì¼]
- í¥ë¯¸ë¡œìš´ ìŠ¤í† ë¦¬í…”ë§
- ì¶œì²˜ í‘œê¸° ê¸ˆì§€
- ê°ì • í‘œí˜„ ê¸ˆì§€
- ë‹¤ìŒ ì˜ìƒ í´ë¦­ ìœ ë„

[ë¶„ëŸ‰] ì•½ 3,500ì

ëŒ€ë³¸ë§Œ ì‘ì„±í•˜ì„¸ìš”."""

        ending_result = _call_gpt51(client, ending_prompt)
        if "error" in ending_result:
            return ending_result
        all_parts.append(ending_result["text"])
        total_cost += ending_result["cost"]
        print(f"[SCRIPT] Part 4 ì™„ë£Œ: {len(ending_result['text']):,}ì")

        # ì „ì²´ ëŒ€ë³¸ í•©ì¹˜ê¸°
        full_script = "\n\n".join(all_parts)
        script_length = len(full_script)

        print(f"[SCRIPT] === íŒŒíŠ¸ë³„ ëŒ€ë³¸ ìƒì„± ì™„ë£Œ ===")
        print(f"[SCRIPT] ì´ ë¶„ëŸ‰: {script_length:,}ì")
        print(f"[SCRIPT] ì´ ë¹„ìš©: ${total_cost:.4f}")

        # YouTube ì„¤ëª…ë€ìš© ì¶œì²˜ í…ìŠ¤íŠ¸ ìƒì„±
        youtube_sources = _format_sources_for_youtube(sources)

        # ========================================
        # YouTube SEO ë©”íƒ€ë°ì´í„° ìƒì„± â˜… ì¶”ê°€
        # ========================================
        print(f"[SCRIPT] YouTube SEO ë©”íƒ€ë°ì´í„° ìƒì„± ì¤‘...")
        global_ep = series_context.get("global_episode") if series_context else episode
        seo_result = _generate_youtube_seo(
            client=client,
            era_name=era_name,
            episode=episode,
            total_episodes=total_episodes,
            title=title,
            topic=topic,
            intro_text=all_parts[0] if all_parts else "",
            global_episode=global_ep,  # â˜… ì „ì²´ ì‹œë¦¬ì¦ˆ ë²ˆí˜¸ ì „ë‹¬
        )
        total_cost += seo_result.get("cost", 0)

        return {
            "script": full_script,
            "length": script_length,
            "model": "gpt-5.2",
            "cost": total_cost,
            "parts": {
                "intro": len(all_parts[0]) if len(all_parts) > 0 else 0,
                "background": len(all_parts[1]) if len(all_parts) > 1 else 0,
                "body1": len(all_parts[2]) if len(all_parts) > 2 else 0,
                "body2": len(all_parts[3]) if len(all_parts) > 3 else 0,
                "ending": len(all_parts[4]) if len(all_parts) > 4 else 0,
            },
            "youtube_sources": youtube_sources,  # YouTube ì„¤ëª…ë€ìš© ì¶œì²˜
            # â˜… YouTube SEO ë©”íƒ€ë°ì´í„°
            "youtube_title": seo_result.get("title", title),
            "thumbnail_text": seo_result.get("thumbnail_text", ""),
        }

    except Exception as e:
        print(f"[SCRIPT] íŒŒíŠ¸ë³„ ìƒì„± ì‹¤íŒ¨: {e}")
        return {"error": str(e)}


def _call_gpt52(client, prompt: str) -> Dict[str, Any]:
    """GPT-5.2 API í˜¸ì¶œ (Responses API)

    GPT-5.2 ê°€ê²©:
    - Input: $1.75 / 1M tokens
    - Output: $14 / 1M tokens
    """
    try:
        response = client.responses.create(
            model="gpt-5.2",
            input=prompt,
        )

        # ê²°ê³¼ ì¶”ì¶œ
        text = response.output_text if hasattr(response, 'output_text') else ""

        if not text:
            # ëŒ€ì²´ ë°©ì‹
            for item in getattr(response, "output", []) or []:
                for content in getattr(item, "content", []) or []:
                    if getattr(content, "type", "") == "text":
                        text += getattr(content, "text", "")

        # ë¹„ìš© ê³„ì‚° (GPT-5.2 ê°€ê²©: $1.75/1M input, $14/1M output)
        input_tokens = len(prompt) // 2  # í•œêµ­ì–´ ì•½ 2ì = 1í† í°
        output_tokens = len(text) // 2
        cost = (input_tokens * 1.75 / 1_000_000) + (output_tokens * 14 / 1_000_000)

        return {"text": text.strip(), "cost": cost}

    except Exception as e:
        return {"error": str(e)}


# ì´ì „ ë²„ì „ í˜¸í™˜ì„±ì„ ìœ„í•œ ë³„ì¹­
_call_gpt51 = _call_gpt52


def _build_next_preview(next_info: Dict[str, Any], era_name: str) -> str:
    """ë‹¤ìŒ ì—í”¼ì†Œë“œ ì˜ˆê³  í…ìŠ¤íŠ¸"""
    if not next_info:
        return ""

    if next_info.get("type") == "next_era":
        return f"""[ë‹¤ìŒ ì—í”¼ì†Œë“œ ì •ë³´]
- ë‹¤ìŒ ì‹œëŒ€: {next_info.get('era_name', '')}
- ë‹¤ìŒ ì£¼ì œ: {next_info.get('title', '')}
- ì˜ˆê³ : "ë‹¤ìŒ ì‹œê°„ì—ëŠ” {next_info.get('era_name', '')}ì˜ ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. {next_info.get('title', '')}ì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤."
"""
    elif next_info.get("type") == "next_episode":
        return f"""[ë‹¤ìŒ ì—í”¼ì†Œë“œ ì •ë³´]
- ë‹¤ìŒ í™”: {era_name} {next_info.get('era_episode', '')}í™”
- ë‹¤ìŒ ì£¼ì œ: {next_info.get('title', '')}
- ì˜ˆê³ : "ë‹¤ìŒ ì‹œê°„ì—ëŠ” {next_info.get('title', '')}ì— ëŒ€í•´ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤."
"""
    else:
        return """[ì‹œë¦¬ì¦ˆ ë§ˆì§€ë§‰]
- ì‹œë¦¬ì¦ˆ ì™„ê²°
- ì „ì²´ ì‹œë¦¬ì¦ˆë¥¼ ì •ë¦¬í•˜ë©° ë§ˆë¬´ë¦¬
"""


def _build_prev_context(prev_info: Dict[str, Any], era_name: str) -> str:
    """
    ì´ì „ ì—í”¼ì†Œë“œ ì»¨í…ìŠ¤íŠ¸ ìƒì„± (API ì¥ì  í™œìš©)

    ì´ì „ ì—í”¼ì†Œë“œ ì •ë³´ë¥¼ ë°›ì•„ì„œ ìì—°ìŠ¤ëŸ¬ìš´ ì—°ê²°ì„ ìœ„í•œ ì»¨í…ìŠ¤íŠ¸ ìƒì„±
    """
    if not prev_info:
        return """[ì´ì „ ì—í”¼ì†Œë“œ]
- ì²« ì—í”¼ì†Œë“œì…ë‹ˆë‹¤.
- ì‹œë¦¬ì¦ˆ ì‹œì‘ ì¸ì‚¬ë¡œ ì‹œì‘í•˜ì„¸ìš”.
- ì˜ˆ: "í•œêµ­ì‚¬ì˜ ì‹œì‘, ê³ ì¡°ì„  ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."
"""

    if prev_info.get("type") == "same_era":
        return f"""[ì´ì „ ì—í”¼ì†Œë“œ - {era_name} ì—°ì†]
- ì´ì „ í™”: {prev_info.get('title', '')}
- ì´ì „ ë‚´ìš© ìš”ì•½: {prev_info.get('summary', '')}
- ì—°ê²° ë°©ì‹: "ì§€ë‚œ ì‹œê°„, {prev_info.get('summary', '')}... ì˜¤ëŠ˜ì€ ê·¸ ì´í›„ ì´ì•¼ê¸°ì…ë‹ˆë‹¤."
"""
    elif prev_info.get("type") == "new_era":
        return f"""[ìƒˆë¡œìš´ ì‹œëŒ€ ì‹œì‘]
- ì´ì „ ì‹œëŒ€: {prev_info.get('prev_era_name', '')}
- ì´ì „ ì‹œëŒ€ ë§ˆì§€ë§‰ ì‚¬ê±´: {prev_info.get('summary', '')}
- ì—°ê²° ë°©ì‹: "{prev_info.get('prev_era_name', '')}ê°€ ì €ë¬¼ê³ , ìƒˆë¡œìš´ ì‹œëŒ€ê°€ ì—´ë¦½ë‹ˆë‹¤..."
"""
    else:
        return ""


def _build_series_position(series_ctx: Dict[str, Any], era_name: str, episode: int, total: int) -> str:
    """
    ì‹œë¦¬ì¦ˆ ì „ì²´ì—ì„œì˜ í˜„ì¬ ìœ„ì¹˜ ì»¨í…ìŠ¤íŠ¸ ìƒì„± (API ì¥ì  í™œìš©)

    ì „ì²´ ì‹œë¦¬ì¦ˆì—ì„œ í˜„ì¬ ì—í”¼ì†Œë“œê°€ ì–´ë””ì— ìœ„ì¹˜í•˜ëŠ”ì§€ ì•Œë ¤ì¤Œ
    """
    if not series_ctx:
        return f"""[ì‹œë¦¬ì¦ˆ ìœ„ì¹˜]
- í˜„ì¬: {era_name} ì‹œëŒ€ {episode}/{total}í™”
- ìœ„ì¹˜ í™œìš©: ì‹œëŒ€ì˜ ì‹œì‘/ì¤‘ë°˜/ëì— ë”°ë¼ í†¤ ì¡°ì ˆ
  - ì‹œëŒ€ ì‹œì‘ (1-2í™”): ìƒˆë¡œìš´ ì‹œëŒ€ì˜ ì‹œì‘ì„ ì•Œë¦¼
  - ì‹œëŒ€ ì¤‘ë°˜: í•µì‹¬ ì‚¬ê±´ ì „ê°œ
  - ì‹œëŒ€ ë (ë§ˆì§€ë§‰ 1-2í™”): ì‹œëŒ€ì˜ ë§ˆë¬´ë¦¬ì™€ ë‹¤ìŒ ì‹œëŒ€ ì˜ˆê³ 
"""

    global_episode = series_ctx.get("global_episode", 0)
    total_global = series_ctx.get("total_global_episodes", 60)
    era_index = series_ctx.get("era_index", 0)
    total_eras = series_ctx.get("total_eras", 8)

    # ì‹œë¦¬ì¦ˆ ë‚´ ìœ„ì¹˜ íŒŒì•…
    if episode == 1:
        position_hint = "ì‹œëŒ€ ì‹œì‘ - ìƒˆë¡œìš´ ì‹œëŒ€ì˜ ì„œë§‰ì„ ì•Œë¦¬ì„¸ìš”"
    elif episode == total:
        position_hint = "ì‹œëŒ€ ë§ˆì§€ë§‰ - ì‹œëŒ€ë¥¼ ì •ë¦¬í•˜ê³  ë‹¤ìŒ ì‹œëŒ€ë¥¼ ì˜ˆê³ í•˜ì„¸ìš”"
    elif episode <= 2:
        position_hint = "ì‹œëŒ€ ì´ˆë°˜ - ë°°ê²½ê³¼ ì£¼ìš” ì¸ë¬¼ ì†Œê°œì— ì§‘ì¤‘"
    elif episode >= total - 1:
        position_hint = "ì‹œëŒ€ í›„ë°˜ - í´ë¼ì´ë§¥ìŠ¤ë¥¼ í–¥í•´ ì „ê°œ"
    else:
        position_hint = "ì‹œëŒ€ ì¤‘ë°˜ - í•µì‹¬ ì‚¬ê±´ ì „ê°œ"

    return f"""[ì‹œë¦¬ì¦ˆ ì „ì²´ ìœ„ì¹˜ - API ì¥ì ]
- ì „ì²´: {global_episode}/{total_global}í™” (í•œêµ­ì‚¬ í†µì‚¬ ì‹œë¦¬ì¦ˆ)
- í˜„ì¬ ì‹œëŒ€: {era_name} ({era_index+1}/{total_eras}ë²ˆì§¸ ì‹œëŒ€)
- ì‹œëŒ€ ë‚´: {episode}/{total}í™”
- ìœ„ì¹˜ ê°€ì´ë“œ: {position_hint}

â˜… ì´ ìœ„ì¹˜ ì •ë³´ë¥¼ í™œìš©í•˜ì„¸ìš”:
- ì‹œë¦¬ì¦ˆ ì „ë°˜ë¶€: ê¸°ì´ˆ ë§¥ë½ ì¶©ë¶„íˆ ì„¤ëª…
- ì‹œë¦¬ì¦ˆ ì¤‘ë°˜: ì—­ì‚¬ì˜ íë¦„ê³¼ ì—°ê²°ì  ê°•ì¡°
- ì‹œë¦¬ì¦ˆ í›„ë°˜: ì•ì„œ ë‹¤ë£¬ ë‚´ìš© ë ˆí¼ëŸ°ìŠ¤ ê°€ëŠ¥
"""


def _generate_youtube_seo(
    client,
    era_name: str,
    episode: int,
    total_episodes: int,
    title: str,
    topic: str,
    intro_text: str,
    global_episode: int = None,  # â˜… ì „ì²´ ì‹œë¦¬ì¦ˆ ë²ˆí˜¸
) -> Dict[str, Any]:
    """
    YouTube SEO ìµœì í™” ë©”íƒ€ë°ì´í„° ìƒì„±

    Returns:
        {
            "title": YouTube ì œëª© (í´ë¦­ ìœ ë„),
            "thumbnail_text": ì¸ë„¤ì¼ ë¬¸êµ¬ (2ì¤„),
            "cost": API ë¹„ìš©
        }
    """
    # ì „ì²´ ì‹œë¦¬ì¦ˆ ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´ ì—í”¼ì†Œë“œ ë²ˆí˜¸ ì‚¬ìš©
    series_num = global_episode if global_episode else episode

    prompt = f"""ë‹¹ì‹ ì€ YouTube SEO ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

[ì˜ìƒ ì •ë³´]
- ì‹œë¦¬ì¦ˆ: í•œêµ­ì‚¬ - {era_name}
- ì „ì²´ ì‹œë¦¬ì¦ˆ ë²ˆí˜¸: {series_num}í™”
- ì‹œëŒ€ ë‚´ ì—í”¼ì†Œë“œ: {episode}/{total_episodes}í™”
- ì›ë³¸ ì œëª©: {title}
- ì£¼ì œ: {topic}

[ëŒ€ë³¸ ì¸íŠ¸ë¡œ]
{intro_text[:1000]}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[ì‘ì—… 1: YouTube ì œëª© ì‘ì„±]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â˜… í•„ìˆ˜ í˜•ì‹: "í•œêµ­ì‚¬ ì‹œë¦¬ì¦ˆ {series_num}í™” | [ë‚´ìš©]"

ì´ í˜•ì‹ì„ ë°˜ë“œì‹œ ì§€í‚¤ë©´ì„œ í´ë¦­ì„ ìœ ë„í•˜ëŠ” ì œëª©ì„ ì‘ì„±í•˜ì„¸ìš”.

ê·œì¹™:
- í˜•ì‹: "í•œêµ­ì‚¬ ì‹œë¦¬ì¦ˆ Ní™” | [ë‚´ìš©]" í•„ìˆ˜
- [ë‚´ìš©] ë¶€ë¶„ì€ 30ì ì´ë‚´
- í´ë¦­ ìœ ë„ ìš”ì†Œ:
  âœ… í•µì‹¬ í‚¤ì›Œë“œ í¬í•¨
  âœ… ì§§ê³  ì„íŒ©íŠ¸ ìˆê²Œ
  âœ… ì§ˆë¬¸í˜• ë˜ëŠ” ê²°ê³¼í˜•
- ê°ì •ì  ê³¼ì¥ ê¸ˆì§€ (ì¶©ê²©ì , ë†€ë¼ìš´ ë“± âŒ)

ì¢‹ì€ ì˜ˆ:
- "í•œêµ­ì‚¬ ì‹œë¦¬ì¦ˆ 2í™” | ë¹„íŒŒí˜•ë™ê²€ê³¼ ê³ ì¸ëŒ, ê³ ì¡°ì„ ì˜ í”ì "
- "í•œêµ­ì‚¬ ì‹œë¦¬ì¦ˆ 5í™” | ì™•ê²€ì„± í•¨ë½, ê³ ì¡°ì„ ì˜ ìµœí›„"
- "í•œêµ­ì‚¬ ì‹œë¦¬ì¦ˆ 13í™” | ê´‘ê°œí† ëŒ€ì™•, ë™ë¶ì•„ë¥¼ í˜¸ë ¹í•˜ë‹¤"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[ì‘ì—… 2: ì¸ë„¤ì¼ ë¬¸êµ¬ ì‘ì„±]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ì¸ë„¤ì¼ì— ë“¤ì–´ê°ˆ í…ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

ê·œì¹™:
- 2ì¤„ë¡œ ì‘ì„± (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)
- 1ì¤„ë‹¹ 7ì ì´ë‚´ ê¶Œì¥ (10ì ì´ˆê³¼ ê¸ˆì§€)
- ì§§ê³  ì„íŒ©íŠ¸ ìˆê²Œ
- ì§ˆë¬¸í˜• ë˜ëŠ” ê°íƒ„í˜•

ì¢‹ì€ ì˜ˆ:
```
18ì„¸ ì™•ì˜
ì²« ì¶œì •
```

```
ìˆ¨ê²¨ì§„ ì§„ì‹¤
ë°í˜€ì§€ë‹¤
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[ì¶œë ¥ í˜•ì‹]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ì•„ë˜ í˜•ì‹ìœ¼ë¡œë§Œ ì¶œë ¥í•˜ì„¸ìš”:

TITLE: [YouTube ì œëª©]
THUMBNAIL:
[1ì¤„]
[2ì¤„]
"""

    try:
        result = _call_gpt51(client, prompt)
        if "error" in result:
            return {"title": title, "thumbnail_text": "", "cost": 0}

        text = result.get("text", "")
        cost = result.get("cost", 0)

        # íŒŒì‹±
        youtube_title = title  # ê¸°ë³¸ê°’
        thumbnail_text = ""

        lines = text.strip().split("\n")
        for i, line in enumerate(lines):
            if line.startswith("TITLE:"):
                youtube_title = line.replace("TITLE:", "").strip()
            elif line.startswith("THUMBNAIL:"):
                # ë‹¤ìŒ 2ì¤„ì´ ì¸ë„¤ì¼ í…ìŠ¤íŠ¸
                thumb_lines = []
                for j in range(i + 1, min(i + 3, len(lines))):
                    if lines[j].strip() and not lines[j].startswith("TITLE"):
                        thumb_lines.append(lines[j].strip())
                thumbnail_text = "\n".join(thumb_lines)

        print(f"[SCRIPT] YouTube ì œëª©: {youtube_title}")
        print(f"[SCRIPT] ì¸ë„¤ì¼ ë¬¸êµ¬: {thumbnail_text.replace(chr(10), ' / ')}")

        return {
            "title": youtube_title,
            "thumbnail_text": thumbnail_text,
            "cost": cost,
        }

    except Exception as e:
        print(f"[SCRIPT] SEO ìƒì„± ì‹¤íŒ¨: {e}")
        return {"title": title, "thumbnail_text": "", "cost": 0}


def _format_sources_for_youtube(sources: list) -> str:
    """
    YouTube ì„¤ëª…ë€ìš© ì¶œì²˜ í…ìŠ¤íŠ¸ ìƒì„±

    Returns:
        ì¶œì²˜ ëª©ë¡ (YouTube ì„¤ëª…ë€ì— ë³µì‚¬-ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥í•œ í˜•ì‹)
    """
    if not sources:
        return ""

    lines = ["ğŸ“š ì°¸ê³  ìë£Œ ë° ì¶œì²˜", ""]

    # ì¶œì²˜ë³„ ë¶„ë¥˜
    encykorea = []
    history_db = []
    cultural = []
    museum = []
    others = []

    for url in sources:
        if not url:
            continue
        url_lower = url.lower()
        if "encykorea" in url_lower:
            encykorea.append(url)
        elif "db.history.go.kr" in url_lower or "history.go.kr" in url_lower:
            history_db.append(url)
        elif "heritage.go.kr" in url_lower:
            cultural.append(url)
        elif "museum.go.kr" in url_lower:
            museum.append(url)
        else:
            others.append(url)

    # ì¹´í…Œê³ ë¦¬ë³„ ì¶œë ¥
    if encykorea:
        lines.append("â–¸ í•œêµ­ë¯¼ì¡±ë¬¸í™”ëŒ€ë°±ê³¼ì‚¬ì „")
        for url in encykorea[:3]:  # ìµœëŒ€ 3ê°œ
            lines.append(f"  {url}")
        lines.append("")

    if history_db:
        lines.append("â–¸ êµ­ì‚¬í¸ì°¬ìœ„ì›íšŒ í•œêµ­ì‚¬DB")
        for url in history_db[:3]:
            lines.append(f"  {url}")
        lines.append("")

    if cultural:
        lines.append("â–¸ ë¬¸í™”ì¬ì²­ êµ­ê°€ë¬¸í™”ìœ ì‚°í¬í„¸")
        for url in cultural[:3]:
            lines.append(f"  {url}")
        lines.append("")

    if museum:
        lines.append("â–¸ êµ­ë¦½ì¤‘ì•™ë°•ë¬¼ê´€")
        for url in museum[:3]:
            lines.append(f"  {url}")
        lines.append("")

    if others:
        lines.append("â–¸ ê¸°íƒ€ ìë£Œ")
        for url in others[:3]:
            lines.append(f"  {url}")
        lines.append("")

    return "\n".join(lines)


def generate_script_gpt51(
    era_name: str,
    episode: int,
    total_episodes: int,
    title: str,
    topic: str,
    full_content: str,
    sources: list,
    next_episode_info: Dict[str, Any] = None,
) -> Dict[str, Any]:
    """
    GPT-5.2ë¡œ 20,000ì ëŒ€ë³¸ ìƒì„± (ì´ì „ ë²„ì „ í˜¸í™˜ìš© í•¨ìˆ˜ëª… ìœ ì§€)

    Args:
        era_name: ì‹œëŒ€ëª… (ì˜ˆ: "ì‚¼êµ­ì‹œëŒ€")
        episode: ì—í”¼ì†Œë“œ ë²ˆí˜¸
        total_episodes: ì‹œëŒ€ ì´ ì—í”¼ì†Œë“œ ìˆ˜
        title: ì—í”¼ì†Œë“œ ì œëª©
        topic: ì£¼ì œ
        full_content: ìˆ˜ì§‘ëœ ìë£Œ ì „ì²´ ë‚´ìš©
        sources: ì¶œì²˜ URL ëª©ë¡
        next_episode_info: ë‹¤ìŒ ì—í”¼ì†Œë“œ ì •ë³´ (ì„ íƒ)

    Returns:
        {
            "script": ìƒì„±ëœ ëŒ€ë³¸,
            "length": ê¸€ììˆ˜,
            "model": ì‚¬ìš© ëª¨ë¸,
            "cost": ì˜ˆìƒ ë¹„ìš©,
            "error": ì—ëŸ¬ ë©”ì‹œì§€ (ì‹¤íŒ¨ ì‹œ)
        }
    """
    api_key = os.environ.get("OPENAI_API_KEY")
    if not api_key:
        return {"error": "OPENAI_API_KEY í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."}

    if not full_content or len(full_content) < 1000:
        return {"error": f"ìˆ˜ì§‘ëœ ìë£Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í˜„ì¬: {len(full_content)}ì)"}

    # ë‹¤ìŒ ì—í”¼ì†Œë“œ ì •ë³´
    next_info_text = ""
    if next_episode_info:
        if next_episode_info.get("type") == "next_era":
            next_info_text = f"""
[ë‹¤ìŒ ì—í”¼ì†Œë“œ ì •ë³´]
- ë‹¤ìŒ ì‹œëŒ€: {next_episode_info.get('era_name', '')}
- ë‹¤ìŒ ì£¼ì œ: {next_episode_info.get('title', '')}
- ì˜ˆê³  ë¬¸êµ¬ ì˜ˆì‹œ: "ë‹¤ìŒ ì‹œê°„ì—ëŠ” {next_episode_info.get('era_name', '')}ì˜ ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."
"""
        elif next_episode_info.get("type") == "next_episode":
            next_info_text = f"""
[ë‹¤ìŒ ì—í”¼ì†Œë“œ ì •ë³´]
- ë‹¤ìŒ í™”: {era_name} {next_episode_info.get('era_episode', episode + 1)}í™”
- ë‹¤ìŒ ì£¼ì œ: {next_episode_info.get('title', '')}
- ì˜ˆê³  ë¬¸êµ¬ ì˜ˆì‹œ: "ë‹¤ìŒ ì‹œê°„ì—ëŠ” {next_episode_info.get('title', '')}ì— ëŒ€í•´ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤."
"""
        else:
            next_info_text = """
[ë‹¤ìŒ ì—í”¼ì†Œë“œ ì •ë³´]
- ì‹œë¦¬ì¦ˆ ë§ˆì§€ë§‰ ì—í”¼ì†Œë“œì…ë‹ˆë‹¤.
- ì „ì²´ ì‹œë¦¬ì¦ˆë¥¼ ì •ë¦¬í•˜ë©° ë§ˆë¬´ë¦¬í•˜ì„¸ìš”.
"""

    # ì¶œì²˜ ëª©ë¡
    source_list = "\n".join([f"  - {s}" for s in sources[:10]]) if sources else "  (ì—†ìŒ)"

    # ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ êµ¬ì„±
    user_prompt = f"""
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[ì—í”¼ì†Œë“œ ì •ë³´]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ì‹œë¦¬ì¦ˆ: í•œêµ­ì‚¬ - {era_name}
- í˜„ì¬: {episode}/{total_episodes}í™”
- ì œëª©: {title}
- ì£¼ì œ: {topic}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[ìˆ˜ì§‘ëœ ìë£Œ]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{full_content}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[ì¶œì²˜ ëª©ë¡]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{source_list}

{next_info_text}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[ì‘ì„± ì§€ì‹œ]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ìœ„ ìë£Œë¥¼ ë°”íƒ•ìœ¼ë¡œ {SCRIPT_TARGET_LENGTH:,}ì ë¶„ëŸ‰ì˜ ë‚˜ë ˆì´ì…˜ ëŒ€ë³¸ì„ ì‘ì„±í•˜ì„¸ìš”.
- ìë£Œì— ì—†ëŠ” ë‚´ìš©ì€ ì¶”ê°€í•˜ì§€ ë§ˆì„¸ìš”.
- í•™ìˆ ì  ì‹ ì¤‘í•¨ì„ ìœ ì§€í•˜ì„¸ìš”.
- ì¶œì²˜ë¥¼ ëª…ì‹œí•˜ì„¸ìš”.
"""

    try:
        client = OpenAI(api_key=api_key)

        print(f"[SCRIPT] GPT-5.2 ëŒ€ë³¸ ìƒì„± ì‹œì‘...")
        print(f"[SCRIPT] ì…ë ¥ ìë£Œ: {len(full_content):,}ì")

        # GPT-5.2 Responses API í˜¸ì¶œ
        response = client.responses.create(
            model="gpt-5.2",
            input=[
                {
                    "role": "system",
                    "content": [{"type": "input_text", "text": SCRIPT_STYLE_PROMPT}]
                },
                {
                    "role": "user",
                    "content": [{"type": "input_text", "text": user_prompt}]
                }
            ],
            temperature=0.7,
        )

        # ê²°ê³¼ ì¶”ì¶œ
        if getattr(response, "output_text", None):
            script = response.output_text.strip()
        else:
            text_chunks = []
            for item in getattr(response, "output", []) or []:
                for content in getattr(item, "content", []) or []:
                    if getattr(content, "type", "") == "text":
                        text_chunks.append(getattr(content, "text", ""))
            script = "\n".join(text_chunks).strip()

        script_length = len(script)

        # í† í° ê³„ì‚° (í•œêµ­ì–´ ì•½ 2ì = 1í† í°)
        # GPT-5.2 ê°€ê²©: $1.75/1M input, $14/1M output
        input_tokens = (len(SCRIPT_STYLE_PROMPT) + len(user_prompt)) // 2
        output_tokens = script_length // 2
        cost = (input_tokens * 1.75 / 1_000_000) + (output_tokens * 14 / 1_000_000)

        print(f"[SCRIPT] ëŒ€ë³¸ ìƒì„± ì™„ë£Œ: {script_length:,}ì")
        print(f"[SCRIPT] ì˜ˆìƒ ë¹„ìš©: ${cost:.4f}")

        # ë¶„ëŸ‰ ì²´í¬
        if script_length < SCRIPT_MIN_LENGTH:
            print(f"[SCRIPT] âš ï¸ ë¶„ëŸ‰ ë¶€ì¡± ({script_length:,}ì < {SCRIPT_MIN_LENGTH:,}ì)")
        elif script_length > SCRIPT_MAX_LENGTH:
            print(f"[SCRIPT] âš ï¸ ë¶„ëŸ‰ ì´ˆê³¼ ({script_length:,}ì > {SCRIPT_MAX_LENGTH:,}ì)")

        return {
            "script": script,
            "length": script_length,
            "model": "gpt-5.2",
            "cost": cost,
            "input_tokens": input_tokens,
            "output_tokens": output_tokens,
        }

    except Exception as e:
        print(f"[SCRIPT] GPT-5.2 í˜¸ì¶œ ì‹¤íŒ¨: {e}")
        return {"error": str(e)}


def generate_script_with_retry(
    era_name: str,
    episode: int,
    total_episodes: int,
    title: str,
    topic: str,
    full_content: str,
    sources: list,
    next_episode_info: Dict[str, Any] = None,
    max_retries: int = 2,
) -> Dict[str, Any]:
    """
    ëŒ€ë³¸ ìƒì„± (ë¶„ëŸ‰ ë¶€ì¡± ì‹œ ì´ì–´ì“°ê¸°)

    ë¶„ëŸ‰ì´ SCRIPT_MIN_LENGTH ë¯¸ë§Œì´ë©´ ì´ì–´ì“°ê¸° ìš”ì²­
    """
    result = generate_script_gpt51(
        era_name=era_name,
        episode=episode,
        total_episodes=total_episodes,
        title=title,
        topic=topic,
        full_content=full_content,
        sources=sources,
        next_episode_info=next_episode_info,
    )

    if "error" in result:
        return result

    script = result.get("script", "")
    total_cost = result.get("cost", 0)

    # ë¶„ëŸ‰ ë¶€ì¡± ì‹œ ì´ì–´ì“°ê¸°
    for attempt in range(max_retries):
        if len(script) >= SCRIPT_MIN_LENGTH:
            break

        print(f"[SCRIPT] ë¶„ëŸ‰ ë¶€ì¡± ({len(script):,}ì), ì´ì–´ì“°ê¸° ì‹œë„ ({attempt + 1}/{max_retries})...")

        continuation = _continue_script(
            era_name=era_name,
            episode=episode,
            title=title,
            current_script=script,
            target_length=SCRIPT_TARGET_LENGTH,
        )

        if "error" in continuation:
            print(f"[SCRIPT] ì´ì–´ì“°ê¸° ì‹¤íŒ¨: {continuation['error']}")
            break

        script += "\n\n" + continuation.get("script", "")
        total_cost += continuation.get("cost", 0)

    result["script"] = script
    result["length"] = len(script)
    result["cost"] = total_cost

    return result


def _continue_script(
    era_name: str,
    episode: int,
    title: str,
    current_script: str,
    target_length: int,
) -> Dict[str, Any]:
    """
    ëŒ€ë³¸ ì´ì–´ì“°ê¸° (ë¶„ëŸ‰ ë¶€ì¡± ì‹œ)
    """
    api_key = os.environ.get("OPENAI_API_KEY")
    if not api_key:
        return {"error": "OPENAI_API_KEY ì—†ìŒ"}

    remaining = target_length - len(current_script)

    prompt = f"""ì•„ë˜ ëŒ€ë³¸ì˜ ì´ì–´ì“°ê¸°ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

[í˜„ì¬ ëŒ€ë³¸ ë§ˆì§€ë§‰ ë¶€ë¶„]
{current_script[-2000:]}

[ì§€ì‹œì‚¬í•­]
- ìœ„ ëŒ€ë³¸ì— ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ëŠ” ë‚´ìš© ì‘ì„±
- ì•½ {remaining:,}ì ë¶„ëŸ‰ ì¶”ê°€
- ê¸°ì¡´ ìŠ¤íƒ€ì¼(í•™ìˆ ì , ê°ê´€ì ) ìœ ì§€
- ë§ˆë¬´ë¦¬ + ë‹¤ìŒ ì—í”¼ì†Œë“œ ì˜ˆê³  í¬í•¨
"""

    try:
        client = OpenAI(api_key=api_key)

        response = client.responses.create(
            model="gpt-5.2",
            input=[
                {
                    "role": "system",
                    "content": [{"type": "input_text", "text": "í•œêµ­ì‚¬ ëŒ€ë³¸ ì‘ê°€ì…ë‹ˆë‹¤. ê¸°ì¡´ ëŒ€ë³¸ì— ì´ì–´ì„œ ì‘ì„±í•©ë‹ˆë‹¤."}]
                },
                {
                    "role": "user",
                    "content": [{"type": "input_text", "text": prompt}]
                }
            ],
            temperature=0.7,
        )

        if getattr(response, "output_text", None):
            continuation = response.output_text.strip()
        else:
            text_chunks = []
            for item in getattr(response, "output", []) or []:
                for content in getattr(item, "content", []) or []:
                    if getattr(content, "type", "") == "text":
                        text_chunks.append(getattr(content, "text", ""))
            continuation = "\n".join(text_chunks).strip()

        # ë¹„ìš© ê³„ì‚° (GPT-5.2 ê°€ê²©: $1.75/1M input, $14/1M output)
        input_tokens = len(prompt) // 2
        output_tokens = len(continuation) // 2
        cost = (input_tokens * 1.75 / 1_000_000) + (output_tokens * 14 / 1_000_000)

        print(f"[SCRIPT] ì´ì–´ì“°ê¸° ì™„ë£Œ: +{len(continuation):,}ì")

        return {
            "script": continuation,
            "length": len(continuation),
            "cost": cost,
        }

    except Exception as e:
        return {"error": str(e)}
