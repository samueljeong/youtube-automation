# Sermon 슈퍼바이저 에이전트 시스템

> **역할**: 사용자의 지시를 받아 하위 에이전트들을 효율적으로 관리하고 설교 작성 워크플로우를 자동 실행

---

## 시스템 개요

```
┌─────────────────────────────────────────────────────────────┐
│                    사용자 (User)                             │
│                         │                                    │
│                    지시/요청                                  │
│                         ▼                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │            슈퍼바이저 에이전트 (Supervisor)          │    │
│  │                                                      │    │
│  │  - 사용자 요청 분석                                  │    │
│  │  - 작업 분배 및 순서 결정                           │    │
│  │  - 하위 에이전트 결과 검수                          │    │
│  │  - 전체 워크플로우 관리                             │    │
│  └─────────────────────────────────────────────────────┘    │
│                         │                                    │
│         ┌───────────────┼───────────────┐                   │
│         ▼               ▼               ▼                   │
│  ┌───────────┐   ┌───────────┐   ┌───────────┐             │
│  │ 분석Agent │   │ 구조Agent │   │ 작성Agent │             │
│  │  (Step1)  │   │  (Step2)  │   │  (Step3)  │             │
│  └───────────┘   └───────────┘   └───────────┘             │
│         │               │               │                   │
│         ▼               ▼               ▼                   │
│  ┌───────────┐   ┌───────────┐   ┌───────────┐             │
│  │ 묵상Agent │   │  QA Agent │   │디자인Agent│             │
│  └───────────┘   └───────────┘   └───────────┘             │
└─────────────────────────────────────────────────────────────┘
```

---

## 하위 에이전트 목록

### 1. 분석 에이전트 (Step1 Agent)
| 항목 | 내용 |
|------|------|
| **역할** | 성경 본문 배경/맥락 분석 |
| **입력** | 성경 구절, 설교 스타일, 카테고리 |
| **출력** | anchors, historical_background, key_terms, guardrails 등 |
| **API** | `POST /api/sermon/process` (step=step1) |
| **모듈** | `sermon_modules/api_sermon.py` |

**주요 분석 항목:**
- 핵심 앵커 (anchors) - 본문의 핵심 메시지
- 역사적 배경 (historical_background)
- 핵심 용어 (key_terms)
- 신학적 가드레일 (guardrails) - 해석의 한계

---

### 2. 구조 에이전트 (Step2 Agent)
| 항목 | 내용 |
|------|------|
| **역할** | 설교 구조/초안 생성 |
| **입력** | Step1 결과, 설교 스타일, 분량 |
| **출력** | sections (대지), subpoints (소대지), illustrations (예화) |
| **API** | `POST /api/sermon/process` (step=step2) |
| **모듈** | `sermon_modules/api_sermon.py` |

**출력 구조:**
```json
{
  "sections": [
    {"title": "대지1", "content": "...", "subpoints": ["소대지1", "소대지2"]}
  ],
  "illustrations": ["예화1", "예화2"],
  "context_data": {...}
}
```

---

### 3. 작성 에이전트 (Step3 Agent)
| 항목 | 내용 |
|------|------|
| **역할** | 최종 설교문 작성 (GPT-PRO) |
| **입력** | Step1 + Step2 결과, 스타일 지침, 분량 |
| **출력** | 완성된 설교문 (글자 수 기준 충족) |
| **API** | `POST /api/sermon/gpt-pro` |
| **모듈** | `sermon_modules/api_sermon.py` |

**분량 기준 (분당 270자):**
| 분량 | 최소 | 목표 | 최대 |
|------|------|------|------|
| 10분 | 2,430자 | 2,700자 | 2,970자 |
| 15분 | 3,645자 | 4,050자 | 4,455자 |
| 20분 | 4,860자 | 5,400자 | 5,940자 |
| 25분 | 6,075자 | 6,750자 | 7,425자 |
| 30분 | 7,290자 | 8,100자 | 8,910자 |

---

### 4. 묵상 에이전트 (Meditation Agent)
| 항목 | 내용 |
|------|------|
| **역할** | 묵상 메시지 생성 |
| **입력** | 설교문 또는 성경 구절 |
| **출력** | 짧은 묵상 글 |
| **API** | `POST /api/sermon/meditation` |
| **모듈** | `sermon_modules/api_sermon.py` |

---

### 5. QA 에이전트 (Q&A Agent)
| 항목 | 내용 |
|------|------|
| **역할** | 설교 관련 질의응답 |
| **입력** | 질문, 설교 컨텍스트 |
| **출력** | 답변 |
| **API** | `POST /api/sermon/qa` |
| **모듈** | `sermon_modules/api_sermon.py` |

---

### 6. 디자인 에이전트 (Design Agent)
| 항목 | 내용 |
|------|------|
| **역할** | 배너, PPT, 말씀카드 생성 |
| **입력** | 설교 제목, 핵심 구절, 스타일 |
| **출력** | 이미지 파일 |
| **API** | `POST /api/banner/generate*` |
| **모듈** | `sermon_modules/api_banner.py` |

---

## 핵심 모듈 구조

```
sermon_modules/
├── __init__.py              # 패키지 초기화, 모든 모듈 export
├── api_sermon.py            # 설교 API (Step1, Step2, Step3, 묵상, QA)
├── api_banner.py            # 배너/디자인 API
├── api_admin.py             # 관리자 API
├── step3_prompt_builder.py  # 프롬프트 빌더
├── db.py                    # DB 연결 (PostgreSQL/SQLite)
├── auth.py                  # 인증, 크레딧
├── utils.py                 # 유틸리티
├── bible.py                 # 성경 본문 검색 (개역개정)
├── strongs.py               # Strong's 원어 분석
├── commentary.py            # 주석 생성
├── context.py               # 시대 컨텍스트, 예화 검증
├── sermon_config.py         # 설정
└── styles/                  # 설교 스타일별 지침
    ├── __init__.py
    ├── expository.py        # 강해설교
    ├── three_points.py      # 3대지 설교
    └── topical.py           # 주제설교
```

---

## 설교 스타일

| 스타일 ID | 이름 | 설명 |
|-----------|------|------|
| expository | 강해설교 | 본문 순서대로 해설 |
| three_points | 3대지 설교 | 3개 대지로 구성 |
| topical | 주제설교 | 특정 주제 중심 |

---

## 표준 워크플로우

### 기본 설교 작성 플로우
```
1. [분석Agent] Step1 실행
   └─ 입력: 성경 구절, 스타일, 카테고리
   └─ 출력: 본문 분석 결과 (JSON)

2. [구조Agent] Step2 실행
   └─ 입력: Step1 결과
   └─ 출력: 설교 구조 (대지, 소대지, 예화)

3. [작성Agent] Step3 실행
   └─ 입력: Step1 + Step2 결과, 분량
   └─ 출력: 완성된 설교문

4. [품질검수] 글자 수 및 구조 검증
   └─ 미달 시: Step3 재실행 또는 보완 지시
```

### 묵상 메시지 플로우
```
1. [묵상Agent] 묵상 생성
   └─ 입력: 설교문 또는 성경 구절
   └─ 출력: 묵상 메시지
```

### 디자인 플로우
```
1. [디자인Agent] 배너 생성
   └─ 입력: 제목, 구절, 스타일
   └─ 출력: 이미지 파일
```

---

## 슈퍼바이저 권한

### 1. 작업 분배
- 사용자 요청 분석 후 적절한 하위 에이전트 선택
- 실행 순서 결정 (순차/병렬)

### 2. 품질 검수
- 각 단계 결과 검토
- 기준 미달 시 재작업 지시
- 글자 수, 구조, 신학적 정확성 검증

### 3. 상태 관리
- 전체 워크플로우 진행 상황 추적
- 에러 발생 시 복구 처리
- 사용자에게 진행 상황 보고

### 4. 최적화
- 캐싱: 동일 요청 재사용
- 병렬 처리: 독립 작업 동시 실행
- 비용 관리: API 호출 최소화

---

## API 엔드포인트 요약

| 엔드포인트 | 메서드 | 담당 에이전트 | 설명 |
|-----------|--------|--------------|------|
| `/api/sermon/process` | POST | 분석/구조 | Step1, Step2 처리 |
| `/api/sermon/gpt-pro` | POST | 작성 | Step3 (최종 설교문) |
| `/api/sermon/meditation` | POST | 묵상 | 묵상 메시지 생성 |
| `/api/sermon/qa` | POST | QA | 질의응답 |
| `/api/sermon/chat` | POST | 챗봇 | 대화형 상담 |
| `/api/sermon/recommend-scripture` | POST | 추천 | 본문 추천 |
| `/api/sermon/style-guide/<id>` | GET | - | 스타일 가이드 조회 |
| `/api/sermon/duration-info/<min>` | GET | - | 분량 정보 조회 |
| `/api/banner/generate*` | POST | 디자인 | 배너/이미지 생성 |

---

## 프론트엔드 모듈

| 파일 | 역할 |
|------|------|
| sermon-main.js | 전역 변수, 설정 |
| sermon-step.js | Step 처리 로직 |
| sermon-step4-copy.js | Step4 전체 복사 |
| sermon-render.js | UI 렌더링 |
| sermon-qa.js | Q&A, 챗봇 |
| sermon-meditation.js | 묵상 메시지 |
| sermon-design.js | 디자인 도우미 |
| sermon-admin.js | 관리자 기능 |
| sermon-firebase.js | Firebase 연동 |
| sermon-utils.js | 유틸리티 |
| sermon-init.js | 앱 초기화 |

---

## 슈퍼바이저 명령어 예시

```
# 기본 설교 작성
"마가복음 10:17-31로 25분 강해설교 만들어줘"
→ Step1 → Step2 → Step3 순차 실행

# 묵상 추가
"이 설교로 묵상 메시지도 만들어줘"
→ 묵상Agent 실행

# 디자인 추가
"배너 이미지도 만들어줘"
→ 디자인Agent 실행

# 전체 패키지
"마가복음 10장으로 20분 설교 + 묵상 + 배너 전부 만들어줘"
→ Step1 → Step2 → Step3 → 묵상Agent → 디자인Agent
```

---

## 다음 단계

1. **슈퍼바이저 로직 구현** - 요청 파싱, 에이전트 호출, 결과 조합
2. **UI 통합** - 단일 입력창에서 슈퍼바이저와 대화
3. **진행상황 표시** - 실시간 상태 업데이트
4. **에러 핸들링** - 재시도 로직, 폴백 처리

---

*마지막 업데이트: 2025-12-25*
