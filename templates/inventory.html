<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìƒí’ˆ ì¬ê³  ê´€ë¦¬</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f8fafc;
      color: #1e293b;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .exchange-rate-display {
      background: rgba(255,255,255,0.2);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 600;
    }

    .container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .filter-group {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .filter-group select,
    .filter-group input {
      padding: 0.5rem 0.75rem;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 0.9rem;
      background: white;
    }

    button {
      padding: .6rem 1rem;
      border: none;
      background: #3b82f6;
      border-radius: 8px;
      cursor: pointer;
      color: white;
      font-weight: 600;
      font-size: .9rem;
      transition: all 0.2s;
    }
    button:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }
    button.success { background: #10b981; }
    button.success:hover { background: #059669; }
    button.secondary { background: #64748b; }
    button.secondary:hover { background: #475569; }
    button.danger { background: #ef4444; }
    button.danger:hover { background: #dc2626; }
    button.small {
      padding: .35rem .6rem;
      font-size: .8rem;
    }

    .stats-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 1rem 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border: 1px solid #e2e8f0;
      flex: 1;
      min-width: 150px;
    }
    .stat-label {
      font-size: 0.85rem;
      color: #64748b;
      margin-bottom: 0.25rem;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e293b;
    }
    .stat-value.highlight { color: #3b82f6; }
    .stat-value.success { color: #10b981; }
    .stat-value.warning { color: #f59e0b; }

    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border: 1px solid #e2e8f0;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th, td {
      padding: 0.75rem 0.5rem;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
      white-space: nowrap;
    }

    th {
      background: #f8fafc;
      font-weight: 600;
      color: #475569;
      position: sticky;
      top: 0;
    }

    tbody tr:hover {
      background: #f8fafc;
    }

    .product-image {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      cursor: pointer;
    }
    .product-image:hover {
      transform: scale(1.1);
    }
    .no-image {
      width: 50px;
      height: 50px;
      background: #f1f5f9;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      font-size: 0.75rem;
    }

    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.6rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-ordering { background: #fef3c7; color: #92400e; }
    .status-shipping { background: #dbeafe; color: #1e40af; }
    .status-instock { background: #d1fae5; color: #065f46; }
    .status-outofstock { background: #fee2e2; color: #991b1b; }

    .profit-positive { color: #10b981; font-weight: 600; }
    .profit-negative { color: #ef4444; font-weight: 600; }

    .action-buttons {
      display: flex;
      gap: 0.25rem;
    }

    /* ëª¨ë‹¬ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      max-width: 700px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #e2e8f0;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 1.25rem;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #64748b;
      padding: 0;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .form-row.full {
      grid-template-columns: 1fr;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    .form-group label {
      font-weight: 600;
      margin-bottom: 0.4rem;
      color: #334155;
      font-size: 0.9rem;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 0.6rem;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 0.9rem;
      background: #f8fafc;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3b82f6;
      background: white;
    }
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    .form-group .hint {
      font-size: 0.75rem;
      color: #94a3b8;
      margin-top: 0.25rem;
    }
    .form-group .calculated {
      background: #f0f9ff;
      border-color: #3b82f6;
      font-weight: 600;
      color: #1e40af;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid #e2e8f0;
    }

    /* ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ */
    .image-preview-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    .image-preview-modal.active {
      display: flex;
    }
    .image-preview-modal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 8px;
    }
    .image-preview-modal .close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 2rem;
      color: white;
      background: none;
      border: none;
      cursor: pointer;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #94a3b8;
    }
    .empty-state h3 {
      margin-bottom: 0.5rem;
      color: #64748b;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }
      .form-row {
        grid-template-columns: 1fr;
      }
      .top-bar {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ“¦ ìƒí’ˆ ì¬ê³  ê´€ë¦¬</h1>
    <div class="header-actions">
      <div class="exchange-rate-display" id="exchangeRateDisplay">
        1 CNY = ë¡œë”©ì¤‘...
      </div>
      <a href="/" style="color: white; text-decoration: none; font-weight: 600;">ğŸ  í™ˆ</a>
    </div>
  </div>

  <div class="container">
    <!-- í†µê³„ ì¹´ë“œ -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-label">ì „ì²´ ìƒí’ˆ</div>
        <div class="stat-value" id="statTotal">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ì¬ê³  ìˆìŒ</div>
        <div class="stat-value success" id="statInStock">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">í’ˆì ˆ</div>
        <div class="stat-value warning" id="statOutOfStock">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ì´ ì¬ê³  ê°€ì¹˜</div>
        <div class="stat-value highlight" id="statTotalValue">â‚©0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ì˜ˆìƒ ì´ ë§ˆì§„</div>
        <div class="stat-value success" id="statTotalMargin">â‚©0</div>
      </div>
    </div>

    <!-- ìƒë‹¨ ì•¡ì…˜ ë°” -->
    <div class="top-bar">
      <div class="filter-group">
        <select id="filterCategory">
          <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
        </select>
        <select id="filterStatus">
          <option value="">ì „ì²´ ìƒíƒœ</option>
          <option value="ordering">ì£¼ë¬¸ì¤‘</option>
          <option value="shipping">ë°°ì†¡ì¤‘</option>
          <option value="instock">ì¬ê³ ìˆìŒ</option>
          <option value="outofstock">í’ˆì ˆ</option>
        </select>
        <input type="text" id="searchInput" placeholder="ğŸ” ìƒí’ˆëª… ê²€ìƒ‰...">
      </div>
      <div class="filter-group">
        <button class="success" onclick="openAddModal()">+ ìƒí’ˆ ì¶”ê°€</button>
        <button class="secondary" onclick="exportToCSV()">ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸°</button>
        <button class="secondary" onclick="importFromCSV()">ğŸ“¤ CSV ê°€ì ¸ì˜¤ê¸°</button>
        <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">
      </div>
    </div>

    <!-- í…Œì´ë¸” -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>No.</th>
            <th>ì¹´í…Œê³ ë¦¬</th>
            <th>ì´ë¯¸ì§€</th>
            <th>ìƒí’ˆëª…</th>
            <th>ê°€ê²©(CNY)</th>
            <th>ì›í™”</th>
            <th>HSì½”ë“œ</th>
            <th>ì¬ê³ </th>
            <th>ë°°ì†¡ë¹„</th>
            <th>ê´€ì„¸</th>
            <th>ì´ ì›ê°€</th>
            <th>íŒë§¤ê°€</th>
            <th>ë§ˆì§„</th>
            <th>êµ¬ë§¤ì²˜</th>
            <th>êµ¬ë§¤ì¼</th>
            <th>ìƒíƒœ</th>
            <th>ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody id="inventoryTableBody">
          <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
        </tbody>
      </table>
      <div class="empty-state" id="emptyState" style="display: none;">
        <h3>ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</h3>
        <p>ìƒí’ˆ ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²« ìƒí’ˆì„ ë“±ë¡í•˜ì„¸ìš”.</p>
      </div>
    </div>
  </div>

  <!-- ìƒí’ˆ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div class="modal-overlay" id="productModal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">ìƒí’ˆ ì¶”ê°€</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>

      <form id="productForm">
        <input type="hidden" id="productId">

        <div class="form-row">
          <div class="form-group">
            <label>ì¹´í…Œê³ ë¦¬ *</label>
            <input type="text" id="formCategory" list="categoryList" required placeholder="ì˜ˆ: ì „ìì œí’ˆ, ì˜ë¥˜, ìƒí™œìš©í’ˆ">
            <datalist id="categoryList"></datalist>
          </div>
          <div class="form-group">
            <label>ìƒí’ˆëª… *</label>
            <input type="text" id="formName" required placeholder="ìƒí’ˆëª… ì…ë ¥">
          </div>
        </div>

        <div class="form-row full">
          <div class="form-group">
            <label>ì´ë¯¸ì§€ URL</label>
            <input type="text" id="formImageUrl" placeholder="ì´ë¯¸ì§€ ì£¼ì†Œë¥¼ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”">
            <div class="hint">ìƒí’ˆ ì´ë¯¸ì§€ ì£¼ì†Œë¥¼ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”</div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>ê°€ê²© (CNY/ìœ„ì•ˆ) *</label>
            <input type="number" id="formPriceCNY" step="0.01" required placeholder="0.00" oninput="calculateFields()">
          </div>
          <div class="form-group">
            <label>ì›í™” í™˜ì „ ê¸ˆì•¡</label>
            <input type="text" id="formPriceKRW" class="calculated" readonly>
            <div class="hint">ìë™ ê³„ì‚°ë¨</div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>HSì½”ë“œ</label>
            <input type="text" id="formHsCode" placeholder="0000.00.0000">
          </div>
          <div class="form-group">
            <label>ì¬ê³  ìˆ˜ëŸ‰ *</label>
            <input type="number" id="formStock" required placeholder="0" oninput="calculateFields()">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>ë°°ì†¡ë¹„ (ì›)</label>
            <input type="number" id="formShippingCost" placeholder="0" oninput="calculateFields()">
          </div>
          <div class="form-group">
            <label>ê´€ì„¸ (ì›)</label>
            <input type="number" id="formCustomsDuty" placeholder="0" oninput="calculateFields()">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>ì´ ì›ê°€ (ê°œë‹¹)</label>
            <input type="text" id="formTotalCost" class="calculated" readonly>
            <div class="hint">ì›í™” + ë°°ì†¡ë¹„/ìˆ˜ëŸ‰ + ê´€ì„¸/ìˆ˜ëŸ‰</div>
          </div>
          <div class="form-group">
            <label>íŒë§¤ê°€ê²© (ì›) *</label>
            <input type="number" id="formSellingPrice" required placeholder="0" oninput="calculateFields()">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>ë§ˆì§„ (ê°œë‹¹)</label>
            <input type="text" id="formMargin" class="calculated" readonly>
          </div>
          <div class="form-group">
            <label>ë§ˆì§„ìœ¨</label>
            <input type="text" id="formMarginRate" class="calculated" readonly>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>êµ¬ë§¤ì²˜/ê³µê¸‰ì—…ì²´</label>
            <input type="text" id="formSupplier" placeholder="ì˜ˆ: íƒ€ì˜¤ë°”ì˜¤, 1688, ì•Œë¦¬ë°”ë°”">
          </div>
          <div class="form-group">
            <label>êµ¬ë§¤ì¼ì</label>
            <input type="date" id="formPurchaseDate">
          </div>
        </div>

        <div class="form-row full">
          <div class="form-group">
            <label>êµ¬ë§¤ ë§í¬</label>
            <input type="text" id="formPurchaseLink" placeholder="https://...">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>ìƒíƒœ *</label>
            <select id="formStatus" required>
              <option value="ordering">ì£¼ë¬¸ì¤‘</option>
              <option value="shipping">ë°°ì†¡ì¤‘</option>
              <option value="instock">ì¬ê³ ìˆìŒ</option>
              <option value="outofstock">í’ˆì ˆ</option>
            </select>
          </div>
        </div>

        <div class="form-row full">
          <div class="form-group">
            <label>ë©”ëª¨/ë¹„ê³ </label>
            <textarea id="formMemo" placeholder="ì¶”ê°€ ë©”ëª¨ ì‚¬í•­"></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="secondary" onclick="closeModal()">ì·¨ì†Œ</button>
          <button type="submit" class="success">ì €ì¥</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
  <div class="image-preview-modal" id="imagePreviewModal" onclick="closeImagePreview()">
    <button class="close-btn">&times;</button>
    <img id="previewImage" src="" alt="ìƒí’ˆ ì´ë¯¸ì§€">
  </div>

  <script>
  // ì „ì—­ ë³€ìˆ˜
  let inventory = [];
  let exchangeRate = 185; // ê¸°ë³¸ í™˜ìœ¨ (1 CNY = 185 KRW)
  let editingId = null;

  // ì´ˆê¸°í™”
  document.addEventListener('DOMContentLoaded', () => {
    loadExchangeRate();
    loadInventory();
    setupEventListeners();
  });

  // í™˜ìœ¨ ë¶ˆëŸ¬ì˜¤ê¸°
  function loadExchangeRate() {
    fetch('/api/trade/exchange-rate')
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          exchangeRate = data.rate;
        }
        document.getElementById('exchangeRateDisplay').textContent =
          `1 CNY = ${exchangeRate.toFixed(2)} KRW`;
      })
      .catch(err => {
        console.error('í™˜ìœ¨ ë¡œë“œ ì‹¤íŒ¨:', err);
        document.getElementById('exchangeRateDisplay').textContent =
          `1 CNY = ${exchangeRate.toFixed(2)} KRW (ê¸°ë³¸ê°’)`;
      });
  }

  // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì¬ê³  ë¶ˆëŸ¬ì˜¤ê¸°
  function loadInventory() {
    const saved = localStorage.getItem('inventory');
    if (saved) {
      inventory = JSON.parse(saved);
    }
    renderTable();
    updateStats();
    updateCategoryFilter();
  }

  // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì¬ê³  ì €ì¥
  function saveInventory() {
    localStorage.setItem('inventory', JSON.stringify(inventory));
  }

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
  function setupEventListeners() {
    document.getElementById('productForm').addEventListener('submit', handleSubmit);
    document.getElementById('filterCategory').addEventListener('change', renderTable);
    document.getElementById('filterStatus').addEventListener('change', renderTable);
    document.getElementById('searchInput').addEventListener('input', renderTable);
  }

  // í…Œì´ë¸” ë Œë”ë§
  function renderTable() {
    const tbody = document.getElementById('inventoryTableBody');
    const emptyState = document.getElementById('emptyState');

    // í•„í„° ì ìš©
    let filtered = [...inventory];

    const categoryFilter = document.getElementById('filterCategory').value;
    const statusFilter = document.getElementById('filterStatus').value;
    const searchQuery = document.getElementById('searchInput').value.toLowerCase();

    if (categoryFilter) {
      filtered = filtered.filter(item => item.category === categoryFilter);
    }
    if (statusFilter) {
      filtered = filtered.filter(item => item.status === statusFilter);
    }
    if (searchQuery) {
      filtered = filtered.filter(item =>
        item.name.toLowerCase().includes(searchQuery) ||
        item.category.toLowerCase().includes(searchQuery)
      );
    }

    if (filtered.length === 0) {
      tbody.innerHTML = '';
      emptyState.style.display = 'block';
      return;
    }

    emptyState.style.display = 'none';

    tbody.innerHTML = filtered.map((item, index) => {
      const margin = item.sellingPrice - item.totalCost;
      const marginRate = item.totalCost > 0 ? ((margin / item.totalCost) * 100).toFixed(1) : 0;
      const marginClass = margin >= 0 ? 'profit-positive' : 'profit-negative';

      return `
        <tr>
          <td>${item.id}</td>
          <td>${item.category}</td>
          <td>
            ${item.imageUrl
              ? `<img src="${item.imageUrl}" class="product-image" onclick="showImagePreview('${item.imageUrl}')" onerror="this.outerHTML='<div class=\\'no-image\\'>ì—†ìŒ</div>'">`
              : '<div class="no-image">ì—†ìŒ</div>'
            }
          </td>
          <td><strong>${item.name}</strong></td>
          <td>Â¥${item.priceCNY.toLocaleString()}</td>
          <td>â‚©${item.priceKRW.toLocaleString()}</td>
          <td>${item.hsCode || '-'}</td>
          <td>${item.stock.toLocaleString()}</td>
          <td>â‚©${(item.shippingCost || 0).toLocaleString()}</td>
          <td>â‚©${(item.customsDuty || 0).toLocaleString()}</td>
          <td>â‚©${item.totalCost.toLocaleString()}</td>
          <td>â‚©${item.sellingPrice.toLocaleString()}</td>
          <td class="${marginClass}">â‚©${margin.toLocaleString()} (${marginRate}%)</td>
          <td>${item.supplier || '-'}</td>
          <td>${item.purchaseDate || '-'}</td>
          <td><span class="status-badge status-${item.status}">${getStatusText(item.status)}</span></td>
          <td>
            <div class="action-buttons">
              <button class="small" onclick="editProduct(${item.id})">ìˆ˜ì •</button>
              <button class="small danger" onclick="deleteProduct(${item.id})">ì‚­ì œ</button>
              ${item.purchaseLink ? `<button class="small secondary" onclick="window.open('${item.purchaseLink}', '_blank')">ë§í¬</button>` : ''}
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  // ìƒíƒœ í…ìŠ¤íŠ¸ ë°˜í™˜
  function getStatusText(status) {
    const statusMap = {
      'ordering': 'ì£¼ë¬¸ì¤‘',
      'shipping': 'ë°°ì†¡ì¤‘',
      'instock': 'ì¬ê³ ìˆìŒ',
      'outofstock': 'í’ˆì ˆ'
    };
    return statusMap[status] || status;
  }

  // í†µê³„ ì—…ë°ì´íŠ¸
  function updateStats() {
    document.getElementById('statTotal').textContent = inventory.length;
    document.getElementById('statInStock').textContent =
      inventory.filter(item => item.status === 'instock').length;
    document.getElementById('statOutOfStock').textContent =
      inventory.filter(item => item.status === 'outofstock').length;

    // ì´ ì¬ê³  ê°€ì¹˜ (ì›ê°€ Ã— ìˆ˜ëŸ‰)
    const totalValue = inventory.reduce((sum, item) => {
      return sum + (item.totalCost * item.stock);
    }, 0);
    document.getElementById('statTotalValue').textContent = `â‚©${totalValue.toLocaleString()}`;

    // ì˜ˆìƒ ì´ ë§ˆì§„
    const totalMargin = inventory.reduce((sum, item) => {
      const margin = (item.sellingPrice - item.totalCost) * item.stock;
      return sum + margin;
    }, 0);
    document.getElementById('statTotalMargin').textContent = `â‚©${totalMargin.toLocaleString()}`;
  }

  // ì¹´í…Œê³ ë¦¬ í•„í„° ì—…ë°ì´íŠ¸
  function updateCategoryFilter() {
    const categories = [...new Set(inventory.map(item => item.category))];
    const select = document.getElementById('filterCategory');
    const datalist = document.getElementById('categoryList');

    // í•„í„° ì…€ë ‰íŠ¸ ì—…ë°ì´íŠ¸
    select.innerHTML = '<option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>';
    categories.forEach(cat => {
      select.innerHTML += `<option value="${cat}">${cat}</option>`;
    });

    // datalist ì—…ë°ì´íŠ¸
    datalist.innerHTML = categories.map(cat => `<option value="${cat}">`).join('');
  }

  // ëª¨ë‹¬ ì—´ê¸° (ì¶”ê°€)
  function openAddModal() {
    editingId = null;
    document.getElementById('modalTitle').textContent = 'ìƒí’ˆ ì¶”ê°€';
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    document.getElementById('formPriceKRW').value = '';
    document.getElementById('formTotalCost').value = '';
    document.getElementById('formMargin').value = '';
    document.getElementById('formMarginRate').value = '';
    document.getElementById('formPurchaseDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('productModal').classList.add('active');
  }

  // ëª¨ë‹¬ ë‹«ê¸°
  function closeModal() {
    document.getElementById('productModal').classList.remove('active');
    editingId = null;
  }

  // ìƒí’ˆ ìˆ˜ì •
  function editProduct(id) {
    const item = inventory.find(p => p.id === id);
    if (!item) return;

    editingId = id;
    document.getElementById('modalTitle').textContent = 'ìƒí’ˆ ìˆ˜ì •';
    document.getElementById('productId').value = id;
    document.getElementById('formCategory').value = item.category;
    document.getElementById('formName').value = item.name;
    document.getElementById('formImageUrl').value = item.imageUrl || '';
    document.getElementById('formPriceCNY').value = item.priceCNY;
    document.getElementById('formHsCode').value = item.hsCode || '';
    document.getElementById('formStock').value = item.stock;
    document.getElementById('formShippingCost').value = item.shippingCost || 0;
    document.getElementById('formCustomsDuty').value = item.customsDuty || 0;
    document.getElementById('formSellingPrice').value = item.sellingPrice;
    document.getElementById('formSupplier').value = item.supplier || '';
    document.getElementById('formPurchaseDate').value = item.purchaseDate || '';
    document.getElementById('formPurchaseLink').value = item.purchaseLink || '';
    document.getElementById('formStatus').value = item.status;
    document.getElementById('formMemo').value = item.memo || '';

    calculateFields();
    document.getElementById('productModal').classList.add('active');
  }

  // í•„ë“œ ìë™ ê³„ì‚°
  function calculateFields() {
    const priceCNY = parseFloat(document.getElementById('formPriceCNY').value) || 0;
    const stock = parseInt(document.getElementById('formStock').value) || 1;
    const shippingCost = parseFloat(document.getElementById('formShippingCost').value) || 0;
    const customsDuty = parseFloat(document.getElementById('formCustomsDuty').value) || 0;
    const sellingPrice = parseFloat(document.getElementById('formSellingPrice').value) || 0;

    // ì›í™” í™˜ì „
    const priceKRW = Math.round(priceCNY * exchangeRate);
    document.getElementById('formPriceKRW').value = `â‚©${priceKRW.toLocaleString()}`;

    // ì´ ì›ê°€ (ê°œë‹¹)
    const totalCost = priceKRW + Math.round(shippingCost / stock) + Math.round(customsDuty / stock);
    document.getElementById('formTotalCost').value = `â‚©${totalCost.toLocaleString()}`;

    // ë§ˆì§„
    const margin = sellingPrice - totalCost;
    const marginRate = totalCost > 0 ? ((margin / totalCost) * 100).toFixed(1) : 0;

    document.getElementById('formMargin').value = `â‚©${margin.toLocaleString()}`;
    document.getElementById('formMarginRate').value = `${marginRate}%`;
  }

  // í¼ ì œì¶œ ì²˜ë¦¬
  function handleSubmit(e) {
    e.preventDefault();

    const priceCNY = parseFloat(document.getElementById('formPriceCNY').value);
    const stock = parseInt(document.getElementById('formStock').value);
    const shippingCost = parseFloat(document.getElementById('formShippingCost').value) || 0;
    const customsDuty = parseFloat(document.getElementById('formCustomsDuty').value) || 0;
    const sellingPrice = parseFloat(document.getElementById('formSellingPrice').value);

    const priceKRW = Math.round(priceCNY * exchangeRate);
    const totalCost = priceKRW + Math.round(shippingCost / stock) + Math.round(customsDuty / stock);

    const productData = {
      category: document.getElementById('formCategory').value.trim(),
      name: document.getElementById('formName').value.trim(),
      imageUrl: document.getElementById('formImageUrl').value.trim(),
      priceCNY: priceCNY,
      priceKRW: priceKRW,
      hsCode: document.getElementById('formHsCode').value.trim(),
      stock: stock,
      shippingCost: shippingCost,
      customsDuty: customsDuty,
      totalCost: totalCost,
      sellingPrice: sellingPrice,
      supplier: document.getElementById('formSupplier').value.trim(),
      purchaseDate: document.getElementById('formPurchaseDate').value,
      purchaseLink: document.getElementById('formPurchaseLink').value.trim(),
      status: document.getElementById('formStatus').value,
      memo: document.getElementById('formMemo').value.trim()
    };

    if (editingId) {
      // ìˆ˜ì •
      const index = inventory.findIndex(p => p.id === editingId);
      if (index !== -1) {
        inventory[index] = { ...inventory[index], ...productData };
      }
    } else {
      // ì¶”ê°€
      const newId = inventory.length > 0 ? Math.max(...inventory.map(p => p.id)) + 1 : 1;
      inventory.push({ id: newId, ...productData, createdAt: new Date().toISOString() });
    }

    saveInventory();
    renderTable();
    updateStats();
    updateCategoryFilter();
    closeModal();
  }

  // ìƒí’ˆ ì‚­ì œ
  function deleteProduct(id) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    inventory = inventory.filter(p => p.id !== id);
    saveInventory();
    renderTable();
    updateStats();
    updateCategoryFilter();
  }

  // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
  function showImagePreview(url) {
    document.getElementById('previewImage').src = url;
    document.getElementById('imagePreviewModal').classList.add('active');
  }

  function closeImagePreview() {
    document.getElementById('imagePreviewModal').classList.remove('active');
  }

  // CSV ë‚´ë³´ë‚´ê¸°
  function exportToCSV() {
    if (inventory.length === 0) {
      alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const headers = ['ë²ˆí˜¸', 'ì¹´í…Œê³ ë¦¬', 'ìƒí’ˆëª…', 'ì´ë¯¸ì§€URL', 'ê°€ê²©(CNY)', 'ì›í™”', 'HSì½”ë“œ',
                     'ì¬ê³ ', 'ë°°ì†¡ë¹„', 'ê´€ì„¸', 'ì´ì›ê°€', 'íŒë§¤ê°€', 'êµ¬ë§¤ì²˜', 'êµ¬ë§¤ì¼', 'êµ¬ë§¤ë§í¬', 'ìƒíƒœ', 'ë©”ëª¨'];

    const rows = inventory.map(item => [
      item.id,
      item.category,
      item.name,
      item.imageUrl || '',
      item.priceCNY,
      item.priceKRW,
      item.hsCode || '',
      item.stock,
      item.shippingCost || 0,
      item.customsDuty || 0,
      item.totalCost,
      item.sellingPrice,
      item.supplier || '',
      item.purchaseDate || '',
      item.purchaseLink || '',
      getStatusText(item.status),
      item.memo || ''
    ]);

    let csv = '\ufeff' + headers.join(',') + '\n';
    rows.forEach(row => {
      csv += row.map(cell => {
        const str = String(cell).replace(/"/g, '""');
        return str.includes(',') || str.includes('"') || str.includes('\n') ? `"${str}"` : str;
      }).join(',') + '\n';
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `ì¬ê³ ê´€ë¦¬_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  }

  // CSV ê°€ì ¸ì˜¤ê¸°
  function importFromCSV() {
    document.getElementById('csvFileInput').click();
  }

  function handleCSVImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      const lines = text.split('\n').filter(line => line.trim());

      if (lines.length < 2) {
        alert('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // í—¤ë” ê±´ë„ˆë›°ê¸°
      const dataLines = lines.slice(1);
      let imported = 0;

      dataLines.forEach(line => {
        const cols = parseCSVLine(line);
        if (cols.length >= 12) {
          const newId = inventory.length > 0 ? Math.max(...inventory.map(p => p.id)) + 1 : 1;

          const priceCNY = parseFloat(cols[4]) || 0;
          const priceKRW = Math.round(priceCNY * exchangeRate);
          const stock = parseInt(cols[7]) || 1;
          const shippingCost = parseFloat(cols[8]) || 0;
          const customsDuty = parseFloat(cols[9]) || 0;
          const totalCost = priceKRW + Math.round(shippingCost / stock) + Math.round(customsDuty / stock);

          inventory.push({
            id: newId,
            category: cols[1] || 'ë¯¸ë¶„ë¥˜',
            name: cols[2] || 'ìƒí’ˆëª… ì—†ìŒ',
            imageUrl: cols[3] || '',
            priceCNY: priceCNY,
            priceKRW: priceKRW,
            hsCode: cols[6] || '',
            stock: stock,
            shippingCost: shippingCost,
            customsDuty: customsDuty,
            totalCost: totalCost,
            sellingPrice: parseFloat(cols[11]) || 0,
            supplier: cols[12] || '',
            purchaseDate: cols[13] || '',
            purchaseLink: cols[14] || '',
            status: getStatusValue(cols[15]) || 'instock',
            memo: cols[16] || '',
            createdAt: new Date().toISOString()
          });
          imported++;
        }
      });

      if (imported > 0) {
        saveInventory();
        renderTable();
        updateStats();
        updateCategoryFilter();
        alert(`${imported}ê°œ ìƒí’ˆì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.`);
      } else {
        alert('ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      }
    };
    reader.readAsText(file, 'UTF-8');
    event.target.value = '';
  }

  // CSV ë¼ì¸ íŒŒì‹±
  function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const char = line[i];

      if (char === '"') {
        if (inQuotes && line[i + 1] === '"') {
          current += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (char === ',' && !inQuotes) {
        result.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    result.push(current.trim());
    return result;
  }

  // ìƒíƒœê°’ ë³€í™˜
  function getStatusValue(text) {
    const statusMap = {
      'ì£¼ë¬¸ì¤‘': 'ordering',
      'ë°°ì†¡ì¤‘': 'shipping',
      'ì¬ê³ ìˆìŒ': 'instock',
      'í’ˆì ˆ': 'outofstock'
    };
    return statusMap[text] || 'instock';
  }

  // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeModal();
      closeImagePreview();
    }
  });
  </script>
</body>
</html>
