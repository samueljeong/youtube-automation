<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì¤‘êµ­ ìˆ˜ì… ì›ê°€ ê³„ì‚°ê¸°</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; 
      background: #f8fafc;
      color: #1e293b;
    }
    .page-wrap { 
      display: flex; 
      gap: 1.5rem; 
      padding: 1.5rem; 
      max-width: 1800px;
      margin: 0 auto;
    }
    .left-col { 
      width: 380px; 
      display: flex; 
      flex-direction: column; 
      gap: 1rem; 
    }
    .center-col {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-width: 0;
    }
    .right-col {
      width: 400px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .box { 
      background: white; 
      border: 1px solid #e2e8f0; 
      border-radius: 12px; 
      padding: 1.25rem; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .box-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 1rem;
      padding-bottom: .75rem;
      border-bottom: 2px solid #e2e8f0;
    }
    .label { 
      font-weight: 600; 
      margin-bottom: .4rem; 
      display: block;
      color: #334155;
      font-size: .9rem;
    }
    input[type="text"], input[type="number"], select, textarea { 
      width: 100%; 
      padding: .6rem; 
      background: #f8fafc; 
      border: 1px solid #cbd5e1; 
      border-radius: 8px; 
      color: #1e293b;
      font-size: 0.95rem;
      transition: all 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3b82f6;
      background: white;
    }
    textarea { 
      min-height: 60px; 
      resize: vertical; 
      font-family: inherit; 
      line-height: 1.5; 
    }
    textarea.autosize { overflow: hidden; }
    
    .input-group {
      margin-bottom: 1rem;
    }
    .input-row {
      display: flex;
      gap: .75rem;
      margin-bottom: 1rem;
    }
    .input-row > div {
      flex: 1;
    }
    
    button { 
      padding: .7rem 1.2rem; 
      border: none;
      background: #3b82f6; 
      border-radius: 8px; 
      cursor: pointer; 
      color: white;
      font-weight: 600;
      font-size: .95rem;
      transition: all 0.2s;
      width: 100%;
    }
    button:hover { 
      background: #2563eb; 
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    button.secondary {
      background: #64748b;
    }
    button.secondary:hover {
      background: #475569;
    }
    button.success {
      background: #10b981;
    }
    button.success:hover {
      background: #059669;
    }
    button.small {
      padding: .45rem .8rem;
      font-size: .85rem;
      width: auto;
    }
    
    .result-box {
      background: #f0f9ff;
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 1.25rem;
      margin-top: 1rem;
    }
    .result-row {
      display: flex;
      justify-content: space-between;
      padding: .6rem 0;
      border-bottom: 1px solid #bfdbfe;
    }
    .result-row:last-child {
      border-bottom: none;
      font-weight: 700;
      font-size: 1.1rem;
      color: #1e40af;
      padding-top: 1rem;
      margin-top: .5rem;
      border-top: 2px solid #3b82f6;
    }
    .result-label {
      color: #475569;
      font-weight: 500;
    }
    .result-value {
      color: #0f172a;
      font-weight: 600;
    }
    
    .saved-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .75rem;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin-bottom: .5rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .saved-item:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }
    .saved-item-info {
      flex: 1;
    }
    .saved-item-name {
      font-weight: 600;
      color: #1e293b;
      margin-bottom: .25rem;
    }
    .saved-item-meta {
      font-size: .8rem;
      color: #64748b;
    }
    .saved-item-actions {
      display: flex;
      gap: .5rem;
    }
    
    .platform-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    .platform-box.naver {
      background: linear-gradient(135deg, #06d6a0 0%, #118ab2 100%);
    }
    .platform-box.coupang {
      background: linear-gradient(135deg, #ef476f 0%, #ffd166 100%);
    }
    .platform-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }
    .platform-row {
      display: flex;
      justify-content: space-between;
      padding: .5rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .platform-row:last-child {
      border-bottom: none;
      font-size: 1.3rem;
      font-weight: 700;
      padding-top: 1rem;
      margin-top: .5rem;
      border-top: 2px solid rgba(255,255,255,0.3);
    }
    
    .tab-buttons {
      display: flex;
      gap: .5rem;
      margin-bottom: 1rem;
    }
    .tab-btn {
      flex: 1;
      padding: .7rem;
      background: #f1f5f9;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      color: #64748b;
      transition: all 0.2s;
    }
    .tab-btn.active {
      background: #3b82f6;
      border-color: #3b82f6;
      color: white;
    }
    
    .shipping-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: .9rem;
    }
    .shipping-table th,
    .shipping-table td {
      padding: .6rem;
      text-align: center;
      border: 1px solid #e2e8f0;
    }
    .shipping-table th {
      background: #f8fafc;
      font-weight: 600;
      color: #475569;
    }
    
    .history-item {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: .75rem;
    }
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: .75rem;
      padding-bottom: .75rem;
      border-bottom: 1px solid #e2e8f0;
    }
    .history-date {
      font-weight: 600;
      color: #1e293b;
    }
    .history-actions {
      display: flex;
      gap: .5rem;
    }
    .history-detail {
      font-size: .9rem;
      color: #475569;
      line-height: 1.6;
    }
    
    .exchange-rate {
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      padding: .5rem 1rem;
      background: #fef3c7;
      border: 1px solid #fbbf24;
      border-radius: 8px;
      font-weight: 600;
      color: #92400e;
      margin-bottom: 1rem;
    }
    
    .alert {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-weight: 500;
    }
    .alert-info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }
    .alert-warning {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fbbf24;
    }
    .alert-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    
    @media (max-width: 1400px) {
      .page-wrap {
        flex-direction: column;
      }
      .left-col, .right-col {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="page-wrap">
    <!-- ì™¼ìª½: ì…ë ¥ -->
    <div class="left-col">
      <div class="box">
  <div class="box-title">ğŸ’° ì œí’ˆ ì •ë³´</div>
  
  <div class="exchange-rate" id="exchange-rate-display">
    ğŸ”„ í™˜ìœ¨ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
  </div>
  
  <!-- 1688 ë§í¬ ë¶„ì„ ì¶”ê°€ -->
  <div class="input-group">
    <label class="label">ğŸ”— 1688/íƒ€ì˜¤ë°”ì˜¤ ë§í¬</label>
    <input type="text" id="product-link" placeholder="https://detail.1688.com/...">
  </div>
  
  <button id="btn-parse-link" class="secondary" style="margin-bottom: 1rem;">
    ğŸ¤– ë§í¬ì—ì„œ ì œí’ˆ ì •ë³´ ìë™ ì¶”ì¶œ
  </button>
  
  <div id="parse-result" style="display: none; margin-bottom: 1rem;"></div>
  
  <div class="input-group">
    <label class="label">ì œí’ˆëª…</label>
    <input type="text" id="product-name" placeholder="ì˜ˆ: ë¬´ì„  ë¸”ë£¨íˆ¬ìŠ¤ ì´ì–´í°">
  </div>
  
  <div class="input-group">
    <label class="label">ì œí’ˆ ì„¤ëª… (HSì½”ë“œ ì¶”ì²œìš©)</label>
    <textarea id="product-desc" placeholder="ì œí’ˆì˜ ì¬ì§ˆ, ìš©ë„, íŠ¹ì§• ë“±ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
  </div>
  
  <button id="btn-hs-recommend" class="secondary">ğŸ” HSì½”ë“œ ì¶”ì²œë°›ê¸°</button>
  
  <!-- ë‚˜ë¨¸ì§€ ì½”ë“œ ë™ì¼ -->
        
        <div class="input-group">
          <label class="label">ì œí’ˆëª…</label>
          <input type="text" id="product-name" placeholder="ì˜ˆ: ë¬´ì„  ë¸”ë£¨íˆ¬ìŠ¤ ì´ì–´í°">
        </div>
        
        <div class="input-group">
          <label class="label">ì œí’ˆ ì„¤ëª… (HSì½”ë“œ ì¶”ì²œìš©)</label>
          <textarea id="product-desc" placeholder="ì œí’ˆì˜ ì¬ì§ˆ, ìš©ë„, íŠ¹ì§• ë“±ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        </div>
        
        <button id="btn-hs-recommend" class="secondary">ğŸ” HSì½”ë“œ ì¶”ì²œë°›ê¸°</button>
        
        <div class="input-group" style="margin-top: 1rem;">
          <label class="label">êµ¬ë§¤ ë§í¬</label>
          <input type="text" id="product-link" placeholder="https://...">
        </div>
        
        <div class="input-row">
          <div>
            <label class="label">ì œí’ˆ ê°€ê²© (ìœ„ì•ˆ Â¥)</label>
            <input type="number" id="product-price" placeholder="0" step="0.01">
          </div>
          <div>
            <label class="label">ìˆ˜ëŸ‰</label>
            <input type="number" id="product-qty" placeholder="0" min="1">
          </div>
        </div>
        
        <div class="input-row">
          <div>
            <label class="label">ë¬´ê²Œ (kg/ê°œ)</label>
            <input type="number" id="product-weight" placeholder="0" step="0.1">
          </div>
          <div>
            <label class="label">HSì½”ë“œ</label>
            <input type="text" id="hs-code" placeholder="0000.00.0000">
          </div>
        </div>
      </div>

      <div class="box">
        <div class="box-title">ğŸ“¦ ë°°ì†¡ ì •ë³´</div>
        
        <div class="tab-buttons">
          <button class="tab-btn active" data-shipping="sea">ì¼ë°˜ í•´ìš´</button>
          <button class="tab-btn" data-shipping="lcl">LCL</button>
        </div>
        
        <div id="shipping-sea">
          <div class="alert alert-info">
            0.5kg ë‹¨ìœ„ë¡œ ì ˆìƒí•˜ì—¬ ê³„ì‚°ë©ë‹ˆë‹¤.
          </div>
        </div>
        
        <div id="shipping-lcl" style="display: none;">
          <div class="input-row">
            <div>
              <label class="label">ê°€ë¡œ (cm)</label>
              <input type="number" id="box-width" placeholder="0" step="0.1">
            </div>
            <div>
              <label class="label">ì„¸ë¡œ (cm)</label>
              <input type="number" id="box-length" placeholder="0" step="0.1">
            </div>
            <div>
              <label class="label">ë†’ì´ (cm)</label>
              <input type="number" id="box-height" placeholder="0" step="0.1">
            </div>
          </div>
          <div class="alert alert-info">
            CBM = (ê°€ë¡œ Ã— ì„¸ë¡œ Ã— ë†’ì´) Ã· 1,000,000<br>
            0.5CBM ë¯¸ë§Œì€ 0.5CBMìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.
          </div>
        </div>
        
        <div class="input-group">
          <label class="label">ì¶”ê°€ ë°°ì†¡ë¹„ (ì›)</label>
          <input type="number" id="extra-shipping" placeholder="0">
        </div>
      </div>

      <div class="box">
        <div class="box-title">ğŸ’³ ìˆ˜ìˆ˜ë£Œ</div>
        
        <div class="input-row">
          <div>
            <label class="label">ì¹´ë“œ ìˆ˜ìˆ˜ë£Œ (%)</label>
            <input type="number" id="card-fee" placeholder="1.5" step="0.1" value="1.5">
          </div>
          <div>
            <label class="label">ê´€ì„¸ (%)</label>
            <input type="number" id="customs-fee" placeholder="8" step="0.1" value="8">
          </div>
        </div>
        
        <div class="input-row">
          <div>
            <label class="label">ë¶€ê°€ì„¸ (%)</label>
            <input type="number" id="vat-fee" placeholder="10" step="0.1" value="10">
          </div>
          <div>
            <label class="label">ê¸°íƒ€ ìˆ˜ìˆ˜ë£Œ (ì›)</label>
            <input type="number" id="other-fee" placeholder="0">
          </div>
        </div>
      </div>

      <button id="btn-calculate" class="success">ğŸ“Š ì›ê°€ ê³„ì‚°í•˜ê¸°</button>
      <button id="btn-save-product" class="secondary">ğŸ’¾ í˜„ì¬ ì œí’ˆ ì €ì¥</button>
      
      <div class="box">
        <div class="box-title">â­ ìì£¼ ì“°ëŠ” í’ˆëª©</div>
        <div id="saved-products-list">
          <p style="color: #94a3b8; text-align: center; padding: 1rem;">ì €ì¥ëœ í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
    </div>

    <!-- ì¤‘ì•™: ê³„ì‚° ê²°ê³¼ -->
    <div class="center-col">
      <div class="box">
        <div class="box-title">ğŸ“‹ HSì½”ë“œ ì¶”ì²œ ê²°ê³¼</div>
        <textarea id="hs-result" readonly style="min-height: 150px; font-size: .9rem;"></textarea>
      </div>

      <div class="box">
        <div class="box-title">ğŸ’° ì´ ì›ê°€ ê³„ì‚°</div>
        <div id="cost-result">
          <p style="color: #94a3b8; text-align: center; padding: 2rem;">ê³„ì‚° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
        </div>
      </div>

      <div class="box">
        <div class="box-title">ğŸ“ˆ ìˆ˜ëŸ‰ë³„ ë‹¨ê°€ ì‹œë®¬ë ˆì´ì…˜</div>
        <div class="input-row" style="margin-bottom: 1rem;">
          <div>
            <label class="label">ì‹œë®¬ë ˆì´ì…˜ ìˆ˜ëŸ‰ 1</label>
            <input type="number" id="sim-qty-1" placeholder="100" value="100">
          </div>
          <div>
            <label class="label">ì‹œë®¬ë ˆì´ì…˜ ìˆ˜ëŸ‰ 2</label>
            <input type="number" id="sim-qty-2" placeholder="500" value="500">
          </div>
          <div>
            <label class="label">ì‹œë®¬ë ˆì´ì…˜ ìˆ˜ëŸ‰ 3</label>
            <input type="number" id="sim-qty-3" placeholder="1000" value="1000">
          </div>
        </div>
        <button id="btn-simulate" class="secondary">ğŸ”„ ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</button>
        <div id="simulation-result" style="margin-top: 1rem;"></div>
      </div>

      <div class="box">
        <div class="box-title">ğŸ“Š ì†ìµë¶„ê¸°ì  ë¶„ì„</div>
        <div class="input-row">
          <div>
            <label class="label">ì´ íˆ¬ì ë¹„ìš© (ì›)</label>
            <input type="number" id="total-investment" placeholder="1000000">
          </div>
          <div>
            <label class="label">ëª©í‘œ ìˆœì´ìµ (ì›)</label>
            <input type="number" id="target-profit" placeholder="2000000">
          </div>
        </div>
        <button id="btn-break-even" class="secondary">ê³„ì‚°í•˜ê¸°</button>
        <div id="break-even-result" style="margin-top: 1rem;"></div>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: íŒë§¤ê°€ ê³„ì‚° & ì´ë ¥ -->
    <div class="right-col">
      <div class="box">
        <div class="box-title">ğŸª íŒë§¤ê°€ ê³„ì‚°</div>
        
        <div class="input-group">
          <label class="label">í¬ë§ ë§ˆì§„ìœ¨ (%)</label>
          <input type="number" id="margin-rate" placeholder="30" value="30" step="1">
        </div>
        
        <div class="input-row">
          <div>
            <label class="label">êµ­ë‚´ ë°°ì†¡ë¹„ (ì›)</label>
            <input type="number" id="domestic-shipping" placeholder="3000" value="3000">
          </div>
          <div>
            <label class="label">í¬ì¥ë¹„ (ì›)</label>
            <input type="number" id="packaging-cost" placeholder="800" value="800">
          </div>
        </div>
        
        <div class="input-group">
          <label class="label">ì˜ˆë¹„ë¹„ (ì›)</label>
          <input type="number" id="reserve-cost" placeholder="500" value="500">
        </div>
        
        <button id="btn-calc-selling-price">íŒë§¤ê°€ ê³„ì‚°í•˜ê¸°</button>
        
        <div id="selling-price-result" style="margin-top: 1.5rem;"></div>
      </div>

      <div class="box">
        <div class="box-title">ğŸ¯ ê²½ìŸì‚¬ ê°€ê²© ë¹„êµ</div>
        <div class="input-group">
          <label class="label">ê²½ìŸì‚¬ ìµœì €ê°€ (ì›)</label>
          <input type="number" id="competitor-price" placeholder="19900">
        </div>
        <button id="btn-compare-price" class="secondary">ë¹„êµí•˜ê¸°</button>
        <div id="price-compare-result" style="margin-top: 1rem;"></div>
      </div>

      <div class="box">
        <div class="box-title">ğŸ“¦ êµ¬ì… ë‚´ì—­</div>
        <button id="btn-save-history" class="success" style="margin-bottom: 1rem;">í˜„ì¬ ê³„ì‚° ê²°ê³¼ ì €ì¥</button>
        <div id="purchase-history">
          <p style="color: #94a3b8; text-align: center; padding: 1rem;">ì €ì¥ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      </div>

      <div class="box">
        <div class="box-title">ğŸ“¥ ë‚´ë³´ë‚´ê¸°</div>
        <button id="btn-export-pdf" class="secondary">PDF ë‹¤ìš´ë¡œë“œ</button>
        <button id="btn-export-excel" class="secondary" style="margin-top: .5rem;">ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
      </div>

      <div class="box">
        <div class="box-title">ğŸ“š ë°°ì†¡ë¹„ ìš”ê¸ˆí‘œ</div>
        <table class="shipping-table">
          <thead>
            <tr>
              <th colspan="2">ì¼ë°˜ í•´ìš´</th>
            </tr>
            <tr>
              <th>ë¬´ê²Œ</th>
              <th>ë°°ì†¡ë¹„</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>1kg</td><td>â‚©5,800</td></tr>
            <tr><td>1.5kg</td><td>â‚©6,500</td></tr>
            <tr><td>2kg</td><td>â‚©7,200</td></tr>
            <tr><td>2.5kg</td><td>â‚©7,900</td></tr>
            <tr><td>3kg</td><td>â‚©8,600</td></tr>
            <tr><td colspan="2" style="text-align: center; font-size: .85rem; color: #64748b;">0.5kgë‹¹ â‚©700 ì¶”ê°€</td></tr>
          </tbody>
        </table>
        
        <table class="shipping-table" style="margin-top: 1rem;">
          <thead>
            <tr>
              <th colspan="2">LCL</th>
            </tr>
            <tr>
              <th>CBM</th>
              <th>ë°°ì†¡ë¹„</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>0.5CBM</td><td>â‚©42,500</td></tr>
            <tr><td>1CBM</td><td>â‚©85,000</td></tr>
            <tr><td>1.5CBM</td><td>â‚©127,500</td></tr>
            <tr><td>2CBM</td><td>â‚©170,000</td></tr>
            <tr><td colspan="2" style="text-align: center; font-size: .85rem; color: #64748b;">
              + BLë¹„ìš© â‚©22,000<br>
              + í•¸ë“¤ë§ë¹„ â‚©33,000<br>
              + í†µê´€ìˆ˜ìˆ˜ë£Œ â‚©33,000
            </td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
  // ì „ì—­ ë³€ìˆ˜
  let exchangeRate = 180; // ê¸°ë³¸ í™˜ìœ¨
  let currentShipping = 'sea'; // í˜„ì¬ ë°°ì†¡ ë°©ë²•
  let lastCalculation = null; // ë§ˆì§€ë§‰ ê³„ì‚° ê²°ê³¼

  // ìë™ ë†’ì´ ì¡°ì ˆ
  function autoResize(el) {
    if (!el) return;
    el.style.height = 'auto';
    el.style.height = el.scrollHeight + 'px';
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ
  document.addEventListener('DOMContentLoaded', () => {
    loadExchangeRate();
    loadSavedProducts();
    loadPurchaseHistory();
    
    document.querySelectorAll('textarea').forEach(t => {
      t.addEventListener('input', () => autoResize(t));
    });
  });

  // í™˜ìœ¨ ë¶ˆëŸ¬ì˜¤ê¸°
  function loadExchangeRate() {
    fetch('/api/trade/exchange-rate')
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          exchangeRate = data.rate;
          const display = document.getElementById('exchange-rate-display');
          display.textContent = `1ìœ„ì•ˆ = ${exchangeRate.toFixed(2)}ì›`;
          if (data.fallback) {
            display.textContent += ' (ê¸°ë³¸ê°’)';
          }
        }
      })
      .catch(err => console.error('í™˜ìœ¨ ë¡œë“œ ì‹¤íŒ¨:', err));
  }

  // ë°°ì†¡ ë°©ë²• ì„ íƒ
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      currentShipping = btn.dataset.shipping;
      
      if (currentShipping === 'sea') {
        document.getElementById('shipping-sea').style.display = 'block';
        document.getElementById('shipping-lcl').style.display = 'none';
      } else {
        document.getElementById('shipping-sea').style.display = 'none';
        document.getElementById('shipping-lcl').style.display = 'block';
      }
    });
  });

  // HSì½”ë“œ ì¶”ì²œ
  document.getElementById('btn-hs-recommend').addEventListener('click', () => {
    const productName = document.getElementById('product-name').value;
    const description = document.getElementById('product-desc').value;
    
    if (!productName) {
      alert('ì œí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    const resultBox = document.getElementById('hs-result');
    resultBox.value = 'ğŸ” HSì½”ë“œ ì¶”ì²œ ì¤‘...';
    
    fetch('/api/trade/hs-code', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        product_name: productName,
        description: description
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.result) {
        resultBox.value = data.result;
        autoResize(resultBox);
      } else {
        resultBox.value = 'ì˜¤ë¥˜: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
      }
    })
    .catch(err => {
      resultBox.value = 'ì˜¤ë¥˜ ë°œìƒ: ' + err.message;
    });
  });

  // ë°°ì†¡ë¹„ ê³„ì‚°
  function calculateShipping(weight, qty) {
    if (currentShipping === 'sea') {
      // ì¼ë°˜ í•´ìš´: 0.5kg ë‹¨ìœ„ ì ˆìƒ
      const totalWeight = weight * qty;
      const roundedWeight = Math.ceil(totalWeight * 2) / 2; // 0.5kg ë‹¨ìœ„ ì ˆìƒ
      
      // ê¸°ë³¸ 1kg = 5800ì›, 0.5kgë‹¹ 700ì› ì¶”ê°€
      let shipping = 5800;
      if (roundedWeight > 1) {
        shipping += Math.floor((roundedWeight - 1) * 2) * 700;
      }
      
      return {
        type: 'ì¼ë°˜ í•´ìš´',
        weight: roundedWeight,
        cost: shipping,
        detail: `${roundedWeight}kg Ã— ${roundedWeight <= 1 ? 'â‚©5,800' : 'â‚©5,800 + ' + Math.floor((roundedWeight - 1) * 2) + ' Ã— â‚©700'}`
      };
    } else {
      // LCL: CBM ê³„ì‚°
      const width = parseFloat(document.getElementById('box-width').value) || 0;
      const length = parseFloat(document.getElementById('box-length').value) || 0;
      const height = parseFloat(document.getElementById('box-height').value) || 0;
      
      if (width === 0 || length === 0 || height === 0) {
        return {
          type: 'LCL',
          cbm: 0,
          cost: 0,
          detail: 'ë°•ìŠ¤ í¬ê¸°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'
        };
      }
      
      const cbmPerUnit = (width * length * height) / 1000000;
      const totalCBM = cbmPerUnit * qty;
      
      // 0.5CBM ë¯¸ë§Œì€ 0.5CBMìœ¼ë¡œ
      const roundedCBM = Math.max(0.5, Math.ceil(totalCBM * 2) / 2);
      
      // CBMë‹¹ 85,000ì›
      const cbmCost = roundedCBM * 85000;
      
      // ì¶”ê°€ ë¹„ìš©
      const blCost = 22000;
      const handlingCost = 33000;
      const customsCost = 33000;
      
      const totalCost = cbmCost + blCost + handlingCost + customsCost;
      
      return {
        type: 'LCL',
        cbm: roundedCBM,
        cost: totalCost,
        detail: `${roundedCBM}CBM (â‚©${cbmCost.toLocaleString()}) + BL(â‚©22,000) + í•¸ë“¤ë§(â‚©33,000) + í†µê´€(â‚©33,000)`
      };
    }
  }

  // ì›ê°€ ê³„ì‚°
  document.getElementById('btn-calculate').addEventListener('click', () => {
    const price = parseFloat(document.getElementById('product-price').value) || 0;
    const qty = parseInt(document.getElementById('product-qty').value) || 0;
    const weight = parseFloat(document.getElementById('product-weight').value) || 0;
    const extraShipping = parseFloat(document.getElementById('extra-shipping').value) || 0;
    const cardFee = parseFloat(document.getElementById('card-fee').value) || 0;
    const customsFee = parseFloat(document.getElementById('customs-fee').value) || 0;
    const vatFee = parseFloat(document.getElementById('vat-fee').value) || 0;
    const otherFee = parseFloat(document.getElementById('other-fee').value) || 0;
    
    if (price === 0 || qty === 0) {
      alert('ì œí’ˆ ê°€ê²©ê³¼ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    // 1. ì œí’ˆ ê¸ˆì•¡ (ì›í™”)
    const productCost = price * qty * exchangeRate;
    
    // 2. ì¹´ë“œ ìˆ˜ìˆ˜ë£Œ
    const cardFeeCost = productCost * (cardFee / 100);
    
    // 3. ë°°ì†¡ë¹„
    const shipping = calculateShipping(weight, qty);
    const shippingCost = shipping.cost + extraShipping;
    
    // 4. ê´€ì„¸ (ì œí’ˆ ê¸ˆì•¡ + ë°°ì†¡ë¹„ ê¸°ì¤€)
    const customsBase = productCost + shippingCost;
    const customsFeeCost = customsBase * (customsFee / 100);
    
    // 5. ë¶€ê°€ì„¸ (ì œí’ˆ ê¸ˆì•¡ + ë°°ì†¡ë¹„ + ê´€ì„¸ ê¸°ì¤€)
    const vatBase = customsBase + customsFeeCost;
    const vatFeeCost = vatBase * (vatFee / 100);
    
    // 6. ì´ ì›ê°€
    const totalCost = productCost + cardFeeCost + shippingCost + customsFeeCost + vatFeeCost + otherFee;
    const costPerUnit = totalCost / qty;
    
    // ê²°ê³¼ ì €ì¥
    lastCalculation = {
      productCost,
      cardFeeCost,
      shippingCost,
      customsFeeCost,
      vatFeeCost,
      otherFee,
      totalCost,
      costPerUnit,
      qty,
      shipping
    };
    
    // ê²°ê³¼ í‘œì‹œ
    const resultBox = document.getElementById('cost-result');
    resultBox.innerHTML = `
      <div class="result-box">
        <div class="result-row">
          <span class="result-label">ì œí’ˆ ê¸ˆì•¡ (${qty}ê°œ)</span>
          <span class="result-value">â‚©${productCost.toLocaleString()}</span>
        </div>
        <div class="result-row">
          <span class="result-label">ì¹´ë“œ ìˆ˜ìˆ˜ë£Œ (${cardFee}%)</span>
          <span class="result-value">â‚©${cardFeeCost.toLocaleString()}</span>
        </div>
        <div class="result-row">
          <span class="result-label">ë°°ì†¡ë¹„ (${shipping.detail})</span>
          <span class="result-value">â‚©${shippingCost.toLocaleString()}</span>
        </div>
        <div class="result-row">
          <span class="result-label">ê´€ì„¸ (${customsFee}%)</span>
          <span class="result-value">â‚©${customsFeeCost.toLocaleString()}</span>
        </div>
        <div class="result-row">
          <span class="result-label">ë¶€ê°€ì„¸ (${vatFee}%)</span>
          <span class="result-value">â‚©${vatFeeCost.toLocaleString()}</span>
        </div>
        ${otherFee > 0 ? `<div class="result-row">
          <span class="result-label">ê¸°íƒ€ ìˆ˜ìˆ˜ë£Œ</span>
          <span class="result-value">â‚©${otherFee.toLocaleString()}</span>
        </div>` : ''}
        <div class="result-row">
          <span class="result-label">ì´ ì›ê°€</span>
          <span class="result-value">â‚©${totalCost.toLocaleString()}</span>
        </div>
        <div class="result-row">
          <span class="result-label">ê°œë‹¹ ì›ê°€</span>
          <span class="result-value">â‚©${costPerUnit.toLocaleString()}</span>
        </div>
      </div>
      <div class="alert alert-success" style="margin-top: 1rem;">
        âœ… ê³„ì‚° ì™„ë£Œ! íŒë§¤ê°€ ê³„ì‚°ì„ ì§„í–‰í•˜ì„¸ìš”.
      </div>
    `;
  });

  // íŒë§¤ê°€ ê³„ì‚°
  document.getElementById('btn-calc-selling-price').addEventListener('click', () => {
    if (!lastCalculation) {
      alert('ë¨¼ì € ì›ê°€ë¥¼ ê³„ì‚°í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    const marginRate = parseFloat(document.getElementById('margin-rate').value) || 0;
    const domesticShipping = parseFloat(document.getElementById('domestic-shipping').value) || 0;
    const packagingCost = parseFloat(document.getElementById('packaging-cost').value) || 0;
    const reserveCost = parseFloat(document.getElementById('reserve-cost').value) || 0;
    
    const costPerUnit = lastCalculation.costPerUnit;
    
    // ë„¤ì´ë²„ (ìˆ˜ìˆ˜ë£Œ 5.85%)
    const naverFeeRate = 5.85;
    const naverBaseCost = costPerUnit + domesticShipping + packagingCost + reserveCost;
    const naverMargin = naverBaseCost * (marginRate / 100);
    const naverBeforeFee = naverBaseCost + naverMargin;
    const naverFee = naverBeforeFee * (naverFeeRate / 100);
    const naverSellingPrice = Math.ceil((naverBeforeFee + naverFee) / 100) * 100; // 100ì› ë‹¨ìœ„
    const naverProfit = naverSellingPrice - naverFee - naverBaseCost;
    
    // ì¿ íŒ¡ (ìˆ˜ìˆ˜ë£Œ 15%)
    const coupangFeeRate = 15;
    const coupangBaseCost = costPerUnit + packagingCost + reserveCost; // ì¿ íŒ¡ì€ ë°°ì†¡ë¹„ ë¬´ë£Œ
    const coupangMargin = coupangBaseCost * (marginRate / 100);
    const coupangBeforeFee = coupangBaseCost + coupangMargin;
    const coupangFee = coupangBeforeFee * (coupangFeeRate / 100);
    const coupangSellingPrice = Math.ceil((coupangBeforeFee + coupangFee) / 100) * 100;
    const coupangProfit = coupangSellingPrice - coupangFee - coupangBaseCost;
    
    const resultBox = document.getElementById('selling-price-result');
    resultBox.innerHTML = `
      <div class="platform-box naver">
        <div class="platform-title">ğŸŸ¢ ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´</div>
        <div class="platform-row">
          <span>ì›ê°€</span>
          <span>â‚©${costPerUnit.toLocaleString()}</span>
        </div>
        <div class="platform-row">
          <span>í”Œë«í¼ ìˆ˜ìˆ˜ë£Œ (${naverFeeRate}%)</span>
          <span>â‚©${naverFee.toLocaleString()}</span>
        </div>
        <div class="platform-row">
          <span>ë°°ì†¡ë¹„</span>
          <span>â‚©${domesticShipping.toLocaleString()}</span>
        </div>
        <div class="platform-row">
          <span>í¬ì¥ë¹„</span>
          <span>â‚©${packagingCost.toLocaleString()}</span>
        </div>
        <div class="platform-row">
          <span>ì˜ˆë¹„ë¹„</span>
          <span>â‚©${reserveCost.toLocaleString()}</span>
        </div>
        <div class="platform-row">
          <span>ìˆœì´ìµ (ë§ˆì§„ ${marginRate}%)</span>
          <span>â‚©${naverProfit.toLocaleString()}</span>
        </div>
        <div class="platform-row">
          <span>ê¶Œì¥ íŒë§¤ê°€</span>
          <span>â‚©${naverSellingPrice.toLocaleString()}</span>
        </div>
      </div>
      
      <div class="platform-box coupang">
        <div class="platform-title">ğŸŸ  ì¿ íŒ¡</div>
        <div class="platform-row">
          <span>ì›ê°€</span>
          <span>â‚©${costPerUnit.toLocaleString()}</span>
        </div>
        <div class="platform-row">
          <span>í”Œë«í¼ ìˆ˜ìˆ˜ë£Œ (${coupangFeeRate}%)</span>
          <span>â‚©${coupangFee.toLocaleString()}</span>
        </div>
        <div class="platform-row">
          <span>ë°°ì†¡ë¹„ (ë¡œì¼“ë°°ì†¡)</span>
          <span>â‚©0</span>
        </div>
        <div class="platform-row">
          <span>í¬ì¥ë¹„</span>
          <span>â‚©${packagingCost.toLocaleString()}</span>
        </div>
        <div class="platform-row">
          <span>ì˜ˆë¹„ë¹„</span>
          <span>â‚©${reserveCost.toLocaleString()}</span>
        </div>
        <div class="platform-row">
          <span>ìˆœì´ìµ (ë§ˆì§„ ${marginRate}%)</span>
          <span>â‚©${coupangProfit.toLocaleString()}</span>
        </div>
        <div class="platform-row">
          <span>ê¶Œì¥ íŒë§¤ê°€</span>
          <span>â‚©${coupangSellingPrice.toLocaleString()}</span>
        </div>
      </div>
    `;
  });

  // ê²½ìŸì‚¬ ê°€ê²© ë¹„êµ
  document.getElementById('btn-compare-price').addEventListener('click', () => {
    if (!lastCalculation) {
      alert('ë¨¼ì € ì›ê°€ë¥¼ ê³„ì‚°í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    const competitorPrice = parseFloat(document.getElementById('competitor-price').value) || 0;
    
    if (competitorPrice === 0) {
      alert('ê²½ìŸì‚¬ ìµœì €ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    const marginRate = parseFloat(document.getElementById('margin-rate').value) || 30;
    const domesticShipping = parseFloat(document.getElementById('domestic-shipping').value) || 3000;
    const packagingCost = parseFloat(document.getElementById('packaging-cost').value) || 800;
    const reserveCost = parseFloat(document.getElementById('reserve-cost').value) || 500;
    
    const costPerUnit = lastCalculation.costPerUnit;
    const naverFeeRate = 5.85;
    const naverBaseCost = costPerUnit + domesticShipping + packagingCost + reserveCost;
    const naverMargin = naverBaseCost * (marginRate / 100);
    const naverBeforeFee = naverBaseCost + naverMargin;
    const naverFee = naverBeforeFee * (naverFeeRate / 100);
    const naverSellingPrice = Math.ceil((naverBeforeFee + naverFee) / 100) * 100;
    
    const difference = naverSellingPrice - competitorPrice;
    const diffPercent = (difference / competitorPrice * 100).toFixed(1);
    
    const resultBox = document.getElementById('price-compare-result');
    
    let alertClass = 'alert-success';
    let message = 'âœ… ê²½ìŸë ¥ ìˆëŠ” ê°€ê²©ì…ë‹ˆë‹¤!';
    
    if (difference > 0) {
      alertClass = 'alert-warning';
      message = `âš ï¸ ê²½ìŸì‚¬ë³´ë‹¤ â‚©${difference.toLocaleString()} (${diffPercent}%) ë¹„ìŒ‰ë‹ˆë‹¤.`;
    } else if (difference < 0) {
      alertClass = 'alert-success';
      message = `âœ… ê²½ìŸì‚¬ë³´ë‹¤ â‚©${Math.abs(difference).toLocaleString()} (${Math.abs(diffPercent)}%) ì €ë ´í•©ë‹ˆë‹¤!`;
    } else {
      alertClass = 'alert-info';
      message = 'ğŸ’¡ ê²½ìŸì‚¬ì™€ ë™ì¼í•œ ê°€ê²©ì…ë‹ˆë‹¤.';
    }
    
    resultBox.innerHTML = `
      <div class="alert ${alertClass}">
        <strong>${message}</strong><br>
        ë‚´ íŒë§¤ê°€: â‚©${naverSellingPrice.toLocaleString()}<br>
        ê²½ìŸì‚¬ ìµœì €ê°€: â‚©${competitorPrice.toLocaleString()}
      </div>
    `;
  });

  // ì†ìµë¶„ê¸°ì  ê³„ì‚°
  document.getElementById('btn-break-even').addEventListener('click', () => {
    if (!lastCalculation) {
      alert('ë¨¼ì € ì›ê°€ë¥¼ ê³„ì‚°í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    const totalInvestment = parseFloat(document.getElementById('total-investment').value) || 0;
    const targetProfit = parseFloat(document.getElementById('target-profit').value) || 0;
    
    if (totalInvestment === 0) {
      alert('ì´ íˆ¬ì ë¹„ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    // ê°œë‹¹ ìˆœì´ìµ ê³„ì‚° (ë„¤ì´ë²„ ê¸°ì¤€)
    const marginRate = parseFloat(document.getElementById('margin-rate').value) || 30;
    const domesticShipping = parseFloat(document.getElementById('domestic-shipping').value) || 3000;
    const packagingCost = parseFloat(document.getElementById('packaging-cost').value) || 800;
    const reserveCost = parseFloat(document.getElementById('reserve-cost').value) || 500;
    
    const costPerUnit = lastCalculation.costPerUnit;
    const naverFeeRate = 5.85;
    const naverBaseCost = costPerUnit + domesticShipping + packagingCost + reserveCost;
    const naverMargin = naverBaseCost * (marginRate / 100);
    const naverBeforeFee = naverBaseCost + naverMargin;
    const naverFee = naverBeforeFee * (naverFeeRate / 100);
    const naverSellingPrice = Math.ceil((naverBeforeFee + naverFee) / 100) * 100;
    const profitPerUnit = naverSellingPrice - naverFee - naverBaseCost;
    
    if (profitPerUnit <= 0) {
      alert('ê°œë‹¹ ìˆœì´ìµì´ 0ì› ì´í•˜ì…ë‹ˆë‹¤. ë§ˆì§„ìœ¨ì„ ì˜¬ë ¤ì£¼ì„¸ìš”.');
      return;
    }
    
    const breakEvenQty = Math.ceil(totalInvestment / profitPerUnit);
    const targetQty = targetProfit > 0 ? Math.ceil((totalInvestment + targetProfit) / profitPerUnit) : 0;
    
    const resultBox = document.getElementById('break-even-result');
    resultBox.innerHTML = `
      <div class="alert alert-info">
        <strong>ğŸ’° ê°œë‹¹ ìˆœì´ìµ: â‚©${profitPerUnit.toLocaleString()}</strong>
      </div>
      <div class="result-box">
        <div class="result-row">
          <span class="result-label">ì†ìµë¶„ê¸°ì </span>
          <span class="result-value">${breakEvenQty.toLocaleString()}ê°œ íŒë§¤</span>
        </div>
        ${targetProfit > 0 ? `<div class="result-row">
          <span class="result-label">ëª©í‘œ ìˆœì´ìµ ë‹¬ì„±</span>
          <span class="result-value">${targetQty.toLocaleString()}ê°œ íŒë§¤</span>
        </div>` : ''}
        <div class="result-row">
          <span class="result-label">ì†ìµë¶„ê¸°ì  ë§¤ì¶œ</span>
          <span class="result-value">â‚©${(breakEvenQty * naverSellingPrice).toLocaleString()}</span>
        </div>
        ${targetProfit > 0 ? `<div class="result-row">
          <span class="result-label">ëª©í‘œ ë‹¬ì„± ë§¤ì¶œ</span>
          <span class="result-value">â‚©${(targetQty * naverSellingPrice).toLocaleString()}</span>
        </div>` : ''}
      </div>
    `;
  });

  // ìˆ˜ëŸ‰ë³„ ì‹œë®¬ë ˆì´ì…˜
  document.getElementById('btn-simulate').addEventListener('click', () => {
    const qty1 = parseInt(document.getElementById('sim-qty-1').value) || 0;
    const qty2 = parseInt(document.getElementById('sim-qty-2').value) || 0;
    const qty3 = parseInt(document.getElementById('sim-qty-3').value) || 0;
    
    if (qty1 === 0 && qty2 === 0 && qty3 === 0) {
      alert('ì‹œë®¬ë ˆì´ì…˜ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    const price = parseFloat(document.getElementById('product-price').value) || 0;
    const weight = parseFloat(document.getElementById('product-weight').value) || 0;
    
    if (price === 0 || weight === 0) {
      alert('ì œí’ˆ ê°€ê²©ê³¼ ë¬´ê²Œë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    const quantities = [qty1, qty2, qty3].filter(q => q > 0);
    let html = '<table class="shipping-table"><thead><tr><th>ìˆ˜ëŸ‰</th><th>ê°œë‹¹ ì›ê°€</th><th>ì´ ì›ê°€</th></tr></thead><tbody>';
    
    quantities.forEach(qty => {
      // ê°„ë‹¨ ê³„ì‚°
      const productCost = price * qty * exchangeRate;
      const shipping = calculateShipping(weight, qty);
      const shippingCost = shipping.cost;
      const cardFeeCost = productCost * 0.015;
      const customsFeeCost = (productCost + shippingCost) * 0.08;
      const vatFeeCost = (productCost + shippingCost + customsFeeCost) * 0.1;
      const totalCost = productCost + cardFeeCost + shippingCost + customsFeeCost + vatFeeCost;
      const costPerUnit = totalCost / qty;
      
      html += `
        <tr>
          <td>${qty.toLocaleString()}ê°œ</td>
          <td>â‚©${costPerUnit.toLocaleString()}</td>
          <td>â‚©${totalCost.toLocaleString()}</td>
        </tr>
      `;
    });
    
    html += '</tbody></table>';
    html += '<div class="alert alert-info" style="margin-top: 1rem;">ğŸ’¡ ìˆ˜ëŸ‰ì´ ë§ì„ìˆ˜ë¡ ê°œë‹¹ ì›ê°€ê°€ ë‚®ì•„ì§‘ë‹ˆë‹¤.</div>';
    
    document.getElementById('simulation-result').innerHTML = html;
  });

  // ì œí’ˆ ì €ì¥
  document.getElementById('btn-save-product').addEventListener('click', () => {
    const productName = document.getElementById('product-name').value;
    const productDesc = document.getElementById('product-desc').value;
    const hsCode = document.getElementById('hs-code').value;
    const price = document.getElementById('product-price').value;
    const weight = document.getElementById('product-weight').value;
    const link = document.getElementById('product-link').value;
    
    if (!productName) {
      alert('ì œí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    const saved = JSON.parse(localStorage.getItem('saved-products') || '[]');
    saved.unshift({
      name: productName,
      desc: productDesc,
      hsCode: hsCode,
      price: price,
      weight: weight,
      link: link,
      savedAt: new Date().toISOString()
    });
    
    localStorage.setItem('saved-products', JSON.stringify(saved));
    loadSavedProducts();
    alert('ì œí’ˆì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
  });

  // ì €ì¥ëœ ì œí’ˆ ë¶ˆëŸ¬ì˜¤ê¸°
  function loadSavedProducts() {
    const saved = JSON.parse(localStorage.getItem('saved-products') || '[]');
    const listBox = document.getElementById('saved-products-list');
    
    if (saved.length === 0) {
      listBox.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 1rem;">ì €ì¥ëœ í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }
    
    let html = '';
    saved.forEach((item, idx) => {
      html += `
        <div class="saved-item" data-idx="${idx}">
          <div class="saved-item-info">
            <div class="saved-item-name">${item.name}</div>
            <div class="saved-item-meta">HS: ${item.hsCode || 'ë¯¸ì…ë ¥'} | Â¥${item.price} | ${item.weight}kg</div>
          </div>
          <div class="saved-item-actions">
            <button class="small secondary" onclick="loadProduct(${idx})">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="small secondary" onclick="deleteProduct(${idx})">ì‚­ì œ</button>
          </div>
        </div>
      `;
    });
    
    listBox.innerHTML = html;
  }

  // ì œí’ˆ ë¶ˆëŸ¬ì˜¤ê¸°
  window.loadProduct = function(idx) {
    const saved = JSON.parse(localStorage.getItem('saved-products') || '[]');
    const item = saved[idx];
    
    document.getElementById('product-name').value = item.name;
    document.getElementById('product-desc').value = item.desc;
    document.getElementById('hs-code').value = item.hsCode;
    document.getElementById('product-price').value = item.price;
    document.getElementById('product-weight').value = item.weight;
    document.getElementById('product-link').value = item.link || '';
  };

  // ì œí’ˆ ì‚­ì œ
  window.deleteProduct = function(idx) {
    if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    const saved = JSON.parse(localStorage.getItem('saved-products') || '[]');
    saved.splice(idx, 1);
    localStorage.setItem('saved-products', JSON.stringify(saved));
    loadSavedProducts();
  };

  // êµ¬ì… ë‚´ì—­ ì €ì¥
  document.getElementById('btn-save-history').addEventListener('click', () => {
    if (!lastCalculation) {
      alert('ë¨¼ì € ì›ê°€ë¥¼ ê³„ì‚°í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    const productName = document.getElementById('product-name').value;
    const qty = document.getElementById('product-qty').value;
    const link = document.getElementById('product-link').value;
    
    const history = JSON.parse(localStorage.getItem('purchase-history') || '[]');
    history.unshift({
      productName: productName,
      qty: qty,
      link: link,
      totalCost: lastCalculation.totalCost,
      costPerUnit: lastCalculation.costPerUnit,
      purchaseDate: new Date().toISOString(),
      calculation: lastCalculation
    });
    
    localStorage.setItem('purchase-history', JSON.stringify(history));
    loadPurchaseHistory();
    alert('êµ¬ì… ë‚´ì—­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
  });

  // êµ¬ì… ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
  function loadPurchaseHistory() {
    const history = JSON.parse(localStorage.getItem('purchase-history') || '[]');
    const historyBox = document.getElementById('purchase-history');
    
    if (history.length === 0) {
      historyBox.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 1rem;">ì €ì¥ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }
    
    let html = '';
    history.forEach((item, idx) => {
      const date = new Date(item.purchaseDate).toLocaleString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      html += `
        <div class="history-item">
          <div class="history-header">
            <div class="history-date">${date}</div>
            <div class="history-actions">
              <button class="small secondary" onclick="deleteHistory(${idx})">ì‚­ì œ</button>
            </div>
          </div>
          <div class="history-detail">
            <strong>${item.productName}</strong> Ã— ${item.qty}ê°œ<br>
            ì´ ì›ê°€: â‚©${item.totalCost.toLocaleString()}<br>
            ê°œë‹¹ ì›ê°€: â‚©${item.costPerUnit.toLocaleString()}
            ${item.link ? `<br><a href="${item.link}" target="_blank" style="color: #3b82f6;">ğŸ”— ìƒí’ˆ ë§í¬</a>` : ''}
          </div>
        </div>
      `;
    });
    
    historyBox.innerHTML = html;
  }

  // ë‚´ì—­ ì‚­ì œ
  window.deleteHistory = function(idx) {
    if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    const history = JSON.parse(localStorage.getItem('purchase-history') || '[]');
    history.splice(idx, 1);
    localStorage.setItem('purchase-history', JSON.stringify(history));
    loadPurchaseHistory();
  };

  // PDF ë‚´ë³´ë‚´ê¸° (ê°„ë‹¨ êµ¬í˜„)
  document.getElementById('btn-export-pdf').addEventListener('click', () => {
    alert('PDF ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.\ní˜„ì¬ëŠ” ë¸Œë¼ìš°ì € ì¸ì‡„ ê¸°ëŠ¥(Ctrl+P)ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
    window.print();
  });

  // ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
  document.getElementById('btn-export-excel').addEventListener('click', () => {
    const history = JSON.parse(localStorage.getItem('purchase-history') || '[]');
    
    if (history.length === 0) {
      alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    let csv = 'ì£¼ë¬¸ì¼,ì œí’ˆëª…,ìˆ˜ëŸ‰,ì´ì›ê°€,ê°œë‹¹ì›ê°€,ë§í¬\n';
    history.forEach(item => {
      const date = new Date(item.purchaseDate).toLocaleDateString('ko-KR');
      csv += `${date},${item.productName},${item.qty},${item.totalCost},${item.costPerUnit},"${item.link || ''}"\n`;
    });
    
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `êµ¬ì…ë‚´ì—­_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  });

  // 1688 ë§í¬ íŒŒì‹±
document.getElementById('btn-parse-link').addEventListener('click', () => {
  const link = document.getElementById('product-link').value.trim();
  
  if (!link) {
    alert('ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  if (!link.includes('1688.com') && !link.includes('taobao.com') && !link.includes('tmall.com')) {
    alert('1688, íƒ€ì˜¤ë°”ì˜¤, í‹°ëª° ë§í¬ë§Œ ì§€ì›ë©ë‹ˆë‹¤.');
    return;
  }
  
  const btn = document.getElementById('btn-parse-link');
  const originalText = btn.textContent;
  btn.textContent = 'ğŸ”„ ë¶„ì„ ì¤‘...';
  btn.disabled = true;
  
  const parseResult = document.getElementById('parse-result');
  parseResult.style.display = 'block';
  parseResult.innerHTML = '<div class="alert alert-info">ğŸ” í˜ì´ì§€ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>';
  
  fetch('/api/trade/parse-1688', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ url: link })
  })
  .then(res => res.json())
  .then(data => {
    if (data.ok && data.result) {
      parseResult.innerHTML = `
        <div class="alert alert-success">
          <strong>âœ… ì œí’ˆ ì •ë³´ ì¶”ì¶œ ì™„ë£Œ!</strong><br><br>
          ${data.result.replace(/\n/g, '<br>')}
        </div>
        <button class="small success" onclick="applyParsedInfo()">â¬‡ï¸ ì •ë³´ ì ìš©í•˜ê¸°</button>
      `;
      
      // ê²°ê³¼ë¥¼ ì„ì‹œ ì €ì¥
      window.parsedProductInfo = data.result;
    } else {
      parseResult.innerHTML = `
        <div class="alert alert-warning">
          âš ï¸ ${data.error || 'ì œí’ˆ ì •ë³´ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}<br><br>
          <strong>ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”:</strong><br>
          1. í˜ì´ì§€ì—ì„œ ì œí’ˆëª… ë³µì‚¬<br>
          2. ì œí’ˆ ì„¤ëª… ë³µì‚¬<br>
          3. ì•„ë˜ ì…ë ¥ë€ì— ë¶™ì—¬ë„£ê¸°
        </div>
      `;
    }
  })
  .catch(err => {
    parseResult.innerHTML = `
      <div class="alert alert-warning">
        âš ï¸ ì˜¤ë¥˜ ë°œìƒ: ${err.message}<br><br>
        1688 í˜ì´ì§€ê°€ ë¡œê·¸ì¸ì„ ìš”êµ¬í•˜ê±°ë‚˜ ì°¨ë‹¨í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
        ìˆ˜ë™ìœ¼ë¡œ ì œí’ˆëª…ê³¼ ì„¤ëª…ì„ ë³µì‚¬í•´ì„œ ì…ë ¥í•´ì£¼ì„¸ìš”.
      </div>
    `;
  })
  .finally(() => {
    btn.textContent = originalText;
    btn.disabled = false;
  });
});

// ì¶”ì¶œëœ ì •ë³´ ì ìš©
window.applyParsedInfo = function() {
  if (!window.parsedProductInfo) return;
  
  const info = window.parsedProductInfo;
  
  // ì œí’ˆëª… ì¶”ì¶œ
  const nameMatch = info.match(/\*\*ì œí’ˆëª…\*\*[:\s]+(.+?)(?:\n|$)/);
  if (nameMatch) {
    document.getElementById('product-name').value = nameMatch[1].trim();
  }
  
  // ì œí’ˆ ì„¤ëª… ì¶”ì¶œ
  const descMatch = info.match(/\*\*ì œí’ˆ ì„¤ëª…\*\*[:\s]+(.+?)(?:\n\*\*|$)/s);
  if (descMatch) {
    document.getElementById('product-desc').value = descMatch[1].trim();
  }
  
  // HSì½”ë“œ ì¶”ì¶œ
  const hsMatch = info.match(/\*\*ì¶”ì²œ HSì½”ë“œ\*\*[:\s]+([\d.\-]+)/);
  if (hsMatch) {
    document.getElementById('hs-code').value = hsMatch[1].trim();
  }
  
  // ê°€ê²© ì¶”ì¶œ
  const priceMatch = info.match(/\*\*ì˜ˆìƒ ê°€ê²©\*\*[:\s]+[Â¥ï¿¥]?([\d.]+)/);
  if (priceMatch) {
    document.getElementById('product-price').value = priceMatch[1].trim();
  }
  
  alert('ì •ë³´ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤! í•„ìš”ì‹œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.');
  
  // íŒŒì‹± ê²°ê³¼ ë°•ìŠ¤ ìˆ¨ê¸°ê¸°
  document.getElementById('parse-result').style.display = 'none';
};
  </script>
</body>
</html>