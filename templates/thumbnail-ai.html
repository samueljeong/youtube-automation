<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI ì¸ë„¤ì¼ ìƒì„±ê¸° | Creator Lab</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Noto Sans KR', -apple-system, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #fff;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      padding: 30px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 30px;
    }
    header h1 {
      font-size: 2.5rem;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    header p { color: #888; font-size: 1.1rem; }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }
    @media (max-width: 1024px) {
      .main-grid { grid-template-columns: 1fr; }
    }

    .panel {
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .panel h2 {
      font-size: 1.3rem;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .panel h2 .icon { font-size: 1.5rem; }

    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #ccc;
    }
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(0,0,0,0.3);
      color: #fff;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    .form-group textarea {
      min-height: 150px;
      resize: vertical;
    }
    .form-group small {
      display: block;
      margin-top: 6px;
      color: #888;
      font-size: 0.85rem;
    }

    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .btn-secondary:hover {
      background: rgba(255,255,255,0.2);
    }
    .btn-select {
      background: linear-gradient(135deg, #11998e, #38ef7d);
      color: #fff;
    }
    .btn-select:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(56, 239, 125, 0.4);
    }

    .thumbnail-preview {
      display: none;
      margin-top: 30px;
    }
    .thumbnail-preview.active { display: block; }
    .thumbnail-preview h3 {
      margin-bottom: 20px;
      font-size: 1.2rem;
    }

    .thumbnail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    @media (max-width: 768px) {
      .thumbnail-grid { grid-template-columns: 1fr; }
    }

    .thumbnail-card {
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid transparent;
      transition: all 0.3s;
      cursor: pointer;
    }
    .thumbnail-card:hover {
      border-color: rgba(102, 126, 234, 0.5);
      transform: translateY(-4px);
    }
    .thumbnail-card.selected {
      border-color: #38ef7d;
      box-shadow: 0 0 20px rgba(56, 239, 125, 0.3);
    }
    .thumbnail-card .image-wrapper {
      position: relative;
      aspect-ratio: 16/9;
      background: #111;
    }
    .thumbnail-card .image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .thumbnail-card .variant-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .thumbnail-card .card-info {
      padding: 16px;
    }
    .thumbnail-card .card-info h4 {
      font-size: 1rem;
      margin-bottom: 8px;
    }
    .thumbnail-card .card-info p {
      font-size: 0.85rem;
      color: #888;
      line-height: 1.5;
    }
    .thumbnail-card .card-actions {
      padding: 0 16px 16px;
      display: flex;
      gap: 10px;
    }

    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .loading-overlay.active { display: flex; }
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255,255,255,0.1);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-text {
      margin-top: 20px;
      font-size: 1.1rem;
      color: #ccc;
    }

    .concept-preview {
      background: rgba(102, 126, 234, 0.1);
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 8px;
      padding: 16px;
      margin-top: 20px;
      display: none;
    }
    .concept-preview.active { display: block; }
    .concept-preview h4 {
      font-size: 0.95rem;
      color: #667eea;
      margin-bottom: 8px;
    }
    .concept-preview p {
      font-size: 0.9rem;
      color: #aaa;
      line-height: 1.6;
    }

    .stats-panel {
      margin-top: 30px;
      padding: 20px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
    }
    .stats-panel h3 {
      font-size: 1rem;
      margin-bottom: 15px;
      color: #888;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }
    .stat-item {
      text-align: center;
      padding: 15px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }
    .stat-item .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #667eea;
    }
    .stat-item .stat-label {
      font-size: 0.8rem;
      color: #888;
      margin-top: 5px;
    }

    .reason-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .reason-modal.active { display: flex; }
    .reason-modal-content {
      background: #1a1a2e;
      padding: 30px;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
    }
    .reason-modal-content h3 {
      margin-bottom: 20px;
    }
    .reason-modal-content textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(0,0,0,0.3);
      color: #fff;
      font-size: 1rem;
      min-height: 100px;
      margin-bottom: 20px;
    }
    .reason-modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .success-message {
      display: none;
      background: linear-gradient(135deg, #11998e, #38ef7d);
      color: #fff;
      padding: 16px 24px;
      border-radius: 8px;
      margin-top: 20px;
      text-align: center;
      font-weight: 500;
    }
    .success-message.active { display: block; }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #888;
      text-decoration: none;
      margin-bottom: 20px;
      transition: color 0.2s;
    }
    .back-link:hover { color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <a href="/drama" class="back-link">â† ë“œë¼ë§ˆ ì œì‘ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>

    <header>
      <h1>AI ì¸ë„¤ì¼ ìƒì„±ê¸°</h1>
      <p>GPT-5.1ì´ ëŒ€ë³¸ì„ ë¶„ì„í•˜ê³ , Gemini 3 Proê°€ í´ë¦­ë¥  ë†’ì€ ì¸ë„¤ì¼ì„ ìƒì„±í•©ë‹ˆë‹¤</p>
    </header>

    <div class="main-grid">
      <!-- ì™¼ìª½: ì…ë ¥ íŒ¨ë„ -->
      <div class="panel">
        <h2><span class="icon">ğŸ“</span> ëŒ€ë³¸ ì…ë ¥</h2>

        <div class="form-group">
          <label>ì œëª©</label>
          <input type="text" id="title" placeholder="ì˜ìƒ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>

        <div class="form-group">
          <label>ì¥ë¥´</label>
          <select id="genre">
            <option value="ì¬í…Œí¬/íˆ¬ì">ì¬í…Œí¬/íˆ¬ì</option>
            <option value="ê°ë™/íë§">ê°ë™/íë§</option>
            <option value="êµìœ¡/ì •ë³´">êµìœ¡/ì •ë³´</option>
            <option value="ì—”í„°í…Œì¸ë¨¼íŠ¸">ì—”í„°í…Œì¸ë¨¼íŠ¸</option>
            <option value="ë¼ì´í”„ìŠ¤íƒ€ì¼">ë¼ì´í”„ìŠ¤íƒ€ì¼</option>
            <option value="ì¼ë°˜" selected>ì¼ë°˜</option>
          </select>
        </div>

        <div class="form-group">
          <label>ëŒ€ë³¸</label>
          <textarea id="script" placeholder="ëŒ€ë³¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. AIê°€ ë¶„ì„í•˜ì—¬ ìµœì ì˜ ì¸ë„¤ì¼ ì»¨ì…‰ì„ ì œì•ˆí•©ë‹ˆë‹¤."></textarea>
          <small>ëŒ€ë³¸ì˜ í•µì‹¬ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ A/B ë‘ ê°€ì§€ ì¸ë„¤ì¼ í”„ë¡¬í”„íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤.</small>
        </div>

        <button class="btn btn-primary" id="btn-analyze" onclick="analyzeThumbnail()">
          <span>ğŸ¤–</span> AI ë¶„ì„ ì‹œì‘
        </button>

        <div class="concept-preview" id="concept-preview">
          <h4>ğŸ“Œ AI ë¶„ì„ ê²°ê³¼</h4>
          <p id="concept-text"></p>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½: ê²°ê³¼ íŒ¨ë„ -->
      <div class="panel">
        <h2><span class="icon">ğŸ–¼ï¸</span> ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°</h2>

        <div id="initial-state">
          <p style="color: #888; text-align: center; padding: 60px 0;">
            ì™¼ìª½ì—ì„œ ëŒ€ë³¸ì„ ì…ë ¥í•˜ê³  AI ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”.<br>
            ë‘ ê°€ì§€ ìŠ¤íƒ€ì¼ì˜ ì¸ë„¤ì¼ì´ ìƒì„±ë©ë‹ˆë‹¤.
          </p>
        </div>

        <div class="thumbnail-preview" id="thumbnail-preview">
          <h3>A/B ì¸ë„¤ì¼ ë¹„êµ</h3>
          <div class="thumbnail-grid" id="thumbnail-grid"></div>

          <div class="success-message" id="success-message">
            âœ… ì„ íƒì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! í•™ìŠµ ë°ì´í„°ë¡œ í™œìš©ë©ë‹ˆë‹¤.
          </div>
        </div>

        <div class="stats-panel" id="stats-panel" style="display: none;">
          <h3>ğŸ“Š í•™ìŠµ í†µê³„</h3>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="stat-total">0</div>
              <div class="stat-label">ì´ ì„ íƒ ìˆ˜</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-a">0</div>
              <div class="stat-label">A ì„ íƒ</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-b">0</div>
              <div class="stat-label">B ì„ íƒ</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
  <div class="loading-overlay" id="loading">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loading-text">AIê°€ ëŒ€ë³¸ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
  </div>

  <!-- ì„ íƒ ì´ìœ  ëª¨ë‹¬ -->
  <div class="reason-modal" id="reason-modal">
    <div class="reason-modal-content">
      <h3>ì„ íƒ ì´ìœ  (ì„ íƒì‚¬í•­)</h3>
      <textarea id="selection-reason" placeholder="ì´ ì¸ë„¤ì¼ì„ ì„ íƒí•œ ì´ìœ ë¥¼ ê°„ë‹¨íˆ ì ì–´ì£¼ì„¸ìš”. í•™ìŠµì— ë„ì›€ì´ ë©ë‹ˆë‹¤."></textarea>
      <div class="reason-modal-actions">
        <button class="btn btn-secondary" onclick="cancelSelection()">ì·¨ì†Œ</button>
        <button class="btn btn-select" onclick="confirmSelection()">ì„ íƒ í™•ì •</button>
      </div>
    </div>
  </div>

  <script>
    // ìƒíƒœ ê´€ë¦¬
    let currentSession = null;
    let currentPrompts = null;
    let currentImageUrls = {};
    let pendingSelection = null;

    // ì¸ë„¤ì¼ ë¶„ì„ ì‹œì‘
    async function analyzeThumbnail() {
      const title = document.getElementById('title').value.trim();
      const genre = document.getElementById('genre').value;
      const script = document.getElementById('script').value.trim();

      if (!script) {
        alert('ëŒ€ë³¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      showLoading('AIê°€ ëŒ€ë³¸ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

      try {
        // 1. GPT-5.1ë¡œ ëŒ€ë³¸ ë¶„ì„
        const analyzeRes = await fetch('/api/thumbnail-ai/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, genre, script })
        });
        const analyzeData = await analyzeRes.json();

        if (!analyzeData.ok) {
          throw new Error(analyzeData.error || 'ë¶„ì„ ì‹¤íŒ¨');
        }

        currentSession = analyzeData.session_id;
        currentPrompts = analyzeData.prompts;

        // ì»¨ì…‰ í”„ë¦¬ë·° í‘œì‹œ
        const conceptPreview = document.getElementById('concept-preview');
        const conceptText = document.getElementById('concept-text');
        conceptText.innerHTML = `
          <strong>ìš”ì•½:</strong> ${analyzeData.script_summary}<br><br>
          <strong>ì»¨ì…‰:</strong> ${analyzeData.thumbnail_concept}<br><br>
          <strong>í•™ìŠµ ë°ì´í„°:</strong> ${analyzeData.learning_examples_used}ê°œ í™œìš©ë¨
        `;
        conceptPreview.classList.add('active');

        // 2. Gemini 3 Proë¡œ A/B ì´ë¯¸ì§€ ìƒì„±
        showLoading('ì¸ë„¤ì¼ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤... (ì•½ 30ì´ˆ ì†Œìš”)');

        const generateRes = await fetch('/api/thumbnail-ai/generate-both', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            session_id: currentSession,
            prompts: currentPrompts
          })
        });
        const generateData = await generateRes.json();

        if (!generateData.ok) {
          throw new Error(generateData.error || 'ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨');
        }

        // ê²°ê³¼ ì €ì¥
        currentImageUrls = {
          A: generateData.results.A?.image_url,
          B: generateData.results.B?.image_url
        };

        // UI ì—…ë°ì´íŠ¸
        renderThumbnails(generateData.results);
        loadStats();

      } catch (error) {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      } finally {
        hideLoading();
      }
    }

    // ì¸ë„¤ì¼ ë Œë”ë§
    function renderThumbnails(results) {
      document.getElementById('initial-state').style.display = 'none';
      document.getElementById('thumbnail-preview').classList.add('active');

      const grid = document.getElementById('thumbnail-grid');
      grid.innerHTML = '';

      ['A', 'B'].forEach(variant => {
        const result = results[variant];
        const promptData = currentPrompts[variant];

        const card = document.createElement('div');
        card.className = 'thumbnail-card';
        card.dataset.variant = variant;

        if (result?.ok && result?.image_url) {
          card.innerHTML = `
            <div class="image-wrapper">
              <img src="${result.image_url}" alt="ì¸ë„¤ì¼ ${variant}">
              <span class="variant-badge">ì˜µì…˜ ${variant}</span>
            </div>
            <div class="card-info">
              <h4>${promptData?.description || 'ì¸ë„¤ì¼ ' + variant}</h4>
              <p><strong>í…ìŠ¤íŠ¸:</strong> ${promptData?.text_overlay?.main || '-'}</p>
              <p><strong>ìŠ¤íƒ€ì¼:</strong> ${promptData?.style || '-'}</p>
            </div>
            <div class="card-actions">
              <button class="btn btn-select" onclick="selectThumbnail('${variant}')">ì´ ì¸ë„¤ì¼ ì„ íƒ</button>
              <button class="btn btn-secondary" onclick="downloadThumbnail('${variant}', '${result.image_url}')">ë‹¤ìš´ë¡œë“œ</button>
            </div>
          `;
        } else {
          card.innerHTML = `
            <div class="image-wrapper" style="display:flex;align-items:center;justify-content:center;color:#888;">
              <span>ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨</span>
            </div>
            <div class="card-info">
              <h4>ì˜µì…˜ ${variant}</h4>
              <p style="color:#ff6b6b;">${result?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>
            </div>
          `;
        }

        grid.appendChild(card);
      });
    }

    // ì¸ë„¤ì¼ ì„ íƒ
    function selectThumbnail(variant) {
      pendingSelection = variant;

      // ì¹´ë“œ ì„ íƒ í‘œì‹œ
      document.querySelectorAll('.thumbnail-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.variant === variant);
      });

      // ì´ìœ  ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
      document.getElementById('reason-modal').classList.add('active');
    }

    // ì„ íƒ ì·¨ì†Œ
    function cancelSelection() {
      pendingSelection = null;
      document.querySelectorAll('.thumbnail-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.getElementById('reason-modal').classList.remove('active');
    }

    // ì„ íƒ í™•ì •
    async function confirmSelection() {
      const reason = document.getElementById('selection-reason').value.trim();

      try {
        const res = await fetch('/api/thumbnail-ai/select', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            session_id: currentSession,
            selected: pendingSelection,
            prompts: currentPrompts,
            script_summary: document.getElementById('concept-text').textContent,
            genre: document.getElementById('genre').value,
            title: document.getElementById('title').value,
            selection_reason: reason,
            image_urls: currentImageUrls
          })
        });
        const data = await res.json();

        if (data.ok) {
          // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
          document.getElementById('success-message').classList.add('active');
          setTimeout(() => {
            document.getElementById('success-message').classList.remove('active');
          }, 3000);

          // í†µê³„ ì—…ë°ì´íŠ¸
          loadStats();
        }
      } catch (error) {
        console.error('Selection error:', error);
      }

      // ëª¨ë‹¬ ë‹«ê¸°
      document.getElementById('reason-modal').classList.remove('active');
      document.getElementById('selection-reason').value = '';
    }

    // ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ
    function downloadThumbnail(variant, url) {
      const a = document.createElement('a');
      a.href = url;
      a.download = `thumbnail_${variant}_${Date.now()}.png`;
      a.click();
    }

    // í†µê³„ ë¡œë“œ
    async function loadStats() {
      try {
        const res = await fetch('/api/thumbnail-ai/history?limit=100');
        const data = await res.json();

        if (data.ok) {
          document.getElementById('stats-panel').style.display = 'block';
          document.getElementById('stat-total').textContent = data.stats.total;
          document.getElementById('stat-a').textContent = data.stats.a_selected;
          document.getElementById('stat-b').textContent = data.stats.b_selected;
        }
      } catch (error) {
        console.error('Stats error:', error);
      }
    }

    // ë¡œë”© í‘œì‹œ
    function showLoading(text) {
      document.getElementById('loading-text').textContent = text;
      document.getElementById('loading').classList.add('active');
      document.getElementById('btn-analyze').disabled = true;
    }

    function hideLoading() {
      document.getElementById('loading').classList.remove('active');
      document.getElementById('btn-analyze').disabled = false;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í†µê³„ ë¡œë“œ
    document.addEventListener('DOMContentLoaded', loadStats);
  </script>
</body>
</html>
