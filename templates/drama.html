<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>DRAMA LAB</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
    }
    .page-wrap {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      height: 100vh;
    }
    .left-col {
      width: 240px;
      display: flex;
      flex-direction: column;
      gap: .5rem;
      overflow-y: auto;
      font-size: .85rem;
    }
    .right-col {
      flex: 1;
      display: flex;
      gap: 1rem;
      min-width: 0;
      overflow-y: hidden;
    }
    .content-area {
      flex: 7;
      display: flex;
      flex-direction: column;
      gap: .75rem;
      overflow-y: auto;
      min-width: 0;
    }
    .analysis-area {
      flex: 3;
      display: flex;
      flex-direction: column;
      gap: .75rem;
      overflow-y: auto;
      min-width: 0;
    }
    .box {
      background: #fff;
      border: none;
      border-radius: 12px;
      padding: .75rem;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
      transition: box-shadow 0.2s ease;
    }
    .box:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,.1);
    }
    .label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: .5rem;
      margin-bottom: .35rem;
    }
    .label { font-weight: 600; }
    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: .35rem .5rem;
    }
    textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
      line-height: 1.4;
    }
    .btn-row {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
    }
    button {
      padding: .35rem .6rem;
      border: none;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,.05);
    }
    button:hover {
      background: #e9ecef;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,.1);
    }
    button.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    button.primary:hover {
      background: linear-gradient(135deg, #5568d3 0%, #663a91 100%);
    }
    button.danger {
      background: #e74c3c;
      color: white;
    }
    button.danger:hover {
      background: #c0392b;
    }
    button.step-btn {
      width: 100%;
      margin-bottom: .5rem;
    }

    /* Step ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .step-nav-btn {
      display: flex;
      align-items: center;
      gap: .5rem;
      width: 100%;
      padding: .5rem .6rem;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 8px;
      color: rgba(255,255,255,0.7);
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }
    .step-nav-btn:hover {
      background: rgba(255,255,255,0.2);
      color: white;
      transform: translateX(3px);
    }
    .step-nav-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }
    .step-nav-btn.completed {
      background: rgba(16, 185, 129, 0.3);
      color: #10b981;
    }
    .step-nav-btn .step-num {
      width: 20px;
      height: 20px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .7rem;
      font-weight: 700;
    }
    .step-nav-btn.active .step-num {
      background: white;
      color: #667eea;
    }
    .step-nav-btn.completed .step-num {
      background: #10b981;
      color: white;
    }
    .step-nav-btn .step-name {
      flex: 1;
      font-size: .8rem;
      font-weight: 500;
    }
    .step-nav-btn .step-status {
      font-size: .6rem;
      opacity: 0.7;
    }
    .step-nav-btn.completed .step-status {
      color: #10b981;
      opacity: 1;
    }

    .style-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .4rem .6rem;
      margin-bottom: .3rem;
      background: #f8f9fa;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .style-item:hover { background: #e9ecef; }
    .style-item.active {
      background: #f0e6ff;
      border: 2px solid #667eea;
    }
    .style-desc {
      font-size: .75rem;
      color: #666;
      margin-top: .2rem;
    }

    .toggle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .status-bar {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: .4rem .7rem;
      font-size: .8rem;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
      display: none;
      text-align: center;
      margin: 0 auto;
      max-width: 400px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .modal-buttons {
      display: flex;
      gap: .5rem;
      margin-top: 1rem;
    }
    .modal-buttons button { flex: 1; }

    .storage-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .4rem .6rem;
      margin-bottom: .3rem;
      background: #f8f9fa;
      border-radius: 6px;
    }

    textarea.autosize { overflow: hidden; }

    /* GPT PRO ê²°ê³¼ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .gpt-pro-result-box {
      background: linear-gradient(135deg, #ff6b9d 0%, #c06c84 100%);
      border: none;
      padding: 1rem;
      border-radius: 8px;
      margin-top: .75rem;
    }
    .gpt-pro-result-box .label {
      color: white;
      font-size: 1.1rem;
      margin-bottom: .5rem;
    }
    .gpt-pro-result-box textarea {
      background: white;
      border: none;
      border-radius: 6px;
      padding: .75rem;
      min-height: 300px;
    }

    /* ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
    .top-buttons-container {
      display: flex;
      gap: .75rem;
    }
    .top-buttons-container .box {
      flex: 1;
      padding: 1rem;
      border: none;
    }
    .copy-all-box {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }
    .gpt-pro-box {
      background: linear-gradient(135deg, #ff6b9d 0%, #e74c3c 100%);
    }
    .top-buttons-container button {
      background: white;
      font-weight: 600;
      padding: .6rem 1.2rem;
      border: none;
      font-size: .95rem;
      width: 100%;
    }
    .copy-all-box button {
      color: #e74c3c;
    }
    .gpt-pro-box button {
      color: #e74c3c;
    }
    .top-buttons-container .box-title {
      color: white;
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: .3rem;
    }
    .top-buttons-container .box-desc {
      color: rgba(255,255,255,0.9);
      font-size: .85rem;
      margin-bottom: .75rem;
    }

    /* Auth header */
    .auth-header {
      background: white;
      border-bottom: 2px solid #e0e0e0;
      padding: .75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .auth-header h1 {
      font-size: 1.2rem;
      margin: 0;
      color: #333;
    }
    .auth-links {
      display: flex;
      gap: .75rem;
      align-items: center;
    }
    .auth-links .user-info {
      font-size: .9rem;
      color: #555;
      font-weight: 500;
    }
    .auth-links a {
      padding: .4rem .8rem;
      text-decoration: none;
      border-radius: 6px;
      font-size: .85rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    .auth-links .btn-login {
      background: white;
      color: #e74c3c;
      border: 2px solid #e74c3c;
    }
    .auth-links .btn-login:hover {
      background: #e74c3c;
      color: white;
    }
    .auth-links .btn-signup {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border: none;
    }
    .auth-links .btn-signup:hover {
      opacity: 0.9;
    }
    .auth-links .btn-logout {
      background: #e74c3c;
      color: white;
      border: none;
    }
    .auth-links .btn-logout:hover {
      background: #c0392b;
    }
    .auth-links .btn-home {
      background: #95a5a6;
      color: white;
      border: none;
    }
    .auth-links .btn-home:hover {
      background: #7f8c8d;
    }

    /* ë²¤ì¹˜ë§ˆí‚¹ ëŒ€ë³¸ ë°•ìŠ¤ - ê³ ì • ë†’ì´ */
    #benchmark-script {
      height: 80px;
      max-height: 80px;
      min-height: 80px;
      resize: none;
    }

    /* ì¤‘ì•™ ë¡œë”© ì¸ë””ì¼€ì´í„° */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    .loading-overlay.show {
      display: flex;
    }
    .loading-content {
      background: white;
      border-radius: 16px;
      padding: 2rem 3rem;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #e74c3c;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-text {
      font-size: 1.2rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 0.5rem;
    }
    .loading-subtext {
      font-size: 0.9rem;
      color: #666;
    }

    /* Step1/Step2/Step3 ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .workflow-box.step1 {
      border: 2px solid #e74c3c;
      background: #fff5f5;
    }
    .workflow-box.step2 {
      border: 2px solid #9b59b6;
      background: #f8f5ff;
    }
    .workflow-box.step3 {
      border: 2px solid #f39c12;
      background: #fffbf0;
    }
    .step-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }
    .step-badge.step1 {
      background: #e74c3c;
      color: white;
    }
    .step-badge.step2 {
      background: #9b59b6;
      color: white;
    }
    .step-badge.step3 {
      background: #f39c12;
      color: white;
    }
    /* Step3 ê²°ê³¼ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .step3-result-box {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      border: none;
      padding: 1rem;
      border-radius: 12px;
      margin-top: .75rem;
    }
    .step3-result-box .label {
      color: white;
      font-size: 1.1rem;
      margin-bottom: .5rem;
    }
    .step3-result-box textarea {
      background: white;
      border: none;
      border-radius: 6px;
      padding: .75rem;
      min-height: 300px;
    }

    /* Step4 ì´ë¯¸ì§€ ìƒì„± ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .step4-container {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      border: none;
      padding: 1rem;
      border-radius: 12px;
      margin-top: .75rem;
    }
    .step4-container .label {
      color: white;
      font-size: 1.1rem;
      font-weight: 700;
    }
    .step4-prompt-section {
      background: white;
      border-radius: 8px;
      padding: .75rem;
      margin-bottom: .75rem;
    }
    .step4-prompt-section .prompt-label {
      font-weight: 600;
      font-size: .9rem;
      margin-bottom: .4rem;
      color: #333;
    }
    .step4-prompt-section textarea {
      width: 100%;
      min-height: 80px;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: .5rem;
      font-size: .85rem;
      resize: vertical;
    }
    .step4-image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: .75rem;
    }
    .step4-image-item {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,.1);
    }
    .step4-image-item img {
      width: 100%;
      height: auto;
      display: block;
    }
    .step4-image-item .image-caption {
      padding: .5rem;
      font-size: .75rem;
      color: #666;
      text-align: center;
    }
    .step4-btn {
      background: white;
      color: #11998e;
      border: none;
      padding: .5rem 1rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: .85rem;
      transition: all 0.2s;
    }
    .step4-btn:hover {
      background: #f0f0f0;
      transform: translateY(-1px);
    }
    .step4-btn.generating {
      opacity: 0.7;
      cursor: not-allowed;
    }

    /* Step5 TTS ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .step5-container {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      padding: 1rem;
      border-radius: 12px;
      margin-top: .75rem;
    }
    .step5-container .label {
      color: white;
      font-size: 1.1rem;
      font-weight: 700;
    }
    .step5-section {
      background: white;
      border-radius: 8px;
      padding: .75rem;
      margin-bottom: .75rem;
    }
    .step5-section .section-label {
      font-weight: 600;
      font-size: .9rem;
      margin-bottom: .4rem;
      color: #333;
    }
    .step5-btn {
      background: white;
      color: #667eea;
      border: none;
      padding: .5rem 1rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: .85rem;
      transition: all 0.2s;
    }
    .step5-btn:hover {
      background: #f0f0f0;
      transform: translateY(-1px);
    }
    .step5-btn.generating {
      opacity: 0.7;
      cursor: not-allowed;
    }
    .step5-audio-player {
      width: 100%;
      margin-top: .5rem;
    }
    .step5-subtitle-preview {
      background: #1a1a2e;
      color: #fff;
      padding: 1rem;
      border-radius: 8px;
      font-family: monospace;
      font-size: .85rem;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .step5-voice-select {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: .5rem;
    }
    .step5-voice-option {
      padding: .5rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
      font-size: .8rem;
    }
    .step5-voice-option:hover {
      border-color: #667eea;
      background: #f8f5ff;
    }
    .step5-voice-option.selected {
      border-color: #667eea;
      background: #667eea;
      color: white;
    }
    .step5-voice-option.selected .voice-preview-btn {
      background: rgba(255,255,255,0.3);
      color: white;
    }
    .voice-preview-btn {
      padding: .25rem .5rem;
      border: none;
      border-radius: 4px;
      background: #f0f0f0;
      cursor: pointer;
      font-size: .8rem;
      transition: all 0.2s;
    }
    .voice-preview-btn:hover {
      background: #667eea;
      color: white;
      transform: scale(1.1);
    }
    .voice-preview-btn.loading {
      opacity: 0.5;
      pointer-events: none;
    }

    /* Step6 ì˜ìƒ ì œì‘ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .step6-container {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      border: none;
      padding: 1rem;
      border-radius: 12px;
      margin-top: .75rem;
    }
    .step6-container .label {
      color: white;
      font-size: 1.1rem;
      font-weight: 700;
    }
    .step6-section {
      background: white;
      border-radius: 8px;
      padding: .75rem;
      margin-bottom: .75rem;
    }
    .step6-section .section-label {
      font-weight: 600;
      font-size: .9rem;
      margin-bottom: .4rem;
      color: #333;
    }
    .step6-btn {
      background: white;
      color: #e74c3c;
      border: none;
      padding: .5rem 1rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: .85rem;
      transition: all 0.2s;
    }
    .step6-btn:hover {
      background: #f0f0f0;
      transform: translateY(-1px);
    }
    .step6-btn.generating {
      opacity: 0.7;
      cursor: not-allowed;
    }
    .step6-preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: .5rem;
      margin-top: .5rem;
    }
    .step6-preview-item {
      position: relative;
      border-radius: 6px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }
    .step6-preview-item:hover {
      border-color: #e74c3c;
    }
    .step6-preview-item.selected {
      border-color: #e74c3c;
      box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
    }
    .step6-preview-item img {
      width: 100%;
      height: 80px;
      object-fit: cover;
    }
    .step6-video-preview {
      background: #1a1a2e;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }
    .step6-video-preview video {
      max-width: 100%;
      max-height: 400px;
      border-radius: 6px;
    }

    /* Step7 ìœ íŠœë¸Œ ì—…ë¡œë“œ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .step7-container {
      display: block !important;
      background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
      border: none;
      padding: 1rem;
      border-radius: 12px;
      margin-top: .75rem;
    }
    .step7-container .label {
      color: white;
      font-size: 1.1rem;
      font-weight: 700;
    }
    .step7-section {
      background: white;
      border-radius: 8px;
      padding: .75rem;
      margin-bottom: .75rem;
    }
    .step7-section .section-label {
      font-weight: 600;
      font-size: .9rem;
      margin-bottom: .4rem;
      color: #333;
    }
    .step7-btn {
      background: white;
      color: #ff0000;
      border: none;
      padding: .5rem 1rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: .85rem;
      transition: all 0.2s;
    }
    .step7-btn:hover {
      background: #f0f0f0;
      transform: translateY(-1px);
    }
    .step7-btn.uploading {
      opacity: 0.7;
      cursor: not-allowed;
    }
    .step7-input {
      width: 100%;
      padding: .5rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: .85rem;
      margin-bottom: .5rem;
    }
    .step7-input:focus {
      outline: none;
      border-color: #ff0000;
    }
    .step7-privacy-option {
      display: inline-flex;
      align-items: center;
      gap: .3rem;
      padding: .4rem .8rem;
      border: 2px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-size: .8rem;
      transition: all 0.2s;
      margin-right: .5rem;
    }
    .step7-privacy-option:hover {
      border-color: #ff0000;
    }
    .step7-privacy-option.selected {
      border-color: #ff0000;
      background: #ff0000;
      color: white;
    }

    /* Step ì ‘ê¸°/í¼ì¹˜ê¸° */
    .workflow-box.collapsed .box-content {
      display: none;
    }
    .workflow-box.collapsed {
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <!-- ì¤‘ì•™ ë¡œë”© ì¸ë””ì¼€ì´í„° -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">AI ì‘ì—… ì¤‘</div>
      <div class="loading-subtext">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>
    </div>
  </div>

  <!-- ì§€ì¹¨ ë³´ê¸° ëª¨ë‹¬ -->
  <div id="guidelines-modal" class="modal">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-title" style="display: flex; justify-content: space-between; align-items: center;">
        <span>ğŸ“‹ ëŒ€ë³¸ ì‘ì„± ì§€ì¹¨</span>
        <button onclick="closeGuidelinesModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">&times;</button>
      </div>
      <div id="guidelines-modal-content" style="padding: 1rem 0; white-space: pre-wrap; font-size: 0.9rem; line-height: 1.8;"></div>
      <div class="modal-buttons">
        <button onclick="closeGuidelinesModal()" class="primary">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- JSON ë·°ì–´ ëª¨ë‹¬ -->
  <div id="json-viewer-modal" class="modal">
    <div class="modal-content" style="max-width: 95vw; max-height: 95vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-title" style="display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
        <span>ğŸ” í˜„ì¬ ì ìš© ì¤‘ì¸ JSON ë°ì´í„°</span>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <button onclick="refreshJsonViewer()" style="padding: 0.3rem 0.8rem; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
          <button onclick="closeJsonViewerModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">&times;</button>
        </div>
      </div>
      <div style="display: flex; gap: 0.5rem; margin: 0.5rem 0; flex-shrink: 0;">
        <button onclick="showJsonTab('session')" id="json-tab-session" class="json-tab active" style="flex: 1; padding: 0.5rem; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">ğŸ“¦ ì„¸ì…˜ ë°ì´í„°</button>
        <button onclick="showJsonTab('guidelines')" id="json-tab-guidelines" class="json-tab" style="flex: 1; padding: 0.5rem; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">ğŸ“‹ ì§€ì¹¨ (style_guide)</button>
        <button onclick="showJsonTab('structure')" id="json-tab-structure" class="json-tab" style="flex: 1; padding: 0.5rem; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">ğŸ—ï¸ ëŒ€ë³¸ êµ¬ì¡°</button>
      </div>
      <div id="json-viewer-content" style="flex: 1; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85rem; white-space: pre-wrap;"></div>
      <div class="modal-buttons" style="flex-shrink: 0; margin-top: 0.5rem;">
        <button onclick="copyJsonContent()" style="flex: 1; background: #2196F3;">ğŸ“‹ ë³µì‚¬</button>
        <button onclick="closeJsonViewerModal()" class="primary" style="flex: 1;">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Auth Header -->
  <div class="auth-header">
    <h1>ğŸ­ ë“œë¼ë§ˆ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± ë„êµ¬</h1>
    <div class="auth-links">
      <a href="/" class="btn-home">í™ˆ</a>
      {% if session.user_id %}
        <span class="user-info">{{ session.user_name }}ë‹˜</span>
        <a href="/logout" class="btn-logout">ë¡œê·¸ì•„ì›ƒ</a>
      {% else %}
        <a href="/login" class="btn-login">ë¡œê·¸ì¸</a>
        <a href="/signup" class="btn-signup">íšŒì›ê°€ì…</a>
      {% endif %}
    </div>
  </div>

  <!-- ì „ì²´ ì§„í–‰ ìƒí™© Progress Bar -->
  <div id="workflow-progress" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: .6rem 1.5rem; display: flex; align-items: center; gap: 1rem;">
    <div style="color: white; font-weight: 600; font-size: .85rem; white-space: nowrap;">ì§„í–‰ ìƒí™©:</div>
    <div style="flex: 1; display: flex; gap: .3rem; align-items: center;">
      <div class="progress-step" data-step="step1" style="flex: 1; text-align: center;">
        <div style="background: rgba(255,255,255,0.3); border-radius: 4px; padding: .25rem .4rem; font-size: .7rem; color: white; cursor: default;" title="Step1: ìƒí™© ì œì‹œ">1</div>
      </div>
      <div style="color: rgba(255,255,255,0.5);">â†’</div>
      <div class="progress-step" data-step="step2" style="flex: 1; text-align: center;">
        <div style="background: rgba(255,255,255,0.3); border-radius: 4px; padding: .25rem .4rem; font-size: .7rem; color: white; cursor: default;" title="Step2: ëŒ€ì‚¬+ì§€ë¬¸">2</div>
      </div>
      <div style="color: rgba(255,255,255,0.5);">â†’</div>
      <div class="progress-step" data-step="step3" style="flex: 1; text-align: center;">
        <div style="background: rgba(255,255,255,0.3); border-radius: 4px; padding: .25rem .4rem; font-size: .7rem; color: white; cursor: default;" title="Step3: ëŒ€ë³¸ ì™„ì„±">3</div>
      </div>
      <div style="color: rgba(255,255,255,0.5);">â†’</div>
      <div class="progress-step" data-step="step4" style="flex: 1; text-align: center;">
        <div style="background: rgba(255,255,255,0.3); border-radius: 4px; padding: .25rem .4rem; font-size: .7rem; color: white; cursor: default;" title="Step4: ì´ë¯¸ì§€ ìƒì„±">4</div>
      </div>
      <div style="color: rgba(255,255,255,0.5);">+</div>
      <div class="progress-step" data-step="step5" style="flex: 1; text-align: center;">
        <div style="background: rgba(255,255,255,0.3); border-radius: 4px; padding: .25rem .4rem; font-size: .7rem; color: white; cursor: default;" title="Step5: ìŒì„±+ìë§‰">5</div>
      </div>
      <div style="color: rgba(255,255,255,0.5);">â†’</div>
      <div class="progress-step" data-step="step6" style="flex: 1; text-align: center;">
        <div style="background: rgba(255,255,255,0.3); border-radius: 4px; padding: .25rem .4rem; font-size: .7rem; color: white; cursor: default;" title="Step6: ì˜ìƒ ì œì‘">6</div>
      </div>
      <div style="color: rgba(255,255,255,0.5);">â†’</div>
      <div class="progress-step" data-step="step7" style="flex: 1; text-align: center;">
        <div style="background: rgba(255,255,255,0.3); border-radius: 4px; padding: .25rem .4rem; font-size: .7rem; color: white; cursor: default;" title="Step7: YouTube ì—…ë¡œë“œ">7</div>
      </div>
    </div>
    <div id="progress-status" style="color: rgba(255,255,255,0.9); font-size: .75rem; white-space: nowrap;">Step1ë¶€í„° ì‹œì‘í•˜ì„¸ìš”</div>
  </div>

  <div class="page-wrap">
    <!-- ì™¼ìª½ -->
    <div class="left-col">
      <!-- Step ë„¤ë¹„ê²Œì´ì…˜ -->
      <div class="step-nav" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 12px; padding: .75rem; margin-bottom: .5rem;">
        <div style="color: white; font-weight: 700; font-size: .9rem; margin-bottom: .75rem; text-align: center;">ğŸ“ ì›Œí¬í”Œë¡œìš°</div>
        <div class="step-nav-items" style="display: flex; flex-direction: column; gap: .4rem;">
          <button class="step-nav-btn active" data-step="step1" onclick="scrollToStep('step1-container')">
            <span class="step-num">1</span>
            <span class="step-name">ì£¼ì œ ì„ ì •</span>
            <span class="step-status">â—</span>
          </button>
          <button class="step-nav-btn" data-step="step2" onclick="scrollToStep('step2-container')">
            <span class="step-num">2</span>
            <span class="step-name">ìë£Œ ì¡°ì‚¬</span>
            <span class="step-status">â—‹</span>
          </button>
          <button class="step-nav-btn" data-step="step3" onclick="scrollToStep('step3-container')">
            <span class="step-num">3</span>
            <span class="step-name">ëŒ€ë³¸ ì‘ì„±</span>
            <span class="step-status">â—‹</span>
          </button>
          <button class="step-nav-btn" data-step="step4" onclick="scrollToStep('step4-container')">
            <span class="step-num">4</span>
            <span class="step-name">ì´ë¯¸ì§€ ìƒì„±</span>
            <span class="step-status">â—‹</span>
          </button>
          <button class="step-nav-btn" data-step="step5" onclick="scrollToStep('step5-container')">
            <span class="step-num">5</span>
            <span class="step-name">ìŒì„± í•©ì„±</span>
            <span class="step-status">â—‹</span>
          </button>
          <button class="step-nav-btn" data-step="step6" onclick="scrollToStep('step6-container')">
            <span class="step-num">6</span>
            <span class="step-name">ì˜ìƒ ì œì‘</span>
            <span class="step-status">â—‹</span>
          </button>
          <button class="step-nav-btn" data-step="step7" onclick="scrollToStep('step7-container')">
            <span class="step-num">7</span>
            <span class="step-name">ì—…ë¡œë“œ</span>
            <span class="step-status">â—‹</span>
          </button>
        </div>
      </div>

      <!-- ë‚ ì§œ + ì˜ìƒ ì‹œê°„ + ì½˜í…ì¸  ìœ í˜• -->
      <div class="box" style="padding: .5rem .75rem;">
        <div style="display: flex; gap: .5rem; align-items: center;">
          <div style="flex: 1;">
            <label class="label" style="font-size: .8rem; margin-bottom: .2rem; display: block;">ë‚ ì§œ</label>
            <input type="date" id="drama-date" style="padding: .25rem .4rem; font-size: .85rem;">
          </div>
          <div style="flex: 1;">
            <label class="label" style="font-size: .8rem; margin-bottom: .2rem; display: block;">ì˜ìƒ ì‹œê°„</label>
            <select id="drama-category" style="padding: .25rem .4rem; font-size: .85rem;"></select>
          </div>
          <div style="flex: 1;">
            <label class="label" style="font-size: .8rem; margin-bottom: .2rem; display: block;">ì½˜í…ì¸  ìœ í˜•</label>
            <select id="content-type" style="padding: .25rem .4rem; font-size: .85rem;">
              <option value="testimony">ê°„ì¦</option>
              <option value="drama">ë“œë¼ë§ˆ</option>
            </select>
          </div>
        </div>
        <!-- í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸° í† ê¸€ -->
        <div style="margin-top: .5rem;">
          <button id="btn-toggle-prompt-preview" style="width: 100%; padding: .3rem; font-size: .75rem; background: #f8f9fa; color: #666; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
            ğŸ“ Step3 í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸° â–¼
          </button>
          <div id="prompt-preview-container" style="display: none; margin-top: .4rem; padding: .5rem; background: #f8f9fa; border-radius: 6px; max-height: 200px; overflow-y: auto;">
            <div style="font-size: .7rem; color: #333; white-space: pre-wrap; line-height: 1.4;" id="prompt-preview-content">
              ì½˜í…ì¸  ìœ í˜•ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ í”„ë¡¬í”„íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </div>

      <!-- ì£¼ì¸ê³µ ì„ íƒ -->
      <div class="box" style="padding: .5rem .75rem;">
        <label class="label" style="font-size: .8rem; margin-bottom: .3rem; display: block;">ì£¼ì¸ê³µ (ì„ íƒì‚¬í•­)</label>
        <div style="display: flex; gap: .4rem; align-items: center;">
          <input type="text" id="main-character" placeholder="ì˜ˆ: 30ëŒ€ ë‚¨ì„± ëª©ì‚¬, ì²­ë…„ ëŒ€í•™ìƒ ë“±" style="flex: 1; font-size: .85rem; padding: .3rem .4rem;">
          <button id="btn-random-character" style="padding: .3rem .6rem; font-size: .75rem; background: #9b59b6; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;">ğŸ² ëœë¤</button>
        </div>
        <div style="font-size: .7rem; color: #666; margin-top: .3rem;">
          ë¹„ì›Œë‘ë©´ AIê°€ ìë™ìœ¼ë¡œ ì ì ˆí•œ ì£¼ì¸ê³µì„ ì„¤ì •í•©ë‹ˆë‹¤.
        </div>
      </div>

      <!-- ë²¤ì¹˜ë§ˆí‚¹ ëŒ€ë³¸ (ì¶•ì†Œ) -->
      <div class="box">
        <label class="label" style="font-size: .9rem;">ë²¤ì¹˜ë§ˆí‚¹ ëŒ€ë³¸</label>
        <textarea id="benchmark-script" placeholder="ì°¸ê³ í•  ëŒ€ë³¸ì´ë‚˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”." style="height: 80px; resize: none; font-size: .85rem;"></textarea>
      </div>

      <!-- AI ëŒ€ë³¸ ë¶„ì„ -->
      <div class="box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: .5rem;">
        <div style="color: white; font-weight: 600; font-size: .85rem; margin-bottom: .4rem;">ğŸ“Š AI ëŒ€ë³¸ ë¶„ì„</div>
        <div style="background: white; border-radius: 6px; padding: .4rem; margin-bottom: .4rem;">
          <div style="display: flex; gap: .3rem; margin-bottom: .3rem;">
            <input type="text" id="benchmark-upload-date" placeholder="ë‚ ì§œ" style="flex: 1; font-size: .7rem; padding: .25rem;">
            <input type="text" id="benchmark-view-count" placeholder="ì¡°íšŒìˆ˜" style="flex: 1; font-size: .7rem; padding: .25rem;">
          </div>
          <label style="display: flex; align-items: center; gap: .2rem; margin-bottom: .3rem; cursor: pointer;">
            <input type="checkbox" id="check-duplicates" style="cursor: pointer;">
            <span style="font-size: .7rem; color: #666;">ì¤‘ë³µ ìë£Œ</span>
          </label>
          <button id="btn-analyze-benchmark" class="primary" style="width: 100%; font-size: .75rem; padding: .3rem;">ë¶„ì„</button>
        </div>
        <div style="background: white; border-radius: 6px; padding: .4rem; max-height: 60px; overflow-y: auto;">
          <div id="analysis-result" style="font-size: .7rem; color: #333; line-height: 1.3;">
            <p style="color: #999; text-align: center; font-size: .65rem;">
              ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
            </p>
          </div>
        </div>
        <button id="btn-view-accumulated-guide" style="width: 100%; margin-top: .4rem; background: white; color: #667eea; font-weight: 600; font-size: .7rem; padding: .3rem; border-radius: 6px; border: none; cursor: pointer;">ğŸ“š ê°€ì´ë“œ ë³´ê¸°</button>
      </div>

      <!-- ì €ì¥ ê³µê°„ -->
      <div class="box">
        <label class="label" style="font-size: .9rem;">ì €ì¥ëœ ë“œë¼ë§ˆ ìë£Œ</label>
        <button id="btn-save" style="width: 100%; margin-bottom: .5rem; font-size: .85rem; padding: .4rem;">í˜„ì¬ ë‚´ìš© ì €ì¥</button>
        <div id="saved-list"></div>
      </div>
    </div>

    <!-- ê°€ìš´ë° - ì›Œí¬í”Œë¡œìš° ì˜ì—­ -->
    <div class="content-area">
      <!-- Step1 ì•µì»¤ ë° ì»¨íŠ¸ë¡¤ -->
      <div id="step1-container"></div>
      <div style="display: flex; gap: .3rem; margin-bottom: .5rem; align-items: center;">
        <button id="btn-add-step1-box" style="flex: 1; padding: .35rem .5rem; font-size: .75rem; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">â• ë°•ìŠ¤ì¶”ê°€</button>
        <button id="btn-auto-execute-step1" style="flex: 1; padding: .35rem .5rem; font-size: .75rem; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">âš¡ ìˆœì°¨ì‹¤í–‰</button>
        <button id="btn-copy-step1-results" style="flex: 1; padding: .35rem .5rem; font-size: .75rem; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">ğŸ“‹ ë³µì‚¬</button>
        <button id="btn-toggle-step1" style="flex: 1; padding: .35rem .5rem; font-size: .75rem; background: #fff; color: #ff6b6b; border: 2px solid #ff6b6b; border-radius: 6px; cursor: pointer; font-weight: 600;">ğŸ”½ ì ‘ê¸°/í¼ì¹˜ê¸°</button>
        <span style="font-size: .7rem; color: #ff6b6b; font-weight: 700; min-width: 40px;">Step1</span>
      </div>

      <!-- Step2 ì•µì»¤ ë° ì»¨íŠ¸ë¡¤ -->
      <div id="step2-container"></div>
      <div style="display: flex; gap: .3rem; margin-bottom: .5rem; align-items: center;">
        <button id="btn-add-step2-box" style="flex: 1; padding: .35rem .5rem; font-size: .75rem; background: linear-gradient(135deg, #4ecdc4 0%, #44a3c2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">â• ë°•ìŠ¤ì¶”ê°€</button>
        <button id="btn-auto-execute-step2" style="flex: 1; padding: .35rem .5rem; font-size: .75rem; background: linear-gradient(135deg, #4ecdc4 0%, #44a3c2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">âš¡ ìˆœì°¨ì‹¤í–‰</button>
        <button id="btn-copy-step2-results" style="flex: 1; padding: .35rem .5rem; font-size: .75rem; background: linear-gradient(135deg, #4ecdc4 0%, #44a3c2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">ğŸ“‹ ë³µì‚¬</button>
        <button id="btn-toggle-step2" style="flex: 1; padding: .35rem .5rem; font-size: .75rem; background: #fff; color: #4ecdc4; border: 2px solid #4ecdc4; border-radius: 6px; cursor: pointer; font-weight: 600;">ğŸ”½ ì ‘ê¸°/í¼ì¹˜ê¸°</button>
        <span style="font-size: .7rem; color: #4ecdc4; font-weight: 700; min-width: 40px;">Step2</span>
      </div>

      <!-- Step3 ì•µì»¤ ë° ì „ì²´ ìˆœì°¨ì‹¤í–‰ -->
      <div id="step3-container"></div>
      <div style="display: flex; gap: .3rem; margin-bottom: .75rem; align-items: center;">
        <button id="btn-auto-execute-all" style="flex: 1; padding: .35rem .5rem; font-size: .75rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">âš¡ ì „ì²´ ìˆœì°¨ì‹¤í–‰</button>
        <button id="btn-execute-step3" style="flex: 2; padding: .35rem .5rem; font-size: .75rem; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">ğŸ¬ Step3: OpenRouter ëŒ€ë³¸ì™„ì„±</button>
        <button id="btn-view-guidelines" style="flex: 1; padding: .35rem .5rem; font-size: .75rem; background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">ğŸ“‹ ì§€ì¹¨ ë³´ê¸°</button>
        <button id="btn-view-json" style="flex: 1; padding: .35rem .5rem; font-size: .75rem; background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">ğŸ” JSON ë³´ê¸°</button>
      </div>

      <!-- ìƒíƒœ í‘œì‹œ -->
      <div id="status-bar" class="status-bar">ì‘ì—… ì¤‘...</div>

      <!-- ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë˜ëŠ” ì˜ì—­ -->
      <div id="workflow-boxes-container"></div>

      <!-- Step3 ê²°ê³¼ ë°•ìŠ¤ -->
      <div id="step3-result-container" class="step3-result-box" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
          <div class="label">ğŸ¬ Step3: OpenRouter ëŒ€ë³¸ ì™„ì„± ê²°ê³¼</div>
          <div style="display: flex; gap: .5rem;">
            <button id="btn-copy-step3-result" style="padding: .4rem .8rem; background: white; color: #f39c12; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: .85rem;">ğŸ“‹ ë³µì‚¬</button>
            <button id="btn-clear-step3-result" style="padding: .4rem .8rem; background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: .85rem;">ğŸ—‘ï¸ ì§€ìš°ê¸°</button>
          </div>
        </div>
        <div id="step3-token-info" style="font-size: .75rem; color: rgba(255,255,255,0.9); margin-bottom: .5rem; display: none;">
          ğŸ“¥ <span id="step3-input-tokens">0</span> (ì…ë ¥) / ğŸ“¤ <span id="step3-output-tokens">0</span> (ì¶œë ¥) | ğŸ’° <span id="step3-cost">â‚©0</span>
        </div>
        <textarea id="step3-result" readonly style="width: 100%; font-size: .9rem; line-height: 1.6; resize: vertical;" placeholder="Step3 ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
      </div>

      <!-- Step4: ì´ë¯¸ì§€ ìƒì„± -->
      <div id="step4-container" class="step4-container" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .75rem;">
          <div class="label">ğŸ¨ Step4: ì¥ë©´ ì´ë¯¸ì§€ ìƒì„±</div>
          <div style="display: flex; gap: .5rem;">
            <button id="btn-clear-step4" class="step4-btn" style="background: rgba(255,255,255,0.3); color: white;">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
          </div>
        </div>

        <!-- 1ë‹¨ê³„: ì¸ë¬¼ ë¶„ì„ -->
        <div class="step4-prompt-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
            <div class="prompt-label">ğŸ‘¥ 1ë‹¨ê³„: ë“±ì¥ì¸ë¬¼ ë¶„ì„</div>
            <button id="btn-analyze-characters" class="step4-btn" style="padding: .4rem .8rem; font-size: .85rem;">ğŸ” ëŒ€ë³¸ì—ì„œ ì¸ë¬¼ ì¶”ì¶œ</button>
          </div>
          <div id="step4-characters-list" style="background: rgba(255,255,255,0.95); border-radius: 8px; padding: .75rem; min-height: 60px;">
            <div style="color: #999; text-align: center; font-size: .85rem;">ëŒ€ë³¸ì„ ë¶„ì„í•˜ë©´ ë“±ì¥ì¸ë¬¼ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
          </div>
        </div>

        <!-- 2ë‹¨ê³„: ì¸ë¬¼ ì´ë¯¸ì§€ ìƒì„± -->
        <div class="step4-prompt-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
            <div class="prompt-label">ğŸ‘¤ 2ë‹¨ê³„: ì¸ë¬¼ ì´ë¯¸ì§€ ìƒì„±</div>
            <div style="display: flex; gap: .5rem; align-items: center;">
              <select id="step4-character-select" style="padding: .4rem; border-radius: 6px; border: 1px solid #ddd; font-size: .85rem; min-width: 120px;">
                <option value="">-- ì¸ë¬¼ ì„ íƒ --</option>
              </select>
              <button id="btn-generate-character-image" class="step4-btn" style="padding: .4rem .8rem; font-size: .85rem;">ğŸ–¼ï¸ ì¸ë¬¼ ì´ë¯¸ì§€ ìƒì„±</button>
            </div>
          </div>
          <textarea id="step4-character-prompt" placeholder="ì„ íƒí•œ ì¸ë¬¼ì˜ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. ì§ì ‘ ìˆ˜ì •ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤."></textarea>
          <div id="step4-character-images" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: .5rem; margin-top: .5rem;"></div>
        </div>

        <!-- 3ë‹¨ê³„: ì”¬ ì´ë¯¸ì§€ ìƒì„± -->
        <div class="step4-prompt-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
            <div class="prompt-label">ğŸ¬ 3ë‹¨ê³„: ì”¬ ì´ë¯¸ì§€ ìƒì„±</div>
            <div style="display: flex; gap: .5rem; align-items: center; flex-wrap: wrap;">
              <select id="step4-scene-select" style="padding: .4rem; border-radius: 6px; border: 1px solid #ddd; font-size: .85rem; min-width: 120px;">
                <option value="">-- ì”¬ ì„ íƒ --</option>
              </select>
              <button id="btn-generate-scene-prompt" class="step4-btn" style="padding: .4rem .8rem; font-size: .85rem;">ğŸ“ í”„ë¡¬í”„íŠ¸ë§Œ</button>
              <button id="btn-generate-scene-all" class="step4-btn" style="padding: .4rem .8rem; font-size: .85rem; background: linear-gradient(135deg, #10b981, #059669); font-weight: 700;">ğŸ¬ í”„ë¡¬í”„íŠ¸+ì´ë¯¸ì§€</button>
            </div>
          </div>

          <div style="margin-bottom: .5rem;">
            <div style="font-size: .8rem; color: rgba(255,255,255,0.9); margin-bottom: .25rem;">ğŸï¸ ë°°ê²½ í”„ë¡¬í”„íŠ¸</div>
            <textarea id="step4-background-prompt" placeholder="ì”¬ì˜ ë°°ê²½ í”„ë¡¬í”„íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>
          </div>

          <div style="margin-bottom: .5rem;">
            <div style="font-size: .8rem; color: rgba(255,255,255,0.9); margin-bottom: .25rem;">ğŸ‘¥ ë“±ì¥ ì¸ë¬¼ (ì”¬ì— í¬í•¨ë  ì¸ë¬¼ ì„ íƒ)</div>
            <div id="step4-scene-characters" style="display: flex; flex-wrap: wrap; gap: .5rem; background: rgba(255,255,255,0.1); padding: .5rem; border-radius: 6px; min-height: 40px;">
              <span style="color: rgba(255,255,255,0.6); font-size: .85rem;">ì¸ë¬¼ ë¶„ì„ í›„ ì„ íƒ ê°€ëŠ¥</span>
            </div>
          </div>

          <div>
            <div style="font-size: .8rem; color: rgba(255,255,255,0.9); margin-bottom: .25rem;">ğŸ­ í†µí•© ì”¬ í”„ë¡¬í”„íŠ¸ (ì¸ë¬¼ + ë°°ê²½)</div>
            <textarea id="step4-combined-prompt" placeholder="ì¸ë¬¼ë“¤ì´ ë°°ê²½ì— ìì—°ìŠ¤ëŸ½ê²Œ ì–´ìš¸ë¦¬ëŠ” í†µí•© ì¥ë©´ í”„ë¡¬í”„íŠ¸ì…ë‹ˆë‹¤."></textarea>
          </div>
        </div>

        <!-- ì´ë¯¸ì§€ ëª¨ë¸ ì„ íƒ -->
        <div style="display: flex; gap: .5rem; margin-bottom: .5rem;">
          <button class="step4-image-provider selected" data-provider="flux" style="flex: 1; padding: .5rem; border: 2px solid #10b981; border-radius: 8px; background: rgba(16,185,129,0.2); cursor: pointer; font-weight: 600; font-size: .85rem;">
            âš¡ FLUX.1 Pro<br><span style="font-size: .7rem; font-weight: normal; color: #666;">$0.055/ì¥ (ê³ í’ˆì§ˆ)</span>
          </button>
          <button class="step4-image-provider" data-provider="dalle" style="flex: 1; padding: .5rem; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-weight: 600; font-size: .85rem;">
            ğŸ¨ DALL-E 3<br><span style="font-size: .7rem; font-weight: normal; color: #666;">$0.08/ì¥ (ì°½ì˜ì )</span>
          </button>
        </div>

        <!-- ì´ë¯¸ì§€ ìƒì„± ë²„íŠ¼ ì˜ì—­ -->
        <div style="display: flex; gap: .5rem; margin-bottom: .75rem;">
          <button id="btn-generate-image" class="step4-btn" style="flex: 1; padding: .75rem; font-size: .95rem; font-weight: 700;">
            ğŸ–¼ï¸ ì”¬ ì´ë¯¸ì§€ ìƒì„± (FLUX.1 Pro)
          </button>
          <select id="step4-image-size" style="padding: .5rem; border-radius: 6px; border: 1px solid #ddd; font-size: .85rem;">
            <option value="1024x1024">1024x1024 (ì •ì‚¬ê°í˜•)</option>
            <option value="1792x1024" selected>1792x1024 (ê°€ë¡œí˜•)</option>
            <option value="1024x1792">1024x1792 (ì„¸ë¡œí˜•)</option>
          </select>
        </div>

        <!-- ìƒì„±ëœ ì´ë¯¸ì§€ í‘œì‹œ ì˜ì—­ -->
        <div id="step4-image-result" style="background: white; border-radius: 8px; padding: .75rem; min-height: 100px;">
          <div id="step4-image-placeholder" style="text-align: center; color: #999; padding: 2rem;">
            <div style="font-size: 2rem; margin-bottom: .5rem;">ğŸ–¼ï¸</div>
            <p>ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
          </div>
          <div id="step4-image-grid" class="step4-image-grid" style="display: none;"></div>
        </div>

        <!-- í† í°/ë¹„ìš© ì •ë³´ -->
        <div id="step4-cost-info" style="font-size: .75rem; color: rgba(255,255,255,0.9); margin-top: .5rem; display: none;">
          ğŸ–¼ï¸ ì´ë¯¸ì§€ ìƒì„± ë¹„ìš©: <span id="step4-image-cost">â‚©0</span>
        </div>
      </div>

      <!-- Step5: TTS ìŒì„± í•©ì„± ë° ìë§‰ ìƒì„± -->
      <div id="step5-container" class="step5-container" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .75rem;">
          <div class="label">ğŸ™ï¸ Step5: ìŒì„± í•©ì„± (TTS) & ìë§‰</div>
          <div style="display: flex; gap: .5rem;">
            <button id="btn-clear-step5" class="step5-btn" style="background: rgba(255,255,255,0.3); color: white;">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
          </div>
        </div>

        <!-- TTS ì œê³µì ì„ íƒ -->
        <div class="step5-section">
          <div class="section-label">ğŸ”Š TTS ì œê³µì</div>
          <div style="display: flex; gap: .5rem; margin-bottom: .75rem;">
            <button class="step5-tts-provider selected" data-provider="google" style="flex: 1; padding: .5rem; border: 2px solid #10b981; border-radius: 8px; background: rgba(16,185,129,0.2); cursor: pointer; font-weight: 600;">
              ğŸŒ Google Cloud<br><span style="font-size: .7rem; font-weight: normal; color: #666;">â‚©16/3000ì (ì €ë ´)</span>
            </button>
            <button class="step5-tts-provider" data-provider="naver" style="flex: 1; padding: .5rem; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-weight: 600;">
              ğŸ‡°ğŸ‡· ë„¤ì´ë²„ í´ë¡œë°”<br><span style="font-size: .7rem; font-weight: normal; color: #666;">â‚©12,000/3000ì (ê³ í’ˆì§ˆ)</span>
            </button>
          </div>
        </div>

        <!-- ìŒì„± ì„ íƒ ì˜ì—­ -->
        <div class="step5-section">
          <div class="section-label" id="step5-voice-label">ğŸ¤ ìŒì„± ì„ íƒ (Google Cloud) <span style="font-size: .75rem; font-weight: normal; color: rgba(255,255,255,0.7);">- í´ë¦­í•˜ì—¬ ë¯¸ë¦¬ë“£ê¸°</span></div>

          <!-- Google TTS ìŒì„± -->
          <div id="step5-voice-google" class="step5-voice-select">
            <div class="step5-voice-option selected" data-voice="ko-KR-Wavenet-A" data-provider="google">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600;">ì—¬ì„± A</div>
                  <div style="font-size: .7rem; color: #666;">Wavenet (ìì—°ìŠ¤ëŸ¬ì›€)</div>
                </div>
                <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('ko-KR-Wavenet-A', 'google')">â–¶ï¸</button>
              </div>
            </div>
            <div class="step5-voice-option" data-voice="ko-KR-Wavenet-B" data-provider="google">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600;">ì—¬ì„± B</div>
                  <div style="font-size: .7rem; color: #666;">Wavenet</div>
                </div>
                <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('ko-KR-Wavenet-B', 'google')">â–¶ï¸</button>
              </div>
            </div>
            <div class="step5-voice-option" data-voice="ko-KR-Wavenet-C" data-provider="google">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600;">ë‚¨ì„± A</div>
                  <div style="font-size: .7rem; color: #666;">Wavenet</div>
                </div>
                <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('ko-KR-Wavenet-C', 'google')">â–¶ï¸</button>
              </div>
            </div>
            <div class="step5-voice-option" data-voice="ko-KR-Wavenet-D" data-provider="google">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600;">ë‚¨ì„± B</div>
                  <div style="font-size: .7rem; color: #666;">Wavenet</div>
                </div>
                <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('ko-KR-Wavenet-D', 'google')">â–¶ï¸</button>
              </div>
            </div>
            <div class="step5-voice-option" data-voice="ko-KR-Neural2-A" data-provider="google">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600;">ì—¬ì„± (Neural)</div>
                  <div style="font-size: .7rem; color: #666;">Neural2 (ìµœê³ í’ˆì§ˆ)</div>
                </div>
                <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('ko-KR-Neural2-A', 'google')">â–¶ï¸</button>
              </div>
            </div>
            <div class="step5-voice-option" data-voice="ko-KR-Neural2-C" data-provider="google">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600;">ë‚¨ì„± (Neural)</div>
                  <div style="font-size: .7rem; color: #666;">Neural2 (ìµœê³ í’ˆì§ˆ)</div>
                </div>
                <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('ko-KR-Neural2-C', 'google')">â–¶ï¸</button>
              </div>
            </div>
          </div>

          <!-- ë„¤ì´ë²„ TTS ìŒì„± (ìˆ¨ê¹€) -->
          <div id="step5-voice-naver" class="step5-voice-select" style="display: none;">
            <div class="step5-voice-option" data-voice="nara" data-provider="naver">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600;">ë‚˜ë¼</div>
                  <div style="font-size: .7rem; color: #666;">ì—¬ì„± (ê¸°ë³¸)</div>
                </div>
                <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('nara', 'naver')">â–¶ï¸</button>
              </div>
            </div>
            <div class="step5-voice-option" data-voice="nara_call" data-provider="naver">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600;">ë‚˜ë¼ (ë°ìŒ)</div>
                  <div style="font-size: .7rem; color: #666;">ì—¬ì„± (ê²½ì¾Œ)</div>
                </div>
                <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('nara_call', 'naver')">â–¶ï¸</button>
              </div>
            </div>
            <div class="step5-voice-option" data-voice="nminsang" data-provider="naver">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600;">ë¯¼ìƒ</div>
                  <div style="font-size: .7rem; color: #666;">ë‚¨ì„±</div>
                </div>
                <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('nminsang', 'naver')">â–¶ï¸</button>
              </div>
            </div>
            <div class="step5-voice-option" data-voice="njiyun" data-provider="naver">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600;">ì§€ìœ¤</div>
                  <div style="font-size: .7rem; color: #666;">ì—¬ì„± (ë°ìŒ)</div>
                </div>
                <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('njiyun', 'naver')">â–¶ï¸</button>
              </div>
            </div>
            <div class="step5-voice-option" data-voice="nsujin" data-provider="naver">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600;">ìˆ˜ì§„</div>
                  <div style="font-size: .7rem; color: #666;">ì—¬ì„± (ì°¨ë¶„)</div>
                </div>
                <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('nsujin', 'naver')">â–¶ï¸</button>
              </div>
            </div>
            <div class="step5-voice-option" data-voice="jinho" data-provider="naver">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600;">ì§„í˜¸</div>
                  <div style="font-size: .7rem; color: #666;">ë‚¨ì„± (ì°¨ë¶„)</div>
                </div>
                <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('jinho', 'naver')">â–¶ï¸</button>
              </div>
            </div>
          </div>
        </div>

        <!-- TTS ì„¤ì • -->
        <div class="step5-section">
          <div class="section-label">âš™ï¸ ìŒì„± ì„¤ì •</div>
          <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 100px;">
              <label style="font-size: .8rem; color: #666;">ì†ë„</label>
              <input type="range" id="step5-speed" min="-5" max="5" value="0" style="width: 100%;">
              <div style="display: flex; justify-content: space-between; font-size: .7rem; color: #999;">
                <span>ëŠë¦¼</span><span>ë³´í†µ</span><span>ë¹ ë¦„</span>
              </div>
            </div>
            <div style="flex: 1; min-width: 100px;">
              <label style="font-size: .8rem; color: #666;">ìŒë†’ì´</label>
              <input type="range" id="step5-pitch" min="-5" max="5" value="0" style="width: 100%;">
              <div style="display: flex; justify-content: space-between; font-size: .7rem; color: #999;">
                <span>ë‚®ìŒ</span><span>ë³´í†µ</span><span>ë†’ìŒ</span>
              </div>
            </div>
            <div style="flex: 1; min-width: 100px;">
              <label style="font-size: .8rem; color: #666;">ë³¼ë¥¨</label>
              <input type="range" id="step5-volume" min="-5" max="5" value="0" style="width: 100%;">
              <div style="display: flex; justify-content: space-between; font-size: .7rem; color: #999;">
                <span>ì‘ìŒ</span><span>ë³´í†µ</span><span>í¼</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ëŒ€ë³¸ í…ìŠ¤íŠ¸ (TTSìš©) -->
        <div class="step5-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .4rem;">
            <div class="section-label">ğŸ“œ TTSìš© ëŒ€ë³¸ í…ìŠ¤íŠ¸</div>
            <button id="btn-extract-narration" class="step5-btn" style="padding: .3rem .6rem; font-size: .75rem;">ğŸ“ ì§€ë¬¸ë§Œ ì¶”ì¶œ</button>
          </div>
          <textarea id="step5-script-text" style="width: 100%; min-height: 120px; border: 1px solid #ddd; border-radius: 6px; padding: .5rem; font-size: .85rem; resize: vertical;" placeholder="Step3 ëŒ€ë³¸ì—ì„œ TTSë¡œ ì½ì„ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”. 'ì§€ë¬¸ë§Œ ì¶”ì¶œ' ë²„íŠ¼ìœ¼ë¡œ ë‚˜ë ˆì´ì…˜ ë¶€ë¶„ë§Œ ì¶”ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."></textarea>
        </div>

        <!-- TTS ìƒì„± ë²„íŠ¼ -->
        <div style="display: flex; gap: .5rem; margin-bottom: .75rem;">
          <button id="btn-generate-tts" class="step5-btn" style="flex: 1; padding: .75rem; font-size: .95rem; font-weight: 700;">
            ğŸ™ï¸ ìŒì„± ìƒì„± (TTS)
          </button>
          <button id="btn-generate-subtitle" class="step5-btn" style="flex: 1; padding: .75rem; font-size: .95rem; font-weight: 700;">
            ğŸ“ ìë§‰ ìƒì„± (SRT)
          </button>
        </div>

        <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ -->
        <div class="step5-section" id="step5-audio-section" style="display: none;">
          <div class="section-label">ğŸ”Š ìƒì„±ëœ ìŒì„±</div>
          <audio id="step5-audio-player" class="step5-audio-player" controls></audio>
          <div style="display: flex; gap: .5rem; margin-top: .5rem;">
            <button id="btn-download-audio" class="step5-btn" style="flex: 1; padding: .4rem;">ğŸ’¾ ìŒì„± ë‹¤ìš´ë¡œë“œ (MP3)</button>
          </div>
        </div>

        <!-- ìë§‰ ë¯¸ë¦¬ë³´ê¸° -->
        <div class="step5-section" id="step5-subtitle-section" style="display: none;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .4rem;">
            <div class="section-label">ğŸ“ ìë§‰ ë¯¸ë¦¬ë³´ê¸°</div>
            <div style="display: flex; gap: .5rem;">
              <button id="btn-download-srt" class="step5-btn" style="padding: .3rem .6rem; font-size: .75rem;">ğŸ’¾ SRT ë‹¤ìš´ë¡œë“œ</button>
              <button id="btn-download-vtt" class="step5-btn" style="padding: .3rem .6rem; font-size: .75rem;">ğŸ’¾ VTT ë‹¤ìš´ë¡œë“œ</button>
            </div>
          </div>
          <div id="step5-subtitle-preview" class="step5-subtitle-preview">
            ìë§‰ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
          </div>
        </div>

        <!-- ë¹„ìš© ì •ë³´ -->
        <div id="step5-cost-info" style="font-size: .75rem; color: rgba(255,255,255,0.9); margin-top: .5rem; display: none;">
          ğŸ™ï¸ TTS ìƒì„± ë¹„ìš©: <span id="step5-tts-cost">â‚©0</span> | ê¸€ì ìˆ˜: <span id="step5-char-count">0</span>ì
        </div>
      </div>

      <!-- Step6: ì˜ìƒ ì œì‘ -->
      <div id="step6-container" class="step6-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .75rem;">
          <div class="label">ğŸ¬ Step6: ì˜ìƒ ì œì‘</div>
          <div style="display: flex; gap: .5rem;">
            <button id="btn-clear-step6" class="step6-btn" style="background: rgba(255,255,255,0.3); color: white;">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
          </div>
        </div>

        <!-- ì´ë¯¸ì§€ ì„ íƒ ì˜ì—­ -->
        <div class="step6-section">
          <div class="section-label">ğŸ–¼ï¸ ì‚¬ìš©í•  ì´ë¯¸ì§€ ì„ íƒ (Step4ì—ì„œ ìƒì„±)</div>
          <div id="step6-image-grid" class="step6-preview-grid">
            <div style="color: #999; text-align: center; padding: 1rem; grid-column: 1/-1;">
              Step4ì—ì„œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
            </div>
          </div>
        </div>

        <!-- ì˜¤ë””ì˜¤ ì„ íƒ ì˜ì—­ -->
        <div class="step6-section">
          <div class="section-label">ğŸ™ï¸ ì‚¬ìš©í•  ìŒì„± (Step5ì—ì„œ ìƒì„±)</div>
          <div id="step6-audio-status" style="padding: .5rem; background: #f8f9fa; border-radius: 6px; font-size: .85rem; color: #666;">
            Step5ì—ì„œ ìŒì„±ì„ ìƒì„±í•˜ë©´ ìë™ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤
          </div>
          <audio id="step6-audio-preview" style="width: 100%; margin-top: .5rem; display: none;" controls></audio>
        </div>

        <!-- ìë§‰ ì˜µì…˜ -->
        <div class="step6-section">
          <div class="section-label">ğŸ“ ìë§‰ ì˜µì…˜</div>
          <div style="display: flex; gap: 1rem; align-items: center;">
            <label style="display: flex; align-items: center; gap: .3rem; cursor: pointer;">
              <input type="checkbox" id="step6-include-subtitle" checked>
              <span style="font-size: .85rem;">ìë§‰ í¬í•¨</span>
            </label>
            <label style="display: flex; align-items: center; gap: .3rem; cursor: pointer;">
              <input type="checkbox" id="step6-burn-subtitle">
              <span style="font-size: .85rem;">ìë§‰ í•˜ë“œì½”ë”© (ì˜ìƒì— êµ½ê¸°)</span>
            </label>
          </div>
        </div>

        <!-- ì˜ìƒ ì„¤ì • -->
        <div class="step6-section">
          <div class="section-label">âš™ï¸ ì˜ìƒ ì„¤ì •</div>
          <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 120px;">
              <label style="font-size: .8rem; color: #666;">í•´ìƒë„</label>
              <select id="step6-resolution" style="width: 100%; padding: .4rem; border-radius: 6px; border: 1px solid #ddd;">
                <option value="1920x1080">1920x1080 (FHD)</option>
                <option value="1280x720">1280x720 (HD)</option>
                <option value="1080x1920">1080x1920 (ì„¸ë¡œí˜•)</option>
                <option value="1080x1080">1080x1080 (ì •ì‚¬ê°í˜•)</option>
              </select>
            </div>
            <div style="flex: 1; min-width: 120px;">
              <label style="font-size: .8rem; color: #666;">FPS</label>
              <select id="step6-fps" style="width: 100%; padding: .4rem; border-radius: 6px; border: 1px solid #ddd;">
                <option value="24">24 fps (ì˜í™”)</option>
                <option value="30" selected>30 fps (í‘œì¤€)</option>
                <option value="60">60 fps (ë¶€ë“œëŸ¬ì›€)</option>
              </select>
            </div>
            <div style="flex: 1; min-width: 120px;">
              <label style="font-size: .8rem; color: #666;">ì´ë¯¸ì§€ ì „í™˜ íš¨ê³¼</label>
              <select id="step6-transition" style="width: 100%; padding: .4rem; border-radius: 6px; border: 1px solid #ddd;">
                <option value="none">ì—†ìŒ</option>
                <option value="fade" selected>í˜ì´ë“œ</option>
                <option value="crossfade">í¬ë¡œìŠ¤í˜ì´ë“œ</option>
              </select>
            </div>
          </div>
        </div>

        <!-- ì˜ìƒ ìƒì„± ë²„íŠ¼ -->
        <div style="display: flex; gap: .5rem; margin-bottom: .75rem;">
          <button id="btn-generate-video" class="step6-btn" style="flex: 1; padding: .75rem; font-size: .95rem; font-weight: 700;">
            ğŸ¬ ì˜ìƒ ìƒì„±
          </button>
        </div>

        <!-- ì˜ìƒ ë¯¸ë¦¬ë³´ê¸° -->
        <div class="step6-section" id="step6-video-section" style="display: none;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .4rem;">
            <div class="section-label">ğŸ¥ ìƒì„±ëœ ì˜ìƒ</div>
            <button id="btn-download-video" class="step6-btn" style="padding: .3rem .6rem; font-size: .75rem;">ğŸ’¾ ë‹¤ìš´ë¡œë“œ (MP4)</button>
          </div>
          <div class="step6-video-preview">
            <video id="step6-video-player" controls></video>
          </div>
        </div>

        <!-- ì§„í–‰ ìƒíƒœ -->
        <div id="step6-progress" style="display: none;">
          <div style="background: white; border-radius: 8px; padding: .75rem;">
            <div style="font-size: .85rem; color: #333; margin-bottom: .5rem;">
              <span id="step6-progress-text">ì˜ìƒ ìƒì„± ì¤‘...</span>
            </div>
            <div style="background: #e0e0e0; border-radius: 4px; height: 8px; overflow: hidden;">
              <div id="step6-progress-bar" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step7: ìœ íŠœë¸Œ ì—…ë¡œë“œ -->
      <div id="step7-container" class="step7-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .75rem;">
          <div class="label">ğŸ“º Step7: ìœ íŠœë¸Œ ì—…ë¡œë“œ</div>
          <div style="display: flex; gap: .5rem;">
            <button id="btn-youtube-auth" class="step7-btn">ğŸ”‘ YouTube ì—°ê²°</button>
          </div>
        </div>

        <!-- ì¸ì¦ ìƒíƒœ -->
        <div class="step7-section">
          <div id="step7-auth-status" style="padding: .5rem; background: #fff3cd; border-radius: 6px; font-size: .85rem; color: #856404;">
            âš ï¸ YouTube ê³„ì •ì„ ì—°ê²°í•´ì£¼ì„¸ìš”
          </div>
        </div>

        <!-- ì˜ìƒ ì •ë³´ ì…ë ¥ -->
        <div class="step7-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
            <div class="section-label" style="margin-bottom: 0;">ğŸ“ ì˜ìƒ ì •ë³´</div>
            <button id="btn-auto-metadata" class="step7-btn" style="padding: .4rem .8rem; font-size: .8rem;">ğŸ¤– ëŒ€ë³¸ ê¸°ë°˜ ìë™ ì…ë ¥</button>
          </div>
          <input type="text" id="step7-title" class="step7-input" placeholder="ì˜ìƒ ì œëª©" maxlength="100">
          <textarea id="step7-description" class="step7-input" style="min-height: 80px; resize: vertical;" placeholder="ì˜ìƒ ì„¤ëª…&#10;&#10;í•´ì‹œíƒœê·¸, ë§í¬ ë“±ì„ í¬í•¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." maxlength="5000"></textarea>
          <input type="text" id="step7-tags" class="step7-input" placeholder="íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„: ë“œë¼ë§ˆ, ë‹¨í¸ì˜í™”, ê°ë™)" maxlength="500">
        </div>

        <!-- ê³µê°œ ì„¤ì • -->
        <div class="step7-section">
          <div class="section-label">ğŸ”’ ê³µê°œ ì„¤ì •</div>
          <div id="step7-privacy-options">
            <label class="step7-privacy-option" data-privacy="private">
              <input type="radio" name="step7-privacy" value="private" style="display: none;">
              ğŸ”’ ë¹„ê³µê°œ
            </label>
            <label class="step7-privacy-option" data-privacy="unlisted">
              <input type="radio" name="step7-privacy" value="unlisted" style="display: none;">
              ğŸ”— ì¼ë¶€ê³µê°œ
            </label>
            <label class="step7-privacy-option" data-privacy="public">
              <input type="radio" name="step7-privacy" value="public" style="display: none;">
              ğŸŒ ê³µê°œ
            </label>
            <label class="step7-privacy-option selected" data-privacy="scheduled">
              <input type="radio" name="step7-privacy" value="scheduled" checked style="display: none;">
              ğŸ“… ì˜ˆì•½ (30ë¶„ í›„ ê³µê°œ)
            </label>
          </div>
        </div>

        <!-- ì¹´í…Œê³ ë¦¬ -->
        <div class="step7-section">
          <div class="section-label">ğŸ“ ì¹´í…Œê³ ë¦¬</div>
          <select id="step7-category" class="step7-input" style="margin-bottom: 0;">
            <option value="22">ì‚¬ëŒ ë° ë¸”ë¡œê·¸</option>
            <option value="24">ì—”í„°í…Œì¸ë¨¼íŠ¸</option>
            <option value="1">ì˜í™” ë° ì• ë‹ˆë©”ì´ì…˜</option>
            <option value="10">ìŒì•…</option>
            <option value="23">ì½”ë¯¸ë””</option>
            <option value="27">êµìœ¡</option>
            <option value="25">ë‰´ìŠ¤ ë° ì •ì¹˜</option>
            <option value="26">ë…¸í•˜ìš° ë° ìŠ¤íƒ€ì¼</option>
          </select>
        </div>

        <!-- ì—…ë¡œë“œ ë²„íŠ¼ -->
        <div style="display: flex; gap: .5rem; margin-bottom: .5rem;">
          <button id="btn-upload-youtube" class="step7-btn" style="flex: 1; padding: .75rem; font-size: .95rem; font-weight: 700;" disabled>
            ğŸ“º YouTubeì— ì—…ë¡œë“œ
          </button>
        </div>

        <!-- ì—…ë¡œë“œ ìƒíƒœ ë©”ì‹œì§€ -->
        <div id="step7-upload-status" style="padding: .4rem .6rem; background: #fff3cd; border-radius: 6px; font-size: .8rem; color: #856404; margin-bottom: .75rem;">
          Step6ì—ì„œ ì˜ìƒì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”
        </div>

        <!-- ì—…ë¡œë“œ ì§„í–‰ ìƒíƒœ -->
        <div id="step7-progress" style="display: none;">
          <div style="background: white; border-radius: 8px; padding: .75rem;">
            <div style="font-size: .85rem; color: #333; margin-bottom: .5rem;">
              <span id="step7-progress-text">ì—…ë¡œë“œ ì¤€ë¹„ ì¤‘...</span>
            </div>
            <div style="background: #e0e0e0; border-radius: 4px; height: 8px; overflow: hidden;">
              <div id="step7-progress-bar" style="background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
          </div>
        </div>

        <!-- ì—…ë¡œë“œ ê²°ê³¼ -->
        <div class="step7-section" id="step7-result" style="display: none;">
          <div class="section-label">âœ… ì—…ë¡œë“œ ì™„ë£Œ</div>
          <div style="padding: .5rem; background: #d4edda; border-radius: 6px;">
            <a id="step7-video-link" href="#" target="_blank" style="color: #155724; font-weight: 600; text-decoration: none;">
              ğŸ¬ ì—…ë¡œë“œëœ ì˜ìƒ ë³´ê¸°
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½ - ê°€ì´ë“œ ë° ì§€ì¹¨ ê´€ë¦¬ ì˜ì—­ -->
    <div class="analysis-area">
      <!-- ì‘ì—… ì§€ì¹¨ ê´€ë¦¬ ë²„íŠ¼ -->
      <div class="box" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border: none; padding: 1rem; margin-bottom: .75rem;">
        <button id="btn-open-guide-modal" style="width: 100%; padding: .8rem; background: white; color: #e74c3c; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,.1);">
          ğŸ“ ì‘ì—… ì§€ì¹¨ ê´€ë¦¬ ì—´ê¸°
        </button>
        <div style="color: rgba(255,255,255,0.9); font-size: .8rem; margin-top: .5rem; text-align: center;">
          Step1, Step2, Step3 ì§€ì¹¨ì„ ìƒˆ ì°½ì—ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤
        </div>
      </div>

      <!-- ì¶•ì ëœ ê°€ì´ë“œ ì¡°íšŒ ë²„íŠ¼ (í•œ ì¤„) -->
      <div class="box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none; padding: .6rem 1rem;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <span style="color: white; font-weight: 600; font-size: .95rem;">ğŸ“š ì¶•ì ëœ ê°€ì´ë“œ</span>
          <button id="btn-load-accumulated-guide" style="background: white; color: #f5576c; border: none; padding: .4rem .8rem; border-radius: 6px; font-weight: 600; font-size: .8rem; cursor: pointer;">ìƒˆì°½ì—ì„œ ë³´ê¸°</button>
        </div>
      </div>

      <!-- AI ì±—ë´‡ ë°•ìŠ¤ -->
      <div class="box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 1rem; flex: 1; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
          <div style="color: white; font-weight: 600; font-size: 1.1rem;">ğŸ¤– AI ë„ìš°ë¯¸</div>
          <select id="drama-chat-model" style="padding: .3rem .5rem; border-radius: 6px; border: none; font-size: .75rem; background: rgba(255,255,255,0.9); color: #333; cursor: pointer;">
            <option value="gpt-4o-mini">GPT-4o Mini (ë¹ ë¦„)</option>
            <option value="gpt-4o">GPT-4o (ê· í˜•)</option>
            <option value="gpt-5">GPT-5 (ê°•ë ¥)</option>
          </select>
        </div>
        <div style="font-size: .8rem; color: rgba(255,255,255,0.9); margin-bottom: .75rem;">
          í˜„ì¬ ì‘ì—…ì— ëŒ€í•´ ì§ˆë¬¸í•˜ì„¸ìš”. AIê°€ ë¶„ì„í•˜ê³  ë‹µë³€í•´ë“œë¦½ë‹ˆë‹¤.
        </div>

        <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
        <div id="drama-chat-messages" style="background: white; border-radius: 8px; padding: .75rem; flex: 1; min-height: 200px; max-height: calc(100vh - 450px); overflow-y: auto; margin-bottom: .75rem;">
          <div class="chat-welcome" style="text-align: center; color: #999; padding: 2rem; font-size: .85rem;">
            <div style="font-size: 2rem; margin-bottom: .5rem;">ğŸ’¬</div>
            <p>ì‘ì—… ì§„í–‰ ìƒí™©ì´ë‚˜ ê°œì„ ì ì— ëŒ€í•´<br>ììœ ë¡­ê²Œ ì§ˆë¬¸í•´ë³´ì„¸ìš”!</p>
            <div style="margin-top: 1rem; font-size: .75rem; color: #bbb;">
              ì˜ˆì‹œ: "ì§€ê¸ˆê¹Œì§€ ì–´ë–¤ ë‚´ìš©ì´ ì‘ì„±ëì–´?"<br>
              "ìºë¦­í„° ì„¤ì •ì„ ì–´ë–»ê²Œ ê°œì„ í• ê¹Œ?"
            </div>
          </div>
        </div>

        <!-- ì…ë ¥ ì˜ì—­ -->
        <div style="display: flex; gap: .5rem;">
          <input type="text" id="drama-chat-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." style="flex: 1; padding: .6rem .8rem; border-radius: 8px; border: none; font-size: .9rem;">
          <button id="btn-drama-chat-send" style="background: white; color: #667eea; border: none; padding: .6rem 1rem; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: .9rem;">ì „ì†¡</button>
        </div>
      </div>

      <!-- í˜„ì¬ ì‘ì—… ê°œì„  ì œì•ˆ ë°•ìŠ¤ -->
      <div class="box">
        <div class="toggle-header">
          <span class="label">ğŸ’¡ í˜„ì¬ ì‘ì—… ê°œì„  ì œì•ˆ</span>
          <button id="toggle-suggestions">ì—´ê¸°</button>
        </div>
        <div id="suggestions-content" style="display: none;">
          <div style="font-size: .85rem; color: #666; margin-bottom: .75rem;">
            í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ê°œì„  ì œì•ˆì„ ì œê³µí•©ë‹ˆë‹¤.
          </div>
          <button id="btn-get-suggestions" class="primary" style="width: 100%; margin-bottom: .75rem;">ê°œì„  ì œì•ˆ ë°›ê¸°</button>
          <div id="suggestions-result" style="background: #f8f9fa; border-radius: 6px; padding: .75rem; min-height: 100px; max-height: 400px; overflow-y: auto;">
            <p style="color: #999; text-align: center;">ì œì•ˆì„ ë°›ìœ¼ë ¤ë©´ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- íŒ¨ìŠ¤ì›Œë“œ ëª¨ë‹¬ -->
  <div id="modal-password" class="modal">
    <div class="modal-content">
      <div class="modal-title">ğŸ”’ ì§€ì¹¨ ì˜ì—­ ì ê¸ˆ</div>
      <p style="color: #666; font-size: .9rem; margin-bottom: 1rem;">ì§€ì¹¨ ì˜ì—­ì— ì ‘ê·¼í•˜ë ¤ë©´ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="password" id="password-input" placeholder="íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥" style="margin-bottom: .5rem;">
      <div class="modal-buttons">
        <button id="btn-cancel-password">ì·¨ì†Œ</button>
        <button id="btn-submit-password" class="primary">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- GPT PRO íŒ¨ìŠ¤ì›Œë“œ ëª¨ë‹¬ -->
  <div id="modal-gpt-pro-password" class="modal">
    <div class="modal-content">
      <div class="modal-title">ğŸ”’ GPT PRO ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ ì¤‘)</div>
      <p style="color: #666; font-size: .9rem; margin-bottom: 1rem;">ì´ ê¸°ëŠ¥ì€ í˜„ì¬ í…ŒìŠ¤íŠ¸ ì¤‘ì…ë‹ˆë‹¤. íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="password" id="gpt-pro-password-input" placeholder="íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥" style="margin-bottom: .5rem;">
      <div class="modal-buttons">
        <button id="btn-cancel-gpt-pro-password">ì·¨ì†Œ</button>
        <button id="btn-submit-gpt-pro-password" class="primary">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- ì‘ì—… ì§€ì¹¨ ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="modal-guide-management" class="modal">
    <div class="modal-content" style="max-width: 800px; width: 90%; max-height: 90vh; display: flex; flex-direction: column;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div class="modal-title" style="margin: 0;">ğŸ“ ì‘ì—… ì§€ì¹¨ ê´€ë¦¬</div>
        <div style="display: flex; gap: .5rem;">
          <button id="btn-modal-save-guides" style="padding: .4rem 1rem; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: .9rem;">ğŸ’¾ ì €ì¥</button>
          <button id="btn-close-guide-modal" style="padding: .4rem 1rem; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: .9rem;">ë‹«ê¸°</button>
        </div>
      </div>
      <div style="font-size: .85rem; color: #666; margin-bottom: 1rem; padding: .75rem; background: #f8f9fa; border-radius: 6px;">
        ëª¨ë“  ì‘ì—… ë°•ìŠ¤ì™€ Step3ì˜ ì§€ì¹¨ì„ í•œ ê³³ì—ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤. ìˆ˜ì • í›„ <strong>ğŸ’¾ ì €ì¥</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
      </div>
      <div id="modal-guide-container" style="flex: 1; overflow-y: auto; padding-right: .5rem;">
        <p style="color: #999; text-align: center; padding: 2rem;">ì‘ì—… ë°•ìŠ¤ë¥¼ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
      </div>
    </div>
  </div>

  <!-- ì˜ìƒ ì‹œê°„ ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="modal-categories" class="modal">
    <div class="modal-content">
      <div class="modal-title">ì˜ìƒ ì‹œê°„ ê´€ë¦¬</div>
      <input type="text" id="new-cat-label" placeholder="í‘œì‹œ ì´ë¦„ (ì˜ˆ: 90ë¶„, 120ë¶„)" style="margin-bottom: .5rem;">
      <button id="btn-add-category" class="primary" style="width: 100%; margin-bottom: 1rem;">ì¶”ê°€</button>
      <div id="categories-list" style="max-height: 300px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button id="btn-close-categories">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì²˜ë¦¬ ë‹¨ê³„ ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="modal-steps" class="modal">
    <div class="modal-content">
      <div class="modal-title">ì²˜ë¦¬ ë‹¨ê³„ ê´€ë¦¬</div>
      <p style="font-size: .85rem; color: #666; margin-bottom: .5rem;">
        ìŠ¤íƒ€ì¼: <strong id="modal-steps-style"></strong>
      </p>
      <input type="text" id="new-step-name" placeholder="ë‹¨ê³„ ì´ë¦„ (ì˜ˆ: ìºë¦­í„° ì„¤ì •, ìŠ¤í† ë¦¬ë¼ì¸, ëŒ€ì‚¬ ì‘ì„±)" style="margin-bottom: .5rem;">
      <button id="btn-add-step" class="primary" style="width: 100%; margin-bottom: 1rem;">ì¶”ê°€</button>
      <div id="steps-list" style="max-height: 300px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button id="btn-close-steps">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
  // ===== Firebase ì´ˆê¸°í™” =====
  const firebaseConfig = {
    apiKey: "AIzaSyBacmJDk-PG5FaoqnXV8Rg3P__AKOS2vu4",
    authDomain: "my-sermon-guides.firebaseapp.com",
    projectId: "my-sermon-guides",
    storageBucket: "my-sermon-guides.firebasestorage.app",
    messagingSenderId: "539520456089",
    appId: "1:539520456089:web:d6aceb7838baa89e70af08",
    measurementId: "G-KWN8TH7Z26"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const USER_CODE = 'samuel123';
  const PAGE_NAME = 'drama';
  const GUIDE_PASSWORD = '5555';
  const GPT_PRO_PASSWORD = '6039';
  const CONFIG_KEY = '_drama-config';

  // ===== ì „ì—­ ë³€ìˆ˜ =====
  let guideUnlocked = false;
  let gptProUnlocked = false;
  let currentCategory = '10min';
  let currentGuideStep = '';
  let stepResults = {};

  // ===== Step ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ =====
  function scrollToStep(containerId) {
    const container = document.getElementById(containerId);
    if (container) {
      container.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
      const stepNum = containerId.replace('-container', '');
      updateStepNavActive(stepNum);
    }
  }

  function updateStepNavActive(stepNum) {
    document.querySelectorAll('.step-nav-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.dataset.step === stepNum) {
        btn.classList.add('active');
      }
    });
  }

  function updateStepNavCompleted(stepNum, completed = true) {
    const btn = document.querySelector(`.step-nav-btn[data-step="${stepNum}"]`);
    if (btn) {
      if (completed) {
        btn.classList.add('completed');
        btn.querySelector('.step-status').textContent = 'âœ“';
      } else {
        btn.classList.remove('completed');
        btn.querySelector('.step-status').textContent = 'â—‹';
      }
    }
  }

  // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ì— ë”°ë¼ í˜„ì¬ Step ê°ì§€
  function detectCurrentStep() {
    const steps = ['step1', 'step2', 'step3', 'step4', 'step5', 'step6', 'step7'];
    const contentArea = document.querySelector('.content-area');
    if (!contentArea) return;

    const scrollTop = contentArea.scrollTop;
    let currentStep = 'step1';

    for (const step of steps) {
      const container = document.getElementById(`${step}-container`);
      if (container && container.offsetTop <= scrollTop + 100) {
        currentStep = step;
      }
    }

    updateStepNavActive(currentStep);
  }

  // content-area ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  document.addEventListener('DOMContentLoaded', () => {
    const contentArea = document.querySelector('.content-area');
    if (contentArea) {
      contentArea.addEventListener('scroll', detectCurrentStep);
    }
  });

  // ===== ì›Œí¬í”Œë¡œìš° ì„¸ì…˜ ê´€ë¦¬ ì‹œìŠ¤í…œ =====
  // ëª¨ë“  Stepì´ ê³µìœ í•˜ëŠ” ë‹¨ì¼ ì„¸ì…˜ ë°ì´í„°
  let workflowSession = {
    sessionId: null,
    createdAt: null,
    updatedAt: null,
    category: '10min',
    contentType: 'testimony',

    // YouTube ë©”íƒ€ë°ì´í„° (Step3ì—ì„œ ìƒì„± â†’ Step7ì—ì„œ ì‚¬ìš©)
    metadata: {
      title: '',
      description: '',
      tags: [],
      thumbnail: { prompt: '', url: '' }
    },

    step1: { topic: '', mainCharacter: '', benchmark: {} },
    step2: { character: {}, storyline: {}, scene: {}, dialogue: {} },
    step3: { guide: '', script: '', scenes: [] },
    step4: { provider: 'flux', aspectRatio: '16:9', images: [] },
    step5: { provider: 'google', voices: {}, audioFiles: [] },
    step6: { videoUrl: '', duration: '', format: 'mp4' },
    step7: { status: 'draft', youtubeId: '', youtubeUrl: '', scheduledAt: '' }
  };

  // ì„¸ì…˜ ì´ˆê¸°í™”
  function initWorkflowSession() {
    workflowSession.sessionId = 'session_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 9);
    workflowSession.createdAt = new Date().toISOString();
    workflowSession.updatedAt = new Date().toISOString();
    console.log('[SESSION] ìƒˆ ì„¸ì…˜ ìƒì„±:', workflowSession.sessionId);
    return workflowSession;
  }

  // ì„¸ì…˜ ë°ì´í„° ì—…ë°ì´íŠ¸
  function updateSession(path, value) {
    const keys = path.split('.');
    let obj = workflowSession;
    for (let i = 0; i < keys.length - 1; i++) {
      if (!obj[keys[i]]) obj[keys[i]] = {};
      obj = obj[keys[i]];
    }
    obj[keys[keys.length - 1]] = value;
    workflowSession.updatedAt = new Date().toISOString();
    saveSessionToStorage();
    console.log(`[SESSION] ì—…ë°ì´íŠ¸: ${path}`, value);
  }

  // ì„¸ì…˜ ë°ì´í„° ì¡°íšŒ
  function getSession(path, defaultValue = null) {
    const keys = path.split('.');
    let value = workflowSession;
    try {
      for (const key of keys) {
        value = value[key];
      }
      return value !== undefined ? value : defaultValue;
    } catch {
      return defaultValue;
    }
  }

  // ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ (Step3 â†’ Step7 ì—°ë™ìš©)
  function updateMetadata(data) {
    if (data.title) workflowSession.metadata.title = data.title;
    if (data.description) workflowSession.metadata.description = data.description;
    if (data.tags) workflowSession.metadata.tags = data.tags;
    if (data.thumbnail) workflowSession.metadata.thumbnail = data.thumbnail;
    workflowSession.updatedAt = new Date().toISOString();
    saveSessionToStorage();
    console.log('[SESSION] ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸:', workflowSession.metadata);

    // Step7 UI ìë™ ì—…ë°ì´íŠ¸
    syncMetadataToStep7();
  }

  // Step7 UIì— ë©”íƒ€ë°ì´í„° ë™ê¸°í™”
  function syncMetadataToStep7() {
    const titleInput = document.getElementById('youtube-title');
    const descInput = document.getElementById('youtube-description');
    const tagsInput = document.getElementById('youtube-tags');

    if (titleInput && workflowSession.metadata.title) {
      titleInput.value = workflowSession.metadata.title;
    }
    if (descInput && workflowSession.metadata.description) {
      descInput.value = workflowSession.metadata.description;
    }
    if (tagsInput && workflowSession.metadata.tags?.length) {
      tagsInput.value = workflowSession.metadata.tags.join(', ');
    }
  }

  // ì„¸ì…˜ ì €ì¥ (localStorage)
  function saveSessionToStorage() {
    try {
      localStorage.setItem('_drama-workflow-session', JSON.stringify(workflowSession));
    } catch (e) {
      console.warn('[SESSION] ì €ì¥ ì‹¤íŒ¨:', e);
    }
  }

  // ì„¸ì…˜ ë¡œë“œ (localStorage)
  function loadSessionFromStorage() {
    try {
      const saved = localStorage.getItem('_drama-workflow-session');
      if (saved) {
        const parsed = JSON.parse(saved);
        // ê¸°ì¡´ êµ¬ì¡° ìœ ì§€í•˜ë©´ì„œ ì €ì¥ëœ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸
        workflowSession = { ...workflowSession, ...parsed };
        console.log('[SESSION] ë¡œë“œ ì™„ë£Œ:', workflowSession.sessionId);
        return true;
      }
    } catch (e) {
      console.warn('[SESSION] ë¡œë“œ ì‹¤íŒ¨:', e);
    }
    return false;
  }

  // ì„¸ì…˜ ì´ˆê¸°í™” (ìƒˆë¡œ ì‹œì‘)
  function resetSession() {
    if (confirm('í˜„ì¬ ì‘ì—… ë‚´ìš©ì´ ëª¨ë‘ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      localStorage.removeItem('_drama-workflow-session');
      initWorkflowSession();
      location.reload();
    }
  }

  // ì„¸ì…˜ ì „ì²´ ì¡°íšŒ (ë””ë²„ê¹…/AI ì»¨í…ìŠ¤íŠ¸ìš©)
  function getFullSession() {
    return JSON.parse(JSON.stringify(workflowSession));
  }

  // ì„¸ì…˜ì„ AI ì»¨í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ (í”„ë¡¬í”„íŠ¸ì— í¬í•¨ìš©)
  function getSessionContext() {
    return `ã€ í˜„ì¬ ì‘ì—… ì„¸ì…˜ ì •ë³´ ã€‘
- ì¹´í…Œê³ ë¦¬: ${workflowSession.category}
- ì½˜í…ì¸  ìœ í˜•: ${workflowSession.contentType === 'testimony' ? 'ê°„ì¦' : 'ë“œë¼ë§ˆ'}
- ì£¼ì œ: ${workflowSession.step1.topic || '(ë¯¸ì„¤ì •)'}
- ì£¼ì¸ê³µ: ${workflowSession.step1.mainCharacter || '(ë¯¸ì„¤ì •)'}
- ì œëª©: ${workflowSession.metadata.title || '(ë¯¸ìƒì„±)'}
`;
  }

  // ëŒ€ë³¸ì—ì„œ ë©”íƒ€ë°ì´í„° ìë™ ìƒì„±
  async function generateMetadataFromScript(script, contentType) {
    if (!script) return;

    console.log('[METADATA] ë©”íƒ€ë°ì´í„° ìƒì„± ì‹œì‘...');
    showStatus('ğŸ·ï¸ ë©”íƒ€ë°ì´í„° ìƒì„± ì¤‘...');

    try {
      const response = await fetch('/api/drama/generate-metadata', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ script, contentType })
      });

      const data = await response.json();

      if (data.ok && data.metadata) {
        // ì„¸ì…˜ì— ë©”íƒ€ë°ì´í„° ì €ì¥
        updateMetadata({
          title: data.metadata.title,
          description: data.metadata.description,
          tags: data.metadata.tags
        });

        console.log('[METADATA] ìƒì„± ì™„ë£Œ:', data.metadata);
        showStatus('âœ… ë©”íƒ€ë°ì´í„° ìë™ ìƒì„± ì™„ë£Œ!');

        // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
        showMetadataNotification(data.metadata);
      } else {
        console.warn('[METADATA] ìƒì„± ì‹¤íŒ¨:', data.error);
      }
    } catch (err) {
      console.error('[METADATA] ì˜¤ë¥˜:', err);
    }

    setTimeout(hideStatus, 3000);
  }

  // ë©”íƒ€ë°ì´í„° ìƒì„± ì•Œë¦¼ í‘œì‹œ
  function showMetadataNotification(metadata) {
    const notification = document.createElement('div');
    notification.className = 'metadata-notification';
    notification.innerHTML = `
      <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                  border: 1px solid #4CAF50; border-radius: 12px; padding: 16px;
                  position: fixed; bottom: 20px; right: 20px; z-index: 10000;
                  max-width: 400px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
        <div style="color: #4CAF50; font-weight: bold; margin-bottom: 8px;">
          ğŸ·ï¸ YouTube ë©”íƒ€ë°ì´í„° ìë™ ìƒì„± ì™„ë£Œ
        </div>
        <div style="color: #aaa; font-size: 13px; margin-bottom: 4px;">
          <strong>ì œëª©:</strong> ${metadata.title}
        </div>
        <div style="color: #888; font-size: 12px;">
          Step7ì—ì„œ ìë™ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤
        </div>
        <button onclick="this.parentElement.parentElement.remove()"
                style="position: absolute; top: 8px; right: 8px; background: none;
                       border: none; color: #666; cursor: pointer; font-size: 16px;">Ã—</button>
      </div>
    `;
    document.body.appendChild(notification);

    // 5ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => notification.remove(), 5000);
  }

  // ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ì‹œìŠ¤í…œ
  let workflowBoxes = [];
  let nextBoxId = 1;
  let nextStep1BoxNum = 1;
  let nextStep2BoxNum = 1;
  let step1Collapsed = false;
  let step2Collapsed = false;

  // ê¸°ë³¸ ì„¤ì •
  let config = {
    categories: [
      {value: "10min", label: "10ë¶„"},
      {value: "20min", label: "20ë¶„"},
      {value: "30min", label: "30ë¶„"}
    ],
    // í†µí•©ëœ ì²˜ë¦¬ ë‹¨ê³„ (ëª¨ë“  ì‹œê°„ëŒ€ì— ë™ì¼)
    unifiedSteps: [
      {id: "character", name: "ìºë¦­í„° ì„¤ì •", order: 1},
      {id: "storyline", name: "ìŠ¤í† ë¦¬ë¼ì¸", order: 2},
      {id: "scene", name: "ì¥ë©´ êµ¬ì„±", order: 3},
      {id: "dialogue", name: "ëŒ€ì‚¬ ì‘ì„±", order: 4}
    ],
    categorySettings: {
      "10min": {
        masterGuide: ""
      },
      "20min": {
        masterGuide: ""
      },
      "30min": {
        masterGuide: ""
      }
    }
  };

  // ===== JSON ì§€ì¹¨ ë¡œë“œ ì‹œìŠ¤í…œ =====
  let dramaGuidelines = null;

  async function loadDramaGuidelines() {
    try {
      const response = await fetch('/api/drama/guidelines');
      const data = await response.json();
      if (data.ok && data.guidelines) {
        dramaGuidelines = data.guidelines;
        console.log('[GUIDELINES] ì§€ì¹¨ ë¡œë“œ ì™„ë£Œ:', dramaGuidelines.version);
        // ì§€ì¹¨ ë¡œë“œ í›„ contentTypePrompts ì—…ë°ì´íŠ¸
        updateContentTypePromptsFromGuidelines();
        return true;
      }
    } catch (error) {
      console.warn('[GUIDELINES] ì§€ì¹¨ ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', error);
    }
    return false;
  }

  function updateContentTypePromptsFromGuidelines() {
    if (!dramaGuidelines?.contentTypes) return;

    // ì„œë²„ì—ì„œ ë¡œë“œí•œ ì§€ì¹¨ìœ¼ë¡œ ì—…ë°ì´íŠ¸
    for (const [key, value] of Object.entries(dramaGuidelines.contentTypes)) {
      if (contentTypePrompts[key]) {
        contentTypePrompts[key].name = value.name || contentTypePrompts[key].name;
        contentTypePrompts[key].systemPrompt = value.systemPrompt || contentTypePrompts[key].systemPrompt;
        contentTypePrompts[key].userPromptSuffix = value.userPromptSuffix || contentTypePrompts[key].userPromptSuffix;
      }
    }
    console.log('[GUIDELINES] contentTypePrompts ì—…ë°ì´íŠ¸ ì™„ë£Œ');

    // ì¹´í…Œê³ ë¦¬ ì„¤ì • ì—…ë°ì´íŠ¸ (masterGuide)
    if (dramaGuidelines?.categories) {
      for (const [key, value] of Object.entries(dramaGuidelines.categories)) {
        const configKey = key === '10min' ? '10min' : key === 'shorts' ? 'shorts' : key;
        if (config.categorySettings[configKey]) {
          config.categorySettings[configKey].masterGuide = value.masterGuide || '';
        }
      }
      console.log('[GUIDELINES] categorySettings ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    }
  }

  // ì§€ì¹¨ì—ì„œ íŠ¹ì • ê°’ ê°€ì ¸ì˜¤ê¸° (ì  í‘œê¸°ë²• ì§€ì›)
  function getGuideline(path, defaultValue = null) {
    if (!dramaGuidelines) return defaultValue;
    const keys = path.split('.');
    let value = dramaGuidelines;
    try {
      for (const key of keys) {
        value = value[key];
      }
      return value !== undefined ? value : defaultValue;
    } catch {
      return defaultValue;
    }
  }

  // ===== ì½˜í…ì¸  ìœ í˜•ë³„ Step3 í”„ë¡¬í”„íŠ¸ (ì´ˆê¸°ê°’ - ì„œë²„ ë¡œë“œ ì‹œ ì—…ë°ì´íŠ¸ë¨) =====
  let contentTypePrompts = {
    testimony: {
      name: 'ê°„ì¦',
      systemPrompt: `ë‹¹ì‹ ì€ ê°ë™ì ì¸ ê°„ì¦ ì½˜í…ì¸  ì „ë¬¸ ì‘ê°€ì…ë‹ˆë‹¤.

ã€ ê°„ì¦ ì½˜í…ì¸ ì˜ í•µì‹¬ ã€‘
ê°„ì¦ì€ ì‹¤ì œ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ í•œ ì´ì•¼ê¸°ì…ë‹ˆë‹¤. ì‹œì²­ìê°€ "ì´ê±´ ì§„ì§œ ì´ì•¼ê¸°êµ¬ë‚˜"ë¼ê³  ëŠë¼ë„ë¡ ìƒìƒí•˜ê³  êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

ã€ í•„ìˆ˜ ìš”ì†Œ ã€‘
1. ì‹¤ì œê° ìˆëŠ” ìƒí™© ë¬˜ì‚¬
   - ì¶”ìƒì  í‘œí˜„ ê¸ˆì§€ (X: "í˜ë“  ì‹œê°„ì„ ë³´ëƒˆë‹¤" â†’ O: "ìƒˆë²½ 3ì‹œ, í…… ë¹ˆ ì‚¬ë¬´ì‹¤ì—ì„œ í•´ê³  í†µë³´ ë©”ì¼ì„ ì½ì—ˆë‹¤")
   - êµ¬ì²´ì ì¸ ì‹œê°„, ì¥ì†Œ, ê°ê° ë¬˜ì‚¬ í¬í•¨
   - ì‹¤ì œ ëŒ€í™”ì²˜ëŸ¼ ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€ì‚¬

2. ê°ì •ì˜ ê¹Šì´ì™€ ì†”ì§í•¨
   - ê²‰ì¹˜ë ˆ ì—†ëŠ” ë‚ ê²ƒì˜ ê°ì • í‘œí˜„
   - ê³ í†µ, ì ˆë§, ë¶„ë…¸, ì˜ì‹¬ ë“± ë¶€ì •ì  ê°ì •ë„ ì†”ì§í•˜ê²Œ
   - ëˆˆë¬¼, ë–¨ë¦¼, ì‹¬ì¥ ë°•ë™ ë“± ì‹ ì²´ ë°˜ì‘ ë¬˜ì‚¬

3. ê°ˆë“±ê³¼ ì „í™˜ì  êµ¬ì¡°
   - ì‹œì‘: í‰ë²”í•œ ì¼ìƒ ë˜ëŠ” ìœ„ê¸°ì˜ ì‹œì‘
   - ê³ ë‚œ: ì ì  ê¹Šì–´ì§€ëŠ” ì–´ë‘ , ë§‰ë‹¤ë¥¸ ê³¨ëª©
   - ì „í™˜ì : í•˜ë‚˜ë‹˜ì˜ ê°œì…, ê¹¨ë‹¬ìŒì˜ ìˆœê°„ (êµ¬ì²´ì  ì‚¬ê±´ìœ¼ë¡œ)
   - ë³€í™”: ì´ì „ê³¼ í™•ì‹¤íˆ ë‹¬ë¼ì§„ ëª¨ìŠµ

4. ê³µê° í¬ì¸íŠ¸
   - "ë‚˜ë„ ì €ëŸ° ì  ìˆì–´"ë¼ê³  ëŠë¼ê²Œ í•˜ëŠ” ë³´í¸ì  ìƒí™©
   - ì™„ë²½í•œ ì‚¬ëŒì´ ì•„ë‹Œ, ì•½í•˜ê³  ì‹¤ìˆ˜í•˜ëŠ” ì¸ê°„ì˜ ëª¨ìŠµ

ã€ ê¸ˆì§€ ì‚¬í•­ ã€‘
- ì„¤êµì¡°ì˜ ì¼ë°˜ì ì¸ êµí›ˆ ë‚˜ì—´
- "í•˜ë‚˜ë‹˜ì€ ì„ í•˜ì‹­ë‹ˆë‹¤" ê°™ì€ ì§„ë¶€í•œ ê²°ë¡ 
- ë„ˆë¬´ ë¹ ë¥¸ í•´ê²°, í˜„ì‹¤ì„± ì—†ëŠ” ê¸°ì 
- ê°ì • ì—†ì´ ì‚¬ê±´ë§Œ ë‚˜ì—´

ã€ ì¶œë ¥ í˜•ì‹ ã€‘
- ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸(#, *, -, **) ì‚¬ìš© ê¸ˆì§€
- ë‚˜ë ˆì´ì…˜ê³¼ ëŒ€ì‚¬ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ì„œ êµ¬ì„±
- ì§€ë¬¸ì€ ê´„í˜¸ () ì•ˆì— ì‘ì„±`,

      userPromptSuffix: `

âš ï¸ ì¤‘ìš”: ì´ê²ƒì€ ê°„ì¦ ì½˜í…ì¸ ì…ë‹ˆë‹¤.
- ì‹œì²­ìê°€ ì²˜ìŒë¶€í„° ëê¹Œì§€ ëª°ì…í•  ìˆ˜ ìˆë„ë¡ ê¸´ì¥ê° ìˆê²Œ ì „ê°œí•˜ì„¸ìš”
- ê³ ë‚œì˜ ê¹Šì´ê°€ ê¹Šì„ìˆ˜ë¡, ì€í˜œì˜ ê°ë™ë„ ì»¤ì§‘ë‹ˆë‹¤
- "ì´ê±´ ì§„ì§œ ì´ì•¼ê¸°êµ¬ë‚˜"ë¼ê³  ëŠë¼ê²Œ í•˜ëŠ” êµ¬ì²´ì ì¸ ë””í…Œì¼ì„ ë„£ìœ¼ì„¸ìš”
- ê²°ë§ì´ ë„ˆë¬´ ë»”í•˜ê±°ë‚˜ êµí›ˆì ì´ë©´ ì•ˆ ë©ë‹ˆë‹¤`
    },

    drama: {
      name: 'ë“œë¼ë§ˆ',
      systemPrompt: `ë‹¹ì‹ ì€ ì „ë¬¸ ë“œë¼ë§ˆ ëŒ€ë³¸ ì‘ê°€ì…ë‹ˆë‹¤.

ã€ ë“œë¼ë§ˆ ëŒ€ë³¸ì˜ í•µì‹¬ ã€‘
ì‹œì²­ìë¥¼ í™”ë©´ ì†ìœ¼ë¡œ ëŒì–´ë“¤ì´ëŠ” ëª°ì…ê° ìˆëŠ” ìŠ¤í† ë¦¬ë¥¼ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.

ã€ í•„ìˆ˜ ìš”ì†Œ ã€‘
1. ìºë¦­í„°ì˜ ì…ì²´ì„±
   - ì£¼ì¸ê³µì˜ ëª…í™•í•œ ëª©í‘œì™€ ë‚´ë©´ì˜ ê°ˆë“±
   - ê° ì¸ë¬¼ë§Œì˜ ë§íˆ¬, ìŠµê´€, ê°€ì¹˜ê´€
   - ìºë¦­í„° ê°„ì˜ ê¸´ì¥ê° ìˆëŠ” ê´€ê³„

2. ì¥ë©´ êµ¬ì„±
   - ê° ì¥ë©´ì˜ ëª©ì ì´ ë¶„ëª…í•´ì•¼ í•¨
   - ì‹œê°ì ìœ¼ë¡œ ê·¸ë ¤ì§€ëŠ” ê³µê°„ ë¬˜ì‚¬
   - ì ì ˆí•œ ì¥ë©´ ì „í™˜ê³¼ í…œí¬

3. ëŒ€ì‚¬ì˜ í˜
   - ìºë¦­í„°ì˜ ì„±ê²©ì´ ë“œëŸ¬ë‚˜ëŠ” ëŒ€ì‚¬
   - ì„œë¸Œí…ìŠ¤íŠ¸ (ë§í•˜ì§€ ì•Šì€ ê²ƒì˜ í˜)
   - ê¸°ì–µì— ë‚¨ëŠ” ëª…ëŒ€ì‚¬

4. ê°ˆë“±ê³¼ ê¸´ì¥
   - ì™¸ì  ê°ˆë“± (ì¸ë¬¼ vs ì¸ë¬¼, ìƒí™©)
   - ë‚´ì  ê°ˆë“± (ì¸ë¬¼ ë‚´ë©´ì˜ ì‹¸ì›€)
   - ì˜ˆìƒì¹˜ ëª»í•œ ë°˜ì „ê³¼ ì „ê°œ

ã€ ëŒ€ë³¸ í˜•ì‹ ã€‘
S#1. ì¥ì†Œ / ì‹œê°„

(ì¥ë©´ ì„¤ëª… - ê³µê°„, ë¶„ìœ„ê¸°, ì¸ë¬¼ ë°°ì¹˜)

ì¸ë¬¼ëª…: ëŒ€ì‚¬
ì¸ë¬¼ëª…: (ê°ì •/í–‰ë™) ëŒ€ì‚¬

ã€ ê¸ˆì§€ ì‚¬í•­ ã€‘
- ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸(#, *, -, **) ì‚¬ìš© ê¸ˆì§€
- ì§€ë£¨í•œ ì„¤ëª…ì´ë‚˜ ë…ë°±
- ìºë¦­í„° í–‰ë™ì˜ ì¼ê´€ì„± ë¶€ì¬
- ê²°ë§ë¡œ í–¥í•˜ëŠ” ê¸´ì¥ê° ì—†ì´ ëŠ˜ì–´ì§€ëŠ” ì „ê°œ`,

      userPromptSuffix: `

âš ï¸ ì¤‘ìš”: ì´ê²ƒì€ ë“œë¼ë§ˆ ëŒ€ë³¸ì…ë‹ˆë‹¤.
- ì‹œì²­ìê°€ ë‹¤ìŒ ì¥ë©´ì´ ê¶ê¸ˆí•´ì§€ë„ë¡ ê¸´ì¥ê°ì„ ìœ ì§€í•˜ì„¸ìš”
- ê° ìºë¦­í„°ì˜ ëª©ì†Œë¦¬ê°€ êµ¬ë¶„ë˜ì–´ì•¼ í•©ë‹ˆë‹¤
- ì¥ë©´ ì „í™˜ì´ ìì—°ìŠ¤ëŸ½ê³  ëª©ì ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤
- ì´¬ì˜ ê°€ëŠ¥í•œ ìˆ˜ì¤€ì˜ êµ¬ì²´ì ì¸ ì§€ë¬¸ì„ ì‘ì„±í•˜ì„¸ìš”`
    }
  };

  // í˜„ì¬ ì„ íƒëœ ì½˜í…ì¸  ìœ í˜•ì˜ í”„ë¡¬í”„íŠ¸ ê°€ì ¸ì˜¤ê¸°
  function getCurrentPrompt() {
    const contentType = document.getElementById('content-type')?.value || 'testimony';
    return contentTypePrompts[contentType] || contentTypePrompts.testimony;
  }

  // í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
  function updatePromptPreview() {
    const prompt = getCurrentPrompt();
    const previewEl = document.getElementById('prompt-preview-content');
    if (previewEl) {
      previewEl.textContent = `ã€ ${prompt.name} ëª¨ë“œ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ã€‘\n\n${prompt.systemPrompt}\n\nã€ ì¶”ê°€ ì§€ì‹œì‚¬í•­ ã€‘${prompt.userPromptSuffix}`;
    }
  }

  // í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸° í† ê¸€
  document.getElementById('btn-toggle-prompt-preview')?.addEventListener('click', function() {
    const container = document.getElementById('prompt-preview-container');
    if (container) {
      const isHidden = container.style.display === 'none';
      container.style.display = isHidden ? 'block' : 'none';
      this.textContent = isHidden ? 'ğŸ“ Step3 í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸° â–²' : 'ğŸ“ Step3 í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸° â–¼';
      if (isHidden) updatePromptPreview();
    }
  });

  // ì½˜í…ì¸  ìœ í˜• ë³€ê²½ ì‹œ í”„ë¡¬í”„íŠ¸ ì—…ë°ì´íŠ¸
  document.getElementById('content-type')?.addEventListener('change', updatePromptPreview);

  // ===== í•œê¸€ â†’ ì˜ë¬¸ ID ìë™ ìƒì„± =====
  function koreanToId(korean) {
    const map = {
      'ìºë¦­í„°': 'character',
      'ìŠ¤í† ë¦¬': 'storyline',
      'ì¤„ê±°ë¦¬': 'plot',
      'ëŒ€ì‚¬': 'dialogue',
      'ì¥ë©´': 'scene',
      'êµ¬ì„±': 'structure',
      'ì„¤ì •': 'setting',
      'ë¶„ì„': 'analysis',
      'ê°œìš”': 'outline',
      'ë…¸ë˜': 'song',
      'ì•ˆë¬´': 'choreography',
      'ì—°ì¶œ': 'direction'
    };

    for (const [key, value] of Object.entries(map)) {
      if (korean.includes(key)) {
        return value + '_' + Date.now().toString(36);
      }
    }

    return 'step_' + Date.now().toString(36);
  }

  // ===== ìœ í‹¸ë¦¬í‹° =====
  function showStatus(msg) {
    const statusBar = document.getElementById('status-bar');
    if (statusBar) {
      statusBar.textContent = msg;
      statusBar.style.display = 'block';
    }
  }

  function hideStatus() {
    const statusBar = document.getElementById('status-bar');
    if (statusBar) {
      statusBar.style.display = 'none';
    }
  }

  // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
  function showLoadingOverlay(text = 'AI ì‘ì—… ì¤‘', subtext = 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...') {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
      const textEl = overlay.querySelector('.loading-text');
      const subtextEl = overlay.querySelector('.loading-subtext');
      if (textEl) textEl.textContent = text;
      if (subtextEl) subtextEl.textContent = subtext;
      overlay.classList.add('show');
    }
  }

  // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
  function hideLoadingOverlay() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
      overlay.classList.remove('show');
    }
  }

  function autoResize(el) {
    if (!el) return;
    el.style.height = 'auto';
    el.style.height = el.scrollHeight + 'px';
  }

  // ===== Firebase í•¨ìˆ˜ =====
  async function loadFromFirebase() {
    try {
      const snapshot = await db.collection('users').doc(USER_CODE).collection(PAGE_NAME).get();

      if (!snapshot.empty) {
        snapshot.forEach(doc => {
          localStorage.setItem(doc.id, doc.data().value);
        });

        const configData = localStorage.getItem(CONFIG_KEY);
        if (configData) {
          config = JSON.parse(configData);
        }
        console.log('âœ… Firebase ë™ê¸°í™” ì™„ë£Œ');
        return true;
      }
      return false;
    } catch (err) {
      console.error('Firebase ë¡œë“œ ì‹¤íŒ¨:', err);
      return false;
    }
  }

  async function saveToFirebase(key, value) {
    try {
      await db.collection('users').doc(USER_CODE).collection(PAGE_NAME).doc(key).set({
        value: value,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      return true;
    } catch (err) {
      console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', err);
      return false;
    }
  }

  async function saveConfig() {
    const configStr = JSON.stringify(config);
    localStorage.setItem(CONFIG_KEY, configStr);
    await saveToFirebase(CONFIG_KEY, configStr);
  }

  // ===== ì´ê´„ ì§€ì¹¨ ê´€ë¦¬ =====
  function loadMasterGuide(category) {
    const settings = config.categorySettings[category];
    const textarea = document.getElementById('master-guide-text');
    if (textarea) {
      if (settings && settings.masterGuide) {
        textarea.value = settings.masterGuide;
      } else {
        textarea.value = '';
      }
      autoResize(textarea);
    }
  }

  async function saveMasterGuide() {
    const textarea = document.getElementById('master-guide-text');
    if (!textarea) return;

    const value = textarea.value;
    const settings = config.categorySettings[currentCategory];

    if (settings) {
      settings.masterGuide = value;
      await saveConfig();

      showStatus('âœ… ì´ê´„ ì§€ì¹¨ ì €ì¥ ì™„ë£Œ!');
      setTimeout(hideStatus, 2000);
    }
  }

  const saveMasterGuideBtn = document.getElementById('save-master-guide');
  if (saveMasterGuideBtn) {
    saveMasterGuideBtn.addEventListener('click', saveMasterGuide);
  }

  const toggleMasterGuideBtn = document.getElementById('toggle-master-guide');
  if (toggleMasterGuideBtn) {
    toggleMasterGuideBtn.addEventListener('click', () => {
      const content = document.getElementById('master-guide-content');
      const btn = document.getElementById('toggle-master-guide');

      if (content && btn) {
        if (content.style.display === 'none') {
          content.style.display = 'block';
          btn.textContent = 'ë‹«ê¸°';
          loadMasterGuide(currentCategory);
        } else {
          content.style.display = 'none';
          btn.textContent = 'ì—´ê¸°';
        }
      }
    });
  }

  // ===== ì§€ì¹¨ ê´€ë¦¬ =====
  function getGuideKey(category, stepId) {
    return `guide-${category}-${stepId}`;
  }

  function loadGuide(category, stepId) {
    const key = getGuideKey(category, stepId);
    const stored = localStorage.getItem(key) || '';
    const textarea = document.getElementById('guide-text');
    if (textarea) {
      textarea.value = stored;
      autoResize(textarea);
    }

    let info = `ìœ í˜•: ${getCategoryLabel(category)} | ë‹¨ê³„: ${getStepName(stepId)}`;
    const infoEl = document.getElementById('current-guide-info');
    if (infoEl) {
      infoEl.textContent = info;
    }
  }

  async function saveGuide() {
    const textarea = document.getElementById('guide-text');
    if (!textarea) return;

    const key = getGuideKey(currentCategory, currentGuideStep);
    const value = textarea.value;

    localStorage.setItem(key, value);

    showStatus('ğŸ’¾ ì €ì¥ ì¤‘...');
    const success = await saveToFirebase(key, value);

    if (success) {
      showStatus('âœ… ì§€ì¹¨ ì €ì¥ ì™„ë£Œ!');
    } else {
      showStatus('âš ï¸ ë¡œì»¬ì—ë§Œ ì €ì¥ë¨');
    }

    setTimeout(hideStatus, 2000);
  }

  // ===== í—¬í¼ í•¨ìˆ˜ =====
  function getCategoryLabel(value) {
    const cat = config.categories.find(c => c.value === value);
    return cat ? cat.label : value;
  }

  function getCurrentSteps() {
    if (!config.unifiedSteps) return [];
    return config.unifiedSteps.sort((a, b) => a.order - b.order);
  }

  function getStepName(stepId) {
    const steps = getCurrentSteps();
    const step = steps.find(s => s.id === stepId);
    return step ? step.name : stepId;
  }

  // ===== GPT PRO ì´ˆì•ˆ êµ¬ì„± ìœ í‹¸ =====
  function assembleGptProDraft() {
    const steps = getCurrentSteps();
    const benchmarkScript = document.getElementById('benchmark-script').value.trim();
    const mainCharacter = document.getElementById('main-character').value.trim();

    if (steps.length === 0) {
      return { error: 'ì²˜ë¦¬ëœ ë‹¨ê³„ê°€ ì—†ìŠµë‹ˆë‹¤.' };
    }

    const completedSteps = steps.filter(step => stepResults[step.id]);

    if (completedSteps.length === 0) {
      return { error: 'ì™„ì„±ëœ ë‹¨ê³„ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê° ë‹¨ê³„ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.' };
    }

    const categoryLabel = getCategoryLabel(currentCategory);

    let fullText = `====================================\n`;
    fullText += `ğŸ­ ë“œë¼ë§ˆ ìŠ¤í¬ë¦½íŠ¸ ì´ˆì•ˆ ìë£Œ (GPT-5.1 ì‘ì„±ìš©)\n`;
    fullText += `====================================\n\n`;
    fullText += `âš ï¸ ì¤‘ìš”: ì´ ìë£ŒëŠ” gpt-4o-miniê°€ ë§Œë“  'ì´ˆì•ˆ'ì…ë‹ˆë‹¤.\n`;
    fullText += `GPT-5.1ì€ ì´ ìë£Œë¥¼ ì°¸ê³ í•˜ë˜, ì²˜ìŒë¶€í„° ìƒˆë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n`;
    fullText += `miniê°€ ë§Œë“  ë¬¸ì¥ì„ ê·¸ëŒ€ë¡œ ë³µì‚¬í•˜ì§€ ë§ê³ , ìì—°ìŠ¤ëŸ¬ìš´ ë“œë¼ë§ˆ ìŠ¤í¬ë¦½íŠ¸ë¡œ ì¬ì‘ì„±í•˜ì„¸ìš”.\n\n`;
    fullText += `${'='.repeat(50)}\n\n`;
    fullText += `ğŸ“Œ ê¸°ë³¸ ì •ë³´\n`;
    fullText += `- ì˜ìƒ ì‹œê°„: ${categoryLabel}\n`;
    if (mainCharacter) {
      fullText += `- ì£¼ì¸ê³µ: ${mainCharacter}\n`;
    }
    if (benchmarkScript) {
      fullText += `- ë²¤ì¹˜ë§ˆí‚¹ ëŒ€ë³¸: ì²¨ë¶€ë¨\n`;
    }
    fullText += `- ì‘ì„±ì¼: ${new Date().toLocaleDateString('ko-KR')}\n`;
    fullText += `\n${'='.repeat(50)}\n\n`;

    if (benchmarkScript) {
      fullText += `ã€ ë²¤ì¹˜ë§ˆí‚¹ ëŒ€ë³¸ ã€‘\n\n`;
      fullText += benchmarkScript;
      fullText += `\n\n${'='.repeat(50)}\n\n`;
    }

    let sectionIndex = 1;
    completedSteps.forEach(step => {
      fullText += `ã€ ${sectionIndex}. ${step.name} ã€‘\n\n`;
      fullText += stepResults[step.id];
      fullText += `\n\n${'='.repeat(50)}\n\n`;
      sectionIndex += 1;
    });

    fullText += `\nğŸ“ ì‘ì„± ì§€ì¹¨:\n`;
    fullText += `ìœ„ì˜ ì´ˆì•ˆ ìë£Œë¥¼ ì°¸ê³ í•˜ì—¬, ì™„ì„±ë„ ë†’ì€ ë“œë¼ë§ˆ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì²˜ìŒë¶€í„° ìƒˆë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n`;

    return {
      error: null,
      fullText,
      draftContent: fullText,
      meta: {
        benchmarkScript,
        mainCharacter,
        categoryLabel
      }
    };
  }

  // ===== ì „ì²´ ë³µì‚¬ ê¸°ëŠ¥ =====
  const btnCopyAll = document.getElementById('btn-copy-all');
  if (btnCopyAll) {
    btnCopyAll.addEventListener('click', () => {
      const draft = assembleGptProDraft();
      if (draft.error) {
        alert(draft.error);
        return;
      }

      const tempTextarea = document.createElement('textarea');
      tempTextarea.value = draft.fullText;
      tempTextarea.style.position = 'fixed';
      tempTextarea.style.opacity = '0';
      document.body.appendChild(tempTextarea);
      tempTextarea.select();

      try {
        document.execCommand('copy');
        showStatus('âœ… GPT-5.1ì— ë¶™ì—¬ë„£ì„ ì¤€ë¹„ ì™„ë£Œ!');
        setTimeout(hideStatus, 2000);
      } catch (err) {
        alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err.message);
      } finally {
        document.body.removeChild(tempTextarea);
      }
    });
  }

  // ===== GPT PRO ì²˜ë¦¬ ê¸°ëŠ¥ =====
  async function executeGptPro() {
    const draft = assembleGptProDraft();
    if (draft.error) {
      alert(draft.error);
      return;
    }

    // ===== 1ë‹¨ê³„: ì „ì²´ ë³µì‚¬ =====
    const tempTextarea = document.createElement('textarea');
    tempTextarea.value = draft.fullText;
    tempTextarea.style.position = 'fixed';
    tempTextarea.style.opacity = '0';
    document.body.appendChild(tempTextarea);
    tempTextarea.select();

    try {
      document.execCommand('copy');
      showStatus('ğŸ“‹ ì „ì²´ ë³µì‚¬ ì™„ë£Œ! GPT PRO ì²˜ë¦¬ ì¤‘...');
    } catch (err) {
      console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
    } finally {
      document.body.removeChild(tempTextarea);
    }

    // ===== 2ë‹¨ê³„: GPT-5.1ë¡œ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± =====
    showStatus('ğŸš€ GPT PRO ì²˜ë¦¬ ì¤‘... (ì•½ 30ì´ˆ ì†Œìš”)');

    try {
      const response = await fetch('/api/drama/gpt-pro', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          mainCharacter: draft.meta.mainCharacter,
          category: draft.meta.categoryLabel,
          draftContent: draft.draftContent
        })
      });

      const data = await response.json();

      if (data.ok) {
        const resultTextarea = document.getElementById('gpt-pro-result');
        const resultContainer = document.getElementById('gpt-pro-result-container');

        if (resultTextarea && resultContainer) {
          resultTextarea.value = data.result;
          autoResize(resultTextarea);
          resultContainer.style.display = 'block';

          // ê²°ê³¼ ë°•ìŠ¤ë¡œ ìŠ¤í¬ë¡¤
          resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        showStatus('âœ… ì „ì²´ ë³µì‚¬ + GPT PRO ì™„ì„±!');
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
        showStatus('âŒ ì‹¤íŒ¨');
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
      showStatus('âŒ ì˜¤ë¥˜');
    } finally {
      setTimeout(hideStatus, 3000);
    }
  }

  const btnGptPro = document.getElementById('btn-gpt-pro');
  if (btnGptPro) {
    btnGptPro.addEventListener('click', () => {
      if (!gptProUnlocked) {
        // íŒ¨ìŠ¤ì›Œë“œ ëª¨ë‹¬ í‘œì‹œ
        const modal = document.getElementById('modal-gpt-pro-password');
        if (modal) modal.classList.add('show');
        const input = document.getElementById('gpt-pro-password-input');
        if (input) {
          input.value = '';
          input.focus();
        }
      } else {
        // ì´ë¯¸ ì ê¸ˆ í•´ì œëœ ê²½ìš° ë°”ë¡œ ì‹¤í–‰
        executeGptPro();
      }
    });
  }

  // GPT PRO ê²°ê³¼ ë³µì‚¬
  const btnCopyGptPro = document.getElementById('btn-copy-gpt-pro');
  if (btnCopyGptPro) {
    btnCopyGptPro.addEventListener('click', () => {
      const textarea = document.getElementById('gpt-pro-result');
      if (textarea && textarea.value) {
        textarea.select();
        document.execCommand('copy');
        const orig = btnCopyGptPro.textContent;
        btnCopyGptPro.textContent = 'âœ… ë³µì‚¬ë¨!';
        setTimeout(() => btnCopyGptPro.textContent = orig, 1500);
      }
    });
  }

  // ===== ì „ì²´ ì§„í–‰ ìƒí™© ê´€ë¦¬ =====
  const completedSteps = new Set();

  function updateProgressIndicator(stepName) {
    completedSteps.add(stepName);

    // ê° ë‹¨ê³„ í‘œì‹œ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.progress-step').forEach(stepEl => {
      const step = stepEl.dataset.step;
      const innerDiv = stepEl.querySelector('div');
      if (completedSteps.has(step)) {
        innerDiv.style.background = '#27ae60';
        innerDiv.style.fontWeight = '700';
      }
    });

    // ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    const statusEl = document.getElementById('progress-status');
    const stepMessages = {
      step1: 'Step2ë¡œ ì§„í–‰í•˜ì„¸ìš”',
      step2: 'Step3 ëŒ€ë³¸ ì™„ì„±ì„ ì‹¤í–‰í•˜ì„¸ìš”',
      step3: 'Step4(ì´ë¯¸ì§€) + Step5(ìŒì„±)ì„ ì§„í–‰í•˜ì„¸ìš”',
      step4: completedSteps.has('step5') ? 'Step6 ì˜ìƒ ìƒì„± ê°€ëŠ¥!' : 'Step5 ìŒì„± ìƒì„±ì„ ì§„í–‰í•˜ì„¸ìš”',
      step5: completedSteps.has('step4') ? 'Step6 ì˜ìƒ ìƒì„± ê°€ëŠ¥!' : 'Step4 ì´ë¯¸ì§€ ìƒì„±ì„ ì§„í–‰í•˜ì„¸ìš”',
      step6: 'Step7 YouTube ì—…ë¡œë“œ ê°€ëŠ¥!',
      step7: 'ëª¨ë“  ë‹¨ê³„ ì™„ë£Œ!'
    };
    if (statusEl) {
      statusEl.textContent = stepMessages[stepName] || '';
    }
  }

  // Step3 ì™„ë£Œ í›„ Step4/Step5 ìë™ í™œì„±í™”
  function activateNextSteps(scriptContent) {
    // Step4 ì»¨í…Œì´ë„ˆ í‘œì‹œ
    const step4Container = document.getElementById('step4-container');
    if (step4Container) {
      step4Container.style.display = 'block';
    }

    // Step5 TTS í…ìŠ¤íŠ¸ ìë™ ì±„ìš°ê¸° (ì§€ë¬¸ë§Œ ì¶”ì¶œ)
    if (scriptContent) {
      const ttsTextarea = document.getElementById('step5-script-text');
      if (ttsTextarea && !ttsTextarea.value.trim()) {
        // ì§€ë¬¸ë§Œ ì¶”ì¶œ (ê´„í˜¸ ì•ˆì˜ ë‚´ìš© ë˜ëŠ” ë‚˜ë ˆì´ì…˜)
        const narrationText = extractNarrationFromScript(scriptContent);
        if (narrationText) {
          ttsTextarea.value = narrationText;
        }
      }
    }

    // ì•ˆë‚´ í† ìŠ¤íŠ¸ í‘œì‹œ
    showNextStepGuide();
  }

  // ëŒ€ë³¸ì—ì„œ ì§€ë¬¸(ë‚˜ë ˆì´ì…˜) ì¶”ì¶œ
  function extractNarrationFromScript(script) {
    const lines = script.split('\n');
    const narrations = [];

    for (const line of lines) {
      const trimmed = line.trim();
      // ê´„í˜¸ë¡œ ì‹œì‘í•˜ëŠ” ì§€ë¬¸ (ì˜ˆ: (ì–´ë‘ìš´ ë°© ì•ˆ...))
      if (trimmed.startsWith('(') && trimmed.endsWith(')')) {
        narrations.push(trimmed.slice(1, -1));
      }
      // ëŒ€ê´„í˜¸ ì§€ë¬¸ (ì˜ˆ: [ë‚˜ë ˆì´ì…˜] ë˜ëŠ” [ì¥ë©´ ì„¤ëª…])
      else if (trimmed.startsWith('[') && (trimmed.includes('ë‚˜ë ˆì´ì…˜') || trimmed.includes('ì¥ë©´'))) {
        const content = trimmed.replace(/\[.*?\]/g, '').trim();
        if (content) narrations.push(content);
      }
      // "ì§€ë¬¸:" ë˜ëŠ” "ë‚˜ë ˆì´ì…˜:" ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ì¤„
      else if (trimmed.startsWith('ì§€ë¬¸:') || trimmed.startsWith('ë‚˜ë ˆì´ì…˜:')) {
        narrations.push(trimmed.replace(/^(ì§€ë¬¸|ë‚˜ë ˆì´ì…˜):?\s*/, ''));
      }
    }

    return narrations.join('\n\n');
  }

  // ë‹¤ìŒ ë‹¨ê³„ ì•ˆë‚´ ê°€ì´ë“œ í‘œì‹œ
  function showNextStepGuide() {
    // ì•ˆë‚´ ë°°ë„ˆ ìƒì„±
    const guideEl = document.createElement('div');
    guideEl.id = 'next-step-guide';
    guideEl.innerHTML = `
      <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 1rem; border-radius: 8px; margin: .75rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <div style="color: white; font-weight: 700; font-size: 1rem; margin-bottom: .5rem;">ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•˜ì„¸ìš”!</div>
        <div style="color: rgba(255,255,255,0.95); font-size: .85rem; line-height: 1.5;">
          <div style="margin-bottom: .3rem;"><strong>Step4:</strong> ëŒ€ë³¸ì—ì„œ ì¸ë¬¼ì„ ì¶”ì¶œí•˜ê³  ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ì„¸ìš”</div>
          <div><strong>Step5:</strong> TTS ìŒì„±ê³¼ ìë§‰ì„ ìƒì„±í•˜ì„¸ìš” (í…ìŠ¤íŠ¸ê°€ ìë™ ì…ë ¥ë¨)</div>
          <div style="margin-top: .5rem; font-size: .75rem; opacity: 0.8;">Step4ì™€ Step5ëŠ” ë™ì‹œì— ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
        </div>
        <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: .5rem; right: .5rem; background: rgba(255,255,255,0.3); border: none; color: white; padding: .25rem .5rem; border-radius: 4px; cursor: pointer; font-size: .75rem;">ë‹«ê¸°</button>
      </div>
    `;
    guideEl.style.position = 'relative';

    // Step4 ì»¨í…Œì´ë„ˆ ì•ì— ì‚½ì…
    const step4Container = document.getElementById('step4-container');
    if (step4Container && step4Container.parentNode) {
      step4Container.parentNode.insertBefore(guideEl, step4Container);

      // 5ì´ˆ í›„ ìë™ ì œê±°
      setTimeout(() => {
        guideEl.remove();
      }, 8000);

      // Step4ë¡œ ìŠ¤í¬ë¡¤
      setTimeout(() => {
        step4Container.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 500);
    }
  }

  // ===== Step3 (OpenRouter) ëŒ€ë³¸ ì™„ì„± ê¸°ëŠ¥ =====
  async function executeStep3() {
    // Step2 ê²°ê³¼ë§Œ ìˆ˜ì§‘ (Step2ì—ì„œ ìƒˆë¡œìš´ ëŒ€ë³¸ ì œì‘í•œ ê²°ê³¼)
    let draftContent = '';
    let hasResults = false;

    // ë””ë²„ê·¸: workflowBoxes ìƒíƒœ í™•ì¸
    console.log('[Step3 Debug] workflowBoxes ì „ì²´:', workflowBoxes);
    console.log('[Step3 Debug] Step2 ë°•ìŠ¤ ëª©ë¡:', workflowBoxes.filter(b => b.stepType === 'step2'));
    workflowBoxes.forEach(box => {
      console.log(`[Step3 Debug] Box ${box.id}: stepType=${box.stepType}, hasResult=${!!box.result}, resultLength=${box.result?.length || 0}`);
    });

    workflowBoxes.forEach(box => {
      // Step2 ë°•ìŠ¤ë§Œ ìˆ˜ì§‘
      if (box.stepType === 'step2' && box.result) {
        hasResults = true;
        draftContent += `\n\n${'='.repeat(50)}\n`;
        draftContent += `[Step2] ${box.name}\n`;
        draftContent += `${'='.repeat(50)}\n\n`;
        draftContent += box.result;
      }
    });

    console.log('[Step3 Debug] hasResults:', hasResults);
    console.log('[Step3 Debug] draftContent length:', draftContent.length);
    console.log('[Step3 Debug] draftContent preview:', draftContent.substring(0, 500));

    if (!hasResults) {
      alert('Step2 ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € Step2 ë°•ìŠ¤ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
      return;
    }

    // ê¸°ë³¸ ì •ë³´ ìˆ˜ì§‘
    const categorySelect = document.getElementById('drama-category');
    const categoryLabel = categorySelect ? categorySelect.options[categorySelect.selectedIndex].text : '';
    const mainCharacterInput = document.getElementById('main-character');
    const mainCharacter = mainCharacterInput ? mainCharacterInput.value : '';
    const benchmarkScript = document.getElementById('benchmark-script')?.value || '';
    const analysisResult = document.getElementById('analysis-result')?.textContent || '';

    // â­ ëª¨ë‹¬ textareaì—ì„œ ìµœì‹  step3Guide ê°’ì„ ê°€ì ¸ì˜´ (ì €ì¥ ì•ˆí•´ë„ ë°˜ì˜ë˜ë„ë¡)
    const step3GuideTextarea = document.getElementById('modal-guide-step3');
    const currentStep3Guide = step3GuideTextarea ? step3GuideTextarea.value : step3Guide;

    // ë””ë²„ê·¸: step3Guide ê°’ í™•ì¸
    console.log('[Step3 Debug] textarea exists:', !!step3GuideTextarea);
    console.log('[Step3 Debug] textarea value:', step3GuideTextarea?.value);
    console.log('[Step3 Debug] global step3Guide:', step3Guide);
    console.log('[Step3 Debug] currentStep3Guide to send:', currentStep3Guide);

    // ë¡œë”© í‘œì‹œ
    showLoadingOverlay('OpenRouter ëŒ€ë³¸ ì™„ì„± ì¤‘', 'AIê°€ ëŒ€ë³¸ì„ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
    showStatus('ğŸ¬ Step3: OpenRouter ëŒ€ë³¸ ì™„ì„± ì¤‘... (ì•½ 30-60ì´ˆ ì†Œìš”)');

    // ì½˜í…ì¸  ìœ í˜• ê°€ì ¸ì˜¤ê¸° (ê°„ì¦/ë“œë¼ë§ˆ)
    const contentType = document.getElementById('content-type')?.value || 'testimony';
    const promptData = contentTypePrompts[contentType] || contentTypePrompts.testimony;

    try {
      const response = await fetch('/api/drama/claude-step3', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          category: categoryLabel,
          draftContent: draftContent,
          mainCharacter: { name: mainCharacter },
          benchmarkScript: benchmarkScript,
          aiAnalysis: analysisResult,
          step3Guide: currentStep3Guide,  // â­ ìµœì‹  ê°’ ì‚¬ìš©
          model: aiModelSettings.step3,  // ì„ íƒëœ ëª¨ë¸ ì „ë‹¬
          contentType: contentType,  // ì½˜í…ì¸  ìœ í˜• (testimony/drama)
          contentTypePrompt: promptData  // ìœ í˜•ë³„ í”„ë¡¬í”„íŠ¸ ë°ì´í„°
        })
      });

      const data = await response.json();

      if (data.ok) {
        const resultTextarea = document.getElementById('step3-result');
        const resultContainer = document.getElementById('step3-result-container');
        const tokenInfo = document.getElementById('step3-token-info');

        if (resultTextarea && resultContainer) {
          resultTextarea.value = data.result;
          autoResize(resultTextarea);
          resultContainer.style.display = 'block';

          // â­ Step3 ê²°ê³¼ ì €ì¥ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ ìœ ì§€)
          step3Result = data.result;
          localStorage.setItem('_drama-step3-result', step3Result);
          saveToFirebase('_drama-step3-result', step3Result);

          // â­ ì„¸ì…˜ì— ëŒ€ë³¸ ì €ì¥
          updateSession('step3.script', step3Result);

          // â­ ë©”íƒ€ë°ì´í„° ìë™ ìƒì„± (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰)
          generateMetadataFromScript(step3Result, contentType);

          // í† í° ì •ë³´ ë° ë¹„ìš© í‘œì‹œ
          if (data.usage && tokenInfo) {
            document.getElementById('step3-input-tokens').textContent = data.usage.input_tokens?.toLocaleString() || '0';
            document.getElementById('step3-output-tokens').textContent = data.usage.output_tokens?.toLocaleString() || '0';
            // ë¹„ìš© ê³„ì‚°
            const cost = calculateCost(aiModelSettings.step3, data.usage.input_tokens || 0, data.usage.output_tokens || 0);
            document.getElementById('step3-cost').textContent = cost ? 'â‚©' + cost.totalCostKRW : '-';
            tokenInfo.style.display = 'block';
          }

          // ê²°ê³¼ ë°•ìŠ¤ë¡œ ìŠ¤í¬ë¡¤
          resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

          // Step4/Step5 ìë™ í™œì„±í™” ë° ì•ˆë‚´
          activateNextSteps(step3Result);
        }

        showStatus('âœ… Step3: OpenRouter ëŒ€ë³¸ ì™„ì„±!');
        updateProgressIndicator('step3');
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
        showStatus('âŒ Step3 ì‹¤íŒ¨');
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
      showStatus('âŒ Step3 ì˜¤ë¥˜');
    } finally {
      hideLoadingOverlay();
      setTimeout(hideStatus, 3000);
    }
  }

  // Step3 ì‹¤í–‰ ë²„íŠ¼ ì´ë²¤íŠ¸
  const btnExecuteStep3 = document.getElementById('btn-execute-step3');
  if (btnExecuteStep3) {
    btnExecuteStep3.addEventListener('click', executeStep3);
  }

  // Step3 ê²°ê³¼ ë³µì‚¬ ë²„íŠ¼ ì´ë²¤íŠ¸
  const btnCopyStep3Result = document.getElementById('btn-copy-step3-result');
  if (btnCopyStep3Result) {
    btnCopyStep3Result.addEventListener('click', () => {
      const textarea = document.getElementById('step3-result');
      if (textarea && textarea.value) {
        textarea.select();
        document.execCommand('copy');
        const orig = btnCopyStep3Result.textContent;
        btnCopyStep3Result.textContent = 'âœ… ë³µì‚¬ë¨!';
        setTimeout(() => btnCopyStep3Result.textContent = orig, 1500);
        showStatus('âœ… Step3 ê²°ê³¼ ë³µì‚¬ ì™„ë£Œ!');
        setTimeout(hideStatus, 2000);
      } else {
        alert('ë³µì‚¬í•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
      }
    });
  }

  // Step3 ê²°ê³¼ ì§€ìš°ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
  const btnClearStep3Result = document.getElementById('btn-clear-step3-result');
  if (btnClearStep3Result) {
    btnClearStep3Result.addEventListener('click', () => {
      if (confirm('Step3 ê²°ê³¼ë¥¼ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const resultTextarea = document.getElementById('step3-result');
        const resultContainer = document.getElementById('step3-result-container');
        const tokenInfo = document.getElementById('step3-token-info');

        if (resultTextarea) resultTextarea.value = '';
        if (resultContainer) resultContainer.style.display = 'none';
        if (tokenInfo) tokenInfo.style.display = 'none';

        // â­ ì €ì¥ëœ Step3 ê²°ê³¼ë„ ì‚­ì œ
        step3Result = '';
        localStorage.removeItem('_drama-step3-result');
        saveToFirebase('_drama-step3-result', '');

        showStatus('ğŸ—‘ï¸ Step3 ê²°ê³¼ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.');
        setTimeout(hideStatus, 2000);
      }
    });
  }

  // ===== Step4: ì´ë¯¸ì§€ ìƒì„± ê¸°ëŠ¥ (ì—…ê·¸ë ˆì´ë“œ ë²„ì „) =====
  let step4GeneratedImages = JSON.parse(localStorage.getItem('_drama-step4-images') || '[]');
  let step4Characters = JSON.parse(localStorage.getItem('_drama-step4-characters') || '[]');
  let step4CharacterImages = JSON.parse(localStorage.getItem('_drama-step4-character-images') || '{}');
  let step4Scenes = JSON.parse(localStorage.getItem('_drama-step4-scenes') || '[]');
  let step4ImageProvider = 'flux';  // ê¸°ë³¸: FLUX.1 Pro

  // ì´ë¯¸ì§€ ëª¨ë¸ ì„ íƒ ì´ë²¤íŠ¸
  document.querySelectorAll('.step4-image-provider').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.step4-image-provider').forEach(b => {
        b.classList.remove('selected');
        b.style.border = '2px solid #ddd';
        b.style.background = 'white';
      });
      btn.classList.add('selected');
      btn.style.border = '2px solid #10b981';
      btn.style.background = 'rgba(16,185,129,0.2)';

      step4ImageProvider = btn.dataset.provider;

      // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      const btnGenerateImage = document.getElementById('btn-generate-image');
      if (btnGenerateImage) {
        const modelName = step4ImageProvider === 'flux' ? 'FLUX.1 Pro' : 'DALL-E 3';
        btnGenerateImage.textContent = `ğŸ–¼ï¸ ì”¬ ì´ë¯¸ì§€ ìƒì„± (${modelName})`;
      }
    });
  });

  // Step3 ê²°ê³¼ê°€ ìˆìœ¼ë©´ Step4 ì»¨í…Œì´ë„ˆ í‘œì‹œ
  function updateStep4Visibility() {
    const step4Container = document.getElementById('step4-container');
    const step3Result = document.getElementById('step3-result')?.value || '';
    if (step4Container) {
      step4Container.style.display = step3Result.trim() ? 'block' : 'none';
    }
  }

  // Step3 ê²°ê³¼ ë³€ê²½ ê°ì§€
  const step3ResultTextarea = document.getElementById('step3-result');
  if (step3ResultTextarea) {
    const observer = new MutationObserver(updateStep4Visibility);
    observer.observe(step3ResultTextarea, { attributes: true, childList: true, subtree: true });
    setInterval(updateStep4Visibility, 1000);
  }

  // 1ë‹¨ê³„: ë“±ì¥ì¸ë¬¼ ë¶„ì„
  async function analyzeCharacters() {
    const step3Result = document.getElementById('step3-result')?.value || '';
    if (!step3Result.trim()) {
      alert('ë¨¼ì € Step3 ëŒ€ë³¸ ì™„ì„±ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
      return;
    }

    const btn = document.getElementById('btn-analyze-characters');
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'â³ ë¶„ì„ ì¤‘...';
    }

    showStatus('ğŸ” ëŒ€ë³¸ì—ì„œ ë“±ì¥ì¸ë¬¼ ë¶„ì„ ì¤‘...');
    showLoadingOverlay();

    try {
      const response = await fetch('/api/drama/analyze-characters', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ script: step3Result })
      });

      const data = await response.json();

      if (data.ok) {
        step4Characters = data.characters || [];
        step4Scenes = data.scenes || [];
        localStorage.setItem('_drama-step4-characters', JSON.stringify(step4Characters));
        localStorage.setItem('_drama-step4-scenes', JSON.stringify(step4Scenes));

        renderCharactersList();
        updateCharacterSelect();
        updateSceneSelect();
        updateSceneCharacterCheckboxes();

        showStatus(`âœ… ${step4Characters.length}ëª…ì˜ ë“±ì¥ì¸ë¬¼, ${step4Scenes.length}ê°œì˜ ì”¬ ë¶„ì„ ì™„ë£Œ!`);
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
        showStatus('âŒ ë¶„ì„ ì‹¤íŒ¨');
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
      showStatus('âŒ ë¶„ì„ ì˜¤ë¥˜');
    } finally {
      hideLoadingOverlay();
      setTimeout(hideStatus, 3000);
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'ğŸ” ëŒ€ë³¸ì—ì„œ ì¸ë¬¼ ì¶”ì¶œ';
      }
    }
  }

  // ë“±ì¥ì¸ë¬¼ ëª©ë¡ ë Œë”ë§
  function renderCharactersList() {
    const container = document.getElementById('step4-characters-list');
    if (!container) return;

    if (step4Characters.length === 0) {
      container.innerHTML = '<div style="color: #999; text-align: center; font-size: .85rem;">ëŒ€ë³¸ì„ ë¶„ì„í•˜ë©´ ë“±ì¥ì¸ë¬¼ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>';
      return;
    }

    container.innerHTML = step4Characters.map((char, idx) => `
      <div style="background: #f8f9fa; padding: .5rem; border-radius: 6px; margin-bottom: .5rem; border-left: 4px solid #27ae60;">
        <div style="font-weight: 600; color: #333; margin-bottom: .25rem;">
          ğŸ‘¤ ${char.name}
          ${step4CharacterImages[char.name] ? '<span style="color: #27ae60; font-size: .8rem;">âœ… ì´ë¯¸ì§€ ìƒì„±ë¨</span>' : ''}
        </div>
        <div style="font-size: .85rem; color: #666;">${char.description}</div>
        <div style="font-size: .8rem; color: #888; margin-top: .25rem;">
          <strong>í”„ë¡¬í”„íŠ¸:</strong> ${char.imagePrompt || '(ìƒì„± ì „)'}
        </div>
      </div>
    `).join('');
  }

  // ì¸ë¬¼ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
  function updateCharacterSelect() {
    const select = document.getElementById('step4-character-select');
    if (!select) return;

    select.innerHTML = '<option value="">-- ì¸ë¬¼ ì„ íƒ --</option>' +
      step4Characters.map((char, idx) => `<option value="${idx}">${char.name}</option>`).join('');
  }

  // ì¸ë¬¼ ì„ íƒ ì‹œ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
  document.getElementById('step4-character-select')?.addEventListener('change', function() {
    const idx = parseInt(this.value);
    const promptArea = document.getElementById('step4-character-prompt');
    if (!isNaN(idx) && step4Characters[idx] && promptArea) {
      promptArea.value = step4Characters[idx].imagePrompt || '';
    }
  });

  // 2ë‹¨ê³„: ì¸ë¬¼ ì´ë¯¸ì§€ ìƒì„±
  async function generateCharacterImage() {
    const selectEl = document.getElementById('step4-character-select');
    const idx = parseInt(selectEl?.value);

    if (isNaN(idx) || !step4Characters[idx]) {
      alert('ì¸ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    const characterPrompt = document.getElementById('step4-character-prompt')?.value || step4Characters[idx].imagePrompt;
    if (!characterPrompt?.trim()) {
      alert('ì¸ë¬¼ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const btn = document.getElementById('btn-generate-character-image');
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'â³ ìƒì„± ì¤‘...';
    }

    showStatus(`ğŸ–¼ï¸ ${step4Characters[idx].name} ì´ë¯¸ì§€ ìƒì„± ì¤‘...`);
    showLoadingOverlay();

    try {
      const response = await fetch('/api/drama/generate-image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          prompt: characterPrompt + ', portrait style, high quality, detailed face, professional lighting',
          size: '1024x1024',
          imageProvider: step4ImageProvider
        })
      });

      const data = await response.json();

      if (data.ok) {
        // ì¸ë¬¼ ì´ë¯¸ì§€ ì €ì¥
        step4CharacterImages[step4Characters[idx].name] = {
          url: data.imageUrl,
          prompt: characterPrompt,
          createdAt: new Date().toISOString()
        };
        localStorage.setItem('_drama-step4-character-images', JSON.stringify(step4CharacterImages));

        // ì¸ë¬¼ ì´ë¯¸ì§€ í‘œì‹œ
        renderCharacterImages();
        renderCharactersList();

        showStatus(`âœ… ${step4Characters[idx].name} ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ!`);
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
        showStatus('âŒ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨');
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
      showStatus('âŒ ì´ë¯¸ì§€ ìƒì„± ì˜¤ë¥˜');
    } finally {
      hideLoadingOverlay();
      setTimeout(hideStatus, 3000);
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'ğŸ–¼ï¸ ì¸ë¬¼ ì´ë¯¸ì§€ ìƒì„±';
      }
    }
  }

  // ì¸ë¬¼ ì´ë¯¸ì§€ ë Œë”ë§
  function renderCharacterImages() {
    const container = document.getElementById('step4-character-images');
    if (!container) return;

    const images = Object.entries(step4CharacterImages);
    if (images.length === 0) {
      container.innerHTML = '';
      return;
    }

    container.innerHTML = images.map(([name, data]) => `
      <div style="background: #f8f9fa; padding: .5rem; border-radius: 6px; text-align: center;">
        <img src="${data.url}" alt="${name}" style="width: 100%; max-width: 150px; border-radius: 6px; cursor: pointer;" onclick="window.open('${data.url}', '_blank')">
        <div style="font-size: .8rem; font-weight: 600; margin-top: .25rem;">${name}</div>
        <button onclick="downloadImage('${data.url}')" style="margin-top: .25rem; padding: .2rem .4rem; font-size: .7rem; cursor: pointer;">ğŸ’¾ ì €ì¥</button>
      </div>
    `).join('');
  }

  // ì”¬ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
  function updateSceneSelect() {
    const select = document.getElementById('step4-scene-select');
    if (!select) return;

    select.innerHTML = '<option value="">-- ì”¬ ì„ íƒ --</option>' +
      step4Scenes.map((scene, idx) => `<option value="${idx}">ì”¬ ${idx + 1}: ${scene.title || scene.location || 'ì¥ë©´'}</option>`).join('');
  }

  // ì”¬ì— ë“±ì¥í•˜ëŠ” ì¸ë¬¼ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
  function updateSceneCharacterCheckboxes() {
    const container = document.getElementById('step4-scene-characters');
    if (!container) return;

    if (step4Characters.length === 0) {
      container.innerHTML = '<span style="color: rgba(255,255,255,0.6); font-size: .85rem;">ì¸ë¬¼ ë¶„ì„ í›„ ì„ íƒ ê°€ëŠ¥</span>';
      return;
    }

    container.innerHTML = step4Characters.map((char, idx) => `
      <label style="display: flex; align-items: center; gap: .25rem; background: rgba(255,255,255,0.9); padding: .3rem .5rem; border-radius: 4px; cursor: pointer; font-size: .85rem;">
        <input type="checkbox" class="scene-character-checkbox" data-name="${char.name}" checked>
        ${char.name}
      </label>
    `).join('');
  }

  // ì”¬ ì„ íƒ ì‹œ í”„ë¡¬í”„íŠ¸ ìƒì„±
  document.getElementById('step4-scene-select')?.addEventListener('change', function() {
    const idx = parseInt(this.value);
    if (!isNaN(idx) && step4Scenes[idx]) {
      document.getElementById('step4-background-prompt').value = step4Scenes[idx].backgroundPrompt || '';
    }
  });

  // 3ë‹¨ê³„: ì”¬ í”„ë¡¬í”„íŠ¸ ìƒì„±
  async function generateScenePrompt() {
    const sceneSelect = document.getElementById('step4-scene-select');
    const idx = parseInt(sceneSelect?.value);

    if (isNaN(idx) || !step4Scenes[idx]) {
      alert('ì”¬ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    // ì„ íƒëœ ì¸ë¬¼ë“¤ ê°€ì ¸ì˜¤ê¸°
    const selectedCharacters = [];
    document.querySelectorAll('.scene-character-checkbox:checked').forEach(cb => {
      const name = cb.dataset.name;
      if (step4CharacterImages[name]) {
        selectedCharacters.push({
          name: name,
          prompt: step4CharacterImages[name].prompt
        });
      } else {
        const char = step4Characters.find(c => c.name === name);
        if (char) {
          selectedCharacters.push({
            name: name,
            prompt: char.imagePrompt
          });
        }
      }
    });

    const btn = document.getElementById('btn-generate-scene-prompt');
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'â³ ìƒì„± ì¤‘...';
    }

    showStatus('ğŸ“ ì”¬ í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...');
    showLoadingOverlay();

    try {
      const response = await fetch('/api/drama/generate-scene-prompt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          scene: step4Scenes[idx],
          characters: selectedCharacters,
          backgroundPrompt: document.getElementById('step4-background-prompt')?.value || ''
        })
      });

      const data = await response.json();

      if (data.ok) {
        document.getElementById('step4-combined-prompt').value = data.combinedPrompt || '';
        if (data.backgroundPrompt) {
          document.getElementById('step4-background-prompt').value = data.backgroundPrompt;
        }
        showStatus('âœ… ì”¬ í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ!');
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
        showStatus('âŒ í”„ë¡¬í”„íŠ¸ ìƒì„± ì‹¤íŒ¨');
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
      showStatus('âŒ í”„ë¡¬í”„íŠ¸ ìƒì„± ì˜¤ë¥˜');
    } finally {
      hideLoadingOverlay();
      setTimeout(hideStatus, 3000);
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'ğŸ“ ì”¬ í”„ë¡¬í”„íŠ¸';
      }
    }
  }

  // í”„ë¡¬í”„íŠ¸ + ì´ë¯¸ì§€ í•œë²ˆì— ìƒì„±
  async function generateScenePromptAndImage() {
    const sceneSelect = document.getElementById('step4-scene-select');
    const idx = parseInt(sceneSelect?.value);

    if (isNaN(idx) || !step4Scenes[idx]) {
      alert('ì”¬ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    // ì„ íƒëœ ì¸ë¬¼ë“¤ ê°€ì ¸ì˜¤ê¸°
    const selectedCharacters = [];
    document.querySelectorAll('.scene-character-checkbox:checked').forEach(cb => {
      const name = cb.dataset.name;
      if (step4CharacterImages[name]) {
        selectedCharacters.push({
          name: name,
          prompt: step4CharacterImages[name].prompt
        });
      } else {
        const char = step4Characters.find(c => c.name === name);
        if (char) {
          selectedCharacters.push({
            name: name,
            prompt: char.imagePrompt
          });
        }
      }
    });

    const btn = document.getElementById('btn-generate-scene-all');
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'â³ í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...';
    }

    showStatus('ğŸ“ Step4: ì”¬ í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...');
    showLoadingOverlay();

    try {
      // 1ë‹¨ê³„: í”„ë¡¬í”„íŠ¸ ìƒì„±
      const promptResponse = await fetch('/api/drama/generate-scene-prompt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          scene: step4Scenes[idx],
          characters: selectedCharacters,
          backgroundPrompt: document.getElementById('step4-background-prompt')?.value || ''
        })
      });

      const promptData = await promptResponse.json();

      if (!promptData.ok) {
        throw new Error(promptData.error || 'í”„ë¡¬í”„íŠ¸ ìƒì„± ì‹¤íŒ¨');
      }

      document.getElementById('step4-combined-prompt').value = promptData.combinedPrompt || '';
      if (promptData.backgroundPrompt) {
        document.getElementById('step4-background-prompt').value = promptData.backgroundPrompt;
      }

      showStatus('âœ… í”„ë¡¬í”„íŠ¸ ì™„ë£Œ! ğŸ–¼ï¸ ì´ë¯¸ì§€ ìƒì„± ì¤‘... (ì•½ 30ì´ˆ)');
      if (btn) btn.textContent = 'â³ ì´ë¯¸ì§€ ìƒì„± ì¤‘...';

      // 2ë‹¨ê³„: ì´ë¯¸ì§€ ìƒì„±
      const imageSize = document.getElementById('step4-image-size')?.value || '1792x1024';
      const imageResponse = await fetch('/api/drama/generate-image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          prompt: promptData.combinedPrompt,
          size: imageSize,
          imageProvider: step4ImageProvider
        })
      });

      const imageData = await imageResponse.json();

      if (imageData.ok) {
        const placeholder = document.getElementById('step4-image-placeholder');
        const imageGrid = document.getElementById('step4-image-grid');
        const costInfo = document.getElementById('step4-cost-info');

        if (placeholder) placeholder.style.display = 'none';
        if (imageGrid) {
          imageGrid.style.display = 'grid';

          const imageItem = document.createElement('div');
          imageItem.className = 'step4-image-item';
          imageItem.innerHTML = `
            <img src="${imageData.imageUrl}" alt="Generated scene" loading="lazy" onclick="window.open('${imageData.imageUrl}', '_blank')">
            <div class="image-caption">
              ì”¬ ${idx + 1}: ${step4Scenes[idx].sceneName || ''} | ${imageSize}
              <button onclick="downloadImage('${imageData.imageUrl}')" style="margin-left: .5rem; padding: .2rem .4rem; font-size: .7rem; cursor: pointer;">ğŸ’¾ ì €ì¥</button>
            </div>
          `;
          imageGrid.insertBefore(imageItem, imageGrid.firstChild);

          step4GeneratedImages.unshift({
            url: imageData.imageUrl,
            prompt: promptData.combinedPrompt,
            sceneIndex: idx,
            sceneName: step4Scenes[idx].sceneName,
            size: imageSize,
            createdAt: new Date().toISOString()
          });
          localStorage.setItem('_drama-step4-images', JSON.stringify(step4GeneratedImages.slice(0, 20)));
        }

        if (costInfo && imageData.cost) {
          document.getElementById('step4-image-cost').textContent = 'â‚©' + imageData.cost.toLocaleString();
          costInfo.style.display = 'block';
        }

        showStatus('âœ… ì”¬ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ!');
        updateProgressIndicator('step4');
        updateStep6Visibility();
      } else {
        throw new Error(imageData.error || 'ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨');
      }
    } catch (err) {
      alert(`ì˜¤ë¥˜: ${err.message}`);
      showStatus('âŒ ìƒì„± ì‹¤íŒ¨');
    } finally {
      hideLoadingOverlay();
      setTimeout(hideStatus, 3000);
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'ğŸ¬ í”„ë¡¬í”„íŠ¸+ì´ë¯¸ì§€';
      }
    }
  }

  // ì´ë¯¸ì§€ ìƒì„± í•¨ìˆ˜ (ì”¬ ì´ë¯¸ì§€)
  async function generateStep4Image() {
    const combinedPrompt = document.getElementById('step4-combined-prompt')?.value || '';
    if (!combinedPrompt.trim()) {
      alert('ë¨¼ì € ì”¬ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    const imageSize = document.getElementById('step4-image-size')?.value || '1792x1024';
    const btnGenerateImage = document.getElementById('btn-generate-image');

    if (btnGenerateImage) {
      btnGenerateImage.disabled = true;
      btnGenerateImage.classList.add('generating');
      btnGenerateImage.textContent = 'â³ ì´ë¯¸ì§€ ìƒì„± ì¤‘... (ì•½ 30ì´ˆ)';
    }

    const modelName = step4ImageProvider === 'flux' ? 'FLUX.1 Pro' : 'DALL-E 3';
    showStatus(`ğŸ–¼ï¸ Step4: ${modelName} ì”¬ ì´ë¯¸ì§€ ìƒì„± ì¤‘...`);
    showLoadingOverlay();

    try {
      const response = await fetch('/api/drama/generate-image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          prompt: combinedPrompt,
          size: imageSize,
          imageProvider: step4ImageProvider
        })
      });

      const data = await response.json();

      if (data.ok) {
        const placeholder = document.getElementById('step4-image-placeholder');
        const imageGrid = document.getElementById('step4-image-grid');
        const costInfo = document.getElementById('step4-cost-info');

        if (placeholder) placeholder.style.display = 'none';
        if (imageGrid) {
          imageGrid.style.display = 'grid';

          const imageItem = document.createElement('div');
          imageItem.className = 'step4-image-item';
          imageItem.innerHTML = `
            <img src="${data.imageUrl}" alt="Generated scene" loading="lazy" onclick="window.open('${data.imageUrl}', '_blank')">
            <div class="image-caption">
              ${new Date().toLocaleString('ko-KR')} | ${imageSize}
              <button onclick="downloadImage('${data.imageUrl}')" style="margin-left: .5rem; padding: .2rem .4rem; font-size: .7rem; cursor: pointer;">ğŸ’¾ ì €ì¥</button>
            </div>
          `;
          imageGrid.insertBefore(imageItem, imageGrid.firstChild);

          step4GeneratedImages.unshift({
            url: data.imageUrl,
            prompt: combinedPrompt,
            size: imageSize,
            createdAt: new Date().toISOString()
          });
          localStorage.setItem('_drama-step4-images', JSON.stringify(step4GeneratedImages.slice(0, 20)));
        }

        if (costInfo && data.cost) {
          document.getElementById('step4-image-cost').textContent = 'â‚©' + data.cost.toLocaleString();
          costInfo.style.display = 'block';
        }

        showStatus('âœ… ì”¬ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ!');
        updateProgressIndicator('step4');
        updateStep6Visibility();
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
        showStatus('âŒ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨');
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
      showStatus('âŒ ì´ë¯¸ì§€ ìƒì„± ì˜¤ë¥˜');
    } finally {
      hideLoadingOverlay();
      setTimeout(hideStatus, 3000);
      if (btnGenerateImage) {
        btnGenerateImage.disabled = false;
        btnGenerateImage.classList.remove('generating');
        const currentModel = step4ImageProvider === 'flux' ? 'FLUX.1 Pro' : 'DALL-E 3';
        btnGenerateImage.textContent = `ğŸ–¼ï¸ ì”¬ ì´ë¯¸ì§€ ìƒì„± (${currentModel})`;
      }
    }
  }

  // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
  function downloadImage(url) {
    const a = document.createElement('a');
    a.href = url;
    a.download = `drama-scene-${Date.now()}.png`;
    a.target = '_blank';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // Step4 ì´ˆê¸°í™” í•¨ìˆ˜
  function clearStep4() {
    if (!confirm('Step4ì˜ ëª¨ë“  ë°ì´í„°(ì¸ë¬¼, ì”¬, ì´ë¯¸ì§€)ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    step4Characters = [];
    step4CharacterImages = {};
    step4Scenes = [];
    step4GeneratedImages = [];

    localStorage.removeItem('_drama-step4-characters');
    localStorage.removeItem('_drama-step4-character-images');
    localStorage.removeItem('_drama-step4-scenes');
    localStorage.removeItem('_drama-step4-images');

    document.getElementById('step4-character-prompt').value = '';
    document.getElementById('step4-background-prompt').value = '';
    document.getElementById('step4-combined-prompt').value = '';

    renderCharactersList();
    updateCharacterSelect();
    updateSceneSelect();
    updateSceneCharacterCheckboxes();
    renderCharacterImages();

    const imageGrid = document.getElementById('step4-image-grid');
    const placeholder = document.getElementById('step4-image-placeholder');
    const costInfo = document.getElementById('step4-cost-info');

    if (imageGrid) {
      imageGrid.innerHTML = '';
      imageGrid.style.display = 'none';
    }
    if (placeholder) placeholder.style.display = 'block';
    if (costInfo) costInfo.style.display = 'none';

    showStatus('ğŸ—‘ï¸ Step4ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    setTimeout(hideStatus, 2000);
  }

  // Step4 ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
  document.getElementById('btn-analyze-characters')?.addEventListener('click', analyzeCharacters);
  document.getElementById('btn-generate-character-image')?.addEventListener('click', generateCharacterImage);
  document.getElementById('btn-generate-scene-prompt')?.addEventListener('click', generateScenePrompt);
  document.getElementById('btn-generate-scene-all')?.addEventListener('click', generateScenePromptAndImage);
  document.getElementById('btn-generate-image')?.addEventListener('click', generateStep4Image);
  document.getElementById('btn-clear-step4')?.addEventListener('click', clearStep4);

  // Step4 ì €ì¥ëœ ë°ì´í„° ë³µì›
  function restoreStep4Data() {
    renderCharactersList();
    updateCharacterSelect();
    updateSceneSelect();
    updateSceneCharacterCheckboxes();
    renderCharacterImages();

    // ì´ë¯¸ì§€ ë³µì›
    if (step4GeneratedImages.length === 0) return;

    const imageGrid = document.getElementById('step4-image-grid');
    const placeholder = document.getElementById('step4-image-placeholder');

    if (imageGrid && placeholder) {
      placeholder.style.display = 'none';
      imageGrid.style.display = 'grid';

      step4GeneratedImages.forEach(img => {
        const imageItem = document.createElement('div');
        imageItem.className = 'step4-image-item';
        imageItem.innerHTML = `
          <img src="${img.url}" alt="Generated scene" loading="lazy" onclick="window.open('${img.url}', '_blank')">
          <div class="image-caption">
            ${new Date(img.createdAt).toLocaleString('ko-KR')} | ${img.size}
            <button onclick="downloadImage('${img.url}')" style="margin-left: .5rem; padding: .2rem .4rem; font-size: .7rem; cursor: pointer;">ğŸ’¾ ì €ì¥</button>
          </div>
        `;
        imageGrid.appendChild(imageItem);
      });
    }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ Step4 ë°ì´í„° ë³µì›
  setTimeout(restoreStep4Data, 500);

  // ===== Step5: TTS ìŒì„± í•©ì„± ë° ìë§‰ ìƒì„± ê¸°ëŠ¥ =====
  let step5TtsProvider = 'google';  // ê¸°ë³¸: Google Cloud TTS
  let step5SelectedVoice = 'ko-KR-Wavenet-A';  // Google ê¸°ë³¸ ìŒì„±
  let step5AudioUrl = null;
  let step5SubtitleData = null;
  let step5PreviewAudio = null;  // ë¯¸ë¦¬ë“£ê¸°ìš© ì˜¤ë””ì˜¤

  // ìŒì„± ë¯¸ë¦¬ë“£ê¸° í•¨ìˆ˜
  async function previewVoice(voice, provider) {
    const sampleText = "ì•ˆë…•í•˜ì„¸ìš”. ì´ ëª©ì†Œë¦¬ë¡œ ë“œë¼ë§ˆ ë‚˜ë ˆì´ì…˜ì„ ì§„í–‰í•©ë‹ˆë‹¤. ê°ë™ì ì¸ ì´ì•¼ê¸°ë¥¼ ì „í•´ë“œë¦´ê²Œìš”.";

    // ê¸°ì¡´ ì¬ìƒ ì¤‘ì¸ ì˜¤ë””ì˜¤ ì¤‘ì§€
    if (step5PreviewAudio) {
      step5PreviewAudio.pause();
      step5PreviewAudio = null;
    }

    // ë²„íŠ¼ ë¡œë”© ìƒíƒœ
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = 'â³';
    btn.classList.add('loading');

    try {
      const response = await fetch('/api/drama/generate-tts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          text: sampleText,
          speaker: voice,
          speed: 0,
          pitch: 0,
          volume: 0,
          ttsProvider: provider
        })
      });

      const data = await response.json();

      if (data.ok && data.audioUrl) {
        step5PreviewAudio = new Audio(data.audioUrl);
        step5PreviewAudio.play();

        // ì¬ìƒ ì¤‘ ë²„íŠ¼ í‘œì‹œ
        btn.textContent = 'â¸ï¸';

        // ì¬ìƒ ì™„ë£Œ ì‹œ ë²„íŠ¼ ë³µì›
        step5PreviewAudio.onended = () => {
          btn.textContent = 'â–¶ï¸';
          btn.classList.remove('loading');
        };

        // í´ë¦­í•˜ë©´ ì •ì§€
        btn.onclick = (e) => {
          e.stopPropagation();
          if (step5PreviewAudio) {
            step5PreviewAudio.pause();
            step5PreviewAudio = null;
          }
          btn.textContent = 'â–¶ï¸';
          btn.classList.remove('loading');
          btn.onclick = (e) => {
            e.stopPropagation();
            previewVoice(voice, provider);
          };
        };
      } else {
        alert(`ë¯¸ë¦¬ë“£ê¸° ì‹¤íŒ¨: ${data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
        btn.textContent = 'â–¶ï¸';
        btn.classList.remove('loading');
      }
    } catch (err) {
      alert(`ë¯¸ë¦¬ë“£ê¸° ì˜¤ë¥˜: ${err.message}`);
      btn.textContent = 'â–¶ï¸';
      btn.classList.remove('loading');
    }
  }

  // Step3 ê²°ê³¼ê°€ ìˆìœ¼ë©´ Step5 ì»¨í…Œì´ë„ˆ í‘œì‹œ
  function updateStep5Visibility() {
    const step5Container = document.getElementById('step5-container');
    const step3Result = document.getElementById('step3-result')?.value || '';
    if (step5Container) {
      step5Container.style.display = step3Result.trim() ? 'block' : 'none';
    }
  }

  // Step5 ê°€ì‹œì„± ì²´í¬ (Step3 ê²°ê³¼ ë³€ê²½ ê°ì§€)
  setInterval(updateStep5Visibility, 1000);

  // TTS ì œê³µì ì„ íƒ ì´ë²¤íŠ¸
  document.querySelectorAll('.step5-tts-provider').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.step5-tts-provider').forEach(b => {
        b.classList.remove('selected');
        b.style.border = '2px solid #ddd';
        b.style.background = 'white';
      });
      btn.classList.add('selected');
      btn.style.border = '2px solid #10b981';
      btn.style.background = 'rgba(16,185,129,0.2)';

      step5TtsProvider = btn.dataset.provider;

      // ìŒì„± ì„ íƒ ì˜ì—­ ì „í™˜
      const googleVoices = document.getElementById('step5-voice-google');
      const naverVoices = document.getElementById('step5-voice-naver');
      const voiceLabel = document.getElementById('step5-voice-label');

      if (step5TtsProvider === 'google') {
        googleVoices.style.display = 'grid';
        naverVoices.style.display = 'none';
        voiceLabel.textContent = 'ğŸ¤ ìŒì„± ì„ íƒ (Google Cloud)';
        // Google ê¸°ë³¸ ìŒì„±ìœ¼ë¡œ ì„¤ì •
        step5SelectedVoice = 'ko-KR-Wavenet-A';
        googleVoices.querySelectorAll('.step5-voice-option').forEach((o, i) => {
          o.classList.toggle('selected', i === 0);
        });
      } else {
        googleVoices.style.display = 'none';
        naverVoices.style.display = 'grid';
        voiceLabel.textContent = 'ğŸ¤ ìŒì„± ì„ íƒ (ë„¤ì´ë²„ í´ë¡œë°”)';
        // ë„¤ì´ë²„ ê¸°ë³¸ ìŒì„±ìœ¼ë¡œ ì„¤ì •
        step5SelectedVoice = 'nara';
        naverVoices.querySelectorAll('.step5-voice-option').forEach((o, i) => {
          o.classList.toggle('selected', i === 0);
        });
      }
    });
  });

  // ìŒì„± ì„ íƒ ì´ë²¤íŠ¸
  document.querySelectorAll('.step5-voice-option').forEach(option => {
    option.addEventListener('click', () => {
      const provider = option.dataset.provider;
      const container = provider === 'google' ? document.getElementById('step5-voice-google') : document.getElementById('step5-voice-naver');
      container.querySelectorAll('.step5-voice-option').forEach(o => o.classList.remove('selected'));
      option.classList.add('selected');
      step5SelectedVoice = option.dataset.voice;
    });
  });

  // ì§€ë¬¸ë§Œ ì¶”ì¶œ í•¨ìˆ˜ (ëŒ€ì‚¬ ì œì™¸)
  function extractNarration() {
    const step3Result = document.getElementById('step3-result')?.value || '';
    if (!step3Result.trim()) {
      alert('ë¨¼ì € Step3 ëŒ€ë³¸ ì™„ì„±ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
      return;
    }

    // ëŒ€ì‚¬ íŒ¨í„´ ì œê±° (ì´ë¦„: ëŒ€ì‚¬ í˜•ì‹)
    let narration = step3Result;

    // "ì¸ë¬¼ëª…: ëŒ€ì‚¬" íŒ¨í„´ ì œê±°
    narration = narration.replace(/^[ê°€-í£a-zA-Z]+\s*[:ï¼š]\s*.+$/gm, '');

    // (ê°ì •/í–‰ë™) í˜•ì‹ì˜ ì§€ì‹œë¬¸ì€ ìœ ì§€í•˜ë˜ ê´„í˜¸ ì œê±°
    narration = narration.replace(/\(([^)]+)\)/g, '$1');

    // ë¹ˆ ì¤„ ì •ë¦¬
    narration = narration.replace(/\n{3,}/g, '\n\n').trim();

    document.getElementById('step5-script-text').value = narration;
    showStatus('ğŸ“ ì§€ë¬¸ì´ ì¶”ì¶œë˜ì—ˆìŠµë‹ˆë‹¤.');
    setTimeout(hideStatus, 2000);
  }

  // TTS ìƒì„± í•¨ìˆ˜
  async function generateTTS() {
    const scriptText = document.getElementById('step5-script-text')?.value || '';
    if (!scriptText.trim()) {
      alert('TTSìš© ëŒ€ë³¸ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    const speed = document.getElementById('step5-speed')?.value || 0;
    const pitch = document.getElementById('step5-pitch')?.value || 0;
    const volume = document.getElementById('step5-volume')?.value || 0;

    const btnGenerateTTS = document.getElementById('btn-generate-tts');
    if (btnGenerateTTS) {
      btnGenerateTTS.disabled = true;
      btnGenerateTTS.classList.add('generating');
      btnGenerateTTS.textContent = 'â³ ìŒì„± ìƒì„± ì¤‘...';
    }

    const providerName = step5TtsProvider === 'google' ? 'Google Cloud' : 'ë„¤ì´ë²„ í´ë¡œë°”';
    showStatus(`ğŸ™ï¸ Step5: ${providerName} TTS ìŒì„± ìƒì„± ì¤‘...`);
    showLoadingOverlay();

    try {
      const response = await fetch('/api/drama/generate-tts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          text: scriptText,
          speaker: step5SelectedVoice,
          speed: parseInt(speed),
          pitch: parseInt(pitch),
          volume: parseInt(volume),
          ttsProvider: step5TtsProvider
        })
      });

      const data = await response.json();

      if (data.ok) {
        // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ í‘œì‹œ
        const audioSection = document.getElementById('step5-audio-section');
        const audioPlayer = document.getElementById('step5-audio-player');
        const costInfo = document.getElementById('step5-cost-info');

        if (audioPlayer && data.audioUrl) {
          step5AudioUrl = data.audioUrl;
          audioPlayer.src = data.audioUrl;
          audioSection.style.display = 'block';
        }

        // ë¹„ìš© ì •ë³´ í‘œì‹œ
        if (costInfo && data.cost) {
          document.getElementById('step5-tts-cost').textContent = 'â‚©' + data.cost.toLocaleString();
          document.getElementById('step5-char-count').textContent = data.charCount?.toLocaleString() || '0';
          costInfo.style.display = 'block';
        }

        showStatus('âœ… TTS ìŒì„± ìƒì„± ì™„ë£Œ!');
        updateProgressIndicator('step5');
        updateStep6Visibility();
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
        showStatus('âŒ TTS ìƒì„± ì‹¤íŒ¨');
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
      showStatus('âŒ TTS ìƒì„± ì˜¤ë¥˜');
    } finally {
      hideLoadingOverlay();
      setTimeout(hideStatus, 3000);
      if (btnGenerateTTS) {
        btnGenerateTTS.disabled = false;
        btnGenerateTTS.classList.remove('generating');
        btnGenerateTTS.textContent = 'ìŒì„± ìƒì„± (TTS)';
      }
    }
  }

  // ìë§‰ ìƒì„± í•¨ìˆ˜
  async function generateSubtitle() {
    const scriptText = document.getElementById('step5-script-text')?.value || '';
    if (!scriptText.trim()) {
      alert('TTSìš© ëŒ€ë³¸ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    const btnGenerateSubtitle = document.getElementById('btn-generate-subtitle');
    if (btnGenerateSubtitle) {
      btnGenerateSubtitle.disabled = true;
      btnGenerateSubtitle.classList.add('generating');
      btnGenerateSubtitle.textContent = 'â³ ìë§‰ ìƒì„± ì¤‘...';
    }

    showStatus('ğŸ“ Step5: ìë§‰ ìƒì„± ì¤‘...');
    showLoadingOverlay();

    try {
      const response = await fetch('/api/drama/generate-subtitle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          text: scriptText,
          speed: parseInt(document.getElementById('step5-speed')?.value || 0)
        })
      });

      const data = await response.json();

      if (data.ok) {
        // ìë§‰ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        const subtitleSection = document.getElementById('step5-subtitle-section');
        const subtitlePreview = document.getElementById('step5-subtitle-preview');

        if (subtitlePreview && data.srt) {
          step5SubtitleData = data;
          subtitlePreview.textContent = data.srt;
          subtitleSection.style.display = 'block';
        }

        showStatus('âœ… ìë§‰ ìƒì„± ì™„ë£Œ!');
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
        showStatus('âŒ ìë§‰ ìƒì„± ì‹¤íŒ¨');
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
      showStatus('âŒ ìë§‰ ìƒì„± ì˜¤ë¥˜');
    } finally {
      hideLoadingOverlay();
      setTimeout(hideStatus, 3000);
      if (btnGenerateSubtitle) {
        btnGenerateSubtitle.disabled = false;
        btnGenerateSubtitle.classList.remove('generating');
        btnGenerateSubtitle.textContent = 'ğŸ“ ìë§‰ ìƒì„± (SRT)';
      }
    }
  }

  // ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
  function downloadAudio() {
    if (!step5AudioUrl) {
      alert('ë¨¼ì € ìŒì„±ì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
      return;
    }
    const a = document.createElement('a');
    a.href = step5AudioUrl;
    a.download = `drama-tts-${Date.now()}.mp3`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // SRT ë‹¤ìš´ë¡œë“œ
  function downloadSRT() {
    if (!step5SubtitleData?.srt) {
      alert('ë¨¼ì € ìë§‰ì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
      return;
    }
    const blob = new Blob([step5SubtitleData.srt], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `drama-subtitle-${Date.now()}.srt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // VTT ë‹¤ìš´ë¡œë“œ
  function downloadVTT() {
    if (!step5SubtitleData?.vtt) {
      alert('ë¨¼ì € ìë§‰ì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
      return;
    }
    const blob = new Blob([step5SubtitleData.vtt], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `drama-subtitle-${Date.now()}.vtt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // Step5 ì´ˆê¸°í™”
  function clearStep5() {
    if (!confirm('Step5ì˜ ëª¨ë“  ë‚´ìš©ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    document.getElementById('step5-script-text').value = '';
    document.getElementById('step5-audio-section').style.display = 'none';
    document.getElementById('step5-subtitle-section').style.display = 'none';
    document.getElementById('step5-cost-info').style.display = 'none';

    const audioPlayer = document.getElementById('step5-audio-player');
    if (audioPlayer) audioPlayer.src = '';

    step5AudioUrl = null;
    step5SubtitleData = null;

    showStatus('ğŸ—‘ï¸ Step5ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    setTimeout(hideStatus, 2000);
  }

  // Step5 ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
  document.getElementById('btn-extract-narration')?.addEventListener('click', extractNarration);
  document.getElementById('btn-generate-tts')?.addEventListener('click', generateTTS);
  document.getElementById('btn-generate-subtitle')?.addEventListener('click', generateSubtitle);
  document.getElementById('btn-download-audio')?.addEventListener('click', downloadAudio);
  document.getElementById('btn-download-srt')?.addEventListener('click', downloadSRT);
  document.getElementById('btn-download-vtt')?.addEventListener('click', downloadVTT);
  document.getElementById('btn-clear-step5')?.addEventListener('click', clearStep5);

  // ===== Step6: ì˜ìƒ ì œì‘ ê¸°ëŠ¥ =====
  let step6SelectedImages = [];
  let step6VideoUrl = null;

  // Step6 ì»¨í…Œì´ë„ˆ ì—…ë°ì´íŠ¸ (ì´ë¯¸ì§€/ì˜¤ë””ì˜¤ ìƒíƒœ ê°±ì‹ )
  function updateStep6Visibility() {
    // ì´ë¯¸ì§€ ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
    updateStep6ImageGrid();
    // ì˜¤ë””ì˜¤ ìƒíƒœ ì—…ë°ì´íŠ¸
    updateStep6AudioStatus();
  }

  // Step6 ì´ë¯¸ì§€ ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
  function updateStep6ImageGrid() {
    const grid = document.getElementById('step6-image-grid');
    if (!grid) return;

    if (!step4GeneratedImages || step4GeneratedImages.length === 0) {
      grid.innerHTML = '<div style="color: #999; text-align: center; padding: 1rem; grid-column: 1/-1;">Step4ì—ì„œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>';
      return;
    }

    grid.innerHTML = step4GeneratedImages.map((img, idx) => `
      <div class="step6-preview-item ${step6SelectedImages.includes(img.url) ? 'selected' : ''}" data-url="${img.url}" onclick="toggleStep6Image('${img.url}')">
        <img src="${img.url}" alt="Scene ${idx + 1}">
      </div>
    `).join('');
  }

  // ì´ë¯¸ì§€ ì„ íƒ í† ê¸€
  function toggleStep6Image(url) {
    const idx = step6SelectedImages.indexOf(url);
    if (idx > -1) {
      step6SelectedImages.splice(idx, 1);
    } else {
      step6SelectedImages.push(url);
    }
    updateStep6ImageGrid();
  }

  // Step6 ì˜¤ë””ì˜¤ ìƒíƒœ ì—…ë°ì´íŠ¸
  function updateStep6AudioStatus() {
    const statusDiv = document.getElementById('step6-audio-status');
    const audioPreview = document.getElementById('step6-audio-preview');

    if (step5AudioUrl) {
      statusDiv.innerHTML = 'âœ… ìŒì„±ì´ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤';
      statusDiv.style.color = '#27ae60';
      audioPreview.src = step5AudioUrl;
      audioPreview.style.display = 'block';
    } else {
      statusDiv.innerHTML = 'Step5ì—ì„œ ìŒì„±ì„ ìƒì„±í•˜ë©´ ìë™ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤';
      statusDiv.style.color = '#666';
      audioPreview.style.display = 'none';
    }
  }

  // Step6 ê°€ì‹œì„± ì²´í¬ (ì£¼ê¸°ì )
  setInterval(updateStep6Visibility, 2000);

  // ì˜ìƒ ìƒì„± í•¨ìˆ˜
  async function generateVideo() {
    // ìœ íš¨ì„± ê²€ì‚¬
    if (step6SelectedImages.length === 0) {
      alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    if (!step5AudioUrl) {
      alert('Step5ì—ì„œ ìŒì„±ì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.');
      return;
    }

    const resolution = document.getElementById('step6-resolution')?.value || '1920x1080';
    const fps = document.getElementById('step6-fps')?.value || '30';
    const transition = document.getElementById('step6-transition')?.value || 'fade';
    const includeSubtitle = document.getElementById('step6-include-subtitle')?.checked || false;
    const burnSubtitle = document.getElementById('step6-burn-subtitle')?.checked || false;

    const btnGenerateVideo = document.getElementById('btn-generate-video');
    const progressDiv = document.getElementById('step6-progress');
    const progressBar = document.getElementById('step6-progress-bar');
    const progressText = document.getElementById('step6-progress-text');

    if (btnGenerateVideo) {
      btnGenerateVideo.disabled = true;
      btnGenerateVideo.classList.add('generating');
      btnGenerateVideo.textContent = 'â³ ì˜ìƒ ìƒì„± ì¤‘...';
    }

    progressDiv.style.display = 'block';
    progressBar.style.width = '10%';
    progressText.textContent = 'ì˜ìƒ ì¤€ë¹„ ì¤‘...';

    showStatus('ğŸ¬ Step6: ì˜ìƒ ìƒì„± ì¤‘...');

    try {
      // ì§„í–‰ ìƒí™© ì‹œë®¬ë ˆì´ì…˜
      let progress = 10;
      const progressInterval = setInterval(() => {
        progress += 5;
        if (progress < 90) {
          progressBar.style.width = progress + '%';
          if (progress < 30) progressText.textContent = 'ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘...';
          else if (progress < 50) progressText.textContent = 'ì˜¤ë””ì˜¤ ì²˜ë¦¬ ì¤‘...';
          else if (progress < 70) progressText.textContent = 'ì˜ìƒ ì¸ì½”ë”© ì¤‘...';
          else progressText.textContent = 'ë§ˆë¬´ë¦¬ ì¤‘...';
        }
      }, 500);

      const response = await fetch('/api/drama/generate-video', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          images: step6SelectedImages,
          audioUrl: step5AudioUrl,
          subtitleData: includeSubtitle ? step5SubtitleData : null,
          burnSubtitle: burnSubtitle,
          resolution: resolution,
          fps: parseInt(fps),
          transition: transition
        })
      });

      clearInterval(progressInterval);

      const data = await response.json();

      if (data.ok) {
        progressBar.style.width = '100%';
        progressText.textContent = 'ì™„ë£Œ!';

        // ì˜ìƒ í”Œë ˆì´ì–´ í‘œì‹œ
        const videoSection = document.getElementById('step6-video-section');
        const videoPlayer = document.getElementById('step6-video-player');

        if (videoPlayer && data.videoUrl) {
          step6VideoUrl = data.videoUrl;
          videoPlayer.src = data.videoUrl;
          videoSection.style.display = 'block';
        }

        showStatus('âœ… ì˜ìƒ ìƒì„± ì™„ë£Œ! Step7ì—ì„œ YouTube ì—…ë¡œë“œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        updateProgressIndicator('step6');
        updateStep7Status();

        setTimeout(() => {
          progressDiv.style.display = 'none';
        }, 1500);
      } else {
        progressDiv.style.display = 'none';
        alert(`ì˜¤ë¥˜: ${data.error}`);
        showStatus('âŒ ì˜ìƒ ìƒì„± ì‹¤íŒ¨');
      }
    } catch (err) {
      progressDiv.style.display = 'none';
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
      showStatus('âŒ ì˜ìƒ ìƒì„± ì˜¤ë¥˜');
    } finally {
      setTimeout(hideStatus, 3000);
      if (btnGenerateVideo) {
        btnGenerateVideo.disabled = false;
        btnGenerateVideo.classList.remove('generating');
        btnGenerateVideo.textContent = 'ğŸ¬ ì˜ìƒ ìƒì„±';
      }
    }
  }

  // ì˜ìƒ ë‹¤ìš´ë¡œë“œ
  function downloadVideo() {
    if (!step6VideoUrl) {
      alert('ë¨¼ì € ì˜ìƒì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
      return;
    }
    const a = document.createElement('a');
    a.href = step6VideoUrl;
    a.download = `drama-video-${Date.now()}.mp4`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // Step6 ì´ˆê¸°í™”
  function clearStep6() {
    if (!confirm('Step6ì˜ ëª¨ë“  ë‚´ìš©ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    step6SelectedImages = [];
    step6VideoUrl = null;

    document.getElementById('step6-video-section').style.display = 'none';
    document.getElementById('step6-progress').style.display = 'none';

    const videoPlayer = document.getElementById('step6-video-player');
    if (videoPlayer) videoPlayer.src = '';

    updateStep6ImageGrid();

    showStatus('ğŸ—‘ï¸ Step6ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    setTimeout(hideStatus, 2000);
  }

  // Step6 ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
  document.getElementById('btn-generate-video')?.addEventListener('click', generateVideo);
  document.getElementById('btn-download-video')?.addEventListener('click', downloadVideo);
  document.getElementById('btn-clear-step6')?.addEventListener('click', clearStep6);

  // ===== Step7: ìœ íŠœë¸Œ ì—…ë¡œë“œ =====
  let youtubeAuthenticated = false;

  // Step7 ì—…ë¡œë“œ ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
  function updateStep7Status() {
    const statusEl = document.getElementById('step7-upload-status');
    const uploadBtn = document.getElementById('btn-upload-youtube');
    const videoSrc = getStep6Video();

    if (!statusEl) return;

    if (!youtubeAuthenticated) {
      statusEl.style.background = '#fff3cd';
      statusEl.style.color = '#856404';
      statusEl.textContent = 'YouTube ì¸ì¦ì„ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”';
      if (uploadBtn) uploadBtn.disabled = true;
    } else if (!videoSrc) {
      statusEl.style.background = '#fff3cd';
      statusEl.style.color = '#856404';
      statusEl.textContent = 'Step6ì—ì„œ ì˜ìƒì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”';
      if (uploadBtn) uploadBtn.disabled = true;
    } else {
      statusEl.style.background = '#d4edda';
      statusEl.style.color = '#155724';
      statusEl.textContent = 'ì˜ìƒì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!';
      if (uploadBtn) uploadBtn.disabled = false;
    }
  }

  // ì£¼ê¸°ì ìœ¼ë¡œ Step7 ìƒíƒœ ì—…ë°ì´íŠ¸
  setInterval(updateStep7Status, 3000);

  // ê°œì¸ì •ë³´ ì˜µì…˜ ì„ íƒ
  function selectStep7Privacy(value) {
    document.querySelectorAll('.step7-privacy-option').forEach(opt => {
      opt.classList.remove('selected');
      const input = opt.querySelector('input[type="radio"]');
      if (input) input.checked = false;
      if (opt.dataset.privacy === value) {
        opt.classList.add('selected');
        if (input) input.checked = true;
      }
    });
  }

  // ê°œì¸ì •ë³´ ì˜µì…˜ ì´ë²¤íŠ¸
  document.querySelectorAll('.step7-privacy-option').forEach(opt => {
    opt.addEventListener('click', () => selectStep7Privacy(opt.dataset.privacy));
  });

  // ëŒ€ë³¸ ê¸°ë°˜ ìë™ ë©”íƒ€ë°ì´í„° ìƒì„±
  async function generateAutoMetadata() {
    const btn = document.getElementById('btn-auto-metadata');
    const step3Result = document.getElementById('step3-result')?.value || '';

    if (!step3Result.trim()) {
      showStatus('Step3 ëŒ€ë³¸ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ëŒ€ë³¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.');
      return;
    }

    btn.disabled = true;
    btn.textContent = 'ìƒì„± ì¤‘...';
    showStatus('ëŒ€ë³¸ì„ ë¶„ì„í•˜ì—¬ ì œëª©, ì„¤ëª…, íƒœê·¸ë¥¼ ìƒì„± ì¤‘...');

    try {
      const response = await fetch('/api/drama/generate-metadata', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ script: step3Result })
      });

      const data = await response.json();

      if (data.success) {
        document.getElementById('step7-title').value = data.title || '';
        document.getElementById('step7-description').value = data.description || '';
        document.getElementById('step7-tags').value = data.tags || '';
        showStatus('ë©”íƒ€ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
      } else {
        throw new Error(data.error || 'ë©”íƒ€ë°ì´í„° ìƒì„± ì‹¤íŒ¨');
      }
    } catch (error) {
      console.error('Auto metadata error:', error);
      showStatus(`ë©”íƒ€ë°ì´í„° ìƒì„± ì‹¤íŒ¨: ${error.message}`);
    } finally {
      btn.disabled = false;
      btn.textContent = 'ëŒ€ë³¸ ê¸°ë°˜ ìë™ ì…ë ¥';
    }
  }

  // ìë™ ë©”íƒ€ë°ì´í„° ë²„íŠ¼ ì´ë²¤íŠ¸
  document.getElementById('btn-auto-metadata')?.addEventListener('click', generateAutoMetadata);

  // ìœ íŠœë¸Œ ì¸ì¦
  async function authenticateYouTube() {
    const authBtn = document.getElementById('btn-youtube-auth');
    const authStatus = document.getElementById('youtube-auth-status');

    authBtn.disabled = true;
    authBtn.textContent = 'ğŸ”„ ì¸ì¦ ì¤‘...';
    authStatus.innerHTML = '<span style="color: #f39c12;">â³ YouTube ì¸ì¦ì„ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤...</span>';

    try {
      const response = await fetch('/api/drama/youtube-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      const data = await response.json();

      if (data.success) {
        youtubeAuthenticated = true;
        authBtn.textContent = 'âœ… ì¸ì¦ ì™„ë£Œ';
        authBtn.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
        authStatus.innerHTML = '<span style="color: #27ae60;">âœ… YouTube ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</span>';
        updateStep7Status();
      } else if (data.auth_url) {
        // OAuth URLì´ ì œê³µë˜ë©´ ìƒˆ ì°½ì—ì„œ ì—´ê¸°
        window.open(data.auth_url, '_blank', 'width=600,height=700');
        authBtn.textContent = 'ğŸ”— ì¸ì¦ ëŒ€ê¸° ì¤‘';
        authStatus.innerHTML = '<span style="color: #f39c12;">â³ ìƒˆ ì°½ì—ì„œ YouTube ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.</span>';

        // ì¸ì¦ ìƒíƒœ í´ë§
        pollYouTubeAuth();
      } else {
        throw new Error(data.error || 'ì¸ì¦ ì‹¤íŒ¨');
      }
    } catch (error) {
      console.error('YouTube auth error:', error);
      authBtn.disabled = false;
      authBtn.textContent = 'ğŸ”— YouTube ì¸ì¦';
      authStatus.innerHTML = `<span style="color: #e74c3c;">âŒ ì¸ì¦ ì‹¤íŒ¨: ${error.message}</span>`;
    }
  }

  // ì¸ì¦ ìƒíƒœ í´ë§
  async function pollYouTubeAuth() {
    const authBtn = document.getElementById('btn-youtube-auth');
    const authStatus = document.getElementById('youtube-auth-status');

    for (let i = 0; i < 60; i++) {
      await new Promise(resolve => setTimeout(resolve, 2000));

      try {
        const response = await fetch('/api/drama/youtube-auth-status');
        const data = await response.json();

        if (data.authenticated) {
          youtubeAuthenticated = true;
          authBtn.textContent = 'âœ… ì¸ì¦ ì™„ë£Œ';
          authBtn.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
          authBtn.disabled = true;
          authStatus.innerHTML = '<span style="color: #27ae60;">âœ… YouTube ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</span>';
          updateStep7Status();
          return;
        }
      } catch (e) {
        console.error('Poll error:', e);
      }
    }

    authBtn.disabled = false;
    authBtn.textContent = 'ğŸ”— YouTube ì¸ì¦';
    authStatus.innerHTML = '<span style="color: #e74c3c;">âŒ ì¸ì¦ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</span>';
  }

  // Step6 ë¹„ë””ì˜¤ ê°€ì ¸ì˜¤ê¸°
  function getStep6Video() {
    const videoPlayer = document.getElementById('step6-video-player');
    if (videoPlayer && videoPlayer.src && videoPlayer.src !== window.location.href) {
      return videoPlayer.src;
    }
    return null;
  }

  // ìœ íŠœë¸Œ ì—…ë¡œë“œ
  async function uploadToYouTube() {
    const videoSrc = getStep6Video();
    if (!videoSrc) {
      showStatus('âŒ ì—…ë¡œë“œí•  ë¹„ë””ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤. Step6ì—ì„œ ë¨¼ì € ë¹„ë””ì˜¤ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
      return;
    }

    const title = document.getElementById('step7-title').value.trim();
    if (!title) {
      showStatus('âŒ ë¹„ë””ì˜¤ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    const description = document.getElementById('step7-description').value.trim();
    const tags = document.getElementById('step7-tags').value.trim();
    const category = document.getElementById('step7-category').value;
    const privacyOption = document.querySelector('.step7-privacy-option.selected');
    const privacyValue = privacyOption ? privacyOption.dataset.privacy : 'scheduled';

    // ì˜ˆì•½ ì—…ë¡œë“œì¸ ê²½ìš° 30ë¶„ í›„ ê³µê°œ ì‹œê°„ ê³„ì‚°
    let privacy = privacyValue;
    let publishAt = null;
    if (privacyValue === 'scheduled') {
      privacy = 'private';  // ì˜ˆì•½ ì‹œ ì¼ë‹¨ ë¹„ê³µê°œë¡œ ì—…ë¡œë“œ
      const scheduledTime = new Date(Date.now() + 30 * 60 * 1000);  // 30ë¶„ í›„
      publishAt = scheduledTime.toISOString();
    }

    const uploadBtn = document.getElementById('btn-upload-youtube');
    const progressContainer = document.getElementById('step7-progress');
    const progressFill = document.getElementById('step7-progress-fill');
    const progressText = document.getElementById('step7-progress-text');
    const resultContainer = document.getElementById('step7-result');

    uploadBtn.disabled = true;
    uploadBtn.textContent = 'â³ ì—…ë¡œë“œ ì¤‘...';
    progressContainer.style.display = 'block';
    resultContainer.style.display = 'none';

    try {
      // ë¹„ë””ì˜¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      progressText.textContent = 'ë¹„ë””ì˜¤ ë°ì´í„° ì¤€ë¹„ ì¤‘...';
      progressFill.style.width = '10%';

      const videoResponse = await fetch(videoSrc);
      const videoBlob = await videoResponse.blob();
      const videoBase64 = await blobToBase64(videoBlob);

      progressText.textContent = publishAt ? 'ìœ íŠœë¸Œì— ì˜ˆì•½ ì—…ë¡œë“œ ì¤‘...' : 'ìœ íŠœë¸Œì— ì—…ë¡œë“œ ì¤‘...';
      progressFill.style.width = '30%';

      const response = await fetch('/api/drama/upload-youtube', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          video_data: videoBase64,
          title: title,
          description: description,
          tags: tags.split(',').map(t => t.trim()).filter(t => t),
          category_id: category,
          privacy_status: privacy,
          publish_at: publishAt
        })
      });

      progressFill.style.width = '80%';

      const data = await response.json();

      if (data.success) {
        progressFill.style.width = '100%';
        progressText.textContent = publishAt ? 'ì˜ˆì•½ ì—…ë¡œë“œ ì™„ë£Œ!' : 'ì—…ë¡œë“œ ì™„ë£Œ!';

        resultContainer.style.display = 'block';
        document.getElementById('step7-video-link').href = data.video_url;
        document.getElementById('step7-video-link').textContent = data.video_url;
        document.getElementById('step7-video-id').textContent = data.video_id;

        const scheduledMsg = publishAt ? ` (${new Date(publishAt).toLocaleString('ko-KR')}ì— ê³µê°œ ì˜ˆì •)` : '';
        showStatus(`ğŸ‰ YouTube ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!${scheduledMsg}`);
        updateProgressIndicator('step7');
      } else {
        throw new Error(data.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
      }
    } catch (error) {
      console.error('Upload error:', error);
      progressText.textContent = `ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
      progressFill.style.background = '#e74c3c';
      showStatus(`âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
    } finally {
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'ğŸ“¤ YouTube ì—…ë¡œë“œ';
    }
  }

  // Blobì„ Base64ë¡œ ë³€í™˜
  function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => {
        const base64 = reader.result.split(',')[1];
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }

  // Step7 ì´ˆê¸°í™”
  function clearStep7() {
    document.getElementById('step7-title').value = '';
    document.getElementById('step7-description').value = '';
    document.getElementById('step7-tags').value = '';
    document.getElementById('step7-category').value = '22';
    selectStep7Privacy('scheduled');

    document.getElementById('step7-progress').style.display = 'none';
    document.getElementById('step7-progress-fill').style.width = '0%';
    document.getElementById('step7-progress-fill').style.background = 'linear-gradient(135deg, #ff0000, #cc0000)';
    document.getElementById('step7-result').style.display = 'none';

    showStatus('Step7ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    setTimeout(hideStatus, 2000);
  }

  // Step7 ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
  document.getElementById('btn-youtube-auth')?.addEventListener('click', authenticateYouTube);
  document.getElementById('btn-upload-youtube')?.addEventListener('click', uploadToYouTube);
  document.getElementById('btn-clear-step7')?.addEventListener('click', clearStep7);

  // Step7 ì´ˆê¸°í™” - ê¸°ë³¸ ê³µê°œ ì„¤ì •ì€ ì˜ˆì•½ (30ë¶„ í›„ ê³µê°œ)
  selectStep7Privacy('scheduled');

  // ===== ë Œë”ë§ í•¨ìˆ˜ =====
  function renderCategories() {
    const select = document.getElementById('drama-category');
    if (!select) return;

    const current = select.value;
    select.innerHTML = config.categories.map(c =>
      `<option value="${c.value}">${c.label}</option>`
    ).join('');

    if (current && config.categories.find(c => c.value === current)) {
      select.value = current;
    } else {
      select.value = config.categories[0].value;
    }
    currentCategory = select.value;
  }

  // Styles are no longer used - main character is a text input field

  function renderProcessingSteps() {
    const steps = getCurrentSteps();
    const container = document.getElementById('processing-steps');

    if (!container) return;

    if (steps.length === 0) {
      container.innerHTML = '<p style="color: #999; font-size: .85rem; text-align: center;">ë‹¨ê³„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>';
      return;
    }

    container.innerHTML = steps.map(step =>
      `<button class="step-btn primary" data-step="${step.id}">${step.order}. ${step.name}</button>`
    ).join('');

    container.querySelectorAll('.step-btn').forEach(btn => {
      btn.addEventListener('click', () => executeStep(btn.dataset.step));
    });
  }

  function renderResultBoxes() {
    const steps = getCurrentSteps();
    const container = document.getElementById('result-boxes');

    if (!container) return;

    container.innerHTML = steps.map(step => `
      <div class="box">
        <label class="label">${step.name}</label>
        <textarea id="result-${step.id}" class="autosize" style="min-height: 140px;" placeholder="${step.name} ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤."></textarea>
      </div>
    `).join('');

    // ê²°ê³¼ ë³µì› ë° ìë™ ë†’ì´
    steps.forEach(step => {
      if (stepResults[step.id]) {
        const textarea = document.getElementById(`result-${step.id}`);
        if (textarea) {
          textarea.value = stepResults[step.id];
          autoResize(textarea);
        }
      }
    });

    // ì…ë ¥ ì´ë²¤íŠ¸ë¡œ ìë™ ë†’ì´ + ê²°ê³¼ ì €ì¥
    container.querySelectorAll('textarea').forEach(textarea => {
      textarea.addEventListener('input', () => {
        autoResize(textarea);
        // ì‚¬ìš©ìê°€ í¸ì§‘í•œ ë‚´ìš©ì„ stepResultsì— ì €ì¥
        const stepId = textarea.id.replace('result-', '');
        stepResults[stepId] = textarea.value;
        // â­ ì„¸ì…˜ì—ë„ ì €ì¥
        saveStep2ResultToSession(stepId, textarea.value);
      });
    });
  }

  function renderGuideTabs() {
    const steps = getCurrentSteps();
    const container = document.getElementById('guide-tabs');

    if (!container) return;

    container.innerHTML = steps.map(step =>
      `<button class="${step.id === currentGuideStep ? 'primary' : ''}"
        data-step="${step.id}">${step.name}</button>`
    ).join('');

    container.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        currentGuideStep = btn.dataset.step;
        renderGuideTabs();
        loadGuide(currentCategory, currentGuideStep);
      });
    });
  }

  // ===== ì²˜ë¦¬ ë‹¨ê³„ ì‹¤í–‰ =====
  async function executeStep(stepId) {
    const benchmarkScript = document.getElementById('benchmark-script').value;
    const mainCharacter = document.getElementById('main-character').value;
    const guideKey = getGuideKey(currentCategory, stepId);
    const guide = localStorage.getItem(guideKey) || '';

    // ì´ê´„ ì§€ì¹¨ ê°€ì ¸ì˜¤ê¸°
    const settings = config.categorySettings[currentCategory];
    const masterGuide = settings ? settings.masterGuide : '';

    const steps = getCurrentSteps();
    const currentStepIndex = steps.findIndex(s => s.id === stepId);
    const previousResults = {};
    for (let i = 0; i < currentStepIndex; i++) {
      const prevStep = steps[i];
      if (stepResults[prevStep.id]) {
        previousResults[prevStep.id] = {
          name: prevStep.name,
          result: stepResults[prevStep.id]
        };
      }
    }

    showStatus(`ğŸ¤– ${getStepName(stepId)} ì²˜ë¦¬ ì¤‘...`);

    try {
      const response = await fetch('/api/drama/process', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          category: currentCategory,
          stepId: stepId,
          stepName: getStepName(stepId),
          text: benchmarkScript,
          mainCharacter: mainCharacter,
          guide: guide,
          masterGuide: masterGuide,
          previousResults: previousResults
        })
      });

      const data = await response.json();

      if (data.ok) {
        stepResults[stepId] = data.result;
        // â­ ì„¸ì…˜ì—ë„ ì €ì¥
        saveStep2ResultToSession(stepId, data.result);

        const textarea = document.getElementById(`result-${stepId}`);
        if (textarea) {
          textarea.value = data.result;
          autoResize(textarea);
        }

        showStatus('âœ… ì™„ë£Œ!');
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
        showStatus('âŒ ì‹¤íŒ¨');
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
      showStatus('âŒ ì˜¤ë¥˜');
    } finally {
      setTimeout(hideStatus, 2000);
    }
  }

  // ===== ì¹´í…Œê³ ë¦¬ ë³€ê²½ =====
  const categorySelect = document.getElementById('drama-category');
  if (categorySelect) {
    categorySelect.addEventListener('change', (e) => {
      currentCategory = e.target.value;
      stepResults = {};
      const gptProContainer = document.getElementById('gpt-pro-result-container');
      if (gptProContainer) gptProContainer.style.display = 'none';

      loadMasterGuide(currentCategory);
      renderProcessingSteps();
      renderResultBoxes();
      renderGuideTabs();
    });
  }

  // ===== íŒ¨ìŠ¤ì›Œë“œ =====
  const toggleGuidesBtn = document.getElementById('toggle-guides');
  if (toggleGuidesBtn) {
    toggleGuidesBtn.addEventListener('click', () => {
      const content = document.getElementById('guide-content');
      const btn = document.getElementById('toggle-guides');

      if (!content || !btn) return;

      if (content.style.display === 'none') {
        if (!guideUnlocked) {
          const modal = document.getElementById('modal-password');
          if (modal) modal.classList.add('show');
          const input = document.getElementById('password-input');
          if (input) {
            input.value = '';
            input.focus();
          }
        } else {
          content.style.display = 'block';
          btn.textContent = 'ë‹«ê¸°';
        }
      } else {
        content.style.display = 'none';
        btn.textContent = 'ì—´ê¸°';
      }
    });
  }

  const btnSubmitPassword = document.getElementById('btn-submit-password');
  if (btnSubmitPassword) {
    btnSubmitPassword.addEventListener('click', () => {
      const input = document.getElementById('password-input');
      if (input && input.value === GUIDE_PASSWORD) {
        guideUnlocked = true;
        const modal = document.getElementById('modal-password');
        if (modal) modal.classList.remove('show');
        const content = document.getElementById('guide-content');
        if (content) content.style.display = 'block';
        const btn = document.getElementById('toggle-guides');
        if (btn) btn.textContent = 'ë‹«ê¸°';

        const steps = getCurrentSteps();
        if (steps.length > 0) {
          currentGuideStep = steps[0].id;
          renderGuideTabs();
          loadGuide(currentCategory, currentGuideStep);
        }
      } else {
        alert('âŒ íŒ¨ìŠ¤ì›Œë“œê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        if (input) input.value = '';
      }
    });
  }

  const btnCancelPassword = document.getElementById('btn-cancel-password');
  if (btnCancelPassword) {
    btnCancelPassword.addEventListener('click', () => {
      const modal = document.getElementById('modal-password');
      if (modal) modal.classList.remove('show');
    });
  }

  const passwordInput = document.getElementById('password-input');
  if (passwordInput) {
    passwordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const btn = document.getElementById('btn-submit-password');
        if (btn) btn.click();
      }
    });
  }

  const saveGuideBtn = document.getElementById('save-guide');
  if (saveGuideBtn) {
    saveGuideBtn.addEventListener('click', saveGuide);
  }

  // ===== GPT PRO íŒ¨ìŠ¤ì›Œë“œ =====
  const btnSubmitGptProPassword = document.getElementById('btn-submit-gpt-pro-password');
  if (btnSubmitGptProPassword) {
    btnSubmitGptProPassword.addEventListener('click', () => {
      const input = document.getElementById('gpt-pro-password-input');
      if (input && input.value === GPT_PRO_PASSWORD) {
        gptProUnlocked = true;
        const modal = document.getElementById('modal-gpt-pro-password');
        if (modal) modal.classList.remove('show');

        // íŒ¨ìŠ¤ì›Œë“œ í™•ì¸ í›„ GPT PRO ì‹¤í–‰
        executeGptPro();
      } else {
        alert('âŒ íŒ¨ìŠ¤ì›Œë“œê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        if (input) input.value = '';
      }
    });
  }

  const btnCancelGptProPassword = document.getElementById('btn-cancel-gpt-pro-password');
  if (btnCancelGptProPassword) {
    btnCancelGptProPassword.addEventListener('click', () => {
      const modal = document.getElementById('modal-gpt-pro-password');
      if (modal) modal.classList.remove('show');
    });
  }

  const gptProPasswordInput = document.getElementById('gpt-pro-password-input');
  if (gptProPasswordInput) {
    gptProPasswordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const btn = document.getElementById('btn-submit-gpt-pro-password');
        if (btn) btn.click();
      }
    });
  }

  // ===== ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ =====
  function renderCategoryManageList() {
    const list = document.getElementById('categories-list');
    if (!list) return;

    if (config.categories.length === 0) {
      list.innerHTML = '<p style="color: #999; font-size: .8rem; text-align: center; padding: .5rem;">ì¹´í…Œê³ ë¦¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>';
      return;
    }

    list.innerHTML = config.categories.map((cat, idx) => `
      <div class="storage-item">
        <div>
          <div style="font-weight: 600;">${cat.label}</div>
          <div style="font-size: .75rem; color: #666;">${cat.value}</div>
        </div>
        <div>
          <button onclick="editCategory(${idx})" style="margin-right: .3rem;">ì´ë¦„ ìˆ˜ì •</button>
          ${config.categories.length > 1 ? `<button class="danger" onclick="deleteCategory(${idx})">ì‚­ì œ</button>` : ''}
        </div>
      </div>
    `).join('');
  }

  const btnManageCategories = document.getElementById('btn-manage-categories');
  if (btnManageCategories) {
    btnManageCategories.addEventListener('click', () => {
      renderCategoryManageList();
      const modal = document.getElementById('modal-categories');
      if (modal) modal.classList.add('show');
    });
  }

  const btnCloseCategories = document.getElementById('btn-close-categories');
  if (btnCloseCategories) {
    btnCloseCategories.addEventListener('click', () => {
      const modal = document.getElementById('modal-categories');
      if (modal) modal.classList.remove('show');
    });
  }

  const btnAddCategory = document.getElementById('btn-add-category');
  if (btnAddCategory) {
    btnAddCategory.addEventListener('click', async () => {
      const input = document.getElementById('new-cat-label');
      if (!input) return;

      const label = input.value.trim();

      if (!label) {
        alert('í‘œì‹œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      const value = koreanToId(label);

      if (config.categories.find(c => c.value === value)) {
        alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¹´í…Œê³ ë¦¬ì…ë‹ˆë‹¤.');
        return;
      }

      config.categories.push({value, label});
      config.categorySettings[value] = {
        masterGuide: "",
        styles: []
      };

      await saveConfig();
      renderCategories();
      renderCategoryManageList();
      input.value = '';
    });
  }

  window.editCategory = async function(idx) {
    const current = config.categories[idx];
    if (!current) return;

    const newLabel = prompt('ìƒˆ ì˜ìƒ ì‹œê°„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', current.label);
    if (newLabel === null) return;

    const trimmed = newLabel.trim();
    if (!trimmed) {
      alert('í‘œì‹œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    current.label = trimmed;
    await saveConfig();
    renderCategories();
    renderCategoryManageList();
    if (current.value === currentCategory) {
      loadMasterGuide(currentCategory);
      renderProcessingSteps();
      renderResultBoxes();
      renderGuideTabs();
    }
  };

  window.deleteCategory = async function(idx) {
    if (!confirm(`"${config.categories[idx].label}" ì‚­ì œ?`)) return;
    const value = config.categories[idx].value;
    config.categories.splice(idx, 1);
    delete config.categorySettings[value];
    await saveConfig();
    renderCategories();
    renderCategoryManageList();
    loadMasterGuide(currentCategory);
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
  };

  // ===== ì²˜ë¦¬ ë‹¨ê³„ ê´€ë¦¬ ë²„íŠ¼ =====
  const btnManageSteps = document.getElementById('btn-manage-steps');
  if (btnManageSteps) {
    btnManageSteps.addEventListener('click', () => {
      const styleLabel = document.getElementById('modal-steps-style');
      if (styleLabel) styleLabel.textContent = 'í†µí•© ì²˜ë¦¬ ë‹¨ê³„';

      renderStepsManageList();

      const stepsModal = document.getElementById('modal-steps');
      if (stepsModal) stepsModal.classList.add('show');
    });
  }

  // Style management removed - using main character text input instead

  function renderStepsManageList() {
    const list = document.getElementById('steps-list');
    if (!list) return;

    if (!config.unifiedSteps) config.unifiedSteps = [];
    config.unifiedSteps.sort((a, b) => a.order - b.order);

    if (config.unifiedSteps.length === 0) {
      list.innerHTML = '<p style="color: #999; font-size: .8rem; text-align: center; padding: .5rem;">ë‹¨ê³„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>';
      return;
    }

    list.innerHTML = config.unifiedSteps.map((step, idx) => `
      <div class="storage-item">
        <span>${step.order}. ${step.name}</span>
        <div>
          ${idx > 0 ? `<button onclick="moveStep(${idx}, -1)" style="margin-right: .3rem;">â†‘</button>` : ''}
          ${idx < config.unifiedSteps.length - 1 ? `<button onclick="moveStep(${idx}, 1)" style="margin-right: .3rem;">â†“</button>` : ''}
          <button onclick="renameStep(${idx})" style="margin-right: .3rem;">ì´ë¦„ ìˆ˜ì •</button>
          <button class="danger" onclick="deleteStep(${idx})">ì‚­ì œ</button>
        </div>
      </div>
    `).join('');
  }

  const btnCloseSteps = document.getElementById('btn-close-steps');
  if (btnCloseSteps) {
    btnCloseSteps.addEventListener('click', () => {
      const modal = document.getElementById('modal-steps');
      if (modal) modal.classList.remove('show');
    });
  }

  const btnAddStep = document.getElementById('btn-add-step');
  if (btnAddStep) {
    btnAddStep.addEventListener('click', async () => {
      const input = document.getElementById('new-step-name');
      if (!input) return;

      const name = input.value.trim();

      if (!name) {
        alert('ë‹¨ê³„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      if (!config.unifiedSteps) config.unifiedSteps = [];

      const id = koreanToId(name);
      const maxOrder = config.unifiedSteps.length > 0 ? Math.max(...config.unifiedSteps.map(s => s.order)) : 0;

      config.unifiedSteps.push({
        id: id,
        name: name,
        order: maxOrder + 1
      });

      await saveConfig();
      renderProcessingSteps();
      renderResultBoxes();
      renderGuideTabs();
      renderStepsManageList();
      input.value = '';
    });
  }

  window.moveStep = async function(idx, direction) {
    if (!config.unifiedSteps) return;

    const steps = config.unifiedSteps;
    const targetIdx = idx + direction;

    if (targetIdx < 0 || targetIdx >= steps.length) return;

    [steps[idx].order, steps[targetIdx].order] = [steps[targetIdx].order, steps[idx].order];

    await saveConfig();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
    renderStepsManageList();
  };

  window.deleteStep = async function(idx) {
    if (!config.unifiedSteps) return;

    if (!confirm(`"${config.unifiedSteps[idx].name}" ì‚­ì œ?`)) return;

    config.unifiedSteps.splice(idx, 1);
    await saveConfig();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
    renderStepsManageList();
  };

  window.renameStep = async function(idx) {
    if (!config.unifiedSteps) return;

    const step = config.unifiedSteps[idx];
    if (!step) return;

    const newName = prompt('ìƒˆ ë‹¨ê³„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', step.name);
    if (newName === null) return;

    const trimmed = newName.trim();
    if (!trimmed) {
      alert('ë‹¨ê³„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    step.name = trimmed;
    await saveConfig();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
    renderStepsManageList();
  };

  // ===== ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° =====
  const btnSave = document.getElementById('btn-save');
  if (btnSave) {
    btnSave.addEventListener('click', () => {
      const saved = JSON.parse(localStorage.getItem('drama-saved') || '[]');
      const mainCharacter = document.getElementById('main-character').value.trim();

      saved.push({
        date: document.getElementById('drama-date').value,
        category: currentCategory,
        mainCharacter: mainCharacter,
        benchmarkScript: document.getElementById('benchmark-script').value,
        results: stepResults,
        savedAt: new Date().toISOString()
      });

      localStorage.setItem('drama-saved', JSON.stringify(saved));
      renderSavedList();
      alert('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    });
  }

  function renderSavedList() {
    const saved = JSON.parse(localStorage.getItem('drama-saved') || '[]');
    const list = document.getElementById('saved-list');

    if (!list) return;

    if (saved.length === 0) {
      list.innerHTML = '<p style="color: #999; font-size: .8rem; text-align: center; padding: .5rem;">ì €ì¥ëœ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    list.innerHTML = saved.map((item, idx) => {
      const catLabel = getCategoryLabel(item.category);
      const mainChar = item.mainCharacter || 'ì£¼ì¸ê³µ ë¯¸ì§€ì •';
      const display = `${item.date} - ${catLabel} - ${mainChar}`;

      return `
        <div class="storage-item">
          <span style="font-size: .85rem;">${display}</span>
          <div>
            <button onclick="loadSaved(${idx})" style="margin-right: .3rem;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button onclick="deleteSaved(${idx})">ì‚­ì œ</button>
          </div>
        </div>
      `;
    }).join('');
  }

  window.loadSaved = function(idx) {
    const saved = JSON.parse(localStorage.getItem('drama-saved') || '[]');
    const item = saved[idx];

    document.getElementById('drama-date').value = item.date || '';
    document.getElementById('drama-category').value = item.category || '10min';
    document.getElementById('benchmark-script').value = item.benchmarkScript || '';
    document.getElementById('main-character').value = item.mainCharacter || '';

    currentCategory = item.category || '10min';
    stepResults = item.results || {};

    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();

    document.querySelectorAll('textarea').forEach(autoResize);
  };

  window.deleteSaved = function(idx) {
    if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const saved = JSON.parse(localStorage.getItem('drama-saved') || '[]');
    saved.splice(idx, 1);
    localStorage.setItem('drama-saved', JSON.stringify(saved));
    renderSavedList();
  };

  // ===== textarea ìë™ ë†’ì´ =====
  document.querySelectorAll('textarea.autosize').forEach(textarea => {
    textarea.addEventListener('input', () => autoResize(textarea));
  });

  // ===== ë¶„ì„ ì˜ì—­ í† ê¸€ =====
  const toggleSuggestionsBtn = document.getElementById('toggle-suggestions');
  if (toggleSuggestionsBtn) {
    toggleSuggestionsBtn.addEventListener('click', () => {
      const content = document.getElementById('suggestions-content');
      const btn = document.getElementById('toggle-suggestions');
      if (content && btn) {
        if (content.style.display === 'none') {
          content.style.display = 'block';
          btn.textContent = 'ë‹«ê¸°';
        } else {
          content.style.display = 'none';
          btn.textContent = 'ì—´ê¸°';
        }
      }
    });
  }

  // ===== ëœë¤ ì£¼ì¸ê³µ ìƒì„± =====
  const btnRandomCharacter = document.getElementById('btn-random-character');
  if (btnRandomCharacter) {
    btnRandomCharacter.addEventListener('click', () => {
      const characters = [
        '30ëŒ€ ë‚¨ì„± ëª©ì‚¬',
        '20ëŒ€ ì—¬ì„± ëŒ€í•™ìƒ',
        '40ëŒ€ ë‚¨ì„± ì‚¬ì—…ê°€',
        '50ëŒ€ ì—¬ì„± ì£¼ë¶€',
        'ì²­ë…„ ì „ë„ì‚¬',
        'ì¤‘ë…„ ë‚¨ì„± êµì‚¬',
        '20ëŒ€ ë‚¨ì„± ì²­ë…„',
        '30ëŒ€ ì—¬ì„± ì§ì¥ì¸',
        'ê³ ë“±í•™ìƒ ë‚¨ì',
        'ê³ ë“±í•™ìƒ ì—¬ì',
        '60ëŒ€ ë…¸ë¶€ë¶€',
        'ì Šì€ ë¶€ë¶€',
        'ì´í˜¼í•œ ì¤‘ë…„ ì—¬ì„±',
        'í™€ì–´ë¨¸ë‹ˆì™€ ì•„ë“¤',
        'ì•„ë²„ì§€ì™€ ë”¸'
      ];
      const random = characters[Math.floor(Math.random() * characters.length)];
      document.getElementById('main-character').value = random;
    });
  }

  // ===== ë²¤ì¹˜ë§ˆí‚¹ ë¶„ì„ ê¸°ëŠ¥ =====
  const btnAnalyzeBenchmark = document.getElementById('btn-analyze-benchmark');
  if (btnAnalyzeBenchmark) {
    btnAnalyzeBenchmark.addEventListener('click', async () => {
      const benchmarkScript = document.getElementById('benchmark-script').value.trim();
      const uploadDate = document.getElementById('benchmark-upload-date').value.trim();
      const viewCount = document.getElementById('benchmark-view-count').value.trim();
      const analysisResult = document.getElementById('analysis-result');

      if (!benchmarkScript) {
        alert('ë²¤ì¹˜ë§ˆí‚¹ ëŒ€ë³¸ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!uploadDate || !viewCount) {
        alert('ì—…ë¡œë“œ ë‚ ì§œì™€ ì¡°íšŒìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ê°„ë‹¨í•œ í•´ì‹œ ìƒì„± í•¨ìˆ˜ (ì¤‘ë³µ ì²´í¬ìš©)
      const generateSimpleHash = (text) => {
        let hash = 0;
        for (let i = 0; i < text.length; i++) {
          const char = text.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash;
        }
        return hash.toString(36);
      };

      // ì¤‘ë³µ ìë£Œ ì²´í¬ë°•ìŠ¤ ìƒíƒœ í™•ì¸ (ì²´í¬ ì‹œ ë¶„ì„ë§Œ ìˆ˜í–‰, ì €ì¥ ì•ˆ í•¨)
      const isDuplicateData = document.getElementById('check-duplicates')?.checked || false;
      const scriptHash = isDuplicateData ? '' : generateSimpleHash(benchmarkScript);

      // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
      showLoadingOverlay('ë²¤ì¹˜ë§ˆí¬ ëŒ€ë³¸ ë¶„ì„ ì¤‘', 'AIê°€ ëŒ€ë³¸ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
      analysisResult.innerHTML = '<p style="color: #e74c3c; text-align: center;">ğŸ”„ ë¶„ì„ ì¤‘...</p>';

      try {
        const response = await fetch('/api/drama/analyze-benchmark', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            benchmarkScript: benchmarkScript,
            uploadDate: uploadDate,
            viewCount: viewCount,
            category: currentCategory,
            scriptHash: scriptHash
          })
        });

        const data = await response.json();

        if (data.ok) {
          const statusMessage = data.isDuplicate
            ? '<strong style="color: #f39c12;">âš ï¸ ì¤‘ë³µ ëŒ€ë³¸ - ë¶„ì„ë§Œ ìˆ˜í–‰ë¨ (ì €ì¥ ì•ˆ ë¨)</strong>'
            : '<strong style="color: #e74c3c;">âœ… ë¶„ì„ ì™„ë£Œ ë° DB ì €ì¥ë¨</strong>';

          analysisResult.innerHTML = `
            <div style="margin-bottom: .75rem;">
              ${statusMessage}
            </div>
            <div style="white-space: pre-wrap; line-height: 1.8;">${data.analysis}</div>
          `;
        } else {
          analysisResult.innerHTML = `<p style="color: #e74c3c;">âŒ ì˜¤ë¥˜: ${data.error}</p>`;
        }
      } catch (err) {
        analysisResult.innerHTML = `<p style="color: #e74c3c;">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}</p>`;
      } finally {
        hideLoadingOverlay();
      }
    });
  }

  // ===== ê°œì„  ì œì•ˆ ë°›ê¸° =====
  const btnGetSuggestions = document.getElementById('btn-get-suggestions');
  if (btnGetSuggestions) {
    btnGetSuggestions.addEventListener('click', async () => {
      const suggestionsResult = document.getElementById('suggestions-result');

      // ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ê²°ê³¼ë¥¼ ëª¨ì•„ì„œ ì „ë‹¬
      let allContent = '';
      workflowBoxes.forEach(box => {
        if (box.result) {
          allContent += `\n\n[${box.boxNumber}. ${box.name}]\n${box.result}\n`;
        }
      });

      if (!allContent) {
        alert('ì‘ì—… ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
        return;
      }

      suggestionsResult.innerHTML = '<p style="color: #4a90e2; text-align: center;">ğŸ”„ ì œì•ˆ ìƒì„± ì¤‘...</p>';

      try {
        const response = await fetch('/api/drama/get-suggestions', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            currentDraft: allContent,
            category: currentCategory
          })
        });

        const data = await response.json();

        if (data.ok) {
          suggestionsResult.innerHTML = `
            <div style="white-space: pre-wrap; line-height: 1.8;">${data.suggestions}</div>
          `;
        } else {
          suggestionsResult.innerHTML = `<p style="color: #e74c3c;">âŒ ì˜¤ë¥˜: ${data.error}</p>`;
        }
      } catch (err) {
        suggestionsResult.innerHTML = `<p style="color: #e74c3c;">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}</p>`;
      }
    });
  }

  // ===== ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ì‹œìŠ¤í…œ =====

  // ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ì¶”ê°€
  function addWorkflowBox(stepType = 'step1') {
    const stepLabel = stepType === 'step1' ? 'Step1' : 'Step2';
    const stepNumber = stepType === 'step1' ? nextStep1BoxNum : nextStep2BoxNum;

    const box = {
      id: `box_${nextBoxId}`,
      boxNumber: nextBoxId,
      stepNumber: stepNumber,
      stepType: stepType,
      name: `${stepLabel} ì‘ì—… ${stepNumber}`,
      inputs: {
        benchmarkScript: false,
        aiAnalysis: false
      },
      guide: '',
      result: ''
    };

    workflowBoxes.push(box);
    nextBoxId++;

    if (stepType === 'step1') {
      nextStep1BoxNum++;
    } else {
      nextStep2BoxNum++;
    }

    renderWorkflowBoxes();
    saveWorkflowBoxes();
  }

  // ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ì‚­ì œ
  function deleteWorkflowBox(boxId) {
    const index = workflowBoxes.findIndex(b => b.id === boxId);
    if (index !== -1) {
      if (confirm(`"${workflowBoxes[index].name}" ë°•ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        workflowBoxes.splice(index, 1);

        // Stepë³„ ë°•ìŠ¤ ë²ˆí˜¸ ì¬ì •ë ¬
        const step1Boxes = workflowBoxes.filter(b => b.stepType === 'step1');
        const step2Boxes = workflowBoxes.filter(b => b.stepType === 'step2');

        step1Boxes.forEach((box, idx) => {
          box.stepNumber = idx + 1;
          box.name = `Step1 ì‘ì—… ${idx + 1}`;
        });

        step2Boxes.forEach((box, idx) => {
          box.stepNumber = idx + 1;
          box.name = `Step2 ì‘ì—… ${idx + 1}`;
        });

        // ë‹¤ìŒ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
        nextStep1BoxNum = step1Boxes.length + 1;
        nextStep2BoxNum = step2Boxes.length + 1;

        renderWorkflowBoxes();
        saveWorkflowBoxes();
      }
    }
  }

  // ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ë Œë”ë§
  function renderWorkflowBoxes() {
    const container = document.getElementById('workflow-boxes-container');
    if (!container) return;

    if (workflowBoxes.length === 0) {
      container.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">â• ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‘ì—… ë°•ìŠ¤ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>';
      return;
    }

    container.innerHTML = workflowBoxes.map((box, index) => {
      const stepType = box.stepType || 'step1';  // ê¸°ë³¸ê°’ step1
      const stepBadgeClass = stepType === 'step1' ? 'step1' : 'step2';
      const stepBadgeColor = stepType === 'step1' ? '#ff6b6b' : '#4ecdc4';
      const stepBadgeGradient = stepType === 'step1' ? 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)' : 'linear-gradient(135deg, #4ecdc4 0%, #44a3c2 100%)';
      const stepBgColor = stepType === 'step1' ? '#fff5f5' : '#f0fdfc';
      const stepLabel = stepType === 'step1' ? 'Step1' : 'Step2';

      return `
      <div class="box workflow-box ${stepType}" id="workflow-box-${box.id}" draggable="true" data-box-index="${index}" style="margin-bottom: .5rem; border-left: 4px solid ${stepBadgeColor}; cursor: move;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
          <div style="display: flex; align-items: center; gap: .4rem; flex: 1;">
            <span style="cursor: grab; font-size: 1rem; color: #999; user-select: none;">â‹®â‹®</span>
            <span style="background: ${stepBadgeGradient}; color: white; padding: .25rem .5rem; border-radius: 6px; font-weight: 600; font-size: .75rem; box-shadow: 0 2px 4px rgba(0,0,0,.1);">${stepLabel} ${box.stepNumber || box.boxNumber}</span>
            <input type="text" value="${box.name}" onchange="updateBoxName('${box.id}', this.value)" style="font-weight: 600; font-size: .85rem; border: none; padding: .2rem .4rem; border-radius: 4px; background: #f8f9fa; flex: 1;" onclick="(function(e){e.stopPropagation();})(event)">
          </div>
          <div style="display: flex; gap: .3rem; align-items: center;">
            <button onclick="(function(e){executeWorkflowBox('${box.id}'); e.stopPropagation();})(event)" style="padding: .25rem .5rem; font-size: .75rem; background: ${stepBadgeGradient}; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">â–¶ï¸</button>
            <button onclick="(function(e){copyBoxResult('${box.id}'); e.stopPropagation();})(event)" style="padding: .25rem .5rem; font-size: .75rem; background: white; border: 2px solid ${stepBadgeColor}; color: ${stepBadgeColor}; border-radius: 6px; cursor: pointer; font-weight: 600;">ğŸ“‹</button>
            ${index > 0 ? `<button onclick="(function(e){moveBoxUp(${index}); e.stopPropagation();})(event)" style="padding: .25rem .4rem; font-size: .75rem; border-radius: 4px; background: #f8f9fa; border: none; cursor: pointer;">â–²</button>` : ''}
            ${index < workflowBoxes.length - 1 ? `<button onclick="(function(e){moveBoxDown(${index}); e.stopPropagation();})(event)" style="padding: .25rem .4rem; font-size: .75rem; border-radius: 4px; background: #f8f9fa; border: none; cursor: pointer;">â–¼</button>` : ''}
            <button onclick="deleteWorkflowBox('${box.id}')" class="danger" style="padding: .25rem .5rem; font-size: .75rem; border-radius: 6px;">ğŸ—‘ï¸</button>
          </div>
        </div>

        <div class="box-content" id="content-${box.id}" style="display: ${(stepType === 'step1' && step1Collapsed) || (stepType === 'step2' && step2Collapsed) ? 'none' : 'block'}">
        <!-- ì…ë ¥ ì†ŒìŠ¤ ì„ íƒ -->
        <div style="background: ${stepBgColor}; padding: .5rem; border-radius: 8px; margin-bottom: .5rem; border: 1px solid ${stepBadgeColor}20;">
          <div style="font-size: .75rem; font-weight: 600; margin-bottom: .4rem; color: #555;">ğŸ“¥ ì…ë ¥ ì†ŒìŠ¤</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: .3rem;">
            <label style="display: flex; align-items: center; gap: .25rem; cursor: pointer; padding: .2rem; border-radius: 4px; transition: background 0.2s;">
              <input type="checkbox" ${box.inputs.benchmarkScript ? 'checked' : ''} onchange="updateBoxInput('${box.id}', 'benchmarkScript', this.checked)">
              <span style="font-size: .75rem;">ë²¤ì¹˜ë§ˆí‚¹ ëŒ€ë³¸</span>
            </label>
            <label style="display: flex; align-items: center; gap: .25rem; cursor: pointer; padding: .2rem; border-radius: 4px; transition: background 0.2s;">
              <input type="checkbox" ${box.inputs.aiAnalysis ? 'checked' : ''} onchange="updateBoxInput('${box.id}', 'aiAnalysis', this.checked)">
              <span style="font-size: .75rem;">AI ë¶„ì„</span>
            </label>
            ${workflowBoxes.slice(0, index).filter(b => b.stepType === stepType).map(otherBox => `
              <label style="display: flex; align-items: center; gap: .25rem; cursor: pointer; padding: .2rem; border-radius: 4px; transition: background 0.2s;">
                <input type="checkbox" ${box.inputs[`box_${otherBox.boxNumber}`] ? 'checked' : ''} onchange="updateBoxInput('${box.id}', 'box_${otherBox.boxNumber}', this.checked)">
                <span style="font-size: .75rem;">[${otherBox.stepNumber || otherBox.boxNumber}] ${otherBox.name}</span>
              </label>
            `).join('')}
          </div>
        </div>

        <!-- ê²°ê³¼ í‘œì‹œ -->
        <div style="background: ${stepBgColor}; padding: .5rem; border-radius: 8px; border: 1px solid ${stepBadgeColor}30;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .3rem;">
            <div style="font-size: .75rem; font-weight: 600; color: ${stepBadgeColor};">ğŸ“Š ê²°ê³¼</div>
            <div id="token-info-${box.id}" style="font-size: .65rem; color: #888; display: ${box.usage ? 'flex' : 'none'}; gap: .5rem; align-items: center;">
              ${box.usage ? `
                <span>ğŸ“¥ ${box.usage.input_tokens?.toLocaleString() || 0}</span>
                <span>ğŸ“¤ ${box.usage.output_tokens?.toLocaleString() || 0}</span>
                <span style="color: ${stepBadgeColor}; font-weight: 600;">ğŸ’° ${(() => {
                  const cost = calculateCost(box.usage.model, box.usage.input_tokens || 0, box.usage.output_tokens || 0);
                  return cost ? 'â‚©' + cost.totalCostKRW : '-';
                })()}</span>
              ` : ''}
            </div>
          </div>
          <textarea id="result-${box.id}" readonly style="width: 100%; min-height: 80px; font-size: .75rem; padding: .4rem; border: none; border-radius: 6px; background: white; box-shadow: inset 0 1px 3px rgba(0,0,0,.05); resize: vertical;" placeholder="ì‹¤í–‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...">${box.result}</textarea>
        </div>
        </div>
      </div>
      `;
    }).join('');

    // ì§€ì¹¨ ê´€ë¦¬ íŒ¨ë„ë„ ì—…ë°ì´íŠ¸
    renderGuideManagement();

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì¬ì„¤ì •
    setupDragAndDrop();
  }

  // Step3 ì§€ì¹¨ ì €ì¥ìš© ë³€ìˆ˜
  let step3Guide = localStorage.getItem('_drama-step3-guide') || '';

  // Step3 ê²°ê³¼ ì €ì¥ìš© ë³€ìˆ˜
  let step3Result = localStorage.getItem('_drama-step3-result') || '';

  // AI ëª¨ë¸ ì„¤ì • (ê¸°ë³¸ê°’)
  let aiModelSettings = JSON.parse(localStorage.getItem('_drama-ai-models') || 'null') || {
    step1: 'gpt-4o-mini',
    step2: 'gpt-4o-mini',
    step3: 'anthropic/claude-sonnet-4.5',
    benchmarkAnalysis: 'gpt-4o-mini'
  };

  // ëª¨ë¸ë³„ ê°€ê²© ì •ë³´ (1M í† í°ë‹¹ USD) - ê¸°ì¤€: gpt-4o (í‰ê· )
  const modelPricing = {
    // OpenAI ëª¨ë¸ (ê¸°ì¤€: gpt-4o = 0%)
    'gpt-4o-mini': { input: 0.15, output: 0.60, diff: -94 },      // ë§¤ìš° ì €ë ´
    'gpt-4o': { input: 2.50, output: 10.00, diff: 0 },            // ê¸°ì¤€ (í‰ê· )
    'gpt-4.5-preview': { input: 75.00, output: 150.00, diff: +2900 }, // í”„ë¦¬ë¯¸ì—„
    'gpt-5': { input: 5.00, output: 20.00, diff: +100 },          // ê³ í’ˆì§ˆ
    'gpt-5.1': { input: 7.50, output: 30.00, diff: +200 },        // ìµœì‹ 
    // OpenRouter ëª¨ë¸ (ê¸°ì¤€: claude-sonnet-4.5 = 0%)
    'anthropic/claude-sonnet-4.5': { input: 3.00, output: 15.00, diff: 0 },  // Sonnet 4.5 (ê¸°ì¤€)
    'anthropic/claude-sonnet-4': { input: 3.00, output: 15.00, diff: 0 },       // Sonnet 4
    'anthropic/claude-3.5-sonnet': { input: 3.00, output: 15.00, diff: 0 },     // 3.5 Sonnet
    'anthropic/claude-3-opus': { input: 15.00, output: 75.00, diff: +400 },     // ìµœê³  í’ˆì§ˆ
    'anthropic/claude-3-haiku': { input: 0.25, output: 1.25, diff: -92 },       // ì €ë ´
    'google/gemini-pro-1.5': { input: 1.25, output: 5.00, diff: -58 },          // ì¤‘ì €ê°€
    'meta-llama/llama-3.1-70b-instruct': { input: 0.52, output: 0.75, diff: -83 } // ì €ë ´
  };

  // ë¹„ìš© ê³„ì‚° í•¨ìˆ˜
  function calculateCost(modelId, inputTokens, outputTokens) {
    const pricing = modelPricing[modelId];
    if (!pricing) return null;
    const inputCost = (inputTokens / 1000000) * pricing.input;
    const outputCost = (outputTokens / 1000000) * pricing.output;
    return {
      inputCost: inputCost.toFixed(6),
      outputCost: outputCost.toFixed(6),
      totalCost: (inputCost + outputCost).toFixed(6),
      totalCostKRW: ((inputCost + outputCost) * 1400).toFixed(2) // ì›í™” í™˜ì‚° (ëŒ€ëµ)
    };
  }

  // ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡ - ê°€ê²© ì°¨ì´ % í¬í•¨
  const availableModels = {
    openai: [
      { id: 'gpt-4o-mini', name: 'GPT-4o Mini (-94% ì €ë ´)' },
      { id: 'gpt-4o', name: 'GPT-4o (ê¸°ì¤€, í‰ê· )' },
      { id: 'gpt-5', name: 'GPT-5 (+100% ê³ í’ˆì§ˆ)' },
      { id: 'gpt-5.1', name: 'GPT-5.1 (+200% ìµœì‹ )' },
      { id: 'gpt-4.5-preview', name: 'GPT-4.5 Preview (+2900% í”„ë¦¬ë¯¸ì—„)' }
    ],
    openrouter: [
      { id: 'anthropic/claude-sonnet-4.5', name: 'Claude Sonnet 4.5 (ê¸°ì¤€, ì¶”ì²œ)' },
      { id: 'anthropic/claude-sonnet-4', name: 'Claude Sonnet 4 (ë™ì¼ê°€ê²©)' },
      { id: 'anthropic/claude-3.5-sonnet', name: 'Claude 3.5 Sonnet (ë™ì¼ê°€ê²©)' },
      { id: 'anthropic/claude-3-opus', name: 'Claude 3 Opus (+400% ìµœê³ í’ˆì§ˆ)' },
      { id: 'anthropic/claude-3-haiku', name: 'Claude 3 Haiku (-92% ì €ë ´)' },
      { id: 'google/gemini-pro-1.5', name: 'Gemini Pro 1.5 (-58%)' },
      { id: 'meta-llama/llama-3.1-70b-instruct', name: 'Llama 3.1 70B (-83% ì €ë ´)' }
    ]
  };

  // ì§€ì¹¨ ê´€ë¦¬ ëª¨ë‹¬ ë Œë”ë§ (Step1, Step2, Step3 + AI ëª¨ë¸ ì„¤ì •)
  function renderGuideManagement() {
    const container = document.getElementById('modal-guide-container');
    if (!container) return;

    let html = '';

    // ===== AI ëª¨ë¸ ì„¤ì • ì„¹ì…˜ =====
    html += `<div style="margin-bottom: 1.5rem;">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: .5rem 1rem; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 1rem;">ğŸ¤– AI ëª¨ë¸ ì„¤ì •</div>
      <div style="background: #f8f5ff; padding: 1rem; border-radius: 0 0 8px 8px; border: 2px solid #667eea; border-top: none;">
        <div style="font-size: .85rem; color: #666; margin-bottom: 1rem;">
          ê° ê¸°ëŠ¥ì—ì„œ ì‚¬ìš©í•  AI ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”. ë³€ê²½ í›„ ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">

          <!-- ë²¤ì¹˜ë§ˆí‚¹ ë¶„ì„ ëª¨ë¸ (ì²« ë²ˆì§¸) -->
          <div style="background: white; padding: .75rem; border-radius: 8px; border: 1px solid #e0e0e0;">
            <label style="font-weight: 600; font-size: .85rem; color: #667eea; display: block; margin-bottom: .4rem;">ğŸ“Š ë²¤ì¹˜ë§ˆí‚¹ ë¶„ì„</label>
            <select id="model-benchmark" style="width: 100%; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem;">
              ${availableModels.openai.map(m => `<option value="${m.id}" ${aiModelSettings.benchmarkAnalysis === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
            </select>
          </div>

          <!-- Step1 ëª¨ë¸ -->
          <div style="background: white; padding: .75rem; border-radius: 8px; border: 1px solid #e0e0e0;">
            <label style="font-weight: 600; font-size: .85rem; color: #ff6b6b; display: block; margin-bottom: .4rem;">Step1 (ë²¤ì¹˜ë§ˆí‚¹ ëŒ€ë³¸ ë¶„ì„)</label>
            <select id="model-step1" style="width: 100%; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem;">
              ${availableModels.openai.map(m => `<option value="${m.id}" ${aiModelSettings.step1 === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
            </select>
          </div>

          <!-- Step2 ëª¨ë¸ -->
          <div style="background: white; padding: .75rem; border-radius: 8px; border: 1px solid #e0e0e0;">
            <label style="font-weight: 600; font-size: .85rem; color: #4ecdc4; display: block; margin-bottom: .4rem;">Step2 (ìƒˆ ëŒ€ë³¸ ì œì‘)</label>
            <select id="model-step2" style="width: 100%; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem;">
              ${availableModels.openai.map(m => `<option value="${m.id}" ${aiModelSettings.step2 === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
            </select>
          </div>

          <!-- Step3 ëª¨ë¸ (OpenRouter) -->
          <div style="background: white; padding: .75rem; border-radius: 8px; border: 1px solid #e0e0e0;">
            <label style="font-weight: 600; font-size: .85rem; color: #f39c12; display: block; margin-bottom: .4rem;">Step3 (OpenRouter ìµœì¢… ëŒ€ë³¸)</label>
            <select id="model-step3" style="width: 100%; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem;">
              ${availableModels.openrouter.map(m => `<option value="${m.id}" ${aiModelSettings.step3 === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
            </select>
          </div>

        </div>
      </div>
    </div>`;

    // Step1 ë°•ìŠ¤ë“¤
    const step1Boxes = workflowBoxes.filter(b => (b.stepType || 'step1') === 'step1');
    if (step1Boxes.length > 0) {
      html += `<div style="margin-bottom: 1.5rem;">
        <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; padding: .5rem 1rem; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 1rem;">ğŸ“‹ Step1 ì§€ì¹¨ (ë²¤ì¹˜ë§ˆí‚¹ ë¶„ì„)</div>
        <div style="background: #fff5f5; padding: 1rem; border-radius: 0 0 8px 8px; border: 2px solid #ff6b6b; border-top: none;">`;

      step1Boxes.forEach(box => {
        html += `
          <div style="margin-bottom: 1rem;">
            <div style="font-weight: 600; font-size: .9rem; color: #333; margin-bottom: .4rem;">${box.stepNumber || box.boxNumber}. ${box.name}</div>
            <textarea
              id="modal-guide-${box.id}"
              onchange="updateBoxGuide('${box.id}', this.value)"
              style="width: 100%; min-height: 80px; font-size: .85rem; padding: .6rem; border: 1px solid #ffcdd2; border-radius: 6px; font-family: inherit; resize: vertical;"
              placeholder="ì´ ì‘ì—…ì˜ êµ¬ì²´ì ì¸ ì§€ì¹¨ì„ ì…ë ¥í•˜ì„¸ìš”...">${box.guide || ''}</textarea>
          </div>`;
      });
      html += `</div></div>`;
    }

    // Step2 ë°•ìŠ¤ë“¤
    const step2Boxes = workflowBoxes.filter(b => b.stepType === 'step2');
    if (step2Boxes.length > 0) {
      html += `<div style="margin-bottom: 1.5rem;">
        <div style="background: linear-gradient(135deg, #4ecdc4 0%, #44a3c2 100%); color: white; padding: .5rem 1rem; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 1rem;">ğŸ“‹ Step2 ì§€ì¹¨ (ìƒˆ ëŒ€ë³¸ ì œì‘)</div>
        <div style="background: #f0fdfc; padding: 1rem; border-radius: 0 0 8px 8px; border: 2px solid #4ecdc4; border-top: none;">`;

      step2Boxes.forEach(box => {
        html += `
          <div style="margin-bottom: 1rem;">
            <div style="font-weight: 600; font-size: .9rem; color: #333; margin-bottom: .4rem;">${box.stepNumber || box.boxNumber}. ${box.name}</div>
            <textarea
              id="modal-guide-${box.id}"
              onchange="updateBoxGuide('${box.id}', this.value)"
              style="width: 100%; min-height: 80px; font-size: .85rem; padding: .6rem; border: 1px solid #b2dfdb; border-radius: 6px; font-family: inherit; resize: vertical;"
              placeholder="ì´ ì‘ì—…ì˜ êµ¬ì²´ì ì¸ ì§€ì¹¨ì„ ì…ë ¥í•˜ì„¸ìš”...">${box.guide || ''}</textarea>
          </div>`;
      });
      html += `</div></div>`;
    }

    // Step3 ì§€ì¹¨ (OpenRouter ëŒ€ë³¸ ì™„ì„±)
    html += `<div style="margin-bottom: 1rem;">
      <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: .5rem 1rem; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 1rem;">ğŸ¬ Step3 ì§€ì¹¨ (OpenRouter ëŒ€ë³¸ ì™„ì„±)</div>
      <div style="background: #fffbf0; padding: 1rem; border-radius: 0 0 8px 8px; border: 2px solid #f39c12; border-top: none;">
        <div style="font-size: .85rem; color: #666; margin-bottom: .5rem;">
          OpenRouter AIê°€ ìµœì¢… ëŒ€ë³¸ì„ ì‘ì„±í•  ë•Œ ì°¸ê³ í•  ì§€ì¹¨ì…ë‹ˆë‹¤.
        </div>
        <textarea
          id="modal-guide-step3"
          style="width: 100%; min-height: 120px; font-size: .85rem; padding: .6rem; border: 1px solid #ffe0b2; border-radius: 6px; font-family: inherit; resize: vertical;"
          placeholder="ì˜ˆ: ëŒ€ì‚¬ëŠ” ìì—°ìŠ¤ëŸ½ê²Œ, ì¥ë©´ ì „í™˜ì€ ë¶€ë“œëŸ½ê²Œ, ê°ì •ì„ ì„ ê°•ì¡°í•´ì„œ ì‘ì„±í•´ì£¼ì„¸ìš”...">${step3Guide}</textarea>
      </div>
    </div>`;

    if (workflowBoxes.length === 0) {
      html = `<p style="color: #999; text-align: center; padding: 1rem;">ì‘ì—… ë°•ìŠ¤ë¥¼ ì¶”ê°€í•˜ë©´ Step1/Step2 ì§€ì¹¨ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>` + html;
    }

    container.innerHTML = html;
  }

  // ë°•ìŠ¤ ì´ë¦„ ì—…ë°ì´íŠ¸
  window.updateBoxName = function(boxId, newName) {
    const box = workflowBoxes.find(b => b.id === boxId);
    if (box) {
      box.name = newName;
      saveWorkflowBoxes();
      renderWorkflowBoxes();
    }
  };

  // ì…ë ¥ ì†ŒìŠ¤ ì—…ë°ì´íŠ¸
  window.updateBoxInput = function(boxId, inputKey, checked) {
    const box = workflowBoxes.find(b => b.id === boxId);
    if (box) {
      box.inputs[inputKey] = checked;
      saveWorkflowBoxes();
    }
  };

  // ì§€ì¹¨ ì—…ë°ì´íŠ¸ (onChangeëŠ” ë©”ëª¨ë¦¬ì—ë§Œ ì €ì¥, ì‹¤ì œ ì €ì¥ì€ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ)
  window.updateBoxGuide = function(boxId, guide) {
    const box = workflowBoxes.find(b => b.id === boxId);
    if (box) {
      box.guide = guide;
      // ë‹¤ë¥¸ í…ìŠ¤íŠ¸ì˜ì—­ë„ ë™ê¸°í™” (íŒ¨ë„ê³¼ ë°•ìŠ¤ ì–‘ìª½)
      const panelTextarea = document.getElementById(`guide-panel-${boxId}`);
      if (panelTextarea && panelTextarea.value !== guide) {
        panelTextarea.value = guide;
      }
    }
  };

  // ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ì‹¤í–‰
  window.executeWorkflowBox = async function(boxId) {
    const box = workflowBoxes.find(b => b.id === boxId);
    if (!box) return;

    // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
    showLoadingOverlay(`[${box.boxNumber}] ${box.name} ì²˜ë¦¬ ì¤‘`, 'AIê°€ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

    // ì…ë ¥ ë°ì´í„° ìˆ˜ì§‘
    let inputData = {};

    if (box.inputs.benchmarkScript) {
      inputData.benchmarkScript = document.getElementById('benchmark-script').value;
    }

    if (box.inputs.aiAnalysis) {
      inputData.aiAnalysis = document.getElementById('analysis-result').innerText;
    }

    // ë‹¤ë¥¸ ë°•ìŠ¤ì˜ ê²°ê³¼ ìˆ˜ì§‘
    for (const [key, value] of Object.entries(box.inputs)) {
      if (key.startsWith('box_') && value) {
        const boxNumber = parseInt(key.replace('box_', ''));
        const sourceBox = workflowBoxes.find(b => b.boxNumber === boxNumber);
        if (sourceBox && sourceBox.result) {
          inputData[`box${boxNumber}Result`] = sourceBox.result;
        }
      }
    }

    // ì£¼ì¸ê³µ ì •ë³´ ìˆ˜ì§‘
    const mainCharacter = document.getElementById('main-character')?.value.trim() || '';

    // stepTypeì— ë”°ë¼ ì ì ˆí•œ ëª¨ë¸ ì„ íƒ
    const stepType = box.stepType || 'step1';
    const modelToUse = stepType === 'step1' ? aiModelSettings.step1 : aiModelSettings.step2;

    try {
      const response = await fetch('/api/drama/workflow-execute', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          boxId: box.id,
          boxName: box.name,
          boxNumber: box.boxNumber,
          stepType: stepType,
          guide: box.guide,
          inputs: inputData,
          category: currentCategory,
          mainCharacter: mainCharacter,
          model: modelToUse
        })
      });

      const data = await response.json();

      if (data.ok) {
        box.result = data.result;
        box.usage = data.usage;  // í† í° ì‚¬ìš©ëŸ‰ ì €ì¥
        document.getElementById(`result-${box.id}`).value = data.result;

        // í† í° ì •ë³´ ì—…ë°ì´íŠ¸
        const tokenInfoDiv = document.getElementById(`token-info-${box.id}`);
        if (tokenInfoDiv && data.usage) {
          const cost = calculateCost(data.usage.model, data.usage.input_tokens || 0, data.usage.output_tokens || 0);
          tokenInfoDiv.innerHTML = `
            <span>ğŸ“¥ ${(data.usage.input_tokens || 0).toLocaleString()}</span>
            <span>ğŸ“¤ ${(data.usage.output_tokens || 0).toLocaleString()}</span>
            <span style="color: inherit; font-weight: 600;">ğŸ’° ${cost ? 'â‚©' + cost.totalCostKRW : '-'}</span>
          `;
          tokenInfoDiv.style.display = 'flex';
        }

        saveWorkflowBoxes();
        showStatus('âœ… ì™„ë£Œ!');
        setTimeout(hideStatus, 2000);
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
    } finally {
      hideLoadingOverlay();
    }
  };

  // ë°•ìŠ¤ ê²°ê³¼ ë³µì‚¬
  window.copyBoxResult = function(boxId) {
    const textarea = document.getElementById(`result-${boxId}`);
    if (textarea && textarea.value) {
      textarea.select();
      document.execCommand('copy');
      showStatus('âœ… ë³µì‚¬ ì™„ë£Œ!');
      setTimeout(hideStatus, 1500);
    }
  };

  // ë°•ìŠ¤ ìˆœì„œ ì´ë™ (ìœ„ë¡œ)
  window.moveBoxUp = function(index) {
    if (index > 0) {
      [workflowBoxes[index], workflowBoxes[index - 1]] = [workflowBoxes[index - 1], workflowBoxes[index]];
      renderWorkflowBoxes();
      saveWorkflowBoxes();
    }
  };

  // ë°•ìŠ¤ ìˆœì„œ ì´ë™ (ì•„ë˜ë¡œ)
  window.moveBoxDown = function(index) {
    if (index < workflowBoxes.length - 1) {
      [workflowBoxes[index], workflowBoxes[index + 1]] = [workflowBoxes[index + 1], workflowBoxes[index]];
      renderWorkflowBoxes();
      saveWorkflowBoxes();
    }
  };

  // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
  let draggedBoxIndex = null;

  function setupDragAndDrop() {
    const container = document.getElementById('workflow-boxes-container');
    if (!container) return;

    container.addEventListener('dragstart', (e) => {
      if (e.target.classList.contains('workflow-box')) {
        draggedBoxIndex = parseInt(e.target.dataset.boxIndex);
        e.target.style.opacity = '0.4';
      }
    });

    container.addEventListener('dragend', (e) => {
      if (e.target.classList.contains('workflow-box')) {
        e.target.style.opacity = '1';
        draggedBoxIndex = null;
      }
    });

    container.addEventListener('dragover', (e) => {
      e.preventDefault();
      const targetBox = e.target.closest('.workflow-box');
      if (targetBox && draggedBoxIndex !== null) {
        const targetIndex = parseInt(targetBox.dataset.boxIndex);
        if (draggedBoxIndex !== targetIndex) {
          const rect = targetBox.getBoundingClientRect();
          const midpoint = rect.top + rect.height / 2;
          if (e.clientY < midpoint) {
            targetBox.style.borderTop = '3px solid #667eea';
            targetBox.style.borderBottom = '';
          } else {
            targetBox.style.borderTop = '';
            targetBox.style.borderBottom = '3px solid #667eea';
          }
        }
      }
    });

    container.addEventListener('dragleave', (e) => {
      const targetBox = e.target.closest('.workflow-box');
      if (targetBox) {
        targetBox.style.borderTop = '';
        targetBox.style.borderBottom = '';
      }
    });

    container.addEventListener('drop', (e) => {
      e.preventDefault();
      const targetBox = e.target.closest('.workflow-box');
      if (targetBox && draggedBoxIndex !== null) {
        const targetIndex = parseInt(targetBox.dataset.boxIndex);

        if (draggedBoxIndex !== targetIndex) {
          const draggedBox = workflowBoxes[draggedBoxIndex];
          workflowBoxes.splice(draggedBoxIndex, 1);

          const rect = targetBox.getBoundingClientRect();
          const midpoint = rect.top + rect.height / 2;
          const insertIndex = e.clientY < midpoint ? targetIndex : targetIndex + 1;
          const finalIndex = draggedBoxIndex < targetIndex ? insertIndex - 1 : insertIndex;

          workflowBoxes.splice(finalIndex, 0, draggedBox);
          renderWorkflowBoxes();
          saveWorkflowBoxes();
          setupDragAndDrop(); // ì¬ì„¤ì •
        }

        targetBox.style.borderTop = '';
        targetBox.style.borderBottom = '';
      }
    });
  }

  // ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ì €ì¥
  async function saveWorkflowBoxes() {
    localStorage.setItem('_drama-workflow-boxes', JSON.stringify(workflowBoxes));
    localStorage.setItem('_drama-next-box-id', nextBoxId.toString());
    localStorage.setItem('_drama-next-step1-num', nextStep1BoxNum.toString());
    localStorage.setItem('_drama-next-step2-num', nextStep2BoxNum.toString());
    await saveToFirebase('_drama-workflow-boxes', JSON.stringify(workflowBoxes));
    await saveToFirebase('_drama-next-box-id', nextBoxId.toString());
    await saveToFirebase('_drama-next-step1-num', nextStep1BoxNum.toString());
    await saveToFirebase('_drama-next-step2-num', nextStep2BoxNum.toString());
  }

  // ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸°
  function loadWorkflowBoxes() {
    const saved = localStorage.getItem('_drama-workflow-boxes');
    const savedNextId = localStorage.getItem('_drama-next-box-id');
    const savedStep1Num = localStorage.getItem('_drama-next-step1-num');
    const savedStep2Num = localStorage.getItem('_drama-next-step2-num');
    const savedStep1Collapsed = localStorage.getItem('_drama-step1-collapsed');
    const savedStep2Collapsed = localStorage.getItem('_drama-step2-collapsed');

    if (saved) {
      workflowBoxes = JSON.parse(saved);
    }
    if (savedNextId) {
      nextBoxId = parseInt(savedNextId);
    }
    if (savedStep1Num) {
      nextStep1BoxNum = parseInt(savedStep1Num);
    }
    if (savedStep2Num) {
      nextStep2BoxNum = parseInt(savedStep2Num);
    }
    // Reset collapsed state to false to ensure boxes are visible
    step1Collapsed = false;
    step2Collapsed = false;
    localStorage.removeItem('_drama-step1-collapsed');
    localStorage.removeItem('_drama-step2-collapsed');
  }

  // ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ì¶”ê°€ ë²„íŠ¼
  const btnAddStep1Box = document.getElementById('btn-add-step1-box');
  const btnAddStep2Box = document.getElementById('btn-add-step2-box');

  if (btnAddStep1Box) {
    btnAddStep1Box.addEventListener('click', () => addWorkflowBox('step1'));
  }
  if (btnAddStep2Box) {
    btnAddStep2Box.addEventListener('click', () => addWorkflowBox('step2'));
  }

  // Step1 ê²°ê³¼ ë³µì‚¬ ë²„íŠ¼
  const btnCopyStep1Results = document.getElementById('btn-copy-step1-results');
  if (btnCopyStep1Results) {
    btnCopyStep1Results.addEventListener('click', () => {
      const step1Boxes = workflowBoxes.filter(box => (box.stepType || 'step1') === 'step1');
      let allResults = '';

      step1Boxes.forEach(box => {
        if (box.result) {
          allResults += `\n\n${'='.repeat(50)}\n`;
          allResults += `[${box.boxNumber}] ${box.name}\n`;
          allResults += `${'='.repeat(50)}\n\n`;
          allResults += box.result;
        }
      });

      if (!allResults) {
        alert('ë³µì‚¬í•  Step1 ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const textarea = document.createElement('textarea');
      textarea.value = allResults.trim();
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);

      showStatus('âœ… Step1 ê²°ê³¼ ë³µì‚¬ ì™„ë£Œ!');
      setTimeout(hideStatus, 2000);
    });
  }

  // Step2 ê²°ê³¼ ë³µì‚¬ ë²„íŠ¼ (ì•ˆë‚´ ë¬¸êµ¬ í¬í•¨)
  const btnCopyStep2Results = document.getElementById('btn-copy-step2-results');
  if (btnCopyStep2Results) {
    btnCopyStep2Results.addEventListener('click', () => {
      const step2Boxes = workflowBoxes.filter(box => box.stepType === 'step2');
      let allResults = '';

      // ì•ˆë‚´ ë¬¸êµ¬ ì¶”ê°€
      allResults += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
      allResults += '                  ë“œë¼ë§ˆ ëŒ€ë³¸ ì‘ì„± ìë£Œ\n';
      allResults += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
      allResults += 'ì•„ë˜ëŠ” ìƒˆë¡œìš´ ë“œë¼ë§ˆ ëŒ€ë³¸ì„ ì‘ì„±í•˜ê¸° ìœ„í•´ ì¤€ë¹„ëœ ê¸°íš ìë£Œì…ë‹ˆë‹¤.\n';
      allResults += 'ê° ë‹¨ê³„ë³„ë¡œ ì •ë¦¬ëœ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬, ì™„ì„±ë„ ë†’ì€ ë“œë¼ë§ˆ ëŒ€ë³¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n';
      allResults += 'ì´ ìë£ŒëŠ” ìºë¦­í„° ì„¤ì •, ìŠ¤í† ë¦¬ êµ¬ì¡°, ì¥ë©´ êµ¬ì„± ë“± ë“œë¼ë§ˆ ì œì‘ì— í•„ìš”í•œ\n';
      allResults += 'í•µì‹¬ ìš”ì†Œë“¤ì„ í¬í•¨í•˜ê³  ìˆìŠµë‹ˆë‹¤. ê° ì„¹ì…˜ì˜ ë‚´ìš©ì„ í† ëŒ€ë¡œ ìì—°ìŠ¤ëŸ½ê³ \n';
      allResults += 'ìƒë™ê° ìˆëŠ” ëŒ€ë³¸ìœ¼ë¡œ ë°œì „ì‹œì¼œ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.\n\n';

      step2Boxes.forEach(box => {
        if (box.result) {
          allResults += `\n\n${'='.repeat(50)}\n`;
          allResults += `[${box.boxNumber}] ${box.name}\n`;
          allResults += `${'='.repeat(50)}\n\n`;
          allResults += box.result;
        }
      });

      if (!step2Boxes.some(box => box.result)) {
        alert('ë³µì‚¬í•  Step2 ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const textarea = document.createElement('textarea');
      textarea.value = allResults.trim();
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);

      showStatus('âœ… Step2 ê²°ê³¼ (ì•ˆë‚´ë¬¸êµ¬ í¬í•¨) ë³µì‚¬ ì™„ë£Œ!');
      setTimeout(hideStatus, 2000);
    });
  }

  // ìˆœì°¨ ì‹¤í–‰ í•¨ìˆ˜ (ê³µí†µ)
  async function autoExecuteBoxes(boxes, title) {
    if (boxes.length === 0) {
      alert(`ì‹¤í–‰í•  ${title} ë°•ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.`);
      return;
    }

    if (!confirm(`${boxes.length}ê°œì˜ ${title} ë°•ìŠ¤ë¥¼ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‹¤í–‰ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`)) {
      return;
    }

    showLoadingOverlay(`${title} ìˆœì°¨ ì‹¤í–‰ ì¤‘`, `${title} ${boxes.length}ê°œ ë°•ìŠ¤ ì‹¤í–‰ ì¤‘...`);

    for (let i = 0; i < boxes.length; i++) {
      const box = boxes[i];

      // ë¡œë”© ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
      const overlay = document.getElementById('loading-overlay');
      if (overlay) {
        const subtextEl = overlay.querySelector('.loading-subtext');
        if (subtextEl) {
          subtextEl.textContent = `[${i + 1}/${boxes.length}] ${box.name} ì‹¤í–‰ ì¤‘...`;
        }
      }

      // ë°•ìŠ¤ ì‹¤í–‰ (executeWorkflowBox í•¨ìˆ˜ ë‚´ìš©ì„ ì§ì ‘ ì‹¤í–‰)
      await executeWorkflowBoxDirect(box);

      // ì ì‹œ ëŒ€ê¸° (API ë¶€í•˜ ë°©ì§€)
      await new Promise(resolve => setTimeout(resolve, 500));
    }

    hideLoadingOverlay();
    showStatus(`âœ… ${title} ìˆœì°¨ ì‹¤í–‰ ì™„ë£Œ!`);
    setTimeout(hideStatus, 2000);
    renderWorkflowBoxes();
  }

  // ìˆœì°¨ ì‹¤í–‰ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  const btnAutoExecuteStep1 = document.getElementById('btn-auto-execute-step1');
  const btnAutoExecuteStep2 = document.getElementById('btn-auto-execute-step2');
  const btnAutoExecuteAll = document.getElementById('btn-auto-execute-all');

  if (btnAutoExecuteStep1) {
    btnAutoExecuteStep1.addEventListener('click', async () => {
      const step1Boxes = workflowBoxes.filter(box => (box.stepType || 'step1') === 'step1');
      await autoExecuteBoxes(step1Boxes, 'Step1');
    });
  }

  if (btnAutoExecuteStep2) {
    btnAutoExecuteStep2.addEventListener('click', async () => {
      const step2Boxes = workflowBoxes.filter(box => box.stepType === 'step2');
      await autoExecuteBoxes(step2Boxes, 'Step2');
    });
  }

  if (btnAutoExecuteAll) {
    btnAutoExecuteAll.addEventListener('click', async () => {
      await autoExecuteBoxes(workflowBoxes, 'ì „ì²´');
    });
  }

  // ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼
  const btnToggleStep1 = document.getElementById('btn-toggle-step1');
  const btnToggleStep2 = document.getElementById('btn-toggle-step2');

  if (btnToggleStep1) {
    btnToggleStep1.addEventListener('click', () => {
      step1Collapsed = !step1Collapsed;
      localStorage.setItem('_drama-step1-collapsed', step1Collapsed.toString());
      renderWorkflowBoxes();
    });
  }

  if (btnToggleStep2) {
    btnToggleStep2.addEventListener('click', () => {
      step2Collapsed = !step2Collapsed;
      localStorage.setItem('_drama-step2-collapsed', step2Collapsed.toString());
      renderWorkflowBoxes();
    });
  }

  // ìˆœì°¨ ì‹¤í–‰ìš© ì§ì ‘ ì‹¤í–‰ í•¨ìˆ˜
  async function executeWorkflowBoxDirect(box) {
    // ì…ë ¥ ë°ì´í„° ìˆ˜ì§‘
    let inputData = {};

    if (box.inputs.benchmarkScript) {
      inputData.benchmarkScript = document.getElementById('benchmark-script').value;
    }

    if (box.inputs.aiAnalysis) {
      inputData.aiAnalysis = document.getElementById('analysis-result').innerText;
    }

    // ë‹¤ë¥¸ ë°•ìŠ¤ì˜ ê²°ê³¼ ìˆ˜ì§‘
    for (const [key, value] of Object.entries(box.inputs)) {
      if (key.startsWith('box_') && value) {
        const boxNumber = parseInt(key.replace('box_', ''));
        const sourceBox = workflowBoxes.find(b => b.boxNumber === boxNumber);
        if (sourceBox && sourceBox.result) {
          inputData[`box${boxNumber}Result`] = sourceBox.result;
        }
      }
    }

    // ì£¼ì¸ê³µ ì •ë³´ ìˆ˜ì§‘
    const mainCharacter = document.getElementById('main-character')?.value.trim() || '';

    // stepTypeì— ë”°ë¼ ì ì ˆí•œ ëª¨ë¸ ì„ íƒ
    const stepType = box.stepType || 'step1';
    const modelToUse = stepType === 'step1' ? aiModelSettings.step1 : aiModelSettings.step2;

    try {
      const response = await fetch('/api/drama/workflow-execute', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          boxId: box.id,
          boxName: box.name,
          boxNumber: box.boxNumber,
          stepType: stepType,
          guide: box.guide,
          inputs: inputData,
          category: currentCategory,
          mainCharacter: mainCharacter,
          model: modelToUse
        })
      });

      const data = await response.json();

      if (data.ok) {
        box.result = data.result;
        const resultEl = document.getElementById(`result-${box.id}`);
        if (resultEl) {
          resultEl.value = data.result;
        }
        await saveWorkflowBoxes();
      } else {
        console.error(`Box ${box.boxNumber} failed:`, data.error);
      }
    } catch (err) {
      console.error(`Box ${box.boxNumber} error:`, err.message);
    }
  }

  // ì§€ì¹¨ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
  const btnOpenGuideModal = document.getElementById('btn-open-guide-modal');
  const modalGuideManagement = document.getElementById('modal-guide-management');
  const btnCloseGuideModal = document.getElementById('btn-close-guide-modal');
  const btnModalSaveGuides = document.getElementById('btn-modal-save-guides');

  if (btnOpenGuideModal && modalGuideManagement) {
    btnOpenGuideModal.addEventListener('click', () => {
      renderGuideManagement(); // ì—´ ë•Œ ìµœì‹  ìƒíƒœë¡œ ë Œë”ë§
      modalGuideManagement.classList.add('show');
    });
  }

  // ì§€ì¹¨ ê´€ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
  if (btnCloseGuideModal && modalGuideManagement) {
    btnCloseGuideModal.addEventListener('click', () => {
      modalGuideManagement.classList.remove('show');
    });
  }

  // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
  if (modalGuideManagement) {
    modalGuideManagement.addEventListener('click', (e) => {
      if (e.target === modalGuideManagement) {
        modalGuideManagement.classList.remove('show');
      }
    });
  }

  // ì§€ì¹¨ ì €ì¥ ë²„íŠ¼ (ëª¨ë‹¬)
  if (btnModalSaveGuides) {
    btnModalSaveGuides.addEventListener('click', async () => {
      showStatus('ğŸ’¾ ì§€ì¹¨ ì €ì¥ ì¤‘...');

      // ëª¨ë“  í…ìŠ¤íŠ¸ì˜ì—­ì˜ ê°’ì„ workflowBoxesì— ë™ê¸°í™”
      workflowBoxes.forEach(box => {
        const textarea = document.getElementById(`modal-guide-${box.id}`);
        if (textarea) {
          box.guide = textarea.value;
        }
      });

      // Step3 ì§€ì¹¨ ì €ì¥
      const step3Textarea = document.getElementById('modal-guide-step3');
      if (step3Textarea) {
        step3Guide = step3Textarea.value;
        localStorage.setItem('_drama-step3-guide', step3Guide);
        await saveToFirebase('_drama-step3-guide', step3Guide);
      }

      // AI ëª¨ë¸ ì„¤ì • ì €ì¥
      aiModelSettings = {
        step1: document.getElementById('model-step1')?.value || 'gpt-4o-mini',
        step2: document.getElementById('model-step2')?.value || 'gpt-4o-mini',
        step3: document.getElementById('model-step3')?.value || 'anthropic/claude-sonnet-4.5',
        benchmarkAnalysis: document.getElementById('model-benchmark')?.value || 'gpt-4o-mini'
      };
      localStorage.setItem('_drama-ai-models', JSON.stringify(aiModelSettings));
      await saveToFirebase('_drama-ai-models', JSON.stringify(aiModelSettings));

      // Firebaseì™€ localStorageì— ì €ì¥
      await saveWorkflowBoxes();

      showStatus('âœ… ì§€ì¹¨ ë° ëª¨ë¸ ì„¤ì • ì €ì¥ ì™„ë£Œ!');
      setTimeout(hideStatus, 2000);
    });
  }

  // ì¶•ì ëœ ê°€ì´ë“œ - ìƒˆì°½ì—ì„œ ë³´ê¸°
  const btnLoadAccumulatedGuide = document.getElementById('btn-load-accumulated-guide');

  async function openAccumulatedGuideInNewWindow() {
    // ìƒˆ ì°½ ì—´ê¸°
    const guideWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
    guideWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>ì¶•ì ëœ ê°€ì´ë“œ - Drama</title>
        <style>
          body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 2rem; background: #f8f9fa; margin: 0; }
          .container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
          h1 { color: #f5576c; margin-bottom: 1rem; font-size: 1.5rem; }
          .loading { text-align: center; padding: 3rem; color: #666; }
          .content { white-space: pre-wrap; line-height: 1.8; font-size: .95rem; color: #333; }
          .error { color: #e74c3c; text-align: center; padding: 2rem; }
        </style>
      </head>
      <body>
        <div class="container">
          <h1>ğŸ“š ì¶•ì ëœ ì‘ì„± ê°€ì´ë“œ</h1>
          <div id="guide-content" class="loading">ğŸ”„ ê°€ì´ë“œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </body>
      </html>
    `);
    guideWindow.document.close();

    try {
      const response = await fetch('/api/drama/get-accumulated-guide', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ category: currentCategory })
      });

      const data = await response.json();
      const contentDiv = guideWindow.document.getElementById('guide-content');

      if (data.ok) {
        contentDiv.className = 'content';
        contentDiv.innerHTML = data.guide;
      } else {
        contentDiv.className = 'error';
        contentDiv.innerHTML = 'âŒ ì˜¤ë¥˜: ' + data.error;
      }
    } catch (err) {
      const contentDiv = guideWindow.document.getElementById('guide-content');
      contentDiv.className = 'error';
      contentDiv.innerHTML = 'âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + err.message;
    }
  }

  if (btnLoadAccumulatedGuide) {
    btnLoadAccumulatedGuide.addEventListener('click', openAccumulatedGuideInNewWindow);
  }

  // ===== AI ì±—ë´‡ ê¸°ëŠ¥ =====
  const chatMessages = document.getElementById('drama-chat-messages');
  const chatInput = document.getElementById('drama-chat-input');
  const chatSendBtn = document.getElementById('btn-drama-chat-send');

  function addChatMessage(type, content) {
    // í™˜ì˜ ë©”ì‹œì§€ ì œê±°
    const welcome = chatMessages.querySelector('.chat-welcome');
    if (welcome) welcome.remove();

    const msgDiv = document.createElement('div');
    msgDiv.style.cssText = `
      margin-bottom: .75rem; padding: .6rem .8rem; border-radius: 8px;
      ${type === 'user'
        ? 'background: #667eea; color: white; margin-left: 20%; text-align: right;'
        : 'background: #f0f0f0; color: #333; margin-right: 20%;'}
    `;
    msgDiv.innerHTML = `<div style="font-size: .85rem; line-height: 1.5; white-space: pre-wrap;">${content}</div>`;
    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function collectDramaContext() {
    // í˜„ì¬ ì‘ì—… ìƒíƒœ ìˆ˜ì§‘
    const context = {};

    // ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ê²°ê³¼ë“¤
    if (workflowBoxes && workflowBoxes.length > 0) {
      context.workflowResults = workflowBoxes.map(box => ({
        name: box.name,
        result: box.result || ''
      })).filter(b => b.result);
    }

    // Step3 ê²°ê³¼
    const step3Textarea = document.getElementById('step3-result');
    if (step3Textarea && step3Textarea.value) {
      context.step3Result = step3Textarea.value;
    }

    // ë²¤ì¹˜ë§ˆí¬ ìŠ¤í¬ë¦½íŠ¸
    const benchmarkText = document.getElementById('text-benchmark')?.value;
    if (benchmarkText) {
      context.benchmarkScript = benchmarkText;
    }

    return context;
  }

  async function sendChatMessage() {
    const question = chatInput.value.trim();
    if (!question) return;

    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    addChatMessage('user', question);
    chatInput.value = '';

    // ì„ íƒëœ ëª¨ë¸ ê°€ì ¸ì˜¤ê¸°
    const modelSelect = document.getElementById('drama-chat-model');
    const selectedModel = modelSelect ? modelSelect.value : 'gpt-4o-mini';

    // ë¡œë”© í‘œì‹œ
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'chat-loading';
    loadingDiv.style.cssText = 'margin-bottom: .75rem; padding: .6rem .8rem; background: #f0f0f0; border-radius: 8px; margin-right: 20%;';
    loadingDiv.innerHTML = `<div style="font-size: .85rem; color: #999;">ğŸ¤” ${selectedModel}ë¡œ ìƒê° ì¤‘...</div>`;
    chatMessages.appendChild(loadingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    try {
      const response = await fetch('/api/drama/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          question: question,
          context: collectDramaContext(),
          model: selectedModel
        })
      });

      const data = await response.json();
      loadingDiv.remove();

      if (data.ok) {
        addChatMessage('ai', data.answer);
      } else {
        addChatMessage('ai', 'âŒ ì˜¤ë¥˜: ' + data.error);
      }
    } catch (err) {
      loadingDiv.remove();
      addChatMessage('ai', 'âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + err.message);
    }
  }

  if (chatSendBtn) {
    chatSendBtn.addEventListener('click', sendChatMessage);
  }
  if (chatInput) {
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendChatMessage();
    });
  }

  // ===== ì´ˆê¸°í™” =====
  document.addEventListener('DOMContentLoaded', async () => {
    const dateInput = document.getElementById('drama-date');
    if (dateInput) {
      dateInput.value = new Date().toISOString().split('T')[0];
    }

    // â­ ì›Œí¬í”Œë¡œìš° ì„¸ì…˜ ë¡œë“œ ë˜ëŠ” ìƒˆë¡œ ìƒì„±
    if (!loadSessionFromStorage()) {
      initWorkflowSession();
    }
    // Step7ì— ë©”íƒ€ë°ì´í„° ë™ê¸°í™”
    syncMetadataToStep7();

    // â­ JSON ì§€ì¹¨ ë¡œë“œ (ë¹„ë™ê¸°, ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
    loadDramaGuidelines().then(loaded => {
      if (loaded) {
        console.log('[INIT] ì„œë²„ ì§€ì¹¨ ë¡œë“œ ì™„ë£Œ');
      }
    });

    showStatus('â˜ï¸ í´ë¼ìš°ë“œ ë™ê¸°í™” ì¤‘...');
    await loadFromFirebase();

    // â­ Step3 ì§€ì¹¨ ë¶ˆëŸ¬ì˜¤ê¸° (Firebase ë™ê¸°í™” í›„)
    step3Guide = localStorage.getItem('_drama-step3-guide') || '';

    // â­ Step3 ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸° (Firebase ë™ê¸°í™” í›„)
    step3Result = localStorage.getItem('_drama-step3-result') || '';
    if (step3Result) {
      const resultTextarea = document.getElementById('step3-result');
      const resultContainer = document.getElementById('step3-result-container');
      if (resultTextarea && resultContainer) {
        resultTextarea.value = step3Result;
        resultContainer.style.display = 'block';
        // ì ì‹œ í›„ autoResize í˜¸ì¶œ (DOM ë Œë”ë§ í›„)
        setTimeout(() => autoResize(resultTextarea), 100);
      }
    }

    // â­ AI ëª¨ë¸ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
    const savedModels = localStorage.getItem('_drama-ai-models');
    if (savedModels) {
      aiModelSettings = JSON.parse(savedModels);
    }

    // â­ ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸° ë° ë Œë”ë§
    loadWorkflowBoxes();
    renderWorkflowBoxes();

    hideStatus();

    renderCategories();
    loadMasterGuide(currentCategory);
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
    renderSavedList();

    document.querySelectorAll('textarea').forEach(autoResize);

    // â­ Step1 ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ì„¸ì…˜ ìë™ ì €ì¥
    setupStep1SessionSync();
  });

  // ===== ì§€ì¹¨ ë³´ê¸° ëª¨ë‹¬ =====
  function openGuidelinesModal() {
    const modal = document.getElementById('guidelines-modal');
    const content = document.getElementById('guidelines-modal-content');

    // ì§€ì¹¨ ë‚´ìš© êµ¬ì„±
    let guidelineText = '';

    // ëŒ€ë³¸ êµ¬ì¡° (7ë‹¨ê³„) í‘œì‹œ
    if (dramaGuidelines?.structure?.sections) {
      guidelineText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ—ï¸ ëŒ€ë³¸ êµ¬ì¡° (7ë‹¨ê³„) - ì´ ${dramaGuidelines.structure.total_length}ì
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

`;
      dramaGuidelines.structure.sections.forEach(section => {
        const charCount = Math.round(dramaGuidelines.structure.total_length * section.length_ratio);
        guidelineText += `ã€ ${section.id}. ${section.korean_name} ã€‘ (${(section.length_ratio * 100).toFixed(0)}% â‰ˆ ${charCount}ì)
ëª©ì : ${section.purpose}
í•„ìˆ˜ ìš”ì†Œ: ${section.must_include.join(', ')}
ì˜ˆì‹œ: "${section.example?.substring(0, 50)}..."

`;
      });
    }

    // ëŒ€ì‚¬ ë¹„ìœ¨
    if (dramaGuidelines?.dialogue_ratio) {
      guidelineText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’¬ ëŒ€ì‚¬ ë¹„ìœ¨
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ ì„œìˆ /ë‚˜ë ˆì´ì…˜: ${dramaGuidelines.dialogue_ratio.narration}%
â€¢ ë‚´ë©´ ë…ë°±: ${dramaGuidelines.dialogue_ratio.inner_monologue}%
â€¢ ì§ì ‘ ëŒ€í™”: ${dramaGuidelines.dialogue_ratio.direct_dialogue}%

`;
    }

    // ë””í…Œì¼ ìš”êµ¬ì‚¬í•­
    if (dramaGuidelines?.detail_requirements) {
      const dr = dramaGuidelines.detail_requirements;
      guidelineText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ í•„ìˆ˜ ë””í…Œì¼ ìš”êµ¬ì‚¬í•­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ ì´ë¦„: ${dr.naming?.min_count}ê°œ ì´ìƒ (ì˜ˆ: ${dr.naming?.examples?.join(', ')})
â€¢ ë‚˜ì´: ${dr.ages?.min_count}ê°œ ì´ìƒ (ì˜ˆ: ${dr.ages?.examples?.join(', ')})
â€¢ ì¥ì†Œ: ${dr.locations?.min_count}ê°œ ì´ìƒ (ì˜ˆ: ${dr.locations?.examples?.join(', ')})
â€¢ ìˆ«ì: ${dr.amounts?.min_count}ê°œ ì´ìƒ (ì˜ˆ: ${dr.amounts?.examples?.join(', ')})
â€¢ ì‹œê°„: ${dr.time_periods?.min_count}ê°œ ì´ìƒ (ì˜ˆ: ${dr.time_periods?.examples?.join(', ')})

`;
    }

    // ê°ì • í‘œí˜„
    if (dramaGuidelines?.emotional_expressions) {
      guidelineText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â¤ï¸ ê°ì • í‘œí˜„ ê°€ì´ë“œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì‹ ì²´ ë°˜ì‘:
${dramaGuidelines.emotional_expressions.physical_reactions?.map(p => `  â€¢ ${p}`).join('\n')}

ê°ì • ìƒíƒœ:
${dramaGuidelines.emotional_expressions.emotional_states?.map(p => `  â€¢ ${p}`).join('\n')}

`;
    }

    // ê¸ˆì§€ íŒ¨í„´
    if (dramaGuidelines?.forbidden_patterns) {
      guidelineText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸš« ê¸ˆì§€ íŒ¨í„´
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
í¬ë§·íŒ…:
${dramaGuidelines.forbidden_patterns.formatting?.map(p => `  âœ— ${p}`).join('\n')}

ì½˜í…ì¸ :
${dramaGuidelines.forbidden_patterns.content?.map(p => `  âœ— ${p}`).join('\n')}

ìŠ¤íƒ€ì¼:
${dramaGuidelines.forbidden_patterns.style?.map(p => `  âœ— ${p}`).join('\n')}

`;
    }

    // í’ˆì§ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸
    if (dramaGuidelines?.quality_checklist) {
      guidelineText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… í’ˆì§ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
êµ¬ì¡°:
${dramaGuidelines.quality_checklist.structure?.map(q => `  â˜ ${q}`).join('\n')}

ë””í…Œì¼:
${dramaGuidelines.quality_checklist.details?.map(q => `  â˜ ${q}`).join('\n')}

ê°ì •:
${dramaGuidelines.quality_checklist.emotion?.map(q => `  â˜ ${q}`).join('\n')}

ëŒ€ì‚¬:
${dramaGuidelines.quality_checklist.dialogue?.map(q => `  â˜ ${q}`).join('\n')}
`;
    }

    if (!guidelineText) {
      guidelineText = 'ì§€ì¹¨ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    }

    content.textContent = guidelineText;
    modal.classList.add('show');
  }

  function closeGuidelinesModal() {
    const modal = document.getElementById('guidelines-modal');
    modal.classList.remove('show');
  }

  // ì§€ì¹¨ ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
  document.getElementById('btn-view-guidelines')?.addEventListener('click', openGuidelinesModal);

  // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
  document.getElementById('guidelines-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'guidelines-modal') {
      closeGuidelinesModal();
    }
  });

  // ===== JSON ë·°ì–´ ëª¨ë‹¬ =====
  let currentJsonTab = 'session';
  let currentJsonContent = '';

  function openJsonViewerModal() {
    const modal = document.getElementById('json-viewer-modal');
    modal.classList.add('show');
    showJsonTab('session');
  }

  function closeJsonViewerModal() {
    const modal = document.getElementById('json-viewer-modal');
    modal.classList.remove('show');
  }

  function showJsonTab(tabName) {
    currentJsonTab = tabName;

    // íƒ­ ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼
    document.querySelectorAll('.json-tab').forEach(btn => {
      btn.style.background = '#e0e0e0';
      btn.style.color = '#333';
    });
    document.getElementById(`json-tab-${tabName}`).style.background = '#6c5ce7';
    document.getElementById(`json-tab-${tabName}`).style.color = 'white';

    const content = document.getElementById('json-viewer-content');

    if (tabName === 'session') {
      currentJsonContent = JSON.stringify(workflowSession, null, 2);
      content.innerHTML = syntaxHighlight(currentJsonContent);
    } else if (tabName === 'guidelines') {
      currentJsonContent = dramaGuidelines ? JSON.stringify(dramaGuidelines, null, 2) : '// ì§€ì¹¨ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
      content.innerHTML = syntaxHighlight(currentJsonContent);
    } else if (tabName === 'structure') {
      // ëŒ€ë³¸ êµ¬ì¡°ë§Œ í‘œì‹œ
      if (dramaGuidelines?.structure) {
        const structureInfo = {
          total_length: dramaGuidelines.structure.total_length,
          sections: dramaGuidelines.structure.sections.map(s => ({
            id: s.id,
            name: s.korean_name,
            ratio: `${(s.length_ratio * 100).toFixed(0)}%`,
            purpose: s.purpose,
            must_include: s.must_include
          })),
          dialogue_ratio: dramaGuidelines.dialogue_ratio,
          mandatory_elements: dramaGuidelines.mandatory_elements
        };
        currentJsonContent = JSON.stringify(structureInfo, null, 2);
        content.innerHTML = syntaxHighlight(currentJsonContent);
      } else {
        content.textContent = '// ì§€ì¹¨ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
      }
    }
  }

  function refreshJsonViewer() {
    showJsonTab(currentJsonTab);
    showStatus('ğŸ”„ JSON ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
    setTimeout(hideStatus, 1500);
  }

  function copyJsonContent() {
    navigator.clipboard.writeText(currentJsonContent).then(() => {
      showStatus('ğŸ“‹ JSON ë³µì‚¬ ì™„ë£Œ!');
      setTimeout(hideStatus, 1500);
    });
  }

  // JSON êµ¬ë¬¸ ê°•ì¡°
  function syntaxHighlight(json) {
    if (typeof json !== 'string') {
      json = JSON.stringify(json, null, 2);
    }
    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
      let cls = 'number';
      if (/^"/.test(match)) {
        if (/:$/.test(match)) {
          cls = 'key';
        } else {
          cls = 'string';
        }
      } else if (/true|false/.test(match)) {
        cls = 'boolean';
      } else if (/null/.test(match)) {
        cls = 'null';
      }
      const colors = {
        key: '#9cdcfe',
        string: '#ce9178',
        number: '#b5cea8',
        boolean: '#569cd6',
        null: '#569cd6'
      };
      return `<span style="color: ${colors[cls]}">${match}</span>`;
    });
  }

  // JSON ë·°ì–´ ë²„íŠ¼ ì´ë²¤íŠ¸
  document.getElementById('btn-view-json')?.addEventListener('click', openJsonViewerModal);

  // JSON ë·°ì–´ ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
  document.getElementById('json-viewer-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'json-viewer-modal') {
      closeJsonViewerModal();
    }
  });

  // Step1 ì…ë ¥ í•„ë“œë“¤ì„ ì„¸ì…˜ê³¼ ë™ê¸°í™”
  function setupStep1SessionSync() {
    // ë²¤ì¹˜ë§ˆí¬ ëŒ€ë³¸
    const benchmarkScript = document.getElementById('benchmark-script');
    if (benchmarkScript) {
      // ì„¸ì…˜ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
      if (workflowSession.step1.benchmark?.script) {
        benchmarkScript.value = workflowSession.step1.benchmark.script;
      }
      // ë³€ê²½ ì‹œ ì €ì¥
      benchmarkScript.addEventListener('change', () => {
        updateSession('step1.benchmark.script', benchmarkScript.value);
      });
    }

    // ì£¼ì¸ê³µ ì •ë³´
    const mainCharacter = document.getElementById('main-character');
    if (mainCharacter) {
      if (workflowSession.step1.mainCharacter) {
        mainCharacter.value = workflowSession.step1.mainCharacter;
      }
      mainCharacter.addEventListener('change', () => {
        updateSession('step1.mainCharacter', mainCharacter.value);
      });
    }

    // ì¹´í…Œê³ ë¦¬ ë³€ê²½
    const categorySelect = document.getElementById('category-select');
    if (categorySelect) {
      categorySelect.addEventListener('change', () => {
        updateSession('category', categorySelect.value);
      });
    }

    // ì½˜í…ì¸  ìœ í˜• ë³€ê²½
    const contentType = document.getElementById('content-type');
    if (contentType) {
      if (workflowSession.contentType) {
        contentType.value = workflowSession.contentType;
      }
      contentType.addEventListener('change', () => {
        updateSession('contentType', contentType.value);
      });
    }

    console.log('[SESSION] Step1 ë™ê¸°í™” ì„¤ì • ì™„ë£Œ');
  }

  // Step2 ê²°ê³¼ë¥¼ ì„¸ì…˜ì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜ (ê¸°ì¡´ stepResultsì— ì €ì¥í•  ë•Œ í˜¸ì¶œ)
  function saveStep2ResultToSession(stepId, result) {
    const stepMap = {
      'character': 'character',
      'storyline': 'storyline',
      'scene': 'scene',
      'dialogue': 'dialogue'
    };

    const sessionKey = stepMap[stepId];
    if (sessionKey) {
      updateSession(`step2.${sessionKey}`, { result, completedAt: new Date().toISOString() });
    }
  }
  </script>
</body>
</html>
