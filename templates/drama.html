<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>DRAMA LAB</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
    }
    .page-wrap {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      height: 100vh;
    }
    .left-col {
      width: 240px;
      display: flex;
      flex-direction: column;
      gap: .5rem;
      overflow-y: auto;
      font-size: .85rem;
    }
    .right-col {
      flex: 1;
      display: flex;
      gap: 1rem;
      min-width: 0;
      overflow-y: hidden;
    }
    .content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: .75rem;
      overflow-y: auto;
      min-width: 0;
    }
    .analysis-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: .75rem;
      overflow-y: auto;
      min-width: 0;
    }
    .box {
      background: #fff;
      border: none;
      border-radius: 12px;
      padding: .75rem;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
      transition: box-shadow 0.2s ease;
    }
    .box:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,.1);
    }
    .label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: .5rem;
      margin-bottom: .35rem;
    }
    .label { font-weight: 600; }
    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: .35rem .5rem;
    }
    textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
      line-height: 1.4;
    }
    .btn-row {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
    }
    button {
      padding: .35rem .6rem;
      border: none;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,.05);
    }
    button:hover {
      background: #e9ecef;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,.1);
    }
    button.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    button.primary:hover {
      background: linear-gradient(135deg, #5568d3 0%, #663a91 100%);
    }
    button.danger {
      background: #e74c3c;
      color: white;
    }
    button.danger:hover {
      background: #c0392b;
    }
    button.step-btn {
      width: 100%;
      margin-bottom: .5rem;
    }

    .style-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .4rem .6rem;
      margin-bottom: .3rem;
      background: #f8f9fa;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .style-item:hover { background: #e9ecef; }
    .style-item.active {
      background: #f0e6ff;
      border: 2px solid #667eea;
    }
    .style-desc {
      font-size: .75rem;
      color: #666;
      margin-top: .2rem;
    }

    .toggle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .status-bar {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: .4rem .7rem;
      font-size: .8rem;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
      display: none;
      text-align: center;
      margin: 0 auto;
      max-width: 400px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .modal-buttons {
      display: flex;
      gap: .5rem;
      margin-top: 1rem;
    }
    .modal-buttons button { flex: 1; }

    .storage-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .4rem .6rem;
      margin-bottom: .3rem;
      background: #f8f9fa;
      border-radius: 6px;
    }

    textarea.autosize { overflow: hidden; }

    /* GPT PRO ê²°ê³¼ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .gpt-pro-result-box {
      background: linear-gradient(135deg, #ff6b9d 0%, #c06c84 100%);
      border: none;
      padding: 1rem;
      border-radius: 8px;
      margin-top: .75rem;
    }
    .gpt-pro-result-box .label {
      color: white;
      font-size: 1.1rem;
      margin-bottom: .5rem;
    }
    .gpt-pro-result-box textarea {
      background: white;
      border: none;
      border-radius: 6px;
      padding: .75rem;
      min-height: 300px;
    }

    /* ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
    .top-buttons-container {
      display: flex;
      gap: .75rem;
    }
    .top-buttons-container .box {
      flex: 1;
      padding: 1rem;
      border: none;
    }
    .copy-all-box {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }
    .gpt-pro-box {
      background: linear-gradient(135deg, #ff6b9d 0%, #e74c3c 100%);
    }
    .top-buttons-container button {
      background: white;
      font-weight: 600;
      padding: .6rem 1.2rem;
      border: none;
      font-size: .95rem;
      width: 100%;
    }
    .copy-all-box button {
      color: #e74c3c;
    }
    .gpt-pro-box button {
      color: #e74c3c;
    }
    .top-buttons-container .box-title {
      color: white;
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: .3rem;
    }
    .top-buttons-container .box-desc {
      color: rgba(255,255,255,0.9);
      font-size: .85rem;
      margin-bottom: .75rem;
    }

    /* Auth header */
    .auth-header {
      background: white;
      border-bottom: 2px solid #e0e0e0;
      padding: .75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .auth-header h1 {
      font-size: 1.2rem;
      margin: 0;
      color: #333;
    }
    .auth-links {
      display: flex;
      gap: .75rem;
      align-items: center;
    }
    .auth-links .user-info {
      font-size: .9rem;
      color: #555;
      font-weight: 500;
    }
    .auth-links a {
      padding: .4rem .8rem;
      text-decoration: none;
      border-radius: 6px;
      font-size: .85rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    .auth-links .btn-login {
      background: white;
      color: #e74c3c;
      border: 2px solid #e74c3c;
    }
    .auth-links .btn-login:hover {
      background: #e74c3c;
      color: white;
    }
    .auth-links .btn-signup {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border: none;
    }
    .auth-links .btn-signup:hover {
      opacity: 0.9;
    }
    .auth-links .btn-logout {
      background: #e74c3c;
      color: white;
      border: none;
    }
    .auth-links .btn-logout:hover {
      background: #c0392b;
    }
    .auth-links .btn-home {
      background: #95a5a6;
      color: white;
      border: none;
    }
    .auth-links .btn-home:hover {
      background: #7f8c8d;
    }

    /* ë²¤ì¹˜ë§ˆí‚¹ ëŒ€ë³¸ ë°•ìŠ¤ - ê³ ì • ë†’ì´ */
    #benchmark-script {
      height: 80px;
      max-height: 80px;
      min-height: 80px;
      resize: none;
    }

    /* ì¤‘ì•™ ë¡œë”© ì¸ë””ì¼€ì´í„° */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    .loading-overlay.show {
      display: flex;
    }
    .loading-content {
      background: white;
      border-radius: 16px;
      padding: 2rem 3rem;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #e74c3c;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-text {
      font-size: 1.2rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 0.5rem;
    }
    .loading-subtext {
      font-size: 0.9rem;
      color: #666;
    }

    /* Step1/Step2 ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .workflow-box.step1 {
      border: 2px solid #e74c3c;
      background: #fff5f5;
    }
    .workflow-box.step2 {
      border: 2px solid #9b59b6;
      background: #f8f5ff;
    }
    .step-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }
    .step-badge.step1 {
      background: #e74c3c;
      color: white;
    }
    .step-badge.step2 {
      background: #9b59b6;
      color: white;
    }

    /* Step ì ‘ê¸°/í¼ì¹˜ê¸° */
    .workflow-box.collapsed .box-content {
      display: none;
    }
    .workflow-box.collapsed {
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <!-- ì¤‘ì•™ ë¡œë”© ì¸ë””ì¼€ì´í„° -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">AI ì‘ì—… ì¤‘</div>
      <div class="loading-subtext">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>
    </div>
  </div>

  <!-- Auth Header -->
  <div class="auth-header">
    <h1>ğŸ­ ë“œë¼ë§ˆ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± ë„êµ¬</h1>
    <div class="auth-links">
      <a href="/" class="btn-home">í™ˆ</a>
      {% if session.user_id %}
        <span class="user-info">{{ session.user_name }}ë‹˜</span>
        <a href="/logout" class="btn-logout">ë¡œê·¸ì•„ì›ƒ</a>
      {% else %}
        <a href="/login" class="btn-login">ë¡œê·¸ì¸</a>
        <a href="/signup" class="btn-signup">íšŒì›ê°€ì…</a>
      {% endif %}
    </div>
  </div>

  <div class="page-wrap">
    <!-- ì™¼ìª½ -->
    <div class="left-col">
      <!-- ë‚ ì§œ + ì˜ìƒ ì‹œê°„ (í•œ ì¤„) -->
      <div class="box" style="padding: .5rem .75rem;">
        <div style="display: flex; gap: .5rem; align-items: center;">
          <div style="flex: 1;">
            <label class="label" style="font-size: .8rem; margin-bottom: .2rem; display: block;">ë‚ ì§œ</label>
            <input type="date" id="drama-date" style="padding: .25rem .4rem; font-size: .85rem;">
          </div>
          <div style="flex: 1;">
            <label class="label" style="font-size: .8rem; margin-bottom: .2rem; display: block;">ì˜ìƒ ì‹œê°„</label>
            <select id="drama-category" style="padding: .25rem .4rem; font-size: .85rem;"></select>
          </div>
        </div>
      </div>

      <!-- ì£¼ì¸ê³µ ì„ íƒ -->
      <div class="box" style="padding: .5rem .75rem;">
        <label class="label" style="font-size: .8rem; margin-bottom: .3rem; display: block;">ì£¼ì¸ê³µ (ì„ íƒì‚¬í•­)</label>
        <div style="display: flex; gap: .4rem; align-items: center;">
          <input type="text" id="main-character" placeholder="ì˜ˆ: 30ëŒ€ ë‚¨ì„± ëª©ì‚¬, ì²­ë…„ ëŒ€í•™ìƒ ë“±" style="flex: 1; font-size: .85rem; padding: .3rem .4rem;">
          <button id="btn-random-character" style="padding: .3rem .6rem; font-size: .75rem; background: #9b59b6; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;">ğŸ² ëœë¤</button>
        </div>
        <div style="font-size: .7rem; color: #666; margin-top: .3rem;">
          ë¹„ì›Œë‘ë©´ AIê°€ ìë™ìœ¼ë¡œ ì ì ˆí•œ ì£¼ì¸ê³µì„ ì„¤ì •í•©ë‹ˆë‹¤.
        </div>
      </div>

      <!-- ë²¤ì¹˜ë§ˆí‚¹ ëŒ€ë³¸ (ì¶•ì†Œ) -->
      <div class="box">
        <label class="label" style="font-size: .9rem;">ë²¤ì¹˜ë§ˆí‚¹ ëŒ€ë³¸</label>
        <textarea id="benchmark-script" placeholder="ì°¸ê³ í•  ëŒ€ë³¸ì´ë‚˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”." style="height: 80px; resize: none; font-size: .85rem;"></textarea>
      </div>

      <!-- AI ëŒ€ë³¸ ë¶„ì„ -->
      <div class="box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: .5rem;">
        <div style="color: white; font-weight: 600; font-size: .85rem; margin-bottom: .4rem;">ğŸ“Š AI ëŒ€ë³¸ ë¶„ì„</div>
        <div style="background: white; border-radius: 6px; padding: .4rem; margin-bottom: .4rem;">
          <div style="display: flex; gap: .3rem; margin-bottom: .3rem;">
            <input type="text" id="benchmark-upload-date" placeholder="ë‚ ì§œ" style="flex: 1; font-size: .7rem; padding: .25rem;">
            <input type="text" id="benchmark-view-count" placeholder="ì¡°íšŒìˆ˜" style="flex: 1; font-size: .7rem; padding: .25rem;">
          </div>
          <label style="display: flex; align-items: center; gap: .2rem; margin-bottom: .3rem; cursor: pointer;">
            <input type="checkbox" id="check-duplicates" style="cursor: pointer;">
            <span style="font-size: .7rem; color: #666;">ì¤‘ë³µ ìë£Œ</span>
          </label>
          <button id="btn-analyze-benchmark" class="primary" style="width: 100%; font-size: .75rem; padding: .3rem;">ë¶„ì„</button>
        </div>
        <div style="background: white; border-radius: 6px; padding: .4rem; max-height: 60px; overflow-y: auto;">
          <div id="analysis-result" style="font-size: .7rem; color: #333; line-height: 1.3;">
            <p style="color: #999; text-align: center; font-size: .65rem;">
              ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
            </p>
          </div>
        </div>
        <button id="btn-view-accumulated-guide" style="width: 100%; margin-top: .4rem; background: white; color: #667eea; font-weight: 600; font-size: .7rem; padding: .3rem; border-radius: 6px; border: none; cursor: pointer;">ğŸ“š ê°€ì´ë“œ ë³´ê¸°</button>
      </div>

      <!-- ì €ì¥ ê³µê°„ -->
      <div class="box">
        <label class="label" style="font-size: .9rem;">ì €ì¥ëœ ë“œë¼ë§ˆ ìë£Œ</label>
        <button id="btn-save" style="width: 100%; margin-bottom: .5rem; font-size: .85rem; padding: .4rem;">í˜„ì¬ ë‚´ìš© ì €ì¥</button>
        <div id="saved-list"></div>
      </div>
    </div>

    <!-- ê°€ìš´ë° - ì›Œí¬í”Œë¡œìš° ì˜ì—­ -->
    <div class="content-area">
      <!-- ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ì¶”ê°€ ë²„íŠ¼ -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: .5rem; margin-bottom: .75rem;">
        <button id="btn-add-step1-box" style="padding: .6rem; font-size: .9rem; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(255,107,107,.3); transition: all 0.2s ease;">â• Step1 ë°•ìŠ¤ ì¶”ê°€</button>
        <button id="btn-add-step2-box" style="padding: .6rem; font-size: .9rem; background: linear-gradient(135deg, #4ecdc4 0%, #44a3c2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(78,205,196,.3); transition: all 0.2s ease;">â• Step2 ë°•ìŠ¤ ì¶”ê°€</button>
      </div>

      <!-- ìˆœì°¨ ì‹¤í–‰ ë²„íŠ¼ -->
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: .5rem; margin-bottom: .75rem;">
        <button id="btn-auto-execute-step1" style="padding: .55rem; font-size: .8rem; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(255,107,107,.3); transition: all 0.2s ease;">âš¡ Step1 ìˆœì°¨ì‹¤í–‰</button>
        <button id="btn-auto-execute-step2" style="padding: .55rem; font-size: .8rem; background: linear-gradient(135deg, #4ecdc4 0%, #44a3c2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(78,205,196,.3); transition: all 0.2s ease;">âš¡ Step2 ìˆœì°¨ì‹¤í–‰</button>
        <button id="btn-auto-execute-all" style="padding: .55rem; font-size: .8rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(102,126,234,.3); transition: all 0.2s ease;">âš¡ ì „ì²´ ìˆœì°¨ì‹¤í–‰</button>
      </div>

      <!-- ë³µì‚¬ ë²„íŠ¼ -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: .5rem; margin-bottom: .75rem;">
        <button id="btn-copy-step1-results" style="padding: .55rem; font-size: .85rem; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(255,107,107,.25); transition: all 0.2s ease;">ğŸ“‹ Step1 ë³µì‚¬</button>
        <button id="btn-copy-step2-results" style="padding: .55rem; font-size: .85rem; background: linear-gradient(135deg, #4ecdc4 0%, #44a3c2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(78,205,196,.25); transition: all 0.2s ease;">ğŸ“‹ Step2 ë³µì‚¬</button>
      </div>

      <!-- Step ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: .5rem; margin-bottom: .75rem;">
        <button id="btn-toggle-step1" style="padding: .5rem; font-size: .8rem; background: #fff; color: #ff6b6b; border: 2px solid #ff6b6b; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s ease;">ğŸ”½ Step1 ì ‘ê¸°/í¼ì¹˜ê¸°</button>
        <button id="btn-toggle-step2" style="padding: .5rem; font-size: .8rem; background: #fff; color: #4ecdc4; border: 2px solid #4ecdc4; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s ease;">ğŸ”½ Step2 ì ‘ê¸°/í¼ì¹˜ê¸°</button>
      </div>

      <!-- ìƒíƒœ í‘œì‹œ -->
      <div id="status-bar" class="status-bar">ì‘ì—… ì¤‘...</div>

      <!-- ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë˜ëŠ” ì˜ì—­ -->
      <div id="workflow-boxes-container"></div>
    </div>

    <!-- ì˜¤ë¥¸ìª½ - ê°€ì´ë“œ ë° ì§€ì¹¨ ê´€ë¦¬ ì˜ì—­ -->
    <div class="analysis-area">
      <!-- ì‘ì—… ì§€ì¹¨ ê´€ë¦¬ ë°•ìŠ¤ -->
      <div class="box" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border: none; padding: 1rem; margin-bottom: .75rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .75rem;">
          <div style="color: white; font-weight: 600; font-size: 1.1rem;">ğŸ“ ì‘ì—… ì§€ì¹¨ ê´€ë¦¬</div>
          <div style="display: flex; gap: .5rem;">
            <button id="btn-save-guides" style="padding: .3rem .8rem; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: .85rem; display: none;">ğŸ’¾ ì €ì¥</button>
            <button id="btn-toggle-guide-panel" style="padding: .3rem .6rem; background: white; color: #e74c3c; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: .85rem;">ì—´ê¸°</button>
          </div>
        </div>
        <div id="guide-panel-content" style="display: none;">
          <div style="background: white; border-radius: 6px; padding: .75rem; margin-bottom: .5rem;">
            <div style="font-size: .85rem; color: #666; margin-bottom: .5rem;">
              ëª¨ë“  ì‘ì—… ë°•ìŠ¤ì˜ ì§€ì¹¨ì„ í•œ ê³³ì—ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤. ì§€ì¹¨ ìˆ˜ì • í›„ <strong>ğŸ’¾ ì €ì¥</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
            </div>
          </div>
          <div id="guide-management-container" style="background: white; border-radius: 6px; padding: .75rem; max-height: 400px; overflow-y: auto;">
            <p style="color: #999; text-align: center; padding: 1rem;">ì‘ì—… ë°•ìŠ¤ë¥¼ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>

      <!-- ì¶•ì ëœ ê°€ì´ë“œ ì¡°íšŒ ë°•ìŠ¤ -->
      <div class="box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none; padding: 1rem;">
        <div style="color: white; font-weight: 600; font-size: 1.1rem; margin-bottom: .75rem;">ğŸ“š ì¶•ì ëœ ì‘ì„± ê°€ì´ë“œ</div>
        <div style="background: white; border-radius: 6px; padding: .75rem; margin-bottom: .75rem;">
          <div style="font-size: .85rem; color: #666; margin-bottom: .5rem;">
            ì—¬ëŸ¬ ëŒ€ë³¸ì„ ë¶„ì„í•˜ì—¬ ì¶•ì ëœ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ ê°€ì´ë“œì…ë‹ˆë‹¤.
          </div>
          <button id="btn-load-accumulated-guide" class="primary" style="width: 100%;">ê°€ì´ë“œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
        <div style="background: white; border-radius: 6px; padding: .75rem; max-height: calc(100vh - 300px); overflow-y: auto;">
          <div id="accumulated-guide-result" style="font-size: .9rem; color: #333; line-height: 1.6;">
            <p style="color: #999; text-align: center; padding: 2rem;">
              ê°€ì´ë“œ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
            </p>
          </div>
        </div>
      </div>

      <!-- í˜„ì¬ ì‘ì—… ê°œì„  ì œì•ˆ ë°•ìŠ¤ -->
      <div class="box">
        <div class="toggle-header">
          <span class="label">ğŸ’¡ í˜„ì¬ ì‘ì—… ê°œì„  ì œì•ˆ</span>
          <button id="toggle-suggestions">ì—´ê¸°</button>
        </div>
        <div id="suggestions-content" style="display: none;">
          <div style="font-size: .85rem; color: #666; margin-bottom: .75rem;">
            í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ê°œì„  ì œì•ˆì„ ì œê³µí•©ë‹ˆë‹¤.
          </div>
          <button id="btn-get-suggestions" class="primary" style="width: 100%; margin-bottom: .75rem;">ê°œì„  ì œì•ˆ ë°›ê¸°</button>
          <div id="suggestions-result" style="background: #f8f9fa; border-radius: 6px; padding: .75rem; min-height: 100px; max-height: 400px; overflow-y: auto;">
            <p style="color: #999; text-align: center;">ì œì•ˆì„ ë°›ìœ¼ë ¤ë©´ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- íŒ¨ìŠ¤ì›Œë“œ ëª¨ë‹¬ -->
  <div id="modal-password" class="modal">
    <div class="modal-content">
      <div class="modal-title">ğŸ”’ ì§€ì¹¨ ì˜ì—­ ì ê¸ˆ</div>
      <p style="color: #666; font-size: .9rem; margin-bottom: 1rem;">ì§€ì¹¨ ì˜ì—­ì— ì ‘ê·¼í•˜ë ¤ë©´ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="password" id="password-input" placeholder="íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥" style="margin-bottom: .5rem;">
      <div class="modal-buttons">
        <button id="btn-cancel-password">ì·¨ì†Œ</button>
        <button id="btn-submit-password" class="primary">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- GPT PRO íŒ¨ìŠ¤ì›Œë“œ ëª¨ë‹¬ -->
  <div id="modal-gpt-pro-password" class="modal">
    <div class="modal-content">
      <div class="modal-title">ğŸ”’ GPT PRO ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ ì¤‘)</div>
      <p style="color: #666; font-size: .9rem; margin-bottom: 1rem;">ì´ ê¸°ëŠ¥ì€ í˜„ì¬ í…ŒìŠ¤íŠ¸ ì¤‘ì…ë‹ˆë‹¤. íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="password" id="gpt-pro-password-input" placeholder="íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥" style="margin-bottom: .5rem;">
      <div class="modal-buttons">
        <button id="btn-cancel-gpt-pro-password">ì·¨ì†Œ</button>
        <button id="btn-submit-gpt-pro-password" class="primary">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- ì˜ìƒ ì‹œê°„ ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="modal-categories" class="modal">
    <div class="modal-content">
      <div class="modal-title">ì˜ìƒ ì‹œê°„ ê´€ë¦¬</div>
      <input type="text" id="new-cat-label" placeholder="í‘œì‹œ ì´ë¦„ (ì˜ˆ: 90ë¶„, 120ë¶„)" style="margin-bottom: .5rem;">
      <button id="btn-add-category" class="primary" style="width: 100%; margin-bottom: 1rem;">ì¶”ê°€</button>
      <div id="categories-list" style="max-height: 300px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button id="btn-close-categories">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì²˜ë¦¬ ë‹¨ê³„ ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="modal-steps" class="modal">
    <div class="modal-content">
      <div class="modal-title">ì²˜ë¦¬ ë‹¨ê³„ ê´€ë¦¬</div>
      <p style="font-size: .85rem; color: #666; margin-bottom: .5rem;">
        ìŠ¤íƒ€ì¼: <strong id="modal-steps-style"></strong>
      </p>
      <input type="text" id="new-step-name" placeholder="ë‹¨ê³„ ì´ë¦„ (ì˜ˆ: ìºë¦­í„° ì„¤ì •, ìŠ¤í† ë¦¬ë¼ì¸, ëŒ€ì‚¬ ì‘ì„±)" style="margin-bottom: .5rem;">
      <button id="btn-add-step" class="primary" style="width: 100%; margin-bottom: 1rem;">ì¶”ê°€</button>
      <div id="steps-list" style="max-height: 300px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button id="btn-close-steps">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
  // ===== Firebase ì´ˆê¸°í™” =====
  const firebaseConfig = {
    apiKey: "AIzaSyBacmJDk-PG5FaoqnXV8Rg3P__AKOS2vu4",
    authDomain: "my-sermon-guides.firebaseapp.com",
    projectId: "my-sermon-guides",
    storageBucket: "my-sermon-guides.firebasestorage.app",
    messagingSenderId: "539520456089",
    appId: "1:539520456089:web:d6aceb7838baa89e70af08",
    measurementId: "G-KWN8TH7Z26"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const USER_CODE = 'samuel123';
  const PAGE_NAME = 'drama';
  const GUIDE_PASSWORD = '5555';
  const GPT_PRO_PASSWORD = '6039';
  const CONFIG_KEY = '_drama-config';

  // ===== ì „ì—­ ë³€ìˆ˜ =====
  let guideUnlocked = false;
  let gptProUnlocked = false;
  let currentCategory = '10min';
  let currentGuideStep = '';
  let stepResults = {};

  // ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ì‹œìŠ¤í…œ
  let workflowBoxes = [];
  let nextBoxId = 1;
  let nextStep1BoxNum = 1;
  let nextStep2BoxNum = 1;
  let step1Collapsed = false;
  let step2Collapsed = false;

  // ê¸°ë³¸ ì„¤ì •
  let config = {
    categories: [
      {value: "10min", label: "10ë¶„"},
      {value: "20min", label: "20ë¶„"},
      {value: "30min", label: "30ë¶„"},
      {value: "60min", label: "60ë¶„"}
    ],
    // í†µí•©ëœ ì²˜ë¦¬ ë‹¨ê³„ (ëª¨ë“  ì‹œê°„ëŒ€ì— ë™ì¼)
    unifiedSteps: [
      {id: "character", name: "ìºë¦­í„° ì„¤ì •", order: 1},
      {id: "storyline", name: "ìŠ¤í† ë¦¬ë¼ì¸", order: 2},
      {id: "scene", name: "ì¥ë©´ êµ¬ì„±", order: 3},
      {id: "dialogue", name: "ëŒ€ì‚¬ ì‘ì„±", order: 4}
    ],
    categorySettings: {
      "10min": {
        masterGuide: ""
      },
      "20min": {
        masterGuide: ""
      },
      "30min": {
        masterGuide: ""
      },
      "60min": {
        masterGuide: ""
      }
    }
  };

  // ===== í•œê¸€ â†’ ì˜ë¬¸ ID ìë™ ìƒì„± =====
  function koreanToId(korean) {
    const map = {
      'ìºë¦­í„°': 'character',
      'ìŠ¤í† ë¦¬': 'storyline',
      'ì¤„ê±°ë¦¬': 'plot',
      'ëŒ€ì‚¬': 'dialogue',
      'ì¥ë©´': 'scene',
      'êµ¬ì„±': 'structure',
      'ì„¤ì •': 'setting',
      'ë¶„ì„': 'analysis',
      'ê°œìš”': 'outline',
      'ë…¸ë˜': 'song',
      'ì•ˆë¬´': 'choreography',
      'ì—°ì¶œ': 'direction'
    };

    for (const [key, value] of Object.entries(map)) {
      if (korean.includes(key)) {
        return value + '_' + Date.now().toString(36);
      }
    }

    return 'step_' + Date.now().toString(36);
  }

  // ===== ìœ í‹¸ë¦¬í‹° =====
  function showStatus(msg) {
    const statusBar = document.getElementById('status-bar');
    if (statusBar) {
      statusBar.textContent = msg;
      statusBar.style.display = 'block';
    }
  }

  function hideStatus() {
    const statusBar = document.getElementById('status-bar');
    if (statusBar) {
      statusBar.style.display = 'none';
    }
  }

  // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
  function showLoadingOverlay(text = 'AI ì‘ì—… ì¤‘', subtext = 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...') {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
      const textEl = overlay.querySelector('.loading-text');
      const subtextEl = overlay.querySelector('.loading-subtext');
      if (textEl) textEl.textContent = text;
      if (subtextEl) subtextEl.textContent = subtext;
      overlay.classList.add('show');
    }
  }

  // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
  function hideLoadingOverlay() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
      overlay.classList.remove('show');
    }
  }

  function autoResize(el) {
    if (!el) return;
    el.style.height = 'auto';
    el.style.height = el.scrollHeight + 'px';
  }

  // ===== Firebase í•¨ìˆ˜ =====
  async function loadFromFirebase() {
    try {
      const snapshot = await db.collection('users').doc(USER_CODE).collection(PAGE_NAME).get();

      if (!snapshot.empty) {
        snapshot.forEach(doc => {
          localStorage.setItem(doc.id, doc.data().value);
        });

        const configData = localStorage.getItem(CONFIG_KEY);
        if (configData) {
          config = JSON.parse(configData);
        }
        console.log('âœ… Firebase ë™ê¸°í™” ì™„ë£Œ');
        return true;
      }
      return false;
    } catch (err) {
      console.error('Firebase ë¡œë“œ ì‹¤íŒ¨:', err);
      return false;
    }
  }

  async function saveToFirebase(key, value) {
    try {
      await db.collection('users').doc(USER_CODE).collection(PAGE_NAME).doc(key).set({
        value: value,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      return true;
    } catch (err) {
      console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', err);
      return false;
    }
  }

  async function saveConfig() {
    const configStr = JSON.stringify(config);
    localStorage.setItem(CONFIG_KEY, configStr);
    await saveToFirebase(CONFIG_KEY, configStr);
  }

  // ===== ì´ê´„ ì§€ì¹¨ ê´€ë¦¬ =====
  function loadMasterGuide(category) {
    const settings = config.categorySettings[category];
    const textarea = document.getElementById('master-guide-text');
    if (textarea) {
      if (settings && settings.masterGuide) {
        textarea.value = settings.masterGuide;
      } else {
        textarea.value = '';
      }
      autoResize(textarea);
    }
  }

  async function saveMasterGuide() {
    const textarea = document.getElementById('master-guide-text');
    if (!textarea) return;

    const value = textarea.value;
    const settings = config.categorySettings[currentCategory];

    if (settings) {
      settings.masterGuide = value;
      await saveConfig();

      showStatus('âœ… ì´ê´„ ì§€ì¹¨ ì €ì¥ ì™„ë£Œ!');
      setTimeout(hideStatus, 2000);
    }
  }

  const saveMasterGuideBtn = document.getElementById('save-master-guide');
  if (saveMasterGuideBtn) {
    saveMasterGuideBtn.addEventListener('click', saveMasterGuide);
  }

  const toggleMasterGuideBtn = document.getElementById('toggle-master-guide');
  if (toggleMasterGuideBtn) {
    toggleMasterGuideBtn.addEventListener('click', () => {
      const content = document.getElementById('master-guide-content');
      const btn = document.getElementById('toggle-master-guide');

      if (content && btn) {
        if (content.style.display === 'none') {
          content.style.display = 'block';
          btn.textContent = 'ë‹«ê¸°';
          loadMasterGuide(currentCategory);
        } else {
          content.style.display = 'none';
          btn.textContent = 'ì—´ê¸°';
        }
      }
    });
  }

  // ===== ì§€ì¹¨ ê´€ë¦¬ =====
  function getGuideKey(category, stepId) {
    return `guide-${category}-${stepId}`;
  }

  function loadGuide(category, stepId) {
    const key = getGuideKey(category, stepId);
    const stored = localStorage.getItem(key) || '';
    const textarea = document.getElementById('guide-text');
    if (textarea) {
      textarea.value = stored;
      autoResize(textarea);
    }

    let info = `ìœ í˜•: ${getCategoryLabel(category)} | ë‹¨ê³„: ${getStepName(stepId)}`;
    const infoEl = document.getElementById('current-guide-info');
    if (infoEl) {
      infoEl.textContent = info;
    }
  }

  async function saveGuide() {
    const textarea = document.getElementById('guide-text');
    if (!textarea) return;

    const key = getGuideKey(currentCategory, currentGuideStep);
    const value = textarea.value;

    localStorage.setItem(key, value);

    showStatus('ğŸ’¾ ì €ì¥ ì¤‘...');
    const success = await saveToFirebase(key, value);

    if (success) {
      showStatus('âœ… ì§€ì¹¨ ì €ì¥ ì™„ë£Œ!');
    } else {
      showStatus('âš ï¸ ë¡œì»¬ì—ë§Œ ì €ì¥ë¨');
    }

    setTimeout(hideStatus, 2000);
  }

  // ===== í—¬í¼ í•¨ìˆ˜ =====
  function getCategoryLabel(value) {
    const cat = config.categories.find(c => c.value === value);
    return cat ? cat.label : value;
  }

  function getCurrentSteps() {
    if (!config.unifiedSteps) return [];
    return config.unifiedSteps.sort((a, b) => a.order - b.order);
  }

  function getStepName(stepId) {
    const steps = getCurrentSteps();
    const step = steps.find(s => s.id === stepId);
    return step ? step.name : stepId;
  }

  // ===== GPT PRO ì´ˆì•ˆ êµ¬ì„± ìœ í‹¸ =====
  function assembleGptProDraft() {
    const steps = getCurrentSteps();
    const benchmarkScript = document.getElementById('benchmark-script').value.trim();
    const mainCharacter = document.getElementById('main-character').value.trim();

    if (steps.length === 0) {
      return { error: 'ì²˜ë¦¬ëœ ë‹¨ê³„ê°€ ì—†ìŠµë‹ˆë‹¤.' };
    }

    const completedSteps = steps.filter(step => stepResults[step.id]);

    if (completedSteps.length === 0) {
      return { error: 'ì™„ì„±ëœ ë‹¨ê³„ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê° ë‹¨ê³„ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.' };
    }

    const categoryLabel = getCategoryLabel(currentCategory);

    let fullText = `====================================\n`;
    fullText += `ğŸ­ ë“œë¼ë§ˆ ìŠ¤í¬ë¦½íŠ¸ ì´ˆì•ˆ ìë£Œ (GPT-5.1 ì‘ì„±ìš©)\n`;
    fullText += `====================================\n\n`;
    fullText += `âš ï¸ ì¤‘ìš”: ì´ ìë£ŒëŠ” gpt-4o-miniê°€ ë§Œë“  'ì´ˆì•ˆ'ì…ë‹ˆë‹¤.\n`;
    fullText += `GPT-5.1ì€ ì´ ìë£Œë¥¼ ì°¸ê³ í•˜ë˜, ì²˜ìŒë¶€í„° ìƒˆë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n`;
    fullText += `miniê°€ ë§Œë“  ë¬¸ì¥ì„ ê·¸ëŒ€ë¡œ ë³µì‚¬í•˜ì§€ ë§ê³ , ìì—°ìŠ¤ëŸ¬ìš´ ë“œë¼ë§ˆ ìŠ¤í¬ë¦½íŠ¸ë¡œ ì¬ì‘ì„±í•˜ì„¸ìš”.\n\n`;
    fullText += `${'='.repeat(50)}\n\n`;
    fullText += `ğŸ“Œ ê¸°ë³¸ ì •ë³´\n`;
    fullText += `- ì˜ìƒ ì‹œê°„: ${categoryLabel}\n`;
    if (mainCharacter) {
      fullText += `- ì£¼ì¸ê³µ: ${mainCharacter}\n`;
    }
    if (benchmarkScript) {
      fullText += `- ë²¤ì¹˜ë§ˆí‚¹ ëŒ€ë³¸: ì²¨ë¶€ë¨\n`;
    }
    fullText += `- ì‘ì„±ì¼: ${new Date().toLocaleDateString('ko-KR')}\n`;
    fullText += `\n${'='.repeat(50)}\n\n`;

    if (benchmarkScript) {
      fullText += `ã€ ë²¤ì¹˜ë§ˆí‚¹ ëŒ€ë³¸ ã€‘\n\n`;
      fullText += benchmarkScript;
      fullText += `\n\n${'='.repeat(50)}\n\n`;
    }

    let sectionIndex = 1;
    completedSteps.forEach(step => {
      fullText += `ã€ ${sectionIndex}. ${step.name} ã€‘\n\n`;
      fullText += stepResults[step.id];
      fullText += `\n\n${'='.repeat(50)}\n\n`;
      sectionIndex += 1;
    });

    fullText += `\nğŸ“ ì‘ì„± ì§€ì¹¨:\n`;
    fullText += `ìœ„ì˜ ì´ˆì•ˆ ìë£Œë¥¼ ì°¸ê³ í•˜ì—¬, ì™„ì„±ë„ ë†’ì€ ë“œë¼ë§ˆ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì²˜ìŒë¶€í„° ìƒˆë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n`;

    return {
      error: null,
      fullText,
      draftContent: fullText,
      meta: {
        benchmarkScript,
        mainCharacter,
        categoryLabel
      }
    };
  }

  // ===== ì „ì²´ ë³µì‚¬ ê¸°ëŠ¥ =====
  const btnCopyAll = document.getElementById('btn-copy-all');
  if (btnCopyAll) {
    btnCopyAll.addEventListener('click', () => {
      const draft = assembleGptProDraft();
      if (draft.error) {
        alert(draft.error);
        return;
      }

      const tempTextarea = document.createElement('textarea');
      tempTextarea.value = draft.fullText;
      tempTextarea.style.position = 'fixed';
      tempTextarea.style.opacity = '0';
      document.body.appendChild(tempTextarea);
      tempTextarea.select();

      try {
        document.execCommand('copy');
        showStatus('âœ… GPT-5.1ì— ë¶™ì—¬ë„£ì„ ì¤€ë¹„ ì™„ë£Œ!');
        setTimeout(hideStatus, 2000);
      } catch (err) {
        alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err.message);
      } finally {
        document.body.removeChild(tempTextarea);
      }
    });
  }

  // ===== GPT PRO ì²˜ë¦¬ ê¸°ëŠ¥ =====
  async function executeGptPro() {
    const draft = assembleGptProDraft();
    if (draft.error) {
      alert(draft.error);
      return;
    }

    // ===== 1ë‹¨ê³„: ì „ì²´ ë³µì‚¬ =====
    const tempTextarea = document.createElement('textarea');
    tempTextarea.value = draft.fullText;
    tempTextarea.style.position = 'fixed';
    tempTextarea.style.opacity = '0';
    document.body.appendChild(tempTextarea);
    tempTextarea.select();

    try {
      document.execCommand('copy');
      showStatus('ğŸ“‹ ì „ì²´ ë³µì‚¬ ì™„ë£Œ! GPT PRO ì²˜ë¦¬ ì¤‘...');
    } catch (err) {
      console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
    } finally {
      document.body.removeChild(tempTextarea);
    }

    // ===== 2ë‹¨ê³„: GPT-5.1ë¡œ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± =====
    showStatus('ğŸš€ GPT PRO ì²˜ë¦¬ ì¤‘... (ì•½ 30ì´ˆ ì†Œìš”)');

    try {
      const response = await fetch('/api/drama/gpt-pro', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          mainCharacter: draft.meta.mainCharacter,
          category: draft.meta.categoryLabel,
          draftContent: draft.draftContent
        })
      });

      const data = await response.json();

      if (data.ok) {
        const resultTextarea = document.getElementById('gpt-pro-result');
        const resultContainer = document.getElementById('gpt-pro-result-container');

        if (resultTextarea && resultContainer) {
          resultTextarea.value = data.result;
          autoResize(resultTextarea);
          resultContainer.style.display = 'block';

          // ê²°ê³¼ ë°•ìŠ¤ë¡œ ìŠ¤í¬ë¡¤
          resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        showStatus('âœ… ì „ì²´ ë³µì‚¬ + GPT PRO ì™„ì„±!');
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
        showStatus('âŒ ì‹¤íŒ¨');
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
      showStatus('âŒ ì˜¤ë¥˜');
    } finally {
      setTimeout(hideStatus, 3000);
    }
  }

  const btnGptPro = document.getElementById('btn-gpt-pro');
  if (btnGptPro) {
    btnGptPro.addEventListener('click', () => {
      if (!gptProUnlocked) {
        // íŒ¨ìŠ¤ì›Œë“œ ëª¨ë‹¬ í‘œì‹œ
        const modal = document.getElementById('modal-gpt-pro-password');
        if (modal) modal.classList.add('show');
        const input = document.getElementById('gpt-pro-password-input');
        if (input) {
          input.value = '';
          input.focus();
        }
      } else {
        // ì´ë¯¸ ì ê¸ˆ í•´ì œëœ ê²½ìš° ë°”ë¡œ ì‹¤í–‰
        executeGptPro();
      }
    });
  }

  // GPT PRO ê²°ê³¼ ë³µì‚¬
  const btnCopyGptPro = document.getElementById('btn-copy-gpt-pro');
  if (btnCopyGptPro) {
    btnCopyGptPro.addEventListener('click', () => {
      const textarea = document.getElementById('gpt-pro-result');
      if (textarea && textarea.value) {
        textarea.select();
        document.execCommand('copy');
        const orig = btnCopyGptPro.textContent;
        btnCopyGptPro.textContent = 'âœ… ë³µì‚¬ë¨!';
        setTimeout(() => btnCopyGptPro.textContent = orig, 1500);
      }
    });
  }

  // ===== ë Œë”ë§ í•¨ìˆ˜ =====
  function renderCategories() {
    const select = document.getElementById('drama-category');
    if (!select) return;

    const current = select.value;
    select.innerHTML = config.categories.map(c =>
      `<option value="${c.value}">${c.label}</option>`
    ).join('');

    if (current && config.categories.find(c => c.value === current)) {
      select.value = current;
    } else {
      select.value = config.categories[0].value;
    }
    currentCategory = select.value;
  }

  // Styles are no longer used - main character is a text input field

  function renderProcessingSteps() {
    const steps = getCurrentSteps();
    const container = document.getElementById('processing-steps');

    if (!container) return;

    if (steps.length === 0) {
      container.innerHTML = '<p style="color: #999; font-size: .85rem; text-align: center;">ë‹¨ê³„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>';
      return;
    }

    container.innerHTML = steps.map(step =>
      `<button class="step-btn primary" data-step="${step.id}">${step.order}. ${step.name}</button>`
    ).join('');

    container.querySelectorAll('.step-btn').forEach(btn => {
      btn.addEventListener('click', () => executeStep(btn.dataset.step));
    });
  }

  function renderResultBoxes() {
    const steps = getCurrentSteps();
    const container = document.getElementById('result-boxes');

    if (!container) return;

    container.innerHTML = steps.map(step => `
      <div class="box">
        <label class="label">${step.name}</label>
        <textarea id="result-${step.id}" class="autosize" style="min-height: 140px;" placeholder="${step.name} ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤."></textarea>
      </div>
    `).join('');

    // ê²°ê³¼ ë³µì› ë° ìë™ ë†’ì´
    steps.forEach(step => {
      if (stepResults[step.id]) {
        const textarea = document.getElementById(`result-${step.id}`);
        if (textarea) {
          textarea.value = stepResults[step.id];
          autoResize(textarea);
        }
      }
    });

    // ì…ë ¥ ì´ë²¤íŠ¸ë¡œ ìë™ ë†’ì´ + ê²°ê³¼ ì €ì¥
    container.querySelectorAll('textarea').forEach(textarea => {
      textarea.addEventListener('input', () => {
        autoResize(textarea);
        // ì‚¬ìš©ìê°€ í¸ì§‘í•œ ë‚´ìš©ì„ stepResultsì— ì €ì¥
        const stepId = textarea.id.replace('result-', '');
        stepResults[stepId] = textarea.value;
      });
    });
  }

  function renderGuideTabs() {
    const steps = getCurrentSteps();
    const container = document.getElementById('guide-tabs');

    if (!container) return;

    container.innerHTML = steps.map(step =>
      `<button class="${step.id === currentGuideStep ? 'primary' : ''}"
        data-step="${step.id}">${step.name}</button>`
    ).join('');

    container.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        currentGuideStep = btn.dataset.step;
        renderGuideTabs();
        loadGuide(currentCategory, currentGuideStep);
      });
    });
  }

  // ===== ì²˜ë¦¬ ë‹¨ê³„ ì‹¤í–‰ =====
  async function executeStep(stepId) {
    const benchmarkScript = document.getElementById('benchmark-script').value;
    const mainCharacter = document.getElementById('main-character').value;
    const guideKey = getGuideKey(currentCategory, stepId);
    const guide = localStorage.getItem(guideKey) || '';

    // ì´ê´„ ì§€ì¹¨ ê°€ì ¸ì˜¤ê¸°
    const settings = config.categorySettings[currentCategory];
    const masterGuide = settings ? settings.masterGuide : '';

    const steps = getCurrentSteps();
    const currentStepIndex = steps.findIndex(s => s.id === stepId);
    const previousResults = {};
    for (let i = 0; i < currentStepIndex; i++) {
      const prevStep = steps[i];
      if (stepResults[prevStep.id]) {
        previousResults[prevStep.id] = {
          name: prevStep.name,
          result: stepResults[prevStep.id]
        };
      }
    }

    showStatus(`ğŸ¤– ${getStepName(stepId)} ì²˜ë¦¬ ì¤‘...`);

    try {
      const response = await fetch('/api/drama/process', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          category: currentCategory,
          stepId: stepId,
          stepName: getStepName(stepId),
          text: benchmarkScript,
          mainCharacter: mainCharacter,
          guide: guide,
          masterGuide: masterGuide,
          previousResults: previousResults
        })
      });

      const data = await response.json();

      if (data.ok) {
        stepResults[stepId] = data.result;
        const textarea = document.getElementById(`result-${stepId}`);
        if (textarea) {
          textarea.value = data.result;
          autoResize(textarea);
        }

        showStatus('âœ… ì™„ë£Œ!');
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
        showStatus('âŒ ì‹¤íŒ¨');
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
      showStatus('âŒ ì˜¤ë¥˜');
    } finally {
      setTimeout(hideStatus, 2000);
    }
  }

  // ===== ì¹´í…Œê³ ë¦¬ ë³€ê²½ =====
  const categorySelect = document.getElementById('drama-category');
  if (categorySelect) {
    categorySelect.addEventListener('change', (e) => {
      currentCategory = e.target.value;
      stepResults = {};
      const gptProContainer = document.getElementById('gpt-pro-result-container');
      if (gptProContainer) gptProContainer.style.display = 'none';

      loadMasterGuide(currentCategory);
      renderProcessingSteps();
      renderResultBoxes();
      renderGuideTabs();
    });
  }

  // ===== íŒ¨ìŠ¤ì›Œë“œ =====
  const toggleGuidesBtn = document.getElementById('toggle-guides');
  if (toggleGuidesBtn) {
    toggleGuidesBtn.addEventListener('click', () => {
      const content = document.getElementById('guide-content');
      const btn = document.getElementById('toggle-guides');

      if (!content || !btn) return;

      if (content.style.display === 'none') {
        if (!guideUnlocked) {
          const modal = document.getElementById('modal-password');
          if (modal) modal.classList.add('show');
          const input = document.getElementById('password-input');
          if (input) {
            input.value = '';
            input.focus();
          }
        } else {
          content.style.display = 'block';
          btn.textContent = 'ë‹«ê¸°';
        }
      } else {
        content.style.display = 'none';
        btn.textContent = 'ì—´ê¸°';
      }
    });
  }

  const btnSubmitPassword = document.getElementById('btn-submit-password');
  if (btnSubmitPassword) {
    btnSubmitPassword.addEventListener('click', () => {
      const input = document.getElementById('password-input');
      if (input && input.value === GUIDE_PASSWORD) {
        guideUnlocked = true;
        const modal = document.getElementById('modal-password');
        if (modal) modal.classList.remove('show');
        const content = document.getElementById('guide-content');
        if (content) content.style.display = 'block';
        const btn = document.getElementById('toggle-guides');
        if (btn) btn.textContent = 'ë‹«ê¸°';

        const steps = getCurrentSteps();
        if (steps.length > 0) {
          currentGuideStep = steps[0].id;
          renderGuideTabs();
          loadGuide(currentCategory, currentGuideStep);
        }
      } else {
        alert('âŒ íŒ¨ìŠ¤ì›Œë“œê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        if (input) input.value = '';
      }
    });
  }

  const btnCancelPassword = document.getElementById('btn-cancel-password');
  if (btnCancelPassword) {
    btnCancelPassword.addEventListener('click', () => {
      const modal = document.getElementById('modal-password');
      if (modal) modal.classList.remove('show');
    });
  }

  const passwordInput = document.getElementById('password-input');
  if (passwordInput) {
    passwordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const btn = document.getElementById('btn-submit-password');
        if (btn) btn.click();
      }
    });
  }

  const saveGuideBtn = document.getElementById('save-guide');
  if (saveGuideBtn) {
    saveGuideBtn.addEventListener('click', saveGuide);
  }

  // ===== GPT PRO íŒ¨ìŠ¤ì›Œë“œ =====
  const btnSubmitGptProPassword = document.getElementById('btn-submit-gpt-pro-password');
  if (btnSubmitGptProPassword) {
    btnSubmitGptProPassword.addEventListener('click', () => {
      const input = document.getElementById('gpt-pro-password-input');
      if (input && input.value === GPT_PRO_PASSWORD) {
        gptProUnlocked = true;
        const modal = document.getElementById('modal-gpt-pro-password');
        if (modal) modal.classList.remove('show');

        // íŒ¨ìŠ¤ì›Œë“œ í™•ì¸ í›„ GPT PRO ì‹¤í–‰
        executeGptPro();
      } else {
        alert('âŒ íŒ¨ìŠ¤ì›Œë“œê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        if (input) input.value = '';
      }
    });
  }

  const btnCancelGptProPassword = document.getElementById('btn-cancel-gpt-pro-password');
  if (btnCancelGptProPassword) {
    btnCancelGptProPassword.addEventListener('click', () => {
      const modal = document.getElementById('modal-gpt-pro-password');
      if (modal) modal.classList.remove('show');
    });
  }

  const gptProPasswordInput = document.getElementById('gpt-pro-password-input');
  if (gptProPasswordInput) {
    gptProPasswordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const btn = document.getElementById('btn-submit-gpt-pro-password');
        if (btn) btn.click();
      }
    });
  }

  // ===== ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ =====
  function renderCategoryManageList() {
    const list = document.getElementById('categories-list');
    if (!list) return;

    if (config.categories.length === 0) {
      list.innerHTML = '<p style="color: #999; font-size: .8rem; text-align: center; padding: .5rem;">ì¹´í…Œê³ ë¦¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>';
      return;
    }

    list.innerHTML = config.categories.map((cat, idx) => `
      <div class="storage-item">
        <div>
          <div style="font-weight: 600;">${cat.label}</div>
          <div style="font-size: .75rem; color: #666;">${cat.value}</div>
        </div>
        <div>
          <button onclick="editCategory(${idx})" style="margin-right: .3rem;">ì´ë¦„ ìˆ˜ì •</button>
          ${config.categories.length > 1 ? `<button class="danger" onclick="deleteCategory(${idx})">ì‚­ì œ</button>` : ''}
        </div>
      </div>
    `).join('');
  }

  const btnManageCategories = document.getElementById('btn-manage-categories');
  if (btnManageCategories) {
    btnManageCategories.addEventListener('click', () => {
      renderCategoryManageList();
      const modal = document.getElementById('modal-categories');
      if (modal) modal.classList.add('show');
    });
  }

  const btnCloseCategories = document.getElementById('btn-close-categories');
  if (btnCloseCategories) {
    btnCloseCategories.addEventListener('click', () => {
      const modal = document.getElementById('modal-categories');
      if (modal) modal.classList.remove('show');
    });
  }

  const btnAddCategory = document.getElementById('btn-add-category');
  if (btnAddCategory) {
    btnAddCategory.addEventListener('click', async () => {
      const input = document.getElementById('new-cat-label');
      if (!input) return;

      const label = input.value.trim();

      if (!label) {
        alert('í‘œì‹œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      const value = koreanToId(label);

      if (config.categories.find(c => c.value === value)) {
        alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¹´í…Œê³ ë¦¬ì…ë‹ˆë‹¤.');
        return;
      }

      config.categories.push({value, label});
      config.categorySettings[value] = {
        masterGuide: "",
        styles: []
      };

      await saveConfig();
      renderCategories();
      renderCategoryManageList();
      input.value = '';
    });
  }

  window.editCategory = async function(idx) {
    const current = config.categories[idx];
    if (!current) return;

    const newLabel = prompt('ìƒˆ ì˜ìƒ ì‹œê°„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', current.label);
    if (newLabel === null) return;

    const trimmed = newLabel.trim();
    if (!trimmed) {
      alert('í‘œì‹œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    current.label = trimmed;
    await saveConfig();
    renderCategories();
    renderCategoryManageList();
    if (current.value === currentCategory) {
      loadMasterGuide(currentCategory);
      renderProcessingSteps();
      renderResultBoxes();
      renderGuideTabs();
    }
  };

  window.deleteCategory = async function(idx) {
    if (!confirm(`"${config.categories[idx].label}" ì‚­ì œ?`)) return;
    const value = config.categories[idx].value;
    config.categories.splice(idx, 1);
    delete config.categorySettings[value];
    await saveConfig();
    renderCategories();
    renderCategoryManageList();
    loadMasterGuide(currentCategory);
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
  };

  // ===== ì²˜ë¦¬ ë‹¨ê³„ ê´€ë¦¬ ë²„íŠ¼ =====
  const btnManageSteps = document.getElementById('btn-manage-steps');
  if (btnManageSteps) {
    btnManageSteps.addEventListener('click', () => {
      const styleLabel = document.getElementById('modal-steps-style');
      if (styleLabel) styleLabel.textContent = 'í†µí•© ì²˜ë¦¬ ë‹¨ê³„';

      renderStepsManageList();

      const stepsModal = document.getElementById('modal-steps');
      if (stepsModal) stepsModal.classList.add('show');
    });
  }

  // Style management removed - using main character text input instead

  function renderStepsManageList() {
    const list = document.getElementById('steps-list');
    if (!list) return;

    if (!config.unifiedSteps) config.unifiedSteps = [];
    config.unifiedSteps.sort((a, b) => a.order - b.order);

    if (config.unifiedSteps.length === 0) {
      list.innerHTML = '<p style="color: #999; font-size: .8rem; text-align: center; padding: .5rem;">ë‹¨ê³„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>';
      return;
    }

    list.innerHTML = config.unifiedSteps.map((step, idx) => `
      <div class="storage-item">
        <span>${step.order}. ${step.name}</span>
        <div>
          ${idx > 0 ? `<button onclick="moveStep(${idx}, -1)" style="margin-right: .3rem;">â†‘</button>` : ''}
          ${idx < config.unifiedSteps.length - 1 ? `<button onclick="moveStep(${idx}, 1)" style="margin-right: .3rem;">â†“</button>` : ''}
          <button onclick="renameStep(${idx})" style="margin-right: .3rem;">ì´ë¦„ ìˆ˜ì •</button>
          <button class="danger" onclick="deleteStep(${idx})">ì‚­ì œ</button>
        </div>
      </div>
    `).join('');
  }

  const btnCloseSteps = document.getElementById('btn-close-steps');
  if (btnCloseSteps) {
    btnCloseSteps.addEventListener('click', () => {
      const modal = document.getElementById('modal-steps');
      if (modal) modal.classList.remove('show');
    });
  }

  const btnAddStep = document.getElementById('btn-add-step');
  if (btnAddStep) {
    btnAddStep.addEventListener('click', async () => {
      const input = document.getElementById('new-step-name');
      if (!input) return;

      const name = input.value.trim();

      if (!name) {
        alert('ë‹¨ê³„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      if (!config.unifiedSteps) config.unifiedSteps = [];

      const id = koreanToId(name);
      const maxOrder = config.unifiedSteps.length > 0 ? Math.max(...config.unifiedSteps.map(s => s.order)) : 0;

      config.unifiedSteps.push({
        id: id,
        name: name,
        order: maxOrder + 1
      });

      await saveConfig();
      renderProcessingSteps();
      renderResultBoxes();
      renderGuideTabs();
      renderStepsManageList();
      input.value = '';
    });
  }

  window.moveStep = async function(idx, direction) {
    if (!config.unifiedSteps) return;

    const steps = config.unifiedSteps;
    const targetIdx = idx + direction;

    if (targetIdx < 0 || targetIdx >= steps.length) return;

    [steps[idx].order, steps[targetIdx].order] = [steps[targetIdx].order, steps[idx].order];

    await saveConfig();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
    renderStepsManageList();
  };

  window.deleteStep = async function(idx) {
    if (!config.unifiedSteps) return;

    if (!confirm(`"${config.unifiedSteps[idx].name}" ì‚­ì œ?`)) return;

    config.unifiedSteps.splice(idx, 1);
    await saveConfig();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
    renderStepsManageList();
  };

  window.renameStep = async function(idx) {
    if (!config.unifiedSteps) return;

    const step = config.unifiedSteps[idx];
    if (!step) return;

    const newName = prompt('ìƒˆ ë‹¨ê³„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', step.name);
    if (newName === null) return;

    const trimmed = newName.trim();
    if (!trimmed) {
      alert('ë‹¨ê³„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    step.name = trimmed;
    await saveConfig();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
    renderStepsManageList();
  };

  // ===== ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° =====
  const btnSave = document.getElementById('btn-save');
  if (btnSave) {
    btnSave.addEventListener('click', () => {
      const saved = JSON.parse(localStorage.getItem('drama-saved') || '[]');
      const mainCharacter = document.getElementById('main-character').value.trim();

      saved.push({
        date: document.getElementById('drama-date').value,
        category: currentCategory,
        mainCharacter: mainCharacter,
        benchmarkScript: document.getElementById('benchmark-script').value,
        results: stepResults,
        savedAt: new Date().toISOString()
      });

      localStorage.setItem('drama-saved', JSON.stringify(saved));
      renderSavedList();
      alert('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    });
  }

  function renderSavedList() {
    const saved = JSON.parse(localStorage.getItem('drama-saved') || '[]');
    const list = document.getElementById('saved-list');

    if (!list) return;

    if (saved.length === 0) {
      list.innerHTML = '<p style="color: #999; font-size: .8rem; text-align: center; padding: .5rem;">ì €ì¥ëœ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    list.innerHTML = saved.map((item, idx) => {
      const catLabel = getCategoryLabel(item.category);
      const mainChar = item.mainCharacter || 'ì£¼ì¸ê³µ ë¯¸ì§€ì •';
      const display = `${item.date} - ${catLabel} - ${mainChar}`;

      return `
        <div class="storage-item">
          <span style="font-size: .85rem;">${display}</span>
          <div>
            <button onclick="loadSaved(${idx})" style="margin-right: .3rem;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button onclick="deleteSaved(${idx})">ì‚­ì œ</button>
          </div>
        </div>
      `;
    }).join('');
  }

  window.loadSaved = function(idx) {
    const saved = JSON.parse(localStorage.getItem('drama-saved') || '[]');
    const item = saved[idx];

    document.getElementById('drama-date').value = item.date || '';
    document.getElementById('drama-category').value = item.category || '10min';
    document.getElementById('benchmark-script').value = item.benchmarkScript || '';
    document.getElementById('main-character').value = item.mainCharacter || '';

    currentCategory = item.category || '10min';
    stepResults = item.results || {};

    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();

    document.querySelectorAll('textarea').forEach(autoResize);
  };

  window.deleteSaved = function(idx) {
    if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const saved = JSON.parse(localStorage.getItem('drama-saved') || '[]');
    saved.splice(idx, 1);
    localStorage.setItem('drama-saved', JSON.stringify(saved));
    renderSavedList();
  };

  // ===== textarea ìë™ ë†’ì´ =====
  document.querySelectorAll('textarea.autosize').forEach(textarea => {
    textarea.addEventListener('input', () => autoResize(textarea));
  });

  // ===== ë¶„ì„ ì˜ì—­ í† ê¸€ =====
  const toggleSuggestionsBtn = document.getElementById('toggle-suggestions');
  if (toggleSuggestionsBtn) {
    toggleSuggestionsBtn.addEventListener('click', () => {
      const content = document.getElementById('suggestions-content');
      const btn = document.getElementById('toggle-suggestions');
      if (content && btn) {
        if (content.style.display === 'none') {
          content.style.display = 'block';
          btn.textContent = 'ë‹«ê¸°';
        } else {
          content.style.display = 'none';
          btn.textContent = 'ì—´ê¸°';
        }
      }
    });
  }

  // ===== ëœë¤ ì£¼ì¸ê³µ ìƒì„± =====
  const btnRandomCharacter = document.getElementById('btn-random-character');
  if (btnRandomCharacter) {
    btnRandomCharacter.addEventListener('click', () => {
      const characters = [
        '30ëŒ€ ë‚¨ì„± ëª©ì‚¬',
        '20ëŒ€ ì—¬ì„± ëŒ€í•™ìƒ',
        '40ëŒ€ ë‚¨ì„± ì‚¬ì—…ê°€',
        '50ëŒ€ ì—¬ì„± ì£¼ë¶€',
        'ì²­ë…„ ì „ë„ì‚¬',
        'ì¤‘ë…„ ë‚¨ì„± êµì‚¬',
        '20ëŒ€ ë‚¨ì„± ì²­ë…„',
        '30ëŒ€ ì—¬ì„± ì§ì¥ì¸',
        'ê³ ë“±í•™ìƒ ë‚¨ì',
        'ê³ ë“±í•™ìƒ ì—¬ì',
        '60ëŒ€ ë…¸ë¶€ë¶€',
        'ì Šì€ ë¶€ë¶€',
        'ì´í˜¼í•œ ì¤‘ë…„ ì—¬ì„±',
        'í™€ì–´ë¨¸ë‹ˆì™€ ì•„ë“¤',
        'ì•„ë²„ì§€ì™€ ë”¸'
      ];
      const random = characters[Math.floor(Math.random() * characters.length)];
      document.getElementById('main-character').value = random;
    });
  }

  // ===== ë²¤ì¹˜ë§ˆí‚¹ ë¶„ì„ ê¸°ëŠ¥ =====
  const btnAnalyzeBenchmark = document.getElementById('btn-analyze-benchmark');
  if (btnAnalyzeBenchmark) {
    btnAnalyzeBenchmark.addEventListener('click', async () => {
      const benchmarkScript = document.getElementById('benchmark-script').value.trim();
      const uploadDate = document.getElementById('benchmark-upload-date').value.trim();
      const viewCount = document.getElementById('benchmark-view-count').value.trim();
      const analysisResult = document.getElementById('analysis-result');

      if (!benchmarkScript) {
        alert('ë²¤ì¹˜ë§ˆí‚¹ ëŒ€ë³¸ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!uploadDate || !viewCount) {
        alert('ì—…ë¡œë“œ ë‚ ì§œì™€ ì¡°íšŒìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ê°„ë‹¨í•œ í•´ì‹œ ìƒì„± í•¨ìˆ˜ (ì¤‘ë³µ ì²´í¬ìš©)
      const generateSimpleHash = (text) => {
        let hash = 0;
        for (let i = 0; i < text.length; i++) {
          const char = text.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash;
        }
        return hash.toString(36);
      };

      // ì¤‘ë³µ ìë£Œ ì²´í¬ë°•ìŠ¤ ìƒíƒœ í™•ì¸ (ì²´í¬ ì‹œ ë¶„ì„ë§Œ ìˆ˜í–‰, ì €ì¥ ì•ˆ í•¨)
      const isDuplicateData = document.getElementById('check-duplicates')?.checked || false;
      const scriptHash = isDuplicateData ? '' : generateSimpleHash(benchmarkScript);

      // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
      showLoadingOverlay('ë²¤ì¹˜ë§ˆí¬ ëŒ€ë³¸ ë¶„ì„ ì¤‘', 'AIê°€ ëŒ€ë³¸ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
      analysisResult.innerHTML = '<p style="color: #e74c3c; text-align: center;">ğŸ”„ ë¶„ì„ ì¤‘...</p>';

      try {
        const response = await fetch('/api/drama/analyze-benchmark', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            benchmarkScript: benchmarkScript,
            uploadDate: uploadDate,
            viewCount: viewCount,
            category: currentCategory,
            scriptHash: scriptHash
          })
        });

        const data = await response.json();

        if (data.ok) {
          const statusMessage = data.isDuplicate
            ? '<strong style="color: #f39c12;">âš ï¸ ì¤‘ë³µ ëŒ€ë³¸ - ë¶„ì„ë§Œ ìˆ˜í–‰ë¨ (ì €ì¥ ì•ˆ ë¨)</strong>'
            : '<strong style="color: #e74c3c;">âœ… ë¶„ì„ ì™„ë£Œ ë° DB ì €ì¥ë¨</strong>';

          analysisResult.innerHTML = `
            <div style="margin-bottom: .75rem;">
              ${statusMessage}
            </div>
            <div style="white-space: pre-wrap; line-height: 1.8;">${data.analysis}</div>
          `;
        } else {
          analysisResult.innerHTML = `<p style="color: #e74c3c;">âŒ ì˜¤ë¥˜: ${data.error}</p>`;
        }
      } catch (err) {
        analysisResult.innerHTML = `<p style="color: #e74c3c;">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}</p>`;
      } finally {
        hideLoadingOverlay();
      }
    });
  }

  // ===== ê°œì„  ì œì•ˆ ë°›ê¸° =====
  const btnGetSuggestions = document.getElementById('btn-get-suggestions');
  if (btnGetSuggestions) {
    btnGetSuggestions.addEventListener('click', async () => {
      const suggestionsResult = document.getElementById('suggestions-result');

      // ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ê²°ê³¼ë¥¼ ëª¨ì•„ì„œ ì „ë‹¬
      let allContent = '';
      workflowBoxes.forEach(box => {
        if (box.result) {
          allContent += `\n\n[${box.boxNumber}. ${box.name}]\n${box.result}\n`;
        }
      });

      if (!allContent) {
        alert('ì‘ì—… ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
        return;
      }

      suggestionsResult.innerHTML = '<p style="color: #4a90e2; text-align: center;">ğŸ”„ ì œì•ˆ ìƒì„± ì¤‘...</p>';

      try {
        const response = await fetch('/api/drama/get-suggestions', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            currentDraft: allContent,
            category: currentCategory
          })
        });

        const data = await response.json();

        if (data.ok) {
          suggestionsResult.innerHTML = `
            <div style="white-space: pre-wrap; line-height: 1.8;">${data.suggestions}</div>
          `;
        } else {
          suggestionsResult.innerHTML = `<p style="color: #e74c3c;">âŒ ì˜¤ë¥˜: ${data.error}</p>`;
        }
      } catch (err) {
        suggestionsResult.innerHTML = `<p style="color: #e74c3c;">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}</p>`;
      }
    });
  }

  // ===== ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ì‹œìŠ¤í…œ =====

  // ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ì¶”ê°€
  function addWorkflowBox(stepType = 'step1') {
    const stepLabel = stepType === 'step1' ? 'Step1' : 'Step2';
    const stepNumber = stepType === 'step1' ? nextStep1BoxNum : nextStep2BoxNum;

    const box = {
      id: `box_${nextBoxId}`,
      boxNumber: nextBoxId,
      stepNumber: stepNumber,
      stepType: stepType,
      name: `${stepLabel} ì‘ì—… ${stepNumber}`,
      inputs: {
        benchmarkScript: false,
        aiAnalysis: false
      },
      guide: '',
      result: ''
    };

    workflowBoxes.push(box);
    nextBoxId++;

    if (stepType === 'step1') {
      nextStep1BoxNum++;
    } else {
      nextStep2BoxNum++;
    }

    renderWorkflowBoxes();
    saveWorkflowBoxes();
  }

  // ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ì‚­ì œ
  function deleteWorkflowBox(boxId) {
    const index = workflowBoxes.findIndex(b => b.id === boxId);
    if (index !== -1) {
      if (confirm(`"${workflowBoxes[index].name}" ë°•ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        workflowBoxes.splice(index, 1);

        // Stepë³„ ë°•ìŠ¤ ë²ˆí˜¸ ì¬ì •ë ¬
        const step1Boxes = workflowBoxes.filter(b => b.stepType === 'step1');
        const step2Boxes = workflowBoxes.filter(b => b.stepType === 'step2');

        step1Boxes.forEach((box, idx) => {
          box.stepNumber = idx + 1;
          box.name = `Step1 ì‘ì—… ${idx + 1}`;
        });

        step2Boxes.forEach((box, idx) => {
          box.stepNumber = idx + 1;
          box.name = `Step2 ì‘ì—… ${idx + 1}`;
        });

        // ë‹¤ìŒ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
        nextStep1BoxNum = step1Boxes.length + 1;
        nextStep2BoxNum = step2Boxes.length + 1;

        renderWorkflowBoxes();
        saveWorkflowBoxes();
      }
    }
  }

  // ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ë Œë”ë§
  function renderWorkflowBoxes() {
    const container = document.getElementById('workflow-boxes-container');
    if (!container) return;

    if (workflowBoxes.length === 0) {
      container.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">â• ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‘ì—… ë°•ìŠ¤ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>';
      return;
    }

    container.innerHTML = workflowBoxes.map((box, index) => {
      const stepType = box.stepType || 'step1';  // ê¸°ë³¸ê°’ step1
      const stepBadgeClass = stepType === 'step1' ? 'step1' : 'step2';
      const stepBadgeColor = stepType === 'step1' ? '#ff6b6b' : '#4ecdc4';
      const stepBadgeGradient = stepType === 'step1' ? 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)' : 'linear-gradient(135deg, #4ecdc4 0%, #44a3c2 100%)';
      const stepBgColor = stepType === 'step1' ? '#fff5f5' : '#f0fdfc';
      const stepLabel = stepType === 'step1' ? 'Step1' : 'Step2';

      return `
      <div class="box workflow-box ${stepType}" id="workflow-box-${box.id}" draggable="true" data-box-index="${index}" style="margin-bottom: .5rem; border-left: 4px solid ${stepBadgeColor}; cursor: move;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
          <div style="display: flex; align-items: center; gap: .4rem; flex: 1;">
            <span style="cursor: grab; font-size: 1rem; color: #999; user-select: none;">â‹®â‹®</span>
            <span style="background: ${stepBadgeGradient}; color: white; padding: .25rem .5rem; border-radius: 6px; font-weight: 600; font-size: .75rem; box-shadow: 0 2px 4px rgba(0,0,0,.1);">${stepLabel} ${box.stepNumber || box.boxNumber}</span>
            <input type="text" value="${box.name}" onchange="updateBoxName('${box.id}', this.value)" style="font-weight: 600; font-size: .85rem; border: none; padding: .2rem .4rem; border-radius: 4px; background: #f8f9fa; flex: 1;" onclick="(function(e){e.stopPropagation();})(event)">
          </div>
          <div style="display: flex; gap: .3rem; align-items: center;">
            <button onclick="(function(e){executeWorkflowBox('${box.id}'); e.stopPropagation();})(event)" style="padding: .25rem .5rem; font-size: .75rem; background: ${stepBadgeGradient}; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">â–¶ï¸</button>
            <button onclick="(function(e){copyBoxResult('${box.id}'); e.stopPropagation();})(event)" style="padding: .25rem .5rem; font-size: .75rem; background: white; border: 2px solid ${stepBadgeColor}; color: ${stepBadgeColor}; border-radius: 6px; cursor: pointer; font-weight: 600;">ğŸ“‹</button>
            ${index > 0 ? `<button onclick="(function(e){moveBoxUp(${index}); e.stopPropagation();})(event)" style="padding: .25rem .4rem; font-size: .75rem; border-radius: 4px; background: #f8f9fa; border: none; cursor: pointer;">â–²</button>` : ''}
            ${index < workflowBoxes.length - 1 ? `<button onclick="(function(e){moveBoxDown(${index}); e.stopPropagation();})(event)" style="padding: .25rem .4rem; font-size: .75rem; border-radius: 4px; background: #f8f9fa; border: none; cursor: pointer;">â–¼</button>` : ''}
            <button onclick="deleteWorkflowBox('${box.id}')" class="danger" style="padding: .25rem .5rem; font-size: .75rem; border-radius: 6px;">ğŸ—‘ï¸</button>
          </div>
        </div>

        <div class="box-content" id="content-${box.id}" style="display: ${(stepType === 'step1' && step1Collapsed) || (stepType === 'step2' && step2Collapsed) ? 'none' : 'block'}">
        <!-- ì…ë ¥ ì†ŒìŠ¤ ì„ íƒ -->
        <div style="background: ${stepBgColor}; padding: .5rem; border-radius: 8px; margin-bottom: .5rem; border: 1px solid ${stepBadgeColor}20;">
          <div style="font-size: .75rem; font-weight: 600; margin-bottom: .4rem; color: #555;">ğŸ“¥ ì…ë ¥ ì†ŒìŠ¤</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: .3rem;">
            <label style="display: flex; align-items: center; gap: .25rem; cursor: pointer; padding: .2rem; border-radius: 4px; transition: background 0.2s;">
              <input type="checkbox" ${box.inputs.benchmarkScript ? 'checked' : ''} onchange="updateBoxInput('${box.id}', 'benchmarkScript', this.checked)">
              <span style="font-size: .75rem;">ë²¤ì¹˜ë§ˆí‚¹ ëŒ€ë³¸</span>
            </label>
            <label style="display: flex; align-items: center; gap: .25rem; cursor: pointer; padding: .2rem; border-radius: 4px; transition: background 0.2s;">
              <input type="checkbox" ${box.inputs.aiAnalysis ? 'checked' : ''} onchange="updateBoxInput('${box.id}', 'aiAnalysis', this.checked)">
              <span style="font-size: .75rem;">AI ë¶„ì„</span>
            </label>
            ${workflowBoxes.slice(0, index).filter(b => b.stepType === stepType).map(otherBox => `
              <label style="display: flex; align-items: center; gap: .25rem; cursor: pointer; padding: .2rem; border-radius: 4px; transition: background 0.2s;">
                <input type="checkbox" ${box.inputs[`box_${otherBox.boxNumber}`] ? 'checked' : ''} onchange="updateBoxInput('${box.id}', 'box_${otherBox.boxNumber}', this.checked)">
                <span style="font-size: .75rem;">[${otherBox.stepNumber || otherBox.boxNumber}] ${otherBox.name}</span>
              </label>
            `).join('')}
          </div>
        </div>

        <!-- ê²°ê³¼ í‘œì‹œ -->
        <div style="background: ${stepBgColor}; padding: .5rem; border-radius: 8px; border: 1px solid ${stepBadgeColor}30;">
          <div style="font-size: .75rem; font-weight: 600; margin-bottom: .3rem; color: ${stepBadgeColor};">ğŸ“Š ê²°ê³¼</div>
          <textarea id="result-${box.id}" readonly style="width: 100%; min-height: 80px; font-size: .75rem; padding: .4rem; border: none; border-radius: 6px; background: white; box-shadow: inset 0 1px 3px rgba(0,0,0,.05); resize: vertical;" placeholder="ì‹¤í–‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...">${box.result}</textarea>
        </div>
        </div>
      </div>
      `;
    }).join('');

    // ì§€ì¹¨ ê´€ë¦¬ íŒ¨ë„ë„ ì—…ë°ì´íŠ¸
    renderGuideManagement();

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì¬ì„¤ì •
    setupDragAndDrop();
  }

  // ì§€ì¹¨ ê´€ë¦¬ íŒ¨ë„ ë Œë”ë§
  function renderGuideManagement() {
    const container = document.getElementById('guide-management-container');
    if (!container) return;

    if (workflowBoxes.length === 0) {
      container.innerHTML = '<p style="color: #999; text-align: center; padding: 1rem;">ì‘ì—… ë°•ìŠ¤ë¥¼ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>';
      return;
    }

    container.innerHTML = workflowBoxes.map(box => {
      const stepType = box.stepType || 'step1';
      const stepBadgeColor = stepType === 'step1' ? '#ff6b6b' : '#4ecdc4';
      const stepBadgeGradient = stepType === 'step1' ? 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)' : 'linear-gradient(135deg, #4ecdc4 0%, #44a3c2 100%)';
      const stepLabel = stepType === 'step1' ? 'Step1' : 'Step2';

      return `
        <div style="border: 2px solid ${stepBadgeColor}; border-radius: 10px; padding: .75rem; margin-bottom: .75rem; background: ${stepType === 'step1' ? '#fff5f5' : '#f0fdfc'};">
          <div style="display: flex; align-items: center; gap: .5rem; margin-bottom: .5rem;">
            <span style="background: ${stepBadgeGradient}; color: white; padding: .3rem .6rem; border-radius: 6px; font-weight: 600; font-size: .8rem; box-shadow: 0 2px 4px rgba(0,0,0,.1);">${stepLabel} ${box.stepNumber || box.boxNumber}</span>
            <span style="font-weight: 600; font-size: .9rem; color: #333;">${box.name}</span>
          </div>
          <textarea
            id="guide-panel-${box.id}"
            onchange="updateBoxGuide('${box.id}', this.value)"
            style="width: 100%; min-height: 100px; font-size: .85rem; padding: .6rem; border: none; border-radius: 8px; font-family: inherit; background: white; box-shadow: inset 0 2px 4px rgba(0,0,0,.05);"
            placeholder="ì´ ì‘ì—…ì˜ êµ¬ì²´ì ì¸ ì§€ì¹¨ì„ ì…ë ¥í•˜ì„¸ìš”...">${box.guide || ''}</textarea>
        </div>
      `;
    }).join('');
  }

  // ë°•ìŠ¤ ì´ë¦„ ì—…ë°ì´íŠ¸
  window.updateBoxName = function(boxId, newName) {
    const box = workflowBoxes.find(b => b.id === boxId);
    if (box) {
      box.name = newName;
      saveWorkflowBoxes();
      renderWorkflowBoxes();
    }
  };

  // ì…ë ¥ ì†ŒìŠ¤ ì—…ë°ì´íŠ¸
  window.updateBoxInput = function(boxId, inputKey, checked) {
    const box = workflowBoxes.find(b => b.id === boxId);
    if (box) {
      box.inputs[inputKey] = checked;
      saveWorkflowBoxes();
    }
  };

  // ì§€ì¹¨ ì—…ë°ì´íŠ¸ (onChangeëŠ” ë©”ëª¨ë¦¬ì—ë§Œ ì €ì¥, ì‹¤ì œ ì €ì¥ì€ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ)
  window.updateBoxGuide = function(boxId, guide) {
    const box = workflowBoxes.find(b => b.id === boxId);
    if (box) {
      box.guide = guide;
      // ë‹¤ë¥¸ í…ìŠ¤íŠ¸ì˜ì—­ë„ ë™ê¸°í™” (íŒ¨ë„ê³¼ ë°•ìŠ¤ ì–‘ìª½)
      const panelTextarea = document.getElementById(`guide-panel-${boxId}`);
      if (panelTextarea && panelTextarea.value !== guide) {
        panelTextarea.value = guide;
      }
    }
  };

  // ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ì‹¤í–‰
  window.executeWorkflowBox = async function(boxId) {
    const box = workflowBoxes.find(b => b.id === boxId);
    if (!box) return;

    // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
    showLoadingOverlay(`[${box.boxNumber}] ${box.name} ì²˜ë¦¬ ì¤‘`, 'AIê°€ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

    // ì…ë ¥ ë°ì´í„° ìˆ˜ì§‘
    let inputData = {};

    if (box.inputs.benchmarkScript) {
      inputData.benchmarkScript = document.getElementById('benchmark-script').value;
    }

    if (box.inputs.aiAnalysis) {
      inputData.aiAnalysis = document.getElementById('analysis-result').innerText;
    }

    // ë‹¤ë¥¸ ë°•ìŠ¤ì˜ ê²°ê³¼ ìˆ˜ì§‘
    for (const [key, value] of Object.entries(box.inputs)) {
      if (key.startsWith('box_') && value) {
        const boxNumber = parseInt(key.replace('box_', ''));
        const sourceBox = workflowBoxes.find(b => b.boxNumber === boxNumber);
        if (sourceBox && sourceBox.result) {
          inputData[`box${boxNumber}Result`] = sourceBox.result;
        }
      }
    }

    // ì£¼ì¸ê³µ ì •ë³´ ìˆ˜ì§‘
    const mainCharacter = document.getElementById('main-character')?.value.trim() || '';

    try {
      const response = await fetch('/api/drama/workflow-execute', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          boxId: box.id,
          boxName: box.name,
          boxNumber: box.boxNumber,
          guide: box.guide,
          inputs: inputData,
          category: currentCategory,
          mainCharacter: mainCharacter
        })
      });

      const data = await response.json();

      if (data.ok) {
        box.result = data.result;
        document.getElementById(`result-${box.id}`).value = data.result;
        saveWorkflowBoxes();
        showStatus('âœ… ì™„ë£Œ!');
        setTimeout(hideStatus, 2000);
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
    } finally {
      hideLoadingOverlay();
    }
  };

  // ë°•ìŠ¤ ê²°ê³¼ ë³µì‚¬
  window.copyBoxResult = function(boxId) {
    const textarea = document.getElementById(`result-${boxId}`);
    if (textarea && textarea.value) {
      textarea.select();
      document.execCommand('copy');
      showStatus('âœ… ë³µì‚¬ ì™„ë£Œ!');
      setTimeout(hideStatus, 1500);
    }
  };

  // ë°•ìŠ¤ ìˆœì„œ ì´ë™ (ìœ„ë¡œ)
  window.moveBoxUp = function(index) {
    if (index > 0) {
      [workflowBoxes[index], workflowBoxes[index - 1]] = [workflowBoxes[index - 1], workflowBoxes[index]];
      renderWorkflowBoxes();
      saveWorkflowBoxes();
    }
  };

  // ë°•ìŠ¤ ìˆœì„œ ì´ë™ (ì•„ë˜ë¡œ)
  window.moveBoxDown = function(index) {
    if (index < workflowBoxes.length - 1) {
      [workflowBoxes[index], workflowBoxes[index + 1]] = [workflowBoxes[index + 1], workflowBoxes[index]];
      renderWorkflowBoxes();
      saveWorkflowBoxes();
    }
  };

  // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
  let draggedBoxIndex = null;

  function setupDragAndDrop() {
    const container = document.getElementById('workflow-boxes-container');
    if (!container) return;

    container.addEventListener('dragstart', (e) => {
      if (e.target.classList.contains('workflow-box')) {
        draggedBoxIndex = parseInt(e.target.dataset.boxIndex);
        e.target.style.opacity = '0.4';
      }
    });

    container.addEventListener('dragend', (e) => {
      if (e.target.classList.contains('workflow-box')) {
        e.target.style.opacity = '1';
        draggedBoxIndex = null;
      }
    });

    container.addEventListener('dragover', (e) => {
      e.preventDefault();
      const targetBox = e.target.closest('.workflow-box');
      if (targetBox && draggedBoxIndex !== null) {
        const targetIndex = parseInt(targetBox.dataset.boxIndex);
        if (draggedBoxIndex !== targetIndex) {
          const rect = targetBox.getBoundingClientRect();
          const midpoint = rect.top + rect.height / 2;
          if (e.clientY < midpoint) {
            targetBox.style.borderTop = '3px solid #667eea';
            targetBox.style.borderBottom = '';
          } else {
            targetBox.style.borderTop = '';
            targetBox.style.borderBottom = '3px solid #667eea';
          }
        }
      }
    });

    container.addEventListener('dragleave', (e) => {
      const targetBox = e.target.closest('.workflow-box');
      if (targetBox) {
        targetBox.style.borderTop = '';
        targetBox.style.borderBottom = '';
      }
    });

    container.addEventListener('drop', (e) => {
      e.preventDefault();
      const targetBox = e.target.closest('.workflow-box');
      if (targetBox && draggedBoxIndex !== null) {
        const targetIndex = parseInt(targetBox.dataset.boxIndex);

        if (draggedBoxIndex !== targetIndex) {
          const draggedBox = workflowBoxes[draggedBoxIndex];
          workflowBoxes.splice(draggedBoxIndex, 1);

          const rect = targetBox.getBoundingClientRect();
          const midpoint = rect.top + rect.height / 2;
          const insertIndex = e.clientY < midpoint ? targetIndex : targetIndex + 1;
          const finalIndex = draggedBoxIndex < targetIndex ? insertIndex - 1 : insertIndex;

          workflowBoxes.splice(finalIndex, 0, draggedBox);
          renderWorkflowBoxes();
          saveWorkflowBoxes();
          setupDragAndDrop(); // ì¬ì„¤ì •
        }

        targetBox.style.borderTop = '';
        targetBox.style.borderBottom = '';
      }
    });
  }

  // ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ì €ì¥
  async function saveWorkflowBoxes() {
    localStorage.setItem('_drama-workflow-boxes', JSON.stringify(workflowBoxes));
    localStorage.setItem('_drama-next-box-id', nextBoxId.toString());
    localStorage.setItem('_drama-next-step1-num', nextStep1BoxNum.toString());
    localStorage.setItem('_drama-next-step2-num', nextStep2BoxNum.toString());
    await saveToFirebase('_drama-workflow-boxes', JSON.stringify(workflowBoxes));
    await saveToFirebase('_drama-next-box-id', nextBoxId.toString());
    await saveToFirebase('_drama-next-step1-num', nextStep1BoxNum.toString());
    await saveToFirebase('_drama-next-step2-num', nextStep2BoxNum.toString());
  }

  // ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸°
  function loadWorkflowBoxes() {
    const saved = localStorage.getItem('_drama-workflow-boxes');
    const savedNextId = localStorage.getItem('_drama-next-box-id');
    const savedStep1Num = localStorage.getItem('_drama-next-step1-num');
    const savedStep2Num = localStorage.getItem('_drama-next-step2-num');
    const savedStep1Collapsed = localStorage.getItem('_drama-step1-collapsed');
    const savedStep2Collapsed = localStorage.getItem('_drama-step2-collapsed');

    if (saved) {
      workflowBoxes = JSON.parse(saved);
    }
    if (savedNextId) {
      nextBoxId = parseInt(savedNextId);
    }
    if (savedStep1Num) {
      nextStep1BoxNum = parseInt(savedStep1Num);
    }
    if (savedStep2Num) {
      nextStep2BoxNum = parseInt(savedStep2Num);
    }
    // Reset collapsed state to false to ensure boxes are visible
    step1Collapsed = false;
    step2Collapsed = false;
    localStorage.removeItem('_drama-step1-collapsed');
    localStorage.removeItem('_drama-step2-collapsed');
  }

  // ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ì¶”ê°€ ë²„íŠ¼
  const btnAddStep1Box = document.getElementById('btn-add-step1-box');
  const btnAddStep2Box = document.getElementById('btn-add-step2-box');

  if (btnAddStep1Box) {
    btnAddStep1Box.addEventListener('click', () => addWorkflowBox('step1'));
  }
  if (btnAddStep2Box) {
    btnAddStep2Box.addEventListener('click', () => addWorkflowBox('step2'));
  }

  // Step1 ê²°ê³¼ ë³µì‚¬ ë²„íŠ¼
  const btnCopyStep1Results = document.getElementById('btn-copy-step1-results');
  if (btnCopyStep1Results) {
    btnCopyStep1Results.addEventListener('click', () => {
      const step1Boxes = workflowBoxes.filter(box => (box.stepType || 'step1') === 'step1');
      let allResults = '';

      step1Boxes.forEach(box => {
        if (box.result) {
          allResults += `\n\n${'='.repeat(50)}\n`;
          allResults += `[${box.boxNumber}] ${box.name}\n`;
          allResults += `${'='.repeat(50)}\n\n`;
          allResults += box.result;
        }
      });

      if (!allResults) {
        alert('ë³µì‚¬í•  Step1 ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const textarea = document.createElement('textarea');
      textarea.value = allResults.trim();
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);

      showStatus('âœ… Step1 ê²°ê³¼ ë³µì‚¬ ì™„ë£Œ!');
      setTimeout(hideStatus, 2000);
    });
  }

  // Step2 ê²°ê³¼ ë³µì‚¬ ë²„íŠ¼ (ì•ˆë‚´ ë¬¸êµ¬ í¬í•¨)
  const btnCopyStep2Results = document.getElementById('btn-copy-step2-results');
  if (btnCopyStep2Results) {
    btnCopyStep2Results.addEventListener('click', () => {
      const step2Boxes = workflowBoxes.filter(box => box.stepType === 'step2');
      let allResults = '';

      // ì•ˆë‚´ ë¬¸êµ¬ ì¶”ê°€
      allResults += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
      allResults += '                  ë“œë¼ë§ˆ ëŒ€ë³¸ ì‘ì„± ìë£Œ\n';
      allResults += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
      allResults += 'ì•„ë˜ëŠ” ìƒˆë¡œìš´ ë“œë¼ë§ˆ ëŒ€ë³¸ì„ ì‘ì„±í•˜ê¸° ìœ„í•´ ì¤€ë¹„ëœ ê¸°íš ìë£Œì…ë‹ˆë‹¤.\n';
      allResults += 'ê° ë‹¨ê³„ë³„ë¡œ ì •ë¦¬ëœ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬, ì™„ì„±ë„ ë†’ì€ ë“œë¼ë§ˆ ëŒ€ë³¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n';
      allResults += 'ì´ ìë£ŒëŠ” ìºë¦­í„° ì„¤ì •, ìŠ¤í† ë¦¬ êµ¬ì¡°, ì¥ë©´ êµ¬ì„± ë“± ë“œë¼ë§ˆ ì œì‘ì— í•„ìš”í•œ\n';
      allResults += 'í•µì‹¬ ìš”ì†Œë“¤ì„ í¬í•¨í•˜ê³  ìˆìŠµë‹ˆë‹¤. ê° ì„¹ì…˜ì˜ ë‚´ìš©ì„ í† ëŒ€ë¡œ ìì—°ìŠ¤ëŸ½ê³ \n';
      allResults += 'ìƒë™ê° ìˆëŠ” ëŒ€ë³¸ìœ¼ë¡œ ë°œì „ì‹œì¼œ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.\n\n';

      step2Boxes.forEach(box => {
        if (box.result) {
          allResults += `\n\n${'='.repeat(50)}\n`;
          allResults += `[${box.boxNumber}] ${box.name}\n`;
          allResults += `${'='.repeat(50)}\n\n`;
          allResults += box.result;
        }
      });

      if (!step2Boxes.some(box => box.result)) {
        alert('ë³µì‚¬í•  Step2 ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const textarea = document.createElement('textarea');
      textarea.value = allResults.trim();
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);

      showStatus('âœ… Step2 ê²°ê³¼ (ì•ˆë‚´ë¬¸êµ¬ í¬í•¨) ë³µì‚¬ ì™„ë£Œ!');
      setTimeout(hideStatus, 2000);
    });
  }

  // ìˆœì°¨ ì‹¤í–‰ í•¨ìˆ˜ (ê³µí†µ)
  async function autoExecuteBoxes(boxes, title) {
    if (boxes.length === 0) {
      alert(`ì‹¤í–‰í•  ${title} ë°•ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.`);
      return;
    }

    if (!confirm(`${boxes.length}ê°œì˜ ${title} ë°•ìŠ¤ë¥¼ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‹¤í–‰ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`)) {
      return;
    }

    showLoadingOverlay(`${title} ìˆœì°¨ ì‹¤í–‰ ì¤‘`, `${title} ${boxes.length}ê°œ ë°•ìŠ¤ ì‹¤í–‰ ì¤‘...`);

    for (let i = 0; i < boxes.length; i++) {
      const box = boxes[i];

      // ë¡œë”© ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
      const overlay = document.getElementById('loading-overlay');
      if (overlay) {
        const subtextEl = overlay.querySelector('.loading-subtext');
        if (subtextEl) {
          subtextEl.textContent = `[${i + 1}/${boxes.length}] ${box.name} ì‹¤í–‰ ì¤‘...`;
        }
      }

      // ë°•ìŠ¤ ì‹¤í–‰ (executeWorkflowBox í•¨ìˆ˜ ë‚´ìš©ì„ ì§ì ‘ ì‹¤í–‰)
      await executeWorkflowBoxDirect(box);

      // ì ì‹œ ëŒ€ê¸° (API ë¶€í•˜ ë°©ì§€)
      await new Promise(resolve => setTimeout(resolve, 500));
    }

    hideLoadingOverlay();
    showStatus(`âœ… ${title} ìˆœì°¨ ì‹¤í–‰ ì™„ë£Œ!`);
    setTimeout(hideStatus, 2000);
    renderWorkflowBoxes();
  }

  // ìˆœì°¨ ì‹¤í–‰ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  const btnAutoExecuteStep1 = document.getElementById('btn-auto-execute-step1');
  const btnAutoExecuteStep2 = document.getElementById('btn-auto-execute-step2');
  const btnAutoExecuteAll = document.getElementById('btn-auto-execute-all');

  if (btnAutoExecuteStep1) {
    btnAutoExecuteStep1.addEventListener('click', async () => {
      const step1Boxes = workflowBoxes.filter(box => (box.stepType || 'step1') === 'step1');
      await autoExecuteBoxes(step1Boxes, 'Step1');
    });
  }

  if (btnAutoExecuteStep2) {
    btnAutoExecuteStep2.addEventListener('click', async () => {
      const step2Boxes = workflowBoxes.filter(box => box.stepType === 'step2');
      await autoExecuteBoxes(step2Boxes, 'Step2');
    });
  }

  if (btnAutoExecuteAll) {
    btnAutoExecuteAll.addEventListener('click', async () => {
      await autoExecuteBoxes(workflowBoxes, 'ì „ì²´');
    });
  }

  // ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼
  const btnToggleStep1 = document.getElementById('btn-toggle-step1');
  const btnToggleStep2 = document.getElementById('btn-toggle-step2');

  if (btnToggleStep1) {
    btnToggleStep1.addEventListener('click', () => {
      step1Collapsed = !step1Collapsed;
      localStorage.setItem('_drama-step1-collapsed', step1Collapsed.toString());
      renderWorkflowBoxes();
    });
  }

  if (btnToggleStep2) {
    btnToggleStep2.addEventListener('click', () => {
      step2Collapsed = !step2Collapsed;
      localStorage.setItem('_drama-step2-collapsed', step2Collapsed.toString());
      renderWorkflowBoxes();
    });
  }

  // ìˆœì°¨ ì‹¤í–‰ìš© ì§ì ‘ ì‹¤í–‰ í•¨ìˆ˜
  async function executeWorkflowBoxDirect(box) {
    // ì…ë ¥ ë°ì´í„° ìˆ˜ì§‘
    let inputData = {};

    if (box.inputs.benchmarkScript) {
      inputData.benchmarkScript = document.getElementById('benchmark-script').value;
    }

    if (box.inputs.aiAnalysis) {
      inputData.aiAnalysis = document.getElementById('analysis-result').innerText;
    }

    // ë‹¤ë¥¸ ë°•ìŠ¤ì˜ ê²°ê³¼ ìˆ˜ì§‘
    for (const [key, value] of Object.entries(box.inputs)) {
      if (key.startsWith('box_') && value) {
        const boxNumber = parseInt(key.replace('box_', ''));
        const sourceBox = workflowBoxes.find(b => b.boxNumber === boxNumber);
        if (sourceBox && sourceBox.result) {
          inputData[`box${boxNumber}Result`] = sourceBox.result;
        }
      }
    }

    // ì£¼ì¸ê³µ ì •ë³´ ìˆ˜ì§‘
    const mainCharacter = document.getElementById('main-character')?.value.trim() || '';

    try {
      const response = await fetch('/api/drama/workflow-execute', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          boxId: box.id,
          boxName: box.name,
          boxNumber: box.boxNumber,
          guide: box.guide,
          inputs: inputData,
          category: currentCategory,
          mainCharacter: mainCharacter
        })
      });

      const data = await response.json();

      if (data.ok) {
        box.result = data.result;
        const resultEl = document.getElementById(`result-${box.id}`);
        if (resultEl) {
          resultEl.value = data.result;
        }
        await saveWorkflowBoxes();
      } else {
        console.error(`Box ${box.boxNumber} failed:`, data.error);
      }
    } catch (err) {
      console.error(`Box ${box.boxNumber} error:`, err.message);
    }
  }

  // ì§€ì¹¨ ê´€ë¦¬ íŒ¨ë„ í† ê¸€ ë²„íŠ¼
  const btnToggleGuidePanel = document.getElementById('btn-toggle-guide-panel');
  const btnSaveGuides = document.getElementById('btn-save-guides');
  const guidePanelContent = document.getElementById('guide-panel-content');

  if (btnToggleGuidePanel && guidePanelContent) {
    btnToggleGuidePanel.addEventListener('click', () => {
      if (guidePanelContent.style.display === 'none') {
        guidePanelContent.style.display = 'block';
        btnToggleGuidePanel.textContent = 'ë‹«ê¸°';
        if (btnSaveGuides) btnSaveGuides.style.display = 'block'; // ì €ì¥ ë²„íŠ¼ í‘œì‹œ
        renderGuideManagement(); // ì—´ ë•Œ ìµœì‹  ìƒíƒœë¡œ ë Œë”ë§
      } else {
        guidePanelContent.style.display = 'none';
        btnToggleGuidePanel.textContent = 'ì—´ê¸°';
        if (btnSaveGuides) btnSaveGuides.style.display = 'none'; // ì €ì¥ ë²„íŠ¼ ìˆ¨ê¹€
      }
    });
  }

  // ì§€ì¹¨ ì €ì¥ ë²„íŠ¼
  if (btnSaveGuides) {
    btnSaveGuides.addEventListener('click', async () => {
      showStatus('ğŸ’¾ ì§€ì¹¨ ì €ì¥ ì¤‘...');

      // ëª¨ë“  í…ìŠ¤íŠ¸ì˜ì—­ì˜ ê°’ì„ workflowBoxesì— ë™ê¸°í™”
      workflowBoxes.forEach(box => {
        const textarea = document.getElementById(`guide-panel-${box.id}`);
        if (textarea) {
          box.guide = textarea.value;
        }
      });

      // Firebaseì™€ localStorageì— ì €ì¥
      await saveWorkflowBoxes();

      showStatus('âœ… ì§€ì¹¨ ì €ì¥ ì™„ë£Œ!');
      setTimeout(hideStatus, 2000);
    });
  }

  // ì¶•ì ëœ ê°€ì´ë“œ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼
  const btnLoadAccumulatedGuide = document.getElementById('btn-load-accumulated-guide');
  const btnViewAccumulatedGuide = document.getElementById('btn-view-accumulated-guide');

  async function loadAccumulatedGuide() {
    const resultDiv = document.getElementById('accumulated-guide-result');

    // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
    showLoadingOverlay('ì¶•ì ëœ ê°€ì´ë“œ ìƒì„± ì¤‘', 'AIê°€ ê°€ì´ë“œë¥¼ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
    resultDiv.innerHTML = '<p style="color: #e74c3c; text-align: center;">ğŸ”„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

    try {
      const response = await fetch('/api/drama/get-accumulated-guide', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          category: currentCategory
        })
      });

      const data = await response.json();

      if (data.ok) {
        resultDiv.innerHTML = `
          <div style="white-space: pre-wrap; line-height: 1.8;">${data.guide}</div>
        `;
      } else {
        resultDiv.innerHTML = `<p style="color: #e74c3c;">âŒ ì˜¤ë¥˜: ${data.error}</p>`;
      }
    } catch (err) {
      resultDiv.innerHTML = `<p style="color: #e74c3c;">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}</p>`;
    } finally {
      hideLoadingOverlay();
    }
  }

  if (btnLoadAccumulatedGuide) {
    btnLoadAccumulatedGuide.addEventListener('click', loadAccumulatedGuide);
  }
  if (btnViewAccumulatedGuide) {
    btnViewAccumulatedGuide.addEventListener('click', loadAccumulatedGuide);
  }

  // ===== ì´ˆê¸°í™” =====
  document.addEventListener('DOMContentLoaded', async () => {
    const dateInput = document.getElementById('drama-date');
    if (dateInput) {
      dateInput.value = new Date().toISOString().split('T')[0];
    }

    showStatus('â˜ï¸ í´ë¼ìš°ë“œ ë™ê¸°í™” ì¤‘...');
    await loadFromFirebase();

    // â­ ì›Œí¬í”Œë¡œìš° ë°•ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸° ë° ë Œë”ë§
    loadWorkflowBoxes();
    renderWorkflowBoxes();

    hideStatus();

    renderCategories();
    loadMasterGuide(currentCategory);
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
    renderSavedList();

    document.querySelectorAll('textarea').forEach(autoResize);
  });
  </script>
</body>
</html>
