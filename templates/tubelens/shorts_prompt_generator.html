<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shorts Prompt Generator - TubeLens</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect fill='%23FF0000' width='32' height='32' rx='6'/><text x='16' y='22' font-size='16' fill='white' text-anchor='middle' font-weight='bold'>T</text></svg>">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      color: #333;
      min-height: 100vh;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 24px;
      background: #fff;
      border-bottom: 1px solid #e1e5eb;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-left h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #e53e3e;
    }

    .header-badge {
      font-size: 0.75rem;
      color: #666;
      background: #f0f0f0;
      padding: 4px 10px;
      border-radius: 20px;
    }

    .header-right {
      display: flex;
      gap: 10px;
    }

    .header-btn {
      padding: 8px 16px;
      background: #f5f7fa;
      color: #333;
      text-decoration: none;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .header-btn:hover { background: #e1e5eb; }
    .header-btn.home { background: #e53e3e; color: #fff; }
    .header-btn.home:hover { background: #c53030; }

    /* Main Container */
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Input Panel */
    .input-panel {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .input-panel h2 {
      font-size: 1.2rem;
      margin-bottom: 16px;
      color: #333;
    }

    .input-row {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .input-wrap {
      flex: 1;
      min-width: 300px;
    }

    .input-wrap label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: #666;
      margin-bottom: 6px;
    }

    .text-input {
      width: 100%;
      padding: 14px 20px;
      font-size: 1rem;
      border: 2px solid #e1e5eb;
      border-radius: 12px;
      transition: all 0.2s;
    }

    .text-input:focus {
      outline: none;
      border-color: #e53e3e;
      box-shadow: 0 0 0 4px rgba(229, 62, 62, 0.1);
    }

    .option-wrap {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .option-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .option-group label {
      font-size: 0.85rem;
      color: #666;
    }

    .option-select {
      padding: 10px 16px;
      font-size: 0.9rem;
      border: 2px solid #e1e5eb;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
    }

    .checkbox-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-wrap input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .btn-analyze {
      padding: 14px 32px;
      background: #e53e3e;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-analyze:hover { background: #c53030; }
    .btn-analyze:disabled { background: #ccc; cursor: not-allowed; }

    /* Progress */
    .progress-panel {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      display: none;
    }

    .progress-panel.active { display: block; }

    .progress-bar-wrap {
      background: #e1e5eb;
      border-radius: 10px;
      height: 20px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #e53e3e, #ff6b6b);
      border-radius: 10px;
      width: 0%;
      transition: width 0.3s;
    }

    .progress-text {
      font-size: 0.9rem;
      color: #666;
      text-align: center;
    }

    /* Results Panel */
    .results-panel {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      display: none;
    }

    .results-panel.active { display: block; }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e1e5eb;
    }

    .results-header h2 {
      font-size: 1.2rem;
      color: #333;
    }

    .results-meta {
      display: flex;
      gap: 16px;
      font-size: 0.85rem;
      color: #666;
    }

    .results-meta span {
      background: #f5f7fa;
      padding: 6px 12px;
      border-radius: 6px;
    }

    .btn-copy-all {
      padding: 10px 20px;
      background: #4a5568;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-copy-all:hover { background: #2d3748; }

    /* Prompt Cards */
    .prompt-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .prompt-card {
      background: #f8f9fa;
      border: 1px solid #e1e5eb;
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s;
    }

    .prompt-card:hover {
      border-color: #e53e3e;
      box-shadow: 0 4px 12px rgba(229, 62, 62, 0.1);
    }

    .prompt-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .prompt-time {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .time-badge {
      background: #e53e3e;
      color: #fff;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .time-label {
      color: #666;
      font-size: 0.85rem;
    }

    .btn-copy {
      padding: 6px 12px;
      background: #e1e5eb;
      color: #333;
      border: none;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-copy:hover { background: #cbd5e0; }
    .btn-copy.copied { background: #48bb78; color: #fff; }

    .prompt-text {
      font-size: 0.95rem;
      line-height: 1.6;
      color: #333;
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #e1e5eb;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Error */
    .error-panel {
      background: #fed7d7;
      border: 1px solid #fc8181;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      color: #c53030;
      display: none;
    }

    .error-panel.active { display: block; }

    /* Analysis Card */
    .analysis-card {
      background: #f8f9fa;
      border: 1px solid #e1e5eb;
      border-radius: 12px;
      padding: 16px;
    }

    .analysis-card h4 {
      font-size: 0.95rem;
      margin: 0;
    }

    .analysis-card p {
      font-size: 0.9rem;
      line-height: 1.6;
      color: #333;
      margin: 0;
    }

    /* Drop Zone */
    #drop-zone.dragover {
      border-color: #e53e3e;
      background: rgba(229, 62, 62, 0.05);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .input-row { flex-direction: column; }
      .input-wrap { min-width: 100%; }
      .option-wrap { flex-direction: column; align-items: flex-start; }
      .results-header { flex-direction: column; gap: 12px; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <h1>Shorts Prompt Generator</h1>
      <span class="header-badge">AI Powered</span>
    </div>
    <div class="header-right">
      <a href="/tubelens" class="header-btn">TubeLens</a>
      <a href="/" class="header-btn home">Home</a>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-container">
    <!-- Input Panel -->
    <section class="input-panel">
      <h2>ğŸ¬ Shorts ì˜ìƒ ì—…ë¡œë“œ</h2>
      <p style="color: #666; font-size: 0.9rem; margin-bottom: 16px;">
        YouTube Shorts ì˜ìƒ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ì”¬ë³„ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.<br>
        <span style="color: #e53e3e;">ğŸ’¡ íŒ: ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨ìœ¼ë¡œ Shortsë¥¼ ë‹¤ìš´ë¡œë“œí•œ í›„ ì—…ë¡œë“œí•˜ì„¸ìš”</span>
      </p>
      <div class="input-row">
        <div class="input-wrap" style="min-width: 100%;">
          <label for="video-upload">ì˜ìƒ íŒŒì¼ (MP4, WebM, MOV)</label>
          <div id="video-drop-zone" style="border: 2px dashed #e1e5eb; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s;">
            <input type="file" id="video-upload" accept="video/mp4,video/webm,video/quicktime,video/*" style="display: none;">
            <div id="video-drop-text">
              <span style="font-size: 2rem;">ğŸ¥</span>
              <p style="margin: 10px 0 0; color: #666;">í´ë¦­í•˜ê±°ë‚˜ ì˜ìƒ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
              <p style="margin: 5px 0 0; color: #999; font-size: 0.8rem;">ìµœëŒ€ 100MB</p>
            </div>
            <div id="video-preview-container" style="display: none;">
              <video id="preview-video" style="max-width: 100%; max-height: 300px; border-radius: 8px;" controls></video>
              <p id="video-file-name" style="margin-top: 10px; color: #333; font-weight: 500;"></p>
              <button id="btn-change-video" type="button" style="margin-top: 8px; padding: 6px 12px; background: #e1e5eb; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">ë‹¤ë¥¸ íŒŒì¼ ì„ íƒ</button>
            </div>
          </div>
        </div>
      </div>
      <div class="input-row">
        <div class="option-wrap">
          <div class="option-group">
            <label for="mode">ë¶„ì„ ëª¨ë“œ</label>
            <select id="mode" class="option-select">
              <option value="scene" selected>ì”¬ ê¸°ë°˜ (ê¶Œì¥)</option>
              <option value="interval">ì‹œê°„ ê¸°ë°˜</option>
            </select>
          </div>
          <div class="option-group" id="interval-group" style="display: none;">
            <label for="interval">í”„ë ˆì„ ê°„ê²©</label>
            <select id="interval" class="option-select">
              <option value="2">2ì´ˆ</option>
              <option value="3">3ì´ˆ</option>
              <option value="5" selected>5ì´ˆ</option>
              <option value="10">10ì´ˆ</option>
            </select>
          </div>
          <div class="option-group" id="threshold-group">
            <label for="threshold">ì”¬ ê°ì§€ ë¯¼ê°ë„</label>
            <select id="threshold" class="option-select">
              <option value="0.2">ë†’ìŒ (0.2)</option>
              <option value="0.3" selected>ë³´í†µ (0.3)</option>
              <option value="0.4">ë‚®ìŒ (0.4)</option>
            </select>
          </div>
          <div class="checkbox-wrap">
            <input type="checkbox" id="refine">
            <label for="refine">GPTë¡œ í”„ë¡¬í”„íŠ¸ ì •ì œ (ì„ íƒ)</label>
          </div>
          <button id="btn-analyze" class="btn-analyze" disabled>ë¶„ì„ ì‹œì‘</button>
        </div>
      </div>
    </section>

    <!-- Image Upload Panel -->
    <section class="input-panel" style="margin-top: 20px;">
      <h2>ì´ë¯¸ì§€ â†’ í”„ë¡¬í”„íŠ¸ ë¶„ì„</h2>
      <p style="color: #666; font-size: 0.9rem; margin-bottom: 16px;">
        ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ ì¡°ëª…, ì¹´ë©”ë¼ ì•µê¸€, ìƒ‰ê° ë“±ì„ ì„¸ë°€í•˜ê²Œ ë¶„ì„í•˜ì—¬ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
      </p>
      <div class="input-row">
        <div class="input-wrap" style="min-width: 100%;">
          <label for="image-upload">ì´ë¯¸ì§€ íŒŒì¼</label>
          <div id="drop-zone" style="border: 2px dashed #e1e5eb; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s;">
            <input type="file" id="image-upload" accept="image/*" style="display: none;">
            <div id="drop-text">
              <span style="font-size: 2rem;">ğŸ“·</span>
              <p style="margin: 10px 0 0; color: #666;">í´ë¦­í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
            </div>
            <img id="preview-image" style="max-width: 100%; max-height: 300px; display: none; border-radius: 8px;">
          </div>
        </div>
      </div>
      <div class="input-row" style="margin-top: 16px;">
        <button id="btn-analyze-image" class="btn-analyze" disabled>ì´ë¯¸ì§€ ë¶„ì„</button>
      </div>
    </section>

    <!-- Image Analysis Result -->
    <section id="image-result-panel" class="results-panel" style="margin-top: 20px;">
      <div class="results-header">
        <h2>ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼</h2>
        <button id="btn-copy-image-prompt" class="btn-copy-all">í”„ë¡¬í”„íŠ¸ ë³µì‚¬</button>
      </div>

      <!-- Analysis Grid -->
      <div id="analysis-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 20px;">
        <div class="analysis-card" data-field="subject">
          <h4 style="color: #e53e3e; margin-bottom: 8px;">ğŸ“¸ í”¼ì‚¬ì²´</h4>
          <p id="analysis-subject">-</p>
        </div>
        <div class="analysis-card" data-field="background">
          <h4 style="color: #e53e3e; margin-bottom: 8px;">ğŸï¸ ë°°ê²½</h4>
          <p id="analysis-background">-</p>
        </div>
        <div class="analysis-card" data-field="lighting">
          <h4 style="color: #e53e3e; margin-bottom: 8px;">ğŸ’¡ ì¡°ëª…</h4>
          <p id="analysis-lighting">-</p>
        </div>
        <div class="analysis-card" data-field="camera">
          <h4 style="color: #e53e3e; margin-bottom: 8px;">ğŸ¥ ì¹´ë©”ë¼/êµ¬ë„</h4>
          <p id="analysis-camera">-</p>
        </div>
        <div class="analysis-card" data-field="color">
          <h4 style="color: #e53e3e; margin-bottom: 8px;">ğŸ¨ ìƒ‰ê°</h4>
          <p id="analysis-color">-</p>
        </div>
        <div class="analysis-card" data-field="mood">
          <h4 style="color: #e53e3e; margin-bottom: 8px;">âœ¨ ë¶„ìœ„ê¸°</h4>
          <p id="analysis-mood">-</p>
        </div>
        <div class="analysis-card" data-field="style" style="grid-column: 1 / -1;">
          <h4 style="color: #e53e3e; margin-bottom: 8px;">ğŸ¬ ìŠ¤íƒ€ì¼</h4>
          <p id="analysis-style">-</p>
        </div>
      </div>

      <!-- Generated Prompts -->
      <div style="margin-top: 20px;">
        <h3 style="margin-bottom: 12px;">ìƒì„±ëœ í”„ë¡¬í”„íŠ¸</h3>
        <div class="prompt-card" style="margin-bottom: 12px;">
          <div class="prompt-header">
            <span class="time-badge" style="background: #4a5568;">English</span>
            <button class="btn-copy" id="btn-copy-en">ë³µì‚¬</button>
          </div>
          <div class="prompt-text" id="prompt-en">-</div>
        </div>
        <div class="prompt-card">
          <div class="prompt-header">
            <span class="time-badge" style="background: #2d3748;">í•œêµ­ì–´</span>
            <button class="btn-copy" id="btn-copy-ko">ë³µì‚¬</button>
          </div>
          <div class="prompt-text" id="prompt-ko">-</div>
        </div>
      </div>
    </section>

    <!-- Error Panel -->
    <div id="error-panel" class="error-panel"></div>

    <!-- Progress Panel -->
    <section id="progress-panel" class="progress-panel">
      <div class="progress-bar-wrap">
        <div id="progress-bar" class="progress-bar"></div>
      </div>
      <div id="progress-text" class="progress-text">ì˜ìƒ ë‹¤ìš´ë¡œë“œ ì¤‘...</div>
    </section>

    <!-- Results Panel -->
    <section id="results-panel" class="results-panel">
      <div class="results-header">
        <div>
          <h2>ë¶„ì„ ê²°ê³¼</h2>
          <div class="results-meta">
            <span id="video-duration">ì˜ìƒ ê¸¸ì´: -</span>
            <span id="frame-count">í”„ë ˆì„: -</span>
          </div>
        </div>
        <button id="btn-copy-all" class="btn-copy-all">ì „ì²´ ë³µì‚¬</button>
      </div>
      <div id="prompt-list" class="prompt-list"></div>
    </section>
  </main>

  <script>
    // ë¹„ë””ì˜¤ ì—…ë¡œë“œ ê´€ë ¨ ìš”ì†Œ
    const videoDropZone = document.getElementById('video-drop-zone');
    const videoUpload = document.getElementById('video-upload');
    const videoDropText = document.getElementById('video-drop-text');
    const videoPreviewContainer = document.getElementById('video-preview-container');
    const previewVideo = document.getElementById('preview-video');
    const videoFileName = document.getElementById('video-file-name');
    const btnChangeVideo = document.getElementById('btn-change-video');

    const modeSelect = document.getElementById('mode');
    const intervalSelect = document.getElementById('interval');
    const intervalGroup = document.getElementById('interval-group');
    const thresholdSelect = document.getElementById('threshold');
    const thresholdGroup = document.getElementById('threshold-group');
    const refineCheckbox = document.getElementById('refine');
    const btnAnalyze = document.getElementById('btn-analyze');
    const errorPanel = document.getElementById('error-panel');
    const progressPanel = document.getElementById('progress-panel');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const resultsPanel = document.getElementById('results-panel');
    const promptList = document.getElementById('prompt-list');
    const videoDuration = document.getElementById('video-duration');
    const frameCount = document.getElementById('frame-count');
    const btnCopyAll = document.getElementById('btn-copy-all');

    let analysisResults = null;
    let selectedVideoFile = null;

    // ë¹„ë””ì˜¤ ë“œë˜ê·¸ ì•¤ ë“œë¡­
    videoDropZone.addEventListener('click', (e) => {
      if (e.target !== btnChangeVideo) {
        videoUpload.click();
      }
    });

    videoDropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      videoDropZone.classList.add('dragover');
    });

    videoDropZone.addEventListener('dragleave', () => {
      videoDropZone.classList.remove('dragover');
    });

    videoDropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      videoDropZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].type.startsWith('video/')) {
        handleVideoSelect(files[0]);
      } else {
        showError('ë¹„ë””ì˜¤ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
      }
    });

    videoUpload.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleVideoSelect(e.target.files[0]);
      }
    });

    btnChangeVideo.addEventListener('click', (e) => {
      e.stopPropagation();
      videoUpload.click();
    });

    function handleVideoSelect(file) {
      // íŒŒì¼ í¬ê¸° ì²´í¬ (100MB)
      if (file.size > 100 * 1024 * 1024) {
        showError('íŒŒì¼ í¬ê¸°ëŠ” 100MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤');
        return;
      }

      selectedVideoFile = file;
      const videoURL = URL.createObjectURL(file);
      previewVideo.src = videoURL;
      videoFileName.textContent = file.name + ' (' + (file.size / 1024 / 1024).toFixed(1) + 'MB)';
      videoDropText.style.display = 'none';
      videoPreviewContainer.style.display = 'block';
      btnAnalyze.disabled = false;
      hideError();
    }

    // ëª¨ë“œ ë³€ê²½ ì‹œ ì˜µì…˜ í† ê¸€
    modeSelect.addEventListener('change', () => {
      if (modeSelect.value === 'interval') {
        intervalGroup.style.display = 'flex';
        thresholdGroup.style.display = 'none';
      } else {
        intervalGroup.style.display = 'none';
        thresholdGroup.style.display = 'flex';
      }
    });

    // ë¶„ì„ ì‹œì‘ (íŒŒì¼ ì—…ë¡œë“œ ë°©ì‹)
    btnAnalyze.addEventListener('click', async () => {
      if (!selectedVideoFile) {
        showError('ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
        return;
      }

      // Reset UI
      hideError();
      resultsPanel.classList.remove('active');
      progressPanel.classList.add('active');
      btnAnalyze.disabled = true;

      // Simulate progress
      let progress = 0;
      const mode = modeSelect.value;
      const progressSteps = [
        { percent: 10, text: 'ì˜ìƒ ì—…ë¡œë“œ ì¤‘...' },
        { percent: 30, text: mode === 'scene' ? 'ì”¬ ë³€í™” ê°ì§€ ì¤‘...' : 'í”„ë ˆì„ ì¶”ì¶œ ì¤‘...' },
        { percent: 50, text: 'AI ë¶„ì„ ì¤‘...' },
        { percent: 80, text: 'í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...' }
      ];

      let stepIndex = 0;
      const progressInterval = setInterval(() => {
        if (stepIndex < progressSteps.length) {
          progress = progressSteps[stepIndex].percent;
          progressBar.style.width = progress + '%';
          progressText.textContent = progressSteps[stepIndex].text;
          stepIndex++;
        }
      }, 2000);

      try {
        const formData = new FormData();
        formData.append('video', selectedVideoFile);
        formData.append('mode', modeSelect.value);
        formData.append('interval', intervalSelect.value);
        formData.append('threshold', thresholdSelect.value);
        formData.append('refine', refineCheckbox.checked);

        const response = await fetch('/api/tubelens/video-to-prompts', {
          method: 'POST',
          body: formData
        });

        clearInterval(progressInterval);

        const data = await response.json();

        if (data.success) {
          analysisResults = data;
          progressBar.style.width = '100%';
          progressText.textContent = 'ì™„ë£Œ!';

          setTimeout(() => {
            progressPanel.classList.remove('active');
            displayResults(data);
          }, 500);
        } else {
          progressPanel.classList.remove('active');
          showError(data.message || 'ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
      } catch (error) {
        clearInterval(progressInterval);
        progressPanel.classList.remove('active');
        showError('ì„œë²„ ì˜¤ë¥˜: ' + error.message);
      } finally {
        btnAnalyze.disabled = false;
      }
    });

    // ê²°ê³¼ í‘œì‹œ
    function displayResults(data) {
      videoDuration.textContent = `ì˜ìƒ ê¸¸ì´: ${data.duration}ì´ˆ`;
      frameCount.textContent = `í”„ë ˆì„: ${data.frameCount}ê°œ`;

      promptList.innerHTML = '';
      data.prompts.forEach((prompt, index) => {
        const card = document.createElement('div');
        card.className = 'prompt-card';
        card.innerHTML = `
          <div class="prompt-header">
            <div class="prompt-time">
              <span class="time-badge">${prompt.time}ì´ˆ</span>
              <span class="time-label">Scene ${index + 1}</span>
            </div>
            <button class="btn-copy" data-prompt="${encodeURIComponent(prompt.prompt)}">ë³µì‚¬</button>
          </div>
          <div class="prompt-text">${escapeHtml(prompt.prompt)}</div>
        `;
        promptList.appendChild(card);
      });

      // ë³µì‚¬ ë²„íŠ¼ ì´ë²¤íŠ¸
      document.querySelectorAll('.btn-copy').forEach(btn => {
        btn.addEventListener('click', () => {
          const promptText = decodeURIComponent(btn.dataset.prompt);
          navigator.clipboard.writeText(promptText).then(() => {
            btn.textContent = 'ë³µì‚¬ë¨!';
            btn.classList.add('copied');
            setTimeout(() => {
              btn.textContent = 'ë³µì‚¬';
              btn.classList.remove('copied');
            }, 2000);
          });
        });
      });

      resultsPanel.classList.add('active');
    }

    // ì „ì²´ ë³µì‚¬
    btnCopyAll.addEventListener('click', () => {
      if (!analysisResults) return;

      const allPrompts = analysisResults.prompts.map((p, i) =>
        `[${p.time}ì´ˆ] Scene ${i + 1}:\n${p.prompt}`
      ).join('\n\n---\n\n');

      navigator.clipboard.writeText(allPrompts).then(() => {
        btnCopyAll.textContent = 'ë³µì‚¬ ì™„ë£Œ!';
        setTimeout(() => {
          btnCopyAll.textContent = 'ì „ì²´ ë³µì‚¬';
        }, 2000);
      });
    });

    // ì—ëŸ¬ í‘œì‹œ
    function showError(message) {
      errorPanel.textContent = message;
      errorPanel.classList.add('active');
    }

    function hideError() {
      errorPanel.classList.remove('active');
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========== ì´ë¯¸ì§€ â†’ í”„ë¡¬í”„íŠ¸ ë¶„ì„ ==========
    const dropZone = document.getElementById('drop-zone');
    const imageUpload = document.getElementById('image-upload');
    const previewImage = document.getElementById('preview-image');
    const dropText = document.getElementById('drop-text');
    const btnAnalyzeImage = document.getElementById('btn-analyze-image');
    const imageResultPanel = document.getElementById('image-result-panel');

    let selectedFile = null;

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­
    dropZone.addEventListener('click', () => imageUpload.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].type.startsWith('image/')) {
        handleImageSelect(files[0]);
      }
    });

    imageUpload.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleImageSelect(e.target.files[0]);
      }
    });

    function handleImageSelect(file) {
      selectedFile = file;
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        previewImage.style.display = 'block';
        dropText.style.display = 'none';
        btnAnalyzeImage.disabled = false;
      };
      reader.readAsDataURL(file);
    }

    // ì´ë¯¸ì§€ ë¶„ì„
    btnAnalyzeImage.addEventListener('click', async () => {
      if (!selectedFile) {
        showError('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
        return;
      }

      hideError();
      btnAnalyzeImage.disabled = true;
      btnAnalyzeImage.textContent = 'ë¶„ì„ ì¤‘...';
      imageResultPanel.classList.remove('active');

      try {
        const formData = new FormData();
        formData.append('image', selectedFile);

        const response = await fetch('/api/tubelens/image-to-prompt', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          displayImageAnalysis(data);
        } else {
          showError(data.message || 'ì´ë¯¸ì§€ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
      } catch (error) {
        showError('ì„œë²„ ì˜¤ë¥˜: ' + error.message);
      } finally {
        btnAnalyzeImage.disabled = false;
        btnAnalyzeImage.textContent = 'ì´ë¯¸ì§€ ë¶„ì„';
      }
    });

    function displayImageAnalysis(data) {
      // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
      if (data.analysis) {
        document.getElementById('analysis-subject').textContent = data.analysis.subject || '-';
        document.getElementById('analysis-background').textContent = data.analysis.background || '-';
        document.getElementById('analysis-lighting').textContent = data.analysis.lighting || '-';
        document.getElementById('analysis-camera').textContent = data.analysis.camera || '-';
        document.getElementById('analysis-color').textContent = data.analysis.color || '-';
        document.getElementById('analysis-mood').textContent = data.analysis.mood || '-';
        document.getElementById('analysis-style').textContent = data.analysis.style || '-';
      }

      // í”„ë¡¬í”„íŠ¸ í‘œì‹œ
      document.getElementById('prompt-en').textContent = data.prompt || '-';
      document.getElementById('prompt-ko').textContent = data.prompt_ko || '-';

      imageResultPanel.classList.add('active');

      // ë³µì‚¬ ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById('btn-copy-en').onclick = () => {
        copyToClipboard(data.prompt, document.getElementById('btn-copy-en'));
      };
      document.getElementById('btn-copy-ko').onclick = () => {
        copyToClipboard(data.prompt_ko, document.getElementById('btn-copy-ko'));
      };
      document.getElementById('btn-copy-image-prompt').onclick = () => {
        const fullText = `[English]\n${data.prompt}\n\n[í•œêµ­ì–´]\n${data.prompt_ko}`;
        copyToClipboard(fullText, document.getElementById('btn-copy-image-prompt'));
      };
    }

    function copyToClipboard(text, btn) {
      navigator.clipboard.writeText(text).then(() => {
        const originalText = btn.textContent;
        btn.textContent = 'ë³µì‚¬ë¨!';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = originalText;
          btn.classList.remove('copied');
        }, 2000);
      });
    }
  </script>
</body>
</html>
