<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shorts Prompt Generator - TubeLens</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect fill='%23FF0000' width='32' height='32' rx='6'/><text x='16' y='22' font-size='16' fill='white' text-anchor='middle' font-weight='bold'>T</text></svg>">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      color: #333;
      min-height: 100vh;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 24px;
      background: #fff;
      border-bottom: 1px solid #e1e5eb;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-left h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #e53e3e;
    }

    .header-badge {
      font-size: 0.75rem;
      color: #666;
      background: #f0f0f0;
      padding: 4px 10px;
      border-radius: 20px;
    }

    .header-right {
      display: flex;
      gap: 10px;
    }

    .header-btn {
      padding: 8px 16px;
      background: #f5f7fa;
      color: #333;
      text-decoration: none;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .header-btn:hover { background: #e1e5eb; }
    .header-btn.home { background: #e53e3e; color: #fff; }
    .header-btn.home:hover { background: #c53030; }

    /* Main Container */
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Input Panel */
    .input-panel {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .input-panel h2 {
      font-size: 1.2rem;
      margin-bottom: 16px;
      color: #333;
    }

    .input-row {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .input-wrap {
      flex: 1;
      min-width: 300px;
    }

    .input-wrap label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: #666;
      margin-bottom: 6px;
    }

    .text-input {
      width: 100%;
      padding: 14px 20px;
      font-size: 1rem;
      border: 2px solid #e1e5eb;
      border-radius: 12px;
      transition: all 0.2s;
    }

    .text-input:focus {
      outline: none;
      border-color: #e53e3e;
      box-shadow: 0 0 0 4px rgba(229, 62, 62, 0.1);
    }

    .option-wrap {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .option-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .option-group label {
      font-size: 0.85rem;
      color: #666;
    }

    .option-select {
      padding: 10px 16px;
      font-size: 0.9rem;
      border: 2px solid #e1e5eb;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
    }

    .checkbox-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-wrap input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .btn-analyze {
      padding: 14px 32px;
      background: #e53e3e;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-analyze:hover { background: #c53030; }
    .btn-analyze:disabled { background: #ccc; cursor: not-allowed; }

    /* Progress */
    .progress-panel {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      display: none;
    }

    .progress-panel.active { display: block; }

    .progress-bar-wrap {
      background: #e1e5eb;
      border-radius: 10px;
      height: 20px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #e53e3e, #ff6b6b);
      border-radius: 10px;
      width: 0%;
      transition: width 0.3s;
    }

    .progress-text {
      font-size: 0.9rem;
      color: #666;
      text-align: center;
    }

    /* Results Panel */
    .results-panel {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      display: none;
    }

    .results-panel.active { display: block; }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e1e5eb;
    }

    .results-header h2 {
      font-size: 1.2rem;
      color: #333;
    }

    .results-meta {
      display: flex;
      gap: 16px;
      font-size: 0.85rem;
      color: #666;
    }

    .results-meta span {
      background: #f5f7fa;
      padding: 6px 12px;
      border-radius: 6px;
    }

    .btn-copy-all {
      padding: 10px 20px;
      background: #4a5568;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-copy-all:hover { background: #2d3748; }

    /* Prompt Cards */
    .prompt-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .prompt-card {
      background: #f8f9fa;
      border: 1px solid #e1e5eb;
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s;
    }

    .prompt-card:hover {
      border-color: #e53e3e;
      box-shadow: 0 4px 12px rgba(229, 62, 62, 0.1);
    }

    .prompt-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .prompt-time {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .time-badge {
      background: #e53e3e;
      color: #fff;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .time-label {
      color: #666;
      font-size: 0.85rem;
    }

    .btn-copy {
      padding: 6px 12px;
      background: #e1e5eb;
      color: #333;
      border: none;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-copy:hover { background: #cbd5e0; }
    .btn-copy.copied { background: #48bb78; color: #fff; }

    .prompt-text {
      font-size: 0.95rem;
      line-height: 1.6;
      color: #333;
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #e1e5eb;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Error */
    .error-panel {
      background: #fed7d7;
      border: 1px solid #fc8181;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      color: #c53030;
      display: none;
    }

    .error-panel.active { display: block; }

    /* Responsive */
    @media (max-width: 768px) {
      .input-row { flex-direction: column; }
      .input-wrap { min-width: 100%; }
      .option-wrap { flex-direction: column; align-items: flex-start; }
      .results-header { flex-direction: column; gap: 12px; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <h1>Shorts Prompt Generator</h1>
      <span class="header-badge">AI Powered</span>
    </div>
    <div class="header-right">
      <a href="/tubelens" class="header-btn">TubeLens</a>
      <a href="/" class="header-btn home">Home</a>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-container">
    <!-- Input Panel -->
    <section class="input-panel">
      <h2>YouTube Shorts URL 입력</h2>
      <div class="input-row">
        <div class="input-wrap">
          <label for="shorts-url">Shorts URL</label>
          <input type="text" id="shorts-url" class="text-input"
                 placeholder="https://youtube.com/shorts/xxxxxxx 또는 영상 ID">
        </div>
      </div>
      <div class="input-row">
        <div class="option-wrap">
          <div class="option-group">
            <label for="mode">분석 모드</label>
            <select id="mode" class="option-select">
              <option value="scene" selected>씬 기반 (권장)</option>
              <option value="interval">시간 기반</option>
            </select>
          </div>
          <div class="option-group" id="interval-group" style="display: none;">
            <label for="interval">프레임 간격</label>
            <select id="interval" class="option-select">
              <option value="2">2초</option>
              <option value="3">3초</option>
              <option value="5" selected>5초</option>
              <option value="10">10초</option>
            </select>
          </div>
          <div class="option-group" id="threshold-group">
            <label for="threshold">씬 감지 민감도</label>
            <select id="threshold" class="option-select">
              <option value="0.2">높음 (0.2)</option>
              <option value="0.3" selected>보통 (0.3)</option>
              <option value="0.4">낮음 (0.4)</option>
            </select>
          </div>
          <div class="checkbox-wrap">
            <input type="checkbox" id="refine">
            <label for="refine">GPT로 프롬프트 정제 (선택)</label>
          </div>
          <button id="btn-analyze" class="btn-analyze">분석 시작</button>
        </div>
      </div>
    </section>

    <!-- Error Panel -->
    <div id="error-panel" class="error-panel"></div>

    <!-- Progress Panel -->
    <section id="progress-panel" class="progress-panel">
      <div class="progress-bar-wrap">
        <div id="progress-bar" class="progress-bar"></div>
      </div>
      <div id="progress-text" class="progress-text">영상 다운로드 중...</div>
    </section>

    <!-- Results Panel -->
    <section id="results-panel" class="results-panel">
      <div class="results-header">
        <div>
          <h2>분석 결과</h2>
          <div class="results-meta">
            <span id="video-duration">영상 길이: -</span>
            <span id="frame-count">프레임: -</span>
          </div>
        </div>
        <button id="btn-copy-all" class="btn-copy-all">전체 복사</button>
      </div>
      <div id="prompt-list" class="prompt-list"></div>
    </section>
  </main>

  <script>
    const shortsUrlInput = document.getElementById('shorts-url');
    const modeSelect = document.getElementById('mode');
    const intervalSelect = document.getElementById('interval');
    const intervalGroup = document.getElementById('interval-group');
    const thresholdSelect = document.getElementById('threshold');
    const thresholdGroup = document.getElementById('threshold-group');
    const refineCheckbox = document.getElementById('refine');
    const btnAnalyze = document.getElementById('btn-analyze');
    const errorPanel = document.getElementById('error-panel');
    const progressPanel = document.getElementById('progress-panel');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const resultsPanel = document.getElementById('results-panel');
    const promptList = document.getElementById('prompt-list');
    const videoDuration = document.getElementById('video-duration');
    const frameCount = document.getElementById('frame-count');
    const btnCopyAll = document.getElementById('btn-copy-all');

    let analysisResults = null;

    // 모드 변경 시 옵션 토글
    modeSelect.addEventListener('change', () => {
      if (modeSelect.value === 'interval') {
        intervalGroup.style.display = 'flex';
        thresholdGroup.style.display = 'none';
      } else {
        intervalGroup.style.display = 'none';
        thresholdGroup.style.display = 'flex';
      }
    });

    // 분석 시작
    btnAnalyze.addEventListener('click', async () => {
      const url = shortsUrlInput.value.trim();
      if (!url) {
        showError('Shorts URL을 입력해주세요');
        return;
      }

      // Reset UI
      hideError();
      resultsPanel.classList.remove('active');
      progressPanel.classList.add('active');
      btnAnalyze.disabled = true;

      // Simulate progress
      let progress = 0;
      const mode = modeSelect.value;
      const progressSteps = [
        { percent: 10, text: '영상 다운로드 중...' },
        { percent: 30, text: mode === 'scene' ? '씬 변화 감지 중...' : '프레임 추출 중...' },
        { percent: 50, text: 'AI 분석 중...' },
        { percent: 80, text: '프롬프트 생성 중...' }
      ];

      let stepIndex = 0;
      const progressInterval = setInterval(() => {
        if (stepIndex < progressSteps.length) {
          progress = progressSteps[stepIndex].percent;
          progressBar.style.width = progress + '%';
          progressText.textContent = progressSteps[stepIndex].text;
          stepIndex++;
        }
      }, 2000);

      try {
        const response = await fetch('/api/tubelens/shorts-to-prompts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            url: url,
            mode: mode,
            interval: parseInt(intervalSelect.value),
            threshold: parseFloat(thresholdSelect.value),
            refine: refineCheckbox.checked
          })
        });

        clearInterval(progressInterval);

        const data = await response.json();

        if (data.success) {
          analysisResults = data;
          progressBar.style.width = '100%';
          progressText.textContent = '완료!';

          setTimeout(() => {
            progressPanel.classList.remove('active');
            displayResults(data);
          }, 500);
        } else {
          progressPanel.classList.remove('active');
          showError(data.message || '분석에 실패했습니다');
        }
      } catch (error) {
        clearInterval(progressInterval);
        progressPanel.classList.remove('active');
        showError('서버 오류: ' + error.message);
      } finally {
        btnAnalyze.disabled = false;
      }
    });

    // 결과 표시
    function displayResults(data) {
      videoDuration.textContent = `영상 길이: ${data.duration}초`;
      frameCount.textContent = `프레임: ${data.frameCount}개`;

      promptList.innerHTML = '';
      data.prompts.forEach((prompt, index) => {
        const card = document.createElement('div');
        card.className = 'prompt-card';
        card.innerHTML = `
          <div class="prompt-header">
            <div class="prompt-time">
              <span class="time-badge">${prompt.time}초</span>
              <span class="time-label">Scene ${index + 1}</span>
            </div>
            <button class="btn-copy" data-prompt="${encodeURIComponent(prompt.prompt)}">복사</button>
          </div>
          <div class="prompt-text">${escapeHtml(prompt.prompt)}</div>
        `;
        promptList.appendChild(card);
      });

      // 복사 버튼 이벤트
      document.querySelectorAll('.btn-copy').forEach(btn => {
        btn.addEventListener('click', () => {
          const promptText = decodeURIComponent(btn.dataset.prompt);
          navigator.clipboard.writeText(promptText).then(() => {
            btn.textContent = '복사됨!';
            btn.classList.add('copied');
            setTimeout(() => {
              btn.textContent = '복사';
              btn.classList.remove('copied');
            }, 2000);
          });
        });
      });

      resultsPanel.classList.add('active');
    }

    // 전체 복사
    btnCopyAll.addEventListener('click', () => {
      if (!analysisResults) return;

      const allPrompts = analysisResults.prompts.map((p, i) =>
        `[${p.time}초] Scene ${i + 1}:\n${p.prompt}`
      ).join('\n\n---\n\n');

      navigator.clipboard.writeText(allPrompts).then(() => {
        btnCopyAll.textContent = '복사 완료!';
        setTimeout(() => {
          btnCopyAll.textContent = '전체 복사';
        }, 2000);
      });
    });

    // 에러 표시
    function showError(message) {
      errorPanel.textContent = message;
      errorPanel.classList.add('active');
    }

    function hideError() {
      errorPanel.classList.remove('active');
    }

    // HTML 이스케이프
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Enter 키로 분석 시작
    shortsUrlInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        btnAnalyze.click();
      }
    });
  </script>
</body>
</html>
