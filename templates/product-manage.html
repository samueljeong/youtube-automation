<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>ìƒí’ˆê´€ë¦¬ - Creator Lab</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect fill='%23667eea' width='32' height='32' rx='6'/><text x='16' y='22' font-size='18' fill='white' text-anchor='middle' font-weight='bold'>P</text></svg>">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/drama.css') }}?v=20241202">
  <style>
    /* ìƒí’ˆê´€ë¦¬ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
    .margin-tool-container {
      padding: 20px;
    }
    .margin-tool-container section {
      background: #fff;
      border-radius: 12px;
      padding: 16px 18px;
      margin-bottom: 16px;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.05);
    }
    .margin-tool-container section h2 {
      margin: 0 0 8px;
      font-size: 16px;
      color: #111827;
    }
    .margin-tool-container section small {
      color: #6b7280;
      font-size: 12px;
    }
    .margin-tool-container .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px 14px;
      margin-top: 8px;
    }
    .margin-tool-container label {
      font-size: 12px;
      color: #374151;
      display: block;
      margin-bottom: 3px;
    }
    .margin-tool-container input,
    .margin-tool-container select,
    .margin-tool-container textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }
    .margin-tool-container input:focus,
    .margin-tool-container select:focus,
    .margin-tool-container textarea:focus {
      outline: 2px solid #4f46e5;
      border-color: transparent;
    }
    .margin-tool-container button {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .margin-tool-container button.primary {
      background: #4f46e5;
      color: #fff;
    }
    .margin-tool-container button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .margin-tool-container button.danger {
      background: #f97373;
      color: #fff;
    }
    .margin-tool-container button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .margin-tool-container .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .margin-tool-container .toolbar span {
      font-size: 12px;
      color: #6b7280;
    }
    .margin-tool-container table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
    }
    .margin-tool-container th,
    .margin-tool-container td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 4px;
      text-align: center;
    }
    .margin-tool-container th {
      background: #f9fafb;
      font-weight: 600;
    }
    .margin-tool-container tr:hover td {
      background: #f9fafb;
    }
    .margin-tool-container .text-left { text-align: left; }
    .margin-tool-container .badge-pos {
      color: #16a34a;
      font-weight: 600;
    }
    .margin-tool-container .badge-neg {
      color: #dc2626;
      font-weight: 600;
      white-space: nowrap;
    }
    .margin-tool-container .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #ecfeff;
      color: #0f766e;
      gap: 4px;
    }
    .page-title {
      margin: 0 0 8px;
      font-size: 20px;
      color: #111827;
    }
    .page-desc {
      color: #6b7280;
      font-size: 13px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <!-- Auth Header -->
  <div class="auth-header">
    <h1>Creator Lab</h1>
    <div class="auth-links">
      <a href="/" class="btn-home">í™ˆ</a>
    </div>
  </div>

  <!-- Main Layout with Sidebar -->
  <div class="main-layout">
    <!-- Left Sidebar Navigation -->
    <aside class="sidebar">
      <nav class="sidebar-nav">
        <a href="/drama" class="sidebar-item" data-page="drama">
          <span class="sidebar-icon">ğŸ¬</span>
          <span class="sidebar-label">ë“œë¼ë§ˆ ì œì‘</span>
        </a>
        <a href="/image" class="sidebar-item" data-page="image">
          <span class="sidebar-icon">ğŸ–¼ï¸</span>
          <span class="sidebar-label">ì´ë¯¸ì§€ ì œì‘</span>
        </a>
        <a href="/product" class="sidebar-item" data-page="product">
          <span class="sidebar-icon">ğŸ“¦</span>
          <span class="sidebar-label">ìƒí’ˆ ì œì‘</span>
        </a>
        <a href="/product-manage" class="sidebar-item active" data-page="product-manage">
          <span class="sidebar-icon">ğŸ·ï¸</span>
          <span class="sidebar-label">ìƒí’ˆê´€ë¦¬</span>
        </a>
      </nav>
    </aside>

    <!-- Main Content Area -->
    <div class="main-content">
      <div id="product-manage-app" class="margin-tool-container">
        <h1 class="page-title">ì¤‘êµ­ ìˆ˜ì… ë§ˆì§„ Â· LCL Â· HS ì½”ë“œ ì‹œë®¬ë ˆì´í„°</h1>
        <p class="page-desc">ìœ„ì•ˆë‹¨ê°€ / í™˜ìœ¨ / ë„¤ì´ë²„ ìˆ˜ìˆ˜ë£Œ / ê´€Â·ë¶€ê°€ì„¸ / LCLê¹Œì§€ í•œ ë²ˆì— ë³´ëŠ” ë‚´ë¶€ìš© íˆ´ (ì‹¤ì œ ì‹ ê³  HS ì½”ë“œëŠ” ë°˜ë“œì‹œ ê´€ì„¸ì‚¬ í™•ì¸)</p>

        <!-- ê¸€ë¡œë²Œ ì„¤ì • -->
        <section id="global-config">
          <h2>â‘  ê¸€ë¡œë²Œ ì„¤ì •</h2>
          <small>ê¸°ë³¸ê°’ì€ ì§€ê¸ˆ ìš°ë¦¬ê°€ ê³„ì‚°ì— ì“°ë˜ ê°’ì´ì•¼. í•„ìš”í•˜ë©´ ë„¤ì´ë²„ ìˆ˜ìˆ˜ë£Œ/ë¶€ê°€ì„¸/ì¹´ë“œ ìˆ˜ìˆ˜ë£Œ/í™˜ìœ¨ë§Œ ìˆ˜ì •í•´.</small>
          <div class="grid">
            <div>
              <label for="exchangeRate">í™˜ìœ¨ (KRW / CNY)</label>
              <input id="exchangeRate" type="number" value="207" step="0.1" />
            </div>
            <div>
              <label for="naverFeeRate">ë„¤ì´ë²„ ìˆ˜ìˆ˜ë£Œìœ¨ (ì˜ˆ: 0.06 = 6%)</label>
              <input id="naverFeeRate" type="number" value="0.06" step="0.001" />
            </div>
            <div>
              <label for="vatRate">ë¶€ê°€ì„¸ìœ¨ (ì˜ˆ: 0.1 = 10%)</label>
              <input id="vatRate" type="number" value="0.10" step="0.01" />
            </div>
            <div>
              <label for="cardFeeRate">ì¹´ë“œ í•´ì™¸ê²°ì œ ìˆ˜ìˆ˜ë£Œìœ¨ (ì˜ˆ: 0.015 = 1.5%)</label>
              <input id="cardFeeRate" type="number" value="0.015" step="0.001" />
            </div>
          </div>
        </section>

        <!-- LCL ì‹œë®¬ë ˆì´ì…˜ -->
        <section id="lcl-config">
          <h2>â‘¡ LCL ì‹œë®¬ë ˆì´ì…˜</h2>
          <small>í•œ ë²ˆì— ê°™ì€ ë°•ìŠ¤ë¡œ ëª‡ ê°œë¥¼ ë„£ì–´ì„œ ë“¤ì—¬ì˜¤ëŠ”ì§€, ê·¸ë•Œ LCL ì´ ë¹„ìš©ì´ ì–¼ë§ˆì¸ì§€ ì…ë ¥í•˜ë©´ ê°œë‹¹ LCL ë‹¨ê°€ë¥¼ ìë™ ê³„ì‚°í•´.</small>
          <div class="grid">
            <div>
              <label for="lclTotalCost">í•œ ë²ˆ ì„ ì í•  ë•Œ LCL ì´ ë¹„ìš© (ì›, ì˜ˆ: 120000)</label>
              <input id="lclTotalCost" type="number" value="0" />
            </div>
            <div>
              <label for="lclQuantity">ê·¸ ì„ ì ì— ë“¤ì–´ê°€ëŠ” ìƒí’ˆ ê°œìˆ˜ (ì˜ˆ: 30ê°œ)</label>
              <input id="lclQuantity" type="number" value="0" />
            </div>
            <div>
              <label>ê³„ì‚°ëœ ê°œë‹¹ LCL ë¹„ìš© (ìë™)</label>
              <div id="lclPerUnitDisplay" class="pill">
                <span>ê°œë‹¹ LCL: 0 ì›</span>
              </div>
            </div>
          </div>
          <div class="toolbar">
            <span>â€» LCL ë¹„ìš©ì„ ê³„ì‚°í•´ë‘ë©´, ì•„ë˜ ëª¨ë“  ìƒí’ˆì— ê°™ì€ ê°œë‹¹ LCL ë‹¨ê°€ê°€ ì ìš©ë¼.</span>
          </div>
        </section>

        <!-- ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ / í•„í„° -->
        <section id="product-list-section">
          <h2>â‘¢ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸</h2>
          <div class="toolbar">
            <div>
              <label for="categoryFilter">ì¹´í…Œê³ ë¦¬ í•„í„°</label>
              <select id="categoryFilter">
                <option value="all">ì „ì²´</option>
              </select>
            </div>
            <span id="summaryText">ìƒí’ˆ 0ê°œ</span>
          </div>

          <table id="productTable">
            <thead>
              <tr>
                <th>ì¹´í…Œê³ ë¦¬</th>
                <th class="text-left">ìƒí’ˆëª…</th>
                <th>ì¤‘êµ­ë‹¨ê°€<br/>(CNY)</th>
                <th>íŒë§¤ê°€<br/>(KRW)</th>
                <th>ë¶€í”¼(L)</th>
                <th>HSì½”ë“œ<br/>/ê´€ì„¸ìœ¨</th>
                <th>ê°œë‹¹ LCL</th>
                <th>ë§ˆì§„ (ì›)</th>
                <th>ë§ˆì§„ìœ¨</th>
                <th>ë§í¬</th>
                <th>ì‚­ì œ</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </section>

        <!-- ìƒí’ˆ ì¶”ê°€ -->
        <section id="product-add-section">
          <h2>â‘£ ìƒí’ˆ ì¶”ê°€</h2>
          <small>ìƒí’ˆëª… + ìœ„ì•ˆ ê°€ê²© + íŒë§¤ê°€ + ë¶€í”¼ë¥¼ ì…ë ¥í•˜ê³ , í•„ìš”í•˜ë©´ HSì½”ë“œ ìë™ ì¶”ì²œì„ ëˆŒëŸ¬ì„œ ê´€ì„¸ìœ¨ê¹Œì§€ ì„¸íŒ…í•´.</small>
          <div class="grid">
            <div>
              <label for="newCategory">ì¹´í…Œê³ ë¦¬</label>
              <input id="newCategory" type="text" placeholder="ì˜ˆ: ì—¬ê³¼ê¸° / ë¶€ìì¬ / ì†Œëª¨í’ˆ" />
            </div>
            <div>
              <label for="newName">ìƒí’ˆëª…</label>
              <input id="newName" type="text" placeholder="ì˜ˆ: 22L ìŠ¤í…Œì¸ë ˆìŠ¤ ì—¬ê³¼ê¸° (ê¸°ë³¸í˜•)" />
            </div>
            <div>
              <label for="newCnyPrice">ì¤‘êµ­ ë‹¨ê°€ (ìœ„ì•ˆ)</label>
              <input id="newCnyPrice" type="number" step="0.01" placeholder="ì˜ˆ: 400" />
            </div>
            <div>
              <label for="newSellPrice">íŒë§¤ê°€ (ì›)</label>
              <input id="newSellPrice" type="number" placeholder="ì˜ˆ: 180000" />
            </div>
            <div>
              <label for="newVolume">ë¶€í”¼ (L, ëŒ€ëµ)</label>
              <input id="newVolume" type="number" step="0.1" placeholder="ì˜ˆ: 22" />
            </div>
            <div>
              <label for="newLink">êµ¬ë§¤ ë§í¬(URL)</label>
              <input id="newLink" type="url" placeholder="ì˜ˆ: https://..." />
            </div>
            <div>
              <label for="newHsCode">HS ì½”ë“œ (ì„ íƒ, ìë™ ì¶”ì²œ ê°€ëŠ¥)</label>
              <input id="newHsCode" type="text" placeholder="ì˜ˆ: 732690" />
            </div>
            <div>
              <label for="newDutyRate">ê´€ì„¸ìœ¨ (ì˜ˆ: 0 ë˜ëŠ” 0.08)</label>
              <div style="display:flex; gap:4px;">
                <input id="newDutyRate" type="number" step="0.001" placeholder="ì˜ˆ: 0 ë˜ëŠ” 0.08" />
                <button type="button" class="secondary" id="hsSuggestBtn">HS ìë™ ì¶”ì²œ</button>
              </div>
            </div>
          </div>
          <div class="toolbar" style="margin-top:10px;">
            <button class="primary" id="addProductBtn">ìƒí’ˆ ì¶”ê°€</button>
            <button class="secondary" id="clearAllBtn">ì „ì²´ ì‚­ì œ (ë¡œì»¬ ì €ì¥ì†Œ ì´ˆê¸°í™”)</button>
            <span>â€» ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì € <b>localStorage</b>ì— ì €ì¥ë¼. ìƒˆë¡œê³ ì¹¨í•´ë„ ìœ ì§€ë¨.</span>
          </div>
        </section>
      </div>
    </div><!-- /main-content -->
  </div><!-- /main-layout -->

  <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">ë¡œë”© ì¤‘...</div>
    <div class="loading-subtext"></div>
  </div>

  <!-- ìƒíƒœë°” -->
  <div id="status-bar" class="status-bar"></div>

  <script>
    let products = [];
    const STORAGE_KEY = "cn_margin_products_v1";

    const exchangeRateInput = document.getElementById("exchangeRate");
    const naverFeeRateInput = document.getElementById("naverFeeRate");
    const vatRateInput = document.getElementById("vatRate");
    const cardFeeRateInput = document.getElementById("cardFeeRate");

    const lclTotalCostInput = document.getElementById("lclTotalCost");
    const lclQuantityInput = document.getElementById("lclQuantity");
    const lclPerUnitDisplay = document.getElementById("lclPerUnitDisplay");

    const categoryFilterSelect = document.getElementById("categoryFilter");
    const summaryText = document.getElementById("summaryText");
    const productTableBody = document.querySelector("#productTable tbody");

    const newCategoryInput = document.getElementById("newCategory");
    const newNameInput = document.getElementById("newName");
    const newCnyPriceInput = document.getElementById("newCnyPrice");
    const newSellPriceInput = document.getElementById("newSellPrice");
    const newVolumeInput = document.getElementById("newVolume");
    const newLinkInput = document.getElementById("newLink");
    const newHsCodeInput = document.getElementById("newHsCode");
    const newDutyRateInput = document.getElementById("newDutyRate");
    const hsSuggestBtn = document.getElementById("hsSuggestBtn");

    const addProductBtn = document.getElementById("addProductBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");

    function formatNumber(num) {
      if (isNaN(num)) return "-";
      return num.toLocaleString("ko-KR");
    }

    function formatPercent(num) {
      if (isNaN(num)) return "-";
      return num.toFixed(1) + "%";
    }

    const HS_RULES = [
      {
        keywords: ["ìŠ¤í…Œì¸ë ˆìŠ¤", "ìŠ¤í…", "stainless", "í†µ"],
        hsCode: "732690",
        dutyRate: 0.0,
        desc: "ê¸°íƒ€ ìŠ¤í…Œì¸ë¦¬ìŠ¤ì œ ì œí’ˆ (ì¤‘êµ­ FTA 0% ê°€ì •)"
      },
      {
        keywords: ["ì—¬ê³¼ê¸°", "í•„í„°", "ìˆ˜ì¡±ê´€", "ì–´í•­", "í•„í„°í†µ"],
        hsCode: "842121",
        dutyRate: 0.0,
        desc: "ì—¬ê³¼ê¸°/ì •ìˆ˜ê¸°ë¥˜ (ê´€ì„¸ 0% ê°€ì •)"
      },
      {
        keywords: ["íŒí”„", "ëª¨í„°"],
        hsCode: "841370",
        dutyRate: 0.08,
        desc: "ì•¡ì²´ íŒí”„/ëª¨í„° (ê´€ì„¸ 8% ê°€ì •)"
      },
      {
        keywords: ["í”Œë¼ìŠ¤í‹±", "íŠœë¸Œ", "í˜¸ìŠ¤"],
        hsCode: "391740",
        dutyRate: 0.08,
        desc: "í”Œë¼ìŠ¤í‹± ê´€/í”¼íŒ… (ê´€ì„¸ 8% ê°€ì •)"
      },
      {
        keywords: ["ì•„ë‹µí„°", "ì–´ëŒ‘í„°", "ì „ì›", "ì»¨íŠ¸ë¡¤ëŸ¬", "adapter"],
        hsCode: "850440",
        dutyRate: 0.08,
        desc: "ì „ì›ê³µê¸‰ì¥ì¹˜ (ê´€ì„¸ 8% ê°€ì •)"
      }
    ];

    function guessHsFromName(name) {
      if (!name) return null;
      const lower = name.toLowerCase();
      for (const rule of HS_RULES) {
        for (const kw of rule.keywords) {
          if (lower.includes(kw.toLowerCase())) {
            return {
              hsCode: rule.hsCode,
              dutyRate: rule.dutyRate,
              desc: rule.desc
            };
          }
        }
      }
      return null;
    }

    function getLclPerUnit() {
      const total = Number(lclTotalCostInput.value || 0);
      const qty = Number(lclQuantityInput.value || 0);
      if (total > 0 && qty > 0) return total / qty;
      return 0;
    }

    function updateLclDisplay() {
      const perUnit = getLclPerUnit();
      lclPerUnitDisplay.innerHTML = `<span>ê°œë‹¹ LCL: ${formatNumber(Math.round(perUnit))} ì›</span>`;
      renderTable();
    }

    function calculateMargin(product) {
      const exchangeRate = Number(exchangeRateInput.value || 0);
      const naverFeeRate = Number(naverFeeRateInput.value || 0);
      const vatRate = Number(vatRateInput.value || 0);
      const cardFeeRate = Number(cardFeeRateInput.value || 0);
      const lclPerUnit = getLclPerUnit();

      const cnyPrice = Number(product.cnyPrice || 0);
      const sellPrice = Number(product.sellPrice || 0);

      const baseCostKrw = cnyPrice * exchangeRate;

      const guessed = guessHsFromName(product.name || "");
      let dutyRate = 0;
      let hsCode = "";

      if (product.dutyRate !== undefined && product.dutyRate !== null && !Number.isNaN(product.dutyRate)) {
        dutyRate = Number(product.dutyRate);
      } else if (guessed) {
        dutyRate = guessed.dutyRate;
      }

      if (product.hsCode) {
        hsCode = product.hsCode;
      } else if (guessed) {
        hsCode = guessed.hsCode;
      }

      const duty = baseCostKrw * dutyRate;
      const vatBase = baseCostKrw + duty;
      const vat = vatBase * vatRate;
      const cardFee = baseCostKrw * cardFeeRate;
      const platformFee = sellPrice * naverFeeRate;

      const totalCost = baseCostKrw + duty + vat + cardFee + lclPerUnit;
      const profit = sellPrice - totalCost - platformFee;
      const marginRate = sellPrice > 0 ? (profit / sellPrice) * 100 : 0;

      return {
        baseCostKrw,
        vat,
        duty,
        dutyRate,
        hsCode,
        cardFee,
        lclPerUnit,
        platformFee,
        totalCost,
        profit,
        marginRate
      };
    }

    function renderTable() {
      const selectedCategory = categoryFilterSelect.value;
      productTableBody.innerHTML = "";
      let filtered = products;

      if (selectedCategory !== "all") {
        filtered = products.filter(p => p.category === selectedCategory);
      }

      filtered.forEach((product) => {
        const result = calculateMargin(product);
        const tr = document.createElement("tr");

        const tdCat = document.createElement("td");
        tdCat.textContent = product.category;
        tr.appendChild(tdCat);

        const tdName = document.createElement("td");
        tdName.className = "text-left";
        tdName.textContent = product.name;
        tr.appendChild(tdName);

        const tdCny = document.createElement("td");
        tdCny.textContent = product.cnyPrice;
        tr.appendChild(tdCny);

        const tdSell = document.createElement("td");
        tdSell.textContent = formatNumber(product.sellPrice);
        tr.appendChild(tdSell);

        const tdVol = document.createElement("td");
        tdVol.textContent = product.volume ? product.volume + "L" : "-";
        tr.appendChild(tdVol);

        const tdHs = document.createElement("td");
        if (result.hsCode) {
          tdHs.innerHTML = `${result.hsCode}<br/><span style="font-size:11px; color:#6b7280;">${(result.dutyRate*100).toFixed(1)}%</span>`;
        } else {
          tdHs.innerHTML = `<span style="font-size:11px; color:#9ca3af;">ë¯¸ì§€ì •</span>`;
        }
        tr.appendChild(tdHs);

        const tdLcl = document.createElement("td");
        tdLcl.textContent = result.lclPerUnit > 0 ? formatNumber(Math.round(result.lclPerUnit)) + "ì›" : "-";
        tr.appendChild(tdLcl);

        const tdProfit = document.createElement("td");
        tdProfit.innerHTML = result.profit >= 0
          ? `<span class="badge-pos">+${formatNumber(Math.round(result.profit))}</span>`
          : `<span class="badge-neg">${formatNumber(Math.round(result.profit))}</span>`;
        tr.appendChild(tdProfit);

        const tdMargin = document.createElement("td");
        tdMargin.innerHTML = `<span class="${result.marginRate >= 0 ? "badge-pos" : "badge-neg"}">${formatPercent(result.marginRate)}</span>`;
        tr.appendChild(tdMargin);

        const tdLink = document.createElement("td");
        if (product.link) {
          const linkBtn = document.createElement("button");
          linkBtn.className = "secondary";
          linkBtn.textContent = "ë§í¬ ë³µì‚¬";
          linkBtn.addEventListener("click", () => {
            navigator.clipboard.writeText(product.link).then(() => {
              linkBtn.textContent = "ë³µì‚¬ë¨!";
              setTimeout(() => (linkBtn.textContent = "ë§í¬ ë³µì‚¬"), 1200);
            }).catch(() => alert("í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨"));
          });
          tdLink.appendChild(linkBtn);
        } else {
          tdLink.textContent = "-";
        }
        tr.appendChild(tdLink);

        const tdDelete = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.className = "danger";
        delBtn.textContent = "X";
        delBtn.addEventListener("click", () => {
          products = products.filter(p => p.id !== product.id);
          saveProducts();
          refreshAll();
        });
        tdDelete.appendChild(delBtn);
        tr.appendChild(tdDelete);

        productTableBody.appendChild(tr);
      });

      summaryText.textContent = `ìƒí’ˆ ${filtered.length}ê°œ (ì „ì²´ ${products.length}ê°œ)`;
    }

    function refreshCategoryFilter() {
      const categories = Array.from(new Set(products.map(p => p.category).filter(Boolean)));
      const currentValue = categoryFilterSelect.value;
      categoryFilterSelect.innerHTML = `<option value="all">ì „ì²´</option>`;
      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        categoryFilterSelect.appendChild(opt);
      });
      if (categories.includes(currentValue)) {
        categoryFilterSelect.value = currentValue;
      } else {
        categoryFilterSelect.value = "all";
      }
    }

    function saveProducts() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
    }

    function loadProducts() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          products = JSON.parse(raw);
        } catch (e) {
          products = [];
        }
      }
    }

    function refreshAll() {
      refreshCategoryFilter();
      renderTable();
    }

    hsSuggestBtn.addEventListener("click", () => {
      const name = newNameInput.value.trim();
      if (!name) {
        alert("ìƒí’ˆëª…ì„ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
      }
      const guess = guessHsFromName(name);
      if (!guess) {
        alert("ë§¤ì¹­ë˜ëŠ” HS ì½”ë“œ ì¶”ì²œì´ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
      }
      newHsCodeInput.value = guess.hsCode;
      newDutyRateInput.value = guess.dutyRate;
    });

    addProductBtn.addEventListener("click", () => {
      const category = newCategoryInput.value.trim() || "ë¯¸ë¶„ë¥˜";
      const name = newNameInput.value.trim();
      const cny = Number(newCnyPriceInput.value || 0);
      const sell = Number(newSellPriceInput.value || 0);
      const volume = newVolumeInput.value ? Number(newVolumeInput.value) : null;
      const link = newLinkInput.value.trim();
      const hsCode = newHsCodeInput.value.trim() || null;
      const dutyRate = newDutyRateInput.value ? Number(newDutyRateInput.value) : null;

      if (!name || !cny || !sell) {
        alert("ìƒí’ˆëª… / ì¤‘êµ­ë‹¨ê°€ / íŒë§¤ê°€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
        return;
      }

      const product = {
        id: crypto.randomUUID(),
        category,
        name,
        cnyPrice: cny,
        sellPrice: sell,
        volume,
        link,
        hsCode,
        dutyRate
      };
      products.push(product);
      saveProducts();

      newNameInput.value = "";
      newCnyPriceInput.value = "";
      newSellPriceInput.value = "";
      newVolumeInput.value = "";
      newLinkInput.value = "";
      newHsCodeInput.value = "";
      newDutyRateInput.value = "";

      refreshAll();
    });

    clearAllBtn.addEventListener("click", () => {
      if (!confirm("ì •ë§ ì „ì²´ ìƒí’ˆì„ ì‚­ì œí• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ)")) return;
      products = [];
      saveProducts();
      refreshAll();
    });

    categoryFilterSelect.addEventListener("change", renderTable);

    [exchangeRateInput, naverFeeRateInput, vatRateInput, cardFeeRateInput].forEach(input => {
      input.addEventListener("input", renderTable);
    });

    [lclTotalCostInput, lclQuantityInput].forEach(input => {
      input.addEventListener("input", updateLclDisplay);
    });

    loadProducts();
    updateLclDisplay();
    refreshAll();
  </script>
</body>
</html>
