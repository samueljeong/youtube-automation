<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>ìƒí’ˆê´€ë¦¬ - Creator Lab</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect fill='%23667eea' width='32' height='32' rx='6'/><text x='16' y='22' font-size='18' fill='white' text-anchor='middle' font-weight='bold'>P</text></svg>">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/drama.css') }}?v=20241202">
  <style>
    .pm-container { padding: 16px; }

    /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
    .tab-nav { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab-btn {
      padding: 10px 20px; border: 2px solid #e5e7eb; background: #fff;
      border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;
      transition: all 0.2s;
    }
    .tab-btn:hover { border-color: #4f46e5; }
    .tab-btn.active { background: #4f46e5; color: #fff; border-color: #4f46e5; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ìˆ˜ìˆ˜ë£Œ ìš”ì•½ ë°” */
    .fee-summary-bar {
      background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;
      padding: 10px 16px; margin-bottom: 16px; display: flex; gap: 16px;
      flex-wrap: wrap; align-items: center; font-size: 12px;
    }
    .fee-item { display: flex; align-items: center; gap: 4px; }
    .fee-item label { color: #64748b; }
    .fee-item select, .fee-item input {
      padding: 4px 8px; border: 1px solid #cbd5e1; border-radius: 4px;
      font-size: 12px; width: auto;
    }
    .fee-item .value { font-weight: 600; color: #334155; }
    .exchange-badge {
      background: #dcfce7; color: #16a34a; padding: 2px 8px;
      border-radius: 4px; font-size: 11px;
    }

    /* ì¹´ë“œ */
    .card {
      background: #fff; border-radius: 12px; padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 16px;
    }
    .card h3 { margin: 0 0 12px; font-size: 15px; color: #1e293b; }

    /* ê·¸ë¦¬ë“œ */
    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    @media (max-width: 768px) {
      .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
    }

    /* í¼ */
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; font-size: 12px; color: #475569; margin-bottom: 4px; }
    .form-group input, .form-group select {
      width: 100%; padding: 8px 10px; border: 1px solid #d1d5db;
      border-radius: 6px; font-size: 13px; box-sizing: border-box;
    }
    .form-group input:focus, .form-group select:focus {
      outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79,70,229,0.1);
    }
    .form-row { display: flex; gap: 8px; align-items: flex-end; }
    .form-hint { font-size: 11px; color: #94a3b8; margin-top: 2px; }

    /* ë²„íŠ¼ */
    .btn {
      padding: 8px 16px; border: none; border-radius: 6px;
      font-size: 13px; cursor: pointer; font-weight: 500;
    }
    .btn-primary { background: #4f46e5; color: #fff; }
    .btn-naver { background: #03c75a; color: #fff; }
    .btn-coupang { background: #e41e25; color: #fff; }
    .btn-secondary { background: #e5e7eb; color: #374151; }
    .btn-sm { padding: 4px 10px; font-size: 11px; }
    .btn-danger { background: #fee2e2; color: #dc2626; }

    /* ê²°ê³¼ ì¹´ë“œ */
    .result-card {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 1px solid #bae6fd; border-radius: 10px; padding: 16px; margin-top: 16px;
    }
    .result-card.naver { background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-color: #86efac; }
    .result-card.coupang { background: linear-gradient(135deg, #fef2f2, #fee2e2); border-color: #fca5a5; }
    .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .result-header h4 { margin: 0; font-size: 14px; }
    .result-price { font-size: 24px; font-weight: 700; color: #1e293b; }
    .result-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 12px; }
    .result-row { display: flex; justify-content: space-between; padding: 4px 0; }
    .result-row.total { border-top: 1px solid rgba(0,0,0,0.1); margin-top: 4px; padding-top: 8px; font-weight: 600; }
    .profit-highlight {
      background: #fff; border-radius: 8px; padding: 12px; margin-top: 12px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .profit-label { font-size: 13px; color: #475569; }
    .profit-value { font-size: 20px; font-weight: 700; }
    .profit-value.positive { color: #16a34a; }
    .profit-value.negative { color: #dc2626; }

    /* HSì½”ë“œ ì¶”ì²œ */
    .hs-recommend {
      background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px;
      padding: 12px; margin-top: 12px;
    }
    .hs-recommend h5 { margin: 0 0 8px; font-size: 13px; color: #92400e; }
    .hs-option {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px; background: #fff; border-radius: 6px; margin-bottom: 6px;
      cursor: pointer; border: 2px solid transparent;
    }
    .hs-option:hover { border-color: #fbbf24; }
    .hs-option.selected { border-color: #f59e0b; background: #fef3c7; }
    .hs-option .code { font-weight: 600; }
    .hs-option .rate { color: #16a34a; font-weight: 600; }
    .hs-option .desc { font-size: 11px; color: #78716c; }

    /* ë¶€í”¼ ì…ë ¥ */
    .volume-input {
      background: #f8fafc; border-radius: 8px; padding: 12px; margin-top: 8px;
    }
    .volume-type-toggle { display: flex; gap: 8px; margin-bottom: 10px; }
    .volume-type-btn {
      flex: 1; padding: 8px; border: 2px solid #e2e8f0; background: #fff;
      border-radius: 6px; font-size: 12px; cursor: pointer;
    }
    .volume-type-btn.active { border-color: #4f46e5; background: #eef2ff; color: #4f46e5; }
    .dimension-inputs { display: flex; gap: 8px; align-items: center; }
    .dimension-inputs input { width: 60px; text-align: center; }
    .dimension-inputs span { color: #94a3b8; }

    /* ë°°ì†¡ë¹„ ë¹„êµ */
    .shipping-compare {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 12px;
    }
    .shipping-option {
      border: 2px solid #e2e8f0; border-radius: 8px; padding: 12px;
      cursor: pointer; transition: all 0.2s;
    }
    .shipping-option:hover { border-color: #4f46e5; }
    .shipping-option.selected { border-color: #4f46e5; background: #eef2ff; }
    .shipping-option h5 { margin: 0 0 8px; font-size: 13px; }
    .shipping-option .price { font-size: 18px; font-weight: 700; color: #1e293b; }
    .shipping-option .detail { font-size: 11px; color: #64748b; margin-top: 4px; }

    /* í…Œì´ë¸” */
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td { padding: 10px 8px; text-align: center; border-bottom: 1px solid #e5e7eb; }
    th { background: #f8fafc; font-weight: 600; color: #475569; }
    tr:hover td { background: #f8fafc; }
    .text-left { text-align: left; }
    .badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 500; }
    .badge-naver { background: #dcfce7; color: #16a34a; }
    .badge-coupang { background: #fee2e2; color: #dc2626; }
    .badge-import { background: #dbeafe; color: #2563eb; }
    .badge-proxy { background: #fef3c7; color: #d97706; }
    .stock-input { width: 60px; padding: 4px; text-align: center; }

    /* ëª¨ë‹¬ */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: #fff; border-radius: 12px; padding: 24px;
      max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;
    }
    .modal h3 { margin: 0 0 16px; }
    .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }

    /* íŒë§¤ëŸ‰ ì¶”ì  */
    .sales-tracker {
      background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px;
      padding: 12px; margin-top: 8px;
    }
    .sales-tracker h5 { margin: 0 0 8px; font-size: 13px; color: #166534; }
    .sales-log { max-height: 150px; overflow-y: auto; font-size: 11px; }
    .sales-log-item {
      display: flex; justify-content: space-between;
      padding: 4px 0; border-bottom: 1px dashed #bbf7d0;
    }
  </style>
</head>
<body>
  <div class="auth-header">
    <h1>Creator Lab</h1>
    <div class="auth-links"><a href="/" class="btn-home">í™ˆ</a></div>
  </div>

  <div class="main-layout">
    <aside class="sidebar">
      <nav class="sidebar-nav">
        <a href="/drama" class="sidebar-item"><span class="sidebar-icon">ğŸ¬</span><span class="sidebar-label">ë“œë¼ë§ˆ ì œì‘</span></a>
        <a href="/image" class="sidebar-item"><span class="sidebar-icon">ğŸ–¼ï¸</span><span class="sidebar-label">ì´ë¯¸ì§€ ì œì‘</span></a>
        <a href="/product" class="sidebar-item"><span class="sidebar-icon">ğŸ“¦</span><span class="sidebar-label">ìƒí’ˆ ì œì‘</span></a>
        <a href="/product-manage" class="sidebar-item active"><span class="sidebar-icon">ğŸ·ï¸</span><span class="sidebar-label">ìƒí’ˆê´€ë¦¬</span></a>
      </nav>
    </aside>

    <div class="main-content">
      <div class="pm-container">
        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="tab-nav">
          <button class="tab-btn active" onclick="switchTab('register')">ğŸ“ ìƒí’ˆë“±ë¡</button>
          <button class="tab-btn" onclick="switchTab('list')">ğŸ“‹ ìƒí’ˆë¦¬ìŠ¤íŠ¸</button>
          <button class="tab-btn" onclick="switchTab('detail')">ğŸ¨ ìƒì„¸í˜ì´ì§€ ì œì‘</button>
        </div>

        <!-- ìˆ˜ìˆ˜ë£Œ ìš”ì•½ ë°” -->
        <div class="fee-summary-bar">
          <div class="fee-item">
            <label>í™˜ìœ¨</label>
            <span class="value" id="rateDisplay">207</span>ì›/CNY
            <span class="exchange-badge" id="rateStatus">ë¡œë”©</span>
            <button class="btn btn-sm btn-secondary" onclick="fetchExchangeRate()">ğŸ”„</button>
          </div>
          <div class="fee-item">
            <label>ë„¤ì´ë²„</label>
            <select id="naverFee" onchange="recalculate()">
              <option value="0.055">5.5%</option>
              <option value="0.06" selected>6%</option>
              <option value="0.08">8%</option>
            </select>
          </div>
          <div class="fee-item">
            <label>ì¿ íŒ¡</label>
            <select id="coupangFee" onchange="recalculate()">
              <option value="0.08">8%</option>
              <option value="0.10" selected>10%</option>
              <option value="0.12">12%</option>
            </select>
          </div>
          <div class="fee-item">
            <label>ë¶€ê°€ì„¸</label>
            <select id="vatRate" onchange="recalculate()">
              <option value="0.10" selected>10%</option>
              <option value="0">ë©´ì„¸</option>
            </select>
          </div>
          <div class="fee-item">
            <label>ì¹´ë“œìˆ˜ìˆ˜ë£Œ</label>
            <select id="cardFee" onchange="recalculate()">
              <option value="0">0% (ìœ„ì•ˆê²°ì œ)</option>
              <option value="0.02">2%</option>
              <option value="0.025">2.5%</option>
              <option value="0.03" selected>3% (ì¼ë°˜)</option>
              <option value="0.035">3.5%</option>
            </select>
          </div>
          <div class="fee-item">
            <label>íƒ€ì˜¤ë°”ì˜¤</label>
            <select id="taobaoFee" onchange="recalculate()">
              <option value="0" selected>ì—†ìŒ</option>
              <option value="0.01">1%</option>
              <option value="0.02">2%</option>
              <option value="0.03">3%</option>
              <option value="0.05">5%</option>
            </select>
          </div>
        </div>

        <!-- ìƒí’ˆë“±ë¡ íƒ­ -->
        <div id="tab-register" class="tab-content active">
          <div class="grid-2">
            <!-- ì¢Œì¸¡: ìƒí’ˆ ì •ë³´ ì…ë ¥ -->
            <div>
              <div class="card">
                <h3>ğŸ“¦ ìƒí’ˆ ì •ë³´</h3>
                <div class="grid-2">
                  <div class="form-group">
                    <label>ì¹´í…Œê³ ë¦¬</label>
                    <input type="text" id="newCategory" placeholder="ì˜ˆ: ì—¬ê³¼ê¸°">
                  </div>
                  <div class="form-group">
                    <label>ìƒí’ˆëª… *</label>
                    <input type="text" id="newName" placeholder="ì˜ˆ: 22L ìŠ¤í…Œì¸ë ˆìŠ¤ ì—¬ê³¼ê¸°" oninput="suggestHSCodes()">
                  </div>
                </div>
                <div class="grid-3">
                  <div class="form-group">
                    <label>ì¤‘êµ­ ë‹¨ê°€ (CNY) *</label>
                    <input type="number" id="newCnyPrice" step="0.01" placeholder="400" oninput="recalculate()">
                  </div>
                  <div class="form-group">
                    <label>ìˆ˜ëŸ‰ (ì„ íƒ)</label>
                    <input type="number" id="newQuantity" value="1" min="1" oninput="recalculate()">
                  </div>
                  <div class="form-group">
                    <label>ëª©í‘œ ë§ˆì§„ìœ¨ (%)</label>
                    <input type="number" id="targetMargin" value="35" oninput="recalculate()">
                  </div>
                </div>
                <div class="form-group">
                  <label>êµ¬ë§¤ ë§í¬</label>
                  <input type="url" id="newLink" placeholder="https://...">
                </div>
                <div class="form-group">
                  <label>ìƒí’ˆ ì´ë¯¸ì§€ URL</label>
                  <div style="display:flex; gap:8px; align-items:flex-start;">
                    <input type="url" id="newImageUrl" placeholder="https://... ì´ë¯¸ì§€ URL" style="flex:1;" oninput="previewImage()">
                    <div id="imagePreview" style="width:60px; height:60px; border:1px dashed #cbd5e1; border-radius:6px; display:flex; align-items:center; justify-content:center; overflow:hidden; background:#f8fafc;">
                      <span style="font-size:10px; color:#94a3b8;">ë¯¸ë¦¬ë³´ê¸°</span>
                    </div>
                  </div>
                </div>

                <!-- íŒë§¤ ë°©ì‹ -->
                <div class="form-group" style="margin-top:16px;">
                  <label>íŒë§¤ ë°©ì‹</label>
                  <div class="volume-type-toggle">
                    <button class="volume-type-btn active" onclick="setSaleType('import')">ğŸš¢ í•œêµ­ìˆ˜ì…</button>
                    <button class="volume-type-btn" onclick="setSaleType('proxy')">ğŸ“¦ êµ¬ë§¤ëŒ€í–‰</button>
                  </div>
                </div>
                <div id="proxyShippingBox" style="display:none;" class="form-group">
                  <label>ê°œë‹¹ í•´ì™¸ë°°ì†¡ë¹„ (ì›)</label>
                  <input type="number" id="proxyShipping" value="0" placeholder="15000" oninput="recalculate()">
                </div>

                <!-- HSì½”ë“œ ì¶”ì²œ -->
                <div id="hsRecommendBox" class="hs-recommend" style="display:none;">
                  <h5>ğŸ’¡ HSì½”ë“œ ì¶”ì²œ (ë‚®ì€ ê´€ì„¸ ìš°ì„ )</h5>
                  <div id="hsOptions"></div>
                  <div class="form-hint">* ì‹¤ì œ ì ìš©ì€ ê´€ì„¸ì‚¬ í™•ì¸ í•„ìš”. ì‹ ê³  ë°©ë²•ì— ë”°ë¼ ê´€ì„¸ ì ˆê° ê°€ëŠ¥</div>
                </div>
              </div>

              <!-- ë¶€í”¼ ì…ë ¥ -->
              <div class="card">
                <h3>ğŸ“ ë¶€í”¼ ì •ë³´</h3>
                <div class="volume-type-toggle">
                  <button class="volume-type-btn active" onclick="setVolumeType('individual')">ê°œë³„ ìƒí’ˆ</button>
                  <button class="volume-type-btn" onclick="setVolumeType('box')">ë°•ìŠ¤ ë‹¨ìœ„</button>
                </div>
                <div class="volume-input">
                  <div class="dimension-inputs">
                    <input type="number" id="dimW" placeholder="ê°€ë¡œ" oninput="calcVolume()"> <span>Ã—</span>
                    <input type="number" id="dimH" placeholder="ì„¸ë¡œ" oninput="calcVolume()"> <span>Ã—</span>
                    <input type="number" id="dimD" placeholder="ë†’ì´" oninput="calcVolume()"> <span>cm</span>
                    <span style="margin-left:12px;">= <strong id="volumeResult">0</strong> CBM</span>
                  </div>
                  <div id="boxQtyRow" style="display:none; margin-top:10px;">
                    <label style="font-size:12px;">ë°•ìŠ¤ë‹¹ ìˆ˜ëŸ‰</label>
                    <input type="number" id="boxQty" value="1" style="width:80px;" oninput="recalculate()">
                  </div>
                </div>
              </div>

              <!-- ë°°ì†¡ë¹„ ë¹„êµ (ì´ì§€íƒ€ì˜¤ ê¸°ì¤€) -->
              <div class="card">
                <h3>ğŸšš ë°°ì†¡ë¹„ ë¹„êµ <span style="font-size:11px; color:#64748b;">(ì´ì§€íƒ€ì˜¤ ê¸°ì¤€)</span></h3>
                <div class="shipping-compare">
                  <div class="shipping-option selected" onclick="selectShipping('lcl')">
                    <h5>ğŸš¢ LCL (í•´ìƒì†ŒëŸ‰)</h5>
                    <div class="price" id="lclPrice">ê³„ì‚° í•„ìš”</div>
                    <div class="detail" style="font-size:10px;">
                      <div>ìš´ì„(CBM): <span id="lclFreight">-</span></div>
                      <div style="color:#64748b;">BLë¹„: 22,000ì›</div>
                      <div style="color:#64748b;">í•¸ë“¤ë§: 33,000ì›</div>
                      <div style="color:#64748b;">í†µê´€ìˆ˜ìˆ˜ë£Œ: 33,000ì›</div>
                      <div id="lclFtaRow" style="color:#16a34a;">ì›ì‚°ì§€ì¦ëª…: 35,000ì›</div>
                      <div>êµ­ë‚´ë°°ì†¡: <span id="lclDomestic">-</span></div>
                    </div>
                    <div class="form-hint" style="margin-top:6px; font-size:9px;">
                      ìµœì†Œ 0.5CBM ì ìš© | ì†Œìš” 2-3ì£¼
                    </div>
                  </div>
                  <div class="shipping-option" onclick="selectShipping('air')">
                    <h5>âœˆï¸ í•­ê³µ/íŠ¹ì†¡</h5>
                    <div class="price" id="airPrice">ê³„ì‚° í•„ìš”</div>
                    <div class="detail" style="font-size:10px;">
                      <div>CBMë‹¹ ì•½ 50ë§Œì›</div>
                      <div style="color:#64748b;">ì†Œìš” 7-10ì¼</div>
                    </div>
                    <div class="form-hint" style="margin-top:6px; font-size:9px;">
                      ê¸‰í•  ë•Œë§Œ ì‚¬ìš© ê¶Œì¥
                    </div>
                  </div>
                </div>
                <div style="margin-top:10px;">
                  <label style="font-size:11px; display:flex; align-items:center; gap:4px;">
                    <input type="checkbox" id="useFta" checked onchange="recalculate()">
                    FTA ì›ì‚°ì§€ì¦ëª… ì‹ ì²­ (+35,000ì›, ê´€ì„¸ 0% ì ìš©)
                  </label>
                </div>
                <div class="form-hint" style="margin-top:6px; background:#f0f9ff; padding:8px; border-radius:6px;">
                  <strong>ğŸ“¦ êµ­ë‚´ë°°ì†¡ ê¸°ì¤€ (CJëŒ€í•œí†µìš´)</strong><br>
                  â€¢ ì‚¼ë³€í•© 80cm ë¯¸ë§Œ: ê¸°ë³¸ 3,500ì›<br>
                  â€¢ 80-100cm: +500ì› / 100-120cm: +1,000ì› / 120-160cm: +3,000ì›<br>
                  â€¢ 160cm ì´ˆê³¼ ë˜ëŠ” 15kg ì´ˆê³¼: ê²½ë™íƒë°° ì´ê´€
                </div>
                <details style="margin-top:8px; font-size:11px;">
                  <summary style="cursor:pointer; color:#4f46e5;">ğŸ“Š LCL CBM ìš”ê¸ˆí‘œ ë³´ê¸°</summary>
                  <div style="background:#f8fafc; padding:8px; margin-top:4px; border-radius:6px;">
                    <table style="width:100%; font-size:10px;">
                      <tr><th style="padding:2px 4px;">CBM</th><th style="padding:2px 4px;">ë‹¨ê°€</th></tr>
                      <tr><td>0.5 (ìµœì†Œ)</td><td>220,000ì›</td></tr>
                      <tr><td>~1</td><td>180,000ì›/CBM</td></tr>
                      <tr><td>~2</td><td>160,000ì›/CBM</td></tr>
                      <tr><td>~3</td><td>150,000ì›/CBM</td></tr>
                      <tr><td>~5</td><td>140,000ì›/CBM</td></tr>
                      <tr><td>~10</td><td>130,000ì›/CBM</td></tr>
                      <tr><td>10+</td><td>120,000ì›/CBM</td></tr>
                    </table>
                  </div>
                </details>
              </div>
            </div>

            <!-- ìš°ì¸¡: ê³„ì‚° ê²°ê³¼ -->
            <div>
              <!-- ê²°ì œ ì˜ˆìƒ ê¸ˆì•¡ -->
              <div class="card">
                <h3>ğŸ’³ ì˜ˆìƒ ê²°ì œ ê¸ˆì•¡</h3>
                <div class="result-grid">
                  <div class="result-row"><span>ì¤‘êµ­ ì›ê°€</span><span id="totalCny">-</span></div>
                  <div class="result-row"><span>ì›í™” í™˜ì‚°</span><span id="totalKrw">-</span></div>
                  <div class="result-row"><span>ê´€ì„¸</span><span id="totalDuty">-</span></div>
                  <div class="result-row"><span>ë¶€ê°€ì„¸</span><span id="totalVat">-</span></div>
                  <div class="result-row"><span>ì¹´ë“œìˆ˜ìˆ˜ë£Œ</span><span id="totalCard">-</span></div>
                  <div class="result-row"><span>íƒ€ì˜¤ë°”ì˜¤</span><span id="totalTaobao">-</span></div>
                  <div class="result-row"><span>ë°°ì†¡ë¹„</span><span id="totalShipping">-</span></div>
                  <div class="result-row total"><span>ì´ ê²°ì œ ì˜ˆìƒ</span><span id="grandTotal">-</span></div>
                </div>
              </div>

              <!-- ë„¤ì´ë²„ íŒë§¤ ì‹œë®¬ë ˆì´ì…˜ -->
              <div class="result-card naver">
                <div class="result-header">
                  <h4>ğŸŸ¢ ë„¤ì´ë²„ ê¶Œì¥ íŒë§¤ê°€</h4>
                  <div class="result-price" id="naverPrice">-</div>
                </div>
                <div class="result-grid" style="font-size:11px;">
                  <div class="result-row"><span>í”Œë«í¼ ìˆ˜ìˆ˜ë£Œ</span><span id="naverFeeAmt">-</span></div>
                  <div class="result-row"><span>ì´ ë¹„ìš©</span><span id="naverCost">-</span></div>
                </div>
                <div class="profit-highlight">
                  <span class="profit-label">ì „ì²´ íŒë§¤ ì‹œ ìˆœì´ìµ</span>
                  <span class="profit-value positive" id="naverProfit">-</span>
                </div>
              </div>

              <!-- ì¿ íŒ¡ íŒë§¤ ì‹œë®¬ë ˆì´ì…˜ -->
              <div class="result-card coupang">
                <div class="result-header">
                  <h4>ğŸ”´ ì¿ íŒ¡ ê¶Œì¥ íŒë§¤ê°€</h4>
                  <div class="result-price" id="coupangPrice">-</div>
                </div>
                <div class="result-grid" style="font-size:11px;">
                  <div class="result-row"><span>í”Œë«í¼ ìˆ˜ìˆ˜ë£Œ</span><span id="coupangFeeAmt">-</span></div>
                  <div class="result-row"><span>ì´ ë¹„ìš©</span><span id="coupangCost">-</span></div>
                </div>
                <div class="profit-highlight">
                  <span class="profit-label">ì „ì²´ íŒë§¤ ì‹œ ìˆœì´ìµ</span>
                  <span class="profit-value positive" id="coupangProfit">-</span>
                </div>
              </div>

              <!-- ë“±ë¡ ë²„íŠ¼ -->
              <div style="display:flex; gap:8px; margin-top:16px;">
                <button class="btn btn-naver" style="flex:1;" onclick="addProduct('naver')">ë„¤ì´ë²„ìš© ë“±ë¡</button>
                <button class="btn btn-coupang" style="flex:1;" onclick="addProduct('coupang')">ì¿ íŒ¡ìš© ë“±ë¡</button>
              </div>
            </div>
          </div>
        </div>

        <!-- ìƒí’ˆë¦¬ìŠ¤íŠ¸ íƒ­ -->
        <div id="tab-list" class="tab-content">
          <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
              <h3 style="margin:0;">ğŸ“‹ ë“±ë¡ëœ ìƒí’ˆ</h3>
              <div style="display:flex; gap:8px;">
                <select id="filterPlatform" onchange="renderTable()">
                  <option value="all">ì „ì²´ í”Œë«í¼</option>
                  <option value="naver">ë„¤ì´ë²„</option>
                  <option value="coupang">ì¿ íŒ¡</option>
                </select>
                <select id="filterCategory" onchange="renderTable()">
                  <option value="all">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                </select>
                <button class="btn btn-danger btn-sm" onclick="clearAll()">ì „ì²´ ì‚­ì œ</button>
              </div>
            </div>
            <table>
              <thead>
                <tr>
                  <th style="width:50px;">ì´ë¯¸ì§€</th>
                  <th>í”Œë«í¼</th>
                  <th>ë°©ì‹</th>
                  <th class="text-left">ìƒí’ˆëª…</th>
                  <th>ì›ê°€</th>
                  <th>íŒë§¤ê°€</th>
                  <th>ë§ˆì§„ìœ¨</th>
                  <th>ì¬ê³ </th>
                  <th>ë“±ë¡ì¼</th>
                  <th>ì‘ì—…</th>
                </tr>
              </thead>
              <tbody id="productTableBody"></tbody>
            </table>
            <div id="listSummary" style="margin-top:12px; font-size:12px; color:#64748b;"></div>
          </div>

          <!-- ì¬ê³ /íŒë§¤ëŸ‰ ì¶”ì  -->
          <div class="card">
            <h3>ğŸ“Š ì¬ê³  & íŒë§¤ëŸ‰ ì¶”ì </h3>
            <div class="sales-tracker">
              <h5>ìµœê·¼ ì¬ê³  ë³€ë™ ê¸°ë¡</h5>
              <div class="sales-log" id="salesLog">
                <div style="color:#94a3b8; text-align:center; padding:20px;">
                  ì¬ê³  ë³€ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìƒí’ˆ ì¬ê³ ë¥¼ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ì¶”ì ë©ë‹ˆë‹¤.
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ìƒì„¸í˜ì´ì§€ ì œì‘ íƒ­ -->
        <div id="tab-detail" class="tab-content">
          <div class="card">
            <h3>ğŸ¨ ìƒì„¸í˜ì´ì§€ ì œì‘</h3>
            <div style="text-align:center; padding:60px; color:#94a3b8;">
              <div style="font-size:48px; margin-bottom:16px;">ğŸš§</div>
              <div style="font-size:16px;">ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤</div>
              <div style="font-size:13px; margin-top:8px;">AI ê¸°ë°˜ ìƒì„¸í˜ì´ì§€ ìë™ ìƒì„± ê¸°ëŠ¥ì´ ê³§ ì¶”ê°€ë©ë‹ˆë‹¤</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ìˆ˜ì • ëª¨ë‹¬ -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h3>ìƒí’ˆ ìˆ˜ì •</h3>
      <input type="hidden" id="editId">
      <div class="grid-2">
        <div class="form-group">
          <label>ìƒí’ˆëª…</label>
          <input type="text" id="editName">
        </div>
        <div class="form-group">
          <label>ì¹´í…Œê³ ë¦¬</label>
          <input type="text" id="editCategory">
        </div>
        <div class="form-group">
          <label>ì›ê°€ (CNY)</label>
          <input type="number" id="editCnyPrice">
        </div>
        <div class="form-group">
          <label>íŒë§¤ê°€ (KRW)</label>
          <input type="number" id="editSellPrice">
        </div>
      </div>
      <div class="form-group">
        <label>ì´ë¯¸ì§€ URL</label>
        <div style="display:flex; gap:8px; align-items:flex-start;">
          <input type="url" id="editImageUrl" style="flex:1;" oninput="previewEditImage()">
          <div id="editImagePreview" style="width:60px; height:60px; border:1px dashed #cbd5e1; border-radius:6px; display:flex; align-items:center; justify-content:center; overflow:hidden; background:#f8fafc;">
            <span style="font-size:10px; color:#94a3b8;">ë¯¸ë¦¬ë³´ê¸°</span>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeEditModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="saveEdit()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    // === ì „ì—­ ë³€ìˆ˜ ===
    let products = [];
    let salesLogs = [];
    let exchangeRate = 207;
    let selectedHsCode = null;
    let selectedDutyRate = 0;
    let saleType = 'import';
    let volumeType = 'individual';
    let shippingType = 'lcl';

    // DB ì €ì¥ìœ¼ë¡œ ë³€ê²½ë¨ (localStorage ì œê±°)

    // === HS ì½”ë“œ ë°ì´í„°ë² ì´ìŠ¤ ===
    const HS_DATABASE = {
      'ìŠ¤í…Œì¸ë ˆìŠ¤': [
        { code: '732690', rate: 0, desc: 'ê¸°íƒ€ ìŠ¤í…Œì¸ë¦¬ìŠ¤ ì œí’ˆ (FTA 0%)' },
        { code: '732393', rate: 0.08, desc: 'ìŠ¤í…Œì¸ë¦¬ìŠ¤ ì‹íƒìš©í’ˆ (8%)' }
      ],
      'ì•„í¬ë¦´': [
        { code: '392099', rate: 0, desc: 'ê¸°íƒ€ í”Œë¼ìŠ¤í‹± íŒ/ì‹œíŠ¸ (FTA 0%)' },
        { code: '392062', rate: 0.065, desc: 'í´ë¦¬ì¹´ë³´ë„¤ì´íŠ¸ íŒ (6.5%)' },
        { code: '940360', rate: 0.08, desc: 'ê°€êµ¬ë¥˜ (8%)' }
      ],
      'ì—¬ê³¼ê¸°': [
        { code: '842121', rate: 0, desc: 'ì•¡ì²´ ì—¬ê³¼/ì •í™”ê¸°ê¸° (0%)' },
        { code: '842129', rate: 0, desc: 'ê¸°íƒ€ ì—¬ê³¼ê¸° (0%)' }
      ],
      'íŒí”„': [
        { code: '841370', rate: 0.08, desc: 'ì›ì‹¬íŒí”„ (8%)' },
        { code: '841381', rate: 0.08, desc: 'ê¸°íƒ€ íŒí”„ (8%)' }
      ],
      'í”Œë¼ìŠ¤í‹±': [
        { code: '392690', rate: 0, desc: 'ê¸°íƒ€ í”Œë¼ìŠ¤í‹± ì œí’ˆ (FTA 0%)' },
        { code: '391740', rate: 0.08, desc: 'í”Œë¼ìŠ¤í‹± ê´€/í”¼íŒ… (8%)' }
      ],
      'ì „ì›': [
        { code: '850440', rate: 0.08, desc: 'ì •ë¥˜ê¸°/ë³€í™˜ê¸° (8%)' }
      ],
      'ê¸°ë³¸': [
        { code: '999999', rate: 0.08, desc: 'ê¸°íƒ€ (ê¸°ë³¸ 8%)' }
      ]
    };

    // === ì´ˆê¸°í™” ===
    async function init() {
      fetchExchangeRate();
      await loadProducts();   // APIì—ì„œ ìƒí’ˆ ë¡œë“œ
      await loadSalesLogs();  // APIì—ì„œ ë¡œê·¸ ë¡œë“œ
    }

    // === íƒ­ ì „í™˜ ===
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
    }

    // === í™˜ìœ¨ ê°€ì ¸ì˜¤ê¸° ===
    async function fetchExchangeRate() {
      document.getElementById('rateStatus').textContent = 'ë¡œë”©';
      try {
        const res = await fetch('https://api.exchangerate-api.com/v4/latest/CNY');
        const data = await res.json();
        exchangeRate = data.rates.KRW;
        document.getElementById('rateDisplay').textContent = exchangeRate.toFixed(1);
        document.getElementById('rateStatus').textContent = 'ì‹¤ì‹œê°„';
        document.getElementById('rateStatus').style.background = '#dcfce7';
        recalculate();
      } catch (e) {
        document.getElementById('rateStatus').textContent = 'ì˜¤í”„ë¼ì¸';
        document.getElementById('rateStatus').style.background = '#fef3c7';
      }
    }

    // === íŒë§¤ë°©ì‹ ì„¤ì • ===
    function setSaleType(type) {
      saleType = type;
      document.querySelectorAll('.form-group .volume-type-btn').forEach((b, i) => {
        b.classList.toggle('active', (type === 'import' && i === 0) || (type === 'proxy' && i === 1));
      });
      document.getElementById('proxyShippingBox').style.display = type === 'proxy' ? 'block' : 'none';
      recalculate();
    }

    // === ë¶€í”¼íƒ€ì… ì„¤ì • ===
    function setVolumeType(type) {
      volumeType = type;
      document.querySelectorAll('.card .volume-type-btn').forEach((b, i) => {
        b.classList.toggle('active', (type === 'individual' && i === 0) || (type === 'box' && i === 1));
      });
      document.getElementById('boxQtyRow').style.display = type === 'box' ? 'block' : 'none';
      recalculate();
    }

    // === ë°°ì†¡íƒ€ì… ì„ íƒ ===
    function selectShipping(type) {
      shippingType = type;
      document.querySelectorAll('.shipping-option').forEach(o => o.classList.remove('selected'));
      document.querySelector(`[onclick="selectShipping('${type}')"]`).classList.add('selected');
      recalculate();
    }

    // === ë¶€í”¼ ê³„ì‚° ===
    function calcVolume() {
      const w = parseFloat(document.getElementById('dimW').value) || 0;
      const h = parseFloat(document.getElementById('dimH').value) || 0;
      const d = parseFloat(document.getElementById('dimD').value) || 0;
      const cbm = (w * h * d) / 1000000;
      document.getElementById('volumeResult').textContent = cbm.toFixed(4);
      recalculate();
    }

    // === HSì½”ë“œ ì¶”ì²œ ===
    function suggestHSCodes() {
      const name = document.getElementById('newName').value.toLowerCase();
      const box = document.getElementById('hsRecommendBox');
      const container = document.getElementById('hsOptions');

      let matchedCodes = [];
      for (const [keyword, codes] of Object.entries(HS_DATABASE)) {
        if (keyword !== 'ê¸°ë³¸' && name.includes(keyword)) {
          matchedCodes = [...matchedCodes, ...codes];
        }
      }
      if (matchedCodes.length === 0) {
        matchedCodes = HS_DATABASE['ê¸°ë³¸'];
      }

      // ê´€ì„¸ìœ¨ ë‚®ì€ ìˆœ ì •ë ¬
      matchedCodes.sort((a, b) => a.rate - b.rate);

      if (matchedCodes.length > 0) {
        box.style.display = 'block';
        container.innerHTML = matchedCodes.map((hs, i) => `
          <div class="hs-option ${i === 0 ? 'selected' : ''}" onclick="selectHS('${hs.code}', ${hs.rate}, this)">
            <div>
              <span class="code">${hs.code}</span>
              <span class="desc">${hs.desc}</span>
            </div>
            <span class="rate">${(hs.rate * 100).toFixed(1)}%</span>
          </div>
        `).join('');

        // ì²« ë²ˆì§¸ (ê°€ì¥ ë‚®ì€ ê´€ì„¸) ìë™ ì„ íƒ
        selectedHsCode = matchedCodes[0].code;
        selectedDutyRate = matchedCodes[0].rate;
        recalculate();
      } else {
        box.style.display = 'none';
      }
    }

    function selectHS(code, rate, el) {
      document.querySelectorAll('.hs-option').forEach(o => o.classList.remove('selected'));
      el.classList.add('selected');
      selectedHsCode = code;
      selectedDutyRate = rate;
      recalculate();
    }

    // === ì´ì§€íƒ€ì˜¤ LCL ìš”ê¸ˆí‘œ (CBMë‹¹, ì¼ë°˜í•´ìš´) ===
    const LCL_RATES = {
      // CBM êµ¬ê°„: ìš”ê¸ˆ(ì›/CBM)
      0.5: 220000,   // 0.5CBM ì´í•˜ ìµœì†Œ
      1: 180000,     // 1CBMê¹Œì§€
      2: 160000,     // 2CBMê¹Œì§€
      3: 150000,     // 3CBMê¹Œì§€
      5: 140000,     // 5CBMê¹Œì§€
      10: 130000,    // 10CBMê¹Œì§€
      999: 120000    // 10CBM ì´ˆê³¼
    };

    // êµ­ë‚´ë°°ì†¡ ì¶”ê°€ìš”ê¸ˆ (ì‚¼ë³€í•© ê¸°ì¤€)
    const DOMESTIC_SURCHARGE = {
      80: 0,        // 80cm ë¯¸ë§Œ: ê¸°ë³¸
      100: 500,     // 80-100cm: +500ì›
      120: 1000,    // 100-120cm: +1,000ì›
      160: 3000,    // 120-160cm: +3,000ì›
      999: 5000     // 160cm ì´ˆê³¼: ê²½ë™íƒë°° ì´ê´€ ì¶”ê°€ìš”ê¸ˆ
    };

    // CBM ìš´ì„ ê³„ì‚°
    function calcLclFreight(cbm) {
      const effectiveCbm = Math.max(cbm, 0.5); // ìµœì†Œ 0.5CBM ì ìš©
      let rate = LCL_RATES[999];
      for (const [threshold, r] of Object.entries(LCL_RATES)) {
        if (effectiveCbm <= parseFloat(threshold)) {
          rate = r;
          break;
        }
      }
      return effectiveCbm * rate;
    }

    // êµ­ë‚´ë°°ì†¡ ì¶”ê°€ìš”ê¸ˆ ê³„ì‚° (ì‚¼ë³€í•© ê¸°ì¤€)
    function calcDomesticSurcharge(w, h, d) {
      const sum = w + h + d; // ì‚¼ë³€í•©
      let surcharge = 0;
      for (const [threshold, s] of Object.entries(DOMESTIC_SURCHARGE)) {
        if (sum <= parseFloat(threshold)) {
          surcharge = s;
          break;
        }
      }
      return surcharge;
    }

    // === ë©”ì¸ ê³„ì‚° ===
    function recalculate() {
      const cnyPrice = parseFloat(document.getElementById('newCnyPrice').value) || 0;
      const quantity = parseInt(document.getElementById('newQuantity').value) || 1;
      const targetMargin = parseFloat(document.getElementById('targetMargin').value) || 35;
      const naverFeeRate = parseFloat(document.getElementById('naverFee').value);
      const coupangFeeRate = parseFloat(document.getElementById('coupangFee').value);
      const vatRate = parseFloat(document.getElementById('vatRate').value);
      const cardFeeRate = parseFloat(document.getElementById('cardFee').value);
      const taobaoFeeRate = parseFloat(document.getElementById('taobaoFee').value);
      const useFta = document.getElementById('useFta').checked;

      if (cnyPrice <= 0) return;

      // ì´ ì›ê°€ ê³„ì‚°
      const totalCny = cnyPrice * quantity;
      const totalKrw = totalCny * exchangeRate;

      // FTA ì ìš© ì‹œ ê´€ì„¸ 0%, ì•„ë‹ˆë©´ ì„ íƒëœ ê´€ì„¸ìœ¨ ì ìš©
      const effectiveDutyRate = useFta ? 0 : selectedDutyRate;
      const duty = totalKrw * effectiveDutyRate;
      const vat = (totalKrw + duty) * vatRate;
      const cardFee = totalKrw * cardFeeRate;
      const taobaoFee = totalKrw * taobaoFeeRate;

      // ë°°ì†¡ë¹„ ê³„ì‚°
      let shipping = 0;
      if (saleType === 'proxy') {
        shipping = (parseFloat(document.getElementById('proxyShipping').value) || 0) * quantity;
      } else {
        // ë¶€í”¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const w = parseFloat(document.getElementById('dimW').value) || 0;
        const h = parseFloat(document.getElementById('dimH').value) || 0;
        const d = parseFloat(document.getElementById('dimD').value) || 0;
        const cbm = parseFloat(document.getElementById('volumeResult').textContent) || 0;
        const boxQty = volumeType === 'box' ? parseInt(document.getElementById('boxQty').value) || 1 : 1;
        const shipmentCount = Math.ceil(quantity / boxQty);

        if (shippingType === 'lcl') {
          // LCL ì´ì§€íƒ€ì˜¤ ìš”ê¸ˆ ê³„ì‚°
          const freight = calcLclFreight(cbm * shipmentCount);
          const blFee = 22000;        // BLë¹„
          const handlingFee = 33000;  // í•¸ë“¤ë§
          const customsFee = 33000;   // í†µê´€ìˆ˜ìˆ˜ë£Œ
          const ftaFee = useFta ? 35000 : 0;  // ì›ì‚°ì§€ì¦ëª…
          const domesticSurcharge = calcDomesticSurcharge(w, h, d) * quantity;
          const domesticBase = 3500 * quantity;  // ê¸°ë³¸ êµ­ë‚´ë°°ì†¡ë¹„

          shipping = freight + blFee + handlingFee + customsFee + ftaFee + domesticBase + domesticSurcharge;

          // UI ì—…ë°ì´íŠ¸
          document.getElementById('lclPrice').textContent = formatNum(shipping) + 'ì›';
          document.getElementById('lclFreight').textContent = formatNum(freight) + 'ì›';
          document.getElementById('lclDomestic').textContent = formatNum(domesticBase + domesticSurcharge) + 'ì›';
          document.getElementById('lclFtaRow').style.display = useFta ? 'block' : 'none';

          // í•­ê³µ ë¹„êµ (ì°¸ê³ ìš©)
          const airFreight = cbm * shipmentCount * 500000;
          document.getElementById('airPrice').textContent = formatNum(airFreight + domesticBase) + 'ì›';
        } else {
          // í•­ê³µ ë°°ì†¡ë¹„
          const domesticBase = 3500 * quantity;
          shipping = (cbm * shipmentCount * 500000) + domesticBase;
          document.getElementById('airPrice').textContent = formatNum(shipping) + 'ì›';

          // LCL ë¹„êµ (ì°¸ê³ ìš©)
          const lclTotal = calcLclFreight(cbm * shipmentCount) + 22000 + 33000 + 33000 + (useFta ? 35000 : 0) + domesticBase;
          document.getElementById('lclPrice').textContent = formatNum(lclTotal) + 'ì›';
          document.getElementById('lclFreight').textContent = formatNum(calcLclFreight(cbm * shipmentCount)) + 'ì›';
        }
      }

      const grandTotal = totalKrw + duty + vat + cardFee + taobaoFee + shipping;

      // ê²°ì œ ì˜ˆìƒ ê¸ˆì•¡ í‘œì‹œ
      document.getElementById('totalCny').textContent = formatNum(totalCny) + ' CNY';
      document.getElementById('totalKrw').textContent = formatNum(totalKrw) + 'ì›';
      document.getElementById('totalDuty').textContent = formatNum(duty) + 'ì›';
      document.getElementById('totalVat').textContent = formatNum(vat) + 'ì›';
      document.getElementById('totalCard').textContent = formatNum(cardFee) + 'ì›';
      document.getElementById('totalTaobao').textContent = formatNum(taobaoFee) + 'ì›';
      document.getElementById('totalShipping').textContent = formatNum(shipping) + 'ì›';
      document.getElementById('grandTotal').textContent = formatNum(grandTotal) + 'ì›';

      // ê°œë‹¹ ë¹„ìš©
      const costPerUnit = grandTotal / quantity;
      const marginDecimal = targetMargin / 100;

      // ë„¤ì´ë²„ ê¶Œì¥ê°€
      const naverSellPrice = costPerUnit / (1 - naverFeeRate - marginDecimal);
      const naverFeeAmt = naverSellPrice * naverFeeRate;
      const naverProfit = (naverSellPrice - costPerUnit - naverFeeAmt) * quantity;

      document.getElementById('naverPrice').textContent = formatNum(naverSellPrice) + 'ì›';
      document.getElementById('naverFeeAmt').textContent = formatNum(naverFeeAmt * quantity) + 'ì›';
      document.getElementById('naverCost').textContent = formatNum(grandTotal) + 'ì›';
      document.getElementById('naverProfit').textContent = '+' + formatNum(naverProfit) + 'ì›';
      document.getElementById('naverProfit').className = 'profit-value ' + (naverProfit >= 0 ? 'positive' : 'negative');

      // ì¿ íŒ¡ ê¶Œì¥ê°€
      const coupangSellPrice = costPerUnit / (1 - coupangFeeRate - marginDecimal);
      const coupangFeeAmt = coupangSellPrice * coupangFeeRate;
      const coupangProfit = (coupangSellPrice - costPerUnit - coupangFeeAmt) * quantity;

      document.getElementById('coupangPrice').textContent = formatNum(coupangSellPrice) + 'ì›';
      document.getElementById('coupangFeeAmt').textContent = formatNum(coupangFeeAmt * quantity) + 'ì›';
      document.getElementById('coupangCost').textContent = formatNum(grandTotal) + 'ì›';
      document.getElementById('coupangProfit').textContent = '+' + formatNum(coupangProfit) + 'ì›';
      document.getElementById('coupangProfit').className = 'profit-value ' + (coupangProfit >= 0 ? 'positive' : 'negative');

      // ì „ì—­ ì €ì¥
      window.calcResult = {
        naverPrice: Math.round(naverSellPrice),
        coupangPrice: Math.round(coupangSellPrice),
        costPerUnit,
        grandTotal
      };
    }

    // === ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ===
    function previewImage() {
      const url = document.getElementById('newImageUrl').value.trim();
      const preview = document.getElementById('imagePreview');
      if (url) {
        preview.innerHTML = `<img src="${url}" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentElement.innerHTML='<span style=\\'font-size:10px; color:#ef4444;\\'>ë¡œë“œì‹¤íŒ¨</span>'">`;
      } else {
        preview.innerHTML = '<span style="font-size:10px; color:#94a3b8;">ë¯¸ë¦¬ë³´ê¸°</span>';
      }
    }

    function previewEditImage() {
      const url = document.getElementById('editImageUrl').value.trim();
      const preview = document.getElementById('editImagePreview');
      if (url) {
        preview.innerHTML = `<img src="${url}" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentElement.innerHTML='<span style=\\'font-size:10px; color:#ef4444;\\'>ë¡œë“œì‹¤íŒ¨</span>'">`;
      } else {
        preview.innerHTML = '<span style="font-size:10px; color:#94a3b8;">ë¯¸ë¦¬ë³´ê¸°</span>';
      }
    }

    // === ìƒí’ˆ ì¶”ê°€ ===
    async function addProduct(platform) {
      const name = document.getElementById('newName').value.trim();
      const cnyPrice = parseFloat(document.getElementById('newCnyPrice').value);
      if (!name || !cnyPrice) {
        alert('ìƒí’ˆëª…ê³¼ ì›ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const product = {
        id: crypto.randomUUID(),
        name,
        category: document.getElementById('newCategory').value.trim() || 'ë¯¸ë¶„ë¥˜',
        cnyPrice,
        sellPrice: window.calcResult[platform + 'Price'],
        quantity: parseInt(document.getElementById('newQuantity').value) || 1,
        stock: 0,
        platform,
        saleType,
        hsCode: selectedHsCode,
        dutyRate: selectedDutyRate,
        link: document.getElementById('newLink').value.trim(),
        imageUrl: document.getElementById('newImageUrl').value.trim(),
        createdAt: new Date().toISOString()
      };

      const success = await saveProductToServer(product);
      if (success) {
        products.push(product);
        renderTable();
        updateCategoryFilter();

        // ì…ë ¥ ì´ˆê¸°í™”
        document.getElementById('newName').value = '';
        document.getElementById('newCnyPrice').value = '';
        document.getElementById('newImageUrl').value = '';
        document.getElementById('imagePreview').innerHTML = '<span style="font-size:10px; color:#94a3b8;">ë¯¸ë¦¬ë³´ê¸°</span>';
        document.getElementById('hsRecommendBox').style.display = 'none';
        alert('ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
      } else {
        alert('ìƒí’ˆ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // === í…Œì´ë¸” ë Œë”ë§ ===
    function renderTable() {
      const platformFilter = document.getElementById('filterPlatform').value;
      const categoryFilter = document.getElementById('filterCategory').value;

      let filtered = products;
      if (platformFilter !== 'all') filtered = filtered.filter(p => p.platform === platformFilter);
      if (categoryFilter !== 'all') filtered = filtered.filter(p => p.category === categoryFilter);

      const tbody = document.getElementById('productTableBody');
      tbody.innerHTML = filtered.map(p => {
        const costKrw = p.cnyPrice * exchangeRate;
        const marginRate = p.sellPrice > 0 ? ((p.sellPrice - costKrw) / p.sellPrice * 100).toFixed(1) : 0;
        const date = new Date(p.createdAt).toLocaleDateString('ko-KR');
        const imgHtml = p.imageUrl
          ? `<img src="${p.imageUrl}" style="width:40px; height:40px; object-fit:cover; border-radius:4px;" onerror="this.style.display='none'">`
          : '<span style="color:#cbd5e1;">-</span>';

        return `
          <tr>
            <td>${imgHtml}</td>
            <td><span class="badge badge-${p.platform}">${p.platform === 'naver' ? 'ë„¤ì´ë²„' : 'ì¿ íŒ¡'}</span></td>
            <td><span class="badge badge-${p.saleType}">${p.saleType === 'import' ? 'ìˆ˜ì…' : 'ëŒ€í–‰'}</span></td>
            <td class="text-left">${p.name}</td>
            <td>${p.cnyPrice}Â¥</td>
            <td>${formatNum(p.sellPrice)}ì›</td>
            <td style="color:${marginRate >= 30 ? '#16a34a' : '#dc2626'}">${marginRate}%</td>
            <td>
              <input type="number" class="stock-input" value="${p.stock || 0}"
                onchange="updateStock('${p.id}', this.value)">
            </td>
            <td style="font-size:10px;">${date}</td>
            <td>
              <button class="btn btn-sm btn-secondary" onclick="openEditModal('${p.id}')">ìˆ˜ì •</button>
              <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p.id}')">ì‚­ì œ</button>
            </td>
          </tr>
        `;
      }).join('');

      // ìš”ì•½
      const totalValue = filtered.reduce((sum, p) => sum + (p.sellPrice * (p.stock || 0)), 0);
      document.getElementById('listSummary').textContent =
        `ì´ ${filtered.length}ê°œ ìƒí’ˆ | ì¬ê³  ì´ ê°€ì¹˜: ${formatNum(totalValue)}ì›`;
    }

    // === ì¬ê³  ì—…ë°ì´íŠ¸ ===
    async function updateStock(id, newStock) {
      const product = products.find(p => p.id === id);
      if (!product) return;

      const success = await updateStockOnServer(id, newStock);
      if (success) {
        product.stock = parseInt(newStock);
        loadSalesLogs(); // ë¡œê·¸ ìƒˆë¡œê³ ì¹¨
      }
    }

    function renderSalesLog() {
      const container = document.getElementById('salesLog');
      if (salesLogs.length === 0) {
        container.innerHTML = '<div style="color:#94a3b8; text-align:center; padding:20px;">ì¬ê³  ë³€ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      const recent = salesLogs.slice(-20).reverse();
      container.innerHTML = recent.map(log => {
        const date = new Date(log.date).toLocaleDateString('ko-KR');
        const changeText = log.change > 0 ? `+${log.change} (ì…ê³ )` : `${log.change} (ì¶œê³ /íŒë§¤)`;
        const color = log.change > 0 ? '#16a34a' : '#dc2626';
        return `
          <div class="sales-log-item">
            <span>${log.productName}</span>
            <span style="color:${color}">${changeText}</span>
            <span style="color:#94a3b8">${date}</span>
          </div>
        `;
      }).join('');
    }

    // === ìˆ˜ì • ëª¨ë‹¬ ===
    function openEditModal(id) {
      const product = products.find(p => p.id === id);
      if (!product) return;

      document.getElementById('editId').value = id;
      document.getElementById('editName').value = product.name;
      document.getElementById('editCategory').value = product.category;
      document.getElementById('editCnyPrice').value = product.cnyPrice;
      document.getElementById('editSellPrice').value = product.sellPrice;
      document.getElementById('editImageUrl').value = product.imageUrl || '';
      // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
      const preview = document.getElementById('editImagePreview');
      if (product.imageUrl) {
        preview.innerHTML = `<img src="${product.imageUrl}" style="width:100%; height:100%; object-fit:cover;">`;
      } else {
        preview.innerHTML = '<span style="font-size:10px; color:#94a3b8;">ë¯¸ë¦¬ë³´ê¸°</span>';
      }
      document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
    }

    async function saveEdit() {
      const id = document.getElementById('editId').value;
      const product = products.find(p => p.id === id);
      if (!product) return;

      const updatedData = {
        name: document.getElementById('editName').value,
        category: document.getElementById('editCategory').value,
        cnyPrice: parseFloat(document.getElementById('editCnyPrice').value),
        sellPrice: parseInt(document.getElementById('editSellPrice').value),
        stock: product.stock,
        imageUrl: document.getElementById('editImageUrl').value.trim()
      };

      const success = await updateProductOnServer(id, updatedData);
      if (success) {
        Object.assign(product, updatedData);
        renderTable();
        updateCategoryFilter();
        closeEditModal();
      } else {
        alert('ìƒí’ˆ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // === ì‚­ì œ ===
    async function deleteProduct(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      const success = await deleteProductOnServer(id);
      if (success) {
        products = products.filter(p => p.id !== id);
        renderTable();
        updateCategoryFilter();
      } else {
        alert('ìƒí’ˆ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function clearAll() {
      if (!confirm('ì „ì²´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      // ëª¨ë“  ìƒí’ˆì„ í•˜ë‚˜ì”© ì‚­ì œ
      for (const p of products) {
        await deleteProductOnServer(p.id);
      }
      products = [];
      renderTable();
    }

    // === ì¹´í…Œê³ ë¦¬ í•„í„° ì—…ë°ì´íŠ¸ ===
    function updateCategoryFilter() {
      const categories = [...new Set(products.map(p => p.category))];
      const select = document.getElementById('filterCategory');
      select.innerHTML = '<option value="all">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>' +
        categories.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    // === API í˜¸ì¶œ ===
    async function loadProducts() {
      try {
        const res = await fetch('/api/products');
        const data = await res.json();
        if (data.ok) {
          products = data.products;
          renderTable();
          updateCategoryFilter();
        }
      } catch (e) {
        console.error('ìƒí’ˆ ë¡œë“œ ì‹¤íŒ¨:', e);
      }
    }

    async function loadSalesLogs() {
      try {
        const res = await fetch('/api/products/sales-logs');
        const data = await res.json();
        if (data.ok) {
          salesLogs = data.logs;
          renderSalesLog();
        }
      } catch (e) {
        console.error('ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨:', e);
      }
    }

    async function saveProductToServer(product) {
      try {
        const res = await fetch('/api/products', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(product)
        });
        const data = await res.json();
        return data.ok;
      } catch (e) {
        console.error('ìƒí’ˆ ì €ì¥ ì‹¤íŒ¨:', e);
        return false;
      }
    }

    async function updateProductOnServer(id, product) {
      try {
        const res = await fetch(`/api/products/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(product)
        });
        const data = await res.json();
        return data.ok;
      } catch (e) {
        console.error('ìƒí’ˆ ìˆ˜ì • ì‹¤íŒ¨:', e);
        return false;
      }
    }

    async function deleteProductOnServer(id) {
      try {
        const res = await fetch(`/api/products/${id}`, { method: 'DELETE' });
        const data = await res.json();
        return data.ok;
      } catch (e) {
        console.error('ìƒí’ˆ ì‚­ì œ ì‹¤íŒ¨:', e);
        return false;
      }
    }

    async function updateStockOnServer(id, stock) {
      try {
        const res = await fetch(`/api/products/${id}/stock`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ stock: parseInt(stock) })
        });
        const data = await res.json();
        return data.ok;
      } catch (e) {
        console.error('ì¬ê³  ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e);
        return false;
      }
    }

    // === ìœ í‹¸ ===
    function formatNum(n) {
      return Math.round(n).toLocaleString('ko-KR');
    }

    // ì´ˆê¸°í™”
    init();
  </script>
</body>
</html>
