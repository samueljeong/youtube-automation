<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì„¤êµ ë„ì›€ í˜ì´ì§€</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #f5f5f5; }
    .page-wrap { display: flex; gap: 1rem; padding: 1rem; height: 100vh; }
    .left-col { width: 360px; display: flex; flex-direction: column; gap: .75rem; overflow-y: auto; }
    .right-col { flex: 1; display: flex; flex-direction: column; gap: .75rem; min-width: 0; overflow-y: auto; }
    .box { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: .75rem; }
    .label-row { display: flex; justify-content: space-between; align-items: center; gap: .5rem; margin-bottom: .35rem; }
    .label { font-weight: 600; }
    input[type="text"], input[type="date"], input[type="password"], select { width: 100%; padding: .35rem .5rem; }
    textarea { width: 100%; min-height: 80px; resize: vertical; font-family: inherit; line-height: 1.4; }
    .btn-row { display: flex; gap: .5rem; flex-wrap: wrap; }
    button { padding: .35rem .6rem; border: 1px solid #ccc; background: #f0f0f0; border-radius: 6px; cursor: pointer; }
    button:hover { background: #e0e0e0; }
    button.primary { background: #4a90e2; color: white; border-color: #4a90e2; }
    button.primary:hover { background: #357abd; }
    button.danger { background: #e74c3c; color: white; border-color: #e74c3c; }
    button.danger:hover { background: #c0392b; }
    button.step-btn { width: 100%; margin-bottom: .5rem; position: relative; }
    button.step-btn::before { content: attr(data-order) ". "; font-weight: 600; }
    
    .storage-item, .type-item, .step-item { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: .4rem .6rem; 
      margin-bottom: .3rem;
      background: #f8f9fa;
      border-radius: 6px;
    }
    .type-item { cursor: pointer; transition: all 0.2s; }
    .type-item:hover { background: #e9ecef; }
    .type-item.active { background: #dfe6ff; border: 1px solid #4a90e2; }
    .storage-item:last-child { border-bottom: none; }
    .storage-actions button, .item-actions button { font-size: .7rem; padding: .25rem .45rem; }
    
    .toggle-header { display: flex; justify-content: space-between; align-items: center; }
    .copy-btn { font-size: .7rem; padding: .2rem .5rem; background: #fff; }
    .status-bar { position: fixed; bottom: 10px; right: 10px; background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: .4rem .7rem; font-size: .8rem; box-shadow: 0 2px 6px rgba(0,0,0,.08); display: none; z-index: 1000; }
    .guide-tab { padding: .35rem .7rem; margin-right: .3rem; margin-bottom: .3rem; display: inline-block; }
    .guide-tab-active { background: #dfe6ff; border-color: #b5c6ff; }
    textarea.autosize { overflow: hidden; }
    
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem; }
    .modal-buttons { display: flex; gap: .5rem; margin-top: 1rem; }
    .modal-buttons button { flex: 1; }
    
    .step-order-controls { display: flex; gap: .3rem; }
    .step-order-controls button { padding: .2rem .4rem; font-size: .7rem; }
  </style>
</head>
<body>
  <div class="page-wrap">
    <!-- ì™¼ìª½ -->
    <div class="left-col">
      <!-- ë‚ ì§œ -->
      <div class="box">
        <div class="label-row">
          <label class="label" for="sermon-date">ë‚ ì§œ</label>
          <input type="date" id="sermon-date" style="max-width: 160px;">
        </div>
      </div>

      <!-- ì¹´í…Œê³ ë¦¬ -->
      <div class="box">
        <div class="label-row">
          <label class="label" for="sermon-category">ì„¤êµ ì¹´í…Œê³ ë¦¬</label>
          <button id="btn-manage-categories" style="font-size: .75rem; padding: .2rem .5rem;">ê´€ë¦¬</button>
        </div>
        <select id="sermon-category"></select>
      </div>

      <!-- ì‹œë¦¬ì¦ˆëª… -->
      <div class="box" id="series-box" style="display: none;">
        <label class="label">ì‹œë¦¬ì¦ˆëª…</label>
        <input type="text" id="series-name" placeholder="ì˜ˆ: ìš”í•œë³µìŒ ì‹œë¦¬ì¦ˆ">
      </div>

      <!-- ì„±ê²½êµ¬ì ˆ -->
      <div class="box">
        <label class="label">ì„±ê²½êµ¬ì ˆ</label>
        <input type="text" id="sermon-ref" placeholder="ì˜ˆ) ì‹œ 78:1-8">
      </div>

      <!-- ì„±ê²½ ë³¸ë¬¸ -->
      <div class="box">
        <label class="label">ì„±ê²½ ë³¸ë¬¸ (ì„ íƒì‚¬í•­)</label>
        <textarea id="sermon-text" class="autosize" placeholder="ë³¸ë¬¸ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
      </div>

      <!-- ì²˜ë¦¬ ë‹¨ê³„ -->
      <div class="box">
        <div class="label-row">
          <label class="label">ì²˜ë¦¬ ë‹¨ê³„</label>
          <button id="btn-manage-steps" style="font-size: .75rem; padding: .2rem .5rem;">ê´€ë¦¬</button>
        </div>
        <div id="processing-steps"></div>
      </div>

      <!-- ì„¤êµ ìœ í˜• -->
      <div class="box">
        <div class="label-row">
          <label class="label">ì„¤êµ ìœ í˜•</label>
          <button id="btn-manage-prompt-types" style="font-size: .75rem; padding: .2rem .5rem;">ê´€ë¦¬</button>
        </div>
        <div id="prompt-types-list"></div>
      </div>

      <!-- ì €ì¥ ê³µê°„ -->
      <div class="box">
        <label class="label">ì €ì¥ëœ ì„¤êµ ìë£Œ</label>
        <button id="btn-save" style="width: 100%; margin-bottom: .5rem;">í˜„ì¬ ë‚´ìš© ì €ì¥</button>
        <div id="saved-list"></div>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½ -->
    <div class="right-col">
      <!-- ì „ì²´ ë³µì‚¬ ë²„íŠ¼ -->
      <div class="box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="color: white; font-weight: 600; font-size: 1.1rem; margin-bottom: .3rem;">ğŸ“‹ ì™„ì„±ëœ ì„¤êµ ìë£Œ</div>
            <div style="color: rgba(255,255,255,0.9); font-size: .85rem;">ëª¨ë“  ë‹¨ê³„ë¥¼ ìˆœì„œëŒ€ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤</div>
          </div>
          <button id="btn-copy-all" style="background: white; color: #667eea; font-weight: 600; padding: .6rem 1.2rem; border: none; font-size: .95rem;">ì „ì²´ ë³µì‚¬</button>
        </div>
      </div>

      <!-- ì§€ì¹¨ ì˜ì—­ -->
      <div class="box" id="guide-box">
        <div class="toggle-header">
          <span class="label">ì§€ì¹¨ ì˜ì—­ ğŸ”’</span>
          <button id="toggle-guides">ì—´ê¸°</button>
        </div>
        <div id="guide-content" style="display: none;">
          <div class="btn-row" style="margin-bottom: .5rem;">
            <button id="save-guide" class="primary">ì§€ì¹¨ ì €ì¥</button>
          </div>
          <div id="guide-tabs" class="btn-row" style="margin-bottom: .5rem;"></div>
          <div id="current-guide-info" style="font-size: .85rem; color: #666; margin-bottom: .5rem;"></div>
          <textarea id="guide-text" class="autosize" style="min-height: 90px;" placeholder="ì§€ì¹¨ì„ ì‘ì„±í•˜ì„¸ìš”."></textarea>
        </div>
      </div>

      <!-- ë™ì  ê²°ê³¼ ë°•ìŠ¤ë“¤ -->
      <div id="result-boxes"></div>
    </div>
  </div>

  <!-- ìƒíƒœ í‘œì‹œ -->
  <div id="status-bar" class="status-bar">ì‘ì—… ì¤‘...</div>

  <!-- íŒ¨ìŠ¤ì›Œë“œ ëª¨ë‹¬ -->
  <div id="modal-password" class="modal">
    <div class="modal-content">
      <div class="modal-title">ğŸ”’ ì§€ì¹¨ ì˜ì—­ ì ê¸ˆ</div>
      <p style="color: #666; font-size: .9rem; margin-bottom: 1rem;">ì§€ì¹¨ ì˜ì—­ì— ì ‘ê·¼í•˜ë ¤ë©´ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="password" id="password-input" placeholder="íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥" style="margin-bottom: .5rem;">
      <div class="modal-buttons">
        <button id="btn-cancel-password">ì·¨ì†Œ</button>
        <button id="btn-submit-password" class="primary">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="modal-categories" class="modal">
    <div class="modal-content">
      <div class="modal-title">ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</div>
      <input type="text" id="new-cat-value" placeholder="ì˜ë¬¸ ì½”ë“œ (ì˜ˆ: special)" style="margin-bottom: .3rem;">
      <input type="text" id="new-cat-label" placeholder="í‘œì‹œ ì´ë¦„ (ì˜ˆ: íŠ¹ë³„ì˜ˆë°°)" style="margin-bottom: .5rem;">
      <button id="btn-add-category" class="primary" style="width: 100%; margin-bottom: 1rem;">ì¶”ê°€</button>
      <div id="categories-list" style="max-height: 300px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button id="btn-close-categories">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì²˜ë¦¬ ë‹¨ê³„ ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="modal-steps" class="modal">
    <div class="modal-content">
      <div class="modal-title">ì²˜ë¦¬ ë‹¨ê³„ ê´€ë¦¬</div>
      <p style="font-size: .85rem; color: #666; margin-bottom: .5rem;">ì¹´í…Œê³ ë¦¬: <strong id="modal-steps-category"></strong></p>
      <input type="text" id="new-step-id" placeholder="ì˜ë¬¸ ID (ì˜ˆ: questions)" style="margin-bottom: .3rem;">
      <input type="text" id="new-step-name" placeholder="í‘œì‹œ ì´ë¦„ (ì˜ˆ: ì§ˆë¬¸ ìƒì„±)" style="margin-bottom: .5rem;">
      <button id="btn-add-step" class="primary" style="width: 100%; margin-bottom: 1rem;">ì¶”ê°€</button>
      <div id="steps-list" style="max-height: 300px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button id="btn-close-steps">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì„¤êµ ìœ í˜• ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="modal-prompt-types" class="modal">
    <div class="modal-content">
      <div class="modal-title">ì„¤êµ ìœ í˜• ê´€ë¦¬</div>
      <p style="font-size: .85rem; color: #666; margin-bottom: .5rem;">ì¹´í…Œê³ ë¦¬: <strong id="modal-types-category"></strong></p>
      <input type="text" id="new-prompt-type" placeholder="ìœ í˜• ì´ë¦„ (ì˜ˆ: ê°•í•´ì„¤êµv2)" style="margin-bottom: .5rem;">
      <button id="btn-add-prompt-type" class="primary" style="width: 100%; margin-bottom: 1rem;">ì¶”ê°€</button>
      <div id="prompt-types-manage-list" style="max-height: 300px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button id="btn-close-prompt-types">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  
  <script>
  // ===== Firebase ì´ˆê¸°í™” =====
  const firebaseConfig = {
    apiKey: "AIzaSyBacmJDk-PG5FaoqnXV8Rg3P__AKOS2vu4",
    authDomain: "my-sermon-guides.firebaseapp.com",
    projectId: "my-sermon-guides",
    storageBucket: "my-sermon-guides.firebasestorage.app",
    messagingSenderId: "539520456089",
    appId: "1:539520456089:web:d6aceb7838baa89e70af08",
    measurementId: "G-KWN8TH7Z26"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  
  const USER_CODE = 'samuel123';
  const PAGE_NAME = 'sermon';
  const GUIDE_PASSWORD = '5555';
  const CONFIG_KEY = '_sermon-config';

  // ===== ì „ì—­ ë³€ìˆ˜ =====
  let guideUnlocked = false;
  let currentCategory = 'dawn';
  let currentPromptType = 'ê¸°ë³¸';
  let currentGuideStep = '';
  let stepResults = {}; // {stepId: result}

  // ê¸°ë³¸ ì„¤ì •
  let config = {
    categories: [
      {value: "dawn", label: "ìƒˆë²½ì„¤êµ"},
      {value: "wednesday", label: "ìˆ˜ìš”ì„±ê²½ê³µë¶€"},
      {value: "friday", label: "ê¸ˆìš”ê¸°ë„íšŒ"},
      {value: "youth", label: "ì²­ë…„ë¶€"}
    ],
    categorySettings: {
      dawn: {
        promptTypes: ["ê¸°ë³¸", "ê°•í•´ì„¤êµ", "ì£¼ì œì„¤êµ"],
        steps: [
          {id: "analysis", name: "ë³¸ë¬¸ ë¶„ì„", order: 1},
          {id: "prompt", name: "ì„¤êµë¬¸ í”„ë¡¬í”„íŠ¸", order: 2}
        ]
      },
      wednesday: {
        promptTypes: ["ì‹œë¦¬ì¦ˆí˜•", "ê°•í•´í˜•"],
        steps: [
          {id: "analysis", name: "ë³¸ë¬¸ ë¶„ì„", order: 1},
          {id: "prompt", name: "ì„¤êµë¬¸ í”„ë¡¬í”„íŠ¸", order: 2}
        ]
      },
      friday: {
        promptTypes: ["ê¸°ë³¸", "ê¸°ë„ ì¤‘ì‹¬"],
        steps: [
          {id: "analysis", name: "ë³¸ë¬¸ ë¶„ì„", order: 1},
          {id: "prompt", name: "ì„¤êµë¬¸ í”„ë¡¬í”„íŠ¸", order: 2}
        ]
      },
      youth: {
        promptTypes: ["ì‹¤ì²œí˜•", "í† ë¡ í˜•"],
        steps: [
          {id: "analysis", name: "ë³¸ë¬¸ ë¶„ì„", order: 1},
          {id: "prompt", name: "ì„¤êµë¬¸ í”„ë¡¬í”„íŠ¸", order: 2}
        ]
      }
    }
  };

  // ===== ìœ í‹¸ë¦¬í‹° =====
  function showStatus(msg) {
    document.getElementById('status-bar').textContent = msg;
    document.getElementById('status-bar').style.display = 'block';
  }
  
  function hideStatus() {
    document.getElementById('status-bar').style.display = 'none';
  }

  function autoResize(el) {
    if (!el) return;
    el.style.height = 'auto';
    el.style.height = el.scrollHeight + 'px';
  }

  // ===== Firebase í•¨ìˆ˜ =====
  async function loadFromFirebase() {
    try {
      const snapshot = await db.collection('users').doc(USER_CODE).collection(PAGE_NAME).get();
      
      if (!snapshot.empty) {
        snapshot.forEach(doc => {
          localStorage.setItem(doc.id, doc.data().value);
        });
        
        const configData = localStorage.getItem(CONFIG_KEY);
        if (configData) {
          config = JSON.parse(configData);
        }
        console.log('âœ… Firebase ë™ê¸°í™” ì™„ë£Œ');
        return true;
      }
      return false;
    } catch (err) {
      console.error('Firebase ë¡œë“œ ì‹¤íŒ¨:', err);
      return false;
    }
  }

  async function saveToFirebase(key, value) {
    try {
      await db.collection('users').doc(USER_CODE).collection(PAGE_NAME).doc(key).set({
        value: value,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      return true;
    } catch (err) {
      console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', err);
      return false;
    }
  }

  async function saveConfig() {
    const configStr = JSON.stringify(config);
    localStorage.setItem(CONFIG_KEY, configStr);
    await saveToFirebase(CONFIG_KEY, configStr);
  }

  // ===== ì§€ì¹¨ ê´€ë¦¬ =====
  function getGuideKey(category, stepId, promptType = null) {
    if (stepId === 'prompt' && promptType) {
      return `guide-${category}-${stepId}-${promptType}`;
    }
    return `guide-${category}-${stepId}`;
  }

  function loadGuide(category, stepId, promptType = null) {
    const key = getGuideKey(category, stepId, promptType);
    const stored = localStorage.getItem(key) || '';
    document.getElementById('guide-text').value = stored;
    autoResize(document.getElementById('guide-text'));
    
    let info = `ì¹´í…Œê³ ë¦¬: ${getCategoryLabel(category)} | ë‹¨ê³„: ${getStepName(category, stepId)}`;
    if (stepId === 'prompt' && promptType) {
      info += ` | ìœ í˜•: ${promptType}`;
    }
    document.getElementById('current-guide-info').textContent = info;
  }

  async function saveGuide() {
    const key = getGuideKey(currentCategory, currentGuideStep, 
      currentGuideStep === 'prompt' ? currentPromptType : null);
    const value = document.getElementById('guide-text').value;
    
    localStorage.setItem(key, value);
    
    showStatus('ğŸ’¾ ì €ì¥ ì¤‘...');
    const success = await saveToFirebase(key, value);
    
    if (success) {
      showStatus('âœ… ì§€ì¹¨ ì €ì¥ ì™„ë£Œ!');
    } else {
      showStatus('âš ï¸ ë¡œì»¬ì—ë§Œ ì €ì¥ë¨');
    }
    
    setTimeout(hideStatus, 2000);
  }

  // ===== í—¬í¼ í•¨ìˆ˜ =====
  function getCategoryLabel(value) {
    const cat = config.categories.find(c => c.value === value);
    return cat ? cat.label : value;
  }

  function getStepName(category, stepId) {
    const settings = config.categorySettings[category];
    if (!settings) return stepId;
    const step = settings.steps.find(s => s.id === stepId);
    return step ? step.name : stepId;
  }

  function getCurrentSteps() {
    const settings = config.categorySettings[currentCategory];
    return settings ? settings.steps.sort((a, b) => a.order - b.order) : [];
  }

  function getCurrentPromptTypes() {
    const settings = config.categorySettings[currentCategory];
    return settings ? settings.promptTypes : ['ê¸°ë³¸'];
  }

  // ===== ì „ì²´ ë³µì‚¬ ê¸°ëŠ¥ =====
  document.getElementById('btn-copy-all').addEventListener('click', () => {
    const steps = getCurrentSteps();
    const ref = document.getElementById('sermon-ref').value;
    const seriesName = document.getElementById('series-name').value;
    
    if (steps.length === 0) {
      alert('ì²˜ë¦¬ëœ ë‹¨ê³„ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    // ê²°ê³¼ê°€ ìˆëŠ” ë‹¨ê³„ë§Œ í•„í„°ë§
    const completedSteps = steps.filter(step => stepResults[step.id]);
    
    if (completedSteps.length === 0) {
      alert('ì™„ì„±ëœ ë‹¨ê³„ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê° ë‹¨ê³„ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    // ì „ì²´ í…ìŠ¤íŠ¸ êµ¬ì„±
    let fullText = `====================================\n`;
    fullText += `ğŸ“– ì„¤êµ ìë£Œ\n`;
    fullText += `====================================\n\n`;
    fullText += `ğŸ“Œ ê¸°ë³¸ ì •ë³´\n`;
    fullText += `- ì¹´í…Œê³ ë¦¬: ${getCategoryLabel(currentCategory)}\n`;
    fullText += `- ì„¤êµ ìœ í˜•: ${currentPromptType}\n`;
    fullText += `- ì„±ê²½êµ¬ì ˆ: ${ref}\n`;
    if (seriesName) {
      fullText += `- ì‹œë¦¬ì¦ˆëª…: ${seriesName}\n`;
    }
    fullText += `- ì‘ì„±ì¼: ${new Date().toLocaleDateString('ko-KR')}\n`;
    fullText += `\n${'='.repeat(50)}\n\n`;
    
    // ê° ë‹¨ê³„ ê²°ê³¼ ì¶”ê°€
    completedSteps.forEach((step, index) => {
      fullText += `ã€ ${index + 1}. ${step.name} ã€‘\n\n`;
      fullText += stepResults[step.id];
      fullText += `\n\n${'='.repeat(50)}\n\n`;
    });
    
    // í´ë¦½ë³´ë“œì— ë³µì‚¬
    const tempTextarea = document.createElement('textarea');
    tempTextarea.value = fullText;
    tempTextarea.style.position = 'fixed';
    tempTextarea.style.opacity = '0';
    document.body.appendChild(tempTextarea);
    tempTextarea.select();
    
    try {
      document.execCommand('copy');
      showStatus('âœ… ì „ì²´ ë‚´ìš©ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
      setTimeout(hideStatus, 2000);
    } catch (err) {
      alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err.message);
    } finally {
      document.body.removeChild(tempTextarea);
    }
  });

  // ===== ë Œë”ë§ í•¨ìˆ˜ =====
  function renderCategories() {
    const select = document.getElementById('sermon-category');
    const current = select.value;
    select.innerHTML = config.categories.map(c => 
      `<option value="${c.value}">${c.label}</option>`
    ).join('');
    
    if (current && config.categories.find(c => c.value === current)) {
      select.value = current;
    } else {
      select.value = config.categories[0].value;
    }
    currentCategory = select.value;
  }

  function renderProcessingSteps() {
    const steps = getCurrentSteps();
    const container = document.getElementById('processing-steps');
    
    container.innerHTML = steps.map(step => 
      `<button class="step-btn primary" data-step="${step.id}" data-order="${step.order}">${step.name}</button>`
    ).join('');
    
    container.querySelectorAll('.step-btn').forEach(btn => {
      btn.addEventListener('click', () => executeStep(btn.dataset.step));
    });
  }

  function renderPromptTypes() {
    const types = getCurrentPromptTypes();
    const container = document.getElementById('prompt-types-list');
    
    container.innerHTML = types.map(type => 
      `<div class="type-item ${type === currentPromptType ? 'active' : ''}" data-type="${type}">
        <span>${type}</span>
      </div>`
    ).join('');
    
    container.querySelectorAll('.type-item').forEach(item => {
      item.addEventListener('click', () => {
        currentPromptType = item.dataset.type;
        renderPromptTypes();
        if (currentGuideStep === 'prompt') {
          loadGuide(currentCategory, 'prompt', currentPromptType);
        }
      });
    });
  }

  function renderResultBoxes() {
    const steps = getCurrentSteps();
    const container = document.getElementById('result-boxes');
    
    container.innerHTML = steps.map(step => `
      <div class="box">
        <div class="toggle-header">
          <label class="label">${step.name}${step.id === 'prompt' ? ` (${currentPromptType})` : ''}</label>
          <button class="copy-btn" data-copy="result-${step.id}">ğŸ“‹ ë³µì‚¬</button>
        </div>
        <textarea id="result-${step.id}" class="autosize" style="min-height: 140px;" placeholder="${step.name} ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤." readonly></textarea>
      </div>
    `).join('');
    
    // ë³µì‚¬ ë²„íŠ¼
    container.querySelectorAll('[data-copy]').forEach(btn => {
      btn.addEventListener('click', () => {
        const textarea = document.getElementById(btn.dataset.copy);
        if (textarea && textarea.value) {
          textarea.select();
          document.execCommand('copy');
          const orig = btn.textContent;
          btn.textContent = 'âœ… ë³µì‚¬ë¨!';
          setTimeout(() => btn.textContent = orig, 1500);
        }
      });
    });
    
    // ê¸°ì¡´ ê²°ê³¼ ë³µì›
    steps.forEach(step => {
      if (stepResults[step.id]) {
        const textarea = document.getElementById(`result-${step.id}`);
        if (textarea) {
          textarea.value = stepResults[step.id];
          autoResize(textarea);
        }
      }
    });
  }

  function renderGuideTabs() {
    const steps = getCurrentSteps();
    const container = document.getElementById('guide-tabs');
    
    const tabs = [];
    steps.forEach(step => {
      if (step.id === 'prompt') {
        const types = getCurrentPromptTypes();
        types.forEach(type => {
          tabs.push({
            id: `${step.id}-${type}`,
            label: `${step.name} (${type})`,
            stepId: step.id,
            promptType: type
          });
        });
      } else {
        tabs.push({
          id: step.id,
          label: step.name,
          stepId: step.id,
          promptType: null
        });
      }
    });
    
    container.innerHTML = tabs.map(tab => 
      `<button class="guide-tab ${tab.stepId === currentGuideStep && (tab.stepId !== 'prompt' || tab.promptType === currentPromptType) ? 'guide-tab-active' : ''}" 
        data-step="${tab.stepId}" data-type="${tab.promptType || ''}">${tab.label}</button>`
    ).join('');
    
    container.querySelectorAll('.guide-tab').forEach(btn => {
      btn.addEventListener('click', () => {
        currentGuideStep = btn.dataset.step;
        if (btn.dataset.type) {
          currentPromptType = btn.dataset.type;
        }
        renderGuideTabs();
        loadGuide(currentCategory, currentGuideStep, 
          currentGuideStep === 'prompt' ? currentPromptType : null);
      });
    });
  }

  // ===== ì²˜ë¦¬ ë‹¨ê³„ ì‹¤í–‰ =====
  async function executeStep(stepId) {
    const ref = document.getElementById('sermon-ref').value;
    if (!ref) {
      alert('ì„±ê²½êµ¬ì ˆì„ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    const text = document.getElementById('sermon-text').value;
    const guideKey = getGuideKey(currentCategory, stepId, 
      stepId === 'prompt' ? currentPromptType : null);
    const guide = localStorage.getItem(guideKey) || '';
    
    // ì´ì „ ë‹¨ê³„ ê²°ê³¼ë“¤ ìˆ˜ì§‘
    const steps = getCurrentSteps();
    const currentStepIndex = steps.findIndex(s => s.id === stepId);
    const previousResults = {};
    for (let i = 0; i < currentStepIndex; i++) {
      const prevStep = steps[i];
      if (stepResults[prevStep.id]) {
        previousResults[prevStep.id] = {
          name: prevStep.name,
          result: stepResults[prevStep.id]
        };
      }
    }
    
    showStatus(`ğŸ¤– ${getStepName(currentCategory, stepId)} ì²˜ë¦¬ ì¤‘...`);
    
    try {
      const response = await fetch('/api/sermon/process', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          category: currentCategory,
          stepId: stepId,
          reference: ref,
          text: text,
          guide: guide,
          promptType: stepId === 'prompt' ? currentPromptType : null,
          previousResults: previousResults
        })
      });
      
      const data = await response.json();
      
      if (data.ok) {
        stepResults[stepId] = data.result;
        const textarea = document.getElementById(`result-${stepId}`);
        if (textarea) {
          textarea.value = data.result;
          autoResize(textarea);
        }
        showStatus('âœ… ì™„ë£Œ!');
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
        showStatus('âŒ ì‹¤íŒ¨');
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
      showStatus('âŒ ì˜¤ë¥˜');
    } finally {
      setTimeout(hideStatus, 2000);
    }
  }

  // ===== ì¹´í…Œê³ ë¦¬ ë³€ê²½ =====
  document.getElementById('sermon-category').addEventListener('change', (e) => {
    currentCategory = e.target.value;
    currentPromptType = getCurrentPromptTypes()[0];
    stepResults = {};
    
    renderProcessingSteps();
    renderPromptTypes();
    renderResultBoxes();
    renderGuideTabs();
    
    if (currentCategory === 'wednesday') {
      document.getElementById('series-box').style.display = 'block';
    } else {
      document.getElementById('series-box').style.display = 'none';
    }
  });

  // ===== íŒ¨ìŠ¤ì›Œë“œ =====
  document.getElementById('toggle-guides').addEventListener('click', () => {
    const content = document.getElementById('guide-content');
    const btn = document.getElementById('toggle-guides');
    
    if (content.style.display === 'none') {
      if (!guideUnlocked) {
        document.getElementById('modal-password').classList.add('show');
        document.getElementById('password-input').value = '';
        document.getElementById('password-input').focus();
      } else {
        content.style.display = 'block';
        btn.textContent = 'ë‹«ê¸°';
      }
    } else {
      content.style.display = 'none';
      btn.textContent = 'ì—´ê¸°';
    }
  });

  document.getElementById('btn-submit-password').addEventListener('click', () => {
    if (document.getElementById('password-input').value === GUIDE_PASSWORD) {
      guideUnlocked = true;
      document.getElementById('modal-password').classList.remove('show');
      document.getElementById('guide-content').style.display = 'block';
      document.getElementById('toggle-guides').textContent = 'ë‹«ê¸°';
      
      // ì²« ì§€ì¹¨ íƒ­ ì„ íƒ
      const steps = getCurrentSteps();
      if (steps.length > 0) {
        currentGuideStep = steps[0].id;
        renderGuideTabs();
        loadGuide(currentCategory, currentGuideStep);
      }
    } else {
      alert('âŒ íŒ¨ìŠ¤ì›Œë“œê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
      document.getElementById('password-input').value = '';
    }
  });

  document.getElementById('btn-cancel-password').addEventListener('click', () => {
    document.getElementById('modal-password').classList.remove('show');
  });

  document.getElementById('password-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') document.getElementById('btn-submit-password').click();
  });

  // ===== ì§€ì¹¨ ì €ì¥ =====
  document.getElementById('save-guide').addEventListener('click', saveGuide);

  // ===== ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ =====
  document.getElementById('btn-manage-categories').addEventListener('click', () => {
    const list = document.getElementById('categories-list');
    list.innerHTML = config.categories.map((cat, idx) => `
      <div class="storage-item">
        <div>
          <div style="font-weight: 600;">${cat.label}</div>
          <div style="font-size: .75rem; color: #666;">${cat.value}</div>
        </div>
        ${config.categories.length > 1 ? `<button class="danger" onclick="deleteCategory(${idx})">ì‚­ì œ</button>` : ''}
      </div>
    `).join('');
    document.getElementById('modal-categories').classList.add('show');
  });

  document.getElementById('btn-close-categories').addEventListener('click', () => {
    document.getElementById('modal-categories').classList.remove('show');
  });

  document.getElementById('btn-add-category').addEventListener('click', async () => {
    const value = document.getElementById('new-cat-value').value.trim();
    const label = document.getElementById('new-cat-label').value.trim();
    
    if (!value || !label) {
      alert('ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }
    
    if (config.categories.find(c => c.value === value)) {
      alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.');
      return;
    }
    
    config.categories.push({value, label});
    config.categorySettings[value] = {
      promptTypes: ['ê¸°ë³¸'],
      steps: [
        {id: 'analysis', name: 'ë³¸ë¬¸ ë¶„ì„', order: 1},
        {id: 'prompt', name: 'ì„¤êµë¬¸ í”„ë¡¬í”„íŠ¸', order: 2}
      ]
    };
    
    await saveConfig();
    renderCategories();
    document.getElementById('btn-manage-categories').click();
    document.getElementById('new-cat-value').value = '';
    document.getElementById('new-cat-label').value = '';
  });

  window.deleteCategory = async function(idx) {
    if (!confirm(`"${config.categories[idx].label}" ì‚­ì œ?`)) return;
    const value = config.categories[idx].value;
    config.categories.splice(idx, 1);
    delete config.categorySettings[value];
    await saveConfig();
    renderCategories();
    document.getElementById('btn-manage-categories').click();
  };

  // ===== ì²˜ë¦¬ ë‹¨ê³„ ê´€ë¦¬ =====
  document.getElementById('btn-manage-steps').addEventListener('click', () => {
    document.getElementById('modal-steps-category').textContent = getCategoryLabel(currentCategory);
    const steps = getCurrentSteps();
    const list = document.getElementById('steps-list');
    
    list.innerHTML = steps.map((step, idx) => `
      <div class="step-item">
        <span>${step.order}. ${step.name}</span>
        <div class="step-order-controls">
          ${idx > 0 ? `<button onclick="moveStep(${idx}, -1)">â†‘</button>` : ''}
          ${idx < steps.length - 1 ? `<button onclick="moveStep(${idx}, 1)">â†“</button>` : ''}
          ${steps.length > 1 ? `<button class="danger" onclick="deleteStep(${idx})">ì‚­ì œ</button>` : ''}
        </div>
      </div>
    `).join('');
    
    document.getElementById('modal-steps').classList.add('show');
  });

  document.getElementById('btn-close-steps').addEventListener('click', () => {
    document.getElementById('modal-steps').classList.remove('show');
  });

  document.getElementById('btn-add-step').addEventListener('click', async () => {
    const id = document.getElementById('new-step-id').value.trim();
    const name = document.getElementById('new-step-name').value.trim();
    
    if (!id || !name) {
      alert('ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }
    
    const steps = getCurrentSteps();
    if (steps.find(s => s.id === id)) {
      alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” IDì…ë‹ˆë‹¤.');
      return;
    }
    
    const maxOrder = Math.max(...steps.map(s => s.order), 0);
    config.categorySettings[currentCategory].steps.push({
      id: id,
      name: name,
      order: maxOrder + 1
    });
    
    await saveConfig();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
    document.getElementById('btn-manage-steps').click();
    document.getElementById('new-step-id').value = '';
    document.getElementById('new-step-name').value = '';
  });

  window.moveStep = async function(idx, direction) {
    const steps = getCurrentSteps();
    const targetIdx = idx + direction;
    
    if (targetIdx < 0 || targetIdx >= steps.length) return;
    
    [steps[idx].order, steps[targetIdx].order] = [steps[targetIdx].order, steps[idx].order];
    
    await saveConfig();
    renderProcessingSteps();
    renderResultBoxes();
    document.getElementById('btn-manage-steps').click();
  };

  window.deleteStep = async function(idx) {
    const steps = getCurrentSteps();
    if (!confirm(`"${steps[idx].name}" ì‚­ì œ?`)) return;
    
    config.categorySettings[currentCategory].steps.splice(idx, 1);
    await saveConfig();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
    document.getElementById('btn-manage-steps').click();
  };

  // ===== ì„¤êµ ìœ í˜• ê´€ë¦¬ =====
  document.getElementById('btn-manage-prompt-types').addEventListener('click', () => {
    document.getElementById('modal-types-category').textContent = getCategoryLabel(currentCategory);
    const types = getCurrentPromptTypes();
    const list = document.getElementById('prompt-types-manage-list');
    
    list.innerHTML = types.map((type, idx) => `
      <div class="storage-item">
        <span>${type}</span>
        ${types.length > 1 ? `<button class="danger" onclick="deletePromptType(${idx})">ì‚­ì œ</button>` : ''}
      </div>
    `).join('');
    
    document.getElementById('modal-prompt-types').classList.add('show');
  });

  document.getElementById('btn-close-prompt-types').addEventListener('click', () => {
    document.getElementById('modal-prompt-types').classList.remove('show');
  });

  document.getElementById('btn-add-prompt-type').addEventListener('click', async () => {
    const name = document.getElementById('new-prompt-type').value.trim();
    
    if (!name) {
      alert('ìœ í˜• ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }
    
    const types = getCurrentPromptTypes();
    if (types.includes(name)) {
      alert('ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.');
      return;
    }
    
    config.categorySettings[currentCategory].promptTypes.push(name);
    await saveConfig();
    renderPromptTypes();
    renderGuideTabs();
    document.getElementById('btn-manage-prompt-types').click();
    document.getElementById('new-prompt-type').value = '';
  });

  window.deletePromptType = async function(idx) {
    const types = getCurrentPromptTypes();
    if (!confirm(`"${types[idx]}" ì‚­ì œ?`)) return;
    
    config.categorySettings[currentCategory].promptTypes.splice(idx, 1);
    if (currentPromptType === types[idx]) {
      currentPromptType = getCurrentPromptTypes()[0];
    }
    await saveConfig();
    renderPromptTypes();
    renderGuideTabs();
    document.getElementById('btn-manage-prompt-types').click();
  };

  // ===== ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° =====
  document.getElementById('btn-save').addEventListener('click', () => {
    const saved = JSON.parse(localStorage.getItem('sermon-saved') || '[]');
    saved.push({
      date: document.getElementById('sermon-date').value,
      category: currentCategory,
      seriesName: document.getElementById('series-name').value,
      ref: document.getElementById('sermon-ref').value,
      text: document.getElementById('sermon-text').value,
      promptType: currentPromptType,
      results: stepResults,
      savedAt: new Date().toISOString()
    });
    
    localStorage.setItem('sermon-saved', JSON.stringify(saved));
    renderSavedList();
    alert('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
  });

  function renderSavedList() {
    const saved = JSON.parse(localStorage.getItem('sermon-saved') || '[]');
    const list = document.getElementById('saved-list');
    
    if (saved.length === 0) {
      list.innerHTML = '<p style="color: #999; font-size: .8rem; text-align: center; padding: .5rem;">ì €ì¥ëœ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }
    
    list.innerHTML = saved.map((item, idx) => {
      const catLabel = getCategoryLabel(item.category);
      const display = item.seriesName 
        ? `${item.date} - ${catLabel} - ${item.seriesName}`
        : `${item.date} - ${catLabel}`;
      
      return `
        <div class="storage-item">
          <span style="font-size: .85rem;">${display}</span>
          <div class="storage-actions">
            <button onclick="loadSaved(${idx})">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button onclick="deleteSaved(${idx})">ì‚­ì œ</button>
          </div>
        </div>
      `;
    }).join('');
  }

  window.loadSaved = function(idx) {
    const saved = JSON.parse(localStorage.getItem('sermon-saved') || '[]');
    const item = saved[idx];
    
    document.getElementById('sermon-date').value = item.date || '';
    document.getElementById('sermon-category').value = item.category || 'dawn';
    document.getElementById('sermon-ref').value = item.ref || '';
    document.getElementById('sermon-text').value = item.text || '';
    document.getElementById('series-name').value = item.seriesName || '';
    
    currentCategory = item.category || 'dawn';
    currentPromptType = item.promptType || 'ê¸°ë³¸';
    stepResults = item.results || {};
    
    renderProcessingSteps();
    renderPromptTypes();
    renderResultBoxes();
    renderGuideTabs();
    
    document.querySelectorAll('textarea').forEach(autoResize);
  };

  window.deleteSaved = function(idx) {
    if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const saved = JSON.parse(localStorage.getItem('sermon-saved') || '[]');
    saved.splice(idx, 1);
    localStorage.setItem('sermon-saved', JSON.stringify(saved));
    renderSavedList();
  };

  // ===== textarea ìë™ ë†’ì´ =====
  document.querySelectorAll('textarea.autosize').forEach(textarea => {
    textarea.addEventListener('input', () => autoResize(textarea));
  });

  // ===== ì´ˆê¸°í™” =====
  document.addEventListener('DOMContentLoaded', async () => {
    document.getElementById('sermon-date').value = new Date().toISOString().split('T')[0];
    
    showStatus('â˜ï¸ í´ë¼ìš°ë“œ ë™ê¸°í™” ì¤‘...');
    await loadFromFirebase();
    hideStatus();
    
    renderCategories();
    renderProcessingSteps();
    renderPromptTypes();
    renderResultBoxes();
    renderGuideTabs();
    renderSavedList();
    
    document.querySelectorAll('textarea').forEach(autoResize);
  });
  </script>
</body>
</html>
