<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì„¤êµ ë„ì›€ í˜ì´ì§€</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #f5f5f5; }
    .page-wrap { display: flex; gap: 1rem; padding: 1rem; height: 100vh; box-sizing: border-box; }
    .left-col { width: 360px; display: flex; flex-direction: column; gap: .75rem; overflow-y: auto; }
    .right-col { flex: 1; display: flex; flex-direction: column; gap: .75rem; min-width: 0; overflow-y: auto; }
    .box { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: .75rem; }
    .label-row { display: flex; justify-content: space-between; align-items: center; gap: .5rem; margin-bottom: .35rem; }
    .label { font-weight: 600; }
    input[type="text"], input[type="date"], input[type="password"], select { width: 100%; padding: .35rem .5rem; box-sizing: border-box; }
    textarea { width: 100%; min-height: 80px; resize: vertical; box-sizing: border-box; font-family: inherit; line-height: 1.4; }
    .btn-row { display: flex; gap: .5rem; flex-wrap: wrap; }
    button { padding: .35rem .6rem; border: 1px solid #ccc; background: #f0f0f0; border-radius: 6px; cursor: pointer; }
    button:hover { background: #e0e0e0; }
    button.primary { background: #4a90e2; color: white; border-color: #4a90e2; }
    button.primary:hover { background: #357abd; }
    button.danger { background: #e74c3c; color: white; border-color: #e74c3c; }
    button.danger:hover { background: #c0392b; }
    .storage-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: .25rem 0; gap: .5rem; }
    .storage-item:last-child { border-bottom: none; }
    .storage-actions button { font-size: .7rem; padding: .25rem .45rem; }
    .toggle-header { display: flex; justify-content: space-between; align-items: center; }
    .copy-btn { font-size: .7rem; padding: .2rem .5rem; background: #fff; }
    .status-bar { position: fixed; bottom: 10px; right: 10px; background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: .4rem .7rem; font-size: .8rem; box-shadow: 0 2px 6px rgba(0,0,0,.08); display: none; z-index: 1000; }
    .guide-tab-active { background: #dfe6ff; border-color: #b5c6ff; }
    textarea.autosize { overflow: hidden; }
    
    .sermon-type-item { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: .4rem .6rem; 
      margin-bottom: .3rem;
      background: #f8f9fa;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .sermon-type-item:hover { background: #e9ecef; }
    .sermon-type-item.active { background: #dfe6ff; border: 1px solid #4a90e2; }
    .sermon-type-name { font-size: .9rem; font-weight: 500; }
    .sermon-type-delete { 
      font-size: .7rem; 
      padding: .2rem .4rem; 
      background: transparent;
      color: #e74c3c;
      border: none;
    }
    .sermon-type-delete:hover { background: #fee; }
    
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 400px;
      width: 90%;
    }
    .modal-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem; }
    .modal-buttons { display: flex; gap: .5rem; margin-top: 1rem; }
    .modal-buttons button { flex: 1; }
    
    .category-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .4rem .6rem;
      margin-bottom: .3rem;
      background: #f8f9fa;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="page-wrap">
    <!-- ì™¼ìª½ -->
    <div class="left-col">
      <!-- ë‚ ì§œ -->
      <div class="box">
        <div class="label-row">
          <label class="label" for="sermon-date">ë‚ ì§œ</label>
          <input type="date" id="sermon-date" style="max-width: 160px;">
        </div>
      </div>

      <!-- ì¹´í…Œê³ ë¦¬ -->
      <div class="box">
        <div class="label-row">
          <label class="label" for="sermon-category">ì„¤êµ ì¹´í…Œê³ ë¦¬</label>
          <button id="btn-manage-categories" style="font-size: .75rem; padding: .2rem .5rem;">ê´€ë¦¬</button>
        </div>
        <select id="sermon-category"></select>
      </div>

      <!-- ì‹œë¦¬ì¦ˆëª… -->
      <div class="box" id="series-box" style="display: none;">
        <label class="label">ì‹œë¦¬ì¦ˆëª…</label>
        <input type="text" id="series-name" placeholder="ì˜ˆ: ìš”í•œë³µìŒ ì‹œë¦¬ì¦ˆ">
      </div>

      <!-- ì„±ê²½êµ¬ì ˆ -->
      <div class="box">
        <label class="label">ì„±ê²½êµ¬ì ˆ</label>
        <input type="text" id="sermon-ref" placeholder="ì˜ˆ) ì‹œ 78:1-8">
      </div>

      <!-- ì„±ê²½ ë³¸ë¬¸ -->
      <div class="box">
        <label class="label">ì„±ê²½ ë³¸ë¬¸ (ì„ íƒì‚¬í•­)</label>
        <textarea id="sermon-text" placeholder="ë³¸ë¬¸ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (ì„ íƒì‚¬í•­)"></textarea>
      </div>

      <!-- ì‹¤í–‰ ë²„íŠ¼ -->
      <div class="box">
        <button id="btn-analyze" class="primary" style="width: 100%; margin-bottom: .5rem;">ë³¸ë¬¸ ë¶„ì„</button>
        
        <!-- ì„¤êµ ìœ í˜• ì„ íƒ -->
        <div style="margin: .75rem 0;">
          <div class="label-row">
            <label class="label">ì„¤êµ ìœ í˜•</label>
            <button id="btn-manage-types" style="font-size: .75rem; padding: .2rem .5rem;">ê´€ë¦¬</button>
          </div>
          <div id="sermon-types-list"></div>
        </div>
        
        <button id="btn-prompt" class="primary" style="width: 100%;">ì„¤êµ ì œì‘ í”„ë¡¬í¬íŠ¸</button>
      </div>

      <!-- ì €ì¥ ê³µê°„ -->
      <div class="box">
        <label class="label">ì €ì¥ëœ ì„¤êµ ìë£Œ</label>
        <div class="btn-row" style="margin-bottom: .5rem;">
          <button id="btn-save">í˜„ì¬ ë‚´ìš© ì €ì¥</button>
        </div>
        <div id="saved-list"></div>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½ -->
    <div class="right-col">
      <!-- ì§€ì¹¨ ì˜ì—­ (ê¸°ë³¸ ë‹«í˜) -->
      <div class="box" id="guide-box">
        <div class="toggle-header">
          <span class="label">ì§€ì¹¨ ì˜ì—­ ğŸ”’</span>
          <button id="toggle-guides">ì—´ê¸°</button>
        </div>
        <div id="guide-content" style="display: none;">
          <div class="btn-row" id="guide-btn-row" style="margin: .5rem 0;">
            <button id="save-guide">ì§€ì¹¨ ì €ì¥</button>
            <button id="tab-guide-analysis" class="guide-tab-active">ë³¸ë¬¸ ë¶„ì„ ì§€ì¹¨</button>
            <button id="tab-guide-prompt">ì„¤êµë¬¸ ì œì‘ í”„ë¡¬í¬íŠ¸</button>
          </div>
          <div id="prompt-type-indicator" style="display: none; font-size: .85rem; color: #666; margin-bottom: .5rem;">
            í˜„ì¬ ìœ í˜•: <strong id="current-prompt-type"></strong>
          </div>
          <textarea id="guide-text" class="autosize" style="min-height: 90px;" placeholder="ì„ íƒí•œ ì§€ì¹¨ ìœ í˜•ì˜ ë‚´ìš©ì„ ì‘ì„±í•©ë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ë§ˆë‹¤ ë”°ë¡œ ì €ì¥ë©ë‹ˆë‹¤."></textarea>
        </div>
      </div>

      <!-- ë³¸ë¬¸ ë¶„ì„ ê²°ê³¼ -->
      <div class="box">
        <div class="toggle-header">
          <label class="label">ë³¸ë¬¸ ë¶„ì„</label>
          <button class="copy-btn" data-copy="analysis-box">ë³µì‚¬</button>
        </div>
        <textarea id="analysis-box" class="autosize" style="min-height: 140px;" placeholder="ë³¸ë¬¸ ë¶„ì„ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤."></textarea>
      </div>

      <!-- ì„¤êµë¬¸ ì œì‘ í”„ë¡¬í¬íŠ¸ ê²°ê³¼ -->
      <div class="box">
        <div class="toggle-header">
          <label class="label">ì„¤êµë¬¸ ì œì‘ í”„ë¡¬í¬íŠ¸ (<span id="prompt-result-type">ê¸°ë³¸</span>)</label>
          <button class="copy-btn" data-copy="sermon-prompt-box">ë³µì‚¬</button>
        </div>
        <textarea id="sermon-prompt-box" class="autosize" style="min-height: 140px;" placeholder="GPTì— ë˜ì§ˆ í”„ë¡¬í¬íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤."></textarea>
      </div>
    </div>
  </div>

  <!-- ì§„í–‰ ìƒíƒœ -->
  <div id="status-bar" class="status-bar">GPTë¡œ ì‘ì—… ì¤‘...</div>

  <!-- íŒ¨ìŠ¤ì›Œë“œ ëª¨ë‹¬ -->
  <div id="modal-password" class="modal">
    <div class="modal-content">
      <div class="modal-title">ğŸ”’ ì§€ì¹¨ ì˜ì—­ ì ê¸ˆ</div>
      <p style="color: #666; font-size: .9rem; margin-bottom: 1rem;">ì§€ì¹¨ ì˜ì—­ì— ì ‘ê·¼í•˜ë ¤ë©´ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="password" id="password-input" placeholder="íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥" style="margin-bottom: .5rem;">
      <div class="modal-buttons">
        <button id="btn-cancel-password">ì·¨ì†Œ</button>
        <button id="btn-submit-password" class="primary">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- ì„¤êµ ìœ í˜• ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="modal-manage-types" class="modal">
    <div class="modal-content">
      <div class="modal-title">ì„¤êµ ìœ í˜• ê´€ë¦¬</div>
      <input type="text" id="new-type-name" placeholder="ìƒˆ ì„¤êµ ìœ í˜• ì´ë¦„ (ì˜ˆ: ê°•í•´ì„¤êµv2)" style="margin-bottom: .5rem;">
      <button id="btn-add-type" class="primary" style="width: 100%; margin-bottom: 1rem;">ì¶”ê°€</button>
      
      <div style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
        <div id="manage-types-list"></div>
      </div>
      
      <div class="modal-buttons">
        <button id="btn-close-modal-types">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="modal-manage-categories" class="modal">
    <div class="modal-content">
      <div class="modal-title">ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</div>
      <input type="text" id="new-category-value" placeholder="ì˜ë¬¸ ì½”ë“œ (ì˜ˆ: special)" style="margin-bottom: .3rem;">
      <input type="text" id="new-category-label" placeholder="í‘œì‹œ ì´ë¦„ (ì˜ˆ: íŠ¹ë³„ì˜ˆë°°)" style="margin-bottom: .5rem;">
      <button id="btn-add-category" class="primary" style="width: 100%; margin-bottom: 1rem;">ì¶”ê°€</button>
      
      <div style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
        <div id="manage-categories-list"></div>
      </div>
      
      <div class="modal-buttons">
        <button id="btn-close-modal-categories">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  
  <script>
  // ===== Firebase ì´ˆê¸°í™” =====
  const firebaseConfig = {
    apiKey: "AIzaSyBacmJDk-PG5FaoqnXV8Rg3P__AKOS2vu4",
    authDomain: "my-sermon-guides.firebaseapp.com",
    projectId: "my-sermon-guides",
    storageBucket: "my-sermon-guides.firebasestorage.app",
    messagingSenderId: "539520456089",
    appId: "1:539520456089:web:d6aceb7838baa89e70af08",
    measurementId: "G-KWN8TH7Z26"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  
  const USER_CODE = 'samuel123';
  const PAGE_NAME = 'sermon';
const GUIDE_PASSWORD = '6039';

// Firebase íŠ¹ìˆ˜ í‚¤ ì •ì˜
const SERMON_TYPES_KEY = '_sermon-types';
const CATEGORIES_KEY = '_sermon-categories';

  // ===== ì „ì—­ ë³€ìˆ˜ =====
  const categorySelect = document.getElementById("sermon-category");
  const guideTextArea = document.getElementById("guide-text");
  const statusBar = document.getElementById("status-bar");
  
  let currentGuideType = "analysis";
  let currentPromptType = "ê¸°ë³¸";
  let sermonTypes = ["ê¸°ë³¸", "ê°•í•´ì„¤êµ", "ì£¼ì œì„¤êµ"];
  let categories = [
    {value: "dawn", label: "ìƒˆë²½ì„¤êµ"},
    {value: "wednesday", label: "ìˆ˜ìš”ì„±ê²½ê³µë¶€"},
    {value: "friday", label: "ê¸ˆìš”ê¸°ë„íšŒ"},
    {value: "youth", label: "ì²­ë…„ë¶€"},
    {value: "teen", label: "ì²­ì†Œë…„ë¶€"},
    {value: "women", label: "ì—¬ì„ êµíšŒ"},
    {value: "men", label: "ë‚¨ì„ êµíšŒ"},
    {value: "etc", label: "ê¸°íƒ€"}
  ];
  let guideUnlocked = false;

  // ===== ìƒíƒœ í‘œì‹œ =====
  function showStatus(msg) {
    statusBar.textContent = msg;
    statusBar.style.display = "block";
  }
  
  function hideStatus() {
    statusBar.style.display = "none";
  }

  // ===== ìë™ ë†’ì´ ì¡°ì ˆ =====
  function autoResize(el) {
    if (!el) return;
    el.style.height = 'auto';
    el.style.height = el.scrollHeight + 'px';
  }

  // ===== íŒ¨ìŠ¤ì›Œë“œ ê´€ë¦¬ =====
  
  document.getElementById("toggle-guides").addEventListener("click", () => {
    const guideContent = document.getElementById("guide-content");
    const btn = document.getElementById("toggle-guides");
    
    if (guideContent.style.display === 'none') {
      // ì—´ê¸° ì‹œë„
      if (!guideUnlocked) {
        document.getElementById('modal-password').classList.add('show');
        document.getElementById('password-input').value = '';
        document.getElementById('password-input').focus();
      } else {
        guideContent.style.display = 'block';
        btn.textContent = 'ë‹«ê¸°';
      }
    } else {
      // ë‹«ê¸°
      guideContent.style.display = 'none';
      btn.textContent = 'ì—´ê¸°';
    }
  });

  document.getElementById('btn-submit-password').addEventListener('click', () => {
    const input = document.getElementById('password-input').value;
    if (input === GUIDE_PASSWORD) {
      guideUnlocked = true;
      document.getElementById('modal-password').classList.remove('show');
      document.getElementById('guide-content').style.display = 'block';
      document.getElementById('toggle-guides').textContent = 'ë‹«ê¸°';
      showStatus('âœ… ì§€ì¹¨ ì˜ì—­ì´ ì—´ë ¸ìŠµë‹ˆë‹¤!');
      setTimeout(hideStatus, 2000);
    } else {
      alert('âŒ íŒ¨ìŠ¤ì›Œë“œê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
      document.getElementById('password-input').value = '';
      document.getElementById('password-input').focus();
    }
  });

  document.getElementById('btn-cancel-password').addEventListener('click', () => {
    document.getElementById('modal-password').classList.remove('show');
  });

  document.getElementById('password-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      document.getElementById('btn-submit-password').click();
    }
  });

  // ===== ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ =====
  
  function loadCategories() {
    const saved = localStorage.getItem('sermon-categories');
    if (saved) {
      categories = JSON.parse(saved);
    }
    renderCategories();
  }

// ìˆ˜ì •
async function saveCategories() {
  localStorage.setItem('sermon-categories', JSON.stringify(categories));
  
  // Firebaseì—ë„ ì €ì¥
  try {
    await saveToFirebase(CATEGORIES_KEY, JSON.stringify(categories));
    console.log('âœ… ì¹´í…Œê³ ë¦¬ Firebase ë™ê¸°í™” ì™„ë£Œ');
  } catch (err) {
    console.error('ì¹´í…Œê³ ë¦¬ Firebase ë™ê¸°í™” ì‹¤íŒ¨:', err);
  }
}
  function renderCategories() {
    const currentValue = categorySelect.value;
    categorySelect.innerHTML = categories.map(cat => 
      `<option value="${cat.value}">${cat.label}</option>`
    ).join('');
    
    if (currentValue && categories.find(c => c.value === currentValue)) {
      categorySelect.value = currentValue;
    }
    
    toggleSeriesBox();
  }

  function renderManageCategories() {
    const list = document.getElementById('manage-categories-list');
    list.innerHTML = categories.map((cat, idx) => `
      <div class="category-item">
        <div>
          <div style="font-weight: 600;">${cat.label}</div>
          <div style="font-size: .75rem; color: #666;">${cat.value}</div>
        </div>
        ${categories.length > 1 ? `<button class="sermon-type-delete" onclick="deleteCategory(${idx})">ì‚­ì œ</button>` : ''}
      </div>
    `).join('');
  }

  window.deleteCategory = function(idx) {
    if (!confirm(`"${categories[idx].label}" ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    
    categories.splice(idx, 1);
    saveCategories();
    renderCategories();
    renderManageCategories();
  };

  document.getElementById('btn-manage-categories').addEventListener('click', () => {
    renderManageCategories();
    document.getElementById('modal-manage-categories').classList.add('show');
  });

  document.getElementById('btn-close-modal-categories').addEventListener('click', () => {
    document.getElementById('modal-manage-categories').classList.remove('show');
  });

  document.getElementById('btn-add-category').addEventListener('click', async () => {  // async ì¶”ê°€
  const value = document.getElementById('new-category-value').value.trim();
  const label = document.getElementById('new-category-label').value.trim();
  
  if (!value || !label) {
    alert('ì˜ë¬¸ ì½”ë“œì™€ í‘œì‹œ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
    return;
  }
  
  if (categories.find(c => c.value === value)) {
    alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.');
    return;
  }
  
  categories.push({value, label});
  await saveCategories();  // await ì¶”ê°€
  renderCategories();
  renderManageCategories();
  
  document.getElementById('new-category-value').value = '';
  document.getElementById('new-category-label').value = '';
  alert(`"${label}" ì¹´í…Œê³ ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
});

window.deleteCategory = async function(idx) {  // async ì¶”ê°€
  if (!confirm(`"${categories[idx].label}" ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  
  categories.splice(idx, 1);
  await saveCategories();  // await ì¶”ê°€
  renderCategories();
  renderManageCategories();
};

  // ===== ì„¤êµ ìœ í˜• ê´€ë¦¬ =====
  
  function loadSermonTypes() {
    const saved = localStorage.getItem('sermon-prompt-types');
    if (saved) {
      sermonTypes = JSON.parse(saved);
    }
    renderSermonTypes();
  }

// ìˆ˜ì •
async function saveSermonTypes() {
  localStorage.setItem('sermon-prompt-types', JSON.stringify(sermonTypes));
  
  // Firebaseì—ë„ ì €ì¥
  try {
    await saveToFirebase(SERMON_TYPES_KEY, JSON.stringify(sermonTypes));
    console.log('âœ… ì„¤êµ ìœ í˜• Firebase ë™ê¸°í™” ì™„ë£Œ');
  } catch (err) {
    console.error('ì„¤êµ ìœ í˜• Firebase ë™ê¸°í™” ì‹¤íŒ¨:', err);
  }
}
  function renderSermonTypes() {
    const list = document.getElementById('sermon-types-list');
    list.innerHTML = sermonTypes.map((type, idx) => `
      <div class="sermon-type-item ${type === currentPromptType ? 'active' : ''}" data-type="${type}">
        <span class="sermon-type-name">${type}</span>
      </div>
    `).join('');
    
    document.querySelectorAll('.sermon-type-item').forEach(item => {
      item.addEventListener('click', () => {
        currentPromptType = item.dataset.type;
        renderSermonTypes();
        if (currentGuideType === 'prompt') {
          loadCurrentGuide();
        }
        document.getElementById('current-prompt-type').textContent = currentPromptType;
      });
    });
  }

  function renderManageTypes() {
    const list = document.getElementById('manage-types-list');
    list.innerHTML = sermonTypes.map((type, idx) => `
      <div class="sermon-type-item">
        <span class="sermon-type-name">${type}</span>
        ${sermonTypes.length > 1 ? `<button class="sermon-type-delete" onclick="deleteSermonType(${idx})">ì‚­ì œ</button>` : ''}
      </div>
    `).join('');
  }

window.deleteSermonType = async function(idx) {  // async ì¶”ê°€
  if (!confirm(`"${sermonTypes[idx]}" ìœ í˜•ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê´€ë ¨ ì§€ì¹¨ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) return;
  
  const deletedType = sermonTypes[idx];
  sermonTypes.splice(idx, 1);
  
  if (currentPromptType === deletedType) {
    currentPromptType = sermonTypes[0];
  }
  
  await saveSermonTypes();  // await ì¶”ê°€
  renderSermonTypes();
  renderManageTypes();
};

  document.getElementById('btn-manage-types').addEventListener('click', () => {
    renderManageTypes();
    document.getElementById('modal-manage-types').classList.add('show');
  });

  document.getElementById('btn-close-modal-types').addEventListener('click', () => {
    document.getElementById('modal-manage-types').classList.remove('show');
  });

  document.getElementById('btn-add-type').addEventListener('click', async () => {  // async ì¶”ê°€
  const newName = document.getElementById('new-type-name').value.trim();
  if (!newName) {
    alert('ìœ í˜• ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
    return;
  }
  
  if (sermonTypes.includes(newName)) {
    alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìœ í˜• ì´ë¦„ì…ë‹ˆë‹¤.');
    return;
  }
  
  sermonTypes.push(newName);
  await saveSermonTypes();  // await ì¶”ê°€
  renderSermonTypes();
  renderManageTypes();
  document.getElementById('new-type-name').value = '';
  alert(`"${newName}" ìœ í˜•ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
});

  // ===== Firebase í•¨ìˆ˜ =====
  
  async function loadFromFirebase() {
    try {
      const snapshot = await db
        .collection('users')
        .doc(USER_CODE)
        .collection(PAGE_NAME)
        .get();
      
      let loadedCount = 0;
      if (!snapshot.empty) {
        snapshot.forEach(doc => {
          const key = doc.id;
          const value = doc.data().value;
          localStorage.setItem(key, value);
          loadedCount++;
        });
        console.log(`âœ… Firebaseì—ì„œ ${loadedCount}ê°œ ì§€ì¹¨ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!`);
        return true;
      } else {
        console.log('Firebaseì— ì €ì¥ëœ ì§€ì¹¨ì´ ì—†ìŠµë‹ˆë‹¤.');
        return false;
      }
    } catch (err) {
      console.error('Firebase ë¡œë“œ ì‹¤íŒ¨:', err);
      return false;
    }
  }

  async function saveToFirebase(key, value) {
    try {
      await db
        .collection('users')
        .doc(USER_CODE)
        .collection(PAGE_NAME)
        .doc(key)
        .set({
          value: value,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      return true;
    } catch (err) {
      console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', err);
      return false;
    }
  }

  // ===== ì§€ì¹¨ ê´€ë¦¬ =====
  
  function getGuideKey(category, type, promptType = null) {
    if (type === 'prompt' && promptType) {
      return `sermon-guide-${category}-prompt-${promptType}`;
    }
    return `sermon-guide-${category}-${type}`;
  }

  function loadCurrentGuide() {
    const cat = categorySelect.value;
    let key;
    
    if (currentGuideType === 'prompt') {
      key = getGuideKey(cat, 'prompt', currentPromptType);
      document.getElementById('prompt-type-indicator').style.display = 'block';
      document.getElementById('current-prompt-type').textContent = currentPromptType;
    } else {
      key = getGuideKey(cat, currentGuideType);
      document.getElementById('prompt-type-indicator').style.display = 'none';
    }
    
    const stored = localStorage.getItem(key) || "";
    guideTextArea.value = stored;
    autoResize(guideTextArea);
  }

  function toggleSeriesBox() {
    const seriesBox = document.getElementById("series-box");
    const category = categorySelect.value;
    
    if (category === "wednesday") {
      seriesBox.style.display = "block";
    } else {
      seriesBox.style.display = "none";
    }
  }

  categorySelect.addEventListener("change", () => {
    loadCurrentGuide();
    toggleSeriesBox();
  });

  document.getElementById("tab-guide-analysis").addEventListener("click", () => {
    document.getElementById("tab-guide-analysis").classList.add("guide-tab-active");
    document.getElementById("tab-guide-prompt").classList.remove("guide-tab-active");
    currentGuideType = "analysis";
    loadCurrentGuide();
  });

  document.getElementById("tab-guide-prompt").addEventListener("click", () => {
    document.getElementById("tab-guide-prompt").classList.add("guide-tab-active");
    document.getElementById("tab-guide-analysis").classList.remove("guide-tab-active");
    currentGuideType = "prompt";
    loadCurrentGuide();
  });

  document.getElementById("save-guide").addEventListener("click", async () => {
    const cat = categorySelect.value;
    let key;
    
    if (currentGuideType === 'prompt') {
      key = getGuideKey(cat, 'prompt', currentPromptType);
    } else {
      key = getGuideKey(cat, currentGuideType);
    }
    
    const value = guideTextArea.value;

    localStorage.setItem(key, value);

    showStatus("ğŸ’¾ ì €ì¥ ì¤‘...");
    const success = await saveToFirebase(key, value);

    if (success) {
      showStatus("âœ… ì§€ì¹¨ì´ ì €ì¥ë˜ê³  í´ë¼ìš°ë“œì— ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!");
    } else {
      showStatus("âš ï¸ ë¡œì»¬ì—ë§Œ ì €ì¥ë¨ (í´ë¼ìš°ë“œ ë™ê¸°í™” ì‹¤íŒ¨)");
    }

    setTimeout(hideStatus, 2000);
  });

  // ===== ë³µì‚¬ ê¸°ëŠ¥ =====
  
  document.querySelectorAll('[data-copy]').forEach(btn => {
    btn.addEventListener('click', () => {
      const targetId = btn.dataset.copy;
      const textarea = document.getElementById(targetId);
      if (!textarea) return;
      
      textarea.select();
      document.execCommand('copy');
      
      const originalText = btn.textContent;
      btn.textContent = 'âœ… ë³µì‚¬ë¨!';
      setTimeout(() => {
        btn.textContent = originalText;
      }, 1500);
    });
  });

  // ===== ë³¸ë¬¸ ë¶„ì„ =====
  
  document.getElementById("btn-analyze").addEventListener("click", async () => {
    const date = document.getElementById("sermon-date").value;
    const category = categorySelect.value;
    const ref = document.getElementById("sermon-ref").value;
    const text = document.getElementById("sermon-text").value;
    const guideKey = getGuideKey(category, "analysis");
    const guide = localStorage.getItem(guideKey) || "";

    if (!ref) {
      alert("ì„±ê²½êµ¬ì ˆì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    showStatus("ğŸ¤– ë³¸ë¬¸ ë¶„ì„ ì¤‘...");

    try {
      const response = await fetch("/api/sermon/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          date: date,
          category: category,
          reference: ref,
          text: text,
          guide: guide
        })
      });

      const data = await response.json();

      if (data.ok) {
        const analysisBox = document.getElementById("analysis-box");
        analysisBox.value = data.result;
        autoResize(analysisBox);
        showStatus("âœ… ë³¸ë¬¸ ë¶„ì„ ì™„ë£Œ!");
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
        showStatus("âŒ ë¶„ì„ ì‹¤íŒ¨");
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
      showStatus("âŒ ì˜¤ë¥˜ ë°œìƒ");
    } finally {
      setTimeout(hideStatus, 2000);
    }
  });

  // ===== ì„¤êµë¬¸ í”„ë¡¬í”„íŠ¸ ìƒì„± =====
  
  document.getElementById("btn-prompt").addEventListener("click", async () => {
    const date = document.getElementById("sermon-date").value;
    const category = categorySelect.value;
    const ref = document.getElementById("sermon-ref").value;
    const text = document.getElementById("sermon-text").value;
    const analysis = document.getElementById("analysis-box").value;
    const guideKey = getGuideKey(category, "prompt", currentPromptType);
    const guide = localStorage.getItem(guideKey) || "";

    if (!ref) {
      alert("ì„±ê²½êµ¬ì ˆì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    showStatus(`ğŸ¤– í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘ (${currentPromptType})...`);

    try {
      const response = await fetch("/api/sermon/prompt", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          date: date,
          category: category,
          reference: ref,
          text: text,
          analysis: analysis,
          guide: guide,
          promptType: currentPromptType
        })
      });

      const data = await response.json();

      if (data.ok) {
        const promptBox = document.getElementById("sermon-prompt-box");
        promptBox.value = data.result;
        autoResize(promptBox);
        document.getElementById('prompt-result-type').textContent = currentPromptType;
        showStatus("âœ… í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ!");
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
        showStatus("âŒ ìƒì„± ì‹¤íŒ¨");
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
      showStatus("âŒ ì˜¤ë¥˜ ë°œìƒ");
    } finally {
      setTimeout(hideStatus, 2000);
    }
  });

  // ===== ì €ì¥ ê³µê°„ ê´€ë¦¬ =====
  
  function loadSavedList() {
    const savedList = document.getElementById("saved-list");
    const saved = JSON.parse(localStorage.getItem("sermon-saved") || "[]");

    if (saved.length === 0) {
      savedList.innerHTML = '<p style="color: #999; font-size: .8rem; text-align: center; padding: .5rem;">ì €ì¥ëœ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    savedList.innerHTML = saved.map((item, idx) => {
      const category = categories.find(c => c.value === item.category);
      const categoryName = category ? category.label : item.category;
      const displayText = item.seriesName 
        ? `${item.date || 'ë‚ ì§œ ì—†ìŒ'} - ${categoryName} - ${item.seriesName}`
        : `${item.date || 'ë‚ ì§œ ì—†ìŒ'} - ${categoryName}`;
      
      return `
        <div class="storage-item">
          <span style="font-size: .85rem;">${displayText}</span>
          <div class="storage-actions">
            <button onclick="loadSaved(${idx})">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button onclick="deleteSaved(${idx})">ì‚­ì œ</button>
          </div>
        </div>
      `;
    }).join('');
  }

  document.getElementById("btn-save").addEventListener("click", () => {
    const date = document.getElementById("sermon-date").value;
    const category = categorySelect.value;
    const seriesName = document.getElementById("series-name").value;
    const ref = document.getElementById("sermon-ref").value;
    const text = document.getElementById("sermon-text").value;
    const analysis = document.getElementById("analysis-box").value;
    const prompt = document.getElementById("sermon-prompt-box").value;

    const saved = JSON.parse(localStorage.getItem("sermon-saved") || "[]");
    saved.push({
      date: date,
      category: category,
      seriesName: seriesName,
      ref: ref,
      text: text,
      analysis: analysis,
      prompt: prompt,
      promptType: currentPromptType,
      savedAt: new Date().toISOString()
    });

    localStorage.setItem("sermon-saved", JSON.stringify(saved));
    loadSavedList();
    alert("âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
  });

  window.loadSaved = function(idx) {
    const saved = JSON.parse(localStorage.getItem("sermon-saved") || "[]");
    const item = saved[idx];

    document.getElementById("sermon-date").value = item.date || "";
    
    if (categories.find(c => c.value === item.category)) {
      categorySelect.value = item.category;
    } else {
      categorySelect.value = categories[0].value;
    }
    
    document.getElementById("series-name").value = item.seriesName || "";
    document.getElementById("sermon-ref").value = item.ref || "";
    document.getElementById("sermon-text").value = item.text || "";
    document.getElementById("analysis-box").value = item.analysis || "";
    document.getElementById("sermon-prompt-box").value = item.prompt || "";
    
    if (item.promptType && sermonTypes.includes(item.promptType)) {
      currentPromptType = item.promptType;
      renderSermonTypes();
    }

    toggleSeriesBox();
    document.querySelectorAll('textarea').forEach(autoResize);
  };

  window.deleteSaved = function(idx) {
    if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    const saved = JSON.parse(localStorage.getItem("sermon-saved") || "[]");
    saved.splice(idx, 1);
    localStorage.setItem("sermon-saved", JSON.stringify(saved));
    loadSavedList();
  };

  // ===== textarea ìë™ ë†’ì´ =====
  
  document.querySelectorAll('textarea.autosize').forEach(textarea => {
    textarea.addEventListener('input', () => autoResize(textarea));
  });

  // ===== í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” =====
  
document.addEventListener("DOMContentLoaded", async () => {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById("sermon-date").value = today;

  showStatus("â˜ï¸ í´ë¼ìš°ë“œ ë™ê¸°í™” ì¤‘...");
  await loadFromFirebase();
  
  // Firebaseì—ì„œ ì„¤êµ ìœ í˜• ë¶ˆëŸ¬ì˜¤ê¸°
  const savedTypes = localStorage.getItem(SERMON_TYPES_KEY);
  if (savedTypes) {
    try {
      sermonTypes = JSON.parse(savedTypes);
      console.log('âœ… ì„¤êµ ìœ í˜• Firebaseì—ì„œ ë¶ˆëŸ¬ì˜´:', sermonTypes);
    } catch (e) {
      console.error('ì„¤êµ ìœ í˜• íŒŒì‹± ì‹¤íŒ¨:', e);
    }
  }
  
  // Firebaseì—ì„œ ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
  const savedCategories = localStorage.getItem(CATEGORIES_KEY);
  if (savedCategories) {
    try {
      categories = JSON.parse(savedCategories);
      console.log('âœ… ì¹´í…Œê³ ë¦¬ Firebaseì—ì„œ ë¶ˆëŸ¬ì˜´:', categories);
    } catch (e) {
      console.error('ì¹´í…Œê³ ë¦¬ íŒŒì‹± ì‹¤íŒ¨:', e);
    }
  }
  
  hideStatus();

  loadCategories();
  loadSermonTypes();
  loadCurrentGuide();
  loadSavedList();
  toggleSeriesBox();

  document.querySelectorAll('textarea').forEach(autoResize);
});
  </script>
</body>
</html>