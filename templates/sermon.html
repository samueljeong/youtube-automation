<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>BIBLE LAB</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
    }
    .page-wrap {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      height: 100vh;
    }
    .left-col {
      width: 280px;
      display: flex;
      flex-direction: column;
      gap: .75rem;
      overflow-y: auto;
      background: linear-gradient(135deg, #fafbfc 0%, #f3f4f6 100%);
      padding: .75rem;
      border-radius: 12px;
    }
    .right-col {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0;
      min-width: 0;
      overflow: hidden;
    }

    /* Top ì˜ì—­: ê³ ì • */
    .top-section {
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: .5rem;
      padding-bottom: .5rem;
      border-bottom: 2px solid #e0e0e0;
      background: #f5f5f5;
    }

    /* Content ì˜ì—­: ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
    .content-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: .75rem;
      overflow-y: auto;
      padding-top: .75rem;
      min-height: 0;
    }
    .box {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: .6rem;
    }
    .label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: .5rem;
      margin-bottom: .35rem;
    }
    .label { font-weight: 600; }
    .label-hint {
      font-size: .7rem;
      font-weight: 400;
      color: #0066cc;
      background: #e6f2ff;
      padding: .15rem .4rem;
      border-radius: 9999px;
      margin-left: .35rem;
      white-space: nowrap;
    }
    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: .35rem .5rem;
    }
    textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
      line-height: 1.4;
    }
    .btn-row {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
    }
    button {
      padding: .35rem .6rem;
      border: 1px solid #ccc;
      background: #f0f0f0;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #e0e0e0; }
    button.primary {
      background: #4a90e2;
      color: white;
      border-color: #4a90e2;
    }
    button.primary:hover { background: #357abd; }
    button.danger {
      background: #e74c3c;
      color: white;
      border-color: #e74c3c;
    }
    button.step-btn {
      width: 100%;
      margin-bottom: .5rem;
      text-align: left;
      padding-left: .8rem;
    }

    .style-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .4rem .6rem;
      margin-bottom: .3rem;
      background: #f8f9fa;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .style-item:hover { background: #e9ecef; }
    .style-item.active {
      background: #dfe6ff;
      border: 2px solid #4a90e2;
    }
    .style-desc {
      font-size: .65rem;
      color: #999;
      margin-top: .15rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .title-option-label {
      display: block;
      margin-bottom: .5rem;
      padding: .4rem;
      background: #f8f9fa;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .title-option-label:hover {
      background: #e9ecef;
    }
    .title-option-label input[type="radio"]:checked + span {
      font-weight: 600;
      color: #4a90e2;
    }

    .toggle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .status-bar {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 1rem 2rem;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      display: none;
      text-align: center;
      z-index: 3000;
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* GPT ë¡œë”© ì˜¤ë²„ë ˆì´ */
    #gpt-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .gpt-loading-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 3rem 4rem;
      border-radius: 24px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), 0 0 100px rgba(102, 126, 234, 0.3);
      animation: slideUp 0.5s ease;
      position: relative;
      overflow: hidden;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .gpt-loading-content::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .gpt-loading-spinner {
      width: 64px;
      height: 64px;
      margin: 0 auto 1.5rem;
      border: 5px solid rgba(255, 255, 255, 0.2);
      border-top: 5px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      position: relative;
      z-index: 1;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .gpt-loading-text {
      font-size: 1.4rem;
      font-weight: 700;
      color: white;
      margin-bottom: 0.5rem;
      letter-spacing: 0.5px;
      position: relative;
      z-index: 1;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .gpt-loading-subtext {
      font-size: 0.95rem;
      color: rgba(255, 255, 255, 0.9);
      position: relative;
      z-index: 1;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.6;
      }
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    .modal.show { display: flex; }

    /* ê°€ì´ë“œ ëª¨ë‹¬ - ì˜¤ë¥¸ìª½ í•˜ë‹¨ì— ë°°ì¹˜, ë’¤ í´ë¦­ ê°€ëŠ¥ */
    #modal-guide {
      background: transparent;
      pointer-events: none;
      align-items: flex-end;
      justify-content: flex-end;
      padding: 1.5rem;
    }
    #modal-guide .modal-content {
      pointer-events: auto;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .modal-buttons {
      display: flex;
      gap: .5rem;
      margin-top: 1rem;
    }
    .modal-buttons button { flex: 1; }

    .storage-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .4rem .6rem;
      margin-bottom: .3rem;
      background: #f8f9fa;
      border-radius: 6px;
    }

    textarea.autosize { overflow: hidden; }

    /* GPT PRO ê²°ê³¼ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .gpt-pro-result-box {
      background: linear-gradient(135deg, #ff6b9d 0%, #c06c84 100%);
      border: none;
      padding: 1rem;
      border-radius: 8px;
      margin-top: .75rem;
    }
    .gpt-pro-result-box .label {
      color: white;
      font-size: 1.1rem;
      margin-bottom: .5rem;
    }
    .gpt-pro-result-box textarea {
      background: white;
      border: none;
      border-radius: 6px;
      padding: .75rem;
      min-height: 300px;
    }

    /* ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
    .top-buttons-container {
      display: flex;
      gap: .75rem;
    }
    .top-buttons-container .box {
      flex: 1;
      padding: .7rem;
      border: none;
    }
    .copy-all-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .gpt-pro-box {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .top-buttons-container button {
      background: white;
      font-weight: 600;
      padding: .6rem 1.2rem;
      border: none;
      font-size: .95rem;
      width: 100%;
    }
    .copy-all-box button {
      color: #667eea;
    }
    .gpt-pro-box button {
      color: #f5576c;
    }
    .top-buttons-container .box-title {
      color: white;
      font-weight: 600;
      font-size: .95rem;
      margin-bottom: .25rem;
    }
    .top-buttons-container .box-desc {
      color: rgba(255,255,255,0.9);
      font-size: .8rem;
      margin-bottom: .5rem;
    }

    /* Auth header */
    .auth-header {
      background: white;
      border-bottom: 2px solid #e0e0e0;
      padding: .75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .auth-header h1 {
      font-size: 1.2rem;
      margin: 0;
      color: #333;
    }
    .auth-links {
      display: flex;
      gap: .75rem;
      align-items: center;
    }
    .auth-links .user-info {
      font-size: .9rem;
      color: #555;
      font-weight: 500;
    }
    .auth-links a {
      padding: .4rem .8rem;
      text-decoration: none;
      border-radius: 6px;
      font-size: .85rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    .auth-links .btn-login {
      background: white;
      color: #4a90e2;
      border: 2px solid #4a90e2;
    }
    .auth-links .btn-login:hover {
      background: #4a90e2;
      color: white;
    }
    .auth-links .btn-signup {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
    }
    .auth-links .btn-signup:hover {
      opacity: 0.9;
    }
    .auth-links .btn-logout {
      background: #e74c3c;
      color: white;
      border: none;
    }
    .auth-links .btn-logout:hover {
      background: #c0392b;
    }
    .auth-links .btn-home {
      background: #95a5a6;
      color: white;
      border: none;
    }
    .auth-links .btn-home:hover {
      background: #7f8c8d;
    }

    /* ê´€ë¦¬ì ê³µê°„ 50:50 ë¶„í•  */
    .guide-row-container {
      display: flex;
      gap: .75rem;
    }
    .guide-row-container .box {
      flex: 1;
    }

    /* ê´€ë¦¬ì ê³µê°„ ìŠ¤í¬ë¡¤ */
    #master-guide-content,
    #guide-content {
      max-height: 300px;
      overflow-y: auto;
    }

    /* ì²˜ë¦¬ ë‹¨ê³„ + Q&A 70:30 ë¶„í•  */
    .processing-qa-container {
      display: flex;
      gap: .75rem;
      flex: 1;
      min-height: 0;
    }
    .processing-steps-panel {
      flex: 7;
      display: flex;
      flex-direction: column;
      gap: .75rem;
      overflow-y: auto;
    }
    .qa-panel {
      flex: 3;
      display: flex;
      flex-direction: column;
      gap: .75rem;
      overflow-y: auto;
    }

    /* Q&A ì¸í„°í˜ì´ìŠ¤ ìŠ¤íƒ€ì¼ */
    .qa-interface {
      background: #fff;
      border: 2px solid #8e9aaf;
      border-radius: 8px;
      padding: .75rem;
      display: flex;
      flex-direction: column;
      height: 100%;
      box-shadow: 0 2px 8px rgba(142, 154, 175, 0.15);
    }
    .qa-prompt {
      font-size: .9rem;
      color: #666;
      margin-bottom: .75rem;
      padding: .5rem;
      background: #f8f9fa;
      border-radius: 6px;
      text-align: center;
    }
    .qa-history {
      flex: 1;
      overflow-y: auto;
      margin-bottom: .75rem;
      padding: .5rem;
      background: #fafafa;
      border-radius: 6px;
      min-height: 200px;
    }
    .qa-message {
      margin-bottom: .75rem;
      padding: .5rem;
      border-radius: 6px;
    }
    .qa-message.user {
      background: #e3f2fd;
      margin-left: 2rem;
    }
    .qa-message.assistant {
      background: #f1f8e9;
      margin-right: 2rem;
    }
    .qa-message-label {
      font-size: .75rem;
      font-weight: 600;
      margin-bottom: .25rem;
      color: #555;
    }
    .qa-message-content {
      font-size: .85rem;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    .qa-input-area {
      display: flex;
      gap: .5rem;
    }
    .qa-input-area textarea {
      flex: 1;
      min-height: 60px;
      resize: vertical;
    }
    .qa-input-area button {
      align-self: flex-end;
      height: fit-content;
    }
    .qa-empty-state {
      text-align: center;
      color: #999;
      font-size: .85rem;
      padding: 2rem;
    }

    /* ===== ëª¨ë°”ì¼ ë°˜ì‘í˜• ë””ìì¸ ===== */
    @media screen and (max-width: 768px) {
      .page-wrap {
        flex-direction: column;
        height: auto;
        min-height: 100vh;
        padding: .5rem;
        gap: .5rem;
      }

      .right-col {
        width: 100%;
        overflow: visible;
        height: auto;
        display: contents; /* ëª¨ë°”ì¼ì—ì„œ ìì‹ë“¤ì„ page-wrap ë ˆë²¨ì— ë°°ì¹˜ */
      }

      /* ëª¨ë°”ì¼ì—ì„œ ìˆœì„œ ì¡°ì • */
      .top-section {
        order: 1;
        flex-shrink: 1;
        border-bottom: 2px solid #ccc;
        padding-bottom: .5rem;
      }

      .left-col {
        width: 100%;
        overflow-y: visible;
        order: 2; /* ëª¨ë°”ì¼ì—ì„œ Top ë‹¤ìŒì— ìœ„ì¹˜ */
        background: none;
        padding: 0;
      }

      .content-section {
        order: 3; /* ëª¨ë°”ì¼ì—ì„œ ì™¼ìª½ ì˜ì—­ ë‹¤ìŒì— ìœ„ì¹˜ */
        overflow-y: visible;
        padding-top: .5rem;
      }

      .box {
        padding: .65rem;
      }

      /* ë²„íŠ¼ í¬ê¸° ì¦ê°€ (í„°ì¹˜ ì¹œí™”ì ) */
      button {
        padding: .5rem .75rem;
        font-size: .9rem;
        min-height: 44px; /* í„°ì¹˜ ê¶Œì¥ í¬ê¸° */
      }

      button.step-btn {
        font-size: .95rem;
      }

      /* ì…ë ¥ í•„ë“œ í¬ê¸° ì¦ê°€ */
      input[type="text"],
      input[type="date"],
      input[type="password"],
      select {
        padding: .5rem .65rem;
        font-size: 16px; /* iOS ì¤Œ ë°©ì§€ */
        min-height: 44px;
      }

      textarea {
        font-size: 16px; /* iOS ì¤Œ ë°©ì§€ */
        padding: .5rem;
      }

      /* ìƒë‹¨ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ - ëª¨ë°”ì¼ì—ì„œëŠ” ì„¸ë¡œ ë°°ì¹˜ */
      .top-buttons-container {
        flex-direction: column;
      }

      .top-buttons-container .box {
        width: 100%;
      }

      /* ê´€ë¦¬ì ê³µê°„ - ëª¨ë°”ì¼ì—ì„œëŠ” ì„¸ë¡œ ë°°ì¹˜ */
      .guide-row-container {
        flex-direction: column;
      }

      .guide-row-container .box {
        width: 100%;
      }

      /* ì²˜ë¦¬ ë‹¨ê³„ + Q&A - ëª¨ë°”ì¼ì—ì„œëŠ” ì„¸ë¡œ ë°°ì¹˜ */
      .processing-qa-container {
        flex-direction: column;
      }

      .processing-steps-panel,
      .qa-panel {
        width: 100%;
      }

      /* Auth í—¤ë” - ëª¨ë°”ì¼ ìµœì í™” */
      .auth-header {
        flex-wrap: wrap;
        gap: .5rem;
        padding: .5rem;
      }

      .auth-header h1 {
        font-size: 1.1rem;
      }

      .auth-links {
        gap: .5rem;
        flex-wrap: wrap;
      }

      .auth-links a,
      .auth-links .user-info {
        font-size: .8rem;
        padding: .35rem .6rem;
      }

      /* ëª¨ë‹¬ í¬ê¸° ì¡°ì • */
      .modal-content {
        width: 95%;
        max-height: 90vh;
        padding: 1rem;
      }

      .modal-title {
        font-size: 1.1rem;
      }

      /* ìŠ¤íƒ€ì¼ ì•„ì´í…œ í„°ì¹˜ ì˜ì—­ ì¦ê°€ */
      .style-item {
        padding: .6rem .75rem;
        margin-bottom: .5rem;
      }

      /* Q&A ë©”ì‹œì§€ ì—¬ë°± ì¡°ì • */
      .qa-message.user {
        margin-left: .5rem;
      }

      .qa-message.assistant {
        margin-right: .5rem;
      }

      /* ì €ì¥ ì•„ì´í…œ ë²„íŠ¼ í¬ê¸° */
      .storage-item {
        flex-direction: column;
        align-items: flex-start;
        gap: .5rem;
      }

      .storage-item > div:last-child {
        display: flex;
        gap: .5rem;
        width: 100%;
      }

      .storage-item button {
        flex: 1;
        font-size: .85rem;
      }

      /* ë²„íŠ¼ í–‰ ì¤„ë°”ê¿ˆ */
      .btn-row {
        flex-wrap: wrap;
      }

      /* ìƒíƒœë°” */
      .status-bar {
        font-size: .9rem;
        padding: .8rem 1.5rem;
        max-width: 80%;
      }

      /* ë¼ë²¨ */
      .label {
        font-size: .95rem;
      }

      /* ì œëª© ì„ íƒ ë¼ë²¨ */
      .title-option-label {
        padding: .5rem;
        margin-bottom: .6rem;
      }

      .title-option-label span {
        font-size: .9rem;
      }
    }

    /* ì•„ì£¼ ì‘ì€ í™”ë©´ (360px ì´í•˜) */
    @media screen and (max-width: 360px) {
      .page-wrap {
        padding: .25rem;
      }

      .box {
        padding: .5rem;
        border-radius: 6px;
      }

      button {
        font-size: .85rem;
        padding: .45rem .6rem;
      }

      .auth-header h1 {
        font-size: 1rem;
      }

      .modal-content {
        padding: .75rem;
      }
    }

    /* Step2 ë°•ìŠ¤ ê³ ì • ë° ë¸”ë¼ì¸ë“œ ì²˜ë¦¬ */
    .step2-box {
      position: relative;
    }

    .step2-content-wrapper {
      position: relative;
      max-height: 200px;
      overflow: hidden;
    }

    .step2-content-wrapper textarea {
      resize: none !important;
      overflow: hidden !important;
    }

    .step2-gradient-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 80px;
      background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,0.7) 40%, rgba(255,255,255,1) 100%);
      pointer-events: none;
    }

    /* íƒœë¸”ë¦¿ ê°€ë¡œ ëª¨ë“œ (768px - 1024px) */
    @media screen and (min-width: 769px) and (max-width: 1024px) {
      .left-col {
        width: 320px;
      }

      .page-wrap {
        padding: .75rem;
      }
    }
  </style>
</head>
<body>
  <!-- Auth Header -->
  <div class="auth-header">
    <h1>BIBLE LAB</h1>
    <div class="auth-links">
      <a href="/" class="btn-home">í™ˆ</a>
      {% if session.user_id %}
        <span class="user-info">{{ session.user_name }}ë‹˜</span>
        <a href="/logout" class="btn-logout">ë¡œê·¸ì•„ì›ƒ</a>
      {% else %}
        <a href="/login" class="btn-login">ë¡œê·¸ì¸</a>
        <a href="/signup" class="btn-signup">íšŒì›ê°€ì…</a>
      {% endif %}
    </div>
  </div>

  <div class="page-wrap">
    <!-- ì™¼ìª½ -->
    <div class="left-col">
      <!-- ë‚ ì§œ -->
      <div class="box">
        <label class="label" for="sermon-date">ë‚ ì§œ</label>
        <input type="date" id="sermon-date">
      </div>

      <!-- ì¹´í…Œê³ ë¦¬ -->
      <div class="box">
        <div class="label-row">
          <label class="label">ì¹´í…Œê³ ë¦¬</label>
          <button id="btn-manage-categories" style="font-size: .75rem; padding: .2rem .5rem;">ê´€ë¦¬</button>
        </div>
        <select id="sermon-category"></select>
      </div>

      <!-- ì‹œë¦¬ì¦ˆëª… -->
      <div class="box" id="series-box" style="display: none;">
        <label class="label">ì‹œë¦¬ì¦ˆëª…</label>
        <input type="text" id="series-name" placeholder="ì˜ˆ: ìš”í•œë³µìŒ ì‹œë¦¬ì¦ˆ">
      </div>

      <!-- ì„±ê²½êµ¬ì ˆ -->
      <div class="box">
        <label class="label">ì„±ê²½êµ¬ì ˆ<span class="label-hint">í•„ìˆ˜</span></label>
        <input type="text" id="sermon-ref" placeholder="ì˜ˆ) ì‹œ 78:1-8">
      </div>

      <!-- ì œëª© (ì„ íƒì‚¬í•­) - ì§ì ‘ ì…ë ¥ -->
      <div class="box">
        <label class="label">ì œëª©<span class="label-hint">ì„ íƒ</span></label>
        <input type="text" id="manual-title" placeholder="ì§ì ‘ ì…ë ¥ ë˜ëŠ” ì•„ë˜ ì œëª© ì¶”ì²œì—ì„œ ì„ íƒ">
      </div>

      <!-- ì œëª© ì„ íƒ ì˜ì—­ (ì œëª© ì¶”ì²œ í›„ í‘œì‹œ) -->
      <div class="box" id="title-selection-box" style="display: none;">
        <label class="label">âœ¨ ì œëª© ì¶”ì²œ ì„ íƒ</label>
        <div id="title-options" style="margin-top: .5rem;"></div>
      </div>

      <!-- ì„±ê²½ ë³¸ë¬¸ -->
      <div class="box">
        <label class="label">ì„±ê²½ ë³¸ë¬¸<span class="label-hint">ì„ íƒ</span></label>
        <textarea id="sermon-text" class="autosize" placeholder="ë³¸ë¬¸ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
      </div>

      <!-- ì„¤êµ ìŠ¤íƒ€ì¼ -->
      <div class="box">
        <div class="label-row">
          <label class="label">ì„¤êµ ìŠ¤íƒ€ì¼<span class="label-hint">í´ë¦­í•˜ì—¬ ì„ íƒ</span></label>
          <button id="btn-manage-styles" style="font-size: .75rem; padding: .2rem .5rem;">ê´€ë¦¬</button>
        </div>
        <div id="styles-list"></div>
      </div>

      <!-- ì²˜ë¦¬ ë‹¨ê³„ -->
      <div class="box">
        <label class="label">ì²˜ë¦¬ ë‹¨ê³„<span class="label-hint">í´ë¦­ í›„ ëŒ€ê¸°</span></label>
        <div id="processing-steps"></div>
      </div>

      <!-- ì „ì²´ ë³µì‚¬ + GPT PRO ë²„íŠ¼ -->
      <div style="margin-bottom: .75rem;">
        <div class="box copy-all-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: .85rem; margin-bottom: .75rem;">
          <div class="box-title" style="font-size: .95rem; margin-bottom: .4rem; color: white; font-weight: 700;">ğŸ“‹ ê°œì¸ GPT-PRO ì‚¬ìš©</div>
          <div class="box-desc" style="font-size: .8rem; margin-bottom: .6rem; color: rgba(255,255,255,0.95);">ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­ í›„ ì‚¬ìš©í•˜ì‹œëŠ” GPTì— ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš”.</div>
          <button id="btn-copy-all" style="width: 100%; padding: .6rem; font-size: .9rem; background: white; color: #667eea; font-weight: 700; border: none; border-radius: 6px; cursor: pointer;">ì „ì²´ ë³µì‚¬</button>
        </div>
        <div class="box gpt-pro-box" style="background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); border: none; padding: .85rem;">
          <div class="box-title" style="font-size: .95rem; margin-bottom: .4rem; color: white; font-weight: 700;">ğŸš€ GPT ìµœì‹  ë²„ì „ ì´ìš©</div>
          <div class="box-desc" style="font-size: .8rem; margin-bottom: .6rem; color: rgba(255,255,255,0.95);">ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­ í•˜ì‹œë©´ ìœ ë£Œë²„ì „ GPTë¥¼ ì´ìš©í•´ì„œ ì„¤êµë¬¸ì„ ìš”ì²­í•©ë‹ˆë‹¤.</div>
          <button id="btn-gpt-pro" style="width: 100%; padding: .6rem; font-size: .9rem; background: white; color: #f5576c; font-weight: 700; border: none; border-radius: 6px; cursor: pointer;">ì„¤êµë¬¸ ì‘ì„±</button>
        </div>
      </div>

      <!-- ì €ì¥ ê³µê°„ -->
      <div class="box">
        <label class="label">ì €ì¥ëœ ì„¤êµ ìë£Œ</label>
        <button id="btn-save" style="width: 100%; margin-bottom: .5rem;">í˜„ì¬ ë‚´ìš© ì €ì¥</button>
        <div id="saved-list"></div>
      </div>

      <!-- ì¹´ì¹´ì˜¤í†¡ ë¬¸ì˜ -->
      <div class="box" style="background: linear-gradient(135deg, #FEE500 0%, #FFEB3B 100%); border: none; text-align: center; padding: 1rem;">
        <div style="font-size: .9rem; font-weight: 600; color: #3C1E1E; margin-bottom: .75rem;">
          ğŸ’¬ ë¬¸ì˜ ë° ê¶ê¸ˆì‚¬í•­
        </div>
        <a href="https://open.kakao.com/o/sfFpe12h" target="_blank" rel="noopener noreferrer"
           style="display: inline-block; background: #3C1E1E; color: #FEE500; padding: .65rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: .9rem; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"
           onmouseover="this.style.background='#2C1414'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.25)';"
           onmouseout="this.style.background='#3C1E1E'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)';">
          ğŸ’¬ ì¹´ì¹´ì˜¤í†¡ ë¬¸ì˜í•˜ê¸°
        </a>
        <div style="font-size: .7rem; color: #6D4C41; margin-top: .75rem; opacity: 0.9;">
          ğŸ“± BIBLE LAB ì˜¤í”ˆì±„íŒ…ë°©
        </div>
      </div>

    </div>

    <!-- ì˜¤ë¥¸ìª½ -->
    <div class="right-col">
      <!-- Top ì˜ì—­: ì§€ì¹¨ -->
      <div class="top-section">
      <!-- ìƒíƒœ í‘œì‹œ -->
      <div id="status-bar" class="status-bar">ì‘ì—… ì¤‘...</div>

      <!-- ê´€ë¦¬ì ê³µê°„ -->
        <div class="box" id="guide-box">
          <div style="text-align: center;">
            <div style="font-size: .85rem; color: #666; margin-bottom: .5rem; font-weight: 600;">ê´€ë¦¬ì ê³µê°„ ğŸ”’</div>
            <button id="toggle-guides" class="primary" style="width: 100%;">ê´€ë¦¬ì ê³µê°„ ì—´ê¸°</button>
          </div>
        </div>
      </div>
      <!-- Top ì˜ì—­ ë -->

      <!-- Content ì˜ì—­: ì²˜ë¦¬ ê²°ê³¼ + Q&A -->
      <div class="content-section">
        <!-- ì²˜ë¦¬ ë‹¨ê³„ + Q&A ì˜ì—­ (50:50 ë¶„í• ) -->
        <div class="processing-qa-container">
        <!-- ì™¼ìª½: ì²˜ë¦¬ ë‹¨ê³„ ê²°ê³¼ -->
        <div class="processing-steps-panel">
          <!-- ì—…ë°ì´íŠ¸ ë‚´ì—­ ì•ˆë‚´ -->
          <div id="update-notice" class="box" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border: none;">
            <div style="text-align: center; margin-bottom: 1rem;">
              <h3 style="margin: 0 0 .5rem 0; color: #667eea; font-size: 1.2rem;">ğŸ“¢ ìµœê·¼ ì—…ë°ì´íŠ¸</h3>
              <p style="margin: 0; font-size: .85rem; color: #666;">BIBLE LABì˜ ìƒˆë¡œìš´ ê¸°ëŠ¥ë“¤ì„ í™•ì¸í•´ë³´ì„¸ìš”</p>
            </div>

            <div style="background: white; border-radius: 8px; padding: 1rem;">
              <div style="margin-bottom: .75rem; padding: .6rem; border-left: 3px solid #667eea; background: #f8f9ff;">
                <div style="font-weight: 600; color: #667eea; margin-bottom: .25rem;">2025-11-19</div>
                <div style="font-size: .9rem; color: #333;">âœ¨ UI ë””ìì¸ ê°œì„  ë° ì‚¬ìš©ì ê°€ì´ë“œ ì¶”ê°€</div>
              </div>

              <div style="margin-bottom: .75rem; padding: .6rem; border-left: 3px solid #4a90e2; background: #f0f8ff;">
                <div style="font-weight: 600; color: #4a90e2; margin-bottom: .25rem;">2025-11-19</div>
                <div style="font-size: .9rem; color: #333;">ğŸ“± ëª¨ë°”ì¼ UI ìµœì í™” (Top/Content ì˜ì—­ ë¶„ë¦¬)</div>
              </div>

              <div style="margin-bottom: .75rem; padding: .6rem; border-left: 3px solid #f5576c; background: #fff5f7;">
                <div style="font-weight: 600; color: #f5576c; margin-bottom: .25rem;">2025-11-19</div>
                <div style="font-size: .9rem; color: #333;">ğŸ’¾ ë°ì´í„° ë°±ì—… ë° ë³µì› ê¸°ëŠ¥ ì¶”ê°€</div>
              </div>

              <div style="padding: .6rem; border-left: 3px solid #4caf50; background: #f1f8f4;">
                <div style="font-weight: 600; color: #4caf50; margin-bottom: .25rem;">2025-11-19</div>
                <div style="font-size: .9rem; color: #333;">ğŸ’¬ Q&A ëŒ€í™” ê¸°ëŠ¥ ì¶”ê°€</div>
              </div>
            </div>

            <div style="text-align: center; margin-top: 1rem; padding-top: .75rem; border-top: 1px solid rgba(255,255,255,0.5);">
              <p style="margin: 0; font-size: .8rem; color: #777;">ì™¼ìª½ì—ì„œ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ê³  ì„¤êµìŠ¤íƒ€ì¼ì„ ì •í•˜ì„¸ìš”! ğŸš€</p>
            </div>
          </div>

          <div id="result-boxes"></div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: Q&A ì¸í„°í˜ì´ìŠ¤ -->
        <div class="qa-panel">
          <div class="qa-interface">
            <div class="qa-prompt">ê²€ìƒ‰ëœ ê²°ê³¼ì— ëŒ€í•´ ê°„ë‹¨í•œ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”.</div>
            <div class="qa-history" id="qa-history">
              <div class="qa-empty-state">ì•„ì§ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²˜ë¦¬ ë‹¨ê³„ ê²°ê³¼ë‚˜ ë³¸ë¬¸ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”.</div>
            </div>
            <div class="qa-input-area">
              <textarea id="qa-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”. (ë¶„ì„ëœ ë‚´ìš©ì— ëŒ€í•´ì„œ ì§ˆë¬¸ í•˜ì‹œë©´, ì¶”ê°€ ë‹µë³€ì„ ë“œë¦½ë‹ˆë‹¤.)"></textarea>
              <button id="btn-send-qa" class="primary">ì „ì†¡</button>
            </div>
          </div>
        </div>
      </div>

        <!-- GPT PRO (Step3) ê²°ê³¼ ë°•ìŠ¤ -->
        <div id="gpt-pro-result-container" style="display: none;">
          <div class="gpt-pro-result-box">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
              <div class="label" style="margin: 0;">ğŸ¯ Step3. ì„¤êµë¬¸ ì™„ì„±</div>
              <span id="usage-step3" style="font-size: .75rem; color: rgba(255,255,255,0.9);"></span>
            </div>
            <textarea id="gpt-pro-result" class="autosize" readonly placeholder="Step3 ì²˜ë¦¬ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>
            <button id="btn-copy-gpt-pro" style="margin-top: .5rem; width: 100%; background: white; color: #f5576c; font-weight: 600;">ğŸ“‹ ì™„ì„±ë³¸ ë³µì‚¬</button>
          </div>
        </div>
      </div>
      <!-- Content ì˜ì—­ ë -->
    </div>
  </div>

  <!-- íŒ¨ìŠ¤ì›Œë“œ ëª¨ë‹¬ -->
  <div id="modal-password" class="modal">
    <div class="modal-content">
      <div class="modal-title">ğŸ”’ ê´€ë¦¬ì ê³µê°„ ì ê¸ˆ</div>
      <p style="color: #666; font-size: .9rem; margin-bottom: 1rem;">ê´€ë¦¬ì ê³µê°„ì— ì ‘ê·¼í•˜ë ¤ë©´ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="password" id="password-input" placeholder="íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥" style="margin-bottom: .5rem;">
      <div class="modal-buttons">
        <button id="btn-cancel-password">ì·¨ì†Œ</button>
        <button id="btn-submit-password" class="primary">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- ê´€ë¦¬ì ê³µê°„ ëª¨ë‹¬ -->
  <div id="modal-admin-panel" class="modal">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div class="modal-title" style="margin: 0;">ğŸ”’ ê´€ë¦¬ì ê³µê°„</div>
        <button id="btn-close-admin-panel" style="background: transparent; border: none; font-size: 1.5rem; cursor: pointer; padding: 0; color: #999;">&times;</button>
      </div>

      <div id="guide-content">
        <!-- AI ëª¨ë¸ ì„¤ì • (ì œì¼ ìœ„ë¡œ) -->
        <div style="margin-bottom: 1.5rem;">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: .6rem 1rem; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 1rem;">ğŸ¤– AI ëª¨ë¸ ì„¤ì •</div>
          <div style="background: #f8f5ff; padding: 1rem; border-radius: 0 0 8px 8px; border: 2px solid #667eea; border-top: none;">
            <div style="font-size: .85rem; color: #666; margin-bottom: 1rem;">
              ê° ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•  AI ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”. ë¹„ìš© ì°¨ì´ëŠ” ê¸°ì¤€ ëª¨ë¸ ëŒ€ë¹„ %ì…ë‹ˆë‹¤.
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
              <!-- Step1 ëª¨ë¸ -->
              <div style="background: white; padding: .75rem; border-radius: 8px; border: 2px solid #ff6b6b;">
                <label style="font-weight: 700; font-size: .9rem; color: #ff6b6b; display: block; margin-bottom: .4rem;">Step1 (ë³¸ë¬¸ ì—°êµ¬)</label>
                <select id="model-step1" style="width: 100%; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem;">
                  <option value="gpt-4o">GPT-4o (ê¸°ì¤€)</option>
                  <option value="gpt-4o-mini">GPT-4o Mini (-94% ì €ë ´)</option>
                  <option value="gpt-5">GPT-5 (+100%)</option>
                  <option value="gpt-5.1">GPT-5.1 (+200%)</option>
                </select>
                <div style="font-size: .7rem; color: #999; margin-top: .3rem;">ê¸°ì¤€: GPT-4o</div>
              </div>
              <!-- Step2 ëª¨ë¸ -->
              <div style="background: white; padding: .75rem; border-radius: 8px; border: 2px solid #4ecdc4;">
                <label style="font-weight: 700; font-size: .9rem; color: #4ecdc4; display: block; margin-bottom: .4rem;">Step2 (ì„¤êµ êµ¬ì¡°)</label>
                <select id="model-step2" style="width: 100%; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem;">
                  <option value="gpt-4o">GPT-4o (ê¸°ì¤€)</option>
                  <option value="gpt-4o-mini">GPT-4o Mini (-94% ì €ë ´)</option>
                  <option value="gpt-5">GPT-5 (+100%)</option>
                  <option value="gpt-5.1">GPT-5.1 (+200%)</option>
                </select>
                <div style="font-size: .7rem; color: #999; margin-top: .3rem;">ê¸°ì¤€: GPT-4o</div>
              </div>
              <!-- Step3 (ì„¤êµë¬¸ ì‘ì„±) ëª¨ë¸ -->
              <div style="background: white; padding: .75rem; border-radius: 8px; border: 2px solid #f5576c;">
                <label style="font-weight: 700; font-size: .9rem; color: #f5576c; display: block; margin-bottom: .4rem;">Step3 (ì„¤êµë¬¸ ì‘ì„±)</label>
                <select id="model-gpt-pro" style="width: 100%; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem;">
                  <option value="gpt-5">GPT-5 (ê¸°ì¤€)</option>
                  <option value="gpt-4o">GPT-4o (-50% ì €ë ´)</option>
                  <option value="gpt-5.1">GPT-5.1 (+50%)</option>
                </select>
                <div style="font-size: .7rem; color: #999; margin-top: .3rem;">ê¸°ì¤€: GPT-5</div>
              </div>
            </div>
            <!-- Step3 í† í°ëŸ‰ ì„¤ì • -->
            <div style="background: white; padding: .75rem; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: .5rem;">
              <label style="font-weight: 600; font-size: .85rem; color: #f5576c; display: block; margin-bottom: .4rem;">Step3 ìµœëŒ€ í† í°ëŸ‰</label>
              <div style="display: flex; gap: .5rem; align-items: center;">
                <input type="number" id="step3-max-tokens" value="16000" min="1000" max="32000" step="1000" style="width: 120px; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem;">
                <span style="font-size: .8rem; color: #666;">í† í° (ê¸°ë³¸: 16000, ìµœëŒ€: 32000)</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Step3 ì§€ì¹¨ ìˆ˜ì • -->
        <div style="margin-bottom: 1.5rem;">
          <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: .6rem 1rem; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 1rem;">ğŸ“ Step3 ì§€ì¹¨ (ì„¤êµë¬¸ ì‘ì„±)</div>
          <div style="background: #fff5f8; padding: 1rem; border-radius: 0 0 8px 8px; border: 2px solid #f5576c; border-top: none;">
            <div style="font-size: .85rem; color: #666; margin-bottom: .75rem;">
              ì„¤êµë¬¸ ì‘ì„± ì‹œ AIì—ê²Œ ì „ë‹¬ë˜ëŠ” ì‹œìŠ¤í…œ ì§€ì¹¨ì…ë‹ˆë‹¤. ì§ì ‘ ìˆ˜ì •í•˜ì—¬ ì›í•˜ëŠ” ìŠ¤íƒ€ì¼ë¡œ ì„¤êµë¬¸ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
            <textarea id="step3-system-prompt" style="width: 100%; min-height: 200px; padding: .75rem; border-radius: 6px; border: 1px solid #ddd; font-size: .85rem; line-height: 1.5; resize: vertical;" placeholder="Step3 ì‹œìŠ¤í…œ ì§€ì¹¨..."></textarea>
            <div class="btn-row" style="margin-top: .75rem; gap: .5rem;">
              <button id="btn-save-step3-prompt" class="primary" style="flex: 1;">Step3 ì§€ì¹¨ ì €ì¥</button>
              <button id="btn-reset-step3-prompt" style="flex: 1;">ê¸°ë³¸ê°’ ë³µì›</button>
            </div>
          </div>
        </div>

        <!-- ì²˜ë¦¬ ë‹¨ê³„ ì§€ì¹¨ -->
        <div style="margin-bottom: 1.5rem;">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: .6rem 1rem; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 1rem;">ğŸ“‹ ì²˜ë¦¬ ë‹¨ê³„ ì§€ì¹¨</div>
          <div style="background: #f8f5ff; padding: 1rem; border-radius: 0 0 8px 8px; border: 2px solid #667eea; border-top: none;">
            <div class="btn-row" style="margin-bottom: .5rem;">
              <button id="save-guide" class="primary">ì§€ì¹¨ ì €ì¥</button>
            </div>
            <div id="guide-tabs" class="btn-row" style="margin-bottom: .5rem;"></div>
            <div id="current-guide-info" style="font-size: .85rem; color: #666; margin-bottom: .5rem;"></div>
            <textarea id="guide-text" class="autosize" style="min-height: 120px;" placeholder="ì´ ì²˜ë¦¬ ë‹¨ê³„ì˜ êµ¬ì²´ì ì¸ ì§€ì¹¨ì„ ì‘ì„±í•˜ì„¸ìš”."></textarea>
          </div>
        </div>

        <!-- ë°±ì—…/ë³µì› ë²„íŠ¼ -->
        <div style="margin-bottom: 1rem;">
          <div style="background: #f8f9fa; padding: .75rem 1rem; border-radius: 8px; border: 1px solid #e0e0e0;">
            <div style="font-size: .85rem; color: #666; margin-bottom: .5rem; font-weight: 600;">ğŸ’¾ ë°ì´í„° ë°±ì—…</div>
            <div class="btn-row" style="gap: .5rem;">
              <button id="btn-export-backup" style="flex: 1; font-size: .85rem;">ë°±ì—… ë‹¤ìš´ë¡œë“œ</button>
              <button id="btn-import-backup" style="flex: 1; font-size: .85rem;">ë°±ì—… ë³µì›</button>
            </div>
            <input type="file" id="backup-file-input" accept=".json" style="display: none;">
            <div style="font-size: .75rem; color: #999; margin-top: .5rem;">
              ì •ê¸°ì ìœ¼ë¡œ ë°±ì—… íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì•ˆì „í•œ ê³³ì— ë³´ê´€í•˜ì„¸ìš”.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ì‚¬ìš© ê°€ì´ë“œ ëª¨ë‹¬ -->
  <div id="modal-guide" class="modal">
    <div class="modal-content" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div class="modal-title" style="margin: 0;">ğŸ“– ì‚¬ìš© ê°€ì´ë“œ</div>
        <button id="btn-close-guide-x" style="background: transparent; border: none; font-size: 1.5rem; cursor: pointer; padding: 0; color: #999;">&times;</button>
      </div>

      <div style="color: #555; font-size: .85rem; line-height: 1.5;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
          <strong style="font-size: 1.05rem;">ğŸ‰ BIBLE LABì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</strong><br>
          <span style="font-size: .8rem; opacity: 0.9;">í˜„ì¬ í…ŒìŠ¤íŠ¸ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤</span>
        </div>

        <div style="background: #f0f4ff; padding: .65rem; border-radius: 6px; margin-bottom: .6rem; border-left: 3px solid #667eea;">
          <strong style="color: #667eea;">1. ì¹´í…Œê³ ë¦¬ ì„ íƒ</strong><br>
          <span style="font-size: .8rem;">ì›í•˜ëŠ” ê¸°ëŠ¥ ì„ íƒ í›„ ì„±ê²½êµ¬ì ˆ ì…ë ¥ (ì˜ˆ: ì°½1:1-10 ë˜ëŠ” ì°½ì„¸ê¸° 1ì¥ 1~10ì ˆ)</span>
        </div>

        <div style="background: #f0f4ff; padding: .65rem; border-radius: 6px; margin-bottom: .6rem; border-left: 3px solid #667eea;">
          <strong style="color: #667eea;">2. ì œëª© ë° ì„±ê²½êµ¬ì ˆ</strong><br>
          <span style="font-size: .8rem;">ì„ íƒì‚¬í•­ì´ë¯€ë¡œ ê¼­ ê¸°ì…í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤</span>
        </div>

        <div style="background: #f0f4ff; padding: .65rem; border-radius: 6px; margin-bottom: .6rem; border-left: 3px solid #667eea;">
          <strong style="color: #667eea;">3. ì„¤êµìŠ¤íƒ€ì¼ ì„ íƒ</strong><br>
          <span style="font-size: .8rem;">ìŠ¤íƒ€ì¼ì„ ì„ íƒí•˜ë©´ ì²˜ë¦¬ë‹¨ê³„ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤</span>
        </div>

        <div style="background: #f0f4ff; padding: .65rem; border-radius: 6px; margin-bottom: .6rem; border-left: 3px solid #667eea;">
          <strong style="color: #667eea;">4. ì²˜ë¦¬ ì‹¤í–‰</strong><br>
          <span style="font-size: .8rem;">ê° ë‹¨ê³„ë¥¼ í´ë¦­í•˜ë©´ AIê°€ ìˆ˜í–‰í•©ë‹ˆë‹¤ (5-10ì´ˆ ì†Œìš”)</span>
        </div>

        <div style="background: #f0f4ff; padding: .65rem; border-radius: 6px; margin-bottom: .6rem; border-left: 3px solid #667eea;">
          <strong style="color: #667eea;">5. ê²°ê³¼ í™•ì¸</strong><br>
          <span style="font-size: .8rem;">ì „ì²´ ë³µì‚¬ ë˜ëŠ” í™ˆí˜ì´ì§€ì—ì„œ ì™„ì„±í˜• ì„¤êµë¬¸ ì¶œë ¥ ê°€ëŠ¥</span>
        </div>

        <div style="background: #fff9e6; padding: .65rem; border-radius: 6px; margin-bottom: .6rem; border-left: 3px solid #ffc107;">
          <strong style="color: #f57c00;">ğŸ“‹ ë³´ë¼ìƒ‰ ë²„íŠ¼</strong><br>
          <span style="font-size: .8rem;">ê°œì¸ GPT ìœ ë£Œë²„ì „ì— ë¶™ì—¬ë„£ê¸°í•˜ì—¬ ì„¤êµë¬¸ ì‘ì„±</span>
        </div>

        <div style="background: #ffe6f0; padding: .65rem; border-radius: 6px; margin-bottom: .6rem; border-left: 3px solid #f5576c;">
          <strong style="color: #c2185b;">ğŸš€ ë¶„í™ìƒ‰ ë²„íŠ¼</strong><br>
          <span style="font-size: .8rem;">í˜ì´ì§€ ë‚´ì—ì„œ ì™„ì„±í˜• ì„¤êµë¬¸ ì¶œë ¥ (ìœ ë£Œ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘)</span>
        </div>

        <div style="background: #e8f5e9; padding: .65rem; border-radius: 6px; border-left: 3px solid #4caf50;">
          <strong style="color: #2e7d32;">ğŸ’¡ TIP</strong><br>
          <span style="font-size: .8rem;">Q&Aë¥¼ í†µí•´ ë” ìì„¸í•œ ì§ˆë¬¸ì„ í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤</span>
        </div>
      </div>

      <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0;">
        <label style="display: flex; align-items: center; gap: .5rem; cursor: pointer; font-size: .85rem;">
          <input type="checkbox" id="dont-show-week" style="width: 16px; height: 16px; cursor: pointer;">
          <span>ì¼ì£¼ì¼ê°„ ë³´ì§€ ì•Šê¸°</span>
        </label>
      </div>

      <div class="modal-buttons" style="margin-top: 1rem;">
        <button id="btn-close-guide" class="primary" style="flex: 1;">ì‹œì‘í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <!-- GPT PRO íŒ¨ìŠ¤ì›Œë“œ ëª¨ë‹¬ -->
  <div id="modal-gpt-pro-password" class="modal">
    <div class="modal-content">
      <div class="modal-title">ğŸ”’ GPT PRO ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ ì¤‘)</div>
      <p style="color: #666; font-size: .9rem; margin-bottom: 1rem;">ì´ ê¸°ëŠ¥ì€ í˜„ì¬ í…ŒìŠ¤íŠ¸ ì¤‘ì…ë‹ˆë‹¤. íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="password" id="gpt-pro-password-input" placeholder="íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥" style="margin-bottom: .5rem;">
      <div class="modal-buttons">
        <button id="btn-cancel-gpt-pro-password">ì·¨ì†Œ</button>
        <button id="btn-submit-gpt-pro-password" class="primary">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- ê´€ë¦¬ ê¸°ëŠ¥ íŒ¨ìŠ¤ì›Œë“œ ëª¨ë‹¬ -->
  <div id="modal-manage-password" class="modal">
    <div class="modal-content">
      <div class="modal-title">ğŸ”’ ê´€ë¦¬ ê¸°ëŠ¥ ì ê¸ˆ</div>
      <p style="color: #666; font-size: .9rem; margin-bottom: 1rem;">ì¹´í…Œê³ ë¦¬ ë° ìŠ¤íƒ€ì¼ ê´€ë¦¬ëŠ” ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="password" id="manage-password-input" placeholder="íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥" style="margin-bottom: .5rem;">
      <div class="modal-buttons">
        <button id="btn-cancel-manage-password">ì·¨ì†Œ</button>
        <button id="btn-submit-manage-password" class="primary">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="modal-categories" class="modal">
    <div class="modal-content">
      <div class="modal-title">ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</div>
      <input type="text" id="new-cat-label" placeholder="í‘œì‹œ ì´ë¦„ (ì˜ˆ: íŠ¹ë³„ì˜ˆë°°)" style="margin-bottom: .5rem;">
      <button id="btn-add-category" class="primary" style="width: 100%; margin-bottom: 1rem;">ì¶”ê°€</button>
      <div id="categories-list" style="max-height: 300px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button id="btn-close-categories">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ìŠ¤íƒ€ì¼ ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="modal-styles" class="modal">
    <div class="modal-content">
      <div class="modal-title">ì„¤êµ ìŠ¤íƒ€ì¼ ê´€ë¦¬</div>
      <p style="font-size: .85rem; color: #666; margin-bottom: .5rem;">ì¹´í…Œê³ ë¦¬: <strong id="modal-styles-category"></strong></p>

      <input type="text" id="new-style-name" placeholder="ìŠ¤íƒ€ì¼ ì´ë¦„ (ì˜ˆ: ìƒˆë²½ì˜ˆë°° - ê°•í•´ì„¤êµ)" style="margin-bottom: .3rem;">
      <input type="text" id="new-style-desc" placeholder="ì„¤ëª… (ì˜ˆ: ë³¸ë¡  ì¤‘ì‹¬, ì•„ì´ìŠ¤ë¸Œë˜ì´í‚¹ ì œì™¸)" style="margin-bottom: .5rem;">
      <button id="btn-add-style" class="primary" style="width: 100%; margin-bottom: 1rem;">ì¶”ê°€</button>

      <div id="styles-manage-list" style="max-height: 300px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button id="btn-close-styles">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì²˜ë¦¬ ë‹¨ê³„ ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="modal-steps" class="modal">
    <div class="modal-content">
      <div class="modal-title">ì²˜ë¦¬ ë‹¨ê³„ ê´€ë¦¬</div>
      <p style="font-size: .85rem; color: #666; margin-bottom: .5rem;">
        ìŠ¤íƒ€ì¼: <strong id="modal-steps-style"></strong>
      </p>
      <input type="text" id="new-step-name" placeholder="ë‹¨ê³„ ì´ë¦„ (ì˜ˆ: ì œëª© ì¶”ì²œ, ë³¸ë¬¸ ë¶„ì„, ê°œìš” ì‘ì„±)" style="margin-bottom: .5rem;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: .5rem; margin-bottom: 1rem;">
        <button id="btn-add-step1" class="primary" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); border: none; box-shadow: 0 3px 10px rgba(255,107,107,.3);">â• Step1 ì¶”ê°€</button>
        <button id="btn-add-step2" class="primary" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a3c2 100%); border: none; box-shadow: 0 3px 10px rgba(78,205,196,.3);">â• Step2 ì¶”ê°€</button>
      </div>
      <div id="steps-list" style="max-height: 300px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button id="btn-close-steps">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- GPT ì‘ì—… ì¤‘ ë¡œë”© ì˜¤ë²„ë ˆì´ -->
  <div id="gpt-loading-overlay" style="display: none;">
    <div class="gpt-loading-content">
      <div class="gpt-loading-spinner"></div>
      <div class="gpt-loading-text">BIBLE LABì„ ì´ìš©í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤</div>
      <div class="gpt-loading-subtext">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
  // ===== Firebase ì´ˆê¸°í™” =====
  const firebaseConfig = {
    apiKey: "AIzaSyBacmJDk-PG5FaoqnXV8Rg3P__AKOS2vu4",
    authDomain: "my-sermon-guides.firebaseapp.com",
    projectId: "my-sermon-guides",
    storageBucket: "my-sermon-guides.firebasestorage.app",
    messagingSenderId: "539520456089",
    appId: "1:539520456089:web:d6aceb7838baa89e70af08",
    measurementId: "G-KWN8TH7Z26"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const USER_CODE = 'samuel123';
  const PAGE_NAME = 'sermon';
  const GUIDE_PASSWORD = '5555';
  const GPT_PRO_PASSWORD = '6039';
  const MANAGE_PASSWORD = '6039';
  const CONFIG_KEY = '_sermon-config';

  // ===== ì „ì—­ ë³€ìˆ˜ =====
  let guideUnlocked = false;
  let gptProUnlocked = false;
  let manageUnlocked = false;
  let pendingManageAction = null; // 'categories' or 'styles'
  let currentCategory = 'general';
  let currentStyleId = '';
  let currentGuideStep = '';
  let stepResults = {};
  let titleOptions = []; // ì œëª© í›„ë³´ ì €ì¥
  let selectedTitle = ''; // ì„ íƒëœ ì œëª© ì €ì¥

  // ê¸°ë³¸ ì„¤ì •
  let config = {
    categories: [
      {value: "general", label: "ì¼ë°˜ ì„¤êµ"},
      {value: "series", label: "ì‹œë¦¬ì¦ˆ ì„¤êµ"},
      {value: "education", label: "êµìœ¡"},
      {value: "lecture", label: "ê°•ì˜"}
    ],
    categorySettings: {
      general: {
        masterGuide: "",
        styles: [
          {
            id: "dawn_expository",
            name: "ìƒˆë²½ì˜ˆë°° - ê°•í•´ì„¤êµ",
            description: "ë³¸ë¡  ì¤‘ì‹¬",
            steps: [
              {id: "title", name: "ì œëª© ì¶”ì²œ", order: 1},
              {id: "analysis", name: "ë³¸ë¬¸ ë¶„ì„", order: 2},
              {id: "outline", name: "ê°œìš” ì‘ì„±", order: 3}
            ]
          },
          {
            id: "sunday_topical",
            name: "ì£¼ì¼ì˜ˆë°° - ì£¼ì œì„¤êµ",
            description: "ì£¼ì œ ì¤‘ì‹¬",
            steps: [
              {id: "title", name: "ì œëª© ì¶”ì²œ", order: 1},
              {id: "analysis", name: "ë³¸ë¬¸ ë¶„ì„", order: 2},
              {id: "outline", name: "ê°œìš” ì‘ì„±", order: 3}
            ]
          }
        ]
      },
      series: {
        masterGuide: "",
        styles: [
          {
            id: "series_continuous",
            name: "ìˆ˜ìš”ì˜ˆë°° - ì—°ì†ê°•í•´",
            description: "ì‹œë¦¬ì¦ˆí˜• ê°•í•´",
            steps: [
              {id: "title", name: "ì œëª© ì¶”ì²œ", order: 1},
              {id: "analysis", name: "ë³¸ë¬¸ ë¶„ì„", order: 2},
              {id: "outline", name: "ê°œìš” ì‘ì„±", order: 3}
            ]
          }
        ]
      },
      education: {
        masterGuide: "",
        styles: []
      },
      lecture: {
        masterGuide: "",
        styles: []
      }
    }
  };

  // ===== í•œê¸€ â†’ ì˜ë¬¸ ID ìë™ ìƒì„± =====
  function koreanToId(korean) {
    const map = {
      'ì œëª©': 'title',
      'ì•„ì´ìŠ¤ë¸Œë˜ì´í‚¹': 'icebreaking',
      'ì„œë¡ ': 'intro',
      'ë³¸ë¡ ': 'body',
      'ê²°ë¡ ': 'conclusion',
      'ë³¸ë¬¸': 'analysis',
      'ë¶„ì„': 'analysis',
      'ì‹ í•™': 'theology',
      'í•´ì„': 'interpretation',
      'ì˜ˆí™”': 'illustration',
      'ì ìš©': 'application',
      'ì‹¤ì²œ': 'practice',
      'ê³¼ì œ': 'task',
      'ì§ˆë¬¸': 'questions',
      'í† ë¡ ': 'discussion',
      'ê¸°ë„': 'prayer',
      'ê°œìš”': 'outline'
    };

    for (const [key, value] of Object.entries(map)) {
      if (korean.includes(key)) {
        return value + '_' + Date.now().toString(36);
      }
    }

    return 'step_' + Date.now().toString(36);
  }

  // ===== ìœ í‹¸ë¦¬í‹° =====
  function showStatus(msg) {
    const statusBar = document.getElementById('status-bar');
    if (statusBar) {
      statusBar.textContent = msg;
      statusBar.style.display = 'block';
    }
  }

  // ===== GPT ë¡œë”© ì˜¤ë²„ë ˆì´ =====
  function showGptLoading() {
    const overlay = document.getElementById('gpt-loading-overlay');
    if (overlay) {
      overlay.style.display = 'flex';
    }
  }

  function hideGptLoading() {
    const overlay = document.getElementById('gpt-loading-overlay');
    if (overlay) {
      overlay.style.display = 'none';
    }
  }

  // ===== ëª¨ë¸ë³„ ê°€ê²© ì •ë³´ (1M í† í°ë‹¹ USD) =====
  const modelPricing = {
    'gpt-4o-mini': { input: 0.15, output: 0.60 },
    'gpt-4o': { input: 2.50, output: 10.00 },
    'gpt-5': { input: 5.00, output: 20.00 },
    'gpt-5.1': { input: 7.50, output: 30.00 }
  };

  // ë¹„ìš© ê³„ì‚° í•¨ìˆ˜ (ì›í™”)
  function calculateCost(modelId, inputTokens, outputTokens) {
    const pricing = modelPricing[modelId];
    if (!pricing) return null;
    const inputCost = (inputTokens / 1000000) * pricing.input;
    const outputCost = (outputTokens / 1000000) * pricing.output;
    const totalUSD = inputCost + outputCost;
    const totalKRW = Math.round(totalUSD * 1400); // ì›í™” í™˜ì‚°
    return {
      inputCost: inputCost.toFixed(6),
      outputCost: outputCost.toFixed(6),
      totalCost: totalUSD.toFixed(6),
      totalCostKRW: totalKRW
    };
  }

  // Step3 ê¸°ë³¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
  const DEFAULT_STEP3_PROMPT = `ë‹¹ì‹ ì€ í•œêµ­ì–´ ì„¤êµ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ìë£ŒëŠ” ì°¸ê³ ìš©ìœ¼ë¡œë§Œ í™œìš©í•˜ê³  ë¬¸ì¥ì€ ì²˜ìŒë¶€í„° ìƒˆë¡œ êµ¬ì„±í•˜ë©°,
ë¬µì§í•˜ê³  ëª…ë£Œí•œ ì–´ì¡°ë¡œ ì‹ í•™ì  í†µì°°ê³¼ ì‹¤ì œì  ì ìš©ì„ ê· í˜• ìˆê²Œ ì œì‹œí•˜ì„¸ìš”.
ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ ëŒ€ì‹  ìˆœìˆ˜ í…ìŠ¤íŠ¸ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

Step2ì˜ ì„¤êµ êµ¬ì¡°ë¥¼ ë°˜ë“œì‹œ ë”°ë¼ ì‘ì„±í•˜ì„¸ìš”:
- Step2ì—ì„œ ì œì‹œí•œ ì„œë¡ , ë³¸ë¡ , ê²°ë¡  êµ¬ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
- Step2ì˜ ëŒ€ì§€(í¬ì¸íŠ¸) êµ¬ì„±ì„ ìœ ì§€
- ê° ì„¹ì…˜ì˜ í•µì‹¬ ë©”ì‹œì§€ë¥¼ í™•ì¥í•˜ì—¬ í’ì„±í•˜ê²Œ ì‘ì„±

âš ï¸ ì¤‘ìš”: ì¶©ë¶„íˆ ê¸¸ê³  ìƒì„¸í•˜ë©° í’ì„±í•œ ë‚´ìš©ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.`;

  // ===== ëª¨ë¸ ì„¤ì • ê´€ë¦¬ =====
  function getModelSettings(category) {
    const settings = config.categorySettings[category];
    if (!settings.modelSettings) {
      settings.modelSettings = {
        step1: 'gpt-4o',
        step2: 'gpt-4o',
        gptPro: 'gpt-5',
        step3MaxTokens: 16000,
        step3Prompt: DEFAULT_STEP3_PROMPT
      };
    }
    // ê¸°ì¡´ ì„¤ì •ì— ìƒˆ í•„ë“œê°€ ì—†ìœ¼ë©´ ì¶”ê°€
    if (!settings.modelSettings.step3MaxTokens) {
      settings.modelSettings.step3MaxTokens = 16000;
    }
    if (!settings.modelSettings.step3Prompt) {
      settings.modelSettings.step3Prompt = DEFAULT_STEP3_PROMPT;
    }
    return settings.modelSettings;
  }

  function loadModelSettings() {
    const modelSettings = getModelSettings(currentCategory);
    const step1Select = document.getElementById('model-step1');
    const step2Select = document.getElementById('model-step2');
    const gptProSelect = document.getElementById('model-gpt-pro');
    const step3MaxTokensInput = document.getElementById('step3-max-tokens');
    const step3PromptTextarea = document.getElementById('step3-system-prompt');

    if (step1Select) step1Select.value = modelSettings.step1;
    if (step2Select) step2Select.value = modelSettings.step2;
    if (gptProSelect) gptProSelect.value = modelSettings.gptPro;
    if (step3MaxTokensInput) step3MaxTokensInput.value = modelSettings.step3MaxTokens;
    if (step3PromptTextarea) step3PromptTextarea.value = modelSettings.step3Prompt;
  }

  async function saveModelSettings() {
    const step1Select = document.getElementById('model-step1');
    const step2Select = document.getElementById('model-step2');
    const gptProSelect = document.getElementById('model-gpt-pro');
    const step3MaxTokensInput = document.getElementById('step3-max-tokens');

    const modelSettings = getModelSettings(currentCategory);
    modelSettings.step1 = step1Select ? step1Select.value : 'gpt-4o';
    modelSettings.step2 = step2Select ? step2Select.value : 'gpt-4o';
    modelSettings.gptPro = gptProSelect ? gptProSelect.value : 'gpt-5';
    modelSettings.step3MaxTokens = step3MaxTokensInput ? parseInt(step3MaxTokensInput.value) || 16000 : 16000;

    await saveConfig();
  }

  async function saveStep3Prompt() {
    const step3PromptTextarea = document.getElementById('step3-system-prompt');
    if (!step3PromptTextarea) return;

    const modelSettings = getModelSettings(currentCategory);
    modelSettings.step3Prompt = step3PromptTextarea.value;
    await saveConfig();
    showStatus('âœ… Step3 ì§€ì¹¨ ì €ì¥ë¨');
    setTimeout(hideStatus, 2000);
  }

  function resetStep3Prompt() {
    const step3PromptTextarea = document.getElementById('step3-system-prompt');
    if (step3PromptTextarea) {
      step3PromptTextarea.value = DEFAULT_STEP3_PROMPT;
    }
  }

  function hideStatus() {
    const statusBar = document.getElementById('status-bar');
    if (statusBar) {
      statusBar.style.display = 'none';
    }
  }

  function autoResize(el) {
    if (!el) return;
    el.style.height = 'auto';
    el.style.height = el.scrollHeight + 'px';
  }

  // ===== Firebase í•¨ìˆ˜ (ì¬ì‹œë„ ë¡œì§ í¬í•¨) =====
  async function loadFromFirebase() {
    try {
      const snapshot = await db.collection('users').doc(USER_CODE).collection(PAGE_NAME).get();

      if (!snapshot.empty) {
        snapshot.forEach(doc => {
          localStorage.setItem(doc.id, doc.data().value);
        });

        const configData = localStorage.getItem(CONFIG_KEY);
        if (configData) {
          config = JSON.parse(configData);
        }
        console.log('âœ… Firebase ë™ê¸°í™” ì™„ë£Œ');
        return true;
      }
      return false;
    } catch (err) {
      console.error('Firebase ë¡œë“œ ì‹¤íŒ¨:', err);
      return false;
    }
  }

  async function saveToFirebase(key, value, retries = 0) {
    const MAX_RETRIES = 4;
    const RETRY_DELAYS = [2000, 4000, 8000, 16000]; // exponential backoff

    try {
      await db.collection('users').doc(USER_CODE).collection(PAGE_NAME).doc(key).set({
        value: value,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      return true;
    } catch (err) {
      console.error(`Firebase ì €ì¥ ì‹¤íŒ¨ (ì‹œë„ ${retries + 1}/${MAX_RETRIES + 1}):`, err);

      // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì¸ ê²½ìš°ì—ë§Œ ì¬ì‹œë„
      const isNetworkError = err.code === 'unavailable' || err.code === 'deadline-exceeded' ||
                             err.message.includes('network') || err.message.includes('offline');

      if (isNetworkError && retries < MAX_RETRIES) {
        const delay = RETRY_DELAYS[retries];
        console.log(`${delay}ms í›„ ì¬ì‹œë„...`);
        await new Promise(resolve => setTimeout(resolve, delay));
        return saveToFirebase(key, value, retries + 1);
      }

      return false;
    }
  }

  async function saveConfig() {
    const configStr = JSON.stringify(config);
    localStorage.setItem(CONFIG_KEY, configStr);
    const success = await saveToFirebase(CONFIG_KEY, configStr);
    if (!success) {
      console.warn('âš ï¸ Firebase ì €ì¥ ì‹¤íŒ¨ - ë¡œì»¬ì—ë§Œ ì €ì¥ë¨');
    }
  }

  // ===== ìë™ ì €ì¥ í•¨ìˆ˜ =====
  let autoSaveTimeout = null;
  const AUTO_SAVE_KEY = '_sermon-autosave';

  async function autoSaveStepResults() {
    // debounce: ë§ˆì§€ë§‰ ë³€ê²½ í›„ 2ì´ˆ ë’¤ì— ì €ì¥
    if (autoSaveTimeout) {
      clearTimeout(autoSaveTimeout);
    }

    autoSaveTimeout = setTimeout(async () => {
      const autoSaveData = {
        category: currentCategory,
        styleId: currentStyleId,
        stepResults: stepResults,
        titleOptions: titleOptions,
        selectedTitle: selectedTitle,
        timestamp: new Date().toISOString()
      };

      const autoSaveStr = JSON.stringify(autoSaveData);
      localStorage.setItem(AUTO_SAVE_KEY, autoSaveStr);

      const success = await saveToFirebase(AUTO_SAVE_KEY, autoSaveStr);
      if (success) {
        console.log('ğŸ’¾ ìë™ ì €ì¥ ì™„ë£Œ');
      } else {
        console.warn('âš ï¸ ìë™ ì €ì¥ ì‹¤íŒ¨ - ë¡œì»¬ì—ë§Œ ì €ì¥ë¨');
      }
    }, 2000);
  }

  function loadAutoSave() {
    try {
      const autoSaveStr = localStorage.getItem(AUTO_SAVE_KEY);
      if (!autoSaveStr) return false;

      const autoSaveData = JSON.parse(autoSaveStr);

      // ìë™ ì €ì¥ëœ ë°ì´í„°ê°€ í˜„ì¬ ì¹´í…Œê³ ë¦¬/ìŠ¤íƒ€ì¼ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
      if (autoSaveData.category === currentCategory && autoSaveData.styleId === currentStyleId) {
        stepResults = autoSaveData.stepResults || {};
        titleOptions = autoSaveData.titleOptions || [];
        selectedTitle = autoSaveData.selectedTitle || '';

        console.log('âœ… ìë™ ì €ì¥ëœ ë°ì´í„° ë³µì› ì™„ë£Œ');
        return true;
      }

      return false;
    } catch (err) {
      console.error('ìë™ ì €ì¥ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', err);
      return false;
    }
  }

  // ===== ì‹¤ì‹œê°„ ë™ê¸°í™” =====
  let realtimeListeners = [];
  let isUpdatingFromRemote = false;

  function setupRealtimeSync() {
    // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
    realtimeListeners.forEach(unsubscribe => unsubscribe());
    realtimeListeners = [];

    // CONFIG_KEY ì‹¤ì‹œê°„ ë™ê¸°í™”
    const configListener = db.collection('users').doc(USER_CODE).collection(PAGE_NAME).doc(CONFIG_KEY)
      .onSnapshot((doc) => {
        if (doc.exists && !isUpdatingFromRemote) {
          const remoteData = doc.data();
          const localTimestamp = localStorage.getItem(`${CONFIG_KEY}_timestamp`) || '0';
          const remoteTimestamp = remoteData.updatedAt?.toMillis().toString() || '0';

          // ì›ê²© ë°ì´í„°ê°€ ë¡œì»¬ë³´ë‹¤ ìµœì‹ ì¸ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
          if (remoteTimestamp > localTimestamp) {
            isUpdatingFromRemote = true;
            localStorage.setItem(CONFIG_KEY, remoteData.value);
            localStorage.setItem(`${CONFIG_KEY}_timestamp`, remoteTimestamp);
            config = JSON.parse(remoteData.value);

            console.log('ğŸ”„ ì„¤ì • ë™ê¸°í™”: ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì—…ë°ì´íŠ¸ë¨');

            // UI ì—…ë°ì´íŠ¸
            renderCategories();
            renderStyles();
            renderProcessingSteps();
            renderResultBoxes();
            renderGuideTabs();

            setTimeout(() => {
              isUpdatingFromRemote = false;
            }, 1000);
          }
        }
      }, (error) => {
        console.error('ì‹¤ì‹œê°„ ë™ê¸°í™” ì˜¤ë¥˜ (CONFIG):', error);
      });

    realtimeListeners.push(configListener);

    // AUTO_SAVE_KEY ì‹¤ì‹œê°„ ë™ê¸°í™”
    const autoSaveListener = db.collection('users').doc(USER_CODE).collection(PAGE_NAME).doc(AUTO_SAVE_KEY)
      .onSnapshot((doc) => {
        if (doc.exists && !isUpdatingFromRemote) {
          const remoteData = doc.data();
          const localTimestamp = localStorage.getItem(`${AUTO_SAVE_KEY}_timestamp`) || '0';
          const remoteTimestamp = remoteData.updatedAt?.toMillis().toString() || '0';

          // ì›ê²© ë°ì´í„°ê°€ ë¡œì»¬ë³´ë‹¤ ìµœì‹ ì¸ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
          if (remoteTimestamp > localTimestamp) {
            isUpdatingFromRemote = true;
            localStorage.setItem(AUTO_SAVE_KEY, remoteData.value);
            localStorage.setItem(`${AUTO_SAVE_KEY}_timestamp`, remoteTimestamp);

            const autoSaveData = JSON.parse(remoteData.value);

            // í˜„ì¬ ì¹´í…Œê³ ë¦¬/ìŠ¤íƒ€ì¼ê³¼ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ì—ë§Œ ì ìš©
            if (autoSaveData.category === currentCategory && autoSaveData.styleId === currentStyleId) {
              stepResults = autoSaveData.stepResults || {};
              titleOptions = autoSaveData.titleOptions || [];
              selectedTitle = autoSaveData.selectedTitle || '';

              console.log('ğŸ”„ ì‘ì—… ë‚´ìš© ë™ê¸°í™”: ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì—…ë°ì´íŠ¸ë¨');
              renderResultBoxes();
            }

            setTimeout(() => {
              isUpdatingFromRemote = false;
            }, 1000);
          }
        }
      }, (error) => {
        console.error('ì‹¤ì‹œê°„ ë™ê¸°í™” ì˜¤ë¥˜ (AUTOSAVE):', error);
      });

    realtimeListeners.push(autoSaveListener);
  }

  // ===== ë°±ì—… ë° ë³µì› =====
  function exportBackup() {
    try {
      const backupData = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        config: config,
        guides: {},
        savedSermons: JSON.parse(localStorage.getItem('sermon-saved') || '[]')
      };

      // ëª¨ë“  ì§€ì¹¨ ë°ì´í„° ë°±ì—…
      for (const key of Object.keys(localStorage)) {
        if (key.startsWith('guide-')) {
          backupData.guides[key] = localStorage.getItem(key);
        }
      }

      const dataStr = JSON.stringify(backupData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `sermon-backup-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showStatus('âœ… ë°±ì—… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!');
      setTimeout(hideStatus, 2000);
    } catch (err) {
      console.error('ë°±ì—… ì‹¤íŒ¨:', err);
      alert('ë°±ì—… ìƒì„± ì‹¤íŒ¨: ' + err.message);
    }
  }

  async function importBackup(file) {
    try {
      const reader = new FileReader();

      reader.onload = async (e) => {
        try {
          const backupData = JSON.parse(e.target.result);

          if (!backupData.version || !backupData.config) {
            throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤.');
          }

          const confirmed = confirm(
            `ë°±ì—… ë³µì› ì‹œ í˜„ì¬ ëª¨ë“  ì„¤ì •ì´ ë®ì–´ì“°ì—¬ì§‘ë‹ˆë‹¤.\n\n` +
            `ë°±ì—… ë‚ ì§œ: ${new Date(backupData.exportDate).toLocaleString('ko-KR')}\n\n` +
            `ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
          );

          if (!confirmed) return;

          showStatus('â™»ï¸ ë°±ì—… ë³µì› ì¤‘...');

          // Config ë³µì›
          config = backupData.config;
          await saveConfig();

          // ì§€ì¹¨ ë³µì›
          if (backupData.guides) {
            for (const [key, value] of Object.entries(backupData.guides)) {
              localStorage.setItem(key, value);
              await saveToFirebase(key, value);
            }
          }

          // ì €ì¥ëœ ì„¤êµ ë³µì›
          if (backupData.savedSermons) {
            localStorage.setItem('sermon-saved', JSON.stringify(backupData.savedSermons));
          }

          showStatus('âœ… ë°±ì—… ë³µì› ì™„ë£Œ!');

          // UI ìƒˆë¡œê³ ì¹¨
          setTimeout(() => {
            location.reload();
          }, 1500);

        } catch (err) {
          console.error('ë°±ì—… ë³µì› ì‹¤íŒ¨:', err);
          alert('ë°±ì—… ë³µì› ì‹¤íŒ¨: ' + err.message);
          hideStatus();
        }
      };

      reader.readAsText(file);
    } catch (err) {
      console.error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨:', err);
      alert('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + err.message);
    }
  }

  // ë°±ì—… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  const btnExportBackup = document.getElementById('btn-export-backup');
  if (btnExportBackup) {
    btnExportBackup.addEventListener('click', exportBackup);
  }

  const btnImportBackup = document.getElementById('btn-import-backup');
  const backupFileInput = document.getElementById('backup-file-input');

  if (btnImportBackup && backupFileInput) {
    btnImportBackup.addEventListener('click', () => {
      backupFileInput.click();
    });

    backupFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        importBackup(file);
      }
      // ê°™ì€ íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•  ìˆ˜ ìˆë„ë¡ ì´ˆê¸°í™”
      e.target.value = '';
    });
  }

  // ===== ì œëª© ê´€ë¦¬ í•¨ìˆ˜ =====
  function getSelectedTitle() {
    // ìˆ˜ë™ ì…ë ¥ ì œëª©ì´ ìˆìœ¼ë©´ ìš°ì„ 
    const manualTitle = document.getElementById('manual-title');
    if (manualTitle && manualTitle.value.trim()) {
      return manualTitle.value.trim();
    }
    // ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì„ íƒëœ ì œëª© ë°˜í™˜
    return selectedTitle;
  }

  // ===== ì œëª© ì„ íƒ ê´€ë¦¬ =====
  function displayTitleOptions(titles) {
    titleOptions = titles;
    const container = document.getElementById('title-options');
    const box = document.getElementById('title-selection-box');

    if (!container || !box) return;

    if (titles.length >= 3) {
      container.innerHTML = titles.slice(0, 3).map((title, idx) => `
        <label class="title-option-label">
          <input type="radio" name="selectedTitle" value="${idx}" style="margin-right: .5rem;" ${idx === 0 ? 'checked' : ''}>
          <span>${title}</span>
        </label>
      `).join('');

      // ì²« ë²ˆì§¸ ì œëª©ì„ ê¸°ë³¸ ì„ íƒ
      selectedTitle = titles[0];

      // ë¼ë””ì˜¤ ë²„íŠ¼ ë³€ê²½ ì´ë²¤íŠ¸
      container.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          selectedTitle = titleOptions[parseInt(e.target.value)];
          console.log('ì„ íƒëœ ì œëª©:', selectedTitle);
        });
      });

      box.style.display = 'block';
    }
  }

  // ===== ì´ê´„ ì§€ì¹¨ ê´€ë¦¬ =====
  function loadMasterGuide(category) {
    const settings = config.categorySettings[category];
    const textarea = document.getElementById('master-guide-text');
    if (textarea) {
      if (settings && settings.masterGuide) {
        textarea.value = settings.masterGuide;
      } else {
        textarea.value = '';
      }
      autoResize(textarea);
    }
  }

  async function saveMasterGuide() {
    const textarea = document.getElementById('master-guide-text');
    if (!textarea) return;

    const value = textarea.value;
    const settings = config.categorySettings[currentCategory];

    if (settings) {
      settings.masterGuide = value;
      await saveConfig();

      showStatus('âœ… ì´ê´„ ì§€ì¹¨ ì €ì¥ ì™„ë£Œ!');
      setTimeout(hideStatus, 2000);
    }
  }

  const saveMasterGuideBtn = document.getElementById('save-master-guide');
  if (saveMasterGuideBtn) {
    saveMasterGuideBtn.addEventListener('click', saveMasterGuide);
  }

  const toggleMasterGuideBtn = document.getElementById('toggle-master-guide');
  if (toggleMasterGuideBtn) {
    toggleMasterGuideBtn.addEventListener('click', () => {
      const content = document.getElementById('master-guide-content');
      const btn = document.getElementById('toggle-master-guide');

      if (content && btn) {
        if (content.style.display === 'none') {
          content.style.display = 'block';
          btn.textContent = 'ë‹«ê¸°';
          loadMasterGuide(currentCategory);
        } else {
          content.style.display = 'none';
          btn.textContent = 'ì—´ê¸°';
        }
      }
    });
  }

  // ===== ì§€ì¹¨ ê´€ë¦¬ =====
  function getGuideKey(category, stepId, styleId = currentStyleId) {
    const stylePart = styleId || 'default';
    return `guide-${category}-${stylePart}-${stepId}`;
  }

  function loadGuide(category, stepId) {
    const key = getGuideKey(category, stepId);
    const legacyKey = `guide-${category}-${stepId}`;
    const migrationKey = `guide-migrated-${category}`;
    let stored = localStorage.getItem(key);

    if (!stored) {
      const legacyValue = localStorage.getItem(legacyKey);
      const migrationTarget = localStorage.getItem(migrationKey);

      if (legacyValue && (!migrationTarget || migrationTarget === currentStyleId)) {
        stored = legacyValue;
        // ìŠ¤íƒ€ì¼ ë‹¨ìœ„ë¡œ í‚¤ë¥¼ ë¶„ë¦¬í•˜ë©´ì„œ ê¸°ì¡´ ë°ì´í„°ë¥¼ í˜„ì¬ ìŠ¤íƒ€ì¼ë¡œ ìŠ¹ê²©
        localStorage.setItem(key, stored);
        saveToFirebase(key, stored);

        if (!migrationTarget) {
          const targetStyle = currentStyleId || 'default';
          localStorage.setItem(migrationKey, targetStyle);
          saveToFirebase(migrationKey, targetStyle);
        }
      }
    }

    stored = stored || '';
    const textarea = document.getElementById('guide-text');
    if (textarea) {
      textarea.value = stored;
      autoResize(textarea);
    }

    let info = `ì¹´í…Œê³ ë¦¬: ${getCategoryLabel(category)} | ë‹¨ê³„: ${getStepName(stepId)}`;
    const infoEl = document.getElementById('current-guide-info');
    if (infoEl) {
      infoEl.textContent = info;
    }
  }

  async function saveGuide() {
    const textarea = document.getElementById('guide-text');
    if (!textarea) return;

    const key = getGuideKey(currentCategory, currentGuideStep);
    const value = textarea.value;

    localStorage.setItem(key, value);

    showStatus('ğŸ’¾ ì €ì¥ ì¤‘...');
    const success = await saveToFirebase(key, value);

    if (success) {
      showStatus('âœ… ì§€ì¹¨ ì €ì¥ ì™„ë£Œ!');
    } else {
      showStatus('âš ï¸ ë¡œì»¬ì—ë§Œ ì €ì¥ë¨');
    }

    setTimeout(hideStatus, 2000);
  }

  // ===== í—¬í¼ í•¨ìˆ˜ =====
  function getCategoryLabel(value) {
    const cat = config.categories.find(c => c.value === value);
    return cat ? cat.label : value;
  }

  function getCurrentStyle() {
    const settings = config.categorySettings[currentCategory];
    if (!settings || !settings.styles) return null;
    return settings.styles.find(s => s.id === currentStyleId);
  }

  function getCurrentSteps() {
    const style = getCurrentStyle();
    if (!style || !style.steps) return [];
    return style.steps.sort((a, b) => a.order - b.order);
  }

  function getStepName(stepId) {
    const steps = getCurrentSteps();
    const step = steps.find(s => s.id === stepId);
    return step ? step.name : stepId;
  }

  // ===== GPT PRO ì´ˆì•ˆ êµ¬ì„± ìœ í‹¸ =====
  function assembleGptProDraft() {
    const steps = getCurrentSteps();
    const ref = document.getElementById('sermon-ref').value.trim();
    const seriesName = document.getElementById('series-name').value.trim();
    const style = getCurrentStyle();
    const finalTitle = getSelectedTitle();

    if (!ref) {
      return { error: 'ì„±ê²½êµ¬ì ˆì„ ì…ë ¥í•˜ì„¸ìš”.' };
    }

    if (steps.length === 0) {
      return { error: 'ì²˜ë¦¬ëœ ë‹¨ê³„ê°€ ì—†ìŠµë‹ˆë‹¤.' };
    }

    const completedSteps = steps.filter(step => stepResults[step.id]);

    if (completedSteps.length === 0) {
      return { error: 'ì™„ì„±ëœ ë‹¨ê³„ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê° ë‹¨ê³„ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.' };
    }

    const categoryLabel = getCategoryLabel(currentCategory);
    const styleName = style ? style.name : '';
    const styleDescription = style ? style.description : '';

    let fullText = `====================================\n`;
    fullText += `ğŸ“– ì„¤êµ ì´ˆì•ˆ ìë£Œ (GPT-5.1 ì‘ì„±ìš©)\n`;
    fullText += `====================================\n\n`;
    fullText += `âš ï¸ ì¤‘ìš”: ì´ ìë£ŒëŠ” gpt-4o-miniê°€ ë§Œë“  'ì´ˆì•ˆ'ì…ë‹ˆë‹¤.\n`;
    fullText += `GPT-5.1ì€ ì´ ìë£Œë¥¼ ì°¸ê³ í•˜ë˜, ì²˜ìŒë¶€í„° ìƒˆë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n`;
    fullText += `miniê°€ ë§Œë“  ë¬¸ì¥ì„ ê·¸ëŒ€ë¡œ ë³µì‚¬í•˜ì§€ ë§ê³ , ìì—°ìŠ¤ëŸ¬ìš´ ì„¤êµë¬¸ìœ¼ë¡œ ì¬ì‘ì„±í•˜ì„¸ìš”.\n\n`;
    fullText += `${'='.repeat(50)}\n\n`;
    fullText += `ğŸ“Œ ê¸°ë³¸ ì •ë³´\n`;
    fullText += `- ì¹´í…Œê³ ë¦¬: ${categoryLabel}\n`;
    fullText += `- ìŠ¤íƒ€ì¼: ${styleName}\n`;
    if (styleDescription) {
      fullText += `- ìŠ¤íƒ€ì¼ ì„¤ëª…: ${styleDescription}\n`;
    }
    fullText += `- ì„±ê²½êµ¬ì ˆ: ${ref}\n`;
    if (finalTitle) {
      fullText += `- ì„¤êµ ì œëª©: ${finalTitle}\n`;
    }
    if (seriesName) {
      fullText += `- ì‹œë¦¬ì¦ˆëª…: ${seriesName}\n`;
    }
    fullText += `- ì‘ì„±ì¼: ${new Date().toLocaleDateString('ko-KR')}\n`;
    fullText += `\n${'='.repeat(50)}\n\n`;

    let hasContent = false;
    let sectionIndex = 1;
    completedSteps.forEach(step => {
      if (step.name === 'ì œëª© ì¶”ì²œ') return;

      hasContent = true;
      fullText += `ã€ ${sectionIndex}. ${step.name} ã€‘\n\n`;
      fullText += stepResults[step.id];
      fullText += `\n\n${'='.repeat(50)}\n\n`;
      sectionIndex += 1;
    });

    if (!hasContent) {
      return { error: 'ì œëª© ì¶”ì²œ ì™¸ì˜ ì™„ë£Œëœ ë‹¨ê³„ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë‹¨ê³„ë¥¼ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”.' };
    }

    fullText += `\nğŸ“ ì‘ì„± ì§€ì¹¨:\n`;
    fullText += `ìœ„ì˜ ì´ˆì•ˆ ìë£Œë¥¼ ì°¸ê³ í•˜ì—¬, ì™„ì„±ë„ ë†’ì€ ì„¤êµë¬¸ì„ ì²˜ìŒë¶€í„° ìƒˆë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n`;
    fullText += `âš ï¸ ì¤‘ìš”: max_tokensë¥¼ 16000ìœ¼ë¡œ ì„¤ì •í•˜ê³ , ì¶©ë¶„íˆ ê¸¸ê³  ìƒì„¸í•˜ë©° í’ì„±í•œ ë‚´ìš©ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n`;

    // ì œëª© ì¶”ì²œ ë‹¨ê³„ë¥¼ ì œì™¸í•œ ì™„ë£Œëœ ë‹¨ê³„ ì´ë¦„ë“¤
    const stepNames = completedSteps
      .filter(step => step.name !== 'ì œëª© ì¶”ì²œ')
      .map(step => step.name);

    return {
      error: null,
      fullText,
      draftContent: fullText,
      meta: {
        reference: ref,
        seriesName,
        styleName,
        styleDescription,
        finalTitle,
        categoryLabel
      },
      completedStepNames: stepNames
    };
  }

  // ===== ì „ì²´ ë³µì‚¬ ê¸°ëŠ¥ =====
  const btnCopyAll = document.getElementById('btn-copy-all');
  if (btnCopyAll) {
    btnCopyAll.addEventListener('click', () => {
      const draft = assembleGptProDraft();
      if (draft.error) {
        alert(draft.error);
        return;
      }

      const tempTextarea = document.createElement('textarea');
      tempTextarea.value = draft.fullText;
      tempTextarea.style.position = 'fixed';
      tempTextarea.style.opacity = '0';
      document.body.appendChild(tempTextarea);
      tempTextarea.select();

      try {
        document.execCommand('copy');
        showStatus('âœ… GPT-5.1ì— ë¶™ì—¬ë„£ì„ ì¤€ë¹„ ì™„ë£Œ!');
        setTimeout(hideStatus, 2000);
      } catch (err) {
        alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err.message);
      } finally {
        document.body.removeChild(tempTextarea);
      }
    });
  }

  // ===== GPT PRO ì²˜ë¦¬ ê¸°ëŠ¥ =====
  async function executeGptPro() {
    const draft = assembleGptProDraft();
    if (draft.error) {
      alert(draft.error);
      return;
    }

    // ===== 1ë‹¨ê³„: ì „ì²´ ë³µì‚¬ =====
    const tempTextarea = document.createElement('textarea');
    tempTextarea.value = draft.fullText;
    tempTextarea.style.position = 'fixed';
    tempTextarea.style.opacity = '0';
    document.body.appendChild(tempTextarea);
    tempTextarea.select();

    try {
      document.execCommand('copy');
      showStatus('ğŸ“‹ ì „ì²´ ë³µì‚¬ ì™„ë£Œ! GPT PRO ì²˜ë¦¬ ì¤‘...');
    } catch (err) {
      console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
    } finally {
      document.body.removeChild(tempTextarea);
    }

    // ===== 2ë‹¨ê³„: GPT PRO (Step3)ë¡œ ì„¤êµë¬¸ ì‘ì„± =====
    const modelSettings = getModelSettings(currentCategory);
    const gptProModel = modelSettings.gptPro;
    const step3MaxTokens = modelSettings.step3MaxTokens || 16000;
    const step3Prompt = modelSettings.step3Prompt || DEFAULT_STEP3_PROMPT;

    showGptLoading(); // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
    showStatus(`ğŸš€ Step3 (${gptProModel}) ì²˜ë¦¬ ì¤‘... (ì•½ 30ì´ˆ ì†Œìš”)`);

    try {
      const response = await fetch('/api/sermon/gpt-pro', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          model: gptProModel, // ì„ íƒëœ ëª¨ë¸ ì „ë‹¬
          maxTokens: step3MaxTokens, // ìµœëŒ€ í† í°ëŸ‰
          customSystemPrompt: step3Prompt, // ì‚¬ìš©ì ì •ì˜ ì§€ì¹¨
          reference: draft.meta.reference,
          title: draft.meta.finalTitle,
          seriesName: draft.meta.seriesName,
          styleName: draft.meta.styleName,
          styleDescription: draft.meta.styleDescription,
          category: draft.meta.categoryLabel,
          draftContent: draft.draftContent,
          completedStepNames: draft.completedStepNames
        })
      });

      const data = await response.json();

      if (data.ok) {
        const resultTextarea = document.getElementById('gpt-pro-result');
        const resultContainer = document.getElementById('gpt-pro-result-container');

        if (resultTextarea && resultContainer) {
          resultTextarea.value = data.result;
          autoResize(resultTextarea);
          resultContainer.style.display = 'block';

          // í† í° ì‚¬ìš©ëŸ‰ í‘œì‹œ
          if (data.usage) {
            const cost = calculateCost(gptProModel, data.usage.input_tokens || 0, data.usage.output_tokens || 0);
            const usageSpan = document.getElementById('usage-step3');
            if (usageSpan) {
              usageSpan.textContent = `in(${(data.usage.input_tokens || 0).toLocaleString()}), out(${(data.usage.output_tokens || 0).toLocaleString()}), â‚©${cost ? cost.totalCostKRW : 0}`;
            }
          }

          // ê²°ê³¼ ë°•ìŠ¤ë¡œ ìŠ¤í¬ë¡¤
          resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        showStatus('âœ… ì „ì²´ ë³µì‚¬ + Step3 ì™„ì„±!');
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
        showStatus('âŒ ì‹¤íŒ¨');
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
      showStatus('âŒ ì˜¤ë¥˜');
    } finally {
      hideGptLoading(); // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
      setTimeout(hideStatus, 3000);
    }
  }

  const btnGptPro = document.getElementById('btn-gpt-pro');
  if (btnGptPro) {
    btnGptPro.addEventListener('click', () => {
      if (!gptProUnlocked) {
        // íŒ¨ìŠ¤ì›Œë“œ ëª¨ë‹¬ í‘œì‹œ
        const modal = document.getElementById('modal-gpt-pro-password');
        if (modal) modal.classList.add('show');
        const input = document.getElementById('gpt-pro-password-input');
        if (input) {
          input.value = '';
          input.focus();
        }
      } else {
        // ì´ë¯¸ ì ê¸ˆ í•´ì œëœ ê²½ìš° ë°”ë¡œ ì‹¤í–‰
        executeGptPro();
      }
    });
  }

  // GPT PRO ê²°ê³¼ ë³µì‚¬
  const btnCopyGptPro = document.getElementById('btn-copy-gpt-pro');
  if (btnCopyGptPro) {
    btnCopyGptPro.addEventListener('click', () => {
      const textarea = document.getElementById('gpt-pro-result');
      if (textarea && textarea.value) {
        textarea.select();
        document.execCommand('copy');
        const orig = btnCopyGptPro.textContent;
        btnCopyGptPro.textContent = 'âœ… ë³µì‚¬ë¨!';
        setTimeout(() => btnCopyGptPro.textContent = orig, 1500);
      }
    });
  }

  // ===== ë Œë”ë§ í•¨ìˆ˜ =====
  function renderCategories() {
    const select = document.getElementById('sermon-category');
    if (!select) return;

    const current = select.value;
    select.innerHTML = config.categories.map(c =>
      `<option value="${c.value}">${c.label}</option>`
    ).join('');

    if (current && config.categories.find(c => c.value === current)) {
      select.value = current;
    } else {
      select.value = config.categories[0].value;
    }
    currentCategory = select.value;
  }

  function renderStyles() {
    const settings = config.categorySettings[currentCategory];
    const styles = (settings && settings.styles) ? settings.styles : [];
    const container = document.getElementById('styles-list');

    if (!container) return;

    if (styles.length === 0) {
      container.innerHTML = '<p style="color: #999; font-size: .85rem; text-align: center;">ìŠ¤íƒ€ì¼ì„ ì¶”ê°€í•˜ì„¸ìš”.</p>';
      return;
    }

    container.innerHTML = styles.map(style =>
      `<div class="style-item ${style.id === currentStyleId ? 'active' : ''}" data-style="${style.id}">
        <div>
          <div style="font-weight: 600;">${style.name}</div>
          <div class="style-desc">${style.description || ''}</div>
        </div>
      </div>`
    ).join('');

    container.querySelectorAll('.style-item').forEach(item => {
      item.addEventListener('click', () => {
        currentStyleId = item.dataset.style;
        stepResults = {};
        titleOptions = [];
        selectedTitle = '';
        const titleBox = document.getElementById('title-selection-box');
        if (titleBox) titleBox.style.display = 'none';
        const gptProContainer = document.getElementById('gpt-pro-result-container');
        if (gptProContainer) gptProContainer.style.display = 'none';
        renderStyles();
        renderProcessingSteps();
        renderResultBoxes();
        renderGuideTabs();
      });
    });

    // ìƒˆë¡œê³ ì¹¨ ì‹œ ìë™ ì„ íƒ ë¹„í™œì„±í™” - ì‚¬ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ ì„ íƒí•˜ë„ë¡ í•¨
    // if (!currentStyleId && styles.length > 0) {
    //   currentStyleId = styles[0].id;
    //   renderStyles();
    // }
  }

  function renderProcessingSteps() {
    const steps = getCurrentSteps();
    const container = document.getElementById('processing-steps');

    if (!container) return;

    if (steps.length === 0) {
      container.innerHTML = '<p style="color: #999; font-size: .85rem; text-align: center;">ë‹¨ê³„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>';
      return;
    }

    container.innerHTML = steps.map(step =>
      `<button class="step-btn primary" data-step="${step.id}">${step.name} <span style="float: right;">(í´ë¦­!)</span></button>`
    ).join('');

    container.querySelectorAll('.step-btn').forEach(btn => {
      btn.addEventListener('click', () => executeStep(btn.dataset.step));
    });
  }

  // Step2 ê²°ê³¼ë¥¼ ì„œë¡ ê¹Œì§€ë§Œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
  function truncateToIntro(text) {
    if (!text) return '';

    // ì„œë¡  ì´í›„ì˜ íŒ¨í„´ë“¤ (ë³¸ë¡ , 1ëŒ€ì§€, ëŒ€ì§€1, ì²« ë²ˆì§¸, Conflict ë“±)
    const cutoffPatterns = [
      /\n\s*(ë³¸ë¡ |1ëŒ€ì§€|ëŒ€ì§€\s*1|ì²«\s*ë²ˆì§¸|First|Conflict|ë³¸ë¬¸\s*1|I\.|1\.|í•˜ë‚˜\.|ì²«ì§¸)/i,
      /\n\s*[-=]{3,}/,  // êµ¬ë¶„ì„ 
    ];

    let cutIndex = text.length;

    for (const pattern of cutoffPatterns) {
      const match = text.match(pattern);
      if (match && match.index < cutIndex) {
        cutIndex = match.index;
      }
    }

    // ì„œë¡  ë¶€ë¶„ë§Œ ì¶”ì¶œ
    let intro = text.substring(0, cutIndex).trim();

    // ìµœì†Œ 100ì ì´ìƒì€ ë³´ì—¬ì£¼ê¸°
    if (intro.length < 100 && text.length > 100) {
      intro = text.substring(0, 300).trim();
    }

    return intro;
  }

  // í† í° ì‚¬ìš©ëŸ‰ ì €ì¥
  let stepUsage = {};

  function renderResultBoxes() {
    const steps = getCurrentSteps();
    const container = document.getElementById('result-boxes');
    const updateNotice = document.getElementById('update-notice');
    const modelSettings = getModelSettings(currentCategory);

    if (!container) return;

    // ì—…ë°ì´íŠ¸ ì•ˆë‚´ í‘œì‹œ/ìˆ¨ê¹€
    if (updateNotice) {
      updateNotice.style.display = steps.length === 0 ? 'block' : 'none';
    }

    container.innerHTML = steps.map(step => {
      const stepType = step.stepType || 'step1';
      const stepLabel = stepType === 'step1' ? 'Step1' : 'Step2';
      const usage = stepUsage[step.id];
      const usageHtml = usage ? `
        <span id="usage-${step.id}" style="font-size: .75rem; color: #888;">
          in(${usage.inputTokens?.toLocaleString() || 0}), out(${usage.outputTokens?.toLocaleString() || 0}), â‚©${usage.costKRW || 0}
        </span>
      ` : `<span id="usage-${step.id}" style="font-size: .75rem; color: #888;"></span>`;

      if (step.id === 'step2' || stepType === 'step2') {
        // Step2ëŠ” ì„œë¡ ê¹Œì§€ë§Œ í‘œì‹œ + ë”ë³´ê¸° í‘œì‹œ
        return `
          <div class="box step2-box">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .35rem;">
              <label class="label" style="margin: 0;">${stepLabel}. ${step.name}</label>
              ${usageHtml}
            </div>
            <div class="step2-content-wrapper">
              <textarea id="result-${step.id}" class="autosize" style="min-height: 100px; max-height: 150px;" readonly placeholder="${step.name} ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤."></textarea>
              <div class="step2-gradient-overlay"></div>
            </div>
            <div style="text-align: center; color: #999; font-size: .85rem; padding: .5rem; border-top: 1px dashed #ddd; margin-top: .3rem;">
              -<br>-<br>-<br>
              <span style="font-size: .75rem;">ì´í•˜ ë‚´ìš© ìƒëµ</span>
            </div>
          </div>
        `;
      } else {
        return `
          <div class="box">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .35rem;">
              <label class="label" style="margin: 0;">${stepLabel}. ${step.name}</label>
              ${usageHtml}
            </div>
            <textarea id="result-${step.id}" class="autosize" style="min-height: 140px;" placeholder="${step.name} ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤."></textarea>
          </div>
        `;
      }
    }).join('');

    // ê²°ê³¼ ë³µì› ë° ìë™ ë†’ì´
    steps.forEach(step => {
      if (stepResults[step.id]) {
        const textarea = document.getElementById(`result-${step.id}`);
        if (textarea) {
          // Step2ëŠ” ì„œë¡ ê¹Œì§€ë§Œ í‘œì‹œ
          if (step.id === 'step2') {
            textarea.value = truncateToIntro(stepResults[step.id]);
          } else {
            textarea.value = stepResults[step.id];
            autoResize(textarea);
          }
        }
      }
    });

    // ì…ë ¥ ì´ë²¤íŠ¸ë¡œ ìë™ ë†’ì´ + ê²°ê³¼ ì €ì¥
    container.querySelectorAll('textarea').forEach(textarea => {
      textarea.addEventListener('input', () => {
        autoResize(textarea);
        // ì‚¬ìš©ìê°€ í¸ì§‘í•œ ë‚´ìš©ì„ stepResultsì— ì €ì¥
        const stepId = textarea.id.replace('result-', '');
        stepResults[stepId] = textarea.value;
        // ìë™ ì €ì¥
        autoSaveStepResults();
      });
    });
  }

  function renderGuideTabs() {
    const steps = getCurrentSteps();
    const container = document.getElementById('guide-tabs');

    if (!container) return;

    if (!steps.find(step => step.id === currentGuideStep)) {
      currentGuideStep = steps.length > 0 ? steps[0].id : '';
    }

    container.innerHTML = steps.map(step =>
      `<button class="${step.id === currentGuideStep ? 'primary' : ''}"
        data-step="${step.id}">${step.name}</button>`
    ).join('');

    container.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        currentGuideStep = btn.dataset.step;
        renderGuideTabs();
        loadGuide(currentCategory, currentGuideStep);
      });
    });
  }

  // ===== ì²˜ë¦¬ ë‹¨ê³„ ì‹¤í–‰ =====
  async function executeStep(stepId) {
    const ref = document.getElementById('sermon-ref').value;
    if (!ref) {
      alert('ì„±ê²½êµ¬ì ˆì„ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    const text = document.getElementById('sermon-text').value;
    const guideKey = getGuideKey(currentCategory, stepId);
    const guide = localStorage.getItem(guideKey) || '';

    // ì´ê´„ ì§€ì¹¨ ê°€ì ¸ì˜¤ê¸°
    const settings = config.categorySettings[currentCategory];
    const masterGuide = settings ? settings.masterGuide : '';

    const steps = getCurrentSteps();
    const currentStepIndex = steps.findIndex(s => s.id === stepId);
    const currentStep = steps[currentStepIndex];
    const stepType = currentStep ? (currentStep.stepType || 'step1') : 'step1';

    // ì„ íƒëœ ëª¨ë¸ ê°€ì ¸ì˜¤ê¸°
    const modelSettings = getModelSettings(currentCategory);
    const selectedModel = stepType === 'step1' ? modelSettings.step1 : modelSettings.step2;

    const previousResults = {};
    for (let i = 0; i < currentStepIndex; i++) {
      const prevStep = steps[i];
      if (stepResults[prevStep.id]) {
        previousResults[prevStep.id] = {
          name: prevStep.name,
          result: stepResults[prevStep.id]
        };
      }
    }

    showGptLoading(); // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
    showStatus(`ğŸ¤– ${getStepName(stepId)} ì²˜ë¦¬ ì¤‘...`);

    try {
      const response = await fetch('/api/sermon/process', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          category: currentCategory,
          stepId: stepId,
          stepName: getStepName(stepId),
          stepType: stepType,
          model: selectedModel, // ì„ íƒëœ ëª¨ë¸ ì „ë‹¬
          reference: ref,
          title: getSelectedTitle(), // í˜„ì¬ ì œëª© ì „ë‹¬
          text: text,
          guide: guide,
          masterGuide: masterGuide,
          previousResults: previousResults
        })
      });

      const data = await response.json();

      if (data.ok) {
        stepResults[stepId] = data.result;  // ì „ì²´ ê²°ê³¼ëŠ” ì €ì¥
        const textarea = document.getElementById(`result-${stepId}`);
        if (textarea) {
          // Step2ëŠ” ì„œë¡ ê¹Œì§€ë§Œ í‘œì‹œ
          if (stepId === 'step2' || stepType === 'step2') {
            textarea.value = truncateToIntro(data.result);
          } else {
            textarea.value = data.result;
            autoResize(textarea);
          }
        }

        // í† í° ì‚¬ìš©ëŸ‰ í‘œì‹œ
        if (data.usage) {
          const cost = calculateCost(selectedModel, data.usage.input_tokens || 0, data.usage.output_tokens || 0);
          stepUsage[stepId] = {
            inputTokens: data.usage.input_tokens || 0,
            outputTokens: data.usage.output_tokens || 0,
            model: selectedModel,
            costKRW: cost ? cost.totalCostKRW : 0
          };
          // ì‚¬ìš©ëŸ‰ í‘œì‹œ ì—…ë°ì´íŠ¸
          const usageSpan = document.getElementById(`usage-${stepId}`);
          if (usageSpan) {
            usageSpan.textContent = `in(${(data.usage.input_tokens || 0).toLocaleString()}), out(${(data.usage.output_tokens || 0).toLocaleString()}), â‚©${cost ? cost.totalCostKRW : 0}`;
          }
        }

        // ì œëª© ì¶”ì²œ ë‹¨ê³„ì¸ ê²½ìš° ë¼ë””ì˜¤ ë²„íŠ¼ í‘œì‹œ
        const stepName = getStepName(stepId);
        if (stepName.includes('ì œëª©')) {
          const lines = data.result.trim().split('\n').filter(line => line.trim());
          if (lines.length >= 3) {
            displayTitleOptions(lines.slice(0, 3));
          }
        }

        // ìë™ ì €ì¥
        autoSaveStepResults();

        showStatus('âœ… ì™„ë£Œ!');
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
        showStatus('âŒ ì‹¤íŒ¨');
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
      showStatus('âŒ ì˜¤ë¥˜');
    } finally {
      hideGptLoading(); // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
      setTimeout(hideStatus, 2000);
    }
  }

  // ===== ì¹´í…Œê³ ë¦¬ ë³€ê²½ =====
  const categorySelect = document.getElementById('sermon-category');
  if (categorySelect) {
    categorySelect.addEventListener('change', (e) => {
      currentCategory = e.target.value;
      currentStyleId = '';
      stepResults = {};
      stepUsage = {};  // í† í° ì‚¬ìš©ëŸ‰ë„ ì´ˆê¸°í™”
      titleOptions = [];
      selectedTitle = '';
      const titleBox = document.getElementById('title-selection-box');
      if (titleBox) titleBox.style.display = 'none';
      const gptProContainer = document.getElementById('gpt-pro-result-container');
      if (gptProContainer) gptProContainer.style.display = 'none';

      loadMasterGuide(currentCategory);
      loadModelSettings(); // ëª¨ë¸ ì„¤ì • ë¡œë“œ
      renderStyles();
      renderProcessingSteps();
      renderResultBoxes();
      renderGuideTabs();

      const seriesBox = document.getElementById('series-box');
      if (seriesBox) {
        if (currentCategory === 'series') {
          seriesBox.style.display = 'block';
        } else {
          seriesBox.style.display = 'none';
        }
      }
    });
  }

  // ===== íŒ¨ìŠ¤ì›Œë“œ =====
  const toggleGuidesBtn = document.getElementById('toggle-guides');
  if (toggleGuidesBtn) {
    toggleGuidesBtn.addEventListener('click', () => {
      if (!guideUnlocked) {
        const modal = document.getElementById('modal-password');
        if (modal) modal.classList.add('show');
        const input = document.getElementById('password-input');
        if (input) {
          input.value = '';
          input.focus();
        }
      } else {
        const adminModal = document.getElementById('modal-admin-panel');
        if (adminModal) adminModal.classList.add('show');

        const steps = getCurrentSteps();
        if (steps.length > 0) {
          currentGuideStep = steps[0].id;
          renderGuideTabs();
          loadGuide(currentCategory, currentGuideStep);
        }
      }
    });
  }

  const btnCloseAdminPanel = document.getElementById('btn-close-admin-panel');
  if (btnCloseAdminPanel) {
    btnCloseAdminPanel.addEventListener('click', () => {
      const modal = document.getElementById('modal-admin-panel');
      if (modal) modal.classList.remove('show');
    });
  }

  const btnSubmitPassword = document.getElementById('btn-submit-password');
  if (btnSubmitPassword) {
    btnSubmitPassword.addEventListener('click', () => {
      const input = document.getElementById('password-input');
      if (input && input.value === GUIDE_PASSWORD) {
        guideUnlocked = true;
        const modal = document.getElementById('modal-password');
        if (modal) modal.classList.remove('show');

        const adminModal = document.getElementById('modal-admin-panel');
        if (adminModal) adminModal.classList.add('show');

        const steps = getCurrentSteps();
        if (steps.length > 0) {
          currentGuideStep = steps[0].id;
          renderGuideTabs();
          loadGuide(currentCategory, currentGuideStep);
        }
      } else {
        alert('âŒ íŒ¨ìŠ¤ì›Œë“œê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        if (input) input.value = '';
      }
    });
  }

  const btnCancelPassword = document.getElementById('btn-cancel-password');
  if (btnCancelPassword) {
    btnCancelPassword.addEventListener('click', () => {
      const modal = document.getElementById('modal-password');
      if (modal) modal.classList.remove('show');
    });
  }

  // ì‚¬ìš© ê°€ì´ë“œ ëª¨ë‹¬ ë‹«ê¸°
  function closeGuideModal() {
    const modal = document.getElementById('modal-guide');
    const dontShowCheckbox = document.getElementById('dont-show-week');

    if (dontShowCheckbox && dontShowCheckbox.checked) {
      // ì¼ì£¼ì¼(7ì¼) í›„ê¹Œì§€ ìˆ¨ê¸°ê¸°
      const hideUntil = Date.now() + (7 * 24 * 60 * 60 * 1000);
      localStorage.setItem('sermon-guide-hide-until', hideUntil.toString());
    } else {
      // ë‹¤ìŒ ë°©ë¬¸ì‹œì—ëŠ” í‘œì‹œ
      localStorage.removeItem('sermon-guide-hide-until');
    }

    if (modal) modal.classList.remove('show');
  }

  const btnCloseGuide = document.getElementById('btn-close-guide');
  if (btnCloseGuide) {
    btnCloseGuide.addEventListener('click', closeGuideModal);
  }

  const btnCloseGuideX = document.getElementById('btn-close-guide-x');
  if (btnCloseGuideX) {
    btnCloseGuideX.addEventListener('click', closeGuideModal);
  }

  const passwordInput = document.getElementById('password-input');
  if (passwordInput) {
    passwordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const btn = document.getElementById('btn-submit-password');
        if (btn) btn.click();
      }
    });
  }

  const saveGuideBtn = document.getElementById('save-guide');
  if (saveGuideBtn) {
    saveGuideBtn.addEventListener('click', saveGuide);
  }

  // ===== ê´€ë¦¬ ê¸°ëŠ¥ íŒ¨ìŠ¤ì›Œë“œ =====
  const btnSubmitManagePassword = document.getElementById('btn-submit-manage-password');
  if (btnSubmitManagePassword) {
    btnSubmitManagePassword.addEventListener('click', () => {
      const input = document.getElementById('manage-password-input');
      if (input && input.value === MANAGE_PASSWORD) {
        manageUnlocked = true;
        const modal = document.getElementById('modal-manage-password');
        if (modal) modal.classList.remove('show');

        // íŒ¨ìŠ¤ì›Œë“œ í™•ì¸ í›„ ìš”ì²­ëœ ê´€ë¦¬ ëª¨ë‹¬ í‘œì‹œ
        if (pendingManageAction === 'categories') {
          renderCategoryManageList();
          const categoriesModal = document.getElementById('modal-categories');
          if (categoriesModal) categoriesModal.classList.add('show');
        } else if (pendingManageAction === 'styles') {
          const categoryLabel = document.getElementById('modal-styles-category');
          if (categoryLabel) {
            categoryLabel.textContent = getCategoryLabel(currentCategory);
          }
          renderStylesManageList();
          const stylesModal = document.getElementById('modal-styles');
          if (stylesModal) stylesModal.classList.add('show');
        }
        pendingManageAction = null;
      } else {
        alert('âŒ íŒ¨ìŠ¤ì›Œë“œê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        if (input) input.value = '';
      }
    });
  }

  const btnCancelManagePassword = document.getElementById('btn-cancel-manage-password');
  if (btnCancelManagePassword) {
    btnCancelManagePassword.addEventListener('click', () => {
      pendingManageAction = null;
      const modal = document.getElementById('modal-manage-password');
      if (modal) modal.classList.remove('show');
    });
  }

  const managePasswordInput = document.getElementById('manage-password-input');
  if (managePasswordInput) {
    managePasswordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const btn = document.getElementById('btn-submit-manage-password');
        if (btn) btn.click();
      }
    });
  }

  // ===== GPT PRO íŒ¨ìŠ¤ì›Œë“œ =====
  const btnSubmitGptProPassword = document.getElementById('btn-submit-gpt-pro-password');
  if (btnSubmitGptProPassword) {
    btnSubmitGptProPassword.addEventListener('click', () => {
      const input = document.getElementById('gpt-pro-password-input');
      if (input && input.value === GPT_PRO_PASSWORD) {
        gptProUnlocked = true;
        const modal = document.getElementById('modal-gpt-pro-password');
        if (modal) modal.classList.remove('show');

        // íŒ¨ìŠ¤ì›Œë“œ í™•ì¸ í›„ GPT PRO ì‹¤í–‰
        executeGptPro();
      } else {
        alert('âŒ íŒ¨ìŠ¤ì›Œë“œê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        if (input) input.value = '';
      }
    });
  }

  const btnCancelGptProPassword = document.getElementById('btn-cancel-gpt-pro-password');
  if (btnCancelGptProPassword) {
    btnCancelGptProPassword.addEventListener('click', () => {
      const modal = document.getElementById('modal-gpt-pro-password');
      if (modal) modal.classList.remove('show');
    });
  }

  const gptProPasswordInput = document.getElementById('gpt-pro-password-input');
  if (gptProPasswordInput) {
    gptProPasswordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const btn = document.getElementById('btn-submit-gpt-pro-password');
        if (btn) btn.click();
      }
    });
  }

  // ===== ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ =====
  function renderCategoryManageList() {
    const list = document.getElementById('categories-list');
    if (!list) return;

    if (config.categories.length === 0) {
      list.innerHTML = '<p style="color: #999; font-size: .8rem; text-align: center; padding: .5rem;">ì¹´í…Œê³ ë¦¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>';
      return;
    }

    list.innerHTML = config.categories.map((cat, idx) => `
      <div class="storage-item">
        <div>
          <div style="font-weight: 600;">${cat.label}</div>
          <div style="font-size: .75rem; color: #666;">${cat.value}</div>
        </div>
        <div>
          <button onclick="editCategory(${idx})" style="margin-right: .3rem;">ì´ë¦„ ìˆ˜ì •</button>
          ${config.categories.length > 1 ? `<button class="danger" onclick="deleteCategory(${idx})">ì‚­ì œ</button>` : ''}
        </div>
      </div>
    `).join('');
  }

  const btnManageCategories = document.getElementById('btn-manage-categories');
  if (btnManageCategories) {
    btnManageCategories.addEventListener('click', () => {
      if (manageUnlocked) {
        // ì´ë¯¸ ì ê¸ˆ í•´ì œëœ ê²½ìš° ë°”ë¡œ ëª¨ë‹¬ í‘œì‹œ
        renderCategoryManageList();
        const modal = document.getElementById('modal-categories');
        if (modal) modal.classList.add('show');
      } else {
        // íŒ¨ìŠ¤ì›Œë“œ í™•ì¸ í•„ìš”
        pendingManageAction = 'categories';
        const modal = document.getElementById('modal-manage-password');
        if (modal) modal.classList.add('show');
        const input = document.getElementById('manage-password-input');
        if (input) {
          input.value = '';
          setTimeout(() => input.focus(), 100);
        }
      }
    });
  }

  const btnCloseCategories = document.getElementById('btn-close-categories');
  if (btnCloseCategories) {
    btnCloseCategories.addEventListener('click', () => {
      const modal = document.getElementById('modal-categories');
      if (modal) modal.classList.remove('show');
    });
  }

  const btnAddCategory = document.getElementById('btn-add-category');
  if (btnAddCategory) {
    btnAddCategory.addEventListener('click', async () => {
      const input = document.getElementById('new-cat-label');
      if (!input) return;

      const label = input.value.trim();

      if (!label) {
        alert('í‘œì‹œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      const value = koreanToId(label);

      if (config.categories.find(c => c.value === value)) {
        alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¹´í…Œê³ ë¦¬ì…ë‹ˆë‹¤.');
        return;
      }

      config.categories.push({value, label});
      config.categorySettings[value] = {
        masterGuide: "",
        styles: []
      };

      await saveConfig();
      renderCategories();
      renderCategoryManageList();
      input.value = '';
    });
  }

  window.editCategory = async function(idx) {
    const current = config.categories[idx];
    if (!current) return;

    const newLabel = prompt('ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', current.label);
    if (newLabel === null) return;

    const trimmed = newLabel.trim();
    if (!trimmed) {
      alert('í‘œì‹œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    current.label = trimmed;
    await saveConfig();
    renderCategories();
    renderCategoryManageList();
    if (current.value === currentCategory) {
      loadMasterGuide(currentCategory);
      renderStyles();
      renderProcessingSteps();
      renderResultBoxes();
      renderGuideTabs();
    }
  };

  window.deleteCategory = async function(idx) {
    if (!confirm(`"${config.categories[idx].label}" ì‚­ì œ?`)) return;
    const value = config.categories[idx].value;
    config.categories.splice(idx, 1);
    delete config.categorySettings[value];
    await saveConfig();
    renderCategories();
    renderCategoryManageList();
    loadMasterGuide(currentCategory);
    renderStyles();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
  };

  // ===== ìŠ¤íƒ€ì¼ ê´€ë¦¬ =====
  const btnManageStyles = document.getElementById('btn-manage-styles');
  if (btnManageStyles) {
    btnManageStyles.addEventListener('click', () => {
      if (manageUnlocked) {
        // ì´ë¯¸ ì ê¸ˆ í•´ì œëœ ê²½ìš° ë°”ë¡œ ëª¨ë‹¬ í‘œì‹œ
        const categoryLabel = document.getElementById('modal-styles-category');
        if (categoryLabel) {
          categoryLabel.textContent = getCategoryLabel(currentCategory);
        }

        renderStylesManageList();
        const modal = document.getElementById('modal-styles');
        if (modal) modal.classList.add('show');
      } else {
        // íŒ¨ìŠ¤ì›Œë“œ í™•ì¸ í•„ìš”
        pendingManageAction = 'styles';
        const modal = document.getElementById('modal-manage-password');
        if (modal) modal.classList.add('show');
        const input = document.getElementById('manage-password-input');
        if (input) {
          input.value = '';
          setTimeout(() => input.focus(), 100);
        }
      }
    });
  }

  function renderStylesManageList() {
    const list = document.getElementById('styles-manage-list');
    if (!list) return;

    const settings = config.categorySettings[currentCategory];
    const styles = (settings && settings.styles) ? settings.styles : [];

    if (styles.length === 0) {
      list.innerHTML = '<p style="color: #999; font-size: .8rem; text-align: center; padding: .5rem;">ìŠ¤íƒ€ì¼ì„ ì¶”ê°€í•˜ì„¸ìš”.</p>';
      return;
    }

    list.innerHTML = styles.map((style, idx) => `
      <div class="storage-item">
        <div>
          <div style="font-weight: 600;">${style.name}</div>
          <div style="font-size: .75rem; color: #666;">${style.description || ''}</div>
        </div>
        <div>
          <button onclick="editStyle(${idx})" style="margin-right: .3rem;">ì´ë¦„ ìˆ˜ì •</button>
          <button onclick="editStyleSteps('${style.id}')" style="margin-right: .3rem;">ë‹¨ê³„ í¸ì§‘</button>
          <button onclick="duplicateStyle(${idx})" style="margin-right: .3rem; background: #4CAF50; color: white;">ë³µì œ</button>
          <button class="danger" onclick="deleteStyle(${idx})">ì‚­ì œ</button>
        </div>
      </div>
    `).join('');
  }

  const btnCloseStyles = document.getElementById('btn-close-styles');
  if (btnCloseStyles) {
    btnCloseStyles.addEventListener('click', () => {
      const modal = document.getElementById('modal-styles');
      if (modal) modal.classList.remove('show');
    });
  }

  const btnAddStyle = document.getElementById('btn-add-style');
  if (btnAddStyle) {
    btnAddStyle.addEventListener('click', async () => {
      const nameInput = document.getElementById('new-style-name');
      const descInput = document.getElementById('new-style-desc');

      if (!nameInput) return;

      const name = nameInput.value.trim();
      const desc = descInput ? descInput.value.trim() : '';

      if (!name) {
        alert('ìŠ¤íƒ€ì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      const id = koreanToId(name);
      const settings = config.categorySettings[currentCategory];

      if (!settings.styles) {
        settings.styles = [];
      }

      settings.styles.push({
        id: id,
        name: name,
        description: desc,
        steps: []
      });

      await saveConfig();
      renderStyles();
      renderStylesManageList();
      nameInput.value = '';
      if (descInput) descInput.value = '';
    });
  }

  window.editStyle = async function(idx) {
    const settings = config.categorySettings[currentCategory];
    if (!settings || !settings.styles) return;

    const style = settings.styles[idx];
    if (!style) return;

    const newName = prompt('ìƒˆ ìŠ¤íƒ€ì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', style.name);
    if (newName === null) return;

    const trimmedName = newName.trim();
    if (!trimmedName) {
      alert('ìŠ¤íƒ€ì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    const newDesc = prompt('ìŠ¤íƒ€ì¼ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.', style.description || '');
    if (newDesc === null) return;

    style.name = trimmedName;
    style.description = newDesc.trim();

    await saveConfig();
    renderStyles();
    renderStylesManageList();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
  };

  window.deleteStyle = async function(idx) {
    const settings = config.categorySettings[currentCategory];
    if (!settings || !settings.styles) return;

    const style = settings.styles[idx];
    if (!confirm(`"${style.name}" ì‚­ì œ?`)) return;

    // ìŠ¤íƒ€ì¼ ì‚­ì œ ì‹œ ê´€ë ¨ ì§€ì¹¨ë„ ëª¨ë‘ ì‚­ì œ
    if (style.steps && style.steps.length > 0) {
      style.steps.forEach(step => {
        const guideKey = getGuideKey(currentCategory, step.id, style.id);
        localStorage.removeItem(guideKey);
        // Firebaseì—ì„œë„ ì‚­ì œ
        db.collection('users').doc(USER_CODE).collection(PAGE_NAME).doc(guideKey).delete().catch(err => {
          console.warn('Firebase ì§€ì¹¨ ì‚­ì œ ì‹¤íŒ¨:', err);
        });
      });
    }

    settings.styles.splice(idx, 1);
    if (currentStyleId === style.id) {
      currentStyleId = '';
    }
    await saveConfig();
    renderStyles();
    renderStylesManageList();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
  };

  window.duplicateStyle = async function(idx) {
    const settings = config.categorySettings[currentCategory];
    if (!settings || !settings.styles) return;

    const originalStyle = settings.styles[idx];
    if (!originalStyle) return;

    // ë³µì œí•  ìŠ¤íƒ€ì¼ ì´ë¦„ ì…ë ¥ë°›ê¸°
    const newName = prompt('ë³µì œëœ ìŠ¤íƒ€ì¼ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', `${originalStyle.name} (ì‚¬ë³¸)`);
    if (newName === null) return;

    const trimmedName = newName.trim();
    if (!trimmedName) {
      alert('ìŠ¤íƒ€ì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    // ìƒˆë¡œìš´ ê³ ìœ  ID ìƒì„±
    const newId = koreanToId(trimmedName);

    // ìŠ¤íƒ€ì¼ ë³µì œ (ë‹¨ê³„ë“¤ë„ í•¨ê»˜ ë³µì œ)
    const duplicatedStyle = {
      id: newId,
      name: trimmedName,
      description: originalStyle.description || '',
      steps: originalStyle.steps ? JSON.parse(JSON.stringify(originalStyle.steps)) : []
    };

    // ìŠ¤íƒ€ì¼ ì¶”ê°€
    settings.styles.push(duplicatedStyle);

    // ì§€ì¹¨ ë³µì‚¬ (ê° ë‹¨ê³„ë³„ë¡œ)
    if (originalStyle.steps && originalStyle.steps.length > 0) {
      for (const step of originalStyle.steps) {
        const originalGuideKey = getGuideKey(currentCategory, step.id, originalStyle.id);
        const newGuideKey = getGuideKey(currentCategory, step.id, newId);

        // localStorageì—ì„œ ì§€ì¹¨ ë³µì‚¬
        const guideContent = localStorage.getItem(originalGuideKey);
        if (guideContent) {
          localStorage.setItem(newGuideKey, guideContent);

          // Firebaseì—ë„ ì €ì¥
          await saveToFirebase(newGuideKey, guideContent);
        }
      }
    }

    // ì„¤ì • ì €ì¥
    await saveConfig();

    // UI ì—…ë°ì´íŠ¸
    renderStyles();
    renderStylesManageList();

    showStatus(`âœ… "${trimmedName}" ìŠ¤íƒ€ì¼ì´ ë³µì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
    setTimeout(hideStatus, 2000);
  };

  window.editStyleSteps = function(styleId) {
    const settings = config.categorySettings[currentCategory];
    if (!settings || !settings.styles) return;

    const style = settings.styles.find(s => s.id === styleId);
    if (!style) return;

    currentStyleId = styleId;
    const modal = document.getElementById('modal-styles');
    if (modal) modal.classList.remove('show');

    const styleLabel = document.getElementById('modal-steps-style');
    if (styleLabel) styleLabel.textContent = style.name;

    renderStepsManageList(style);

    const stepsModal = document.getElementById('modal-steps');
    if (stepsModal) stepsModal.classList.add('show');
  };

  function renderStepsManageList(style) {
    const list = document.getElementById('steps-list');
    if (!list) return;

    if (!style.steps) style.steps = [];
    style.steps.sort((a, b) => a.order - b.order);

    if (style.steps.length === 0) {
      list.innerHTML = '<p style="color: #999; font-size: .8rem; text-align: center; padding: .5rem;">ë‹¨ê³„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>';
      return;
    }

    list.innerHTML = style.steps.map((step, idx) => {
      const stepType = step.stepType || 'step1';
      const stepBadgeColor = stepType === 'step1' ? '#ff6b6b' : '#4ecdc4';
      const stepBadgeText = stepType === 'step1' ? 'Step1' : 'Step2';
      return `
        <div class="storage-item">
          <div style="display: flex; align-items: center; gap: .5rem;">
            <span style="background: ${stepBadgeColor}; color: white; padding: .2rem .4rem; border-radius: 4px; font-size: .7rem; font-weight: 600;">${stepBadgeText}</span>
            <span>${step.order}. ${step.name}</span>
          </div>
          <div>
            ${idx > 0 ? `<button onclick="moveStep(${idx}, -1)" style="margin-right: .3rem;">â†‘</button>` : ''}
            ${idx < style.steps.length - 1 ? `<button onclick="moveStep(${idx}, 1)" style="margin-right: .3rem;">â†“</button>` : ''}
            <button onclick="renameStep(${idx})" style="margin-right: .3rem;">ì´ë¦„ ìˆ˜ì •</button>
            <button class="danger" onclick="deleteStep(${idx})">ì‚­ì œ</button>
          </div>
        </div>
      `;
    }).join('');
  }

  const btnCloseSteps = document.getElementById('btn-close-steps');
  if (btnCloseSteps) {
    btnCloseSteps.addEventListener('click', () => {
      const modal = document.getElementById('modal-steps');
      if (modal) modal.classList.remove('show');
    });
  }

  // Step1 ì¶”ê°€ ë²„íŠ¼
  const btnAddStep1 = document.getElementById('btn-add-step1');
  if (btnAddStep1) {
    btnAddStep1.addEventListener('click', async () => {
      const input = document.getElementById('new-step-name');
      if (!input) return;

      const name = input.value.trim();

      if (!name) {
        alert('ë‹¨ê³„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      const style = getCurrentStyle();
      if (!style) return;

      if (!style.steps) style.steps = [];

      const id = koreanToId(name);
      const maxOrder = style.steps.length > 0 ? Math.max(...style.steps.map(s => s.order)) : 0;

      style.steps.push({
        id: id,
        name: name,
        order: maxOrder + 1,
        stepType: 'step1'
      });

      await saveConfig();
      renderProcessingSteps();
      renderResultBoxes();
      renderGuideTabs();
      const updatedStyle = getCurrentStyle();
      if (updatedStyle) {
        renderStepsManageList(updatedStyle);
      }
      input.value = '';
    });
  }

  // Step2 ì¶”ê°€ ë²„íŠ¼
  const btnAddStep2 = document.getElementById('btn-add-step2');
  if (btnAddStep2) {
    btnAddStep2.addEventListener('click', async () => {
      const input = document.getElementById('new-step-name');
      if (!input) return;

      const name = input.value.trim();

      if (!name) {
        alert('ë‹¨ê³„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      const style = getCurrentStyle();
      if (!style) return;

      if (!style.steps) style.steps = [];

      const id = koreanToId(name);
      const maxOrder = style.steps.length > 0 ? Math.max(...style.steps.map(s => s.order)) : 0;

      style.steps.push({
        id: id,
        name: name,
        order: maxOrder + 1,
        stepType: 'step2'
      });

      await saveConfig();
      renderProcessingSteps();
      renderResultBoxes();
      renderGuideTabs();
      const updatedStyle = getCurrentStyle();
      if (updatedStyle) {
        renderStepsManageList(updatedStyle);
      }
      input.value = '';
    });
  }

  window.moveStep = async function(idx, direction) {
    const style = getCurrentStyle();
    if (!style || !style.steps) return;

    const steps = style.steps;
    const targetIdx = idx + direction;

    if (targetIdx < 0 || targetIdx >= steps.length) return;

    [steps[idx].order, steps[targetIdx].order] = [steps[targetIdx].order, steps[idx].order];

    await saveConfig();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
    const updatedStyle = getCurrentStyle();
    if (updatedStyle) {
      renderStepsManageList(updatedStyle);
    }
  };

  window.deleteStep = async function(idx) {
    const style = getCurrentStyle();
    if (!style || !style.steps) return;

    if (!confirm(`"${style.steps[idx].name}" ì‚­ì œ?`)) return;

    style.steps.splice(idx, 1);
    await saveConfig();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
    renderStepsManageList(style);
  };

  window.renameStep = async function(idx) {
    const style = getCurrentStyle();
    if (!style || !style.steps) return;

    const step = style.steps[idx];
    if (!step) return;

    const newName = prompt('ìƒˆ ë‹¨ê³„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', step.name);
    if (newName === null) return;

    const trimmed = newName.trim();
    if (!trimmed) {
      alert('ë‹¨ê³„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    step.name = trimmed;
    await saveConfig();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
    renderStepsManageList(style);
  };

  // ===== ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° =====
  const btnSave = document.getElementById('btn-save');
  if (btnSave) {
    btnSave.addEventListener('click', () => {
      const saved = JSON.parse(localStorage.getItem('sermon-saved') || '[]');
      const style = getCurrentStyle();

      saved.push({
        date: document.getElementById('sermon-date').value,
        category: currentCategory,
        styleId: currentStyleId,
        styleName: style ? style.name : '',
        seriesName: document.getElementById('series-name').value,
        ref: document.getElementById('sermon-ref').value,
        manualTitle: document.getElementById('manual-title').value,
        selectedTitle: selectedTitle,
        text: document.getElementById('sermon-text').value,
        results: stepResults,
        titleOptions: titleOptions,
        savedAt: new Date().toISOString()
      });

      localStorage.setItem('sermon-saved', JSON.stringify(saved));
      renderSavedList();
      alert('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    });
  }

  function renderSavedList() {
    const saved = JSON.parse(localStorage.getItem('sermon-saved') || '[]');
    const list = document.getElementById('saved-list');

    if (!list) return;

    if (saved.length === 0) {
      list.innerHTML = '<p style="color: #999; font-size: .8rem; text-align: center; padding: .5rem;">ì €ì¥ëœ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    list.innerHTML = saved.map((item, idx) => {
      const catLabel = getCategoryLabel(item.category);
      const display = item.seriesName
        ? `${item.date} - ${catLabel} - ${item.seriesName}`
        : `${item.date} - ${catLabel} - ${item.styleName}`;

      return `
        <div class="storage-item">
          <span style="font-size: .85rem;">${display}</span>
          <div>
            <button onclick="loadSaved(${idx})" style="margin-right: .3rem;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button onclick="deleteSaved(${idx})">ì‚­ì œ</button>
          </div>
        </div>
      `;
    }).join('');
  }

  window.loadSaved = function(idx) {
    const saved = JSON.parse(localStorage.getItem('sermon-saved') || '[]');
    const item = saved[idx];

    document.getElementById('sermon-date').value = item.date || '';
    document.getElementById('sermon-category').value = item.category || 'general';
    document.getElementById('sermon-ref').value = item.ref || '';
    document.getElementById('sermon-text').value = item.text || '';
    document.getElementById('series-name').value = item.seriesName || '';
    document.getElementById('manual-title').value = item.manualTitle || '';

    currentCategory = item.category || 'general';
    currentStyleId = item.styleId || '';
    stepResults = item.results || {};
    titleOptions = item.titleOptions || [];
    selectedTitle = item.selectedTitle || '';

    // ì œëª©ì´ ìˆìœ¼ë©´ í‘œì‹œ
    if (titleOptions.length >= 3) {
      displayTitleOptions(titleOptions);
      // ì €ì¥ëœ ì„ íƒ ë³µì›
      if (selectedTitle) {
        const idx = titleOptions.indexOf(selectedTitle);
        if (idx >= 0) {
          const radio = document.querySelector(`input[name="selectedTitle"][value="${idx}"]`);
          if (radio) radio.checked = true;
        }
      }
    }

    renderStyles();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();

    document.querySelectorAll('textarea').forEach(autoResize);
  };

  window.deleteSaved = function(idx) {
    if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const saved = JSON.parse(localStorage.getItem('sermon-saved') || '[]');
    saved.splice(idx, 1);
    localStorage.setItem('sermon-saved', JSON.stringify(saved));
    renderSavedList();
  };

  // ===== textarea ìë™ ë†’ì´ =====
  document.querySelectorAll('textarea.autosize').forEach(textarea => {
    textarea.addEventListener('input', () => autoResize(textarea));
  });

  // ===== Q&A ê¸°ëŠ¥ =====
  const QA_STORAGE_KEY = 'sermon-qa-history';

  function loadQAHistory() {
    try {
      const history = sessionStorage.getItem(QA_STORAGE_KEY);
      return history ? JSON.parse(history) : [];
    } catch (e) {
      console.error('Q&A íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', e);
      return [];
    }
  }

  function saveQAHistory(history) {
    try {
      sessionStorage.setItem(QA_STORAGE_KEY, JSON.stringify(history));
    } catch (e) {
      console.error('Q&A íˆìŠ¤í† ë¦¬ ì €ì¥ ì‹¤íŒ¨:', e);
    }
  }

  function renderQAHistory() {
    const qaHistory = document.getElementById('qa-history');
    if (!qaHistory) return;

    const history = loadQAHistory();

    if (history.length === 0) {
      qaHistory.innerHTML = '<div class="qa-empty-state">ì•„ì§ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²˜ë¦¬ ë‹¨ê³„ ê²°ê³¼ë‚˜ ë³¸ë¬¸ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”.</div>';
      return;
    }

    qaHistory.innerHTML = history.map(item => {
      const userMsg = `
        <div class="qa-message user">
          <div class="qa-message-label">ì§ˆë¬¸</div>
          <div class="qa-message-content">${escapeHtml(item.question)}</div>
        </div>
      `;
      const assistantMsg = `
        <div class="qa-message assistant">
          <div class="qa-message-label">ë‹µë³€</div>
          <div class="qa-message-content">${escapeHtml(item.answer)}</div>
        </div>
      `;
      return userMsg + assistantMsg;
    }).join('');

    // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
    qaHistory.scrollTop = qaHistory.scrollHeight;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  async function sendQAQuestion() {
    const input = document.getElementById('qa-input');
    const question = input.value.trim();

    if (!question) {
      alert('ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    const reference = document.getElementById('sermon-ref').value.trim();

    // í˜„ì¬ ì²˜ë¦¬ ë‹¨ê³„ ê²°ê³¼ë“¤ ìˆ˜ì§‘
    const contextStepResults = {};
    for (const [stepId, stepData] of Object.entries(stepResults)) {
      if (stepData && stepData.result) {
        contextStepResults[stepId] = {
          name: stepData.name || stepId,
          result: stepData.result
        };
      }
    }

    // UI ì—…ë°ì´íŠ¸: ì§ˆë¬¸ ì¶”ê°€
    const history = loadQAHistory();
    history.push({
      question: question,
      answer: 'ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...'
    });
    saveQAHistory(history);
    renderQAHistory();

    // ì…ë ¥ì°½ ë¹„ìš°ê¸°
    input.value = '';

    showGptLoading(); // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ

    try {
      showStatus('ğŸ¤” ë‹µë³€ ìƒì„± ì¤‘...');

      const response = await fetch('/api/sermon/qa', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          question: question,
          reference: reference,
          stepResults: contextStepResults
        })
      });

      const result = await response.json();
      hideGptLoading(); // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
      hideStatus();

      if (result.ok) {
        // ë§ˆì§€ë§‰ í•­ëª©ì˜ ë‹µë³€ ì—…ë°ì´íŠ¸
        history[history.length - 1].answer = result.answer;
        saveQAHistory(history);
        renderQAHistory();
      } else {
        alert('ë‹µë³€ ìƒì„± ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        // ì‹¤íŒ¨í•œ í•­ëª© ì œê±°
        history.pop();
        saveQAHistory(history);
        renderQAHistory();
      }
    } catch (err) {
      hideGptLoading(); // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
      hideStatus();
      console.error('Q&A ìš”ì²­ ì‹¤íŒ¨:', err);
      alert('ë‹µë³€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      // ì‹¤íŒ¨í•œ í•­ëª© ì œê±°
      history.pop();
      saveQAHistory(history);
      renderQAHistory();
    }
  }

  // ===== ì´ˆê¸°í™” =====
  document.addEventListener('DOMContentLoaded', async () => {
    const dateInput = document.getElementById('sermon-date');
    if (dateInput) {
      dateInput.value = new Date().toISOString().split('T')[0];
    }

    showStatus('â˜ï¸ í´ë¼ìš°ë“œ ë™ê¸°í™” ì¤‘...');
    await loadFromFirebase();
    hideStatus();

    renderCategories();
    loadMasterGuide(currentCategory);
    loadModelSettings(); // ëª¨ë¸ ì„¤ì • ë¡œë“œ
    renderStyles();
    renderProcessingSteps();

    // ëª¨ë¸ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const step1Select = document.getElementById('model-step1');
    const step2Select = document.getElementById('model-step2');
    const gptProSelect = document.getElementById('model-gpt-pro');

    if (step1Select) {
      step1Select.addEventListener('change', async () => {
        await saveModelSettings();
        showStatus('âœ… ëª¨ë¸ ì„¤ì • ì €ì¥ë¨');
        setTimeout(hideStatus, 1500);
      });
    }
    if (step2Select) {
      step2Select.addEventListener('change', async () => {
        await saveModelSettings();
        showStatus('âœ… ëª¨ë¸ ì„¤ì • ì €ì¥ë¨');
        setTimeout(hideStatus, 1500);
      });
    }
    if (gptProSelect) {
      gptProSelect.addEventListener('change', async () => {
        await saveModelSettings();
        showStatus('âœ… ëª¨ë¸ ì„¤ì • ì €ì¥ë¨');
        setTimeout(hideStatus, 1500);
      });
    }

    // Step3 í† í° ì„¤ì • ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const step3MaxTokensInput = document.getElementById('step3-max-tokens');
    if (step3MaxTokensInput) {
      step3MaxTokensInput.addEventListener('change', async () => {
        await saveModelSettings();
        showStatus('âœ… í† í° ì„¤ì • ì €ì¥ë¨');
        setTimeout(hideStatus, 1500);
      });
    }

    // Step3 ì§€ì¹¨ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const btnSaveStep3Prompt = document.getElementById('btn-save-step3-prompt');
    if (btnSaveStep3Prompt) {
      btnSaveStep3Prompt.addEventListener('click', saveStep3Prompt);
    }

    const btnResetStep3Prompt = document.getElementById('btn-reset-step3-prompt');
    if (btnResetStep3Prompt) {
      btnResetStep3Prompt.addEventListener('click', () => {
        resetStep3Prompt();
        showStatus('âœ… ê¸°ë³¸ê°’ ë³µì›ë¨ (ì €ì¥í•˜ë ¤ë©´ ì €ì¥ ë²„íŠ¼ í´ë¦­)');
        setTimeout(hideStatus, 2000);
      });
    }

    // ìë™ ì €ì¥ ë°ì´í„° ë³µì› - ìƒˆë¡œê³ ì¹¨ ì‹œ ì´ˆê¸°í™”í•˜ê¸° ìœ„í•´ ì œê±°
    // loadAutoSave();

    // ìƒˆë¡œê³ ì¹¨ ì‹œ stepResults ì´ˆê¸°í™”
    stepResults = {};
    titleOptions = [];
    selectedTitle = '';

    // ìƒˆë¡œê³ ì¹¨ ì‹œ AUTO_SAVE_KEY ë°ì´í„° ì‚­ì œ ë° íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ë¯¸ë˜ ê°’ìœ¼ë¡œ ì„¤ì • (ì‹¤ì‹œê°„ ë™ê¸°í™” ë°©ì§€)
    localStorage.removeItem(AUTO_SAVE_KEY);
    // íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ í˜„ì¬ + 1ë…„ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™”ê°€ ë³µì›í•˜ì§€ ì•Šë„ë¡ í•¨
    const futureTimestamp = (Date.now() + 365 * 24 * 60 * 60 * 1000).toString();
    localStorage.setItem(`${AUTO_SAVE_KEY}_timestamp`, futureTimestamp);

    // ìƒˆë¡œê³ ì¹¨ ì‹œ Q&A íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
    sessionStorage.removeItem(QA_STORAGE_KEY);

    // ìƒˆë¡œê³ ì¹¨ ì‹œ GPT PRO ê²°ê³¼ ì´ˆê¸°í™”
    const gptProContainer = document.getElementById('gpt-pro-result-container');
    if (gptProContainer) gptProContainer.style.display = 'none';
    const gptProResult = document.getElementById('gpt-pro-result');
    if (gptProResult) gptProResult.value = '';

    // ì œëª© ì„ íƒ ë°•ìŠ¤ ìˆ¨ê¸°ê¸°
    const titleBox = document.getElementById('title-selection-box');
    if (titleBox) titleBox.style.display = 'none';

    renderResultBoxes();
    renderGuideTabs();
    renderSavedList();

    // ì²« ë°©ë¬¸ì ê°€ì´ë“œ í‘œì‹œ
    const guideHideUntil = localStorage.getItem('sermon-guide-hide-until');
    const now = Date.now();
    if (!guideHideUntil || now > parseInt(guideHideUntil)) {
      const modal = document.getElementById('modal-guide');
      if (modal) {
        modal.classList.add('show');
      }
    }

    // ì‹¤ì‹œê°„ ë™ê¸°í™” ì‹œì‘
    console.log('ğŸ”„ ì‹¤ì‹œê°„ ë™ê¸°í™” í™œì„±í™”');
    setupRealtimeSync();

    // Q&A ì´ˆê¸°í™”
    renderQAHistory();

    // Q&A ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const btnSendQA = document.getElementById('btn-send-qa');
    if (btnSendQA) {
      btnSendQA.addEventListener('click', sendQAQuestion);
    }

    const qaInput = document.getElementById('qa-input');
    if (qaInput) {
      // Enter í‚¤ë¡œ ì „ì†¡ (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
      qaInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendQAQuestion();
        }
      });
    }

    document.querySelectorAll('textarea').forEach(autoResize);
  });
  </script>
</body>
</html>
