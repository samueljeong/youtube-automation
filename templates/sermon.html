<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>BIBLE LAB</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/sermon.css') }}">
</head>
<body>
  <!-- Auth Header -->
  <div class="auth-header">
    <h1>BIBLE LAB</h1>
    <div class="auth-links">
      <a href="/" class="btn-home">홈</a>
      {% if session.user_id %}
        <span class="user-info">{{ session.user_name }}님</span>
        <a href="/logout" class="btn-logout">로그아웃</a>
      {% else %}
        <a href="/login" class="btn-login">로그인</a>
        <a href="/signup" class="btn-signup">회원가입</a>
      {% endif %}
    </div>
  </div>

  <div class="page-wrap">
    <!-- 숨겨진 요소 (기존 코드 호환용) -->
    <input type="date" id="sermon-date" style="display: none;">
    <textarea id="sermon-text" style="display: none;"></textarea>

    <!-- 왼쪽 -->
    <div class="left-col">
      <div class="box">
        <div class="label-row" style="align-items: flex-start;">
          <div>
            <div class="label">카테고리</div>
            <div style="font-size: .8rem; color: #777;">클릭하여 선택</div>
          </div>
          <button id="btn-manage-categories" style="font-size: .75rem; padding: .2rem .5rem;">관리</button>
        </div>
        <div id="category-buttons" class="category-buttons"></div>
        <select id="sermon-category" style="display: none;"></select>
      </div>

      <div class="box" id="series-box" style="display: none;">
        <label class="label">시리즈명</label>
        <input type="text" id="series-name" placeholder="예: 요한복음 시리즈">
      </div>

      <div class="box">
        <div class="label-row">
          <div class="label">저장된 설교 리스트</div>
          <span style="font-size: .8rem; color: #777;">필요할 때 바로 불러오기</span>
        </div>
        <button id="btn-save" style="width: 100%; margin-bottom: .5rem;">현재 내용 저장</button>
        <div id="saved-list"></div>
      </div>

      <div class="box" style="background: linear-gradient(135deg, #FEE500 0%, #FFEB3B 100%); border: none; text-align: center; padding: 1rem;">
        <div style="font-size: .9rem; font-weight: 600; color: #3C1E1E; margin-bottom: .75rem;">
          💬 문의 및 궁금사항
        </div>
        <a href="https://open.kakao.com/o/sfFpe12h" target="_blank" rel="noopener noreferrer"
           style="display: inline-block; background: #3C1E1E; color: #FEE500; padding: .65rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: .9rem; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"
           onmouseover="this.style.background='#2C1414'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.25)';"
           onmouseout="this.style.background='#3C1E1E'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)';">
          💬 카카오톡 문의하기
        </a>
        <div style="font-size: .7rem; color: #6D4C41; margin-top: .75rem; opacity: 0.9;">
          📱 BIBLE LAB 오픈채팅방
        </div>
      </div>

      <div class="box" id="guide-box">
        <div class="label-row">
          <div class="label">관리자 공간 🔒</div>
          <a href="/sermon_admin" target="_blank" style="font-size: .85rem; color: #4a90e2; text-decoration: none; font-weight: 700;">새 창 열기</a>
        </div>
        <button id="toggle-guides" class="primary" style="width: 100%;">관리자 공간 열기</button>
      </div>
    </div>

    <!-- 가운데 -->
    <div class="middle-col">
      <div class="top-section" style="border-bottom: none; padding-bottom: 0;">
        <div id="status-bar" class="status-bar">작업 중...</div>
      </div>

      <div class="content-section">
        <!-- 설교 콘텐츠 -->
        <div id="sermon-content">
        <!-- 본문 선정 + 성경본문 (한 줄) -->
        <div class="input-grid" style="grid-template-columns: 1fr 1fr; gap: .5rem;">
          <!-- 본문 선정 (추천 기능) -->
          <div class="box" style="padding: .6rem;">
            <label class="label" style="font-size: .8rem;">📖 본문 선정 <span style="font-weight: 400; color: #777;">(상황을 입력하면 적합한 본문을 추천해드립니다)</span><span class="label-hint">선택</span></label>
            <div style="display: flex; gap: .5rem;">
              <input type="text" id="scripture-search" placeholder="예) 이사심방, 구국기도회, 송년예배" style="flex: 1; font-size: .85rem;">
              <button id="btn-search-scripture" class="primary" style="white-space: nowrap; font-size: .85rem;">검색</button>
            </div>
          </div>
          <!-- 성경본문 (필수) - 강조 스타일 -->
          <div class="box" style="padding: .6rem; background: linear-gradient(135deg, #f8f9ff 0%, #e8f4fd 100%); border: 2px solid #667eea;">
            <label class="label" style="font-size: .8rem;">📖 성경본문<span class="label-hint" style="background: #667eea; color: white;">필수</span></label>
            <input type="text" id="sermon-ref" placeholder="예) 시 78:1-8" style="border: 1px solid #667eea; background: white; font-size: .85rem;">
          </div>
        </div>
        <!-- 본문 추천 결과 (검색 결과가 여기에 표시됨) -->
        <div id="scripture-recommendations" style="display: none; margin-bottom: .5rem;">
          <div class="box" style="padding: .6rem; background: #f8f9ff;">
            <div style="font-size: .85rem; color: #667eea; margin-bottom: .5rem; font-weight: 600;">✨ 추천 본문 (클릭하여 선택)</div>
            <div id="scripture-list" style="display: flex; flex-direction: column; gap: .4rem;"></div>
          </div>
        </div>

        <!-- 제목, 예배·집회 유형, 분량, 대상 (한 줄 - 4열) -->
        <div class="input-grid" style="grid-template-columns: repeat(4, 1fr); gap: .5rem;">
          <div class="box" style="padding: .6rem;">
            <label class="label" style="font-size: .8rem;">제목<span class="label-hint">선택</span></label>
            <input type="text" id="manual-title" placeholder="직접 입력" style="font-size: .85rem;">
            <div id="title-selection-box" style="display: none; margin-top: .5rem;">
              <div style="font-size: .75rem; color: #667eea; margin-bottom: .3rem;">✨ 추천 제목</div>
              <div id="title-options"></div>
            </div>
          </div>
          <div class="box" style="padding: .6rem;">
            <label class="label" style="font-size: .8rem;">예배·집회 유형<span class="label-hint">선택</span></label>
            <input type="text" id="sermon-worship-type" placeholder="예) 새벽, 주일" style="font-size: .85rem;">
          </div>
          <div class="box" style="padding: .6rem;">
            <label class="label" style="font-size: .8rem;">분량<span class="label-hint">선택</span></label>
            <input type="text" id="sermon-duration" placeholder="기본 20분" value="" style="font-size: .85rem;">
          </div>
          <div class="box" style="padding: .6rem;">
            <label class="label" style="font-size: .8rem;">대상<span class="label-hint">선택</span></label>
            <input type="text" id="sermon-target" placeholder="예) 장년, 청년" style="font-size: .85rem;">
          </div>
        </div>

        <!-- 숨겨진 주제 입력 (기존 코드 호환용) -->
        <input type="hidden" id="sermon-topic">

        <!-- 특별 참고 사항 -->
        <div class="box" style="padding: .6rem; margin-bottom: .5rem;">
          <label class="label" style="font-size: .8rem;">특별 참고 사항<span class="label-hint">선택</span></label>
          <textarea id="special-notes" placeholder="설교 작성 시 고려해야 할 특별한 상황, 요청, 주의점을 자유롭게 기입하세요.&#10;예) 현장 상황, 성도 사정, 교회 일정, 설교자의 의도 등" style="font-size: .85rem; min-height: 60px; resize: vertical; width: 100%; padding: .5rem; border: 1px solid #e0e0e0; border-radius: 6px; line-height: 1.4;"></textarea>
        </div>

        <div class="dual-row">
          <div class="box" style="padding: .6rem;">
            <div class="label-row" style="margin-bottom: .4rem;">
              <label class="label" style="margin: 0;">설교 스타일<span class="label-hint">클릭하여 선택</span></label>
              <button id="btn-manage-styles" style="font-size: .75rem; padding: .2rem .5rem;">관리</button>
            </div>
            <div id="styles-list"></div>
            <!-- 설교 준비 시작 안내문구 (버튼 비활성화시 표시) -->
            <div id="start-analysis-guide" style="width: 100%; margin-top: .5rem; padding: .5rem; text-align: center; background: #f8f9ff; border-radius: 8px; border: 2px dashed #667eea;">
              <span style="font-size: .9rem; font-weight: 700; color: #667eea;">📖 성경본문을 입력해주세요</span>
            </div>
            <!-- 설교 준비 시작 버튼 -->
            <button id="btn-start-analysis" style="display: none; width: 100%; margin-top: .5rem; padding: .6rem; font-size: .9rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 700; border: none; border-radius: 8px; cursor: pointer;">
              ✨ 설교 준비 시작
            </button>
            <!-- 숨겨진 진행 상태 (내부 기능 유지) -->
            <div id="analysis-status" style="display: none;"></div>
            <div id="processing-steps" style="display: none;"></div>
          </div>
          <!-- 보라색/분홍색 박스 (가로 배치, 높이 자동 맞춤) -->
          <div style="display: flex; flex-direction: row; gap: .5rem; align-items: stretch;">
            <div class="box copy-all-box" id="step4-box" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: .6rem; opacity: 0.5; pointer-events: none; text-align: center; display: flex; flex-direction: column; justify-content: center;">
              <div class="box-title" style="font-size: .85rem; margin-bottom: .25rem; color: white; font-weight: 700;">🟣 내 GPT에 붙여넣기</div>
              <div class="box-desc" style="font-size: .7rem; margin-bottom: .4rem; color: rgba(255,255,255,0.95);">분석 내용을 복사해서 개인 ChatGPT에 사용하세요.</div>
              <button id="btn-copy-all" style="width: 100%; padding: .45rem; font-size: .8rem; background: white; color: #667eea; font-weight: 700; border: none; border-radius: 6px; cursor: pointer;">전체 복사</button>
            </div>
            <div class="box gpt-pro-box" id="step3-box" style="flex: 1; background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); border: none; padding: .6rem; opacity: 0.5; pointer-events: none; text-align: center; display: flex; flex-direction: column; justify-content: center;">
              <div class="box-title" style="font-size: .85rem; margin-bottom: .25rem; color: white; font-weight: 700;">🔴 설교문 완성</div>
              <div class="box-desc" style="font-size: .7rem; margin-bottom: .4rem; color: rgba(255,255,255,0.95);">프리미엄 · BIBLE LAB이 설교문을 작성합니다 (크레딧 1회 차감)</div>
              <button id="btn-gpt-pro" style="width: 100%; padding: .45rem; font-size: .8rem; background: white; color: #f5576c; font-weight: 700; border: none; border-radius: 6px; cursor: pointer;">설교문 작성</button>
            </div>
          </div>
        </div>

          <div class="box" id="result-section-box" style="display: flex; flex-direction: column; gap: .75rem;">
            <!-- Step1/2 결과 영역 -->
            <div id="step12-result-area">
              <div class="label-row">
                <div class="label">처리 단계 결과</div>
                <span style="font-size: .8rem; color: #777;">선택한 단계의 결과가 여기에 순서대로 표시됩니다.</span>
              </div>
              <div id="result-boxes"></div>
            </div>

            <!-- Step3 결과 영역 (같은 자리에 표시) -->
            <div id="gpt-pro-result-container" style="display: none;">
              <div class="gpt-pro-result-box">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                  <div class="label" style="margin: 0;">🎯 Step3. 설교문 완성</div>
                  <span id="usage-step3" style="font-size: .75rem; color: rgba(255,255,255,0.9);"></span>
                </div>
                <button id="btn-copy-gpt-pro" style="margin: .25rem 0 .75rem 0; width: 100%; background: white; color: #f5576c; font-weight: 600;">📋 설교문 전체 복사</button>
                <textarea id="gpt-pro-result" class="autosize" readonly placeholder="Step3 처리 결과가 여기에 표시됩니다."></textarea>
              </div>
            </div>
          </div>
        </div>
        <!-- // 설교 콘텐츠 끝 -->

        <!-- 묵상메시지 콘텐츠 -->
        <div id="meditation-content" style="display: none;">
          <div class="box" style="background: linear-gradient(135deg, #f8f9ff 0%, #e8f4fd 100%); border: 2px solid #667eea;">
            <div class="label" style="margin-bottom: 1rem;">🙏 묵상메시지 작성</div>

            <!-- 첫 번째 줄: 날짜(요일 포함), 성경구절, 보내는 사람 -->
            <div style="display: flex; gap: .75rem; align-items: flex-end; flex-wrap: wrap; margin-bottom: .75rem;">
              <div>
                <label style="font-size: .8rem; color: #666; display: block; margin-bottom: .3rem;">날짜</label>
                <div style="display: flex; align-items: center; gap: .2rem;">
                  <input type="number" id="meditation-month" min="1" max="12" style="width: 55px; text-align: center; padding: .4rem .2rem;">
                  <span style="font-size: .9rem; color: #666;">월</span>
                  <input type="number" id="meditation-day-num" min="1" max="31" style="width: 55px; text-align: center; padding: .4rem .2rem;">
                  <span style="font-size: .9rem; color: #666;">일</span>
                  <span id="meditation-day" style="font-size: .9rem; color: #667eea; font-weight: 600; margin-left: .3rem;">(수)</span>
                </div>
              </div>
              <div style="flex: 1; min-width: 120px;">
                <label style="font-size: .8rem; color: #666; display: block; margin-bottom: .3rem;">성경구절</label>
                <input type="text" id="meditation-ref" placeholder="예) 레위기 1:3" style="width: 100%;">
              </div>
              <div style="flex: 1; min-width: 150px;">
                <label style="font-size: .8rem; color: #666; display: block; margin-bottom: .3rem;">보내는 사람 <span style="color: #999;">(선택)</span></label>
                <input type="text" id="meditation-sender" placeholder="예) 초대교회, 홍길동 목사" style="width: 100%;">
              </div>
            </div>

            <!-- 두 번째 줄: 본문말씀 + 버튼 -->
            <div style="display: flex; gap: .5rem; align-items: flex-end;">
              <div style="flex: 1;">
                <label style="font-size: .8rem; color: #666; display: block; margin-bottom: .3rem;">본문말씀</label>
                <textarea id="meditation-verse" placeholder="예) 그 예물이 소의 번제이면 흠 없는 수컷으로 회막 문에서 여호와 앞에 기쁘게 받으시도록 드릴지니라" style="width: 100%; min-height: 70px; resize: vertical;"></textarea>
              </div>
              <button id="btn-create-meditation" class="primary" style="white-space: nowrap; padding: .6rem 1.2rem; height: fit-content;">메시지 제작</button>
            </div>
          </div>

          <!-- 샘플 템플릿 + 결과 영역 -->
          <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
            <!-- 왼쪽: 샘플 템플릿 -->
            <div style="flex: 1; min-width: 280px;">
              <div class="box" style="background: #fff; border: 1px solid #ddd; height: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                  <div class="label" style="margin: 0; font-size: .9rem;">📝 샘플 템플릿 <span style="font-weight: normal; color: #999; font-size: .75rem;">(선택)</span></div>
                  <button id="btn-reset-template" style="font-size: .7rem; padding: .2rem .5rem; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">초기화</button>
                </div>
                <div style="font-size: .75rem; color: #888; margin-bottom: .5rem;">템플릿을 입력하면 해당 양식으로 메시지가 생성됩니다. 비워두면 기본 양식이 적용됩니다.</div>
                <textarea id="meditation-template" placeholder="샘플 메시지를 붙여넣으세요. 비워두면 기본 양식으로 생성됩니다." style="width: 100%; min-height: 250px; resize: vertical; font-size: .85rem; line-height: 1.5;"></textarea>
              </div>
            </div>

            <!-- 오른쪽: 생성된 메시지 -->
            <div style="flex: 1; min-width: 280px;">
              <div id="meditation-result-container" class="box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; height: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                  <div class="label" style="margin: 0; color: white; font-size: .9rem;">📱 묵상메시지</div>
                  <button id="btn-copy-meditation" style="background: white; color: #667eea; border: none; padding: .3rem .6rem; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: .8rem;">📋 복사</button>
                </div>
                <textarea id="meditation-result" readonly placeholder="메시지 제작 버튼을 클릭하면 여기에 결과가 표시됩니다." style="width: 100%; min-height: 250px; padding: .75rem; border-radius: 6px; border: none; font-size: .85rem; line-height: 1.6; resize: vertical;"></textarea>
              </div>
            </div>
          </div>
        </div>
        <!-- // 묵상메시지 콘텐츠 끝 -->

        <!-- 성경 배경지식 콘텐츠 -->
        <div id="bible-knowledge-content" style="display: none;">
          <div class="box" style="text-align: center; padding: 3rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">📚</div>
            <div style="font-size: 1.1rem; color: #666;">성경 배경지식 기능 준비 중입니다.</div>
            <div style="font-size: .85rem; color: #999; margin-top: .5rem;">곧 업데이트될 예정입니다.</div>
          </div>
        </div>
        <!-- // 성경 배경지식 콘텐츠 끝 -->

        <!-- 빈 페이지 콘텐츠 (새 카테고리용) -->
        <div id="empty-content" style="display: none;">
          <div class="box" style="text-align: center; padding: 3rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">📝</div>
            <div style="font-size: 1.1rem; color: #666;">새 카테고리입니다.</div>
            <div style="font-size: .85rem; color: #999; margin-top: .5rem;">곧 콘텐츠가 추가될 예정입니다.</div>
          </div>
        </div>
        <!-- // 빈 페이지 콘텐츠 끝 -->

        <!-- 디자인 도우미 콘텐츠 -->
        <div id="design-helper-content" style="display: none;">
          <!-- 안내 박스 -->
          <div class="box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; margin-bottom: 1rem;">
            <div style="color: white; font-size: 1.1rem; font-weight: 700; margin-bottom: .5rem;">🎨 현수막/배너 AI 생성기</div>
            <div style="color: rgba(255,255,255,0.9); font-size: .85rem; line-height: 1.5;">
              행사 정보를 입력하면 AI가 교회 현수막/배너용 배경 이미지를 자동으로 생성합니다.<br>
              생성된 이미지에 텍스트를 추가하여 완성된 현수막을 만드세요.
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <!-- 왼쪽: 입력 폼 -->
            <div>
              <!-- AI 모델 선택 -->
              <div class="box" style="margin-bottom: 1rem;">
                <div class="label" style="margin-bottom: .5rem;">🤖 AI 모델 선택</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: .5rem;">
                  <label style="display: flex; align-items: center; padding: .75rem; background: #f8f9fa; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" id="model-dalle3-label">
                    <input type="radio" name="banner-model" value="dalle3" checked style="margin-right: .5rem;">
                    <div>
                      <div style="font-weight: 600; font-size: .9rem;">DALL-E 3</div>
                      <div style="font-size: .75rem; color: #888;">텍스트 렌더링 우수</div>
                    </div>
                  </label>
                  <label style="display: flex; align-items: center; padding: .75rem; background: #f8f9fa; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" id="model-flux-label">
                    <input type="radio" name="banner-model" value="flux_pro" style="margin-right: .5rem;">
                    <div>
                      <div style="font-weight: 600; font-size: .9rem;">Flux Pro</div>
                      <div style="font-size: .75rem; color: #888;">포토리얼리즘</div>
                    </div>
                  </label>
                </div>
              </div>

              <!-- 템플릿 선택 -->
              <div class="box" style="margin-bottom: 1rem;">
                <div class="label" style="margin-bottom: .5rem;">📋 행사 유형 선택</div>
                <select id="banner-template" style="width: 100%; padding: .5rem; border-radius: 6px; border: 1px solid #ddd;">
                  <option value="general">일반</option>
                  <option value="revival">부흥회</option>
                  <option value="christmas">성탄절</option>
                  <option value="easter">부활절</option>
                  <option value="thanksgiving">추수감사절</option>
                  <option value="new_year">신년/송년</option>
                  <option value="special_service">특별집회</option>
                  <option value="bible_school">성경학교/여름캠프</option>
                  <option value="baptism">세례/침례</option>
                  <option value="ordination">임직/취임</option>
                  <option value="mission">선교/전도</option>
                </select>
              </div>

              <!-- 크기 설정 -->
              <div class="box" style="margin-bottom: 1rem;">
                <div class="label" style="margin-bottom: .5rem;">📐 크기 설정 (cm)</div>
                <div style="display: flex; flex-direction: column; gap: .75rem;">
                  <!-- 프리셋 선택 -->
                  <div style="display: flex; flex-wrap: wrap; gap: .4rem;">
                    <button type="button" class="size-preset active" data-width="500" data-height="90" style="padding: .4rem .8rem; border: 1px solid #667eea; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-size: .8rem;">현수막 (500x90)</button>
                    <button type="button" class="size-preset" data-width="300" data-height="90" style="padding: .4rem .8rem; border: 1px solid #ddd; background: #f8f9fa; border-radius: 6px; cursor: pointer; font-size: .8rem;">현수막 (300x90)</button>
                    <button type="button" class="size-preset" data-width="60" data-height="180" style="padding: .4rem .8rem; border: 1px solid #ddd; background: #f8f9fa; border-radius: 6px; cursor: pointer; font-size: .8rem;">X배너 (60x180)</button>
                    <button type="button" class="size-preset" data-width="80" data-height="200" style="padding: .4rem .8rem; border: 1px solid #ddd; background: #f8f9fa; border-radius: 6px; cursor: pointer; font-size: .8rem;">롤배너 (80x200)</button>
                    <button type="button" class="size-preset" data-width="100" data-height="100" style="padding: .4rem .8rem; border: 1px solid #ddd; background: #f8f9fa; border-radius: 6px; cursor: pointer; font-size: .8rem;">정사각형 (100x100)</button>
                  </div>
                  <!-- 직접 입력 -->
                  <div style="display: flex; align-items: center; gap: .5rem;">
                    <input type="number" id="banner-width" value="500" min="10" max="1000" style="width: 80px; padding: .4rem; border-radius: 6px; border: 1px solid #ddd; text-align: center;">
                    <span style="color: #666;">x</span>
                    <input type="number" id="banner-height" value="90" min="10" max="1000" style="width: 80px; padding: .4rem; border-radius: 6px; border: 1px solid #ddd; text-align: center;">
                    <span style="color: #666; font-size: .85rem;">cm</span>
                    <div id="banner-size-preview" style="flex: 1; text-align: right; font-size: .8rem; color: #888;">비율: 5.56:1 (가로형)</div>
                  </div>
                </div>
              </div>

              <!-- 행사 정보 입력 -->
              <div class="box" style="margin-bottom: 1rem;">
                <div class="label" style="margin-bottom: .5rem;">✏️ 행사 정보 (선택)</div>
                <div style="display: flex; flex-direction: column; gap: .5rem;">
                  <input type="text" id="banner-event-name" placeholder="행사명 (예: 2024 가을 부흥회)" style="padding: .5rem; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="text" id="banner-church-name" placeholder="교회명 (예: 소망교회)" style="padding: .5rem; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="text" id="banner-schedule" placeholder="일정 (예: 11/25~27 저녁 7시)" style="padding: .5rem; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="text" id="banner-speaker" placeholder="강사 (예: 홍길동 목사)" style="padding: .5rem; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="text" id="banner-theme" placeholder="주제/말씀 (예: 새 힘을 얻으리니 사40:31)" style="padding: .5rem; border-radius: 6px; border: 1px solid #ddd;">
                </div>
              </div>

              <!-- 텍스트 오버레이 옵션 -->
              <div class="box" style="margin-bottom: 1rem; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #22c55e;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                  <div class="label" style="margin: 0; color: #15803d;">✨ 한글 텍스트 자동 삽입</div>
                  <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="banner-add-text" checked style="width: 18px; height: 18px; margin-right: .5rem;">
                    <span style="font-size: .85rem; color: #166534; font-weight: 600;">활성화</span>
                  </label>
                </div>
                <div id="text-overlay-options">
                  <div style="font-size: .8rem; color: #166534; margin-bottom: .5rem;">위에 입력한 행사 정보가 이미지에 자동으로 추가됩니다.</div>
                  <div style="display: flex; gap: .5rem; align-items: center;">
                    <label style="font-size: .85rem; color: #15803d; font-weight: 500;">폰트:</label>
                    <select id="banner-font" style="flex: 1; padding: .4rem; border-radius: 6px; border: 1px solid #86efac; background: white;">
                      <option value="nanum_gothic">나눔고딕</option>
                      <option value="nanum_barun">나눔바른고딕</option>
                      <option value="nanum_myeongjo">나눔명조</option>
                      <option value="nanum_square">나눔스퀘어</option>
                      <option value="nanum_square_round">나눔스퀘어라운드</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- 고급 옵션 -->
              <div class="box" style="margin-bottom: 1rem;">
                <div class="toggle-header" style="cursor: pointer;" onclick="toggleAdvancedOptions()">
                  <div class="label" style="margin: 0;">⚙️ 고급 옵션</div>
                  <span id="advanced-options-arrow" style="transition: transform 0.2s;">▼</span>
                </div>
                <div id="advanced-options" style="display: none; margin-top: .75rem;">
                  <div style="font-size: .8rem; color: #666; margin-bottom: .5rem;">직접 프롬프트를 입력하거나 AI가 생성한 프롬프트를 수정할 수 있습니다.</div>
                  <textarea id="banner-custom-prompt" placeholder="AI 이미지 생성 프롬프트를 직접 입력하세요 (영어 권장)" style="width: 100%; min-height: 100px; padding: .5rem; border-radius: 6px; border: 1px solid #ddd; font-size: .85rem; resize: vertical;"></textarea>
                  <button onclick="generateBannerPrompt()" style="margin-top: .5rem; width: 100%; padding: .5rem; background: #f0f0f0; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">🤖 AI로 프롬프트 생성</button>
                </div>
              </div>

              <!-- 생성 버튼 -->
              <button id="btn-generate-banner" onclick="generateBanner()" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s;">
                🎨 배경 이미지 생성
              </button>
              <div id="banner-loading" style="display: none; text-align: center; margin-top: 1rem; color: #666;">
                <div style="font-size: 2rem; margin-bottom: .5rem;">⏳</div>
                <div>이미지를 생성하고 있습니다...</div>
                <div style="font-size: .85rem; color: #888;">30초~1분 정도 소요될 수 있습니다.</div>
              </div>
            </div>

            <!-- 오른쪽: 결과 표시 -->
            <div>
              <div class="box" style="height: 100%; min-height: 500px; display: flex; flex-direction: column;">
                <div class="label" style="margin-bottom: .5rem;">🖼️ 생성된 이미지</div>
                <div id="banner-result-container" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px; padding: 1rem;">
                  <div id="banner-placeholder" style="text-align: center; color: #888;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">🖼️</div>
                    <div>왼쪽에서 설정을 선택하고<br>"배경 이미지 생성" 버튼을 클릭하세요.</div>
                  </div>
                  <div id="banner-result" style="display: none; width: 100%;">
                    <img id="banner-image" src="" alt="생성된 배너 이미지" style="width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <div style="margin-top: 1rem; display: flex; gap: .5rem;">
                      <a id="banner-download-link" href="" download="banner.png" style="flex: 1; padding: .75rem; background: #667eea; color: white; text-align: center; border-radius: 6px; text-decoration: none; font-weight: 600;">📥 다운로드</a>
                      <button onclick="regenerateBanner()" style="flex: 1; padding: .75rem; background: #f0f0f0; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-weight: 600;">🔄 다시 생성</button>
                    </div>
                    <div id="banner-info" style="margin-top: 1rem; padding: .75rem; background: #e8f4fd; border-radius: 6px; font-size: .8rem;">
                      <div><strong>모델:</strong> <span id="banner-info-model">-</span></div>
                      <div><strong>템플릿:</strong> <span id="banner-info-template">-</span></div>
                      <div><strong>크기:</strong> <span id="banner-info-layout">-</span></div>
                      <div><strong>텍스트:</strong> <span id="banner-info-text">-</span></div>
                      <div><strong>폰트:</strong> <span id="banner-info-font">-</span></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 사용 팁 -->
          <div class="box" style="margin-top: 1rem; background: #fffbeb; border: 1px solid #f59e0b;">
            <div style="font-weight: 600; color: #b45309; margin-bottom: .5rem;">💡 사용 팁</div>
            <ul style="margin: 0; padding-left: 1.2rem; font-size: .85rem; color: #78350f; line-height: 1.6;">
              <li><strong>한글 텍스트 자동 삽입</strong>을 활성화하면 행사 정보가 이미지에 자동으로 추가됩니다.</li>
              <li><strong>DALL-E 3</strong>은 $0.04~0.08/장, <strong>Flux Pro</strong>는 $0.025/megapixel (fal.ai)입니다.</li>
              <li>원하는 결과가 나오지 않으면 "다시 생성"을 눌러 새로운 이미지를 받아보세요.</li>
              <li>Flux Pro 사용 시 <strong>FAL_KEY</strong> 환경변수 설정이 필요합니다. (<a href="https://fal.ai" target="_blank" style="color: #b45309;">fal.ai</a>에서 발급)</li>
            </ul>
          </div>

          <!-- 참조 이미지 학습 -->
          <div class="box" style="margin-top: 1rem; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0ea5e9;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .75rem;">
              <div style="font-weight: 700; color: #0369a1; font-size: 1rem;">📚 참조 이미지 학습</div>
              <span id="ref-count-badge" style="background: #0ea5e9; color: white; padding: .2rem .6rem; border-radius: 12px; font-size: .75rem;">0개</span>
            </div>
            <div style="font-size: .85rem; color: #0c4a6e; margin-bottom: 1rem; line-height: 1.5;">
              좋은 현수막 이미지 URL을 등록하면 AI가 스타일을 학습하여 더 나은 결과물을 생성합니다.<br>
              데이터가 쌓일수록 품질이 향상됩니다.
            </div>

            <!-- 참조 이미지 추가 폼 -->
            <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
              <div style="font-weight: 600; color: #0369a1; margin-bottom: .75rem; font-size: .9rem;">➕ 참조 이미지 추가</div>
              <div style="display: flex; flex-direction: column; gap: .5rem;">
                <input type="text" id="ref-image-url" placeholder="이미지 URL (https://...)" style="padding: .5rem; border-radius: 6px; border: 1px solid #7dd3fc;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: .5rem;">
                  <select id="ref-template-type" style="padding: .5rem; border-radius: 6px; border: 1px solid #7dd3fc;">
                    <option value="general">일반</option>
                    <option value="revival">부흥회</option>
                    <option value="christmas">성탄절</option>
                    <option value="easter">부활절</option>
                    <option value="thanksgiving">추수감사절</option>
                    <option value="new_year">신년/송년</option>
                    <option value="special_service">특별집회</option>
                    <option value="bible_school">성경학교</option>
                    <option value="baptism">세례/침례</option>
                    <option value="ordination">임직/취임</option>
                    <option value="mission">선교/전도</option>
                  </select>
                  <input type="text" id="ref-style-tags" placeholder="스타일 태그 (예: 모던,그라데이션,미니멀)" style="padding: .5rem; border-radius: 6px; border: 1px solid #7dd3fc;">
                </div>
                <input type="text" id="ref-description" placeholder="설명 (선택, 예: 파란 그라데이션 배경, 깔끔한 레이아웃)" style="padding: .5rem; border-radius: 6px; border: 1px solid #7dd3fc;">
                <div style="display: flex; gap: .5rem;">
                  <button onclick="addReferenceImage()" style="flex: 1; padding: .6rem; background: #0ea5e9; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    📥 참조 이미지 추가
                  </button>
                  <button onclick="previewReferenceImage()" style="padding: .6rem 1rem; background: #f0f9ff; border: 1px solid #7dd3fc; border-radius: 6px; cursor: pointer;">
                    👁️ 미리보기
                  </button>
                </div>
              </div>
              <!-- 미리보기 영역 -->
              <div id="ref-preview-container" style="display: none; margin-top: .75rem;">
                <img id="ref-preview-image" src="" style="max-width: 100%; max-height: 150px; border-radius: 6px; border: 1px solid #ddd;">
              </div>
            </div>

            <!-- 웹사이트 일괄 크롤링 -->
            <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #f59e0b;">
              <div style="font-weight: 600; color: #b45309; margin-bottom: .75rem; font-size: .9rem;">🔍 웹사이트에서 일괄 수집</div>
              <div style="font-size: .8rem; color: #92400e; margin-bottom: .75rem;">현수막 업체 포트폴리오 페이지 URL을 입력하면 이미지를 자동으로 수집합니다.</div>
              <div style="display: flex; gap: .5rem; margin-bottom: .5rem;">
                <input type="text" id="crawl-url" placeholder="웹사이트 URL (예: https://현수막업체.com/portfolio)" style="flex: 1; padding: .5rem; border-radius: 6px; border: 1px solid #fbbf24;">
                <button onclick="crawlImages()" id="btn-crawl" style="padding: .5rem 1rem; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                  🔍 수집
                </button>
              </div>
              <!-- 크롤링 결과 -->
              <div id="crawl-result" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin: .75rem 0 .5rem;">
                  <span id="crawl-count" style="font-size: .85rem; color: #92400e; font-weight: 600;">0개 이미지 발견</span>
                  <div style="display: flex; gap: .5rem;">
                    <button onclick="selectAllCrawled(true)" style="padding: .3rem .6rem; background: white; border: 1px solid #fbbf24; border-radius: 4px; cursor: pointer; font-size: .75rem;">전체 선택</button>
                    <button onclick="selectAllCrawled(false)" style="padding: .3rem .6rem; background: white; border: 1px solid #fbbf24; border-radius: 4px; cursor: pointer; font-size: .75rem;">전체 해제</button>
                  </div>
                </div>
                <div id="crawl-images" style="max-height: 250px; overflow-y: auto; background: white; border-radius: 6px; padding: .5rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: .5rem;">
                </div>
                <div style="display: flex; gap: .5rem; margin-top: .75rem;">
                  <select id="crawl-template-type" style="flex: 1; padding: .5rem; border-radius: 6px; border: 1px solid #fbbf24;">
                    <option value="general">행사 유형: 일반</option>
                    <option value="revival">부흥회</option>
                    <option value="christmas">성탄절</option>
                    <option value="easter">부활절</option>
                    <option value="thanksgiving">추수감사절</option>
                    <option value="new_year">신년/송년</option>
                    <option value="special_service">특별집회</option>
                    <option value="bible_school">성경학교</option>
                    <option value="baptism">세례/침례</option>
                    <option value="ordination">임직/취임</option>
                    <option value="mission">선교/전도</option>
                  </select>
                  <input type="text" id="crawl-style-tags" placeholder="스타일 태그" style="flex: 1; padding: .5rem; border-radius: 6px; border: 1px solid #fbbf24;">
                </div>
                <button onclick="bulkAddCrawledImages()" id="btn-bulk-add" style="width: 100%; margin-top: .5rem; padding: .6rem; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                  📥 선택한 이미지 일괄 등록
                </button>
              </div>
              <!-- 로딩 표시 -->
              <div id="crawl-loading" style="display: none; text-align: center; padding: 1rem; color: #92400e;">
                <div style="font-size: 1.5rem; margin-bottom: .5rem;">⏳</div>
                <div>이미지를 수집하고 있습니다...</div>
              </div>
            </div>

            <!-- 등록된 참조 이미지 목록 -->
            <div>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                <div style="font-weight: 600; color: #0369a1; font-size: .9rem;">📋 등록된 참조 이미지</div>
                <button onclick="loadReferenceImages()" style="padding: .3rem .6rem; background: #f0f9ff; border: 1px solid #7dd3fc; border-radius: 4px; cursor: pointer; font-size: .75rem;">
                  🔄 새로고침
                </button>
              </div>
              <div id="ref-images-list" style="max-height: 300px; overflow-y: auto; background: white; border-radius: 8px; padding: .5rem;">
                <div style="text-align: center; color: #888; padding: 2rem; font-size: .85rem;">
                  등록된 참조 이미지가 없습니다.<br>
                  좋은 현수막 이미지 URL을 추가해주세요.
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- // 디자인 도우미 콘텐츠 끝 -->
      </div>
    </div>

    <!-- 오른쪽 -->
    <div class="right-col">
      <div class="chat-panel">
        <div class="qa-interface">
          <div class="qa-prompt">검색된 결과에 대해 간단한 질문을 해주세요.</div>
          <div class="qa-history" id="qa-history">
            <div class="qa-empty-state">아직 질문이 없습니다.<br>처리 단계 결과나 본문에 대해 궁금한 점을 물어보세요.</div>
          </div>
          <div class="qa-input-area">
            <textarea id="qa-input" placeholder="질문을 입력하세요. (분석된 내용에 대해서 질문 하시면, 추가 답변을 드립니다.)"></textarea>
            <button id="btn-send-qa" class="primary">전송</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- 패스워드 모달 -->
  <div id="modal-password" class="modal">
    <div class="modal-content">
      <div class="modal-title">🔒 관리자 공간 잠금</div>
      <p style="color: #666; font-size: .9rem; margin-bottom: 1rem;">관리자 공간에 접근하려면 패스워드를 입력하세요.</p>
      <input type="password" id="password-input" placeholder="패스워드 입력" style="margin-bottom: .5rem;">
      <div class="modal-buttons">
        <button id="btn-cancel-password">취소</button>
        <button id="btn-submit-password" class="primary">확인</button>
      </div>
    </div>
  </div>

  <!-- 관리자 공간 모달 -->
  <div id="modal-admin-panel" class="modal">
    <div class="modal-content" style="max-width: 900px; min-height: 80vh; max-height: 95vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div class="modal-title" style="margin: 0;">🔒 관리자 공간</div>
        <div style="display: flex; gap: .5rem; align-items: center;">
          <button id="btn-sermon-chatbot" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: .5rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: .85rem;">🤖 AI 도우미</button>
          <button id="btn-close-admin-panel" style="background: transparent; border: none; font-size: 1.5rem; cursor: pointer; padding: 0; color: #999;">&times;</button>
        </div>
      </div>

      <div id="guide-content">
        <!-- AI 모델 설정 (제일 위로) -->
        <div style="margin-bottom: 1.5rem;">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: .6rem 1rem; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 1rem;">🤖 AI 모델 설정</div>
          <div style="background: #f8f5ff; padding: 1rem; border-radius: 0 0 8px 8px; border: 2px solid #667eea; border-top: none;">
            <div style="font-size: .85rem; color: #666; margin-bottom: 1rem;">
              각 단계에서 사용할 AI 모델을 선택하세요. 비용 차이는 기준 모델 대비 %입니다.
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
              <!-- Step1 모델 -->
              <div style="background: white; padding: .75rem; border-radius: 8px; border: 2px solid #ff6b6b;">
                <label style="font-weight: 700; font-size: .9rem; color: #ff6b6b; display: block; margin-bottom: .4rem;">Step1 (본문 연구)</label>
                <select id="model-step1" style="width: 100%; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem;">
                  <option value="gpt-4o">GPT-4o (기준)</option>
                  <option value="gpt-4o-mini">GPT-4o Mini (-94% 저렴)</option>
                  <option value="gpt-5">GPT-5 (+100%)</option>
                  <option value="gpt-5.1">GPT-5.1 (+200%)</option>
                </select>
                <div style="font-size: .7rem; color: #999; margin-top: .3rem;">기준: GPT-4o</div>
              </div>
              <!-- Step2 모델 -->
              <div style="background: white; padding: .75rem; border-radius: 8px; border: 2px solid #4ecdc4;">
                <label style="font-weight: 700; font-size: .9rem; color: #4ecdc4; display: block; margin-bottom: .4rem;">Step2 (설교 구조)</label>
                <select id="model-step2" style="width: 100%; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem;">
                  <option value="gpt-4o">GPT-4o (기준)</option>
                  <option value="gpt-4o-mini">GPT-4o Mini (-94% 저렴)</option>
                  <option value="gpt-5">GPT-5 (+100%)</option>
                  <option value="gpt-5.1">GPT-5.1 (+200%)</option>
                </select>
                <div style="font-size: .7rem; color: #999; margin-top: .3rem;">기준: GPT-4o</div>
              </div>
              <!-- Step3 (설교문 작성) 모델 -->
              <div style="background: white; padding: .75rem; border-radius: 8px; border: 2px solid #f5576c;">
                <label style="font-weight: 700; font-size: .9rem; color: #f5576c; display: block; margin-bottom: .4rem;">Step3 (설교문 작성)</label>
                <select id="model-gpt-pro" style="width: 100%; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem;">
                  <option value="gpt-5">GPT-5 (기준)</option>
                  <option value="gpt-4o">GPT-4o (-50% 저렴)</option>
                  <option value="gpt-5.1">GPT-5.1 (+50%)</option>
                </select>
                <div style="font-size: .7rem; color: #999; margin-top: .3rem;">기준: GPT-5</div>
              </div>
            </div>
            <!-- Step3 토큰량 설정 -->
            <div style="background: white; padding: .75rem; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: .5rem;">
              <label style="font-weight: 600; font-size: .85rem; color: #f5576c; display: block; margin-bottom: .4rem;">Step3 기본 토큰량</label>
              <div style="display: flex; gap: .5rem; align-items: center;">
                <input type="number" id="step3-max-tokens" value="16000" min="1000" max="32000" step="1000" style="width: 120px; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem;">
                <span style="font-size: .8rem; color: #666;">토큰 (기본: 16000, 최대: 32000)</span>
              </div>
            </div>
            <!-- 스타일별 토큰 설정 (접기/펼치기) -->
            <div style="background: white; padding: .75rem; border-radius: 8px; border: 1px solid #e0e0e0;">
              <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleStyleTokens()">
                <label style="font-weight: 600; font-size: .85rem; color: #f5576c;">📊 스타일별 토큰 설정</label>
                <span id="style-tokens-toggle" style="font-size: .8rem; color: #999;">▼ 펼치기</span>
              </div>
              <div id="style-tokens-container" style="display: none; margin-top: .75rem; max-height: 300px; overflow-y: auto;">
                <div style="font-size: .75rem; color: #888; margin-bottom: .5rem;">각 설교 스타일별로 Step3 토큰량을 개별 설정할 수 있습니다. 비워두면 기본값 사용.</div>
                <div id="style-tokens-list">
                  <!-- 동적으로 생성됨 -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- JSON 디버그 패널 -->
        <div style="margin-bottom: 1.5rem;">
          <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: .6rem 1rem; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 1rem; display: flex; justify-content: space-between; align-items: center;">
            <span>🔍 JSON 지침 디버그</span>
            <button id="btn-refresh-json-debug" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: .3rem .6rem; border-radius: 4px; cursor: pointer; font-size: .8rem;">새로고침</button>
          </div>
          <div style="background: #f0fff4; padding: 1rem; border-radius: 0 0 8px 8px; border: 2px solid #38ef7d; border-top: none;">
            <div id="json-debug-content">
              <div style="font-size: .85rem; color: #666; margin-bottom: .5rem;">현재 선택된 단계의 지침을 분석합니다.</div>

              <!-- 상태 표시 -->
              <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <div style="background: white; padding: .5rem .75rem; border-radius: 6px; border: 1px solid #ddd;">
                  <span style="font-size: .75rem; color: #888;">형식:</span>
                  <span id="json-debug-format" style="font-weight: 700; margin-left: .3rem;">-</span>
                </div>
                <div style="background: white; padding: .5rem .75rem; border-radius: 6px; border: 1px solid #ddd;">
                  <span style="font-size: .75rem; color: #888;">스타일:</span>
                  <span id="json-debug-style" style="font-weight: 700; margin-left: .3rem;">-</span>
                </div>
                <div style="background: white; padding: .5rem .75rem; border-radius: 6px; border: 1px solid #ddd;">
                  <span style="font-size: .75rem; color: #888;">역할:</span>
                  <span id="json-debug-role" style="font-weight: 700; margin-left: .3rem;">-</span>
                </div>
              </div>

              <!-- output_format 필드 목록 -->
              <div style="margin-bottom: 1rem;">
                <div style="font-weight: 600; font-size: .85rem; margin-bottom: .5rem; color: #333;">📋 출력 필드 (output_format)</div>
                <div id="json-debug-fields" style="background: white; padding: .75rem; border-radius: 6px; border: 1px solid #ddd; max-height: 150px; overflow-y: auto; font-size: .8rem; font-family: monospace;">
                  <span style="color: #999;">지침을 선택하세요</span>
                </div>
              </div>

              <!-- writing_spec (Step2용) -->
              <div style="margin-bottom: 1rem;">
                <div style="font-weight: 600; font-size: .85rem; margin-bottom: .5rem; color: #333;">⚙️ 작성 규격 (writing_spec)</div>
                <div id="json-debug-writing-spec" style="background: white; padding: .75rem; border-radius: 6px; border: 1px solid #ddd; font-size: .8rem;">
                  <span style="color: #999;">Step2 지침에만 표시됩니다</span>
                </div>
              </div>

              <!-- 생성될 프롬프트 미리보기 -->
              <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                  <div style="font-weight: 600; font-size: .85rem; color: #333;">💬 생성될 프롬프트 미리보기</div>
                  <button id="btn-copy-prompt-preview" style="font-size: .75rem; padding: .2rem .5rem; cursor: pointer;">복사</button>
                </div>
                <textarea id="json-debug-prompt" readonly style="width: 100%; height: 120px; font-size: .75rem; font-family: monospace; background: #1a1a2e; color: #16c79a; padding: .75rem; border-radius: 6px; border: none; resize: vertical;"></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Step3/Step4 프롬프트 비교 -->
        <div style="margin-bottom: 1.5rem;">
          <div style="background: linear-gradient(135deg, #f5576c 0%, #667eea 100%); color: white; padding: .6rem 1rem; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 1rem; display: flex; justify-content: space-between; align-items: center;">
            <span>📊 Step3 vs Step4 프롬프트 비교</span>
            <button id="btn-refresh-step-compare" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: .3rem .6rem; border-radius: 4px; cursor: pointer; font-size: .8rem;">🔄 새로고침</button>
          </div>
          <div style="background: #fef5ff; padding: 1rem; border-radius: 0 0 8px 8px; border: 2px solid #667eea; border-top: none;">
            <div style="font-size: .85rem; color: #666; margin-bottom: .75rem;">
              <strong>Step3</strong> (🔴 분홍색 버튼): 서버에서 GPT API 직접 호출 &nbsp;|&nbsp;
              <strong>Step4</strong> (🟣 보라색 버튼): 프롬프트 복사 → 개인 GPT에 붙여넣기
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <!-- Step3 프롬프트 -->
              <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                  <div style="font-weight: 700; font-size: .9rem; color: #f5576c;">🔴 Step3 (서버 호출)</div>
                  <button onclick="copyStepPrompt('step3')" style="font-size: .7rem; padding: .2rem .4rem; cursor: pointer;">복사</button>
                </div>
                <textarea id="step3-prompt-preview" readonly style="width: 100%; height: 300px; font-size: .75rem; font-family: monospace; background: #1a1a2e; color: #ff6b9d; padding: .75rem; border-radius: 6px; border: none; resize: vertical;"></textarea>
                <div id="step3-prompt-stats" style="font-size: .7rem; color: #888; margin-top: .3rem;">글자수: -</div>
              </div>
              <!-- Step4 프롬프트 -->
              <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                  <div style="font-weight: 700; font-size: .9rem; color: #667eea;">🟣 Step4 (전체 복사)</div>
                  <button onclick="copyStepPrompt('step4')" style="font-size: .7rem; padding: .2rem .4rem; cursor: pointer;">복사</button>
                </div>
                <textarea id="step4-prompt-preview" readonly style="width: 100%; height: 300px; font-size: .75rem; font-family: monospace; background: #1a1a2e; color: #9d6bff; padding: .75rem; border-radius: 6px; border: none; resize: vertical;"></textarea>
                <div id="step4-prompt-stats" style="font-size: .7rem; color: #888; margin-top: .3rem;">글자수: -</div>
              </div>
            </div>
            <!-- 차이점 요약 -->
            <div style="margin-top: 1rem; background: white; padding: .75rem; border-radius: 6px; border: 1px solid #ddd;">
              <div style="font-weight: 600; font-size: .85rem; margin-bottom: .5rem;">📌 현재 상태</div>
              <div id="step-compare-summary" style="font-size: .8rem; color: #666;">
                현재 Step3과 Step4는 <strong>동일한 프롬프트</strong>를 사용합니다.<br>
                추후 Step3에 고급 기능(RAG, 예시 설교 참조 등)을 추가하여 차별화할 예정입니다.
              </div>
            </div>
          </div>
        </div>

        <!-- 처리 단계 지침 -->
        <div style="margin-bottom: 1.5rem;">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: .6rem 1rem; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 1rem;">📋 처리 단계 지침</div>
          <div style="background: #f8f5ff; padding: 1rem; border-radius: 0 0 8px 8px; border: 2px solid #667eea; border-top: none;">
            <!-- 설교 스타일 선택 -->
            <div style="margin-bottom: .75rem;">
              <label style="font-size: .85rem; color: #666; font-weight: 600; display: block; margin-bottom: .3rem;">설교 스타일 선택</label>
              <select id="admin-style-select" style="width: 100%; padding: .5rem; border-radius: 6px; border: 1px solid #ddd; font-size: .9rem; background: white;">
                <option value="">-- 스타일을 선택하세요 --</option>
              </select>
            </div>
            <div class="btn-row" style="margin-bottom: .5rem;">
              <button id="save-guide" class="primary">지침 저장</button>
            </div>
            <div id="guide-tabs" class="btn-row" style="margin-bottom: .5rem;"></div>
            <div id="current-guide-info" style="font-size: .85rem; color: #666; margin-bottom: .5rem;"></div>
            <textarea id="guide-text" class="autosize" style="min-height: 120px;" placeholder="이 처리 단계의 구체적인 지침을 작성하세요."></textarea>
          </div>
        </div>

        <!-- Step3 사용 코드 관리 -->
        <div style="margin-bottom: 1.5rem;">
          <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: .6rem 1rem; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 1rem;">🔑 Step3 사용 코드 관리</div>
          <div style="background: #fffbf0; padding: 1rem; border-radius: 0 0 8px 8px; border: 2px solid #f39c12; border-top: none;">
            <div style="font-size: .85rem; color: #666; margin-bottom: 1rem;">
              테스터에게 배포할 1회용 코드를 생성하고 관리합니다. 코드당 사용 횟수를 지정할 수 있습니다.
            </div>
            <!-- 새 코드 생성 -->
            <div style="background: white; padding: .75rem; border-radius: 8px; border: 1px solid #ffe0b2; margin-bottom: 1rem;">
              <div style="font-weight: 600; font-size: .9rem; color: #e67e22; margin-bottom: .5rem;">새 코드 생성</div>
              <div style="display: flex; gap: .5rem; align-items: center; flex-wrap: wrap;">
                <input type="text" id="new-code-name" placeholder="코드명 (비우면 자동생성)" style="flex: 1; min-width: 150px; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem;">
                <div style="display: flex; align-items: center; gap: .3rem;">
                  <label style="font-size: .85rem; color: #666;">횟수:</label>
                  <input type="number" id="new-code-limit" value="3" min="1" max="100" style="width: 60px; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem; text-align: center;">
                </div>
                <button id="btn-create-code" style="padding: .4rem .8rem; background: #f39c12; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: .85rem; font-weight: 600;">생성</button>
              </div>
            </div>
            <!-- 코드 목록 -->
            <div style="font-weight: 600; font-size: .9rem; color: #e67e22; margin-bottom: .5rem;">코드 목록</div>
            <div id="code-list-container" style="max-height: 200px; overflow-y: auto; background: white; border-radius: 8px; border: 1px solid #ffe0b2;">
              <table style="width: 100%; border-collapse: collapse; font-size: .85rem;">
                <thead>
                  <tr style="background: #fff8e1; position: sticky; top: 0;">
                    <th style="padding: .5rem; text-align: left; border-bottom: 1px solid #ffe0b2;">코드</th>
                    <th style="padding: .5rem; text-align: center; border-bottom: 1px solid #ffe0b2;">남은횟수</th>
                    <th style="padding: .5rem; text-align: center; border-bottom: 1px solid #ffe0b2;">상태</th>
                    <th style="padding: .5rem; text-align: center; border-bottom: 1px solid #ffe0b2;">관리</th>
                  </tr>
                </thead>
                <tbody id="code-list-body">
                  <tr><td colspan="4" style="padding: 1rem; text-align: center; color: #999;">로딩 중...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- 백업/복원 버튼 -->
        <div style="margin-bottom: 1rem;">
          <div style="background: #f8f9fa; padding: .75rem 1rem; border-radius: 8px; border: 1px solid #e0e0e0;">
            <div style="font-size: .85rem; color: #666; margin-bottom: .5rem; font-weight: 600;">💾 데이터 백업</div>
            <div class="btn-row" style="gap: .5rem;">
              <button id="btn-export-backup" style="flex: 1; font-size: .85rem;">백업 다운로드</button>
              <button id="btn-import-backup" style="flex: 1; font-size: .85rem;">백업 복원</button>
            </div>
            <input type="file" id="backup-file-input" accept=".json" style="display: none;">
            <div style="font-size: .75rem; color: #999; margin-top: .5rem;">
              정기적으로 백업 파일을 다운로드하여 안전한 곳에 보관하세요.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 사용 가이드 모달 -->
  <div id="modal-guide" class="modal">
    <div class="modal-content" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div class="modal-title" style="margin: 0;">📖 사용 가이드</div>
        <button id="btn-close-guide-x" style="background: transparent; border: none; font-size: 1.5rem; cursor: pointer; padding: 0; color: #999;">&times;</button>
      </div>

      <div style="color: #555; font-size: .85rem; line-height: 1.5;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
          <strong style="font-size: 1.05rem;">🎉 BIBLE LAB에 오신 것을 환영합니다!</strong><br>
          <span style="font-size: .8rem; opacity: 0.9;">AI 기반 설교 준비 도우미</span>
        </div>

        <div style="background: #f0f4ff; padding: .65rem; border-radius: 6px; margin-bottom: .6rem; border-left: 3px solid #667eea;">
          <strong style="color: #667eea;">1. 성경본문 입력</strong><br>
          <span style="font-size: .8rem;">성경본문을 입력하세요 (예: 시 78:1-8, 창세기 1장 1~10절)</span>
        </div>

        <div style="background: #f0f4ff; padding: .65rem; border-radius: 6px; margin-bottom: .6rem; border-left: 3px solid #667eea;">
          <strong style="color: #667eea;">2. 설교 스타일 선택</strong><br>
          <span style="font-size: .8rem;">3대지, 강해 설교, 주제 설교 중 선택</span>
        </div>

        <div style="background: #f0f4ff; padding: .65rem; border-radius: 6px; margin-bottom: .6rem; border-left: 3px solid #667eea;">
          <strong style="color: #667eea;">3. 설교 준비 시작</strong><br>
          <span style="font-size: .8rem;">보라색 버튼 클릭 → AI가 자동으로 본문 분석 수행</span>
        </div>

        <div style="background: #f0f4ff; padding: .65rem; border-radius: 6px; margin-bottom: .6rem; border-left: 3px solid #667eea;">
          <strong style="color: #667eea;">4. 진행 상태 확인</strong><br>
          <span style="font-size: .8rem;">각 단계별 처리 상황이 실시간으로 표시됩니다<br>(✅완료, ⏳처리중, ⏸️대기)</span>
        </div>

        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: .65rem; border-radius: 6px; margin-bottom: .6rem;">
          <strong style="color: white;">🟣 내 GPT에 붙여넣기</strong><br>
          <span style="font-size: .8rem; color: rgba(255,255,255,0.95);">분석 결과를 복사해서 개인 ChatGPT에서 설교문 작성</span>
        </div>

        <div style="background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); padding: .65rem; border-radius: 6px; margin-bottom: .6rem;">
          <strong style="color: white;">🔴 AI 설교문 완성</strong><br>
          <span style="font-size: .8rem; color: rgba(255,255,255,0.95);">PRO 기능 · BIBLE LAB이 직접 설교문 작성 (크레딧 차감)</span>
        </div>

        <div style="background: #e8f5e9; padding: .65rem; border-radius: 6px; border-left: 3px solid #4caf50;">
          <strong style="color: #2e7d32;">💡 TIP</strong><br>
          <span style="font-size: .8rem;">본문 선정에서 상황을 입력하면 적합한 성경본문을 추천받을 수 있습니다</span>
        </div>
      </div>

      <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0;">
        <label style="display: flex; align-items: center; gap: .5rem; cursor: pointer; font-size: .85rem;">
          <input type="checkbox" id="dont-show-week" style="width: 16px; height: 16px; cursor: pointer;">
          <span>일주일간 보지 않기</span>
        </label>
      </div>

      <div class="modal-buttons" style="margin-top: 1rem;">
        <button id="btn-close-guide" class="primary" style="flex: 1;">시작하기</button>
      </div>
    </div>
  </div>

  <!-- GPT PRO 패스워드 모달 -->
  <div id="modal-gpt-pro-password" class="modal">
    <div class="modal-content">
      <div class="modal-title">🔒 GPT PRO 실행 (테스트 중)</div>
      <p style="color: #666; font-size: .9rem; margin-bottom: 1rem;">이 기능은 현재 테스트 중입니다. 패스워드를 입력하세요.</p>
      <input type="password" id="gpt-pro-password-input" placeholder="패스워드 입력" style="margin-bottom: .5rem;">
      <div class="modal-buttons">
        <button id="btn-cancel-gpt-pro-password">취소</button>
        <button id="btn-submit-gpt-pro-password" class="primary">확인</button>
      </div>
    </div>
  </div>

  <!-- 관리 기능 패스워드 모달 -->
  <div id="modal-manage-password" class="modal">
    <div class="modal-content">
      <div class="modal-title">🔒 관리 기능 잠금</div>
      <p style="color: #666; font-size: .9rem; margin-bottom: 1rem;">카테고리 및 스타일 관리는 관리자만 사용할 수 있습니다. 패스워드를 입력하세요.</p>
      <input type="password" id="manage-password-input" placeholder="패스워드 입력" style="margin-bottom: .5rem;">
      <div class="modal-buttons">
        <button id="btn-cancel-manage-password">취소</button>
        <button id="btn-submit-manage-password" class="primary">확인</button>
      </div>
    </div>
  </div>

  <!-- AI 챗봇 팝업 모달 -->
  <div id="modal-sermon-chatbot" class="modal">
    <div class="modal-content" style="max-width: 600px; height: 70vh; display: flex; flex-direction: column;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div class="modal-title" style="margin: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">🤖 AI 도우미</div>
        <div style="display: flex; gap: .5rem; align-items: center;">
          <select id="sermon-chat-model" style="padding: .4rem .6rem; border-radius: 6px; border: 1px solid #ddd; font-size: .8rem; cursor: pointer;">
            <option value="gpt-4o-mini">GPT-4o Mini (빠름)</option>
            <option value="gpt-4o">GPT-4o (균형)</option>
            <option value="gpt-5">GPT-5 (강력)</option>
          </select>
          <button id="btn-close-sermon-chatbot" style="background: transparent; border: none; font-size: 1.5rem; cursor: pointer; padding: 0; color: #999;">&times;</button>
        </div>
      </div>
      <div style="font-size: .85rem; color: #666; margin-bottom: 1rem; padding: .75rem; background: #f8f9fa; border-radius: 8px;">
        설교문 작성 과정에서 궁금한 점을 질문해보세요.<br>
        <span style="color: #667eea;">Step3 오류, API 문제, 설교 내용 개선</span> 등 무엇이든 도와드립니다!
      </div>
      <!-- 채팅 메시지 영역 -->
      <div id="sermon-chat-messages" style="flex: 1; background: #f0f0f0; border-radius: 8px; padding: .75rem; overflow-y: auto; margin-bottom: .75rem;">
        <div class="chat-welcome" style="text-align: center; color: #999; padding: 2rem; font-size: .85rem;">
          <div style="font-size: 2.5rem; margin-bottom: .5rem;">💬</div>
          <p>어떤 도움이 필요하신가요?</p>
          <div style="margin-top: 1rem; font-size: .75rem; color: #bbb; line-height: 1.6;">
            예시 질문:<br>
            "Step3에서 오류가 났는데 왜 그런거야?"<br>
            "지금 작성된 설교 내용을 요약해줘"<br>
            "크레딧이 부족하다고 나오는데 어떻게 해?"
          </div>
        </div>
      </div>
      <!-- 입력 영역 -->
      <div style="display: flex; gap: .5rem;">
        <input type="text" id="sermon-chat-input" placeholder="질문을 입력하세요..." style="flex: 1; padding: .6rem .8rem; border-radius: 8px; border: 1px solid #ddd; font-size: .9rem;">
        <button id="btn-sermon-chat-send" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: .6rem 1.2rem; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: .9rem;">전송</button>
      </div>
    </div>
  </div>

  <!-- 카테고리 관리 모달 -->
  <div id="modal-categories" class="modal">
    <div class="modal-content">
      <div class="modal-title">카테고리 관리</div>
      <input type="text" id="new-cat-label" placeholder="표시 이름 (예: 특별예배)" style="margin-bottom: .5rem;">
      <button id="btn-add-category" class="primary" style="width: 100%; margin-bottom: 1rem;">추가</button>
      <div id="categories-list" style="max-height: 300px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button id="btn-close-categories">닫기</button>
      </div>
    </div>
  </div>

  <!-- 스타일 관리 모달 -->
  <div id="modal-styles" class="modal">
    <div class="modal-content">
      <div class="modal-title">설교 스타일 관리</div>
      <p style="font-size: .85rem; color: #666; margin-bottom: .5rem;">카테고리: <strong id="modal-styles-category"></strong></p>

      <input type="text" id="new-style-name" placeholder="스타일 이름 (예: 새벽예배 - 강해설교)" style="margin-bottom: .3rem;">
      <input type="text" id="new-style-desc" placeholder="설명 (예: 본론 중심, 아이스브래이킹 제외)" style="margin-bottom: .5rem;">
      <button id="btn-add-style" class="primary" style="width: 100%; margin-bottom: 1rem;">추가</button>

      <div id="styles-manage-list" style="max-height: 300px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button id="btn-close-styles">닫기</button>
      </div>
    </div>
  </div>

  <!-- 처리 단계 관리 모달 -->
  <div id="modal-steps" class="modal">
    <div class="modal-content">
      <div class="modal-title">처리 단계 관리</div>
      <p style="font-size: .85rem; color: #666; margin-bottom: .5rem;">
        스타일: <strong id="modal-steps-style"></strong>
      </p>
      <input type="text" id="new-step-name" placeholder="단계 이름 (예: 제목 추천, 본문 분석, 개요 작성)" style="margin-bottom: .5rem;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: .5rem; margin-bottom: 1rem;">
        <button id="btn-add-step1" class="primary" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); border: none; box-shadow: 0 3px 10px rgba(255,107,107,.3);">➕ Step1 추가</button>
        <button id="btn-add-step2" class="primary" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a3c2 100%); border: none; box-shadow: 0 3px 10px rgba(78,205,196,.3);">➕ Step2 추가</button>
      </div>
      <div id="steps-list" style="max-height: 300px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button id="btn-close-steps">닫기</button>
      </div>
    </div>
  </div>

  <!-- GPT 작업 중 로딩 오버레이 -->
  <div id="gpt-loading-overlay" style="display: none;">
    <div class="gpt-loading-content">
      <div class="gpt-loading-spinner"></div>
      <div class="gpt-loading-text">BIBLE LAB을 이용해 주셔서 감사합니다</div>
      <div class="gpt-loading-subtext">잠시만 기다려주세요</div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <!-- Sermon JS Modules -->
  <script src="{{ url_for('static', filename='js/sermon-utils.js') }}"></script>
  <script src="{{ url_for('static', filename='js/sermon-firebase.js') }}"></script>
  <script src="{{ url_for('static', filename='js/sermon-main.js') }}"></script>
  <script src="{{ url_for('static', filename='js/sermon-render.js') }}"></script>
  <script src="{{ url_for('static', filename='js/sermon-step.js') }}"></script>
  <script src="{{ url_for('static', filename='js/sermon-gpt-pro.js') }}"></script>
  <script src="{{ url_for('static', filename='js/sermon-admin.js') }}"></script>
  <script src="{{ url_for('static', filename='js/sermon-qa.js') }}"></script>
  <script src="{{ url_for('static', filename='js/sermon-meditation.js') }}"></script>
  <script src="{{ url_for('static', filename='js/sermon-design.js') }}"></script>
  <script src="{{ url_for('static', filename='js/sermon-init.js') }}"></script>

</body>
</html>
