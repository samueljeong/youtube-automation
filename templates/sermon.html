<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>BIBLE LAB</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
    }
    .page-wrap {
      display: grid;
      grid-template-columns: 310px 1.1fr 360px;
      gap: 1rem;
      padding: 1rem;
      height: 100vh;
      align-items: stretch;
    }
    .left-col {
      display: flex;
      flex-direction: column;
      gap: .75rem;
      overflow-y: auto;
      background: linear-gradient(135deg, #fafbfc 0%, #f3f4f6 100%);
      padding: .75rem;
      border-radius: 12px;
    }
    .middle-col {
      display: flex;
      flex-direction: column;
      gap: .75rem;
      min-width: 0;
    }
    .right-col {
      display: flex;
      flex-direction: column;
      gap: .75rem;
      min-width: 0;
      background: linear-gradient(135deg, #fafbfc 0%, #f3f4f6 100%);
      padding: .75rem;
      border-radius: 12px;
    }

    /* Top 영역: 고정 */
    .top-section {
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: .5rem;
      padding-bottom: .5rem;
      border-bottom: 2px solid #e0e0e0;
      background: #f5f5f5;
    }

    /* Content 영역: 스크롤 가능 */
    .content-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: .75rem;
      overflow-y: auto;
      padding-top: .75rem;
      min-height: 0;
    }
    .input-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: .75rem;
    }
    .dual-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: .75rem;
      align-items: stretch;
    }
    .dual-row > * {
      display: flex;
      flex-direction: column;
    }
    .action-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: .75rem;
    }
    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .box {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: .6rem;
    }
    .label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: .5rem;
      margin-bottom: .35rem;
    }
    .label { font-weight: 600; }
    .label-hint {
      font-size: .7rem;
      font-weight: 400;
      color: #0066cc;
      background: #e6f2ff;
      padding: .15rem .4rem;
      border-radius: 9999px;
      margin-left: .35rem;
      white-space: nowrap;
    }
    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: .35rem .5rem;
    }
    textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
      line-height: 1.4;
    }
    .btn-row {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
    }
    button {
      padding: .35rem .6rem;
      border: 1px solid #ccc;
      background: #f0f0f0;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #e0e0e0; }
    button.primary {
      background: #4a90e2;
      color: white;
      border-color: #4a90e2;
    }
    button.primary:hover { background: #357abd; }
    button.danger {
      background: #e74c3c;
      color: white;
      border-color: #e74c3c;
    }
    button.step-btn {
      text-align: left;
      padding-left: .8rem;
    }

    .style-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .4rem .6rem;
      margin-bottom: .3rem;
      background: #f8f9fa;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .style-item:hover { background: #e9ecef; }
    .style-item.active {
      background: #dfe6ff;
      border: 2px solid #4a90e2;
    }
    .style-desc {
      font-size: .65rem;
      color: #999;
      margin-top: .15rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .title-option-label {
      display: block;
      margin-bottom: .5rem;
      padding: .4rem;
      background: #f8f9fa;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .title-option-label:hover {
      background: #e9ecef;
    }
    .title-option-label input[type="radio"]:checked + span {
      font-weight: 600;
      color: #4a90e2;
    }

    .toggle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .status-bar {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 1rem 2rem;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      display: none;
      text-align: center;
      z-index: 3000;
      animation: pulse 1.5s ease-in-out infinite;
    }
    .category-buttons {
      display: flex;
      gap: .4rem;
      flex-wrap: wrap;
      margin-bottom: .5rem;
    }
    .category-chip {
      border: 1px solid #ccd6f6;
      background: #f0f4ff;
      color: #3553a4;
      padding: .3rem .6rem;
      border-radius: 999px;
      font-size: .85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .category-chip:hover {
      background: #dbe4ff;
      border-color: #4a90e2;
    }
    .category-chip.active {
      background: #4a90e2;
      color: white;
      border-color: #4a90e2;
    }
    .result-wrapper {
      display: flex;
      flex-direction: column;
      gap: .75rem;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* GPT 로딩 오버레이 */
    #gpt-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .gpt-loading-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 3rem 4rem;
      border-radius: 24px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), 0 0 100px rgba(102, 126, 234, 0.3);
      animation: slideUp 0.5s ease;
      position: relative;
      overflow: hidden;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .gpt-loading-content::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .gpt-loading-spinner {
      width: 64px;
      height: 64px;
      margin: 0 auto 1.5rem;
      border: 5px solid rgba(255, 255, 255, 0.2);
      border-top: 5px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      position: relative;
      z-index: 1;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .gpt-loading-text {
      font-size: 1.4rem;
      font-weight: 700;
      color: white;
      margin-bottom: 0.5rem;
      letter-spacing: 0.5px;
      position: relative;
      z-index: 1;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .gpt-loading-subtext {
      font-size: 0.95rem;
      color: rgba(255, 255, 255, 0.9);
      position: relative;
      z-index: 1;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.6;
      }
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    .modal.show { display: flex; }

    /* 가이드 모달 - 오른쪽 하단에 배치, 뒤 클릭 가능 */
    #modal-guide {
      background: transparent;
      pointer-events: none;
      align-items: flex-end;
      justify-content: flex-end;
      padding: 1.5rem;
    }
    #modal-guide .modal-content {
      pointer-events: auto;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .modal-buttons {
      display: flex;
      gap: .5rem;
      margin-top: 1rem;
    }
    .modal-buttons button { flex: 1; }

    .storage-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .4rem .6rem;
      margin-bottom: .3rem;
      background: #f8f9fa;
      border-radius: 6px;
    }

    textarea.autosize { overflow: hidden; }

    /* GPT PRO 결과 박스 스타일 */
    .gpt-pro-result-box {
      background: linear-gradient(135deg, #ff6b9d 0%, #c06c84 100%);
      border: none;
      padding: 1rem;
      border-radius: 8px;
      margin-top: .75rem;
    }
    .gpt-pro-result-box .label {
      color: white;
      font-size: 1.1rem;
      margin-bottom: .5rem;
    }
    .gpt-pro-result-box textarea {
      background: white;
      border: none;
      border-radius: 6px;
      padding: .75rem;
      min-height: 300px;
    }

    /* 버튼 컨테이너 */
    .top-buttons-container {
      display: flex;
      gap: .75rem;
    }
    .top-buttons-container .box {
      flex: 1;
      padding: .7rem;
      border: none;
    }
    .copy-all-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .gpt-pro-box {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .top-buttons-container button {
      background: white;
      font-weight: 600;
      padding: .6rem 1.2rem;
      border: none;
      font-size: .95rem;
      width: 100%;
    }
    .copy-all-box button {
      color: #667eea;
    }
    .gpt-pro-box button {
      color: #f5576c;
    }
    .top-buttons-container .box-title {
      color: white;
      font-weight: 600;
      font-size: .95rem;
      margin-bottom: .25rem;
    }
    .top-buttons-container .box-desc {
      color: rgba(255,255,255,0.9);
      font-size: .8rem;
      margin-bottom: .5rem;
    }

    /* Auth header */
    .auth-header {
      background: white;
      border-bottom: 2px solid #e0e0e0;
      padding: .75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .auth-header h1 {
      font-size: 1.2rem;
      margin: 0;
      color: #333;
    }
    .auth-links {
      display: flex;
      gap: .75rem;
      align-items: center;
    }
    .auth-links .user-info {
      font-size: .9rem;
      color: #555;
      font-weight: 500;
    }
    .auth-links a {
      padding: .4rem .8rem;
      text-decoration: none;
      border-radius: 6px;
      font-size: .85rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    .auth-links .btn-login {
      background: white;
      color: #4a90e2;
      border: 2px solid #4a90e2;
    }
    .auth-links .btn-login:hover {
      background: #4a90e2;
      color: white;
    }
    .auth-links .btn-signup {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
    }
    .auth-links .btn-signup:hover {
      opacity: 0.9;
    }
    .auth-links .btn-logout {
      background: #e74c3c;
      color: white;
      border: none;
    }
    .auth-links .btn-logout:hover {
      background: #c0392b;
    }
    .auth-links .btn-home {
      background: #95a5a6;
      color: white;
      border: none;
    }
    .auth-links .btn-home:hover {
      background: #7f8c8d;
    }

    /* 관리자 공간 50:50 분할 */
    .guide-row-container {
      display: flex;
      gap: .75rem;
    }
    .guide-row-container .box {
      flex: 1;
    }

    /* 관리자 공간 스크롤 */
    #master-guide-content {
      max-height: 300px;
      overflow-y: auto;
    }
    /* 모달 내 guide-content는 제한 없음 */
    #modal-admin-panel #guide-content {
      max-height: none;
      overflow-y: visible;
    }

    /* 처리 단계 + Q&A 70:30 분할 */
    .processing-qa-container {
      display: flex;
      gap: .75rem;
      flex: 1;
      min-height: 0;
    }
    .processing-steps-panel {
      flex: 7;
      display: flex;
      flex-direction: column;
      gap: .75rem;
      overflow-y: auto;
    }
    .qa-panel {
      flex: 3;
      display: flex;
      flex-direction: column;
      gap: .75rem;
      overflow-y: auto;
    }

    /* Q&A 인터페이스 스타일 */
    .qa-interface {
      background: #fff;
      border: 2px solid #8e9aaf;
      border-radius: 8px;
      padding: .75rem;
      display: flex;
      flex-direction: column;
      height: 100%;
      box-shadow: 0 2px 8px rgba(142, 154, 175, 0.15);
    }
    .qa-prompt {
      font-size: .9rem;
      color: #666;
      margin-bottom: .75rem;
      padding: .5rem;
      background: #f8f9fa;
      border-radius: 6px;
      text-align: center;
    }
    .qa-history {
      flex: 1;
      overflow-y: auto;
      margin-bottom: .75rem;
      padding: .5rem;
      background: #fafafa;
      border-radius: 6px;
      min-height: 200px;
    }
    .qa-message {
      margin-bottom: .75rem;
      padding: .5rem;
      border-radius: 6px;
    }
    .qa-message.user {
      background: #e3f2fd;
      margin-left: 2rem;
    }
    .qa-message.assistant {
      background: #f1f8e9;
      margin-right: 2rem;
    }
    .qa-message-label {
      font-size: .75rem;
      font-weight: 600;
      margin-bottom: .25rem;
      color: #555;
    }
    .qa-message-content {
      font-size: .85rem;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    .qa-input-area {
      display: flex;
      gap: .5rem;
    }
    .qa-input-area textarea {
      flex: 1;
      min-height: 60px;
      resize: vertical;
    }
    .qa-input-area button {
      align-self: flex-end;
      height: fit-content;
    }
    .qa-empty-state {
      text-align: center;
      color: #999;
      font-size: .85rem;
      padding: 2rem;
    }

    /* ===== 모바일 반응형 디자인 ===== */
    @media screen and (max-width: 768px) {
      .page-wrap {
        display: flex;
        flex-direction: column;
        height: auto;
        min-height: 100vh;
        padding: .5rem;
        gap: .5rem;
      }

      .left-col,
      .middle-col,
      .right-col {
        width: 100%;
      }

      .left-col,
      .right-col {
        background: none;
        padding: 0;
      }

      .content-section {
        overflow-y: visible;
        padding-top: .5rem;
      }

      .input-grid,
      .dual-row,
      .action-row {
        grid-template-columns: 1fr;
      }

      .box {
        padding: .65rem;
      }

      /* 버튼 크기 증가 (터치 친화적) */
      button {
        padding: .5rem .75rem;
        font-size: .9rem;
        min-height: 44px; /* 터치 권장 크기 */
      }

      button.step-btn {
        font-size: .95rem;
      }

      /* 입력 필드 크기 증가 */
      input[type="text"],
      input[type="date"],
      input[type="password"],
      select {
        padding: .5rem .65rem;
        font-size: 16px; /* iOS 줌 방지 */
        min-height: 44px;
      }

      textarea {
        font-size: 16px; /* iOS 줌 방지 */
        padding: .5rem;
      }

      /* 상단 버튼 컨테이너 - 모바일에서는 세로 배치 */
      .top-buttons-container {
        flex-direction: column;
      }

      .top-buttons-container .box {
        width: 100%;
      }

      /* 관리자 공간 - 모바일에서는 세로 배치 */
      .guide-row-container {
        flex-direction: column;
      }

      .guide-row-container .box {
        width: 100%;
      }

      /* 처리 단계 + Q&A - 모바일에서는 세로 배치 */
      .processing-qa-container {
        flex-direction: column;
      }

      .processing-steps-panel,
      .qa-panel {
        width: 100%;
      }

      /* Auth 헤더 - 모바일 최적화 */
      .auth-header {
        flex-wrap: wrap;
        gap: .5rem;
        padding: .5rem;
      }

      .auth-header h1 {
        font-size: 1.1rem;
      }

      .auth-links {
        gap: .5rem;
        flex-wrap: wrap;
      }

      .auth-links a,
      .auth-links .user-info {
        font-size: .8rem;
        padding: .35rem .6rem;
      }

      /* 모달 크기 조정 */
      .modal-content {
        width: 95%;
        max-height: 90vh;
        padding: 1rem;
      }

      .modal-title {
        font-size: 1.1rem;
      }

      /* 스타일 아이템 터치 영역 증가 */
      .style-item {
        padding: .6rem .75rem;
        margin-bottom: .5rem;
      }

      /* Q&A 메시지 여백 조정 */
      .qa-message.user {
        margin-left: .5rem;
      }

      .qa-message.assistant {
        margin-right: .5rem;
      }

      /* 저장 아이템 버튼 크기 */
      .storage-item {
        flex-direction: column;
        align-items: flex-start;
        gap: .5rem;
      }

      .storage-item > div:last-child {
        display: flex;
        gap: .5rem;
        width: 100%;
      }

      .storage-item button {
        flex: 1;
        font-size: .85rem;
      }

      /* 버튼 행 줄바꿈 */
      .btn-row {
        flex-wrap: wrap;
      }

      /* 상태바 */
      .status-bar {
        font-size: .9rem;
        padding: .8rem 1.5rem;
        max-width: 80%;
      }

      /* 라벨 */
      .label {
        font-size: .95rem;
      }

      /* 제목 선택 라벨 */
      .title-option-label {
        padding: .5rem;
        margin-bottom: .6rem;
      }

      .title-option-label span {
        font-size: .9rem;
      }
    }

    /* 아주 작은 화면 (360px 이하) */
    @media screen and (max-width: 360px) {
      .page-wrap {
        padding: .25rem;
      }

      .box {
        padding: .5rem;
        border-radius: 6px;
      }

      button {
        font-size: .85rem;
        padding: .45rem .6rem;
      }

      .auth-header h1 {
        font-size: 1rem;
      }

      .modal-content {
        padding: .75rem;
      }
    }

    /* Step2 박스 고정 및 블라인드 처리 */
    .step2-box {
      position: relative;
    }

    .step2-content-wrapper {
      position: relative;
      max-height: 200px;
      overflow: hidden;
    }

    .step2-content-wrapper textarea {
      resize: none !important;
      overflow: hidden !important;
    }

    .step2-gradient-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 80px;
      background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,0.7) 40%, rgba(255,255,255,1) 100%);
      pointer-events: none;
    }

    /* 태블릿 가로 모드 (768px - 1024px) */
    @media screen and (min-width: 769px) and (max-width: 1024px) {
      .page-wrap {
        grid-template-columns: 280px 1fr 300px;
        padding: .75rem;
      }
    }
  </style>
</head>
<body>
  <!-- Auth Header -->
  <div class="auth-header">
    <h1>BIBLE LAB</h1>
    <div class="auth-links">
      <a href="/" class="btn-home">홈</a>
      {% if session.user_id %}
        <span class="user-info">{{ session.user_name }}님</span>
        <a href="/logout" class="btn-logout">로그아웃</a>
      {% else %}
        <a href="/login" class="btn-login">로그인</a>
        <a href="/signup" class="btn-signup">회원가입</a>
      {% endif %}
    </div>
  </div>

  <div class="page-wrap">
    <!-- 숨겨진 요소 (기존 코드 호환용) -->
    <input type="date" id="sermon-date" style="display: none;">
    <textarea id="sermon-text" style="display: none;"></textarea>

    <!-- 왼쪽 -->
    <div class="left-col">
      <div class="box">
        <div class="label-row" style="align-items: flex-start;">
          <div>
            <div class="label">카테고리</div>
            <div style="font-size: .8rem; color: #777;">클릭하여 선택</div>
          </div>
          <button id="btn-manage-categories" style="font-size: .75rem; padding: .2rem .5rem;">관리</button>
        </div>
        <div id="category-buttons" class="category-buttons"></div>
        <select id="sermon-category" style="display: none;"></select>
      </div>

      <div class="box" id="series-box" style="display: none;">
        <label class="label">시리즈명</label>
        <input type="text" id="series-name" placeholder="예: 요한복음 시리즈">
      </div>

      <div class="box">
        <div class="label-row">
          <div class="label">저장된 설교 리스트</div>
          <span style="font-size: .8rem; color: #777;">필요할 때 바로 불러오기</span>
        </div>
        <button id="btn-save" style="width: 100%; margin-bottom: .5rem;">현재 내용 저장</button>
        <div id="saved-list"></div>
      </div>

      <div class="box" style="background: linear-gradient(135deg, #FEE500 0%, #FFEB3B 100%); border: none; text-align: center; padding: 1rem;">
        <div style="font-size: .9rem; font-weight: 600; color: #3C1E1E; margin-bottom: .75rem;">
          💬 문의 및 궁금사항
        </div>
        <a href="https://open.kakao.com/o/sfFpe12h" target="_blank" rel="noopener noreferrer"
           style="display: inline-block; background: #3C1E1E; color: #FEE500; padding: .65rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: .9rem; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"
           onmouseover="this.style.background='#2C1414'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.25)';"
           onmouseout="this.style.background='#3C1E1E'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)';">
          💬 카카오톡 문의하기
        </a>
        <div style="font-size: .7rem; color: #6D4C41; margin-top: .75rem; opacity: 0.9;">
          📱 BIBLE LAB 오픈채팅방
        </div>
      </div>

      <div class="box" id="guide-box">
        <div class="label-row">
          <div class="label">관리자 공간 🔒</div>
          <a href="/sermon_admin" target="_blank" style="font-size: .85rem; color: #4a90e2; text-decoration: none; font-weight: 700;">새 창 열기</a>
        </div>
        <button id="toggle-guides" class="primary" style="width: 100%;">관리자 공간 열기</button>
      </div>
    </div>

    <!-- 가운데 -->
    <div class="middle-col">
      <div class="top-section" style="border-bottom: none; padding-bottom: 0;">
        <div id="status-bar" class="status-bar">작업 중...</div>
      </div>

      <div class="content-section">
        <!-- 설교 콘텐츠 -->
        <div id="sermon-content">
        <!-- 본문 선정 + 성경본문 (한 줄) -->
        <div class="input-grid" style="grid-template-columns: 1fr 1fr; gap: .5rem;">
          <!-- 본문 선정 (추천 기능) -->
          <div class="box" style="padding: .6rem;">
            <label class="label" style="font-size: .8rem;">📖 본문 선정 <span style="font-weight: 400; color: #777;">(상황을 입력하면 적합한 본문을 추천해드립니다)</span><span class="label-hint">선택</span></label>
            <div style="display: flex; gap: .5rem;">
              <input type="text" id="scripture-search" placeholder="예) 이사심방, 구국기도회, 송년예배" style="flex: 1; font-size: .85rem;">
              <button id="btn-search-scripture" class="primary" style="white-space: nowrap; font-size: .85rem;">검색</button>
            </div>
          </div>
          <!-- 성경본문 (필수) - 강조 스타일 -->
          <div class="box" style="padding: .6rem; background: linear-gradient(135deg, #f8f9ff 0%, #e8f4fd 100%); border: 2px solid #667eea;">
            <label class="label" style="font-size: .8rem;">📖 성경본문<span class="label-hint" style="background: #667eea; color: white;">필수</span></label>
            <input type="text" id="sermon-ref" placeholder="예) 시 78:1-8" style="border: 1px solid #667eea; background: white; font-size: .85rem;">
          </div>
        </div>
        <!-- 본문 추천 결과 (검색 결과가 여기에 표시됨) -->
        <div id="scripture-recommendations" style="display: none; margin-bottom: .5rem;">
          <div class="box" style="padding: .6rem; background: #f8f9ff;">
            <div style="font-size: .85rem; color: #667eea; margin-bottom: .5rem; font-weight: 600;">✨ 추천 본문 (클릭하여 선택)</div>
            <div id="scripture-list" style="display: flex; flex-direction: column; gap: .4rem;"></div>
          </div>
        </div>

        <!-- 제목, 예배·집회 유형, 분량, 대상 (한 줄 - 4열) -->
        <div class="input-grid" style="grid-template-columns: repeat(4, 1fr); gap: .5rem;">
          <div class="box" style="padding: .6rem;">
            <label class="label" style="font-size: .8rem;">제목<span class="label-hint">선택</span></label>
            <input type="text" id="manual-title" placeholder="직접 입력" style="font-size: .85rem;">
            <div id="title-selection-box" style="display: none; margin-top: .5rem;">
              <div style="font-size: .75rem; color: #667eea; margin-bottom: .3rem;">✨ 추천 제목</div>
              <div id="title-options"></div>
            </div>
          </div>
          <div class="box" style="padding: .6rem;">
            <label class="label" style="font-size: .8rem;">예배·집회 유형<span class="label-hint">선택</span></label>
            <input type="text" id="sermon-worship-type" placeholder="예) 새벽, 주일" style="font-size: .85rem;">
          </div>
          <div class="box" style="padding: .6rem;">
            <label class="label" style="font-size: .8rem;">분량<span class="label-hint">선택</span></label>
            <input type="text" id="sermon-duration" placeholder="기본 20분" value="" style="font-size: .85rem;">
          </div>
          <div class="box" style="padding: .6rem;">
            <label class="label" style="font-size: .8rem;">대상<span class="label-hint">선택</span></label>
            <input type="text" id="sermon-target" placeholder="예) 장년, 청년" style="font-size: .85rem;">
          </div>
        </div>

        <!-- 숨겨진 주제 입력 (기존 코드 호환용) -->
        <input type="hidden" id="sermon-topic">

        <!-- 특별 참고 사항 -->
        <div class="box" style="padding: .6rem; margin-bottom: .5rem;">
          <label class="label" style="font-size: .8rem;">특별 참고 사항<span class="label-hint">선택</span></label>
          <textarea id="special-notes" placeholder="설교 작성 시 고려해야 할 특별한 상황, 요청, 주의점을 자유롭게 기입하세요.&#10;예) 현장 상황, 성도 사정, 교회 일정, 설교자의 의도 등" style="font-size: .85rem; min-height: 60px; resize: vertical; width: 100%; padding: .5rem; border: 1px solid #e0e0e0; border-radius: 6px; line-height: 1.4;"></textarea>
        </div>

        <div class="dual-row">
          <div class="box" style="padding: .6rem;">
            <div class="label-row" style="margin-bottom: .4rem;">
              <label class="label" style="margin: 0;">설교 스타일<span class="label-hint">클릭하여 선택</span></label>
              <button id="btn-manage-styles" style="font-size: .75rem; padding: .2rem .5rem;">관리</button>
            </div>
            <div id="styles-list"></div>
            <!-- 설교 준비 시작 안내문구 (버튼 비활성화시 표시) -->
            <div id="start-analysis-guide" style="width: 100%; margin-top: .5rem; padding: .5rem; text-align: center; background: #f8f9ff; border-radius: 8px; border: 2px dashed #667eea;">
              <span style="font-size: .9rem; font-weight: 700; color: #667eea;">📖 성경본문을 입력해주세요</span>
            </div>
            <!-- 설교 준비 시작 버튼 -->
            <button id="btn-start-analysis" style="display: none; width: 100%; margin-top: .5rem; padding: .6rem; font-size: .9rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 700; border: none; border-radius: 8px; cursor: pointer;">
              ✨ 설교 준비 시작
            </button>
            <!-- 숨겨진 진행 상태 (내부 기능 유지) -->
            <div id="analysis-status" style="display: none;"></div>
            <div id="processing-steps" style="display: none;"></div>
          </div>
          <!-- 보라색/분홍색 박스 (가로 배치, 높이 자동 맞춤) -->
          <div style="display: flex; flex-direction: row; gap: .5rem; align-items: stretch;">
            <div class="box copy-all-box" id="step4-box" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: .6rem; opacity: 0.5; pointer-events: none; text-align: center; display: flex; flex-direction: column; justify-content: center;">
              <div class="box-title" style="font-size: .85rem; margin-bottom: .25rem; color: white; font-weight: 700;">🟣 내 GPT에 붙여넣기</div>
              <div class="box-desc" style="font-size: .7rem; margin-bottom: .4rem; color: rgba(255,255,255,0.95);">분석 내용을 복사해서 개인 ChatGPT에 사용하세요.</div>
              <button id="btn-copy-all" style="width: 100%; padding: .45rem; font-size: .8rem; background: white; color: #667eea; font-weight: 700; border: none; border-radius: 6px; cursor: pointer;">전체 복사</button>
            </div>
            <div class="box gpt-pro-box" id="step3-box" style="flex: 1; background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); border: none; padding: .6rem; opacity: 0.5; pointer-events: none; text-align: center; display: flex; flex-direction: column; justify-content: center;">
              <div class="box-title" style="font-size: .85rem; margin-bottom: .25rem; color: white; font-weight: 700;">🔴 AI 설교문 완성</div>
              <div class="box-desc" style="font-size: .7rem; margin-bottom: .4rem; color: rgba(255,255,255,0.95);">PRO 기능 · BIBLE LAB이 설교문을 작성합니다 (크레딧 1회 차감)</div>
              <button id="btn-gpt-pro" style="width: 100%; padding: .45rem; font-size: .8rem; background: white; color: #f5576c; font-weight: 700; border: none; border-radius: 6px; cursor: pointer;">설교문 작성</button>
            </div>
          </div>
        </div>

          <div class="box" style="display: flex; flex-direction: column; gap: .75rem;">
            <div class="label-row">
              <div class="label">처리 단계 결과</div>
              <span style="font-size: .8rem; color: #777;">선택한 단계의 결과가 여기에 순서대로 표시됩니다.</span>
            </div>
            <div id="result-boxes"></div>
          </div>

          <div id="gpt-pro-result-container" style="display: none;">
            <div class="gpt-pro-result-box">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                <div class="label" style="margin: 0;">🎯 Step3. 설교문 완성</div>
                <span id="usage-step3" style="font-size: .75rem; color: rgba(255,255,255,0.9);"></span>
              </div>
              <button id="btn-copy-gpt-pro" style="margin: .25rem 0 .75rem 0; width: 100%; background: white; color: #f5576c; font-weight: 600;">📋 설교문 전체 복사</button>
              <textarea id="gpt-pro-result" class="autosize" readonly placeholder="Step3 처리 결과가 여기에 표시됩니다."></textarea>
            </div>
          </div>
        </div>
        <!-- // 설교 콘텐츠 끝 -->

        <!-- 묵상메시지 콘텐츠 -->
        <div id="meditation-content" style="display: none;">
          <div class="box" style="background: linear-gradient(135deg, #f8f9ff 0%, #e8f4fd 100%); border: 2px solid #667eea;">
            <div class="label" style="margin-bottom: 1rem;">🙏 묵상메시지 작성</div>

            <!-- 첫 번째 줄: 날짜(요일 포함), 성경구절, 보내는 사람 -->
            <div style="display: flex; gap: .75rem; align-items: flex-end; flex-wrap: wrap; margin-bottom: .75rem;">
              <div>
                <label style="font-size: .8rem; color: #666; display: block; margin-bottom: .3rem;">날짜</label>
                <div style="display: flex; align-items: center; gap: .2rem;">
                  <input type="number" id="meditation-month" min="1" max="12" style="width: 55px; text-align: center; padding: .4rem .2rem;">
                  <span style="font-size: .9rem; color: #666;">월</span>
                  <input type="number" id="meditation-day-num" min="1" max="31" style="width: 55px; text-align: center; padding: .4rem .2rem;">
                  <span style="font-size: .9rem; color: #666;">일</span>
                  <span id="meditation-day" style="font-size: .9rem; color: #667eea; font-weight: 600; margin-left: .3rem;">(수)</span>
                </div>
              </div>
              <div style="flex: 1; min-width: 120px;">
                <label style="font-size: .8rem; color: #666; display: block; margin-bottom: .3rem;">성경구절</label>
                <input type="text" id="meditation-ref" placeholder="예) 레위기 1:3" style="width: 100%;">
              </div>
              <div style="flex: 1; min-width: 150px;">
                <label style="font-size: .8rem; color: #666; display: block; margin-bottom: .3rem;">보내는 사람 <span style="color: #999;">(선택)</span></label>
                <input type="text" id="meditation-sender" placeholder="예) 초대교회, 홍길동 목사" style="width: 100%;">
              </div>
            </div>

            <!-- 두 번째 줄: 본문말씀 + 버튼 -->
            <div style="display: flex; gap: .5rem; align-items: flex-end;">
              <div style="flex: 1;">
                <label style="font-size: .8rem; color: #666; display: block; margin-bottom: .3rem;">본문말씀</label>
                <textarea id="meditation-verse" placeholder="예) 그 예물이 소의 번제이면 흠 없는 수컷으로 회막 문에서 여호와 앞에 기쁘게 받으시도록 드릴지니라" style="width: 100%; min-height: 70px; resize: vertical;"></textarea>
              </div>
              <button id="btn-create-meditation" class="primary" style="white-space: nowrap; padding: .6rem 1.2rem; height: fit-content;">메시지 제작</button>
            </div>
          </div>

          <!-- 샘플 템플릿 + 결과 영역 -->
          <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
            <!-- 왼쪽: 샘플 템플릿 -->
            <div style="flex: 1; min-width: 280px;">
              <div class="box" style="background: #fff; border: 1px solid #ddd; height: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                  <div class="label" style="margin: 0; font-size: .9rem;">📝 샘플 템플릿 <span style="font-weight: normal; color: #999; font-size: .75rem;">(선택)</span></div>
                  <button id="btn-reset-template" style="font-size: .7rem; padding: .2rem .5rem; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">초기화</button>
                </div>
                <div style="font-size: .75rem; color: #888; margin-bottom: .5rem;">템플릿을 입력하면 해당 양식으로 메시지가 생성됩니다. 비워두면 기본 양식이 적용됩니다.</div>
                <textarea id="meditation-template" placeholder="샘플 메시지를 붙여넣으세요. 비워두면 기본 양식으로 생성됩니다." style="width: 100%; min-height: 250px; resize: vertical; font-size: .85rem; line-height: 1.5;"></textarea>
              </div>
            </div>

            <!-- 오른쪽: 생성된 메시지 -->
            <div style="flex: 1; min-width: 280px;">
              <div id="meditation-result-container" class="box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; height: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                  <div class="label" style="margin: 0; color: white; font-size: .9rem;">📱 묵상메시지</div>
                  <button id="btn-copy-meditation" style="background: white; color: #667eea; border: none; padding: .3rem .6rem; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: .8rem;">📋 복사</button>
                </div>
                <textarea id="meditation-result" readonly placeholder="메시지 제작 버튼을 클릭하면 여기에 결과가 표시됩니다." style="width: 100%; min-height: 250px; padding: .75rem; border-radius: 6px; border: none; font-size: .85rem; line-height: 1.6; resize: vertical;"></textarea>
              </div>
            </div>
          </div>
        </div>
        <!-- // 묵상메시지 콘텐츠 끝 -->

        <!-- 성경 배경지식 콘텐츠 -->
        <div id="bible-knowledge-content" style="display: none;">
          <div class="box" style="text-align: center; padding: 3rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">📚</div>
            <div style="font-size: 1.1rem; color: #666;">성경 배경지식 기능 준비 중입니다.</div>
            <div style="font-size: .85rem; color: #999; margin-top: .5rem;">곧 업데이트될 예정입니다.</div>
          </div>
        </div>
        <!-- // 성경 배경지식 콘텐츠 끝 -->

        <!-- 빈 페이지 콘텐츠 (새 카테고리용) -->
        <div id="empty-content" style="display: none;">
          <div class="box" style="text-align: center; padding: 3rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">📝</div>
            <div style="font-size: 1.1rem; color: #666;">새 카테고리입니다.</div>
            <div style="font-size: .85rem; color: #999; margin-top: .5rem;">곧 콘텐츠가 추가될 예정입니다.</div>
          </div>
        </div>
        <!-- // 빈 페이지 콘텐츠 끝 -->

        <!-- 디자인 도우미 콘텐츠 -->
        <div id="design-helper-content" style="display: none;">
          <!-- 안내 박스 -->
          <div class="box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; margin-bottom: 1rem;">
            <div style="color: white; font-size: 1.1rem; font-weight: 700; margin-bottom: .5rem;">🎨 현수막/배너 AI 생성기</div>
            <div style="color: rgba(255,255,255,0.9); font-size: .85rem; line-height: 1.5;">
              행사 정보를 입력하면 AI가 교회 현수막/배너용 배경 이미지를 자동으로 생성합니다.<br>
              생성된 이미지에 텍스트를 추가하여 완성된 현수막을 만드세요.
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <!-- 왼쪽: 입력 폼 -->
            <div>
              <!-- AI 모델 선택 -->
              <div class="box" style="margin-bottom: 1rem;">
                <div class="label" style="margin-bottom: .5rem;">🤖 AI 모델 선택</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: .5rem;">
                  <label style="display: flex; align-items: center; padding: .75rem; background: #f8f9fa; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" id="model-dalle3-label">
                    <input type="radio" name="banner-model" value="dalle3" checked style="margin-right: .5rem;">
                    <div>
                      <div style="font-weight: 600; font-size: .9rem;">DALL-E 3</div>
                      <div style="font-size: .75rem; color: #888;">텍스트 렌더링 우수</div>
                    </div>
                  </label>
                  <label style="display: flex; align-items: center; padding: .75rem; background: #f8f9fa; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" id="model-flux-label">
                    <input type="radio" name="banner-model" value="flux_pro" style="margin-right: .5rem;">
                    <div>
                      <div style="font-weight: 600; font-size: .9rem;">Flux Pro</div>
                      <div style="font-size: .75rem; color: #888;">포토리얼리즘</div>
                    </div>
                  </label>
                </div>
              </div>

              <!-- 템플릿 선택 -->
              <div class="box" style="margin-bottom: 1rem;">
                <div class="label" style="margin-bottom: .5rem;">📋 행사 유형 선택</div>
                <select id="banner-template" style="width: 100%; padding: .5rem; border-radius: 6px; border: 1px solid #ddd;">
                  <option value="general">일반</option>
                  <option value="revival">부흥회</option>
                  <option value="christmas">성탄절</option>
                  <option value="easter">부활절</option>
                  <option value="thanksgiving">추수감사절</option>
                  <option value="new_year">신년/송년</option>
                  <option value="special_service">특별집회</option>
                  <option value="bible_school">성경학교/여름캠프</option>
                  <option value="baptism">세례/침례</option>
                  <option value="ordination">임직/취임</option>
                  <option value="mission">선교/전도</option>
                </select>
              </div>

              <!-- 크기 설정 -->
              <div class="box" style="margin-bottom: 1rem;">
                <div class="label" style="margin-bottom: .5rem;">📐 크기 설정 (cm)</div>
                <div style="display: flex; flex-direction: column; gap: .75rem;">
                  <!-- 프리셋 선택 -->
                  <div style="display: flex; flex-wrap: wrap; gap: .4rem;">
                    <button type="button" class="size-preset active" data-width="500" data-height="90" style="padding: .4rem .8rem; border: 1px solid #667eea; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-size: .8rem;">현수막 (500x90)</button>
                    <button type="button" class="size-preset" data-width="300" data-height="90" style="padding: .4rem .8rem; border: 1px solid #ddd; background: #f8f9fa; border-radius: 6px; cursor: pointer; font-size: .8rem;">현수막 (300x90)</button>
                    <button type="button" class="size-preset" data-width="60" data-height="180" style="padding: .4rem .8rem; border: 1px solid #ddd; background: #f8f9fa; border-radius: 6px; cursor: pointer; font-size: .8rem;">X배너 (60x180)</button>
                    <button type="button" class="size-preset" data-width="80" data-height="200" style="padding: .4rem .8rem; border: 1px solid #ddd; background: #f8f9fa; border-radius: 6px; cursor: pointer; font-size: .8rem;">롤배너 (80x200)</button>
                    <button type="button" class="size-preset" data-width="100" data-height="100" style="padding: .4rem .8rem; border: 1px solid #ddd; background: #f8f9fa; border-radius: 6px; cursor: pointer; font-size: .8rem;">정사각형 (100x100)</button>
                  </div>
                  <!-- 직접 입력 -->
                  <div style="display: flex; align-items: center; gap: .5rem;">
                    <input type="number" id="banner-width" value="500" min="10" max="1000" style="width: 80px; padding: .4rem; border-radius: 6px; border: 1px solid #ddd; text-align: center;">
                    <span style="color: #666;">x</span>
                    <input type="number" id="banner-height" value="90" min="10" max="1000" style="width: 80px; padding: .4rem; border-radius: 6px; border: 1px solid #ddd; text-align: center;">
                    <span style="color: #666; font-size: .85rem;">cm</span>
                    <div id="banner-size-preview" style="flex: 1; text-align: right; font-size: .8rem; color: #888;">비율: 5.56:1 (가로형)</div>
                  </div>
                </div>
              </div>

              <!-- 행사 정보 입력 -->
              <div class="box" style="margin-bottom: 1rem;">
                <div class="label" style="margin-bottom: .5rem;">✏️ 행사 정보 (선택)</div>
                <div style="display: flex; flex-direction: column; gap: .5rem;">
                  <input type="text" id="banner-event-name" placeholder="행사명 (예: 2024 가을 부흥회)" style="padding: .5rem; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="text" id="banner-church-name" placeholder="교회명 (예: 소망교회)" style="padding: .5rem; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="text" id="banner-schedule" placeholder="일정 (예: 11/25~27 저녁 7시)" style="padding: .5rem; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="text" id="banner-speaker" placeholder="강사 (예: 홍길동 목사)" style="padding: .5rem; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="text" id="banner-theme" placeholder="주제/말씀 (예: 새 힘을 얻으리니 사40:31)" style="padding: .5rem; border-radius: 6px; border: 1px solid #ddd;">
                </div>
              </div>

              <!-- 텍스트 오버레이 옵션 -->
              <div class="box" style="margin-bottom: 1rem; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #22c55e;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                  <div class="label" style="margin: 0; color: #15803d;">✨ 한글 텍스트 자동 삽입</div>
                  <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="banner-add-text" checked style="width: 18px; height: 18px; margin-right: .5rem;">
                    <span style="font-size: .85rem; color: #166534; font-weight: 600;">활성화</span>
                  </label>
                </div>
                <div id="text-overlay-options">
                  <div style="font-size: .8rem; color: #166534; margin-bottom: .5rem;">위에 입력한 행사 정보가 이미지에 자동으로 추가됩니다.</div>
                  <div style="display: flex; gap: .5rem; align-items: center;">
                    <label style="font-size: .85rem; color: #15803d; font-weight: 500;">폰트:</label>
                    <select id="banner-font" style="flex: 1; padding: .4rem; border-radius: 6px; border: 1px solid #86efac; background: white;">
                      <option value="nanum_gothic">나눔고딕</option>
                      <option value="nanum_barun">나눔바른고딕</option>
                      <option value="nanum_myeongjo">나눔명조</option>
                      <option value="nanum_square">나눔스퀘어</option>
                      <option value="nanum_square_round">나눔스퀘어라운드</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- 고급 옵션 -->
              <div class="box" style="margin-bottom: 1rem;">
                <div class="toggle-header" style="cursor: pointer;" onclick="toggleAdvancedOptions()">
                  <div class="label" style="margin: 0;">⚙️ 고급 옵션</div>
                  <span id="advanced-options-arrow" style="transition: transform 0.2s;">▼</span>
                </div>
                <div id="advanced-options" style="display: none; margin-top: .75rem;">
                  <div style="font-size: .8rem; color: #666; margin-bottom: .5rem;">직접 프롬프트를 입력하거나 AI가 생성한 프롬프트를 수정할 수 있습니다.</div>
                  <textarea id="banner-custom-prompt" placeholder="AI 이미지 생성 프롬프트를 직접 입력하세요 (영어 권장)" style="width: 100%; min-height: 100px; padding: .5rem; border-radius: 6px; border: 1px solid #ddd; font-size: .85rem; resize: vertical;"></textarea>
                  <button onclick="generateBannerPrompt()" style="margin-top: .5rem; width: 100%; padding: .5rem; background: #f0f0f0; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">🤖 AI로 프롬프트 생성</button>
                </div>
              </div>

              <!-- 생성 버튼 -->
              <button id="btn-generate-banner" onclick="generateBanner()" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s;">
                🎨 배경 이미지 생성
              </button>
              <div id="banner-loading" style="display: none; text-align: center; margin-top: 1rem; color: #666;">
                <div style="font-size: 2rem; margin-bottom: .5rem;">⏳</div>
                <div>이미지를 생성하고 있습니다...</div>
                <div style="font-size: .85rem; color: #888;">30초~1분 정도 소요될 수 있습니다.</div>
              </div>
            </div>

            <!-- 오른쪽: 결과 표시 -->
            <div>
              <div class="box" style="height: 100%; min-height: 500px; display: flex; flex-direction: column;">
                <div class="label" style="margin-bottom: .5rem;">🖼️ 생성된 이미지</div>
                <div id="banner-result-container" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px; padding: 1rem;">
                  <div id="banner-placeholder" style="text-align: center; color: #888;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">🖼️</div>
                    <div>왼쪽에서 설정을 선택하고<br>"배경 이미지 생성" 버튼을 클릭하세요.</div>
                  </div>
                  <div id="banner-result" style="display: none; width: 100%;">
                    <img id="banner-image" src="" alt="생성된 배너 이미지" style="width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <div style="margin-top: 1rem; display: flex; gap: .5rem;">
                      <a id="banner-download-link" href="" download="banner.png" style="flex: 1; padding: .75rem; background: #667eea; color: white; text-align: center; border-radius: 6px; text-decoration: none; font-weight: 600;">📥 다운로드</a>
                      <button onclick="regenerateBanner()" style="flex: 1; padding: .75rem; background: #f0f0f0; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-weight: 600;">🔄 다시 생성</button>
                    </div>
                    <div id="banner-info" style="margin-top: 1rem; padding: .75rem; background: #e8f4fd; border-radius: 6px; font-size: .8rem;">
                      <div><strong>모델:</strong> <span id="banner-info-model">-</span></div>
                      <div><strong>템플릿:</strong> <span id="banner-info-template">-</span></div>
                      <div><strong>크기:</strong> <span id="banner-info-layout">-</span></div>
                      <div><strong>텍스트:</strong> <span id="banner-info-text">-</span></div>
                      <div><strong>폰트:</strong> <span id="banner-info-font">-</span></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 사용 팁 -->
          <div class="box" style="margin-top: 1rem; background: #fffbeb; border: 1px solid #f59e0b;">
            <div style="font-weight: 600; color: #b45309; margin-bottom: .5rem;">💡 사용 팁</div>
            <ul style="margin: 0; padding-left: 1.2rem; font-size: .85rem; color: #78350f; line-height: 1.6;">
              <li><strong>한글 텍스트 자동 삽입</strong>을 활성화하면 행사 정보가 이미지에 자동으로 추가됩니다.</li>
              <li><strong>DALL-E 3</strong>은 $0.04~0.08/장, <strong>Flux Pro</strong>는 $0.025/megapixel (fal.ai)입니다.</li>
              <li>원하는 결과가 나오지 않으면 "다시 생성"을 눌러 새로운 이미지를 받아보세요.</li>
              <li>Flux Pro 사용 시 <strong>FAL_KEY</strong> 환경변수 설정이 필요합니다. (<a href="https://fal.ai" target="_blank" style="color: #b45309;">fal.ai</a>에서 발급)</li>
            </ul>
          </div>

          <!-- 참조 이미지 학습 -->
          <div class="box" style="margin-top: 1rem; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0ea5e9;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .75rem;">
              <div style="font-weight: 700; color: #0369a1; font-size: 1rem;">📚 참조 이미지 학습</div>
              <span id="ref-count-badge" style="background: #0ea5e9; color: white; padding: .2rem .6rem; border-radius: 12px; font-size: .75rem;">0개</span>
            </div>
            <div style="font-size: .85rem; color: #0c4a6e; margin-bottom: 1rem; line-height: 1.5;">
              좋은 현수막 이미지 URL을 등록하면 AI가 스타일을 학습하여 더 나은 결과물을 생성합니다.<br>
              데이터가 쌓일수록 품질이 향상됩니다.
            </div>

            <!-- 참조 이미지 추가 폼 -->
            <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
              <div style="font-weight: 600; color: #0369a1; margin-bottom: .75rem; font-size: .9rem;">➕ 참조 이미지 추가</div>
              <div style="display: flex; flex-direction: column; gap: .5rem;">
                <input type="text" id="ref-image-url" placeholder="이미지 URL (https://...)" style="padding: .5rem; border-radius: 6px; border: 1px solid #7dd3fc;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: .5rem;">
                  <select id="ref-template-type" style="padding: .5rem; border-radius: 6px; border: 1px solid #7dd3fc;">
                    <option value="general">일반</option>
                    <option value="revival">부흥회</option>
                    <option value="christmas">성탄절</option>
                    <option value="easter">부활절</option>
                    <option value="thanksgiving">추수감사절</option>
                    <option value="new_year">신년/송년</option>
                    <option value="special_service">특별집회</option>
                    <option value="bible_school">성경학교</option>
                    <option value="baptism">세례/침례</option>
                    <option value="ordination">임직/취임</option>
                    <option value="mission">선교/전도</option>
                  </select>
                  <input type="text" id="ref-style-tags" placeholder="스타일 태그 (예: 모던,그라데이션,미니멀)" style="padding: .5rem; border-radius: 6px; border: 1px solid #7dd3fc;">
                </div>
                <input type="text" id="ref-description" placeholder="설명 (선택, 예: 파란 그라데이션 배경, 깔끔한 레이아웃)" style="padding: .5rem; border-radius: 6px; border: 1px solid #7dd3fc;">
                <div style="display: flex; gap: .5rem;">
                  <button onclick="addReferenceImage()" style="flex: 1; padding: .6rem; background: #0ea5e9; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    📥 참조 이미지 추가
                  </button>
                  <button onclick="previewReferenceImage()" style="padding: .6rem 1rem; background: #f0f9ff; border: 1px solid #7dd3fc; border-radius: 6px; cursor: pointer;">
                    👁️ 미리보기
                  </button>
                </div>
              </div>
              <!-- 미리보기 영역 -->
              <div id="ref-preview-container" style="display: none; margin-top: .75rem;">
                <img id="ref-preview-image" src="" style="max-width: 100%; max-height: 150px; border-radius: 6px; border: 1px solid #ddd;">
              </div>
            </div>

            <!-- 웹사이트 일괄 크롤링 -->
            <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #f59e0b;">
              <div style="font-weight: 600; color: #b45309; margin-bottom: .75rem; font-size: .9rem;">🔍 웹사이트에서 일괄 수집</div>
              <div style="font-size: .8rem; color: #92400e; margin-bottom: .75rem;">현수막 업체 포트폴리오 페이지 URL을 입력하면 이미지를 자동으로 수집합니다.</div>
              <div style="display: flex; gap: .5rem; margin-bottom: .5rem;">
                <input type="text" id="crawl-url" placeholder="웹사이트 URL (예: https://현수막업체.com/portfolio)" style="flex: 1; padding: .5rem; border-radius: 6px; border: 1px solid #fbbf24;">
                <button onclick="crawlImages()" id="btn-crawl" style="padding: .5rem 1rem; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                  🔍 수집
                </button>
              </div>
              <!-- 크롤링 결과 -->
              <div id="crawl-result" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin: .75rem 0 .5rem;">
                  <span id="crawl-count" style="font-size: .85rem; color: #92400e; font-weight: 600;">0개 이미지 발견</span>
                  <div style="display: flex; gap: .5rem;">
                    <button onclick="selectAllCrawled(true)" style="padding: .3rem .6rem; background: white; border: 1px solid #fbbf24; border-radius: 4px; cursor: pointer; font-size: .75rem;">전체 선택</button>
                    <button onclick="selectAllCrawled(false)" style="padding: .3rem .6rem; background: white; border: 1px solid #fbbf24; border-radius: 4px; cursor: pointer; font-size: .75rem;">전체 해제</button>
                  </div>
                </div>
                <div id="crawl-images" style="max-height: 250px; overflow-y: auto; background: white; border-radius: 6px; padding: .5rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: .5rem;">
                </div>
                <div style="display: flex; gap: .5rem; margin-top: .75rem;">
                  <select id="crawl-template-type" style="flex: 1; padding: .5rem; border-radius: 6px; border: 1px solid #fbbf24;">
                    <option value="general">행사 유형: 일반</option>
                    <option value="revival">부흥회</option>
                    <option value="christmas">성탄절</option>
                    <option value="easter">부활절</option>
                    <option value="thanksgiving">추수감사절</option>
                    <option value="new_year">신년/송년</option>
                    <option value="special_service">특별집회</option>
                    <option value="bible_school">성경학교</option>
                    <option value="baptism">세례/침례</option>
                    <option value="ordination">임직/취임</option>
                    <option value="mission">선교/전도</option>
                  </select>
                  <input type="text" id="crawl-style-tags" placeholder="스타일 태그" style="flex: 1; padding: .5rem; border-radius: 6px; border: 1px solid #fbbf24;">
                </div>
                <button onclick="bulkAddCrawledImages()" id="btn-bulk-add" style="width: 100%; margin-top: .5rem; padding: .6rem; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                  📥 선택한 이미지 일괄 등록
                </button>
              </div>
              <!-- 로딩 표시 -->
              <div id="crawl-loading" style="display: none; text-align: center; padding: 1rem; color: #92400e;">
                <div style="font-size: 1.5rem; margin-bottom: .5rem;">⏳</div>
                <div>이미지를 수집하고 있습니다...</div>
              </div>
            </div>

            <!-- 등록된 참조 이미지 목록 -->
            <div>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                <div style="font-weight: 600; color: #0369a1; font-size: .9rem;">📋 등록된 참조 이미지</div>
                <button onclick="loadReferenceImages()" style="padding: .3rem .6rem; background: #f0f9ff; border: 1px solid #7dd3fc; border-radius: 4px; cursor: pointer; font-size: .75rem;">
                  🔄 새로고침
                </button>
              </div>
              <div id="ref-images-list" style="max-height: 300px; overflow-y: auto; background: white; border-radius: 8px; padding: .5rem;">
                <div style="text-align: center; color: #888; padding: 2rem; font-size: .85rem;">
                  등록된 참조 이미지가 없습니다.<br>
                  좋은 현수막 이미지 URL을 추가해주세요.
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- // 디자인 도우미 콘텐츠 끝 -->
      </div>
    </div>

    <!-- 오른쪽 -->
    <div class="right-col">
      <div class="chat-panel">
        <div class="qa-interface">
          <div class="qa-prompt">검색된 결과에 대해 간단한 질문을 해주세요.</div>
          <div class="qa-history" id="qa-history">
            <div class="qa-empty-state">아직 질문이 없습니다.<br>처리 단계 결과나 본문에 대해 궁금한 점을 물어보세요.</div>
          </div>
          <div class="qa-input-area">
            <textarea id="qa-input" placeholder="질문을 입력하세요. (분석된 내용에 대해서 질문 하시면, 추가 답변을 드립니다.)"></textarea>
            <button id="btn-send-qa" class="primary">전송</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- 패스워드 모달 -->
  <div id="modal-password" class="modal">
    <div class="modal-content">
      <div class="modal-title">🔒 관리자 공간 잠금</div>
      <p style="color: #666; font-size: .9rem; margin-bottom: 1rem;">관리자 공간에 접근하려면 패스워드를 입력하세요.</p>
      <input type="password" id="password-input" placeholder="패스워드 입력" style="margin-bottom: .5rem;">
      <div class="modal-buttons">
        <button id="btn-cancel-password">취소</button>
        <button id="btn-submit-password" class="primary">확인</button>
      </div>
    </div>
  </div>

  <!-- 관리자 공간 모달 -->
  <div id="modal-admin-panel" class="modal">
    <div class="modal-content" style="max-width: 900px; min-height: 80vh; max-height: 95vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div class="modal-title" style="margin: 0;">🔒 관리자 공간</div>
        <div style="display: flex; gap: .5rem; align-items: center;">
          <button id="btn-sermon-chatbot" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: .5rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: .85rem;">🤖 AI 도우미</button>
          <button id="btn-close-admin-panel" style="background: transparent; border: none; font-size: 1.5rem; cursor: pointer; padding: 0; color: #999;">&times;</button>
        </div>
      </div>

      <div id="guide-content">
        <!-- AI 모델 설정 (제일 위로) -->
        <div style="margin-bottom: 1.5rem;">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: .6rem 1rem; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 1rem;">🤖 AI 모델 설정</div>
          <div style="background: #f8f5ff; padding: 1rem; border-radius: 0 0 8px 8px; border: 2px solid #667eea; border-top: none;">
            <div style="font-size: .85rem; color: #666; margin-bottom: 1rem;">
              각 단계에서 사용할 AI 모델을 선택하세요. 비용 차이는 기준 모델 대비 %입니다.
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
              <!-- Step1 모델 -->
              <div style="background: white; padding: .75rem; border-radius: 8px; border: 2px solid #ff6b6b;">
                <label style="font-weight: 700; font-size: .9rem; color: #ff6b6b; display: block; margin-bottom: .4rem;">Step1 (본문 연구)</label>
                <select id="model-step1" style="width: 100%; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem;">
                  <option value="gpt-4o">GPT-4o (기준)</option>
                  <option value="gpt-4o-mini">GPT-4o Mini (-94% 저렴)</option>
                  <option value="gpt-5">GPT-5 (+100%)</option>
                  <option value="gpt-5.1">GPT-5.1 (+200%)</option>
                </select>
                <div style="font-size: .7rem; color: #999; margin-top: .3rem;">기준: GPT-4o</div>
              </div>
              <!-- Step2 모델 -->
              <div style="background: white; padding: .75rem; border-radius: 8px; border: 2px solid #4ecdc4;">
                <label style="font-weight: 700; font-size: .9rem; color: #4ecdc4; display: block; margin-bottom: .4rem;">Step2 (설교 구조)</label>
                <select id="model-step2" style="width: 100%; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem;">
                  <option value="gpt-4o">GPT-4o (기준)</option>
                  <option value="gpt-4o-mini">GPT-4o Mini (-94% 저렴)</option>
                  <option value="gpt-5">GPT-5 (+100%)</option>
                  <option value="gpt-5.1">GPT-5.1 (+200%)</option>
                </select>
                <div style="font-size: .7rem; color: #999; margin-top: .3rem;">기준: GPT-4o</div>
              </div>
              <!-- Step3 (설교문 작성) 모델 -->
              <div style="background: white; padding: .75rem; border-radius: 8px; border: 2px solid #f5576c;">
                <label style="font-weight: 700; font-size: .9rem; color: #f5576c; display: block; margin-bottom: .4rem;">Step3 (설교문 작성)</label>
                <select id="model-gpt-pro" style="width: 100%; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem;">
                  <option value="gpt-5">GPT-5 (기준)</option>
                  <option value="gpt-4o">GPT-4o (-50% 저렴)</option>
                  <option value="gpt-5.1">GPT-5.1 (+50%)</option>
                </select>
                <div style="font-size: .7rem; color: #999; margin-top: .3rem;">기준: GPT-5</div>
              </div>
            </div>
            <!-- Step3 토큰량 설정 -->
            <div style="background: white; padding: .75rem; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: .5rem;">
              <label style="font-weight: 600; font-size: .85rem; color: #f5576c; display: block; margin-bottom: .4rem;">Step3 기본 토큰량</label>
              <div style="display: flex; gap: .5rem; align-items: center;">
                <input type="number" id="step3-max-tokens" value="16000" min="1000" max="32000" step="1000" style="width: 120px; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem;">
                <span style="font-size: .8rem; color: #666;">토큰 (기본: 16000, 최대: 32000)</span>
              </div>
            </div>
            <!-- 스타일별 토큰 설정 (접기/펼치기) -->
            <div style="background: white; padding: .75rem; border-radius: 8px; border: 1px solid #e0e0e0;">
              <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleStyleTokens()">
                <label style="font-weight: 600; font-size: .85rem; color: #f5576c;">📊 스타일별 토큰 설정</label>
                <span id="style-tokens-toggle" style="font-size: .8rem; color: #999;">▼ 펼치기</span>
              </div>
              <div id="style-tokens-container" style="display: none; margin-top: .75rem; max-height: 300px; overflow-y: auto;">
                <div style="font-size: .75rem; color: #888; margin-bottom: .5rem;">각 설교 스타일별로 Step3 토큰량을 개별 설정할 수 있습니다. 비워두면 기본값 사용.</div>
                <div id="style-tokens-list">
                  <!-- 동적으로 생성됨 -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- JSON 디버그 패널 -->
        <div style="margin-bottom: 1.5rem;">
          <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: .6rem 1rem; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 1rem; display: flex; justify-content: space-between; align-items: center;">
            <span>🔍 JSON 지침 디버그</span>
            <button id="btn-refresh-json-debug" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: .3rem .6rem; border-radius: 4px; cursor: pointer; font-size: .8rem;">새로고침</button>
          </div>
          <div style="background: #f0fff4; padding: 1rem; border-radius: 0 0 8px 8px; border: 2px solid #38ef7d; border-top: none;">
            <div id="json-debug-content">
              <div style="font-size: .85rem; color: #666; margin-bottom: .5rem;">현재 선택된 단계의 지침을 분석합니다.</div>

              <!-- 상태 표시 -->
              <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <div style="background: white; padding: .5rem .75rem; border-radius: 6px; border: 1px solid #ddd;">
                  <span style="font-size: .75rem; color: #888;">형식:</span>
                  <span id="json-debug-format" style="font-weight: 700; margin-left: .3rem;">-</span>
                </div>
                <div style="background: white; padding: .5rem .75rem; border-radius: 6px; border: 1px solid #ddd;">
                  <span style="font-size: .75rem; color: #888;">스타일:</span>
                  <span id="json-debug-style" style="font-weight: 700; margin-left: .3rem;">-</span>
                </div>
                <div style="background: white; padding: .5rem .75rem; border-radius: 6px; border: 1px solid #ddd;">
                  <span style="font-size: .75rem; color: #888;">역할:</span>
                  <span id="json-debug-role" style="font-weight: 700; margin-left: .3rem;">-</span>
                </div>
              </div>

              <!-- output_format 필드 목록 -->
              <div style="margin-bottom: 1rem;">
                <div style="font-weight: 600; font-size: .85rem; margin-bottom: .5rem; color: #333;">📋 출력 필드 (output_format)</div>
                <div id="json-debug-fields" style="background: white; padding: .75rem; border-radius: 6px; border: 1px solid #ddd; max-height: 150px; overflow-y: auto; font-size: .8rem; font-family: monospace;">
                  <span style="color: #999;">지침을 선택하세요</span>
                </div>
              </div>

              <!-- writing_spec (Step2용) -->
              <div style="margin-bottom: 1rem;">
                <div style="font-weight: 600; font-size: .85rem; margin-bottom: .5rem; color: #333;">⚙️ 작성 규격 (writing_spec)</div>
                <div id="json-debug-writing-spec" style="background: white; padding: .75rem; border-radius: 6px; border: 1px solid #ddd; font-size: .8rem;">
                  <span style="color: #999;">Step2 지침에만 표시됩니다</span>
                </div>
              </div>

              <!-- 생성될 프롬프트 미리보기 -->
              <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                  <div style="font-weight: 600; font-size: .85rem; color: #333;">💬 생성될 프롬프트 미리보기</div>
                  <button id="btn-copy-prompt-preview" style="font-size: .75rem; padding: .2rem .5rem; cursor: pointer;">복사</button>
                </div>
                <textarea id="json-debug-prompt" readonly style="width: 100%; height: 120px; font-size: .75rem; font-family: monospace; background: #1a1a2e; color: #16c79a; padding: .75rem; border-radius: 6px; border: none; resize: vertical;"></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Step3/Step4 프롬프트 비교 -->
        <div style="margin-bottom: 1.5rem;">
          <div style="background: linear-gradient(135deg, #f5576c 0%, #667eea 100%); color: white; padding: .6rem 1rem; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 1rem; display: flex; justify-content: space-between; align-items: center;">
            <span>📊 Step3 vs Step4 프롬프트 비교</span>
            <button id="btn-refresh-step-compare" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: .3rem .6rem; border-radius: 4px; cursor: pointer; font-size: .8rem;">🔄 새로고침</button>
          </div>
          <div style="background: #fef5ff; padding: 1rem; border-radius: 0 0 8px 8px; border: 2px solid #667eea; border-top: none;">
            <div style="font-size: .85rem; color: #666; margin-bottom: .75rem;">
              <strong>Step3</strong> (🔴 분홍색 버튼): 서버에서 GPT API 직접 호출 &nbsp;|&nbsp;
              <strong>Step4</strong> (🟣 보라색 버튼): 프롬프트 복사 → 개인 GPT에 붙여넣기
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <!-- Step3 프롬프트 -->
              <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                  <div style="font-weight: 700; font-size: .9rem; color: #f5576c;">🔴 Step3 (서버 호출)</div>
                  <button onclick="copyStepPrompt('step3')" style="font-size: .7rem; padding: .2rem .4rem; cursor: pointer;">복사</button>
                </div>
                <textarea id="step3-prompt-preview" readonly style="width: 100%; height: 300px; font-size: .75rem; font-family: monospace; background: #1a1a2e; color: #ff6b9d; padding: .75rem; border-radius: 6px; border: none; resize: vertical;"></textarea>
                <div id="step3-prompt-stats" style="font-size: .7rem; color: #888; margin-top: .3rem;">글자수: -</div>
              </div>
              <!-- Step4 프롬프트 -->
              <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                  <div style="font-weight: 700; font-size: .9rem; color: #667eea;">🟣 Step4 (전체 복사)</div>
                  <button onclick="copyStepPrompt('step4')" style="font-size: .7rem; padding: .2rem .4rem; cursor: pointer;">복사</button>
                </div>
                <textarea id="step4-prompt-preview" readonly style="width: 100%; height: 300px; font-size: .75rem; font-family: monospace; background: #1a1a2e; color: #9d6bff; padding: .75rem; border-radius: 6px; border: none; resize: vertical;"></textarea>
                <div id="step4-prompt-stats" style="font-size: .7rem; color: #888; margin-top: .3rem;">글자수: -</div>
              </div>
            </div>
            <!-- 차이점 요약 -->
            <div style="margin-top: 1rem; background: white; padding: .75rem; border-radius: 6px; border: 1px solid #ddd;">
              <div style="font-weight: 600; font-size: .85rem; margin-bottom: .5rem;">📌 현재 상태</div>
              <div id="step-compare-summary" style="font-size: .8rem; color: #666;">
                현재 Step3과 Step4는 <strong>동일한 프롬프트</strong>를 사용합니다.<br>
                추후 Step3에 고급 기능(RAG, 예시 설교 참조 등)을 추가하여 차별화할 예정입니다.
              </div>
            </div>
          </div>
        </div>

        <!-- 처리 단계 지침 -->
        <div style="margin-bottom: 1.5rem;">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: .6rem 1rem; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 1rem;">📋 처리 단계 지침</div>
          <div style="background: #f8f5ff; padding: 1rem; border-radius: 0 0 8px 8px; border: 2px solid #667eea; border-top: none;">
            <!-- 설교 스타일 선택 -->
            <div style="margin-bottom: .75rem;">
              <label style="font-size: .85rem; color: #666; font-weight: 600; display: block; margin-bottom: .3rem;">설교 스타일 선택</label>
              <select id="admin-style-select" style="width: 100%; padding: .5rem; border-radius: 6px; border: 1px solid #ddd; font-size: .9rem; background: white;">
                <option value="">-- 스타일을 선택하세요 --</option>
              </select>
            </div>
            <div class="btn-row" style="margin-bottom: .5rem;">
              <button id="save-guide" class="primary">지침 저장</button>
            </div>
            <div id="guide-tabs" class="btn-row" style="margin-bottom: .5rem;"></div>
            <div id="current-guide-info" style="font-size: .85rem; color: #666; margin-bottom: .5rem;"></div>
            <textarea id="guide-text" class="autosize" style="min-height: 120px;" placeholder="이 처리 단계의 구체적인 지침을 작성하세요."></textarea>
          </div>
        </div>

        <!-- Step3 사용 코드 관리 -->
        <div style="margin-bottom: 1.5rem;">
          <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: .6rem 1rem; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 1rem;">🔑 Step3 사용 코드 관리</div>
          <div style="background: #fffbf0; padding: 1rem; border-radius: 0 0 8px 8px; border: 2px solid #f39c12; border-top: none;">
            <div style="font-size: .85rem; color: #666; margin-bottom: 1rem;">
              테스터에게 배포할 1회용 코드를 생성하고 관리합니다. 코드당 사용 횟수를 지정할 수 있습니다.
            </div>
            <!-- 새 코드 생성 -->
            <div style="background: white; padding: .75rem; border-radius: 8px; border: 1px solid #ffe0b2; margin-bottom: 1rem;">
              <div style="font-weight: 600; font-size: .9rem; color: #e67e22; margin-bottom: .5rem;">새 코드 생성</div>
              <div style="display: flex; gap: .5rem; align-items: center; flex-wrap: wrap;">
                <input type="text" id="new-code-name" placeholder="코드명 (비우면 자동생성)" style="flex: 1; min-width: 150px; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem;">
                <div style="display: flex; align-items: center; gap: .3rem;">
                  <label style="font-size: .85rem; color: #666;">횟수:</label>
                  <input type="number" id="new-code-limit" value="3" min="1" max="100" style="width: 60px; padding: .4rem; border-radius: 4px; border: 1px solid #ddd; font-size: .85rem; text-align: center;">
                </div>
                <button id="btn-create-code" style="padding: .4rem .8rem; background: #f39c12; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: .85rem; font-weight: 600;">생성</button>
              </div>
            </div>
            <!-- 코드 목록 -->
            <div style="font-weight: 600; font-size: .9rem; color: #e67e22; margin-bottom: .5rem;">코드 목록</div>
            <div id="code-list-container" style="max-height: 200px; overflow-y: auto; background: white; border-radius: 8px; border: 1px solid #ffe0b2;">
              <table style="width: 100%; border-collapse: collapse; font-size: .85rem;">
                <thead>
                  <tr style="background: #fff8e1; position: sticky; top: 0;">
                    <th style="padding: .5rem; text-align: left; border-bottom: 1px solid #ffe0b2;">코드</th>
                    <th style="padding: .5rem; text-align: center; border-bottom: 1px solid #ffe0b2;">남은횟수</th>
                    <th style="padding: .5rem; text-align: center; border-bottom: 1px solid #ffe0b2;">상태</th>
                    <th style="padding: .5rem; text-align: center; border-bottom: 1px solid #ffe0b2;">관리</th>
                  </tr>
                </thead>
                <tbody id="code-list-body">
                  <tr><td colspan="4" style="padding: 1rem; text-align: center; color: #999;">로딩 중...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- 백업/복원 버튼 -->
        <div style="margin-bottom: 1rem;">
          <div style="background: #f8f9fa; padding: .75rem 1rem; border-radius: 8px; border: 1px solid #e0e0e0;">
            <div style="font-size: .85rem; color: #666; margin-bottom: .5rem; font-weight: 600;">💾 데이터 백업</div>
            <div class="btn-row" style="gap: .5rem;">
              <button id="btn-export-backup" style="flex: 1; font-size: .85rem;">백업 다운로드</button>
              <button id="btn-import-backup" style="flex: 1; font-size: .85rem;">백업 복원</button>
            </div>
            <input type="file" id="backup-file-input" accept=".json" style="display: none;">
            <div style="font-size: .75rem; color: #999; margin-top: .5rem;">
              정기적으로 백업 파일을 다운로드하여 안전한 곳에 보관하세요.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 사용 가이드 모달 -->
  <div id="modal-guide" class="modal">
    <div class="modal-content" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div class="modal-title" style="margin: 0;">📖 사용 가이드</div>
        <button id="btn-close-guide-x" style="background: transparent; border: none; font-size: 1.5rem; cursor: pointer; padding: 0; color: #999;">&times;</button>
      </div>

      <div style="color: #555; font-size: .85rem; line-height: 1.5;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
          <strong style="font-size: 1.05rem;">🎉 BIBLE LAB에 오신 것을 환영합니다!</strong><br>
          <span style="font-size: .8rem; opacity: 0.9;">AI 기반 설교 준비 도우미</span>
        </div>

        <div style="background: #f0f4ff; padding: .65rem; border-radius: 6px; margin-bottom: .6rem; border-left: 3px solid #667eea;">
          <strong style="color: #667eea;">1. 성경본문 입력</strong><br>
          <span style="font-size: .8rem;">성경본문을 입력하세요 (예: 시 78:1-8, 창세기 1장 1~10절)</span>
        </div>

        <div style="background: #f0f4ff; padding: .65rem; border-radius: 6px; margin-bottom: .6rem; border-left: 3px solid #667eea;">
          <strong style="color: #667eea;">2. 설교 스타일 선택</strong><br>
          <span style="font-size: .8rem;">3대지, 강해 설교, 주제 설교 중 선택</span>
        </div>

        <div style="background: #f0f4ff; padding: .65rem; border-radius: 6px; margin-bottom: .6rem; border-left: 3px solid #667eea;">
          <strong style="color: #667eea;">3. 설교 준비 시작</strong><br>
          <span style="font-size: .8rem;">보라색 버튼 클릭 → AI가 자동으로 본문 분석 수행</span>
        </div>

        <div style="background: #f0f4ff; padding: .65rem; border-radius: 6px; margin-bottom: .6rem; border-left: 3px solid #667eea;">
          <strong style="color: #667eea;">4. 진행 상태 확인</strong><br>
          <span style="font-size: .8rem;">각 단계별 처리 상황이 실시간으로 표시됩니다<br>(✅완료, ⏳처리중, ⏸️대기)</span>
        </div>

        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: .65rem; border-radius: 6px; margin-bottom: .6rem;">
          <strong style="color: white;">🟣 내 GPT에 붙여넣기</strong><br>
          <span style="font-size: .8rem; color: rgba(255,255,255,0.95);">분석 결과를 복사해서 개인 ChatGPT에서 설교문 작성</span>
        </div>

        <div style="background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); padding: .65rem; border-radius: 6px; margin-bottom: .6rem;">
          <strong style="color: white;">🔴 AI 설교문 완성</strong><br>
          <span style="font-size: .8rem; color: rgba(255,255,255,0.95);">PRO 기능 · BIBLE LAB이 직접 설교문 작성 (크레딧 차감)</span>
        </div>

        <div style="background: #e8f5e9; padding: .65rem; border-radius: 6px; border-left: 3px solid #4caf50;">
          <strong style="color: #2e7d32;">💡 TIP</strong><br>
          <span style="font-size: .8rem;">본문 선정에서 상황을 입력하면 적합한 성경본문을 추천받을 수 있습니다</span>
        </div>
      </div>

      <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0;">
        <label style="display: flex; align-items: center; gap: .5rem; cursor: pointer; font-size: .85rem;">
          <input type="checkbox" id="dont-show-week" style="width: 16px; height: 16px; cursor: pointer;">
          <span>일주일간 보지 않기</span>
        </label>
      </div>

      <div class="modal-buttons" style="margin-top: 1rem;">
        <button id="btn-close-guide" class="primary" style="flex: 1;">시작하기</button>
      </div>
    </div>
  </div>

  <!-- GPT PRO 패스워드 모달 -->
  <div id="modal-gpt-pro-password" class="modal">
    <div class="modal-content">
      <div class="modal-title">🔒 GPT PRO 실행 (테스트 중)</div>
      <p style="color: #666; font-size: .9rem; margin-bottom: 1rem;">이 기능은 현재 테스트 중입니다. 패스워드를 입력하세요.</p>
      <input type="password" id="gpt-pro-password-input" placeholder="패스워드 입력" style="margin-bottom: .5rem;">
      <div class="modal-buttons">
        <button id="btn-cancel-gpt-pro-password">취소</button>
        <button id="btn-submit-gpt-pro-password" class="primary">확인</button>
      </div>
    </div>
  </div>

  <!-- 관리 기능 패스워드 모달 -->
  <div id="modal-manage-password" class="modal">
    <div class="modal-content">
      <div class="modal-title">🔒 관리 기능 잠금</div>
      <p style="color: #666; font-size: .9rem; margin-bottom: 1rem;">카테고리 및 스타일 관리는 관리자만 사용할 수 있습니다. 패스워드를 입력하세요.</p>
      <input type="password" id="manage-password-input" placeholder="패스워드 입력" style="margin-bottom: .5rem;">
      <div class="modal-buttons">
        <button id="btn-cancel-manage-password">취소</button>
        <button id="btn-submit-manage-password" class="primary">확인</button>
      </div>
    </div>
  </div>

  <!-- AI 챗봇 팝업 모달 -->
  <div id="modal-sermon-chatbot" class="modal">
    <div class="modal-content" style="max-width: 600px; height: 70vh; display: flex; flex-direction: column;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div class="modal-title" style="margin: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">🤖 AI 도우미</div>
        <div style="display: flex; gap: .5rem; align-items: center;">
          <select id="sermon-chat-model" style="padding: .4rem .6rem; border-radius: 6px; border: 1px solid #ddd; font-size: .8rem; cursor: pointer;">
            <option value="gpt-4o-mini">GPT-4o Mini (빠름)</option>
            <option value="gpt-4o">GPT-4o (균형)</option>
            <option value="gpt-5">GPT-5 (강력)</option>
          </select>
          <button id="btn-close-sermon-chatbot" style="background: transparent; border: none; font-size: 1.5rem; cursor: pointer; padding: 0; color: #999;">&times;</button>
        </div>
      </div>
      <div style="font-size: .85rem; color: #666; margin-bottom: 1rem; padding: .75rem; background: #f8f9fa; border-radius: 8px;">
        설교문 작성 과정에서 궁금한 점을 질문해보세요.<br>
        <span style="color: #667eea;">Step3 오류, API 문제, 설교 내용 개선</span> 등 무엇이든 도와드립니다!
      </div>
      <!-- 채팅 메시지 영역 -->
      <div id="sermon-chat-messages" style="flex: 1; background: #f0f0f0; border-radius: 8px; padding: .75rem; overflow-y: auto; margin-bottom: .75rem;">
        <div class="chat-welcome" style="text-align: center; color: #999; padding: 2rem; font-size: .85rem;">
          <div style="font-size: 2.5rem; margin-bottom: .5rem;">💬</div>
          <p>어떤 도움이 필요하신가요?</p>
          <div style="margin-top: 1rem; font-size: .75rem; color: #bbb; line-height: 1.6;">
            예시 질문:<br>
            "Step3에서 오류가 났는데 왜 그런거야?"<br>
            "지금 작성된 설교 내용을 요약해줘"<br>
            "크레딧이 부족하다고 나오는데 어떻게 해?"
          </div>
        </div>
      </div>
      <!-- 입력 영역 -->
      <div style="display: flex; gap: .5rem;">
        <input type="text" id="sermon-chat-input" placeholder="질문을 입력하세요..." style="flex: 1; padding: .6rem .8rem; border-radius: 8px; border: 1px solid #ddd; font-size: .9rem;">
        <button id="btn-sermon-chat-send" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: .6rem 1.2rem; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: .9rem;">전송</button>
      </div>
    </div>
  </div>

  <!-- 카테고리 관리 모달 -->
  <div id="modal-categories" class="modal">
    <div class="modal-content">
      <div class="modal-title">카테고리 관리</div>
      <input type="text" id="new-cat-label" placeholder="표시 이름 (예: 특별예배)" style="margin-bottom: .5rem;">
      <button id="btn-add-category" class="primary" style="width: 100%; margin-bottom: 1rem;">추가</button>
      <div id="categories-list" style="max-height: 300px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button id="btn-close-categories">닫기</button>
      </div>
    </div>
  </div>

  <!-- 스타일 관리 모달 -->
  <div id="modal-styles" class="modal">
    <div class="modal-content">
      <div class="modal-title">설교 스타일 관리</div>
      <p style="font-size: .85rem; color: #666; margin-bottom: .5rem;">카테고리: <strong id="modal-styles-category"></strong></p>

      <input type="text" id="new-style-name" placeholder="스타일 이름 (예: 새벽예배 - 강해설교)" style="margin-bottom: .3rem;">
      <input type="text" id="new-style-desc" placeholder="설명 (예: 본론 중심, 아이스브래이킹 제외)" style="margin-bottom: .5rem;">
      <button id="btn-add-style" class="primary" style="width: 100%; margin-bottom: 1rem;">추가</button>

      <div id="styles-manage-list" style="max-height: 300px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button id="btn-close-styles">닫기</button>
      </div>
    </div>
  </div>

  <!-- 처리 단계 관리 모달 -->
  <div id="modal-steps" class="modal">
    <div class="modal-content">
      <div class="modal-title">처리 단계 관리</div>
      <p style="font-size: .85rem; color: #666; margin-bottom: .5rem;">
        스타일: <strong id="modal-steps-style"></strong>
      </p>
      <input type="text" id="new-step-name" placeholder="단계 이름 (예: 제목 추천, 본문 분석, 개요 작성)" style="margin-bottom: .5rem;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: .5rem; margin-bottom: 1rem;">
        <button id="btn-add-step1" class="primary" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); border: none; box-shadow: 0 3px 10px rgba(255,107,107,.3);">➕ Step1 추가</button>
        <button id="btn-add-step2" class="primary" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a3c2 100%); border: none; box-shadow: 0 3px 10px rgba(78,205,196,.3);">➕ Step2 추가</button>
      </div>
      <div id="steps-list" style="max-height: 300px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button id="btn-close-steps">닫기</button>
      </div>
    </div>
  </div>

  <!-- GPT 작업 중 로딩 오버레이 -->
  <div id="gpt-loading-overlay" style="display: none;">
    <div class="gpt-loading-content">
      <div class="gpt-loading-spinner"></div>
      <div class="gpt-loading-text">BIBLE LAB을 이용해 주셔서 감사합니다</div>
      <div class="gpt-loading-subtext">잠시만 기다려주세요</div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
  // ===== Firebase 초기화 =====
  const firebaseConfig = {
    apiKey: "AIzaSyBacmJDk-PG5FaoqnXV8Rg3P__AKOS2vu4",
    authDomain: "my-sermon-guides.firebaseapp.com",
    projectId: "my-sermon-guides",
    storageBucket: "my-sermon-guides.firebasestorage.app",
    messagingSenderId: "539520456089",
    appId: "1:539520456089:web:d6aceb7838baa89e70af08",
    measurementId: "G-KWN8TH7Z26"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const USER_CODE = 'samuel123';
  const PAGE_NAME = 'sermon';
  const GUIDE_PASSWORD = '5555';
  const GPT_PRO_PASSWORD = '6039';
  const MANAGE_PASSWORD = '6039';
  const CONFIG_KEY = '_sermon-config';

  // ===== 전역 변수 =====
  let guideUnlocked = false;
  let gptProUnlocked = false;
  let manageUnlocked = false;
  let pendingManageAction = null; // 'categories' or 'styles'
  let currentCategory = 'general';
  let currentStyleId = '';
  let currentGuideStep = '';
  let stepResults = {};
  let titleOptions = []; // 제목 후보 저장
  let selectedTitle = ''; // 선택된 제목 저장

  // 기본 설정
  let config = {
    categories: [
      {value: "general", label: "일반 설교"},
      {value: "series", label: "시리즈 설교"},
      {value: "education", label: "교육"},
      {value: "lecture", label: "강의"},
      {value: "design_helper", label: "🎨 디자인 도우미"}
    ],
    categorySettings: {
      general: {
        masterGuide: "",
        styles: [
          {
            id: "dawn_expository",
            name: "새벽예배 - 강해설교",
            description: "본론 중심",
            steps: [
              {id: "title", name: "제목 추천", order: 1},
              {id: "analysis", name: "본문 분석", order: 2},
              {id: "outline", name: "개요 작성", order: 3}
            ]
          },
          {
            id: "sunday_topical",
            name: "주일예배 - 주제설교",
            description: "주제 중심",
            steps: [
              {id: "title", name: "제목 추천", order: 1},
              {id: "analysis", name: "본문 분석", order: 2},
              {id: "outline", name: "개요 작성", order: 3}
            ]
          }
        ]
      },
      series: {
        masterGuide: "",
        styles: [
          {
            id: "series_continuous",
            name: "수요예배 - 연속강해",
            description: "시리즈형 강해",
            steps: [
              {id: "title", name: "제목 추천", order: 1},
              {id: "analysis", name: "본문 분석", order: 2},
              {id: "outline", name: "개요 작성", order: 3}
            ]
          }
        ]
      },
      education: {
        masterGuide: "",
        styles: []
      },
      lecture: {
        masterGuide: "",
        styles: []
      }
    }
  };

  // ===== 한글 → 영문 ID 자동 생성 =====
  function koreanToId(korean) {
    const map = {
      '제목': 'title',
      '아이스브래이킹': 'icebreaking',
      '서론': 'intro',
      '본론': 'body',
      '결론': 'conclusion',
      '본문': 'analysis',
      '분석': 'analysis',
      '신학': 'theology',
      '해석': 'interpretation',
      '예화': 'illustration',
      '적용': 'application',
      '실천': 'practice',
      '과제': 'task',
      '질문': 'questions',
      '토론': 'discussion',
      '기도': 'prayer',
      '개요': 'outline'
    };

    for (const [key, value] of Object.entries(map)) {
      if (korean.includes(key)) {
        return value + '_' + Date.now().toString(36);
      }
    }

    return 'step_' + Date.now().toString(36);
  }

  // 카테고리 ID 생성 함수 (category1, category2, ... 순차적)
  function generateCategoryId() {
    let maxNum = 0;
    config.categories.forEach(cat => {
      const match = cat.value.match(/^category(\d+)$/);
      if (match) {
        const num = parseInt(match[1], 10);
        if (num > maxNum) maxNum = num;
      }
    });
    return 'category' + (maxNum + 1);
  }

  // ===== 유틸리티 =====
  function showStatus(msg) {
    const statusBar = document.getElementById('status-bar');
    if (statusBar) {
      statusBar.textContent = msg;
      statusBar.style.display = 'block';
    }
  }

  // ===== GPT 로딩 (오버레이 대신 안내문구) =====
  let currentLoadingMessage = '';

  function showGptLoading(message) {
    currentLoadingMessage = message || '처리 중입니다...';
    const guideDiv = document.getElementById('start-analysis-guide');
    const startBtn = document.getElementById('btn-start-analysis');

    // 버튼 비활성화
    if (startBtn) startBtn.style.display = 'none';

    // 안내문구에 진행상황 표시
    if (guideDiv) {
      guideDiv.style.display = 'block';
      guideDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      guideDiv.style.border = 'none';
      guideDiv.innerHTML = `<span style="font-size: .95rem; font-weight: 700; color: white;">⏳ ${currentLoadingMessage}</span>`;
    }
  }

  function hideGptLoading() {
    currentLoadingMessage = '';
    const guideDiv = document.getElementById('start-analysis-guide');

    // 안내문구 원래대로 복구
    if (guideDiv) {
      guideDiv.style.display = 'none';
      guideDiv.style.background = '#f8f9ff';
      guideDiv.style.border = '2px dashed #667eea';
      guideDiv.innerHTML = `<span style="font-size: .95rem; font-weight: 700; color: #667eea;">📖 성경본문을 입력해주세요</span>`;
    }

    // UI 상태 업데이트
    updateAnalysisUI();
  }

  function updateLoadingMessage(message) {
    currentLoadingMessage = message;
    const guideDiv = document.getElementById('start-analysis-guide');
    if (guideDiv && guideDiv.style.display !== 'none') {
      guideDiv.innerHTML = `<span style="font-size: .95rem; font-weight: 700; color: white;">⏳ ${message}</span>`;
    }
  }

  // ===== 모델별 가격 정보 (1M 토큰당 USD) =====
  const modelPricing = {
    'gpt-4o-mini': { input: 0.15, output: 0.60 },
    'gpt-4o': { input: 2.50, output: 10.00 },
    'gpt-5': { input: 5.00, output: 20.00 },
    'gpt-5.1': { input: 7.50, output: 30.00 }
  };

  // 비용 계산 함수 (원화, 소수점 1자리)
  function calculateCost(modelId, inputTokens, outputTokens) {
    const pricing = modelPricing[modelId];
    if (!pricing) return null;
    const inputCost = (inputTokens / 1000000) * pricing.input;
    const outputCost = (outputTokens / 1000000) * pricing.output;
    const totalUSD = inputCost + outputCost;
    const totalKRW = (totalUSD * 1400).toFixed(1); // 원화 환산, 소수점 1자리
    return {
      inputCost: inputCost.toFixed(6),
      outputCost: outputCost.toFixed(6),
      totalCost: totalUSD.toFixed(6),
      totalCostKRW: totalKRW
    };
  }

  // Step3 기본 지침 (통합)
  const DEFAULT_STEP3_PROMPT = `당신은 한국어 설교 전문가입니다.
step1,2 자료는 참고용으로만 활용하고 문장은 처음부터 새로 구성하며,
묵직하고 명료한 어조로 신학적 통찰과 실제적 적용을 균형 있게 제시하세요.
마크다운 기호 대신 순수 텍스트만 사용합니다.

Step2의 설교 구조를 반드시 따라 작성하세요:
- Step2에서 제시한 구조를 그대로 사용
- Step2의 대지(포인트) 구성을 유지
- 각 섹션의 핵심 메시지를 확장하여 풍성하게 작성

⚠️ 중요: 충분히 길고 상세하며 풍성한 내용으로 작성해주세요.

【공통 요청 사항】
1. Step2의 설교 구조(서론, 본론, 결론)를 반드시 따라 작성하세요.
2. Step2의 대지(포인트) 구성을 유지하고 각 섹션의 핵심 메시지를 확장하세요.
3. 역사적 배경, 신학적 통찰, 실제 적용을 균형 있게 제시하세요.
4. 관련 성경구절을 적절히 인용하세요.
5. 가독성을 위해 각 섹션 사이에 빈 줄을 넣으세요.
6. 마크다운, 불릿 기호 대신 순수 텍스트 단락을 사용하세요.
7. 충분히 길고 상세하며 풍성한 내용으로 작성해주세요.

【서론 작성 시】
- Step2에서 아이스브레이킹이 있다면 반드시 서론 도입부에 포함하세요.
- 청중의 관심을 끌 수 있는 도입으로 시작하세요.

【결론 작성 시】
- 실천 사항은 간결하게 1-2개만 제시하세요.
- 기도제목도 간결하게 1-2개만 제시하세요.
- 마무리 기도문은 짧게 작성하세요.`;

  // ===== 모델 설정 관리 =====
  function getModelSettings(category) {
    const settings = config.categorySettings[category];
    if (!settings.modelSettings) {
      settings.modelSettings = {
        step1: 'gpt-4o',
        step2: 'gpt-4o',
        gptPro: 'gpt-5',
        step3MaxTokens: 16000,
        step3Prompt: DEFAULT_STEP3_PROMPT
      };
    }
    // 기존 설정에 새 필드가 없으면 추가
    if (!settings.modelSettings.step3MaxTokens) {
      settings.modelSettings.step3MaxTokens = 16000;
    }
    if (!settings.modelSettings.step3Prompt) {
      settings.modelSettings.step3Prompt = DEFAULT_STEP3_PROMPT;
    }
    return settings.modelSettings;
  }

  function loadModelSettings() {
    const modelSettings = getModelSettings(currentCategory);
    const step1Select = document.getElementById('model-step1');
    const step2Select = document.getElementById('model-step2');
    const gptProSelect = document.getElementById('model-gpt-pro');
    const step3MaxTokensInput = document.getElementById('step3-max-tokens');

    if (step1Select) step1Select.value = modelSettings.step1;
    if (step2Select) step2Select.value = modelSettings.step2;
    if (gptProSelect) gptProSelect.value = modelSettings.gptPro;
    if (step3MaxTokensInput) step3MaxTokensInput.value = modelSettings.step3MaxTokens;
  }

  async function saveModelSettings() {
    const step1Select = document.getElementById('model-step1');
    const step2Select = document.getElementById('model-step2');
    const gptProSelect = document.getElementById('model-gpt-pro');
    const step3MaxTokensInput = document.getElementById('step3-max-tokens');

    const modelSettings = getModelSettings(currentCategory);
    modelSettings.step1 = step1Select ? step1Select.value : 'gpt-4o';
    modelSettings.step2 = step2Select ? step2Select.value : 'gpt-4o';
    modelSettings.gptPro = gptProSelect ? gptProSelect.value : 'gpt-5';
    modelSettings.step3MaxTokens = step3MaxTokensInput ? parseInt(step3MaxTokensInput.value) || 16000 : 16000;

    await saveConfig();
  }

  // ===== 스타일별 토큰 설정 =====
  let styleTokensExpanded = false;

  function toggleStyleTokens() {
    styleTokensExpanded = !styleTokensExpanded;
    const container = document.getElementById('style-tokens-container');
    const toggle = document.getElementById('style-tokens-toggle');
    if (container) {
      container.style.display = styleTokensExpanded ? 'block' : 'none';
    }
    if (toggle) {
      toggle.textContent = styleTokensExpanded ? '▲ 접기' : '▼ 펼치기';
    }
    if (styleTokensExpanded) {
      renderStyleTokensList();
    }
  }

  function renderStyleTokensList() {
    const container = document.getElementById('style-tokens-list');
    if (!container) return;

    const catSettings = config.categorySettings[currentCategory];
    if (!catSettings || !catSettings.styles || catSettings.styles.length === 0) {
      container.innerHTML = '<div style="color: #999; font-size: .8rem; padding: .5rem;">설교 스타일이 없습니다. 먼저 스타일을 추가해주세요.</div>';
      return;
    }

    // styleTokens 초기화 (없으면)
    if (!catSettings.styleTokens) {
      catSettings.styleTokens = {};
    }

    const html = catSettings.styles.map((style, idx) => {
      const tokenValue = catSettings.styleTokens[style.id] || '';
      return `
        <div style="display: flex; align-items: center; gap: .5rem; padding: .4rem 0; border-bottom: 1px solid #f0f0f0;">
          <span style="flex: 1; font-size: .85rem; color: #333;">${style.name}</span>
          <input type="number"
            id="style-token-${style.id}"
            value="${tokenValue}"
            placeholder="기본값"
            min="1000" max="32000" step="1000"
            onchange="saveStyleToken('${style.id}', this.value)"
            style="width: 80px; padding: .3rem; border-radius: 4px; border: 1px solid #ddd; font-size: .8rem; text-align: center;">
          <span style="font-size: .7rem; color: #999; width: 30px;">토큰</span>
        </div>
      `;
    }).join('');

    container.innerHTML = html;
  }

  async function saveStyleToken(styleId, value) {
    const catSettings = config.categorySettings[currentCategory];
    if (!catSettings) return;

    if (!catSettings.styleTokens) {
      catSettings.styleTokens = {};
    }

    if (value && parseInt(value) > 0) {
      catSettings.styleTokens[styleId] = parseInt(value);
    } else {
      delete catSettings.styleTokens[styleId]; // 비워두면 삭제 (기본값 사용)
    }

    await saveConfig();
    showStatus('✅ 스타일 토큰 저장됨');
    setTimeout(hideStatus, 1500);
  }

  // 스타일 추가/삭제/이름변경 시 토큰 목록 동기화
  function syncStyleTokens() {
    const catSettings = config.categorySettings[currentCategory];
    if (!catSettings || !catSettings.styles || !catSettings.styleTokens) return;

    // 존재하지 않는 스타일의 토큰 설정 제거
    const styleIds = catSettings.styles.map(s => s.id);
    Object.keys(catSettings.styleTokens).forEach(tokenStyleId => {
      if (!styleIds.includes(tokenStyleId)) {
        delete catSettings.styleTokens[tokenStyleId];
      }
    });
  }

  function hideStatus() {
    const statusBar = document.getElementById('status-bar');
    if (statusBar) {
      statusBar.style.display = 'none';
    }
  }

  function autoResize(el) {
    if (!el) return;
    el.style.height = 'auto';
    el.style.height = el.scrollHeight + 'px';
  }

  // ===== Firebase 함수 (재시도 로직 포함) =====
  async function loadFromFirebase() {
    try {
      const snapshot = await db.collection('users').doc(USER_CODE).collection(PAGE_NAME).get();

      if (!snapshot.empty) {
        snapshot.forEach(doc => {
          localStorage.setItem(doc.id, doc.data().value);
        });

        const configData = localStorage.getItem(CONFIG_KEY);
        if (configData) {
          config = JSON.parse(configData);
        }
        console.log('✅ Firebase 동기화 완료');
        return true;
      }
      return false;
    } catch (err) {
      console.error('Firebase 로드 실패:', err);
      return false;
    }
  }

  async function saveToFirebase(key, value, retries = 0) {
    const MAX_RETRIES = 4;
    const RETRY_DELAYS = [2000, 4000, 8000, 16000]; // exponential backoff

    try {
      await db.collection('users').doc(USER_CODE).collection(PAGE_NAME).doc(key).set({
        value: value,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      return true;
    } catch (err) {
      console.error(`Firebase 저장 실패 (시도 ${retries + 1}/${MAX_RETRIES + 1}):`, err);

      // 네트워크 오류인 경우에만 재시도
      const isNetworkError = err.code === 'unavailable' || err.code === 'deadline-exceeded' ||
                             err.message.includes('network') || err.message.includes('offline');

      if (isNetworkError && retries < MAX_RETRIES) {
        const delay = RETRY_DELAYS[retries];
        console.log(`${delay}ms 후 재시도...`);
        await new Promise(resolve => setTimeout(resolve, delay));
        return saveToFirebase(key, value, retries + 1);
      }

      return false;
    }
  }

  async function saveConfig() {
    const configStr = JSON.stringify(config);
    localStorage.setItem(CONFIG_KEY, configStr);
    const success = await saveToFirebase(CONFIG_KEY, configStr);
    if (!success) {
      console.warn('⚠️ Firebase 저장 실패 - 로컬에만 저장됨');
    }
  }

  // ===== 자동 저장 함수 =====
  let autoSaveTimeout = null;
  const AUTO_SAVE_KEY = '_sermon-autosave';

  async function autoSaveStepResults() {
    // debounce: 마지막 변경 후 2초 뒤에 저장
    if (autoSaveTimeout) {
      clearTimeout(autoSaveTimeout);
    }

    autoSaveTimeout = setTimeout(async () => {
      const autoSaveData = {
        category: currentCategory,
        styleId: currentStyleId,
        stepResults: stepResults,
        titleOptions: titleOptions,
        selectedTitle: selectedTitle,
        timestamp: new Date().toISOString()
      };

      const autoSaveStr = JSON.stringify(autoSaveData);
      localStorage.setItem(AUTO_SAVE_KEY, autoSaveStr);

      const success = await saveToFirebase(AUTO_SAVE_KEY, autoSaveStr);
      if (success) {
        console.log('💾 자동 저장 완료');
      } else {
        console.warn('⚠️ 자동 저장 실패 - 로컬에만 저장됨');
      }
    }, 2000);
  }

  function loadAutoSave() {
    try {
      const autoSaveStr = localStorage.getItem(AUTO_SAVE_KEY);
      if (!autoSaveStr) return false;

      const autoSaveData = JSON.parse(autoSaveStr);

      // 자동 저장된 데이터가 현재 카테고리/스타일과 일치하는지 확인
      if (autoSaveData.category === currentCategory && autoSaveData.styleId === currentStyleId) {
        stepResults = autoSaveData.stepResults || {};
        titleOptions = autoSaveData.titleOptions || [];
        selectedTitle = autoSaveData.selectedTitle || '';

        console.log('✅ 자동 저장된 데이터 복원 완료');
        return true;
      }

      return false;
    } catch (err) {
      console.error('자동 저장 데이터 로드 실패:', err);
      return false;
    }
  }

  // ===== 실시간 동기화 =====
  let realtimeListeners = [];
  let isUpdatingFromRemote = false;

  function setupRealtimeSync() {
    // 기존 리스너 정리
    realtimeListeners.forEach(unsubscribe => unsubscribe());
    realtimeListeners = [];

    // CONFIG_KEY 실시간 동기화
    const configListener = db.collection('users').doc(USER_CODE).collection(PAGE_NAME).doc(CONFIG_KEY)
      .onSnapshot((doc) => {
        if (doc.exists && !isUpdatingFromRemote) {
          const remoteData = doc.data();
          const localTimestamp = localStorage.getItem(`${CONFIG_KEY}_timestamp`) || '0';
          const remoteTimestamp = remoteData.updatedAt?.toMillis().toString() || '0';

          // 원격 데이터가 로컬보다 최신인 경우에만 업데이트
          if (remoteTimestamp > localTimestamp) {
            isUpdatingFromRemote = true;
            localStorage.setItem(CONFIG_KEY, remoteData.value);
            localStorage.setItem(`${CONFIG_KEY}_timestamp`, remoteTimestamp);
            config = JSON.parse(remoteData.value);

            console.log('🔄 설정 동기화: 다른 기기에서 업데이트됨');

            // UI 업데이트
            renderCategories();
            renderStyles();
            renderProcessingSteps();
            renderResultBoxes();
            renderGuideTabs();

            setTimeout(() => {
              isUpdatingFromRemote = false;
            }, 1000);
          }
        }
      }, (error) => {
        console.error('실시간 동기화 오류 (CONFIG):', error);
      });

    realtimeListeners.push(configListener);

    // AUTO_SAVE_KEY 실시간 동기화
    const autoSaveListener = db.collection('users').doc(USER_CODE).collection(PAGE_NAME).doc(AUTO_SAVE_KEY)
      .onSnapshot((doc) => {
        if (doc.exists && !isUpdatingFromRemote) {
          const remoteData = doc.data();
          const localTimestamp = localStorage.getItem(`${AUTO_SAVE_KEY}_timestamp`) || '0';
          const remoteTimestamp = remoteData.updatedAt?.toMillis().toString() || '0';

          // 원격 데이터가 로컬보다 최신인 경우에만 업데이트
          if (remoteTimestamp > localTimestamp) {
            isUpdatingFromRemote = true;
            localStorage.setItem(AUTO_SAVE_KEY, remoteData.value);
            localStorage.setItem(`${AUTO_SAVE_KEY}_timestamp`, remoteTimestamp);

            const autoSaveData = JSON.parse(remoteData.value);

            // 현재 카테고리/스타일과 일치하는 경우에만 적용
            if (autoSaveData.category === currentCategory && autoSaveData.styleId === currentStyleId) {
              stepResults = autoSaveData.stepResults || {};
              titleOptions = autoSaveData.titleOptions || [];
              selectedTitle = autoSaveData.selectedTitle || '';

              console.log('🔄 작업 내용 동기화: 다른 기기에서 업데이트됨');
              renderResultBoxes();
            }

            setTimeout(() => {
              isUpdatingFromRemote = false;
            }, 1000);
          }
        }
      }, (error) => {
        console.error('실시간 동기화 오류 (AUTOSAVE):', error);
      });

    realtimeListeners.push(autoSaveListener);
  }

  // ===== 백업 및 복원 =====
  function exportBackup() {
    try {
      const backupData = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        config: config,
        guides: {},
        savedSermons: JSON.parse(localStorage.getItem('sermon-saved') || '[]')
      };

      // 모든 지침 데이터 백업
      for (const key of Object.keys(localStorage)) {
        if (key.startsWith('guide-')) {
          backupData.guides[key] = localStorage.getItem(key);
        }
      }

      const dataStr = JSON.stringify(backupData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `sermon-backup-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showStatus('✅ 백업 다운로드 완료!');
      setTimeout(hideStatus, 2000);
    } catch (err) {
      console.error('백업 실패:', err);
      alert('백업 생성 실패: ' + err.message);
    }
  }

  async function importBackup(file) {
    try {
      const reader = new FileReader();

      reader.onload = async (e) => {
        try {
          const backupData = JSON.parse(e.target.result);

          if (!backupData.version || !backupData.config) {
            throw new Error('유효하지 않은 백업 파일입니다.');
          }

          const confirmed = confirm(
            `백업 복원 시 현재 모든 설정이 덮어쓰여집니다.\n\n` +
            `백업 날짜: ${new Date(backupData.exportDate).toLocaleString('ko-KR')}\n\n` +
            `계속하시겠습니까?`
          );

          if (!confirmed) return;

          showStatus('♻️ 백업 복원 중...');

          // Config 복원
          config = backupData.config;
          await saveConfig();

          // 지침 복원
          if (backupData.guides) {
            for (const [key, value] of Object.entries(backupData.guides)) {
              localStorage.setItem(key, value);
              await saveToFirebase(key, value);
            }
          }

          // 저장된 설교 복원
          if (backupData.savedSermons) {
            localStorage.setItem('sermon-saved', JSON.stringify(backupData.savedSermons));
          }

          showStatus('✅ 백업 복원 완료!');

          // UI 새로고침
          setTimeout(() => {
            location.reload();
          }, 1500);

        } catch (err) {
          console.error('백업 복원 실패:', err);
          alert('백업 복원 실패: ' + err.message);
          hideStatus();
        }
      };

      reader.readAsText(file);
    } catch (err) {
      console.error('파일 읽기 실패:', err);
      alert('파일 읽기 실패: ' + err.message);
    }
  }

  // 백업 이벤트 리스너
  const btnExportBackup = document.getElementById('btn-export-backup');
  if (btnExportBackup) {
    btnExportBackup.addEventListener('click', exportBackup);
  }

  const btnImportBackup = document.getElementById('btn-import-backup');
  const backupFileInput = document.getElementById('backup-file-input');

  if (btnImportBackup && backupFileInput) {
    btnImportBackup.addEventListener('click', () => {
      backupFileInput.click();
    });

    backupFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        importBackup(file);
      }
      // 같은 파일을 다시 선택할 수 있도록 초기화
      e.target.value = '';
    });
  }

  // ===== 제목 관리 함수 =====
  function getSelectedTitle() {
    // 수동 입력 제목이 있으면 우선
    const manualTitle = document.getElementById('manual-title');
    if (manualTitle && manualTitle.value.trim()) {
      return manualTitle.value.trim();
    }
    // 그렇지 않으면 선택된 제목 반환
    return selectedTitle;
  }

  // ===== 제목 선택 관리 =====
  function displayTitleOptions(titles) {
    titleOptions = titles;
    const container = document.getElementById('title-options');
    const box = document.getElementById('title-selection-box');

    if (!container || !box) return;

    if (titles.length >= 3) {
      container.innerHTML = titles.slice(0, 3).map((title, idx) => `
        <label class="title-option-label">
          <input type="radio" name="selectedTitle" value="${idx}" style="margin-right: .5rem;" ${idx === 0 ? 'checked' : ''}>
          <span>${title}</span>
        </label>
      `).join('');

      // 첫 번째 제목을 기본 선택
      selectedTitle = titles[0];

      // 라디오 버튼 변경 이벤트
      container.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          selectedTitle = titleOptions[parseInt(e.target.value)];
          console.log('선택된 제목:', selectedTitle);
        });
      });

      box.style.display = 'block';
    }
  }

  // ===== 총괄 지침 관리 =====
  function loadMasterGuide(category) {
    const settings = config.categorySettings[category];
    const textarea = document.getElementById('master-guide-text');
    if (textarea) {
      if (settings && settings.masterGuide) {
        textarea.value = settings.masterGuide;
      } else {
        textarea.value = '';
      }
      autoResize(textarea);
    }
  }

  async function saveMasterGuide() {
    const textarea = document.getElementById('master-guide-text');
    if (!textarea) return;

    const value = textarea.value;
    const settings = config.categorySettings[currentCategory];

    if (settings) {
      settings.masterGuide = value;
      await saveConfig();

      showStatus('✅ 총괄 지침 저장 완료!');
      setTimeout(hideStatus, 2000);
    }
  }

  const saveMasterGuideBtn = document.getElementById('save-master-guide');
  if (saveMasterGuideBtn) {
    saveMasterGuideBtn.addEventListener('click', saveMasterGuide);
  }

  const toggleMasterGuideBtn = document.getElementById('toggle-master-guide');
  if (toggleMasterGuideBtn) {
    toggleMasterGuideBtn.addEventListener('click', () => {
      const content = document.getElementById('master-guide-content');
      const btn = document.getElementById('toggle-master-guide');

      if (content && btn) {
        if (content.style.display === 'none') {
          content.style.display = 'block';
          btn.textContent = '닫기';
          loadMasterGuide(currentCategory);
        } else {
          content.style.display = 'none';
          btn.textContent = '열기';
        }
      }
    });
  }

  // ===== 지침 관리 =====
  function getGuideKey(category, stepId, styleId = currentStyleId) {
    const stylePart = styleId || 'default';
    return `guide-${category}-${stylePart}-${stepId}`;
  }

  function loadGuide(category, stepId) {
    const key = getGuideKey(category, stepId);
    const legacyKey = `guide-${category}-${stepId}`;
    const migrationKey = `guide-migrated-${category}`;
    let stored = localStorage.getItem(key);

    if (!stored) {
      const legacyValue = localStorage.getItem(legacyKey);
      const migrationTarget = localStorage.getItem(migrationKey);

      if (legacyValue && (!migrationTarget || migrationTarget === currentStyleId)) {
        stored = legacyValue;
        // 스타일 단위로 키를 분리하면서 기존 데이터를 현재 스타일로 승격
        localStorage.setItem(key, stored);
        saveToFirebase(key, stored);

        if (!migrationTarget) {
          const targetStyle = currentStyleId || 'default';
          localStorage.setItem(migrationKey, targetStyle);
          saveToFirebase(migrationKey, targetStyle);
        }
      }
    }

    stored = stored || '';
    const textarea = document.getElementById('guide-text');
    if (textarea) {
      textarea.value = stored;
      autoResize(textarea);
    }

    let info = `카테고리: ${getCategoryLabel(category)} | 단계: ${getStepName(stepId)}`;
    const infoEl = document.getElementById('current-guide-info');
    if (infoEl) {
      infoEl.textContent = info;
    }

    // JSON 디버그 패널 업데이트
    updateJsonDebugPanel(stored);
  }

  // ===== JSON 디버그 패널 =====
  function updateJsonDebugPanel(guideText) {
    const formatEl = document.getElementById('json-debug-format');
    const styleEl = document.getElementById('json-debug-style');
    const roleEl = document.getElementById('json-debug-role');
    const fieldsEl = document.getElementById('json-debug-fields');
    const writingSpecEl = document.getElementById('json-debug-writing-spec');
    const promptEl = document.getElementById('json-debug-prompt');

    if (!formatEl) return; // 디버그 패널이 없으면 종료

    // 기본값으로 초기화
    formatEl.textContent = '-';
    formatEl.style.color = '#666';
    styleEl.textContent = '-';
    roleEl.textContent = '-';
    fieldsEl.innerHTML = '<span style="color: #999;">지침이 없습니다</span>';
    writingSpecEl.innerHTML = '<span style="color: #999;">-</span>';
    promptEl.value = '';

    if (!guideText || !guideText.trim()) {
      formatEl.textContent = '없음';
      return;
    }

    const trimmed = guideText.trim();

    // JSON 형식 확인
    if (trimmed.startsWith('{') && trimmed.endsWith('}')) {
      try {
        const parsed = JSON.parse(trimmed);

        // JSON 파싱 성공
        formatEl.textContent = '✅ JSON';
        formatEl.style.color = '#38ef7d';
        styleEl.textContent = parsed.style || '-';
        roleEl.textContent = parsed.role || '-';

        // output_format 필드 표시
        if (parsed.output_format) {
          const fields = Object.keys(parsed.output_format);
          fieldsEl.innerHTML = fields.map(field => {
            const info = parsed.output_format[field];
            const label = info.label || field;
            const hasSubItems = info.sub_items || info.per_verse || info.per_term;
            const subIcon = hasSubItems ? ' 📁' : '';
            return `<div style="padding: .2rem 0; border-bottom: 1px solid #eee;">
              <span style="color: #11998e; font-weight: 600;">${field}</span>${subIcon}
              <span style="color: #666; margin-left: .5rem;">(${label})</span>
            </div>`;
          }).join('');
        } else {
          fieldsEl.innerHTML = '<span style="color: #f5576c;">⚠️ output_format이 없습니다</span>';
        }

        // writing_spec 표시 (Step2용)
        if (parsed.writing_spec) {
          const specs = Object.entries(parsed.writing_spec).map(([key, value]) => {
            const displayValue = Array.isArray(value) ? value.join(', ') : value;
            return `<div><span style="color: #667eea; font-weight: 600;">${key}:</span> ${displayValue}</div>`;
          }).join('');
          writingSpecEl.innerHTML = specs;
        }

        // 프롬프트 미리보기 생성
        promptEl.value = generatePromptPreview(parsed);

      } catch (e) {
        // JSON 파싱 실패
        formatEl.textContent = '❌ JSON 오류';
        formatEl.style.color = '#f5576c';
        fieldsEl.innerHTML = `<span style="color: #f5576c;">파싱 오류: ${e.message}</span>`;
        promptEl.value = `JSON 파싱 오류:\n${e.message}\n\n원본:\n${trimmed.substring(0, 500)}...`;
      }
    } else {
      // 텍스트 형식
      formatEl.textContent = '📝 텍스트';
      formatEl.style.color = '#4a90e2';
      fieldsEl.innerHTML = `<span style="color: #666;">텍스트 지침 (${trimmed.length}자)</span>`;
      promptEl.value = `[텍스트 지침 - 기존 방식]\n\n${trimmed}`;
    }
  }

  function generatePromptPreview(jsonGuide) {
    const role = jsonGuide.role || '설교 자료 작성자';
    const principle = jsonGuide.principle || '';
    const outputFormat = jsonGuide.output_format || {};

    let preview = `당신은 '${role}'입니다.\n\n`;
    preview += `【 핵심 원칙 】\n${principle}\n\n`;
    preview += `【 출력 형식 】\n반드시 아래 JSON 형식으로만 응답하세요.\n\n`;
    preview += `{\n`;

    const fields = Object.keys(outputFormat);
    fields.forEach((field, i) => {
      const info = outputFormat[field];
      const label = info.label || field;
      preview += `  "${field}": "/* ${label} */"`;
      if (i < fields.length - 1) preview += ',';
      preview += '\n';
    });

    preview += `}\n\n`;
    preview += `【 각 필드 상세 지침 】\n`;

    for (const [field, info] of Object.entries(outputFormat)) {
      if (typeof info === 'object') {
        preview += `\n▶ ${field} (${info.label || field})\n`;
        if (info.description) preview += `  - 설명: ${info.description}\n`;
        if (info.purpose) preview += `  - 목적: ${info.purpose}\n`;
      }
    }

    return preview;
  }

  async function saveGuide() {
    const textarea = document.getElementById('guide-text');
    if (!textarea) return;

    const key = getGuideKey(currentCategory, currentGuideStep);
    const value = textarea.value;

    localStorage.setItem(key, value);

    showStatus('💾 저장 중...');
    const success = await saveToFirebase(key, value);

    if (success) {
      showStatus('✅ 지침 저장 완료!');
    } else {
      showStatus('⚠️ 로컬에만 저장됨');
    }

    setTimeout(hideStatus, 2000);
  }

  // ===== 헬퍼 함수 =====
  function getCategoryLabel(value) {
    const cat = config.categories.find(c => c.value === value);
    return cat ? cat.label : value;
  }

  function getCurrentStyle() {
    const settings = config.categorySettings[currentCategory];
    if (!settings || !settings.styles) return null;
    return settings.styles.find(s => s.id === currentStyleId);
  }

  function getCurrentSteps() {
    const style = getCurrentStyle();
    if (!style || !style.steps) return [];
    return style.steps.sort((a, b) => a.order - b.order);
  }

  function getStepName(stepId) {
    const steps = getCurrentSteps();
    const step = steps.find(s => s.id === stepId);
    return step ? step.name : stepId;
  }

  // ===== Step3/Step4 프롬프트 비교 기능 =====
  function refreshStepCompare() {
    const step3Preview = document.getElementById('step3-prompt-preview');
    const step4Preview = document.getElementById('step4-prompt-preview');
    const step3Stats = document.getElementById('step3-prompt-stats');
    const step4Stats = document.getElementById('step4-prompt-stats');
    const summaryEl = document.getElementById('step-compare-summary');

    if (!step3Preview || !step4Preview) return;

    // Step4 프롬프트 (전체 복사용)
    const draft = assembleGptProDraft();
    const step4Text = draft.error ? `[오류] ${draft.error}` : draft.fullText;
    step4Preview.value = step4Text;
    step4Stats.textContent = `글자수: ${step4Text.length.toLocaleString()}자`;

    // Step3 프롬프트 (서버에서 생성하는 방식 시뮬레이션)
    const step3Text = generateStep3PromptPreview();
    step3Preview.value = step3Text;
    step3Stats.textContent = `글자수: ${step3Text.length.toLocaleString()}자`;

    // 차이점 분석
    const diff = Math.abs(step3Text.length - step4Text.length);
    const diffPercent = ((diff / Math.max(step3Text.length, step4Text.length)) * 100).toFixed(1);

    if (diffPercent < 5) {
      summaryEl.innerHTML = `
        현재 Step3과 Step4는 <strong>거의 동일한 프롬프트</strong>를 사용합니다. (차이: ${diffPercent}%)<br>
        <span style="color: #888;">추후 Step3에 고급 기능(RAG, 예시 설교 참조, 벤치마킹 등)을 추가하여 차별화할 예정입니다.</span>
      `;
    } else {
      summaryEl.innerHTML = `
        Step3과 Step4 프롬프트 <strong>차이: ${diff.toLocaleString()}자 (${diffPercent}%)</strong><br>
        Step3: ${step3Text.length.toLocaleString()}자 | Step4: ${step4Text.length.toLocaleString()}자
      `;
    }
  }

  function generateStep3PromptPreview() {
    // 서버의 build_step3_prompt_from_json과 유사한 로직
    const ref = document.getElementById('sermon-ref')?.value.trim() || '';
    const style = getCurrentStyle();
    const finalTitle = getSelectedTitle();
    const worshipType = document.getElementById('sermon-worship-type')?.value.trim() || '';
    const duration = document.getElementById('sermon-duration')?.value.trim() || '20분';
    const target = document.getElementById('sermon-target')?.value.trim() || '';
    const specialNotes = document.getElementById('special-notes')?.value.trim() || '';

    if (!ref) {
      return '[오류] 성경본문을 입력하세요.';
    }

    let prompt = '';

    // 최우선 지침 (서버와 동일)
    prompt += '='.repeat(50) + '\n';
    prompt += '【 ★★★ 최우선 지침 ★★★ 】\n';
    prompt += '='.repeat(50) + '\n';
    if (duration) {
      prompt += `\n🚨 분량: ${duration}\n`;
      prompt += `   → 이 설교는 반드시 ${duration} 분량으로 작성하세요.\n`;
      prompt += `   → Step1/Step2 자료가 길더라도 ${duration}에 맞춰 압축하세요.\n`;
      prompt += '   → 분량 제한은 다른 모든 지침보다 우선합니다.\n';
    }
    if (worshipType) {
      prompt += `\n🚨 예배/집회 유형: ${worshipType}\n`;
      prompt += `   → '${worshipType}'에 적합한 톤과 내용으로 작성하세요.\n`;
    }
    if (specialNotes) {
      prompt += `\n🚨 특별 참고 사항:\n`;
      prompt += `   ${specialNotes}\n`;
    }
    prompt += '\n' + '='.repeat(50) + '\n\n';

    prompt += '【 설교문 작성 지침 】\n\n';

    // 기본 정보
    prompt += '▶ 기본 정보\n';
    prompt += `  - 성경 본문: ${ref}\n`;
    if (finalTitle) prompt += `  - 설교 제목: ${finalTitle}\n`;
    if (target) prompt += `  - 대상: ${target}\n`;
    if (worshipType) prompt += `  - 예배·집회 유형: ${worshipType}\n`;
    if (duration) prompt += `  - 분량: ${duration}\n`;
    if (style) prompt += `  - 설교 스타일: ${style.name}\n`;
    prompt += '\n';

    // Step1 결과가 있으면 추가
    const step1Data = stepResults['step1'] || stepResults['background_analysis'];
    if (step1Data) {
      prompt += '▶ Step1 분석 자료 (참고용)\n';
      if (typeof step1Data === 'object') {
        prompt += JSON.stringify(step1Data, null, 2);
      } else {
        prompt += step1Data;
      }
      prompt += '\n\n';
    }

    // Step2 결과가 있으면 추가
    const step2Data = stepResults['step2'] || stepResults['sermon_structure'];
    if (step2Data) {
      prompt += '▶ Step2 설교 구조 (참고용 - 분량에 맞게 조절)\n';
      if (typeof step2Data === 'object') {
        prompt += JSON.stringify(step2Data, null, 2);
      } else {
        prompt += step2Data;
      }
      prompt += '\n\n';
    }

    // 최종 지침
    prompt += '='.repeat(50) + '\n';
    prompt += '【 최종 작성 지침 】\n';
    prompt += '위 Step1/Step2 자료를 참고하여 설교문을 작성하세요.\n';
    if (duration) {
      prompt += `\n⚠️ 매우 중요 - 분량 제한: ${duration} 분량 안에서 충분히 상세하고 풍성한 내용으로 작성하세요!\n`;
      prompt += `${duration} 분량을 반드시 지키되, 그 안에서 최대한 깊이 있게 작성해주세요.\n`;
    }
    prompt += '='.repeat(50);

    return prompt;
  }

  function copyStepPrompt(stepType) {
    const textareaId = stepType === 'step3' ? 'step3-prompt-preview' : 'step4-prompt-preview';
    const textarea = document.getElementById(textareaId);
    if (textarea) {
      navigator.clipboard.writeText(textarea.value).then(() => {
        showStatus(`✅ ${stepType.toUpperCase()} 프롬프트가 복사되었습니다.`);
      }).catch(err => {
        console.error('복사 실패:', err);
      });
    }
  }

  // Step 비교 새로고침 버튼 이벤트
  document.getElementById('btn-refresh-step-compare')?.addEventListener('click', refreshStepCompare);

  // 관리자 패널 열릴 때 자동 새로고침
  const adminModalObserver = new MutationObserver((mutations) => {
    const adminModal = document.getElementById('modal-admin-panel');
    if (adminModal && (adminModal.style.display === 'flex' || adminModal.classList.contains('active'))) {
      setTimeout(refreshStepCompare, 100);
    }
  });
  const adminModalEl = document.getElementById('modal-admin-panel');
  if (adminModalEl) {
    adminModalObserver.observe(adminModalEl, { attributes: true, attributeFilter: ['style', 'class'] });
  }

  // ===== GPT PRO 초안 구성 유틸 =====
  function assembleGptProDraft() {
    const steps = getCurrentSteps();
    const ref = document.getElementById('sermon-ref').value.trim();
    const seriesName = document.getElementById('series-name').value.trim();
    const style = getCurrentStyle();
    const finalTitle = getSelectedTitle();

    // 추가 필드들
    const worshipType = document.getElementById('sermon-worship-type')?.value.trim() || '';
    const duration = document.getElementById('sermon-duration')?.value.trim() || '20분';
    const target = document.getElementById('sermon-target')?.value.trim() || '';
    const specialNotes = document.getElementById('special-notes')?.value.trim() || '';

    if (!ref) {
      return { error: '성경본문을 입력하세요.' };
    }

    if (steps.length === 0) {
      return { error: '처리된 단계가 없습니다.' };
    }

    const completedSteps = steps.filter(step => stepResults[step.id]);

    if (completedSteps.length === 0) {
      return { error: '완성된 단계가 없습니다. 먼저 각 단계를 실행해주세요.' };
    }

    const categoryLabel = getCategoryLabel(currentCategory);
    const styleName = style ? style.name : '';
    const styleDescription = style ? style.description : '';

    let fullText = `====================================\n`;
    fullText += `📖 설교 초안 자료 (GPT-5.1 작성용)\n`;
    fullText += `====================================\n\n`;

    // ★★★ 최우선 지침: 분량과 예배유형 ★★★
    fullText += `${'='.repeat(50)}\n`;
    fullText += `【 ★★★ 최우선 지침 ★★★ 】\n`;
    fullText += `${'='.repeat(50)}\n`;
    fullText += `\n🚨 분량: ${duration}\n`;
    fullText += `   → 이 설교는 반드시 ${duration} 분량으로 작성하세요.\n`;
    fullText += `   → 아래 초안이 길더라도 ${duration}에 맞춰 압축하세요.\n`;
    if (worshipType) {
      fullText += `\n🚨 예배/집회 유형: ${worshipType}\n`;
      fullText += `   → '${worshipType}'에 적합한 톤과 내용으로 작성하세요.\n`;
    }
    if (target) {
      fullText += `\n🚨 대상: ${target}\n`;
    }
    if (specialNotes) {
      fullText += `\n🚨 특별 참고 사항:\n`;
      fullText += `   ${specialNotes.replace(/\n/g, '\n   ')}\n`;
      fullText += `   → 위 내용을 설교문 작성 시 반드시 고려하세요.\n`;
    }
    fullText += `\n${'='.repeat(50)}\n\n`;

    fullText += `⚠️ 중요: 이 자료는 gpt-4o-mini가 만든 '초안'입니다.\n`;
    fullText += `GPT-5.1은 이 자료를 참고하되, 처음부터 새로 작성해주세요.\n`;
    fullText += `mini가 만든 문장을 그대로 복사하지 말고, 자연스러운 설교문으로 재작성하세요.\n\n`;
    fullText += `${'='.repeat(50)}\n\n`;
    fullText += `📌 기본 정보\n`;
    fullText += `- 카테고리: ${categoryLabel}\n`;
    fullText += `- 스타일: ${styleName}\n`;
    if (styleDescription) {
      fullText += `- 스타일 설명: ${styleDescription}\n`;
    }
    fullText += `- 성경본문: ${ref}\n`;
    if (finalTitle) {
      fullText += `- 설교 제목: ${finalTitle}\n`;
    }
    if (seriesName) {
      fullText += `- 시리즈명: ${seriesName}\n`;
    }
    if (worshipType) {
      fullText += `- 예배·집회 유형: ${worshipType}\n`;
    }
    fullText += `- 분량: ${duration}\n`;
    if (target) {
      fullText += `- 대상: ${target}\n`;
    }
    if (specialNotes) {
      fullText += `- 특별 참고 사항: ${specialNotes.replace(/\n/g, ' / ')}\n`;
    }
    fullText += `- 작성일: ${new Date().toLocaleDateString('ko-KR')}\n`;
    fullText += `\n${'='.repeat(50)}\n\n`;

    let hasContent = false;
    let sectionIndex = 1;
    completedSteps.forEach(step => {
      if (step.name === '제목 추천') return;

      hasContent = true;
      fullText += `【 ${sectionIndex}. ${step.name} 】\n\n`;

      // stepResults가 객체(JSON)인지 문자열인지 확인
      const resultData = stepResults[step.id];
      if (typeof resultData === 'object' && resultData !== null) {
        fullText += JSON.stringify(resultData, null, 2);
      } else {
        fullText += resultData;
      }

      fullText += `\n\n${'='.repeat(50)}\n\n`;
      sectionIndex += 1;
    });

    if (!hasContent) {
      return { error: '제목 추천 외의 완료된 단계가 없습니다. 다른 단계를 먼저 실행해주세요.' };
    }

    fullText += `\n${'='.repeat(50)}\n`;
    fullText += `📝 최종 작성 지침:\n`;
    fullText += `${'='.repeat(50)}\n`;
    fullText += `위의 초안 자료를 참고하여, 완성도 높은 설교문을 처음부터 새로 작성해주세요.\n`;
    fullText += `\n⚠️ 가장 중요: 반드시 ${duration} 분량을 지켜주세요!\n`;
    if (worshipType) {
      fullText += `⚠️ 예배 유형 '${worshipType}'에 맞는 톤으로 작성하세요.\n`;
    }
    fullText += `\nmax_tokens를 16000으로 설정하고, ${duration} 분량 내에서 충분히 상세하게 작성해주세요.\n`;

    // 제목 추천 단계를 제외한 완료된 단계 이름들
    const stepNames = completedSteps
      .filter(step => step.name !== '제목 추천')
      .map(step => step.name);

    return {
      error: null,
      fullText,
      draftContent: fullText,
      meta: {
        reference: ref,
        seriesName,
        styleName,
        styleDescription,
        finalTitle,
        categoryLabel,
        specialNotes
      },
      completedStepNames: stepNames
    };
  }

  // ===== 전체 복사 기능 =====
  const btnCopyAll = document.getElementById('btn-copy-all');
  if (btnCopyAll) {
    btnCopyAll.addEventListener('click', () => {
      const draft = assembleGptProDraft();
      if (draft.error) {
        alert(draft.error);
        return;
      }

      const tempTextarea = document.createElement('textarea');
      tempTextarea.value = draft.fullText;
      tempTextarea.style.position = 'fixed';
      tempTextarea.style.opacity = '0';
      document.body.appendChild(tempTextarea);
      tempTextarea.select();

      try {
        document.execCommand('copy');
        showStatus('✅ GPT-5.1에 붙여넣을 준비 완료!');
        setTimeout(hideStatus, 2000);
      } catch (err) {
        alert('복사 실패: ' + err.message);
      } finally {
        document.body.removeChild(tempTextarea);
      }
    });
  }

  // ===== GPT PRO 처리 기능 =====
  async function executeGptPro() {
    const draft = assembleGptProDraft();

    // 디버그: stepResults와 draft 내용 확인
    console.log('[Step3 Debug] stepResults:', JSON.stringify(stepResults, null, 2));
    console.log('[Step3 Debug] getCurrentSteps():', getCurrentSteps());
    console.log('[Step3 Debug] draft.completedStepNames:', draft.completedStepNames);
    console.log('[Step3 Debug] draft.draftContent 길이:', draft.draftContent?.length || 0);

    if (draft.error) {
      alert(draft.error);
      return;
    }

    // ===== 1단계: 전체 복사 =====
    const tempTextarea = document.createElement('textarea');
    tempTextarea.value = draft.fullText;
    tempTextarea.style.position = 'fixed';
    tempTextarea.style.opacity = '0';
    document.body.appendChild(tempTextarea);
    tempTextarea.select();

    try {
      document.execCommand('copy');
      showStatus('📋 전체 복사 완료! GPT PRO 처리 중...');
    } catch (err) {
      console.error('복사 실패:', err);
    } finally {
      document.body.removeChild(tempTextarea);
    }

    // ===== 2단계: GPT PRO (Step3)로 설교문 작성 =====
    const modelSettings = getModelSettings(currentCategory);
    const gptProModel = modelSettings.gptPro;

    // 스타일별 토큰 설정 확인 (없으면 기본 토큰 사용)
    const catSettings = config.categorySettings[currentCategory];
    const styleToken = catSettings?.styleTokens?.[currentStyleId];
    const step3MaxTokens = styleToken || modelSettings.step3MaxTokens || 16000;
    console.log(`[Step3] 스타일별 토큰 설정 - styleId: ${currentStyleId}, styleToken: ${styleToken}, 사용토큰: ${step3MaxTokens}`);

    const step3Prompt = modelSettings.step3Prompt || DEFAULT_STEP3_PROMPT;

    showGptLoading(); // 로딩 오버레이 표시
    const tokenInfo = styleToken ? `스타일 토큰: ${step3MaxTokens}` : `기본 토큰: ${step3MaxTokens}`;
    showStatus(`🚀 Step3 (${gptProModel}, ${tokenInfo}) 처리 중... (약 30초 소요)`);

    // JSON 모드 확인: stepResults에 객체가 있으면 JSON 모드
    const step1Data = stepResults['step1'];
    const step2Data = stepResults['step2'];
    const isJsonMode = (typeof step1Data === 'object' && step1Data !== null) ||
                       (typeof step2Data === 'object' && step2Data !== null);

    // 대상, 예배 유형, 분량 가져오기
    const targetEl = document.getElementById('sermon-target');
    const worshipTypeEl = document.getElementById('sermon-worship-type');
    const durationEl = document.getElementById('sermon-duration');
    const targetAudience = targetEl ? targetEl.value.trim() : '';
    const worshipType = worshipTypeEl ? worshipTypeEl.value.trim() : '';
    const duration = durationEl ? (durationEl.value.trim() || '20분') : '20분';  // 기본값 20분

    console.log(`[Step3] JSON 모드: ${isJsonMode}, 대상: ${targetAudience}, 예배유형: ${worshipType}, 분량: ${duration}`);

    try {
      const requestBody = {
        model: gptProModel, // 선택된 모델 전달
        maxTokens: step3MaxTokens, // 최대 토큰량
        customPrompt: step3Prompt, // 사용자 정의 지침 (통합)
        reference: draft.meta.reference,
        title: draft.meta.finalTitle,
        seriesName: draft.meta.seriesName,
        styleName: draft.meta.styleName,
        styleDescription: draft.meta.styleDescription,
        category: draft.meta.categoryLabel,
        draftContent: draft.draftContent,
        completedStepNames: draft.completedStepNames,
        // 추가 필드
        target: targetAudience,
        worshipType: worshipType,
        duration: duration,  // 분량 (기본 20분)
        specialNotes: draft.meta.specialNotes  // 특별 참고 사항
      };

      // JSON 모드일 경우 step1Result, step2Result, step3Guide 추가
      if (isJsonMode) {
        if (typeof step1Data === 'object') {
          requestBody.step1Result = step1Data;
        }
        if (typeof step2Data === 'object') {
          requestBody.step2Result = step2Data;
        }

        // Step3 지침 불러오기 (스타일별)
        const step3GuideKey = getGuideKey(currentCategory, 'step3');
        const step3Guide = localStorage.getItem(step3GuideKey) || '';
        if (step3Guide.trim()) {
          try {
            // JSON 형식인지 확인
            if (step3Guide.trim().startsWith('{')) {
              requestBody.step3Guide = JSON.parse(step3Guide);
              console.log('[Step3] Step3 지침 (JSON):', requestBody.step3Guide);
            } else {
              requestBody.step3Guide = step3Guide;
              console.log('[Step3] Step3 지침 (텍스트):', step3Guide.substring(0, 100) + '...');
            }
          } catch (e) {
            requestBody.step3Guide = step3Guide;
            console.log('[Step3] Step3 지침 (파싱 실패, 텍스트로 전송):', step3Guide.substring(0, 100) + '...');
          }
        }

        console.log('[Step3] JSON 데이터 전송:', {
          step1Result: !!requestBody.step1Result,
          step2Result: !!requestBody.step2Result,
          step3Guide: !!requestBody.step3Guide
        });
      }

      const response = await fetch('/api/sermon/gpt-pro', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(requestBody)
      });

      // 응답 상태 확인
      if (!response.ok) {
        const errorText = await response.text();
        const errorMsg = `Step3 서버 오류 (${response.status}): ${errorText.substring(0, 200)}`;
        console.error('[Step3]', errorMsg);
        window.setLastSermonError && window.setLastSermonError(errorMsg);
        throw new Error(`서버 응답 오류 (${response.status})`);
      }

      // JSON 파싱 시도
      const responseText = await response.text();
      let data;
      try {
        data = JSON.parse(responseText);
      } catch (parseError) {
        const errorMsg = `Step3 응답 파싱 오류: 서버가 잘못된 응답을 반환했습니다. (${responseText.substring(0, 100)}...)`;
        console.error('[Step3]', errorMsg);
        window.setLastSermonError && window.setLastSermonError(errorMsg);
        throw new Error('서버 응답이 올바른 JSON 형식이 아닙니다. 잠시 후 다시 시도해주세요.');
      }

      if (data.ok) {
        const resultTextarea = document.getElementById('gpt-pro-result');
        const resultContainer = document.getElementById('gpt-pro-result-container');

        if (resultTextarea && resultContainer) {
          resultTextarea.value = data.result;
          autoResize(resultTextarea);
          resultContainer.style.display = 'block';

          // 토큰 사용량 표시
          if (data.usage) {
            const cost = calculateCost(gptProModel, data.usage.input_tokens || 0, data.usage.output_tokens || 0);
            const usageSpan = document.getElementById('usage-step3');
            if (usageSpan) {
              usageSpan.textContent = `in(${(data.usage.input_tokens || 0).toLocaleString()}), out(${(data.usage.output_tokens || 0).toLocaleString()}), ${cost ? cost.totalCostKRW : '0.0'}`;
            }
          }

          // 결과 박스로 스크롤
          resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // 남은 크레딧 표시
        let creditMsg = '';
        if (data.credits !== undefined) {
          if (data.credits === -1) {
            creditMsg = ' (무제한)';
          } else {
            creditMsg = ` (남은 크레딧: ${data.credits}회)`;
          }
        }
        showStatus(`✅ 전체 복사 + Step3 완성!${creditMsg}`);
      } else {
        // 크레딧 부족 에러 처리
        if (data.needCredits) {
          const errorMsg = 'Step3 사용 크레딧이 소진되었습니다. 관리자에게 크레딧 충전을 요청하세요.';
          alert(errorMsg);
          showStatus('⚠️ 크레딧 부족');
          window.setLastSermonError && window.setLastSermonError(errorMsg);
        } else {
          const errorMsg = `Step3 오류: ${data.error}`;
          alert(`오류: ${data.error}`);
          showStatus('❌ 실패');
          window.setLastSermonError && window.setLastSermonError(errorMsg);
        }
      }
    } catch (err) {
      const errorMsg = `Step3 네트워크 오류: ${err.message}`;
      alert(`네트워크 오류: ${err.message}`);
      showStatus('❌ 오류');
      window.setLastSermonError && window.setLastSermonError(errorMsg);
    } finally {
      hideGptLoading(); // 로딩 오버레이 숨김
      setTimeout(hideStatus, 3000);
    }
  }

  const btnGptPro = document.getElementById('btn-gpt-pro');
  if (btnGptPro) {
    btnGptPro.addEventListener('click', async () => {
      try {
        // 먼저 서버에서 크레딧 확인
        const creditRes = await fetch('/api/credits');
        const creditData = await creditRes.json();

        console.log('[Step3 Click] 크레딧 확인:', creditData);

        if (creditData.ok) {
          const credits = creditData.credits;
          const unlimited = creditData.unlimited;
          const authDisabled = creditData.authDisabled; // 체험 모드 여부

          if (unlimited || credits > 0) {
            // 크레딧이 있거나 무제한이면 바로 실행
            console.log('[Step3 Click] 크레딧 있음, 실행');
            executeGptPro();
          } else {
            // 크레딧이 없으면 코드 입력 팝업 표시
            console.log('[Step3 Click] 크레딧 소진, 코드 입력 필요');
            const hasAnyCodes = Object.keys(step3Codes).length > 0;

            if (hasAnyCodes) {
              const codeResult = await showCodeInputPopup();
              if (codeResult.cancelled) {
                return;
              }
              showStatus(`✅ 코드 확인됨! (남은 횟수: ${codeResult.remaining})`);
              executeGptPro();
            } else if (authDisabled) {
              // 체험 모드 - 코드 입력 팝업 표시 (코드 필수)
              const inputCode = await showCodeInputPrompt();
              if (inputCode === null || inputCode === '') {
                // 취소되거나 코드 없으면 실행 안함
                return;
              }
              // 입력된 코드 검증
              const validateResult = await validateAndUseCode(inputCode);
              if (validateResult.valid) {
                showStatus(`✅ 코드 확인됨! (남은 횟수: ${validateResult.remaining})`);
                executeGptPro();
              } else {
                showStatus(`❌ ${validateResult.error}`);
                alert(validateResult.error);
              }
            } else {
              // 코드도 없으면 안내 메시지
              showStatus('⚠️ Step3 사용 크레딧이 부족합니다. 관리자에게 문의하세요.');
              alert('Step3 사용 크레딧이 소진되었습니다.\n\n관리자에게 크레딧 충전을 요청하거나,\n발급받은 코드가 있다면 관리자에게 코드 등록을 요청하세요.');
            }
          }
        } else {
          showStatus('❌ 크레딧 확인 실패');
        }
      } catch (err) {
        console.error('[Step3 Click] 오류:', err);
        showStatus('❌ 오류가 발생했습니다');
      }
    });
  }

  // GPT PRO 결과 복사
  const btnCopyGptPro = document.getElementById('btn-copy-gpt-pro');
  if (btnCopyGptPro) {
    btnCopyGptPro.addEventListener('click', () => {
      const textarea = document.getElementById('gpt-pro-result');
      if (textarea && textarea.value) {
        textarea.select();
        document.execCommand('copy');
        const orig = btnCopyGptPro.textContent;
        btnCopyGptPro.textContent = '✅ 복사됨!';
        setTimeout(() => btnCopyGptPro.textContent = orig, 1500);
      }
    });
  }

  // ===== 렌더링 함수 =====
  function renderCategories() {
    const select = document.getElementById('sermon-category');
    const buttonsContainer = document.getElementById('category-buttons');

    if (!select) return;

    const current = select.value;
    select.innerHTML = config.categories.map(c =>
      `<option value="${c.value}">${c.label}</option>`
    ).join('');

    if (current && config.categories.find(c => c.value === current)) {
      select.value = current;
    } else {
      select.value = config.categories[0].value;
    }
    currentCategory = select.value;

    // 카테고리 버튼 렌더링
    if (buttonsContainer) {
      buttonsContainer.innerHTML = config.categories.map(c =>
        `<span class="category-chip ${c.value === currentCategory ? 'active' : ''}" data-category="${c.value}">${c.label}</span>`
      ).join('');

      // 클릭 이벤트 추가
      buttonsContainer.querySelectorAll('.category-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          const categoryValue = chip.dataset.category;
          select.value = categoryValue;
          currentCategory = categoryValue;
          currentStyleId = '';
          stepResults = {};
          stepUsage = {};
          titleOptions = [];
          selectedTitle = '';

          const titleBox = document.getElementById('title-selection-box');
          if (titleBox) titleBox.style.display = 'none';
          const gptProContainer = document.getElementById('gpt-pro-result-container');
          if (gptProContainer) gptProContainer.style.display = 'none';

          // 버튼 활성화 상태 업데이트
          buttonsContainer.querySelectorAll('.category-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');

          loadMasterGuide(currentCategory);
          loadModelSettings();
          renderStyles();
          renderProcessingSteps();
          renderResultBoxes();
          renderGuideTabs();

          const seriesBox = document.getElementById('series-box');
          if (seriesBox) {
            seriesBox.style.display = currentCategory === 'series' ? 'block' : 'none';
          }

          // 카테고리별 UI 전환
          switchCategoryContent(categoryValue);
        });
      });
    }

    // 초기 로드 시 카테고리별 UI 전환
    switchCategoryContent(currentCategory);
  }

  // 카테고리별 콘텐츠 UI 전환 함수
  function switchCategoryContent(category) {
    const sermonContent = document.getElementById('sermon-content');
    const meditationContent = document.getElementById('meditation-content');
    const bibleKnowledgeContent = document.getElementById('bible-knowledge-content');
    const emptyContent = document.getElementById('empty-content');
    const designHelperContent = document.getElementById('design-helper-content');

    // 모든 콘텐츠 숨기기
    if (sermonContent) sermonContent.style.display = 'none';
    if (meditationContent) meditationContent.style.display = 'none';
    if (bibleKnowledgeContent) bibleKnowledgeContent.style.display = 'none';
    if (emptyContent) emptyContent.style.display = 'none';
    if (designHelperContent) designHelperContent.style.display = 'none';

    // 카테고리 label 가져오기
    const catConfig = config.categories.find(c => c.value === category);
    const label = catConfig ? catConfig.label : '';

    // 카테고리에 따라 해당 콘텐츠만 표시
    if (category === 'category1' || label.includes('묵상')) {
      // 묵상메시지
      if (meditationContent) meditationContent.style.display = 'block';
      if (typeof initMeditationDate === 'function') {
        initMeditationDate();
      }
    } else if (label.includes('배경지식')) {
      // 성경 배경지식
      if (bibleKnowledgeContent) bibleKnowledgeContent.style.display = 'block';
    } else if (category === 'design_helper' || label.includes('디자인')) {
      // 디자인 도우미 - 비밀번호 필요
      const password = prompt('디자인 도우미는 테스트 중입니다.\n접근 비밀번호를 입력하세요:');
      if (password === '6039') {
        if (designHelperContent) designHelperContent.style.display = 'block';
        initDesignHelper();
      } else {
        alert('비밀번호가 틀렸습니다.');
        // 이전 카테고리로 돌아가기 또는 빈 페이지 표시
        if (emptyContent) emptyContent.style.display = 'block';
        return;
      }
    } else if (label.includes('설교') || category.startsWith('step_') ||
               ['general', 'series', 'education', 'lecture'].includes(category)) {
      // 설교 관련 카테고리
      if (sermonContent) sermonContent.style.display = 'block';
    } else {
      // 새로 추가된 카테고리 (category2, category3, ...) → 빈 페이지
      if (emptyContent) emptyContent.style.display = 'block';
    }
  }

  function renderStyles() {
    const settings = config.categorySettings[currentCategory];
    const styles = (settings && settings.styles) ? settings.styles : [];
    const container = document.getElementById('styles-list');

    if (!container) return;

    if (styles.length === 0) {
      container.innerHTML = '<p style="color: #999; font-size: .85rem; text-align: center;">스타일을 추가하세요.</p>';
      return;
    }

    // 가로 배치를 위한 flex 컨테이너 스타일
    container.style.display = 'flex';
    container.style.flexWrap = 'wrap';
    container.style.gap = '.5rem';

    container.innerHTML = styles.map(style =>
      `<div class="style-item ${style.id === currentStyleId ? 'active' : ''}" data-style="${style.id}" style="flex: 1 1 auto; min-width: 80px; text-align: center; padding: .5rem .75rem;">
        <div style="font-weight: 600; font-size: .85rem;">${style.name}</div>
      </div>`
    ).join('');

    container.querySelectorAll('.style-item').forEach(item => {
      item.addEventListener('click', () => {
        currentStyleId = item.dataset.style;
        stepResults = {};
        titleOptions = [];
        selectedTitle = '';
        const titleBox = document.getElementById('title-selection-box');
        if (titleBox) titleBox.style.display = 'none';
        const gptProContainer = document.getElementById('gpt-pro-result-container');
        if (gptProContainer) gptProContainer.style.display = 'none';
        renderStyles();
        renderProcessingSteps();
        renderResultBoxes();
        renderGuideTabs();
        updateAnalysisUI(); // 진행 상태 UI 업데이트
      });
    });

    // 첫 방문/새로고침 시 첫 번째 스타일 자동 선택
    if (!currentStyleId && styles.length > 0) {
      currentStyleId = styles[0].id;
      renderStyles();
      renderProcessingSteps();
    }
  }

  // ===== 자동 분석 실행 시스템 =====
  let analysisInProgress = false;

  // 진행 상태 UI 업데이트
  function updateAnalysisUI() {
    const statusContainer = document.getElementById('analysis-status');
    const startBtn = document.getElementById('btn-start-analysis');
    const guideDiv = document.getElementById('start-analysis-guide');
    const step3Box = document.getElementById('step3-box');
    const step4Box = document.getElementById('step4-box');
    const ref = document.getElementById('sermon-ref')?.value;

    if (!startBtn) return;

    // Step1, Step2 완료 여부 확인
    const steps = getCurrentSteps();
    const step1Steps = steps.filter(s => (s.stepType || 'step1') === 'step1');
    const step2Steps = steps.filter(s => (s.stepType || 'step1') === 'step2');
    const step1Completed = step1Steps.length > 0 && step1Steps.every(s => stepResults[s.id]);
    const step2Completed = step2Steps.length > 0 && step2Steps.every(s => stepResults[s.id]);
    const allCompleted = step1Completed && step2Completed;

    // Step3/Step4 활성화 상태
    if (allCompleted) {
      step3Box.style.opacity = '1';
      step3Box.style.pointerEvents = 'auto';
      step4Box.style.opacity = '1';
      step4Box.style.pointerEvents = 'auto';
      startBtn.style.display = 'none';
      if (guideDiv) guideDiv.style.display = 'none';
    } else if (!ref) {
      // 성경 본문 없음 - 안내문구 표시
      startBtn.style.display = 'none';
      if (guideDiv) guideDiv.style.display = 'block';
      step3Box.style.opacity = '0.5';
      step3Box.style.pointerEvents = 'none';
      step4Box.style.opacity = '0.5';
      step4Box.style.pointerEvents = 'none';
    } else if (currentStyleId && !analysisInProgress) {
      // 스타일 선택됨, 시작 버튼 표시
      startBtn.style.display = 'block';
      if (guideDiv) guideDiv.style.display = 'none';
      step3Box.style.opacity = '0.5';
      step3Box.style.pointerEvents = 'none';
      step4Box.style.opacity = '0.5';
      step4Box.style.pointerEvents = 'none';
    } else {
      // 성경 본문은 있지만 스타일 미선택 또는 분석 중
      startBtn.style.display = 'none';
      if (guideDiv) guideDiv.style.display = 'none';
      step3Box.style.opacity = '0.5';
      step3Box.style.pointerEvents = 'none';
      step4Box.style.opacity = '0.5';
      step4Box.style.pointerEvents = 'none';
    }
  }

  // 진행 상태 표시 업데이트 (각 단계별 상세 표시)
  function updateProgressStatus(statuses) {
    const guideDiv = document.getElementById('start-analysis-guide');
    if (!guideDiv) return;

    const statusIcons = {
      pending: '⏸️',
      running: '⏳',
      done: '✅',
      error: '❌'
    };

    // 진행상황 상세 표시
    guideDiv.style.display = 'block';
    guideDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    guideDiv.style.border = 'none';
    guideDiv.style.padding = '.8rem';
    guideDiv.style.textAlign = 'left';

    let html = '<div style="color: white; font-weight: 700; font-size: .85rem; margin-bottom: .5rem; text-align: center;">BIBLE LAB을 이용해 주셔서 감사합니다.</div>';
    html += '<div style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: .5rem;">';

    statuses.forEach(s => {
      const icon = statusIcons[s.status] || '⏸️';
      let statusText = '';
      let opacity = '0.6';

      if (s.status === 'done') {
        statusText = '완료';
        opacity = '1';
      } else if (s.status === 'running') {
        statusText = '처리 중...';
        opacity = '1';
      } else if (s.status === 'pending') {
        statusText = '대기';
        opacity = '0.6';
      } else if (s.status === 'error') {
        statusText = '오류';
        opacity = '1';
      }

      html += `<div style="font-size: .8rem; color: white; padding: .2rem 0; opacity: ${opacity};">${icon} ${s.name} ${statusText}</div>`;
    });

    html += '</div>';
    guideDiv.innerHTML = html;
  }

  // 자동 분석 실행 (Step1 병렬 → Step2 순차)
  async function startAutoAnalysis() {
    const ref = document.getElementById('sermon-ref').value;
    if (!ref) {
      alert('성경본문을 입력하세요.');
      return;
    }
    if (!currentStyleId) {
      alert('설교 스타일을 선택하세요.');
      return;
    }

    analysisInProgress = true;
    const startBtn = document.getElementById('btn-start-analysis');
    if (startBtn) startBtn.style.display = 'none';

    const steps = getCurrentSteps();
    const step1Steps = steps.filter(s => (s.stepType || 'step1') === 'step1');
    const step2Steps = steps.filter(s => (s.stepType || 'step1') === 'step2');

    // 진행 상태 초기화
    const allStatuses = [
      ...step1Steps.map(s => ({ id: s.id, name: s.name, status: 'pending' })),
      ...step2Steps.map(s => ({ id: s.id, name: s.name, status: 'pending' }))
    ];
    updateProgressStatus(allStatuses);

    try {
      // Step1 병렬 실행
      const step1Promises = step1Steps.map(async (step) => {
        const idx = allStatuses.findIndex(s => s.id === step.id);
        allStatuses[idx].status = 'running';
        updateProgressStatus(allStatuses);

        try {
          await executeStep(step.id);
          allStatuses[idx].status = 'done';
        } catch (e) {
          allStatuses[idx].status = 'error';
        }
        updateProgressStatus(allStatuses);
      });

      await Promise.all(step1Promises);

      // Step2 순차 실행 (Step1 완료 후)
      for (const step of step2Steps) {
        const idx = allStatuses.findIndex(s => s.id === step.id);
        allStatuses[idx].status = 'running';
        updateProgressStatus(allStatuses);

        try {
          await executeStep(step.id);
          allStatuses[idx].status = 'done';
        } catch (e) {
          allStatuses[idx].status = 'error';
        }
        updateProgressStatus(allStatuses);
      }

      // 완료
      updateAnalysisUI();

    } catch (error) {
      console.error('분석 실행 오류:', error);
      alert('분석 중 오류가 발생했습니다.');
    } finally {
      analysisInProgress = false;
    }
  }

  function renderProcessingSteps() {
    // 처리 단계 버튼은 더 이상 표시하지 않음 (자동 분석으로 대체)
    const container = document.getElementById('processing-steps');
    if (container) {
      container.style.display = 'none';
      container.innerHTML = '';
    }
  }

  // Step1/Step2 결과를 일부만 표시하는 함수
  function truncateResult(text, stepType = 'step2') {
    if (!text) return '';

    // JSON인 경우 처리
    if (typeof text === 'object') {
      const jsonStr = JSON.stringify(text, null, 2);
      if (jsonStr.length > 500) {
        return jsonStr.substring(0, 500) + '\n\n...\n\n─ ─ ─\n이하 내용 생략\n─ ─ ─';
      }
      return jsonStr;
    }

    const textStr = String(text);

    if (stepType === 'step1') {
      // Step1: 처음 500자만 표시
      if (textStr.length > 500) {
        return textStr.substring(0, 500).trim() + '\n\n...\n\n─ ─ ─\n이하 내용 생략\n─ ─ ─';
      }
      return textStr;
    }

    // Step2: 서론까지만 표시
    const cutoffPatterns = [
      /\n\s*(본론|1대지|대지\s*1|첫\s*번째|First|Conflict|본문\s*1|I\.|1\.|하나\.|첫째)/i,
      /\n\s*[-=]{3,}/,  // 구분선
    ];

    let cutIndex = textStr.length;

    for (const pattern of cutoffPatterns) {
      const match = textStr.match(pattern);
      if (match && match.index < cutIndex) {
        cutIndex = match.index;
      }
    }

    let intro = textStr.substring(0, cutIndex).trim();

    if (intro.length < 100 && textStr.length > 100) {
      intro = textStr.substring(0, 300).trim();
    }

    if (intro.length < textStr.length) {
      intro += '\n\n─ ─ ─\n이하 내용 생략\n─ ─ ─';
    }

    return intro;
  }

  // 하위 호환성을 위한 별칭
  function truncateToIntro(text) {
    return truncateResult(text, 'step2');
  }

  // 토큰 사용량 저장
  let stepUsage = {};

  function renderResultBoxes() {
    const steps = getCurrentSteps();
    const container = document.getElementById('result-boxes');
    const modelSettings = getModelSettings(currentCategory);

    if (!container) return;

    container.innerHTML = steps.map(step => {
      const stepType = step.stepType || 'step1';
      const stepLabel = stepType === 'step1' ? 'Step1' : 'Step2';
      const usage = stepUsage[step.id];
      const usageHtml = usage ? `
        <span id="usage-${step.id}" style="font-size: .75rem; color: #888;">
          in(${usage.inputTokens?.toLocaleString() || 0}), out(${usage.outputTokens?.toLocaleString() || 0}), ${usage.costKRW || '0.0'}
        </span>
      ` : `<span id="usage-${step.id}" style="font-size: .75rem; color: #888;"></span>`;

      // Step1, Step2 모두 동일한 축약 디자인
      return `
        <div class="box step2-box">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .35rem;">
            <label class="label" style="margin: 0;">${stepLabel}. ${step.name}</label>
            ${usageHtml}
          </div>
          <div class="step2-content-wrapper">
            <textarea id="result-${step.id}" class="autosize" style="min-height: 100px; max-height: 150px;" readonly placeholder="${step.name} 결과가 표시됩니다."></textarea>
            <div class="step2-gradient-overlay"></div>
          </div>
          <div style="text-align: center; color: #999; font-size: .85rem; padding: .5rem; border-top: 1px dashed #ddd; margin-top: .3rem;">
            -<br>-<br>-<br>
            <span style="font-size: .75rem;">이하 내용 생략</span>
          </div>
        </div>
      `;
    }).join('');

    // 결과 복원 및 자동 높이 (Step1, Step2 모두 축약 표시)
    steps.forEach(step => {
      if (stepResults[step.id]) {
        const textarea = document.getElementById(`result-${step.id}`);
        if (textarea) {
          const stepType = step.stepType || 'step1';
          textarea.value = truncateResult(stepResults[step.id], stepType);
        }
      }
    });

    // 입력 이벤트로 자동 높이 + 결과 저장
    container.querySelectorAll('textarea').forEach(textarea => {
      textarea.addEventListener('input', () => {
        autoResize(textarea);
        // 사용자가 편집한 내용을 stepResults에 저장
        const stepId = textarea.id.replace('result-', '');
        stepResults[stepId] = textarea.value;
        // 자동 저장
        autoSaveStepResults();
      });
    });
  }

  // 관리자 공간 - 스타일 선택 드롭다운 업데이트
  function updateAdminStyleSelect() {
    const select = document.getElementById('admin-style-select');
    if (!select) return;

    const catSettings = config.categorySettings[currentCategory];
    const styles = catSettings?.styles || [];

    let html = '<option value="">-- 스타일을 선택하세요 --</option>';
    styles.forEach(style => {
      const selected = style.id === currentStyleId ? 'selected' : '';
      html += `<option value="${style.id}" ${selected}>${style.name}</option>`;
    });

    select.innerHTML = html;
  }

  // 관리자 공간 - 스타일 선택 이벤트 바인딩
  function bindAdminStyleSelect() {
    const select = document.getElementById('admin-style-select');
    if (!select) return;

    select.addEventListener('change', (e) => {
      currentStyleId = e.target.value;
      renderGuideTabs();
      if (currentStyleId && currentGuideStep) {
        loadGuide(currentCategory, currentGuideStep);
      }
    });
  }

  function renderGuideTabs() {
    const steps = getCurrentSteps();
    const container = document.getElementById('guide-tabs');

    // 스타일 선택 드롭다운 업데이트
    updateAdminStyleSelect();

    if (!container) return;

    // 스타일이 선택되지 않았으면 탭 숨기기
    if (!currentStyleId) {
      container.innerHTML = '<div style="color: #999; font-size: .85rem; padding: .5rem;">⬆️ 먼저 설교 스타일을 선택하세요</div>';
      document.getElementById('current-guide-info').textContent = '';
      document.getElementById('guide-text').value = '';
      document.getElementById('guide-text').disabled = true;
      return;
    }

    document.getElementById('guide-text').disabled = false;

    // Step3를 고정으로 추가 (모든 스타일에 공통)
    const allSteps = [
      ...steps,
      { id: 'step3', name: '📝 Step3 (설교문 작성)', stepType: 'step3' }
    ];

    if (!allSteps.find(step => step.id === currentGuideStep)) {
      currentGuideStep = allSteps.length > 0 ? allSteps[0].id : '';
    }

    // Step1/Step2와 Step3 그룹 분리하여 표시
    const step12 = allSteps.filter(s => s.stepType !== 'step3');
    const step3 = allSteps.filter(s => s.stepType === 'step3');

    let html = '';

    // Step1/Step2 탭들
    if (step12.length > 0) {
      html += '<div style="display: flex; gap: .3rem; flex-wrap: wrap; margin-bottom: .5rem;">';
      html += step12.map(step =>
        `<button class="${step.id === currentGuideStep ? 'primary' : ''}"
          data-step="${step.id}" style="font-size: .8rem;">${step.name}</button>`
      ).join('');
      html += '</div>';
    }

    // Step3 탭 (강조 스타일)
    if (step3.length > 0) {
      html += '<div style="display: flex; gap: .3rem;">';
      html += step3.map(step =>
        `<button class="${step.id === currentGuideStep ? '' : ''}"
          data-step="${step.id}"
          style="font-size: .8rem; background: ${step.id === currentGuideStep ? 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)' : 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'}; color: ${step.id === currentGuideStep ? 'white' : '#333'}; border: none; font-weight: 600;">
          ${step.name}</button>`
      ).join('');
      html += '</div>';
    }

    container.innerHTML = html;

    container.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        currentGuideStep = btn.dataset.step;
        renderGuideTabs();
        loadGuide(currentCategory, currentGuideStep);
      });
    });

    // 첫 번째 탭 자동 로드
    if (currentGuideStep && currentStyleId) {
      loadGuide(currentCategory, currentGuideStep);
    }
  }

  // ===== 처리 단계 실행 =====
  async function executeStep(stepId) {
    const ref = document.getElementById('sermon-ref').value;
    if (!ref) {
      alert('성경본문을 입력하세요.');
      return;
    }

    const text = document.getElementById('sermon-text').value;
    const guideKey = getGuideKey(currentCategory, stepId);
    const guide = localStorage.getItem(guideKey) || '';

    // 디버그: 지침 로딩 상태 출력
    console.log(`[executeStep] 카테고리: ${currentCategory}, 스타일: ${currentStyleId}, 단계: ${stepId}`);
    console.log(`[executeStep] guideKey: ${guideKey}`);
    console.log(`[executeStep] guide 길이: ${guide.length}, JSON 여부: ${guide.trim().startsWith('{')}`);
    if (guide.trim().startsWith('{')) {
      try {
        const parsed = JSON.parse(guide);
        console.log(`[executeStep] JSON 파싱 성공 - style: ${parsed.style}, role: ${parsed.role}`);
      } catch (e) {
        console.log(`[executeStep] JSON 파싱 실패: ${e.message}`);
      }
    }

    // 총괄 지침 가져오기
    const settings = config.categorySettings[currentCategory];
    const masterGuide = settings ? settings.masterGuide : '';

    const steps = getCurrentSteps();
    const currentStepIndex = steps.findIndex(s => s.id === stepId);
    const currentStep = steps[currentStepIndex];
    const stepType = currentStep ? (currentStep.stepType || 'step1') : 'step1';

    // 선택된 모델 가져오기
    const modelSettings = getModelSettings(currentCategory);
    const selectedModel = stepType === 'step1' ? modelSettings.step1 : modelSettings.step2;

    const previousResults = {};
    for (let i = 0; i < currentStepIndex; i++) {
      const prevStep = steps[i];
      if (stepResults[prevStep.id]) {
        previousResults[prevStep.id] = {
          name: prevStep.name,
          result: stepResults[prevStep.id]
        };
      }
    }

    showGptLoading(); // 로딩 오버레이 표시
    showStatus(`🤖 ${getStepName(stepId)} 처리 중...`);

    try {
      const response = await fetch('/api/sermon/process', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          category: currentCategory,
          stepId: stepId,
          stepName: getStepName(stepId),
          stepType: stepType,
          model: selectedModel, // 선택된 모델 전달
          reference: ref,
          title: getSelectedTitle(), // 현재 제목 전달
          text: text,
          guide: guide,
          masterGuide: masterGuide,
          previousResults: previousResults
        })
      });

      const data = await response.json();

      if (data.ok) {
        // JSON 응답인지 확인하고 파싱 시도
        let resultData = data.result;
        let isJsonResult = false;

        try {
          // JSON 코드 블록 제거 후 파싱 시도
          let cleanResult = data.result.trim();
          if (cleanResult.startsWith('```json')) {
            cleanResult = cleanResult.replace(/^```json\s*/, '').replace(/\s*```$/, '');
          } else if (cleanResult.startsWith('```')) {
            cleanResult = cleanResult.replace(/^```\s*/, '').replace(/\s*```$/, '');
          }

          if (cleanResult.startsWith('{') && cleanResult.endsWith('}')) {
            const parsed = JSON.parse(cleanResult);
            resultData = parsed;
            isJsonResult = true;
            console.log(`[${stepId}] JSON 응답 파싱 성공`);
          }
        } catch (e) {
          console.log(`[${stepId}] 텍스트 응답 (JSON 아님)`);
        }

        // stepResults에 저장 (JSON이면 객체, 아니면 문자열)
        stepResults[stepId] = resultData;

        const textarea = document.getElementById(`result-${stepId}`);
        if (textarea) {
          // 표시용 텍스트 생성 (Step1, Step2 모두 축약)
          const displayText = isJsonResult ? JSON.stringify(resultData, null, 2) : data.result;
          textarea.value = truncateResult(displayText, stepType);
        }

        // 토큰 사용량 표시
        if (data.usage) {
          const cost = calculateCost(selectedModel, data.usage.input_tokens || 0, data.usage.output_tokens || 0);
          stepUsage[stepId] = {
            inputTokens: data.usage.input_tokens || 0,
            outputTokens: data.usage.output_tokens || 0,
            model: selectedModel,
            costKRW: cost ? cost.totalCostKRW : 0
          };
          // 사용량 표시 업데이트
          const usageSpan = document.getElementById(`usage-${stepId}`);
          if (usageSpan) {
            usageSpan.textContent = `in(${(data.usage.input_tokens || 0).toLocaleString()}), out(${(data.usage.output_tokens || 0).toLocaleString()}), ${cost ? cost.totalCostKRW : '0.0'}`;
          }
        }

        // 제목 추천 단계인 경우 라디오 버튼 표시
        const stepName = getStepName(stepId);
        if (stepName.includes('제목')) {
          const lines = data.result.trim().split('\n').filter(line => line.trim());
          if (lines.length >= 3) {
            displayTitleOptions(lines.slice(0, 3));
          }
        }

        // 자동 저장
        autoSaveStepResults();

        // Step1 완료 시 Step2 버튼 활성화를 위해 다시 렌더링
        renderProcessingSteps();

        showStatus('✅ 완료!');
      } else {
        alert(`오류: ${data.error}`);
        showStatus('❌ 실패');
      }
    } catch (err) {
      alert(`네트워크 오류: ${err.message}`);
      showStatus('❌ 오류');
    } finally {
      hideGptLoading(); // 로딩 오버레이 숨김
      setTimeout(hideStatus, 2000);
    }
  }

  // ===== 카테고리 변경 =====
  const categorySelect = document.getElementById('sermon-category');
  if (categorySelect) {
    categorySelect.addEventListener('change', (e) => {
      currentCategory = e.target.value;
      currentStyleId = '';
      stepResults = {};
      stepUsage = {};  // 토큰 사용량도 초기화
      titleOptions = [];
      selectedTitle = '';
      const titleBox = document.getElementById('title-selection-box');
      if (titleBox) titleBox.style.display = 'none';
      const specialNotesEl = document.getElementById('special-notes');
      if (specialNotesEl) specialNotesEl.value = '';  // 특별 참고 사항 초기화
      const gptProContainer = document.getElementById('gpt-pro-result-container');
      if (gptProContainer) gptProContainer.style.display = 'none';

      loadMasterGuide(currentCategory);
      loadModelSettings(); // 모델 설정 로드
      renderStyles();
      renderProcessingSteps();
      renderResultBoxes();
      renderGuideTabs();

      const seriesBox = document.getElementById('series-box');
      if (seriesBox) {
        if (currentCategory === 'series') {
          seriesBox.style.display = 'block';
        } else {
          seriesBox.style.display = 'none';
        }
      }

      // 카테고리별 UI 전환
      switchCategoryContent(currentCategory);
    });
  }

  // ===== 묵상메시지 생성 기능 =====

  // 요일 배열 (한국어)
  const koreanDays = ['일', '월', '화', '수', '목', '금', '토'];

  // 월/일에서 요일 업데이트
  function updateMeditationDayFromInputs() {
    const monthInput = document.getElementById('meditation-month');
    const dayNumInput = document.getElementById('meditation-day-num');
    const daySpan = document.getElementById('meditation-day');

    if (monthInput && dayNumInput && daySpan) {
      const month = parseInt(monthInput.value, 10);
      const day = parseInt(dayNumInput.value, 10);
      if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
        const now = new Date();
        const date = new Date(now.getFullYear(), month - 1, day);
        const dayIndex = date.getDay();
        daySpan.textContent = `(${koreanDays[dayIndex]})`;
      }
    }
  }

  // 묵상메시지 날짜 초기화 (서울 시간)
  function initMeditationDate() {
    const monthInput = document.getElementById('meditation-month');
    const dayNumInput = document.getElementById('meditation-day-num');

    if (monthInput && dayNumInput) {
      // 서울 시간대로 현재 날짜 계산
      const now = new Date();
      const seoulOffset = 9 * 60; // UTC+9
      const localOffset = now.getTimezoneOffset();
      const seoulTime = new Date(now.getTime() + (seoulOffset + localOffset) * 60 * 1000);

      monthInput.value = seoulTime.getMonth() + 1;
      dayNumInput.value = seoulTime.getDate();

      updateMeditationDayFromInputs();
    }

    // 템플릿 로드
    loadMeditationTemplate();
  }

  // 템플릿 저장/로드 (localStorage)
  function saveMeditationTemplate() {
    const templateInput = document.getElementById('meditation-template');
    if (templateInput) {
      localStorage.setItem('meditation_template', templateInput.value);
    }
  }

  function loadMeditationTemplate() {
    const templateInput = document.getElementById('meditation-template');
    if (templateInput) {
      const saved = localStorage.getItem('meditation_template');
      if (saved) {
        templateInput.value = saved;
        autoResizeTextarea(templateInput);
      }
    }
  }

  function resetMeditationTemplate() {
    const templateInput = document.getElementById('meditation-template');
    if (templateInput) {
      templateInput.value = '';
      localStorage.removeItem('meditation_template');
    }
  }

  // textarea 자동 높이 조절
  function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.max(250, textarea.scrollHeight) + 'px';
  }

  // 월/일 입력 변경 이벤트
  const meditationMonth = document.getElementById('meditation-month');
  const meditationDayNum = document.getElementById('meditation-day-num');
  if (meditationMonth) {
    meditationMonth.addEventListener('change', updateMeditationDayFromInputs);
    meditationMonth.addEventListener('input', updateMeditationDayFromInputs);
  }
  if (meditationDayNum) {
    meditationDayNum.addEventListener('change', updateMeditationDayFromInputs);
    meditationDayNum.addEventListener('input', updateMeditationDayFromInputs);
  }

  // 템플릿 textarea 이벤트
  const meditationTemplate = document.getElementById('meditation-template');
  if (meditationTemplate) {
    meditationTemplate.addEventListener('input', () => {
      saveMeditationTemplate();
      autoResizeTextarea(meditationTemplate);
    });
  }

  // 템플릿 초기화 버튼
  const btnResetTemplate = document.getElementById('btn-reset-template');
  if (btnResetTemplate) {
    btnResetTemplate.addEventListener('click', () => {
      if (confirm('템플릿을 초기화하시겠습니까?')) {
        resetMeditationTemplate();
      }
    });
  }

  const btnCreateMeditation = document.getElementById('btn-create-meditation');
  if (btnCreateMeditation) {
    btnCreateMeditation.addEventListener('click', async () => {
      const monthInput = document.getElementById('meditation-month');
      const dayNumInput = document.getElementById('meditation-day-num');
      const daySpan = document.getElementById('meditation-day');
      const ref = document.getElementById('meditation-ref')?.value.trim();
      const verse = document.getElementById('meditation-verse')?.value.trim();
      const sender = document.getElementById('meditation-sender')?.value.trim();
      const template = document.getElementById('meditation-template')?.value.trim();

      if (!ref) {
        alert('성경본문을 입력해주세요.');
        return;
      }
      if (!verse) {
        alert('본문말씀을 입력해주세요.');
        return;
      }

      // 날짜 포맷팅 (예: 7월 16일 (수))
      let dateStr = '';
      if (monthInput && dayNumInput && monthInput.value && dayNumInput.value) {
        const dayText = daySpan ? daySpan.textContent : '';
        dateStr = `${monthInput.value}월 ${dayNumInput.value}일 ${dayText}`;
      }

      showStatus('🙏 묵상메시지 생성 중...');
      showGptLoading();

      try {
        const response = await fetch('/api/sermon/meditation', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            reference: ref,
            verse: verse,
            dateStr: dateStr,
            sender: sender,
            template: template
          })
        });

        const data = await response.json();

        if (data.ok) {
          const resultTextarea = document.getElementById('meditation-result');
          if (resultTextarea) {
            // 최종 메시지 조합
            let finalMessage = '';

            // 날짜 + 오늘의 말씀
            if (dateStr) {
              finalMessage += `${dateStr} 오늘의 말씀\n\n`;
            }

            // 성경구절
            finalMessage += `${ref}\n`;

            // 본문말씀
            finalMessage += `${verse}\n\n`;

            // 묵상메시지 (GPT 생성 결과)
            finalMessage += data.result;

            // 보내는 사람
            if (sender) {
              finalMessage += `\n\n- ${sender} -`;
            }

            resultTextarea.value = finalMessage;
            autoResizeTextarea(resultTextarea);
          }
          showStatus('✅ 묵상메시지 생성 완료!');
        } else {
          alert(`오류: ${data.error}`);
          showStatus('❌ 실패');
        }
      } catch (err) {
        alert(`네트워크 오류: ${err.message}`);
        showStatus('❌ 오류');
      } finally {
        hideGptLoading();
        setTimeout(hideStatus, 2000);
      }
    });
  }

  // 묵상메시지 복사 버튼
  const btnCopyMeditation = document.getElementById('btn-copy-meditation');
  if (btnCopyMeditation) {
    btnCopyMeditation.addEventListener('click', () => {
      const resultTextarea = document.getElementById('meditation-result');
      if (resultTextarea && resultTextarea.value) {
        navigator.clipboard.writeText(resultTextarea.value).then(() => {
          showStatus('📋 복사되었습니다!');
          setTimeout(hideStatus, 2000);
        }).catch(() => {
          // fallback
          resultTextarea.select();
          document.execCommand('copy');
          showStatus('📋 복사되었습니다!');
          setTimeout(hideStatus, 2000);
        });
      }
    });
  }

  // ===== 패스워드 =====
  const toggleGuidesBtn = document.getElementById('toggle-guides');
  if (toggleGuidesBtn) {
    toggleGuidesBtn.addEventListener('click', () => {
      if (!guideUnlocked) {
        const modal = document.getElementById('modal-password');
        if (modal) modal.classList.add('show');
        const input = document.getElementById('password-input');
        if (input) {
          input.value = '';
          input.focus();
        }
      } else {
        const adminModal = document.getElementById('modal-admin-panel');
        if (adminModal) adminModal.classList.add('show');

        const steps = getCurrentSteps();
        if (steps.length > 0) {
          currentGuideStep = steps[0].id;
          renderGuideTabs();
          loadGuide(currentCategory, currentGuideStep);
        }
      }
    });
  }

  const btnCloseAdminPanel = document.getElementById('btn-close-admin-panel');
  if (btnCloseAdminPanel) {
    btnCloseAdminPanel.addEventListener('click', () => {
      const modal = document.getElementById('modal-admin-panel');
      if (modal) modal.classList.remove('show');
    });
  }

  // JSON 디버그 패널 버튼들
  const btnRefreshJsonDebug = document.getElementById('btn-refresh-json-debug');
  if (btnRefreshJsonDebug) {
    btnRefreshJsonDebug.addEventListener('click', () => {
      const guideKey = getGuideKey(currentCategory, currentGuideStep);
      const guideText = localStorage.getItem(guideKey) || '';
      updateJsonDebugPanel(guideText);
    });
  }

  const btnCopyPromptPreview = document.getElementById('btn-copy-prompt-preview');
  if (btnCopyPromptPreview) {
    btnCopyPromptPreview.addEventListener('click', () => {
      const promptEl = document.getElementById('json-debug-prompt');
      if (promptEl && promptEl.value) {
        navigator.clipboard.writeText(promptEl.value).then(() => {
          btnCopyPromptPreview.textContent = '복사됨!';
          setTimeout(() => { btnCopyPromptPreview.textContent = '복사'; }, 1500);
        });
      }
    });
  }

  const btnSubmitPassword = document.getElementById('btn-submit-password');
  if (btnSubmitPassword) {
    btnSubmitPassword.addEventListener('click', () => {
      const input = document.getElementById('password-input');
      if (input && input.value === GUIDE_PASSWORD) {
        guideUnlocked = true;
        const modal = document.getElementById('modal-password');
        if (modal) modal.classList.remove('show');

        const adminModal = document.getElementById('modal-admin-panel');
        if (adminModal) adminModal.classList.add('show');

        const steps = getCurrentSteps();
        if (steps.length > 0) {
          currentGuideStep = steps[0].id;
          renderGuideTabs();
          loadGuide(currentCategory, currentGuideStep);
        }
      } else {
        alert('❌ 패스워드가 틀렸습니다.');
        if (input) input.value = '';
      }
    });
  }

  const btnCancelPassword = document.getElementById('btn-cancel-password');
  if (btnCancelPassword) {
    btnCancelPassword.addEventListener('click', () => {
      const modal = document.getElementById('modal-password');
      if (modal) modal.classList.remove('show');
    });
  }

  // 사용 가이드 모달 닫기
  function closeGuideModal() {
    const modal = document.getElementById('modal-guide');
    const dontShowCheckbox = document.getElementById('dont-show-week');

    if (dontShowCheckbox && dontShowCheckbox.checked) {
      // 일주일(7일) 후까지 숨기기
      const hideUntil = Date.now() + (7 * 24 * 60 * 60 * 1000);
      localStorage.setItem('sermon-guide-hide-until', hideUntil.toString());
    } else {
      // 다음 방문시에는 표시
      localStorage.removeItem('sermon-guide-hide-until');
    }

    if (modal) modal.classList.remove('show');
  }

  const btnCloseGuide = document.getElementById('btn-close-guide');
  if (btnCloseGuide) {
    btnCloseGuide.addEventListener('click', closeGuideModal);
  }

  const btnCloseGuideX = document.getElementById('btn-close-guide-x');
  if (btnCloseGuideX) {
    btnCloseGuideX.addEventListener('click', closeGuideModal);
  }

  const passwordInput = document.getElementById('password-input');
  if (passwordInput) {
    passwordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const btn = document.getElementById('btn-submit-password');
        if (btn) btn.click();
      }
    });
  }

  const saveGuideBtn = document.getElementById('save-guide');
  if (saveGuideBtn) {
    saveGuideBtn.addEventListener('click', saveGuide);
  }

  // ===== 관리 기능 패스워드 =====
  const btnSubmitManagePassword = document.getElementById('btn-submit-manage-password');
  if (btnSubmitManagePassword) {
    btnSubmitManagePassword.addEventListener('click', () => {
      const input = document.getElementById('manage-password-input');
      if (input && input.value === MANAGE_PASSWORD) {
        manageUnlocked = true;
        const modal = document.getElementById('modal-manage-password');
        if (modal) modal.classList.remove('show');

        // 패스워드 확인 후 요청된 관리 모달 표시
        if (pendingManageAction === 'categories') {
          renderCategoryManageList();
          const categoriesModal = document.getElementById('modal-categories');
          if (categoriesModal) categoriesModal.classList.add('show');
        } else if (pendingManageAction === 'styles') {
          const categoryLabel = document.getElementById('modal-styles-category');
          if (categoryLabel) {
            categoryLabel.textContent = getCategoryLabel(currentCategory);
          }
          renderStylesManageList();
          const stylesModal = document.getElementById('modal-styles');
          if (stylesModal) stylesModal.classList.add('show');
        }
        pendingManageAction = null;
      } else {
        alert('❌ 패스워드가 틀렸습니다.');
        if (input) input.value = '';
      }
    });
  }

  const btnCancelManagePassword = document.getElementById('btn-cancel-manage-password');
  if (btnCancelManagePassword) {
    btnCancelManagePassword.addEventListener('click', () => {
      pendingManageAction = null;
      const modal = document.getElementById('modal-manage-password');
      if (modal) modal.classList.remove('show');
    });
  }

  const managePasswordInput = document.getElementById('manage-password-input');
  if (managePasswordInput) {
    managePasswordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const btn = document.getElementById('btn-submit-manage-password');
        if (btn) btn.click();
      }
    });
  }

  // ===== GPT PRO 패스워드 =====
  const btnSubmitGptProPassword = document.getElementById('btn-submit-gpt-pro-password');
  if (btnSubmitGptProPassword) {
    btnSubmitGptProPassword.addEventListener('click', () => {
      const input = document.getElementById('gpt-pro-password-input');
      if (input && input.value === GPT_PRO_PASSWORD) {
        gptProUnlocked = true;
        const modal = document.getElementById('modal-gpt-pro-password');
        if (modal) modal.classList.remove('show');

        // 패스워드 확인 후 GPT PRO 실행
        executeGptPro();
      } else {
        alert('❌ 패스워드가 틀렸습니다.');
        if (input) input.value = '';
      }
    });
  }

  const btnCancelGptProPassword = document.getElementById('btn-cancel-gpt-pro-password');
  if (btnCancelGptProPassword) {
    btnCancelGptProPassword.addEventListener('click', () => {
      const modal = document.getElementById('modal-gpt-pro-password');
      if (modal) modal.classList.remove('show');
    });
  }

  const gptProPasswordInput = document.getElementById('gpt-pro-password-input');
  if (gptProPasswordInput) {
    gptProPasswordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const btn = document.getElementById('btn-submit-gpt-pro-password');
        if (btn) btn.click();
      }
    });
  }

  // ===== 카테고리 관리 =====
  function renderCategoryManageList() {
    const list = document.getElementById('categories-list');
    if (!list) return;

    if (config.categories.length === 0) {
      list.innerHTML = '<p style="color: #999; font-size: .8rem; text-align: center; padding: .5rem;">카테고리를 추가하세요.</p>';
      return;
    }

    list.innerHTML = config.categories.map((cat, idx) => `
      <div class="storage-item">
        <div>
          <div style="font-weight: 600;">${cat.label}</div>
          <div style="font-size: .75rem; color: #666;">${cat.value}</div>
        </div>
        <div>
          <button onclick="editCategory(${idx})" style="margin-right: .3rem;">이름 수정</button>
          ${config.categories.length > 1 ? `<button class="danger" onclick="deleteCategory(${idx})">삭제</button>` : ''}
        </div>
      </div>
    `).join('');
  }

  const btnManageCategories = document.getElementById('btn-manage-categories');
  if (btnManageCategories) {
    btnManageCategories.addEventListener('click', () => {
      if (manageUnlocked) {
        // 이미 잠금 해제된 경우 바로 모달 표시
        renderCategoryManageList();
        const modal = document.getElementById('modal-categories');
        if (modal) modal.classList.add('show');
      } else {
        // 패스워드 확인 필요
        pendingManageAction = 'categories';
        const modal = document.getElementById('modal-manage-password');
        if (modal) modal.classList.add('show');
        const input = document.getElementById('manage-password-input');
        if (input) {
          input.value = '';
          setTimeout(() => input.focus(), 100);
        }
      }
    });
  }

  const btnCloseCategories = document.getElementById('btn-close-categories');
  if (btnCloseCategories) {
    btnCloseCategories.addEventListener('click', () => {
      const modal = document.getElementById('modal-categories');
      if (modal) modal.classList.remove('show');
    });
  }

  const btnAddCategory = document.getElementById('btn-add-category');
  if (btnAddCategory) {
    btnAddCategory.addEventListener('click', async () => {
      const input = document.getElementById('new-cat-label');
      if (!input) return;

      const label = input.value.trim();

      if (!label) {
        alert('표시 이름을 입력하세요.');
        return;
      }

      // 같은 이름의 카테고리가 있는지 확인
      if (config.categories.find(c => c.label === label)) {
        alert('이미 존재하는 카테고리 이름입니다.');
        return;
      }

      const value = generateCategoryId();

      config.categories.push({value, label});
      config.categorySettings[value] = {
        masterGuide: "",
        styles: []
      };

      await saveConfig();
      renderCategories();
      renderCategoryManageList();
      input.value = '';
    });
  }

  window.editCategory = async function(idx) {
    const current = config.categories[idx];
    if (!current) return;

    const newLabel = prompt('새 카테고리 이름을 입력하세요.', current.label);
    if (newLabel === null) return;

    const trimmed = newLabel.trim();
    if (!trimmed) {
      alert('표시 이름을 입력하세요.');
      return;
    }

    current.label = trimmed;
    await saveConfig();
    renderCategories();
    renderCategoryManageList();
    if (current.value === currentCategory) {
      loadMasterGuide(currentCategory);
      renderStyles();
      renderProcessingSteps();
      renderResultBoxes();
      renderGuideTabs();
    }
  };

  window.deleteCategory = async function(idx) {
    if (!confirm(`"${config.categories[idx].label}" 삭제?`)) return;
    const value = config.categories[idx].value;
    config.categories.splice(idx, 1);
    delete config.categorySettings[value];
    await saveConfig();
    renderCategories();
    renderCategoryManageList();
    loadMasterGuide(currentCategory);
    renderStyles();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
  };

  // ===== 스타일 관리 =====
  const btnManageStyles = document.getElementById('btn-manage-styles');
  if (btnManageStyles) {
    btnManageStyles.addEventListener('click', () => {
      if (manageUnlocked) {
        // 이미 잠금 해제된 경우 바로 모달 표시
        const categoryLabel = document.getElementById('modal-styles-category');
        if (categoryLabel) {
          categoryLabel.textContent = getCategoryLabel(currentCategory);
        }

        renderStylesManageList();
        const modal = document.getElementById('modal-styles');
        if (modal) modal.classList.add('show');
      } else {
        // 패스워드 확인 필요
        pendingManageAction = 'styles';
        const modal = document.getElementById('modal-manage-password');
        if (modal) modal.classList.add('show');
        const input = document.getElementById('manage-password-input');
        if (input) {
          input.value = '';
          setTimeout(() => input.focus(), 100);
        }
      }
    });
  }

  function renderStylesManageList() {
    const list = document.getElementById('styles-manage-list');
    if (!list) return;

    const settings = config.categorySettings[currentCategory];
    const styles = (settings && settings.styles) ? settings.styles : [];

    if (styles.length === 0) {
      list.innerHTML = '<p style="color: #999; font-size: .8rem; text-align: center; padding: .5rem;">스타일을 추가하세요.</p>';
      return;
    }

    list.innerHTML = styles.map((style, idx) => `
      <div class="storage-item">
        <div>
          <div style="font-weight: 600;">${style.name}</div>
          <div style="font-size: .75rem; color: #666;">${style.description || ''}</div>
        </div>
        <div>
          <button onclick="editStyle(${idx})" style="margin-right: .3rem;">이름 수정</button>
          <button onclick="editStyleSteps('${style.id}')" style="margin-right: .3rem;">단계 편집</button>
          <button onclick="duplicateStyle(${idx})" style="margin-right: .3rem; background: #4CAF50; color: white;">복제</button>
          <button class="danger" onclick="deleteStyle(${idx})">삭제</button>
        </div>
      </div>
    `).join('');
  }

  const btnCloseStyles = document.getElementById('btn-close-styles');
  if (btnCloseStyles) {
    btnCloseStyles.addEventListener('click', () => {
      const modal = document.getElementById('modal-styles');
      if (modal) modal.classList.remove('show');
    });
  }

  const btnAddStyle = document.getElementById('btn-add-style');
  if (btnAddStyle) {
    btnAddStyle.addEventListener('click', async () => {
      const nameInput = document.getElementById('new-style-name');
      const descInput = document.getElementById('new-style-desc');

      if (!nameInput) return;

      const name = nameInput.value.trim();
      const desc = descInput ? descInput.value.trim() : '';

      if (!name) {
        alert('스타일 이름을 입력하세요.');
        return;
      }

      const id = koreanToId(name);
      const settings = config.categorySettings[currentCategory];

      if (!settings.styles) {
        settings.styles = [];
      }

      settings.styles.push({
        id: id,
        name: name,
        description: desc,
        steps: []
      });

      await saveConfig();
      renderStyles();
      renderStylesManageList();
      nameInput.value = '';
      if (descInput) descInput.value = '';
    });
  }

  window.editStyle = async function(idx) {
    const settings = config.categorySettings[currentCategory];
    if (!settings || !settings.styles) return;

    const style = settings.styles[idx];
    if (!style) return;

    const newName = prompt('새 스타일 이름을 입력하세요.', style.name);
    if (newName === null) return;

    const trimmedName = newName.trim();
    if (!trimmedName) {
      alert('스타일 이름을 입력하세요.');
      return;
    }

    const newDesc = prompt('스타일 설명을 입력하세요.', style.description || '');
    if (newDesc === null) return;

    style.name = trimmedName;
    style.description = newDesc.trim();

    await saveConfig();
    renderStyles();
    renderStylesManageList();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
  };

  window.deleteStyle = async function(idx) {
    const settings = config.categorySettings[currentCategory];
    if (!settings || !settings.styles) return;

    const style = settings.styles[idx];
    if (!confirm(`"${style.name}" 삭제?`)) return;

    // 스타일 삭제 시 관련 지침도 모두 삭제
    if (style.steps && style.steps.length > 0) {
      style.steps.forEach(step => {
        const guideKey = getGuideKey(currentCategory, step.id, style.id);
        localStorage.removeItem(guideKey);
        // Firebase에서도 삭제
        db.collection('users').doc(USER_CODE).collection(PAGE_NAME).doc(guideKey).delete().catch(err => {
          console.warn('Firebase 지침 삭제 실패:', err);
        });
      });
    }

    settings.styles.splice(idx, 1);
    if (currentStyleId === style.id) {
      currentStyleId = '';
    }

    // 스타일 토큰 설정에서도 삭제된 스타일 정리
    syncStyleTokens();

    await saveConfig();
    renderStyles();
    renderStylesManageList();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
  };

  window.duplicateStyle = async function(idx) {
    const settings = config.categorySettings[currentCategory];
    if (!settings || !settings.styles) return;

    const originalStyle = settings.styles[idx];
    if (!originalStyle) return;

    // 복제할 스타일 이름 입력받기
    const newName = prompt('복제된 스타일의 이름을 입력하세요.', `${originalStyle.name} (사본)`);
    if (newName === null) return;

    const trimmedName = newName.trim();
    if (!trimmedName) {
      alert('스타일 이름을 입력하세요.');
      return;
    }

    // 새로운 고유 ID 생성
    const newId = koreanToId(trimmedName);

    // 스타일 복제 (단계들도 함께 복제)
    const duplicatedStyle = {
      id: newId,
      name: trimmedName,
      description: originalStyle.description || '',
      steps: originalStyle.steps ? JSON.parse(JSON.stringify(originalStyle.steps)) : []
    };

    // 스타일 추가
    settings.styles.push(duplicatedStyle);

    // 지침 복사 (각 단계별로)
    if (originalStyle.steps && originalStyle.steps.length > 0) {
      for (const step of originalStyle.steps) {
        const originalGuideKey = getGuideKey(currentCategory, step.id, originalStyle.id);
        const newGuideKey = getGuideKey(currentCategory, step.id, newId);

        // localStorage에서 지침 복사
        const guideContent = localStorage.getItem(originalGuideKey);
        if (guideContent) {
          localStorage.setItem(newGuideKey, guideContent);

          // Firebase에도 저장
          await saveToFirebase(newGuideKey, guideContent);
        }
      }
    }

    // 설정 저장
    await saveConfig();

    // UI 업데이트
    renderStyles();
    renderStylesManageList();

    showStatus(`✅ "${trimmedName}" 스타일이 복제되었습니다.`);
    setTimeout(hideStatus, 2000);
  };

  window.editStyleSteps = function(styleId) {
    const settings = config.categorySettings[currentCategory];
    if (!settings || !settings.styles) return;

    const style = settings.styles.find(s => s.id === styleId);
    if (!style) return;

    currentStyleId = styleId;
    const modal = document.getElementById('modal-styles');
    if (modal) modal.classList.remove('show');

    const styleLabel = document.getElementById('modal-steps-style');
    if (styleLabel) styleLabel.textContent = style.name;

    renderStepsManageList(style);

    const stepsModal = document.getElementById('modal-steps');
    if (stepsModal) stepsModal.classList.add('show');
  };

  function renderStepsManageList(style) {
    const list = document.getElementById('steps-list');
    if (!list) return;

    if (!style.steps) style.steps = [];
    style.steps.sort((a, b) => a.order - b.order);

    if (style.steps.length === 0) {
      list.innerHTML = '<p style="color: #999; font-size: .8rem; text-align: center; padding: .5rem;">단계를 추가하세요.</p>';
      return;
    }

    list.innerHTML = style.steps.map((step, idx) => {
      const stepType = step.stepType || 'step1';
      const stepBadgeColor = stepType === 'step1' ? '#ff6b6b' : '#4ecdc4';
      const stepBadgeText = stepType === 'step1' ? 'Step1' : 'Step2';
      return `
        <div class="storage-item">
          <div style="display: flex; align-items: center; gap: .5rem;">
            <span style="background: ${stepBadgeColor}; color: white; padding: .2rem .4rem; border-radius: 4px; font-size: .7rem; font-weight: 600;">${stepBadgeText}</span>
            <span>${step.order}. ${step.name}</span>
          </div>
          <div>
            ${idx > 0 ? `<button onclick="moveStep(${idx}, -1)" style="margin-right: .3rem;">↑</button>` : ''}
            ${idx < style.steps.length - 1 ? `<button onclick="moveStep(${idx}, 1)" style="margin-right: .3rem;">↓</button>` : ''}
            <button onclick="renameStep(${idx})" style="margin-right: .3rem;">이름 수정</button>
            <button class="danger" onclick="deleteStep(${idx})">삭제</button>
          </div>
        </div>
      `;
    }).join('');
  }

  const btnCloseSteps = document.getElementById('btn-close-steps');
  if (btnCloseSteps) {
    btnCloseSteps.addEventListener('click', () => {
      const modal = document.getElementById('modal-steps');
      if (modal) modal.classList.remove('show');
    });
  }

  // Step1 추가 버튼
  const btnAddStep1 = document.getElementById('btn-add-step1');
  if (btnAddStep1) {
    btnAddStep1.addEventListener('click', async () => {
      const input = document.getElementById('new-step-name');
      if (!input) return;

      const name = input.value.trim();

      if (!name) {
        alert('단계 이름을 입력하세요.');
        return;
      }

      const style = getCurrentStyle();
      if (!style) return;

      if (!style.steps) style.steps = [];

      const id = koreanToId(name);
      const maxOrder = style.steps.length > 0 ? Math.max(...style.steps.map(s => s.order)) : 0;

      style.steps.push({
        id: id,
        name: name,
        order: maxOrder + 1,
        stepType: 'step1'
      });

      await saveConfig();
      renderProcessingSteps();
      renderResultBoxes();
      renderGuideTabs();
      const updatedStyle = getCurrentStyle();
      if (updatedStyle) {
        renderStepsManageList(updatedStyle);
      }
      input.value = '';
    });
  }

  // Step2 추가 버튼
  const btnAddStep2 = document.getElementById('btn-add-step2');
  if (btnAddStep2) {
    btnAddStep2.addEventListener('click', async () => {
      const input = document.getElementById('new-step-name');
      if (!input) return;

      const name = input.value.trim();

      if (!name) {
        alert('단계 이름을 입력하세요.');
        return;
      }

      const style = getCurrentStyle();
      if (!style) return;

      if (!style.steps) style.steps = [];

      const id = koreanToId(name);
      const maxOrder = style.steps.length > 0 ? Math.max(...style.steps.map(s => s.order)) : 0;

      style.steps.push({
        id: id,
        name: name,
        order: maxOrder + 1,
        stepType: 'step2'
      });

      await saveConfig();
      renderProcessingSteps();
      renderResultBoxes();
      renderGuideTabs();
      const updatedStyle = getCurrentStyle();
      if (updatedStyle) {
        renderStepsManageList(updatedStyle);
      }
      input.value = '';
    });
  }

  window.moveStep = async function(idx, direction) {
    const style = getCurrentStyle();
    if (!style || !style.steps) return;

    const steps = style.steps;
    const targetIdx = idx + direction;

    if (targetIdx < 0 || targetIdx >= steps.length) return;

    [steps[idx].order, steps[targetIdx].order] = [steps[targetIdx].order, steps[idx].order];

    await saveConfig();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
    const updatedStyle = getCurrentStyle();
    if (updatedStyle) {
      renderStepsManageList(updatedStyle);
    }
  };

  window.deleteStep = async function(idx) {
    const style = getCurrentStyle();
    if (!style || !style.steps) return;

    if (!confirm(`"${style.steps[idx].name}" 삭제?`)) return;

    style.steps.splice(idx, 1);
    await saveConfig();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
    renderStepsManageList(style);
  };

  window.renameStep = async function(idx) {
    const style = getCurrentStyle();
    if (!style || !style.steps) return;

    const step = style.steps[idx];
    if (!step) return;

    const newName = prompt('새 단계 이름을 입력하세요.', step.name);
    if (newName === null) return;

    const trimmed = newName.trim();
    if (!trimmed) {
      alert('단계 이름을 입력하세요.');
      return;
    }

    step.name = trimmed;
    await saveConfig();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();
    renderStepsManageList(style);
  };

  // ===== 저장/불러오기 =====
  const btnSave = document.getElementById('btn-save');
  if (btnSave) {
    btnSave.addEventListener('click', () => {
      const saved = JSON.parse(localStorage.getItem('sermon-saved') || '[]');
      const style = getCurrentStyle();

      saved.push({
        date: document.getElementById('sermon-date').value,
        category: currentCategory,
        styleId: currentStyleId,
        styleName: style ? style.name : '',
        seriesName: document.getElementById('series-name').value,
        ref: document.getElementById('sermon-ref').value,
        manualTitle: document.getElementById('manual-title').value,
        selectedTitle: selectedTitle,
        text: document.getElementById('sermon-text').value,
        specialNotes: document.getElementById('special-notes')?.value || '',
        results: stepResults,
        titleOptions: titleOptions,
        savedAt: new Date().toISOString()
      });

      localStorage.setItem('sermon-saved', JSON.stringify(saved));
      renderSavedList();
      alert('✅ 저장되었습니다!');
    });
  }

  function renderSavedList() {
    const saved = JSON.parse(localStorage.getItem('sermon-saved') || '[]');
    const list = document.getElementById('saved-list');

    if (!list) return;

    if (saved.length === 0) {
      list.innerHTML = '<p style="color: #999; font-size: .8rem; text-align: center; padding: .5rem;">저장된 자료가 없습니다.</p>';
      return;
    }

    list.innerHTML = saved.map((item, idx) => {
      const catLabel = getCategoryLabel(item.category);
      const display = item.seriesName
        ? `${item.date} - ${catLabel} - ${item.seriesName}`
        : `${item.date} - ${catLabel} - ${item.styleName}`;

      return `
        <div class="storage-item">
          <span style="font-size: .85rem;">${display}</span>
          <div>
            <button onclick="loadSaved(${idx})" style="margin-right: .3rem;">불러오기</button>
            <button onclick="deleteSaved(${idx})">삭제</button>
          </div>
        </div>
      `;
    }).join('');
  }

  window.loadSaved = function(idx) {
    const saved = JSON.parse(localStorage.getItem('sermon-saved') || '[]');
    const item = saved[idx];

    document.getElementById('sermon-date').value = item.date || '';
    document.getElementById('sermon-category').value = item.category || 'general';
    document.getElementById('sermon-ref').value = item.ref || '';
    document.getElementById('sermon-text').value = item.text || '';
    document.getElementById('series-name').value = item.seriesName || '';
    document.getElementById('manual-title').value = item.manualTitle || '';
    const specialNotesEl = document.getElementById('special-notes');
    if (specialNotesEl) specialNotesEl.value = item.specialNotes || '';

    currentCategory = item.category || 'general';
    currentStyleId = item.styleId || '';
    stepResults = item.results || {};
    titleOptions = item.titleOptions || [];
    selectedTitle = item.selectedTitle || '';

    // 제목이 있으면 표시
    if (titleOptions.length >= 3) {
      displayTitleOptions(titleOptions);
      // 저장된 선택 복원
      if (selectedTitle) {
        const idx = titleOptions.indexOf(selectedTitle);
        if (idx >= 0) {
          const radio = document.querySelector(`input[name="selectedTitle"][value="${idx}"]`);
          if (radio) radio.checked = true;
        }
      }
    }

    renderStyles();
    renderProcessingSteps();
    renderResultBoxes();
    renderGuideTabs();

    document.querySelectorAll('textarea').forEach(autoResize);
  };

  window.deleteSaved = function(idx) {
    if (!confirm('삭제하시겠습니까?')) return;
    const saved = JSON.parse(localStorage.getItem('sermon-saved') || '[]');
    saved.splice(idx, 1);
    localStorage.setItem('sermon-saved', JSON.stringify(saved));
    renderSavedList();
  };

  // ===== textarea 자동 높이 =====
  document.querySelectorAll('textarea.autosize').forEach(textarea => {
    textarea.addEventListener('input', () => autoResize(textarea));
  });

  // ===== Q&A 기능 =====
  const QA_STORAGE_KEY = 'sermon-qa-history';

  function loadQAHistory() {
    try {
      const history = sessionStorage.getItem(QA_STORAGE_KEY);
      return history ? JSON.parse(history) : [];
    } catch (e) {
      console.error('Q&A 히스토리 로드 실패:', e);
      return [];
    }
  }

  function saveQAHistory(history) {
    try {
      sessionStorage.setItem(QA_STORAGE_KEY, JSON.stringify(history));
    } catch (e) {
      console.error('Q&A 히스토리 저장 실패:', e);
    }
  }

  function renderQAHistory() {
    const qaHistory = document.getElementById('qa-history');
    if (!qaHistory) return;

    const history = loadQAHistory();

    if (history.length === 0) {
      qaHistory.innerHTML = '<div class="qa-empty-state">아직 질문이 없습니다.<br>처리 단계 결과나 본문에 대해 궁금한 점을 물어보세요.</div>';
      return;
    }

    qaHistory.innerHTML = history.map(item => {
      const userMsg = `
        <div class="qa-message user">
          <div class="qa-message-label">질문</div>
          <div class="qa-message-content">${escapeHtml(item.question)}</div>
        </div>
      `;
      const assistantMsg = `
        <div class="qa-message assistant">
          <div class="qa-message-label">답변</div>
          <div class="qa-message-content">${escapeHtml(item.answer)}</div>
        </div>
      `;
      return userMsg + assistantMsg;
    }).join('');

    // 스크롤을 맨 아래로
    qaHistory.scrollTop = qaHistory.scrollHeight;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  async function sendQAQuestion() {
    const input = document.getElementById('qa-input');
    const question = input.value.trim();

    if (!question) {
      alert('질문을 입력해주세요.');
      return;
    }

    const reference = document.getElementById('sermon-ref').value.trim();

    // 현재 처리 단계 결과들 수집
    // stepResults는 { stepId: "결과 문자열" } 형태로 저장됨
    const contextStepResults = {};
    for (const [stepId, stepData] of Object.entries(stepResults)) {
      if (stepData) {
        // stepData가 문자열인 경우 직접 사용
        const result = typeof stepData === 'string' ? stepData : (stepData.result || '');
        const name = typeof stepData === 'string' ? getStepName(stepId) : (stepData.name || stepId);
        if (result) {
          contextStepResults[stepId] = {
            name: name,
            result: result
          };
        }
      }
    }

    // UI 업데이트: 질문 추가
    const history = loadQAHistory();
    history.push({
      question: question,
      answer: '답변을 생성 중입니다...'
    });
    saveQAHistory(history);
    renderQAHistory();

    // 입력창 비우기
    input.value = '';

    showGptLoading(); // 로딩 오버레이 표시

    try {
      showStatus('🤔 답변 생성 중...');

      const response = await fetch('/api/sermon/qa', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          question: question,
          reference: reference,
          stepResults: contextStepResults
        })
      });

      const result = await response.json();
      hideGptLoading(); // 로딩 오버레이 숨김
      hideStatus();

      if (result.ok) {
        // 마지막 항목의 답변 업데이트
        history[history.length - 1].answer = result.answer;
        saveQAHistory(history);
        renderQAHistory();
      } else {
        alert('답변 생성 실패: ' + (result.error || '알 수 없는 오류'));
        // 실패한 항목 제거
        history.pop();
        saveQAHistory(history);
        renderQAHistory();
      }
    } catch (err) {
      hideGptLoading(); // 로딩 오버레이 숨김
      hideStatus();
      console.error('Q&A 요청 실패:', err);
      alert('답변 생성 중 오류가 발생했습니다.');
      // 실패한 항목 제거
      history.pop();
      saveQAHistory(history);
      renderQAHistory();
    }
  }

  // ===== Step3 사용 코드 관리 시스템 =====
  const CODES_KEY = '_sermon-step3-codes';
  let step3Codes = {}; // { 코드명: { limit: 총횟수, remaining: 남은횟수, createdAt: 생성일 } }

  // 코드 목록 로드
  async function loadStep3Codes() {
    const saved = localStorage.getItem(CODES_KEY);
    console.log('[Step3Codes] localStorage 데이터:', saved);
    if (saved) {
      try {
        step3Codes = JSON.parse(saved);
        console.log('[Step3Codes] 로드된 코드:', step3Codes);
        console.log('[Step3Codes] 코드 개수:', Object.keys(step3Codes).length);
      } catch (e) {
        console.error('[Step3Codes] 파싱 오류:', e);
        step3Codes = {};
      }
    } else {
      console.log('[Step3Codes] 저장된 코드 없음');
    }
    renderCodeList();
  }

  // 코드 목록 저장
  async function saveStep3Codes() {
    localStorage.setItem(CODES_KEY, JSON.stringify(step3Codes));
    await saveToFirebase(CODES_KEY, JSON.stringify(step3Codes));
  }

  // 랜덤 코드 생성
  function generateRandomCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // 혼동 가능한 문자 제외 (0,O,1,I)
    let code = '';
    for (let i = 0; i < 6; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
  }

  // 새 코드 생성
  async function createNewCode() {
    const nameInput = document.getElementById('new-code-name');
    const limitInput = document.getElementById('new-code-limit');

    let codeName = nameInput.value.trim().toUpperCase();
    const limit = parseInt(limitInput.value) || 3;

    // 코드명이 비어있으면 자동 생성
    if (!codeName) {
      do {
        codeName = generateRandomCode();
      } while (step3Codes[codeName]); // 중복 방지
    }

    // 이미 존재하는 코드 체크
    if (step3Codes[codeName]) {
      alert(`'${codeName}' 코드가 이미 존재합니다.`);
      return;
    }

    // 코드 추가
    step3Codes[codeName] = {
      limit: limit,
      remaining: limit,
      createdAt: new Date().toISOString()
    };

    await saveStep3Codes();
    renderCodeList();

    // 입력 필드 초기화
    nameInput.value = '';
    limitInput.value = '3';

    showStatus(`✅ 코드 '${codeName}' 생성 완료!`);
    setTimeout(hideStatus, 2000);
  }

  // 코드 삭제
  async function deleteCode(codeName) {
    if (!confirm(`'${codeName}' 코드를 삭제하시겠습니까?`)) return;

    delete step3Codes[codeName];
    await saveStep3Codes();
    renderCodeList();

    showStatus(`🗑️ 코드 '${codeName}' 삭제됨`);
    setTimeout(hideStatus, 2000);
  }

  // 코드 목록 렌더링
  function renderCodeList() {
    const tbody = document.getElementById('code-list-body');
    if (!tbody) return;

    const codeNames = Object.keys(step3Codes);

    if (codeNames.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" style="padding: 1rem; text-align: center; color: #999;">생성된 코드가 없습니다.</td></tr>';
      return;
    }

    // 생성일 기준 정렬 (최신순)
    codeNames.sort((a, b) => {
      const dateA = new Date(step3Codes[a].createdAt || 0);
      const dateB = new Date(step3Codes[b].createdAt || 0);
      return dateB - dateA;
    });

    tbody.innerHTML = codeNames.map(code => {
      const info = step3Codes[code];
      const isExhausted = info.remaining <= 0;
      const statusText = isExhausted ? '소진' : '활성';
      const statusColor = isExhausted ? '#e74c3c' : '#27ae60';
      const statusBg = isExhausted ? '#fde8e8' : '#e8f8e8';

      return `
        <tr style="border-bottom: 1px solid #f0f0f0;">
          <td style="padding: .5rem; font-family: monospace; font-weight: 600;">${code}</td>
          <td style="padding: .5rem; text-align: center;">${info.remaining}/${info.limit}</td>
          <td style="padding: .5rem; text-align: center;">
            <span style="background: ${statusBg}; color: ${statusColor}; padding: .2rem .5rem; border-radius: 4px; font-size: .75rem; font-weight: 600;">${statusText}</span>
          </td>
          <td style="padding: .5rem; text-align: center;">
            <button onclick="deleteCode('${code}')" style="padding: .2rem .5rem; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: .75rem;">삭제</button>
          </td>
        </tr>
      `;
    }).join('');
  }

  // 코드 유효성 검사 및 사용
  async function validateAndUseCode(inputCode) {
    const code = inputCode.trim().toUpperCase();

    if (!code) {
      return { valid: false, message: '코드를 입력해주세요.' };
    }

    if (!step3Codes[code]) {
      return { valid: false, message: '존재하지 않는 코드입니다.' };
    }

    if (step3Codes[code].remaining <= 0) {
      return { valid: false, message: '사용 횟수가 모두 소진된 코드입니다.' };
    }

    // 코드 사용 (횟수 차감)
    step3Codes[code].remaining--;
    await saveStep3Codes();
    renderCodeList();

    return { valid: true, remaining: step3Codes[code].remaining };
  }

  // 체험 모드용 코드 입력 프롬프트 (코드 없이 실행 가능)
  function showCodeInputPrompt() {
    return new Promise((resolve) => {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;';

      const popup = document.createElement('div');
      popup.style.cssText = 'background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 380px; width: 90%;';
      popup.innerHTML = `
        <div style="font-size: 1.1rem; font-weight: 700; color: #f5576c; margin-bottom: 1rem; text-align: center;">🔑 Step3 사용 코드 입력</div>
        <div style="font-size: .85rem; color: #666; margin-bottom: 1rem; text-align: center;">
          Step3 실행을 위해 발급받은 코드를 입력해주세요.
        </div>
        <input type="text" id="code-prompt-input" placeholder="코드 입력 (예: ABC123)" style="width: 100%; padding: .75rem; font-size: 1rem; border: 2px solid #ddd; border-radius: 8px; text-align: center; text-transform: uppercase; font-family: monospace; font-weight: 600; margin-bottom: 1rem; box-sizing: border-box;">
        <div id="code-prompt-error" style="color: #e74c3c; font-size: .85rem; text-align: center; margin-bottom: 1rem; display: none;"></div>
        <div style="display: flex; gap: .5rem;">
          <button id="btn-prompt-cancel" style="flex: 1; padding: .6rem; background: #e0e0e0; color: #666; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">취소</button>
          <button id="btn-prompt-run" style="flex: 1; padding: .6rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">확인</button>
        </div>
      `;

      overlay.appendChild(popup);
      document.body.appendChild(overlay);

      const input = popup.querySelector('#code-prompt-input');
      const cancelBtn = popup.querySelector('#btn-prompt-cancel');
      const runBtn = popup.querySelector('#btn-prompt-run');

      input.focus();

      const cleanup = () => {
        document.body.removeChild(overlay);
      };

      cancelBtn.addEventListener('click', () => {
        cleanup();
        resolve(null); // 취소
      });

      runBtn.addEventListener('click', () => {
        const code = input.value.trim().toUpperCase();
        cleanup();
        resolve(code); // 빈 문자열이면 코드 없이 실행
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const code = input.value.trim().toUpperCase();
          cleanup();
          resolve(code);
        } else if (e.key === 'Escape') {
          cleanup();
          resolve(null);
        }
      });
    });
  }

  // 코드 입력 팝업 표시
  function showCodeInputPopup() {
    return new Promise((resolve) => {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;';

      const popup = document.createElement('div');
      popup.style.cssText = 'background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 350px; width: 90%;';
      popup.innerHTML = `
        <div style="font-size: 1.1rem; font-weight: 700; color: #f5576c; margin-bottom: 1rem; text-align: center;">🔑 Step3 사용 코드 입력</div>
        <div style="font-size: .85rem; color: #666; margin-bottom: 1rem; text-align: center;">
          Step3 실행을 위해 발급받은 코드를 입력해주세요.
        </div>
        <input type="text" id="step3-code-input" placeholder="코드 입력 (예: ABC123)" style="width: 100%; padding: .75rem; font-size: 1rem; border: 2px solid #ddd; border-radius: 8px; text-align: center; text-transform: uppercase; font-family: monospace; font-weight: 600; margin-bottom: 1rem; box-sizing: border-box;">
        <div id="code-error-msg" style="color: #e74c3c; font-size: .85rem; text-align: center; margin-bottom: 1rem; display: none;"></div>
        <div style="display: flex; gap: .5rem;">
          <button id="btn-code-cancel" style="flex: 1; padding: .6rem; background: #e0e0e0; color: #666; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">취소</button>
          <button id="btn-code-confirm" style="flex: 1; padding: .6rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">확인</button>
        </div>
      `;

      overlay.appendChild(popup);
      document.body.appendChild(overlay);

      const input = popup.querySelector('#step3-code-input');
      const errorMsg = popup.querySelector('#code-error-msg');
      const cancelBtn = popup.querySelector('#btn-code-cancel');
      const confirmBtn = popup.querySelector('#btn-code-confirm');

      input.focus();

      const cleanup = () => {
        document.body.removeChild(overlay);
      };

      cancelBtn.addEventListener('click', () => {
        cleanup();
        resolve({ cancelled: true });
      });

      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          cleanup();
          resolve({ cancelled: true });
        }
      });

      const handleConfirm = async () => {
        confirmBtn.disabled = true;
        confirmBtn.textContent = '확인 중...';

        const result = await validateAndUseCode(input.value);

        if (result.valid) {
          cleanup();
          resolve({ cancelled: false, ...result });
        } else {
          errorMsg.textContent = result.message;
          errorMsg.style.display = 'block';
          confirmBtn.disabled = false;
          confirmBtn.textContent = '확인';
          input.focus();
          input.select();
        }
      };

      confirmBtn.addEventListener('click', handleConfirm);
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleConfirm();
      });
    });
  }

  // 전역 함수로 등록 (onclick에서 사용)
  window.deleteCode = deleteCode;

  // ===== AI 챗봇 기능 =====
  let lastSermonError = ''; // 마지막 오류 저장

  const sermonChatModal = document.getElementById('modal-sermon-chatbot');
  const sermonChatMessages = document.getElementById('sermon-chat-messages');
  const sermonChatInput = document.getElementById('sermon-chat-input');
  const sermonChatSendBtn = document.getElementById('btn-sermon-chat-send');
  const btnSermonChatbot = document.getElementById('btn-sermon-chatbot');
  const btnCloseSermonChatbot = document.getElementById('btn-close-sermon-chatbot');

  // 챗봇 모달 열기/닫기
  if (btnSermonChatbot) {
    btnSermonChatbot.addEventListener('click', () => {
      sermonChatModal.classList.add('show');
    });
  }
  if (btnCloseSermonChatbot) {
    btnCloseSermonChatbot.addEventListener('click', () => {
      sermonChatModal.classList.remove('show');
    });
  }

  function addSermonChatMessage(type, content) {
    // 환영 메시지 제거
    const welcome = sermonChatMessages.querySelector('.chat-welcome');
    if (welcome) welcome.remove();

    const msgDiv = document.createElement('div');
    msgDiv.style.cssText = `
      margin-bottom: .75rem; padding: .6rem .8rem; border-radius: 8px;
      ${type === 'user'
        ? 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-left: 20%; text-align: right;'
        : 'background: white; color: #333; margin-right: 20%; box-shadow: 0 1px 3px rgba(0,0,0,0.1);'}
    `;
    msgDiv.innerHTML = `<div style="font-size: .85rem; line-height: 1.5; white-space: pre-wrap;">${content}</div>`;
    sermonChatMessages.appendChild(msgDiv);
    sermonChatMessages.scrollTop = sermonChatMessages.scrollHeight;
  }

  function collectSermonContext() {
    const context = {};

    // Step1 결과
    const step1Result = document.getElementById('step1-result')?.value;
    if (step1Result) context.step1Result = step1Result;

    // Step2 결과
    const step2Result = document.getElementById('step2-result')?.value;
    if (step2Result) context.step2Result = step2Result;

    // Step3 결과
    const step3Result = document.getElementById('step3-result')?.value;
    if (step3Result) context.step3Result = step3Result;

    // 성경 본문
    const bibleVerse = document.getElementById('bible-verse')?.value;
    if (bibleVerse) context.bibleVerse = bibleVerse;

    // 설교 스타일
    const styleSelect = document.getElementById('style-select');
    if (styleSelect) context.sermonStyle = styleSelect.options[styleSelect.selectedIndex]?.text;

    // 마지막 오류
    if (lastSermonError) context.lastError = lastSermonError;

    return context;
  }

  async function sendSermonChatMessage() {
    const question = sermonChatInput.value.trim();
    if (!question) return;

    // 사용자 메시지 추가
    addSermonChatMessage('user', question);
    sermonChatInput.value = '';

    // 선택된 모델 가져오기
    const modelSelect = document.getElementById('sermon-chat-model');
    const selectedModel = modelSelect ? modelSelect.value : 'gpt-4o-mini';

    // 로딩 표시
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'sermon-chat-loading';
    loadingDiv.style.cssText = 'margin-bottom: .75rem; padding: .6rem .8rem; background: white; border-radius: 8px; margin-right: 20%; box-shadow: 0 1px 3px rgba(0,0,0,0.1);';
    loadingDiv.innerHTML = `<div style="font-size: .85rem; color: #999;">🤔 ${selectedModel}로 생각 중...</div>`;
    sermonChatMessages.appendChild(loadingDiv);
    sermonChatMessages.scrollTop = sermonChatMessages.scrollHeight;

    try {
      const response = await fetch('/api/sermon/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          question: question,
          context: collectSermonContext(),
          model: selectedModel
        })
      });

      const data = await response.json();
      loadingDiv.remove();

      if (data.ok) {
        addSermonChatMessage('ai', data.answer);
      } else {
        addSermonChatMessage('ai', '❌ 오류: ' + data.error);
      }
    } catch (err) {
      loadingDiv.remove();
      addSermonChatMessage('ai', '❌ 네트워크 오류: ' + err.message);
    }
  }

  if (sermonChatSendBtn) {
    sermonChatSendBtn.addEventListener('click', sendSermonChatMessage);
  }
  if (sermonChatInput) {
    sermonChatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendSermonChatMessage();
    });
  }

  // 오류 저장 함수 (다른 곳에서 호출)
  window.setLastSermonError = function(error) {
    lastSermonError = error;
  };

  // ===== 본문 추천 기능 =====
  async function searchScripture() {
    const searchInput = document.getElementById('scripture-search');
    const recommendationsDiv = document.getElementById('scripture-recommendations');
    const scriptureList = document.getElementById('scripture-list');

    const query = searchInput.value.trim();
    if (!query) {
      alert('상황을 입력해주세요. (예: 이사심방, 구국기도회)');
      return;
    }

    showStatus('📖 본문 추천 중...');
    showGptLoading();

    try {
      const response = await fetch('/api/sermon/recommend-scripture', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ query: query })
      });

      const data = await response.json();
      hideGptLoading();

      if (data.ok && data.recommendations) {
        scriptureList.innerHTML = data.recommendations.map((rec, idx) => `
          <div class="scripture-item" data-scripture="${rec.scripture}" style="background: #f8f9fa; padding: .75rem; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; margin-bottom: .5rem;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: .4rem;">
              <div style="font-weight: 700; color: #333; font-size: .95rem;">${idx + 1}. ${rec.scripture}</div>
              ${rec.title ? `<span style="font-size: .75rem; background: #667eea; color: white; padding: .15rem .4rem; border-radius: 4px;">${rec.title}</span>` : ''}
            </div>
            ${rec.text ? `<div style="font-size: .8rem; color: #555; background: #fff; padding: .5rem; border-radius: 4px; margin-bottom: .4rem; border-left: 3px solid #667eea; line-height: 1.5;">"${rec.text}"</div>` : ''}
            <div style="font-size: .8rem; color: #666; line-height: 1.4;">${rec.reason}</div>
          </div>
        `).join('');

        // 클릭 이벤트 추가
        scriptureList.querySelectorAll('.scripture-item').forEach(item => {
          item.addEventListener('click', () => {
            const scripture = item.dataset.scripture;
            document.getElementById('sermon-ref').value = scripture;

            // 검색 키워드를 예배·집회 유형 상자에 설정
            const searchKeyword = document.getElementById('scripture-search').value.trim();
            const worshipTypeInput = document.getElementById('sermon-worship-type');
            if (searchKeyword && worshipTypeInput) {
              worshipTypeInput.value = searchKeyword;
            }

            // 선택된 항목 스타일
            scriptureList.querySelectorAll('.scripture-item').forEach(i => {
              i.style.borderColor = 'transparent';
              i.style.background = '#f8f9fa';
            });
            item.style.borderColor = '#4a90e2';
            item.style.background = '#e6f2ff';

            showStatus('✅ 본문이 선택되었습니다! (예배 유형도 설정됨)');
            setTimeout(hideStatus, 2000);
          });

          // 호버 효과
          item.addEventListener('mouseenter', () => {
            if (item.style.borderColor !== 'rgb(74, 144, 226)') {
              item.style.background = '#e9ecef';
            }
          });
          item.addEventListener('mouseleave', () => {
            if (item.style.borderColor !== 'rgb(74, 144, 226)') {
              item.style.background = '#f8f9fa';
            }
          });
        });

        recommendationsDiv.style.display = 'block';
        showStatus('✅ 추천 완료!');
        setTimeout(hideStatus, 2000);
      } else {
        alert('추천 실패: ' + (data.error || '알 수 없는 오류'));
        hideStatus();
      }
    } catch (err) {
      hideGptLoading();
      alert('네트워크 오류: ' + err.message);
      hideStatus();
    }
  }

  // ===== 초기화 =====
  document.addEventListener('DOMContentLoaded', async () => {
    const dateInput = document.getElementById('sermon-date');
    if (dateInput) {
      dateInput.value = new Date().toISOString().split('T')[0];
    }

    showStatus('☁️ 클라우드 동기화 중...');
    await loadFromFirebase();
    hideStatus();

    renderCategories();
    loadMasterGuide(currentCategory);
    loadModelSettings(); // 모델 설정 로드
    loadStep3Codes(); // Step3 코드 목록 로드

    // 코드 생성 버튼 이벤트 리스너
    const btnCreateCode = document.getElementById('btn-create-code');
    if (btnCreateCode) {
      btnCreateCode.addEventListener('click', createNewCode);
    }

    // 본문 추천 버튼 이벤트 리스너
    const btnSearchScripture = document.getElementById('btn-search-scripture');
    if (btnSearchScripture) {
      btnSearchScripture.addEventListener('click', searchScripture);
    }
    const scriptureSearchInput = document.getElementById('scripture-search');
    if (scriptureSearchInput) {
      scriptureSearchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchScripture();
      });
    }

    renderStyles();
    renderProcessingSteps();
    bindAdminStyleSelect(); // 관리자 스타일 선택 이벤트 바인딩
    updateAnalysisUI(); // 초기 진행 상태 UI

    // 설교 준비 시작 버튼 이벤트
    const btnStartAnalysis = document.getElementById('btn-start-analysis');
    if (btnStartAnalysis) {
      btnStartAnalysis.addEventListener('click', startAutoAnalysis);
    }

    // 성경 본문 입력 시 UI 업데이트
    const sermonRefInput = document.getElementById('sermon-ref');
    if (sermonRefInput) {
      sermonRefInput.addEventListener('input', () => {
        updateAnalysisUI();
      });
    }

    // 모델 선택 이벤트 리스너
    const step1Select = document.getElementById('model-step1');
    const step2Select = document.getElementById('model-step2');
    const gptProSelect = document.getElementById('model-gpt-pro');

    if (step1Select) {
      step1Select.addEventListener('change', async () => {
        await saveModelSettings();
        showStatus('✅ 모델 설정 저장됨');
        setTimeout(hideStatus, 1500);
      });
    }
    if (step2Select) {
      step2Select.addEventListener('change', async () => {
        await saveModelSettings();
        showStatus('✅ 모델 설정 저장됨');
        setTimeout(hideStatus, 1500);
      });
    }
    if (gptProSelect) {
      gptProSelect.addEventListener('change', async () => {
        await saveModelSettings();
        showStatus('✅ 모델 설정 저장됨');
        setTimeout(hideStatus, 1500);
      });
    }

    // Step3 토큰 설정 이벤트 리스너
    const step3MaxTokensInput = document.getElementById('step3-max-tokens');
    if (step3MaxTokensInput) {
      step3MaxTokensInput.addEventListener('change', async () => {
        await saveModelSettings();
        showStatus('✅ 토큰 설정 저장됨');
        setTimeout(hideStatus, 1500);
      });
    }

    // 자동 저장 데이터 복원 - 새로고침 시 초기화하기 위해 제거
    // loadAutoSave();

    // 새로고침 시 stepResults 초기화
    stepResults = {};
    titleOptions = [];
    selectedTitle = '';

    // 새로고침 시 AUTO_SAVE_KEY 데이터 삭제 및 타임스탬프를 미래 값으로 설정 (실시간 동기화 방지)
    localStorage.removeItem(AUTO_SAVE_KEY);
    // 타임스탬프를 현재 + 1년으로 설정하여 실시간 동기화가 복원하지 않도록 함
    const futureTimestamp = (Date.now() + 365 * 24 * 60 * 60 * 1000).toString();
    localStorage.setItem(`${AUTO_SAVE_KEY}_timestamp`, futureTimestamp);

    // 새로고침 시 Q&A 히스토리 초기화
    sessionStorage.removeItem(QA_STORAGE_KEY);

    // 새로고침 시 GPT PRO 결과 초기화
    const gptProContainer = document.getElementById('gpt-pro-result-container');
    if (gptProContainer) gptProContainer.style.display = 'none';
    const gptProResult = document.getElementById('gpt-pro-result');
    if (gptProResult) gptProResult.value = '';

    // 제목 선택 박스 숨기기
    const titleBox = document.getElementById('title-selection-box');
    if (titleBox) titleBox.style.display = 'none';

    renderResultBoxes();
    renderGuideTabs();
    renderSavedList();

    // 첫 방문자 가이드 표시
    const guideHideUntil = localStorage.getItem('sermon-guide-hide-until');
    const now = Date.now();
    if (!guideHideUntil || now > parseInt(guideHideUntil)) {
      const modal = document.getElementById('modal-guide');
      if (modal) {
        modal.classList.add('show');
      }
    }

    // 실시간 동기화 시작
    console.log('🔄 실시간 동기화 활성화');
    setupRealtimeSync();

    // Q&A 초기화
    renderQAHistory();

    // Q&A 이벤트 리스너
    const btnSendQA = document.getElementById('btn-send-qa');
    if (btnSendQA) {
      btnSendQA.addEventListener('click', sendQAQuestion);
    }

    const qaInput = document.getElementById('qa-input');
    if (qaInput) {
      // Enter 키로 전송 (Shift+Enter는 줄바꿈)
      qaInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendQAQuestion();
        }
      });
    }

    document.querySelectorAll('textarea').forEach(autoResize);
  });

  // ===== 디자인 도우미 함수 =====

  // 디자인 도우미 초기화
  function initDesignHelper() {
    // 모델 선택 라디오 버튼 스타일 업데이트
    const modelRadios = document.querySelectorAll('input[name="banner-model"]');
    modelRadios.forEach(radio => {
      radio.addEventListener('change', updateModelSelection);
    });
    updateModelSelection();

    // 크기 프리셋 버튼 이벤트
    const presetButtons = document.querySelectorAll('.size-preset');
    presetButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        // 모든 버튼 비활성화 스타일
        presetButtons.forEach(b => {
          b.style.background = '#f8f9fa';
          b.style.border = '1px solid #ddd';
          b.style.color = '#333';
          b.classList.remove('active');
        });
        // 클릭된 버튼 활성화 스타일
        btn.style.background = '#667eea';
        btn.style.border = '1px solid #667eea';
        btn.style.color = 'white';
        btn.classList.add('active');

        // 크기 입력 필드 업데이트
        const width = btn.dataset.width;
        const height = btn.dataset.height;
        document.getElementById('banner-width').value = width;
        document.getElementById('banner-height').value = height;
        updateSizePreview();
      });
    });

    // 크기 입력 필드 변경 이벤트
    const widthInput = document.getElementById('banner-width');
    const heightInput = document.getElementById('banner-height');
    if (widthInput) widthInput.addEventListener('input', updateSizePreview);
    if (heightInput) heightInput.addEventListener('input', updateSizePreview);

    updateSizePreview();
  }

  // 모델 선택 스타일 업데이트
  function updateModelSelection() {
    const dalleLabel = document.getElementById('model-dalle3-label');
    const fluxLabel = document.getElementById('model-flux-label');
    const dalleRadio = document.querySelector('input[name="banner-model"][value="dalle3"]');
    const fluxRadio = document.querySelector('input[name="banner-model"][value="flux_pro"]');

    if (dalleLabel && fluxLabel) {
      dalleLabel.style.border = dalleRadio.checked ? '2px solid #667eea' : '2px solid transparent';
      dalleLabel.style.background = dalleRadio.checked ? '#f0f4ff' : '#f8f9fa';
      fluxLabel.style.border = fluxRadio.checked ? '2px solid #667eea' : '2px solid transparent';
      fluxLabel.style.background = fluxRadio.checked ? '#f0f4ff' : '#f8f9fa';
    }
  }

  // 크기 미리보기 업데이트
  function updateSizePreview() {
    const width = parseInt(document.getElementById('banner-width').value) || 100;
    const height = parseInt(document.getElementById('banner-height').value) || 100;
    const preview = document.getElementById('banner-size-preview');

    if (preview) {
      const ratio = (width / height).toFixed(2);
      let type = '정사각형';
      if (width > height * 1.2) type = '가로형';
      else if (height > width * 1.2) type = '세로형';
      preview.textContent = `비율: ${ratio}:1 (${type})`;
    }
  }

  // cm를 AI 이미지 비율로 변환
  function cmToAspectRatio(widthCm, heightCm) {
    const ratio = widthCm / heightCm;

    // DALL-E 3 지원 크기로 매핑
    if (ratio >= 1.5) {
      return { layout: 'horizontal', dalle_size: '1792x1024', flux_aspect: '16:9' };
    } else if (ratio <= 0.67) {
      return { layout: 'vertical', dalle_size: '1024x1792', flux_aspect: '9:16' };
    } else {
      return { layout: 'square', dalle_size: '1024x1024', flux_aspect: '1:1' };
    }
  }

  // 고급 옵션 토글
  function toggleAdvancedOptions() {
    const options = document.getElementById('advanced-options');
    const arrow = document.getElementById('advanced-options-arrow');
    if (options && arrow) {
      const isHidden = options.style.display === 'none';
      options.style.display = isHidden ? 'block' : 'none';
      arrow.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
    }
  }

  // AI로 프롬프트 생성
  async function generateBannerPrompt() {
    const template = document.getElementById('banner-template').value;
    const eventName = document.getElementById('banner-event-name').value;
    const theme = document.getElementById('banner-theme').value;
    const customPromptTextarea = document.getElementById('banner-custom-prompt');

    customPromptTextarea.value = '프롬프트 생성 중...';

    try {
      const response = await fetch('/api/banner/generate-prompt', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          template: template,
          event_name: eventName,
          theme: theme
        })
      });

      const data = await response.json();
      if (data.ok) {
        customPromptTextarea.value = data.prompt;
      } else {
        customPromptTextarea.value = '';
        alert('프롬프트 생성 실패: ' + data.error);
      }
    } catch (err) {
      customPromptTextarea.value = '';
      alert('네트워크 오류: ' + err.message);
    }
  }

  // 현수막 이미지 생성
  async function generateBanner() {
    const model = document.querySelector('input[name="banner-model"]:checked').value;
    const template = document.getElementById('banner-template').value;

    // cm 기반 크기에서 레이아웃 결정
    const widthCm = parseInt(document.getElementById('banner-width').value) || 500;
    const heightCm = parseInt(document.getElementById('banner-height').value) || 90;
    const sizeConfig = cmToAspectRatio(widthCm, heightCm);
    const layout = sizeConfig.layout;

    const eventName = document.getElementById('banner-event-name').value;
    const churchName = document.getElementById('banner-church-name').value;
    const schedule = document.getElementById('banner-schedule').value;
    const speaker = document.getElementById('banner-speaker').value;
    const theme = document.getElementById('banner-theme').value;
    const customPrompt = document.getElementById('banner-custom-prompt').value;
    const addText = document.getElementById('banner-add-text').checked;
    const fontId = document.getElementById('banner-font').value;

    // UI 업데이트
    const btnGenerate = document.getElementById('btn-generate-banner');
    const loadingDiv = document.getElementById('banner-loading');
    const placeholder = document.getElementById('banner-placeholder');
    const resultDiv = document.getElementById('banner-result');

    btnGenerate.disabled = true;
    btnGenerate.innerHTML = '⏳ 생성 중...';
    loadingDiv.style.display = 'block';
    placeholder.style.display = 'none';
    resultDiv.style.display = 'none';

    try {
      // 텍스트 오버레이 포함 API 사용
      const response = await fetch('/api/banner/generate-with-text', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          model: model,
          template: template,
          layout: layout,
          width_cm: widthCm,
          height_cm: heightCm,
          event_name: eventName,
          church_name: churchName,
          schedule: schedule,
          speaker: speaker,
          theme: theme,
          custom_prompt: customPrompt,
          add_text: addText,
          font_id: fontId
        })
      });

      const data = await response.json();

      if (data.ok) {
        // 결과 표시
        const bannerImage = document.getElementById('banner-image');
        const downloadLink = document.getElementById('banner-download-link');

        bannerImage.src = data.image_url;

        // Base64 이미지인 경우 다운로드 링크 처리
        if (data.image_url.startsWith('data:')) {
          downloadLink.href = data.image_url;
        } else {
          downloadLink.href = data.image_url;
        }

        // 정보 업데이트
        document.getElementById('banner-info-model').textContent = data.model;
        document.getElementById('banner-info-template').textContent = data.template;
        // 크기를 cm로 표시
        const layoutNames = { horizontal: '가로형', vertical: '세로형', square: '정사각형' };
        const layoutName = layoutNames[layout] || layout;
        document.getElementById('banner-info-layout').textContent = `${widthCm} x ${heightCm} cm (${layoutName})`;
        document.getElementById('banner-info-text').textContent = data.text_added ? '추가됨' : '없음';
        document.getElementById('banner-info-font').textContent = data.font || '-';

        resultDiv.style.display = 'block';
      } else {
        alert('이미지 생성 실패: ' + data.error);
        placeholder.style.display = 'block';
      }
    } catch (err) {
      alert('네트워크 오류: ' + err.message);
      placeholder.style.display = 'block';
    } finally {
      btnGenerate.disabled = false;
      btnGenerate.innerHTML = '🎨 배경 이미지 생성';
      loadingDiv.style.display = 'none';
    }
  }

  // 다시 생성
  function regenerateBanner() {
    generateBanner();
  }

  // ===== 참조 이미지 관리 함수 =====

  // 참조 이미지 미리보기
  function previewReferenceImage() {
    const url = document.getElementById('ref-image-url').value.trim();
    const previewContainer = document.getElementById('ref-preview-container');
    const previewImage = document.getElementById('ref-preview-image');

    if (!url) {
      alert('이미지 URL을 입력해주세요.');
      return;
    }

    previewImage.src = url;
    previewImage.onerror = () => {
      previewContainer.style.display = 'none';
      alert('이미지를 불러올 수 없습니다. URL을 확인해주세요.');
    };
    previewImage.onload = () => {
      previewContainer.style.display = 'block';
    };
  }

  // 참조 이미지 추가
  async function addReferenceImage() {
    const url = document.getElementById('ref-image-url').value.trim();
    const templateType = document.getElementById('ref-template-type').value;
    const styleTags = document.getElementById('ref-style-tags').value.trim();
    const description = document.getElementById('ref-description').value.trim();

    if (!url) {
      alert('이미지 URL을 입력해주세요.');
      return;
    }

    if (!url.startsWith('http://') && !url.startsWith('https://')) {
      alert('올바른 URL 형식이 아닙니다. (http:// 또는 https://로 시작)');
      return;
    }

    try {
      const response = await fetch('/api/banner/references', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          image_url: url,
          template_type: templateType,
          style_tags: styleTags,
          description: description
        })
      });

      const data = await response.json();

      if (data.ok) {
        alert('참조 이미지가 추가되었습니다!');
        // 입력 필드 초기화
        document.getElementById('ref-image-url').value = '';
        document.getElementById('ref-style-tags').value = '';
        document.getElementById('ref-description').value = '';
        document.getElementById('ref-preview-container').style.display = 'none';
        // 목록 새로고침
        loadReferenceImages();
      } else {
        alert('추가 실패: ' + data.error);
      }
    } catch (err) {
      alert('네트워크 오류: ' + err.message);
    }
  }

  // 참조 이미지 목록 로드
  async function loadReferenceImages() {
    try {
      const response = await fetch('/api/banner/references');
      const data = await response.json();

      const listContainer = document.getElementById('ref-images-list');
      const countBadge = document.getElementById('ref-count-badge');

      if (data.ok && data.references.length > 0) {
        countBadge.textContent = data.count + '개';

        const templateNames = {
          general: '일반', revival: '부흥회', christmas: '성탄절',
          easter: '부활절', thanksgiving: '추수감사절', new_year: '신년/송년',
          special_service: '특별집회', bible_school: '성경학교',
          baptism: '세례/침례', ordination: '임직/취임', mission: '선교/전도'
        };

        let html = '<div style="display: flex; flex-direction: column; gap: .5rem;">';

        data.references.forEach(ref => {
          const templateName = templateNames[ref.template_type] || ref.template_type;
          const tags = ref.style_tags ? ref.style_tags.split(',').slice(0, 3).join(', ') : '';
          const colors = ref.color_palette ? ref.color_palette.split(',').slice(0, 3) : [];

          html += `
            <div style="display: flex; gap: .75rem; padding: .75rem; background: #f8f9fa; border-radius: 8px; align-items: center;">
              <img src="${ref.image_url}" style="width: 80px; height: 50px; object-fit: cover; border-radius: 4px; cursor: pointer;" onclick="window.open('${ref.image_url}', '_blank')" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/><text fill=%22%23999%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22>No Image</text></svg>'">
              <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; font-size: .85rem; color: #333;">${templateName}</div>
                ${tags ? `<div style="font-size: .75rem; color: #666; margin-top: .2rem;">${tags}</div>` : ''}
                ${colors.length > 0 ? `
                  <div style="display: flex; gap: .2rem; margin-top: .3rem;">
                    ${colors.map(c => `<span style="width: 16px; height: 16px; border-radius: 3px; background: ${c}; border: 1px solid #ddd;"></span>`).join('')}
                  </div>
                ` : ''}
              </div>
              <div style="display: flex; flex-direction: column; gap: .3rem;">
                <div style="font-size: .7rem; color: #888;">품질: ${ref.quality_score}/10</div>
                <button onclick="deleteReferenceImage(${ref.id})" style="padding: .3rem .5rem; background: #fee2e2; color: #dc2626; border: none; border-radius: 4px; cursor: pointer; font-size: .7rem;">삭제</button>
              </div>
            </div>
          `;
        });

        html += '</div>';
        listContainer.innerHTML = html;
      } else {
        countBadge.textContent = '0개';
        listContainer.innerHTML = `
          <div style="text-align: center; color: #888; padding: 2rem; font-size: .85rem;">
            등록된 참조 이미지가 없습니다.<br>
            좋은 현수막 이미지 URL을 추가해주세요.
          </div>
        `;
      }
    } catch (err) {
      console.error('참조 이미지 로드 실패:', err);
    }
  }

  // 참조 이미지 삭제
  async function deleteReferenceImage(refId) {
    if (!confirm('이 참조 이미지를 삭제하시겠습니까?')) {
      return;
    }

    try {
      const response = await fetch(`/api/banner/references/${refId}`, {
        method: 'DELETE'
      });

      const data = await response.json();

      if (data.ok) {
        loadReferenceImages();
      } else {
        alert('삭제 실패: ' + data.error);
      }
    } catch (err) {
      alert('네트워크 오류: ' + err.message);
    }
  }

  // 페이지 로드 시 참조 이미지 목록 로드
  document.addEventListener('DOMContentLoaded', function() {
    // 디자인 도우미가 활성화될 때 참조 이미지 로드
    const designHelperContent = document.getElementById('design-helper-content');
    if (designHelperContent) {
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.attributeName === 'style') {
            const display = window.getComputedStyle(designHelperContent).display;
            if (display !== 'none') {
              loadReferenceImages();
            }
          }
        });
      });
      observer.observe(designHelperContent, { attributes: true });
    }
  });

  // ===== 웹사이트 크롤링 함수 =====

  // 크롤링된 이미지 데이터 저장
  let crawledImages = [];

  // 웹사이트에서 이미지 크롤링
  async function crawlImages() {
    const url = document.getElementById('crawl-url').value.trim();
    if (!url) {
      alert('웹사이트 URL을 입력해주세요.');
      return;
    }

    const btnCrawl = document.getElementById('btn-crawl');
    const loadingDiv = document.getElementById('crawl-loading');
    const resultDiv = document.getElementById('crawl-result');

    btnCrawl.disabled = true;
    btnCrawl.textContent = '수집 중...';
    loadingDiv.style.display = 'block';
    resultDiv.style.display = 'none';

    try {
      const response = await fetch('/api/banner/crawl', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ url: url })
      });

      const data = await response.json();

      if (data.ok && data.images.length > 0) {
        crawledImages = data.images;
        document.getElementById('crawl-count').textContent = `${data.count}개 이미지 발견`;

        // 이미지 그리드 표시
        const imagesContainer = document.getElementById('crawl-images');
        let html = '';

        data.images.forEach((img, index) => {
          html += `
            <div class="crawl-image-item" style="position: relative; cursor: pointer;" onclick="toggleCrawlImage(${index})">
              <img src="${img.url}" style="width: 100%; height: 80px; object-fit: cover; border-radius: 4px; border: 2px solid transparent;"
                   id="crawl-img-${index}"
                   onerror="this.parentElement.style.display='none'">
              <input type="checkbox" id="crawl-check-${index}" style="position: absolute; top: 4px; right: 4px; width: 18px; height: 18px;">
            </div>
          `;
        });

        imagesContainer.innerHTML = html;
        resultDiv.style.display = 'block';
      } else if (data.ok && data.images.length === 0) {
        alert('이미지를 찾을 수 없습니다. 다른 페이지를 시도해보세요.');
      } else {
        alert('크롤링 실패: ' + data.error);
      }
    } catch (err) {
      alert('네트워크 오류: ' + err.message);
    } finally {
      btnCrawl.disabled = false;
      btnCrawl.textContent = '🔍 수집';
      loadingDiv.style.display = 'none';
    }
  }

  // 크롤링된 이미지 선택 토글
  function toggleCrawlImage(index) {
    const checkbox = document.getElementById(`crawl-check-${index}`);
    const img = document.getElementById(`crawl-img-${index}`);

    checkbox.checked = !checkbox.checked;
    img.style.border = checkbox.checked ? '2px solid #f59e0b' : '2px solid transparent';
  }

  // 전체 선택/해제
  function selectAllCrawled(select) {
    crawledImages.forEach((_, index) => {
      const checkbox = document.getElementById(`crawl-check-${index}`);
      const img = document.getElementById(`crawl-img-${index}`);
      if (checkbox) {
        checkbox.checked = select;
        img.style.border = select ? '2px solid #f59e0b' : '2px solid transparent';
      }
    });
  }

  // 선택한 이미지 일괄 등록
  async function bulkAddCrawledImages() {
    const selectedImages = [];

    crawledImages.forEach((img, index) => {
      const checkbox = document.getElementById(`crawl-check-${index}`);
      if (checkbox && checkbox.checked) {
        selectedImages.push(img);
      }
    });

    if (selectedImages.length === 0) {
      alert('등록할 이미지를 선택해주세요.');
      return;
    }

    const templateType = document.getElementById('crawl-template-type').value;
    const styleTags = document.getElementById('crawl-style-tags').value.trim();

    const btnBulkAdd = document.getElementById('btn-bulk-add');
    btnBulkAdd.disabled = true;
    btnBulkAdd.textContent = `⏳ ${selectedImages.length}개 등록 중...`;

    try {
      const response = await fetch('/api/banner/references/bulk', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          images: selectedImages,
          template_type: templateType,
          style_tags: styleTags
        })
      });

      const data = await response.json();

      if (data.ok) {
        alert(`${data.added}개 이미지가 등록되었습니다!` + (data.failed > 0 ? ` (${data.failed}개 실패)` : ''));

        // 결과 초기화
        document.getElementById('crawl-result').style.display = 'none';
        document.getElementById('crawl-url').value = '';
        crawledImages = [];

        // 참조 이미지 목록 새로고침
        loadReferenceImages();
      } else {
        alert('등록 실패: ' + data.error);
      }
    } catch (err) {
      alert('네트워크 오류: ' + err.message);
    } finally {
      btnBulkAdd.disabled = false;
      btnBulkAdd.textContent = '📥 선택한 이미지 일괄 등록';
    }
  }
  </script>
</body>
</html>
