<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë¬µìƒ ë©”ì‹œì§€ ìƒì„±ê¸°</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; 
      background: #0f172a;
      color: #e2e8f0;
    }
    .page-wrap { 
      display: flex; 
      gap: 1rem; 
      padding: 1rem; 
      min-height: 100vh;
    }
    .left-col { 
      width: 360px; 
      display: flex; 
      flex-direction: column; 
      gap: .75rem; 
    }
    .right-col { 
      flex: 1; 
      display: flex; 
      flex-direction: column; 
      gap: .75rem; 
      min-width: 0; 
    }
    .box { 
      background: #1e293b; 
      border: 1px solid #334155; 
      border-radius: 12px; 
      padding: 1rem; 
    }
    .label { 
      font-weight: 600; 
      margin-bottom: .5rem; 
      display: block;
      color: #f1f5f9;
    }
    input[type="text"], input[type="number"], select { 
      width: 100%; 
      padding: .5rem; 
      background: #0f172a; 
      border: 1px solid #475569; 
      border-radius: 8px; 
      color: #e2e8f0;
      font-size: 0.95rem;
    }
    textarea { 
      width: 100%; 
      min-height: 80px; 
      resize: vertical; 
      box-sizing: border-box; 
      font-family: inherit; 
      line-height: 1.6; 
      padding: .75rem;
      background: #0f172a; 
      border: 1px solid #475569; 
      border-radius: 8px; 
      color: #e2e8f0;
      font-size: 0.95rem;
    }
    textarea.autosize { overflow: hidden; }
    
    .date-input {
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    .date-input input {
      width: 70px;
      text-align: center;
    }
    .date-input span {
      color: #94a3b8;
    }
    
    .btn-row { 
      display: flex; 
      gap: .5rem; 
      flex-wrap: wrap; 
    }
    button { 
      padding: .6rem 1rem; 
      border: 1px solid #3b82f6; 
      background: #2563eb; 
      border-radius: 8px; 
      cursor: pointer; 
      color: white;
      font-weight: 500;
      transition: all 0.2s;
    }
    button:hover { 
      background: #1d4ed8; 
      transform: translateY(-1px);
    }
    button.secondary {
      background: #475569;
      border-color: #64748b;
    }
    button.secondary:hover {
      background: #334155;
    }
    
    .toggle-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: .75rem;
    }
    .copy-btn { 
      font-size: .85rem; 
      padding: .35rem .7rem; 
      background: #0f172a; 
      border: 1px solid #475569;
    }
    .status-bar { 
      position: fixed; 
      bottom: 20px; 
      right: 20px; 
      background: #1e293b; 
      border: 1px solid #3b82f6; 
      border-radius: 8px; 
      padding: .75rem 1.25rem; 
      font-size: .9rem; 
      box-shadow: 0 4px 12px rgba(0,0,0,.3); 
      display: none;
      color: #60a5fa;
    }
    .guide-tabs {
      display: flex;
      gap: .5rem;
      margin-bottom: .75rem;
    }
    .guide-tab {
      padding: .5rem 1rem;
      background: #0f172a;
      border: 1px solid #475569;
      border-radius: 8px;
      cursor: pointer;
      font-size: .9rem;
      transition: all 0.2s;
    }
    .guide-tab.active {
      background: #2563eb;
      border-color: #3b82f6;
      color: white;
    }
    .guide-content {
      display: none;
    }
    .guide-content.active {
      display: block;
    }
    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: .75rem;
    }
    .message-actions {
      display: flex;
      gap: .5rem;
    }
    .split-boxes {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    @media (max-width: 1200px) {
      .split-boxes {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="page-wrap">
    <!-- ì™¼ìª½ -->
    <div class="left-col">
      <!-- ë‚ ì§œ -->
      <div class="box">
        <label class="label">ë‚ ì§œ</label>
        <div class="date-input">
          <input type="number" id="month" min="1" max="12" value="11">
          <span>ì›”</span>
          <input type="number" id="day" min="1" max="31" value="12">
          <span>ì¼ (<span id="day-of-week">ìˆ˜</span>)</span>
        </div>
      </div>

      <!-- ë³¸ë¬¸ -->
      <div class="box">
        <label class="label">ë³¸ë¬¸</label>
        <input type="text" id="bible-ref" placeholder="ì˜ˆ: ë ˆìœ„ê¸° 26:13">
      </div>

      <!-- ë³¸ë¬¸ ë‚´ìš© -->
      <div class="box">
        <label class="label">ë³¸ë¬¸ ë‚´ìš©</label>
        <textarea id="bible-text" class="autosize" placeholder="ì„±ê²½ êµ¬ì ˆ ì „ì²´ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
      </div>

      <!-- ë©”ì‹œì§€ ìƒì„± ë²„íŠ¼ -->
      <div class="box">
        <div class="btn-row">
          <button id="btn-morning">â˜€ï¸ ì˜¤ì „ ë©”ì‹œì§€</button>
          <button id="btn-evening">ğŸŒ™ ì €ë… ë©”ì‹œì§€</button>
        </div>
      </div>

      <!-- ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ìƒì„± ë²„íŠ¼ -->
      <div class="box">
        <div class="btn-row">
          <button id="btn-morning-img" class="secondary">ğŸ–¼ï¸ ì˜¤ì „ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸</button>
          <button id="btn-evening-img" class="secondary">ğŸ–¼ï¸ ì €ë… ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸</button>
        </div>
      </div>

      <!-- ìƒì„± ìƒíƒœ -->
      <div id="status-indicator" style="text-align: center; color: #60a5fa; display: none;">
        â³ GPT ìƒì„± ì¤‘...
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½ -->
    <div class="right-col">
      <!-- ì§€ì¹¨ ì˜ì—­ -->
      <div class="box" id="guide-box">
        <div class="toggle-header">
          <span class="label">ì§€ì¹¨ ì˜ì—­</span>
          <button id="toggle-guides" class="secondary">ë‹«ê¸°</button>
        </div>
        <div id="guide-inner">
          <div class="guide-tabs">
            <button class="guide-tab active" data-tab="morning">ì˜¤ì „ ì§€ì¹¨</button>
            <button class="guide-tab" data-tab="evening">ì €ë… ì§€ì¹¨</button>
            <button class="guide-tab" data-tab="image">ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ì§€ì¹¨</button>
            <button class="guide-tab" data-tab="translate">ë²ˆì—­ ì§€ì¹¨</button>
          </div>
          <div class="guide-content active" data-content="morning">
            <textarea id="guide-morning" class="autosize" placeholder="ì˜¤ì „ ë©”ì‹œì§€ ìƒì„± ì§€ì¹¨ì„ ì‘ì„±í•˜ì„¸ìš”."></textarea>
          </div>
          <div class="guide-content" data-content="evening">
            <textarea id="guide-evening" class="autosize" placeholder="ì €ë… ë©”ì‹œì§€ ìƒì„± ì§€ì¹¨ì„ ì‘ì„±í•˜ì„¸ìš”."></textarea>
          </div>
          <div class="guide-content" data-content="image">
            <textarea id="guide-image" class="autosize" placeholder="ì´ë¯¸ì§€ëŠ” ë§‘ìŒ ëª©ìƒ ë©”ì‹œì§€ ë°°ê²½ìœ¼ë¡œ ì‚¬ìš©í• ê±°ì•¼. ì‚¬ì›ì´ë‚˜ ì ˆ, ì´ìŠ¬ëŒ ë“± ê¸°ë…êµê°€ ì•„ë‹Œ ë‹¤ë¥¸ ì¢…êµì  ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ë©´ ì•ˆëœë‹¤."></textarea>
          </div>
          <div class="guide-content" data-content="translate">
            <textarea id="guide-translate" class="autosize" placeholder="ë²ˆì—­ ì§€ì¹¨ì„ ì‘ì„±í•˜ì„¸ìš”."></textarea>
          </div>
          <button id="save-guide" style="margin-top: .75rem;">ğŸ’¾ ì§€ì¹¨ ì €ì¥</button>
        </div>
      </div>

      <!-- ë©”ì‹œì§€ ì¶œë ¥ -->
      <div class="split-boxes">
        <div class="box">
          <div class="message-header">
            <label class="label">ì˜¤ì „ ë©”ì‹œì§€</label>
            <div class="message-actions">
              <button class="copy-btn" data-copy="morning-message">ğŸ“‹ ë³µì‚¬</button>
              <button class="copy-btn" data-translate="morning" data-lang="en">ğŸŒ ì˜ì–´</button>
              <button class="copy-btn" data-translate="morning" data-lang="ja">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´</button>
            </div>
          </div>
          <textarea id="morning-message" class="autosize" placeholder="ì˜¤ì „ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤." readonly></textarea>
        </div>

        <div class="box">
          <div class="message-header">
            <label class="label">ì €ë… ë©”ì‹œì§€</label>
            <div class="message-actions">
              <button class="copy-btn" data-copy="evening-message">ğŸ“‹ ë³µì‚¬</button>
              <button class="copy-btn" data-translate="evening" data-lang="en">ğŸŒ ì˜ì–´</button>
              <button class="copy-btn" data-translate="evening" data-lang="ja">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´</button>
            </div>
          </div>
          <textarea id="evening-message" class="autosize" placeholder="ì €ë… ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤." readonly></textarea>
        </div>
      </div>

      <!-- ë²ˆì—­ -->
      <div class="box">
        <div class="toggle-header">
          <label class="label">ë²ˆì—­</label>
          <button class="copy-btn" data-copy="translation">ğŸ“‹ ë³µì‚¬</button>
        </div>
        <textarea id="translation" class="autosize" placeholder="ë²ˆì—­ëœ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤." readonly></textarea>
      </div>

<!-- ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ -->
<div class="split-boxes">
  <div class="box">
    <label class="label" style="margin-bottom: 1rem;">ì˜¤ì „ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸</label>
    
    <div style="margin-bottom: 1rem;">
      <div class="toggle-header" style="margin-bottom: .5rem;">
        <span style="font-size: .9rem; color: #94a3b8;">Image Prompt 1</span>
        <button class="copy-btn" data-copy="morning-img-1">ğŸ“‹ ë³µì‚¬</button>
      </div>
      <textarea id="morning-img-1" class="autosize" style="min-height: 60px;" placeholder="Image prompt 1" readonly></textarea>
    </div>

    <div style="margin-bottom: 1rem;">
      <div class="toggle-header" style="margin-bottom: .5rem;">
        <span style="font-size: .9rem; color: #94a3b8;">Image Prompt 2</span>
        <button class="copy-btn" data-copy="morning-img-2">ğŸ“‹ ë³µì‚¬</button>
      </div>
      <textarea id="morning-img-2" class="autosize" style="min-height: 60px;" placeholder="Image prompt 2" readonly></textarea>
    </div>

    <div style="margin-bottom: 1rem;">
      <div class="toggle-header" style="margin-bottom: .5rem;">
        <span style="font-size: .9rem; color: #94a3b8;">Image Prompt 3</span>
        <button class="copy-btn" data-copy="morning-img-3">ğŸ“‹ ë³µì‚¬</button>
      </div>
      <textarea id="morning-img-3" class="autosize" style="min-height: 60px;" placeholder="Image prompt 3" readonly></textarea>
    </div>

    <div>
      <div class="toggle-header" style="margin-bottom: .5rem;">
        <span style="font-size: .9rem; color: #94a3b8;">Music Prompt</span>
        <button class="copy-btn" data-copy="morning-music">ğŸ“‹ ë³µì‚¬</button>
      </div>
      <textarea id="morning-music" class="autosize" style="min-height: 60px;" placeholder="Music prompt" readonly></textarea>
    </div>
  </div>

  <div class="box">
    <label class="label" style="margin-bottom: 1rem;">ì €ë… ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸</label>
    
    <div style="margin-bottom: 1rem;">
      <div class="toggle-header" style="margin-bottom: .5rem;">
        <span style="font-size: .9rem; color: #94a3b8;">Image Prompt 1</span>
        <button class="copy-btn" data-copy="evening-img-1">ğŸ“‹ ë³µì‚¬</button>
      </div>
      <textarea id="evening-img-1" class="autosize" style="min-height: 60px;" placeholder="Image prompt 1" readonly></textarea>
    </div>

    <div style="margin-bottom: 1rem;">
      <div class="toggle-header" style="margin-bottom: .5rem;">
        <span style="font-size: .9rem; color: #94a3b8;">Image Prompt 2</span>
        <button class="copy-btn" data-copy="evening-img-2">ğŸ“‹ ë³µì‚¬</button>
      </div>
      <textarea id="evening-img-2" class="autosize" style="min-height: 60px;" placeholder="Image prompt 2" readonly></textarea>
    </div>

    <div style="margin-bottom: 1rem;">
      <div class="toggle-header" style="margin-bottom: .5rem;">
        <span style="font-size: .9rem; color: #94a3b8;">Image Prompt 3</span>
        <button class="copy-btn" data-copy="evening-img-3">ğŸ“‹ ë³µì‚¬</button>
      </div>
      <textarea id="evening-img-3" class="autosize" style="min-height: 60px;" placeholder="Image prompt 3" readonly></textarea>
    </div>

    <div>
      <div class="toggle-header" style="margin-bottom: .5rem;">
        <span style="font-size: .9rem; color: #94a3b8;">Music Prompt</span>
        <button class="copy-btn" data-copy="evening-music">ğŸ“‹ ë³µì‚¬</button>
      </div>
      <textarea id="evening-music" class="autosize" style="min-height: 60px;" placeholder="Music prompt" readonly></textarea>
    </div>
  </div>
</div>
  <!-- ì§„í–‰ ìƒíƒœ -->
  <div id="status-bar" class="status-bar">ì‘ì—… ì¤‘...</div>

<!-- Firebase SDK ì¶”ê°€ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  
  <script>
  // ===== Firebase ì´ˆê¸°í™” =====
  const firebaseConfig = {
    apiKey: "AIzaSyBacmJDk-PG5FaoqnXV8Rg3P__AKOS2vu4",
    authDomain: "my-sermon-guides.firebaseapp.com",
    projectId: "my-sermon-guides",
    storageBucket: "my-sermon-guides.firebasestorage.app",
    messagingSenderId: "539520456089",
    appId: "1:539520456089:web:d6aceb7838baa89e70af08",
    measurementId: "G-KWN8TH7Z26"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  
  const USER_CODE = 'samuel123';
  const PAGE_NAME = 'message';

  // ===== ì „ì—­ ë³€ìˆ˜ =====
  let currentGuideTab = 'morning'; // í˜„ì¬ í™œì„±í™”ëœ íƒ­

  // ===== ìë™ ë†’ì´ ì¡°ì ˆ =====
  function autoResize(el) {
    if (!el) return;
    el.style.height = 'auto';
    el.style.height = el.scrollHeight + 'px';
  }

  // ===== ìš”ì¼ ê³„ì‚° =====
  function updateDayOfWeek() {
    const month = parseInt(document.getElementById('month').value);
    const day = parseInt(document.getElementById('day').value);
    const year = new Date().getFullYear();
    const date = new Date(year, month - 1, day);
    const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    document.getElementById('day-of-week').textContent = days[date.getDay()];
  }

  document.getElementById('month').addEventListener('change', updateDayOfWeek);
  document.getElementById('day').addEventListener('change', updateDayOfWeek);

  // ===== ìƒíƒœ í‘œì‹œ =====
  const statusBar = document.getElementById('status-bar');
  function showStatus(msg) {
    statusBar.textContent = msg;
    statusBar.style.display = 'block';
  }
  function hideStatus() {
    statusBar.style.display = 'none';
  }

  // ===== Firebase í•¨ìˆ˜ =====
  
  async function loadFromFirebase() {
    try {
      const snapshot = await db
        .collection('users')
        .doc(USER_CODE)
        .collection(PAGE_NAME)
        .get();
      
      let loadedCount = 0;
      if (!snapshot.empty) {
        snapshot.forEach(doc => {
          const key = doc.id;
          const value = doc.data().value;
          localStorage.setItem(key, value);
          loadedCount++;
        });
        console.log(`âœ… Firebaseì—ì„œ ${loadedCount}ê°œ ì§€ì¹¨ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!`);
        return true;
      } else {
        console.log('Firebaseì— ì €ì¥ëœ ì§€ì¹¨ì´ ì—†ìŠµë‹ˆë‹¤.');
        return false;
      }
    } catch (err) {
      console.error('Firebase ë¡œë“œ ì‹¤íŒ¨:', err);
      return false;
    }
  }

  async function saveToFirebase(key, value) {
    try {
      await db
        .collection('users')
        .doc(USER_CODE)
        .collection(PAGE_NAME)
        .doc(key)
        .set({
          value: value,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      return true;
    } catch (err) {
      console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', err);
      return false;
    }
  }

  // ===== ì§€ì¹¨ ê´€ë¦¬ =====
  
  function getGuideKey(category) {
    return `message-guide-${category}`;
  }

  // ì§€ì¹¨ íƒ­ ì „í™˜
  document.querySelectorAll('.guide-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
      document.querySelectorAll('.guide-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.guide-content').forEach(c => c.classList.remove('active'));
      
      // í´ë¦­í•œ íƒ­ í™œì„±í™”
      tab.classList.add('active');
      const tabName = tab.dataset.tab;
      currentGuideTab = tabName;
      
      const content = document.querySelector(`.guide-content[data-content="${tabName}"]`);
      if (content) {
        content.classList.add('active');
      }
      
      // í•´ë‹¹ ì§€ì¹¨ ë¶ˆëŸ¬ì˜¤ê¸°
      loadGuide(tabName);
    });
  });

  // íŠ¹ì • ì§€ì¹¨ ë¶ˆëŸ¬ì˜¤ê¸°
  function loadGuide(category) {
    const key = getGuideKey(category);
    const stored = localStorage.getItem(key) || '';
    const textarea = document.getElementById(`guide-${category}`);
    if (textarea) {
      textarea.value = stored;
      autoResize(textarea);
    }
  }

  // ëª¨ë“  ì§€ì¹¨ ë¶ˆëŸ¬ì˜¤ê¸°
  function loadAllGuides() {
    ['morning', 'evening', 'image', 'translate'].forEach(cat => {
      loadGuide(cat);
    });
  }

  // ì§€ì¹¨ ì €ì¥
  document.getElementById('save-guide').addEventListener('click', async () => {
    const textarea = document.getElementById(`guide-${currentGuideTab}`);
    if (!textarea) {
      alert('ì˜¤ë¥˜: ì§€ì¹¨ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    const value = textarea.value;
    const key = getGuideKey(currentGuideTab);
    
    // localStorage ì €ì¥
    localStorage.setItem(key, value);
    
    // Firebase ì €ì¥
    showStatus('ğŸ’¾ ì €ì¥ ì¤‘...');
    const success = await saveToFirebase(key, value);
    
    if (success) {
      showStatus('âœ… ì§€ì¹¨ì´ ì €ì¥ë˜ê³  í´ë¼ìš°ë“œì— ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
    } else {
      showStatus('âš ï¸ ë¡œì»¬ì—ë§Œ ì €ì¥ë¨ (í´ë¼ìš°ë“œ ë™ê¸°í™” ì‹¤íŒ¨)');
    }
    
    setTimeout(hideStatus, 2000);
  });

  // ===== ì§€ì¹¨ ì˜ì—­ í† ê¸€ =====
  
  let guidesVisible = true;
  document.getElementById('toggle-guides').addEventListener('click', () => {
    const inner = document.getElementById('guide-inner');
    const btn = document.getElementById('toggle-guides');
    
    guidesVisible = !guidesVisible;
    inner.style.display = guidesVisible ? 'block' : 'none';
    btn.textContent = guidesVisible ? 'ë‹«ê¸°' : 'ì—´ê¸°';
  });

  // ===== ë³µì‚¬ ê¸°ëŠ¥ =====
  
  document.querySelectorAll('[data-copy]').forEach(btn => {
    btn.addEventListener('click', () => {
      const targetId = btn.dataset.copy;
      const textarea = document.getElementById(targetId);
      if (!textarea) return;
      
      textarea.select();
      document.execCommand('copy');
      
      const originalText = btn.textContent;
      btn.textContent = 'âœ… ë³µì‚¬ë¨!';
      setTimeout(() => {
        btn.textContent = originalText;
      }, 1500);
    });
  });

  // ===== ë©”ì‹œì§€ ìƒì„± =====
  
  async function generateMessage(timeOfDay) {
    const month = document.getElementById('month').value;
    const day = document.getElementById('day').value;
    const dayOfWeek = document.getElementById('day-of-week').textContent;
    const bibleRef = document.getElementById('bible-ref').value;
    const bibleText = document.getElementById('bible-text').value;
    const guideKey = getGuideKey(timeOfDay);
    const guide = localStorage.getItem(guideKey) || '';

    if (!bibleRef || !bibleText) {
      alert('ë³¸ë¬¸ê³¼ ë³¸ë¬¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    const statusIndicator = document.getElementById('status-indicator');
    statusIndicator.style.display = 'block';
    showStatus(`${timeOfDay === 'morning' ? 'â˜€ï¸ ì˜¤ì „' : 'ğŸŒ™ ì €ë…'} ë©”ì‹œì§€ ìƒì„± ì¤‘...`);

    try {
      const response = await fetch('/api/message/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          month: month,
          day: day,
          day_of_week: dayOfWeek,
          bible_ref: bibleRef,
          bible_text: bibleText,
          time_of_day: timeOfDay,
          guide: guide
        })
      });
      
      const data = await response.json();

      if (data.ok) {
        const outputId = `${timeOfDay}-message`;
        const textarea = document.getElementById(outputId);
        textarea.value = data.message;
        autoResize(textarea);
        showStatus('âœ… ë©”ì‹œì§€ ìƒì„± ì™„ë£Œ! ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...');

        // ë©”ì‹œì§€ ìƒì„± ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ìƒì„±
        statusIndicator.style.display = 'none';
        await generateImagePrompts(timeOfDay);
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
        showStatus('âŒ ìƒì„± ì‹¤íŒ¨');
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
      showStatus('âŒ ì˜¤ë¥˜ ë°œìƒ');
    } finally {
      statusIndicator.style.display = 'none';
      setTimeout(hideStatus, 2000);
    }
  }

  document.getElementById('btn-morning').addEventListener('click', () => generateMessage('morning'));
  document.getElementById('btn-evening').addEventListener('click', () => generateMessage('evening'));

  // ===== ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ìƒì„± =====
  
  async function generateImagePrompts(timeOfDay) {
    const month = document.getElementById('month').value;
    const day = document.getElementById('day').value;
    const bibleRef = document.getElementById('bible-ref').value;
    const bibleText = document.getElementById('bible-text').value;
    const messageTextarea = document.getElementById(`${timeOfDay}-message`);
    const message = messageTextarea.value;
    const guideKey = getGuideKey('image');
    const guide = localStorage.getItem(guideKey) || '';
    
    if (!message) {
      alert(`ë¨¼ì € ${timeOfDay === 'morning' ? 'ì˜¤ì „' : 'ì €ë…'} ë©”ì‹œì§€ë¥¼ ìƒì„±í•˜ì„¸ìš”.`);
      return;
    }
    
    const statusIndicator = document.getElementById('status-indicator');
    statusIndicator.style.display = 'block';
    showStatus(`ğŸ–¼ï¸ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...`);
    
    try {
      const response = await fetch('/api/message/image-prompts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          month: month,
          day: day,
          bible_ref: bibleRef,
          bible_text: bibleText,
          message: message,
          time_of_day: timeOfDay,
          guide: guide
        })
      });
      
      const data = await response.json();
      
      if (data.ok) {
        document.getElementById(`${timeOfDay}-img-1`).value = data.image1;
        document.getElementById(`${timeOfDay}-img-2`).value = data.image2;
        document.getElementById(`${timeOfDay}-img-3`).value = data.image3;
        document.getElementById(`${timeOfDay}-music`).value = data.music;
        
        [1, 2, 3].forEach(i => {
          autoResize(document.getElementById(`${timeOfDay}-img-${i}`));
        });
        autoResize(document.getElementById(`${timeOfDay}-music`));
        
        showStatus('âœ… ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ!');
      } else {
        alert(`ì˜¤ë¥˜: ${data.error}`);
        showStatus('âŒ ìƒì„± ì‹¤íŒ¨');
      }
    } catch (err) {
      alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
      showStatus('âŒ ì˜¤ë¥˜ ë°œìƒ');
    } finally {
      statusIndicator.style.display = 'none';
      setTimeout(hideStatus, 2000);
    }
  }

  document.getElementById('btn-morning-img').addEventListener('click', () => generateImagePrompts('morning'));
  document.getElementById('btn-evening-img').addEventListener('click', () => generateImagePrompts('evening'));

  // ===== ë²ˆì—­ =====
  
  document.querySelectorAll('[data-translate]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const timeOfDay = btn.dataset.translate;
      const lang = btn.dataset.lang;
      const messageTextarea = document.getElementById(`${timeOfDay}-message`);
      const message = messageTextarea.value;
      const guideKey = getGuideKey('translate');
      const guide = localStorage.getItem(guideKey) || '';
      
      if (!message) {
        alert('ë¨¼ì € ë©”ì‹œì§€ë¥¼ ìƒì„±í•˜ì„¸ìš”.');
        return;
      }
      
      showStatus(`ğŸŒ ë²ˆì—­ ì¤‘...`);
      
      try {
        const response = await fetch('/api/message/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            text: message,
            target_lang: lang,
            guide: guide
          })
        });
        
        const data = await response.json();
        
        if (data.ok) {
          const translationTextarea = document.getElementById('translation');
          translationTextarea.value = data.translation;
          autoResize(translationTextarea);
          showStatus('âœ… ë²ˆì—­ ì™„ë£Œ!');
        } else {
          alert(`ì˜¤ë¥˜: ${data.error}`);
          showStatus('âŒ ë²ˆì—­ ì‹¤íŒ¨');
        }
      } catch (err) {
        alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
        showStatus('âŒ ì˜¤ë¥˜ ë°œìƒ');
      } finally {
        setTimeout(hideStatus, 2000);
      }
    });
  });

  // ===== textarea ìë™ ë†’ì´ =====
  
  document.querySelectorAll('textarea.autosize').forEach(textarea => {
    textarea.addEventListener('input', () => autoResize(textarea));
  });

  // ===== í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” =====
  
  document.addEventListener('DOMContentLoaded', async () => {
    // ìš”ì¼ ì—…ë°ì´íŠ¸
    updateDayOfWeek();
    
    // Firebaseì—ì„œ ì§€ì¹¨ ë¶ˆëŸ¬ì˜¤ê¸°
    showStatus('â˜ï¸ í´ë¼ìš°ë“œ ë™ê¸°í™” ì¤‘...');
    await loadFromFirebase();
    hideStatus();
    
    // ëª¨ë“  ì§€ì¹¨ í™”ë©´ì— í‘œì‹œ
    loadAllGuides();
    
    // ëª¨ë“  textarea ë†’ì´ ì¡°ì ˆ
    document.querySelectorAll('textarea').forEach(autoResize);
  });
  </script>
</body>
</html>