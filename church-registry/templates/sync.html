{% extends "base.html" %}

{% block title %}god4u 동기화{% endblock %}

{% block content %}
<div class="container">
    <!-- 페이지 헤더 -->
    <div class="page-header">
        <div>
            <h1 class="page-title">
                <i class="bi bi-arrow-repeat"></i>
                god4u 동기화
            </h1>
            <p class="page-subtitle">god4u 교적 데이터를 가져옵니다 (단방향, 읽기 전용)</p>
        </div>
    </div>

    <!-- 쿠키 입력 섹션 -->
    <div class="form-section" style="margin-bottom: 24px;">
        <div class="form-section-title">
            <i class="bi bi-key"></i>
            god4u 인증
        </div>
        <p style="color: var(--apple-text-secondary); margin-bottom: 20px;">
            god4u에 로그인한 후, 브라우저 개발자 도구에서 쿠키를 복사하여 입력하세요.
        </p>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">ASP.NET_SessionId</label>
                <input type="text" id="sessionId" class="form-control" placeholder="xgsyv0zp5q0b14znzorohsk2">
                <small style="color: var(--apple-text-secondary); font-size: 12px;">F12 → Application → Cookies에서 복사</small>
            </div>
            <div class="form-group">
                <label class="form-label">pastorinfo</label>
                <input type="text" id="pastorinfo" class="form-control" placeholder="sUser=...&sID=...">
                <small style="color: var(--apple-text-secondary); font-size: 12px;">F12 → Application → Cookies에서 복사</small>
            </div>
        </div>

        <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
            <button onclick="testConnection()" class="apple-btn apple-btn-secondary">
                <i class="bi bi-plug"></i> 연결 테스트
            </button>
            <span id="connectionStatus"></span>
        </div>
    </div>

    <!-- 백업 섹션 -->
    <div class="form-section" style="margin-bottom: 24px; border-left: 4px solid #f59e0b;">
        <div class="form-section-title">
            <i class="bi bi-shield-check"></i>
            1단계: 백업 (권장)
        </div>
        <p style="color: var(--apple-text-secondary); margin-bottom: 16px;">
            동기화 전 백업하면 문제 발생 시 복원할 수 있습니다.
        </p>

        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <button onclick="backupGod4u()" class="apple-btn apple-btn-secondary" style="background: #fef3c7; color: #92400e; border: 1px solid #fcd34d;">
                <i class="bi bi-download"></i> god4u 백업 다운로드
            </button>
            <button onclick="backupRegistry()" class="apple-btn apple-btn-secondary">
                <i class="bi bi-download"></i> church-registry 백업
            </button>
        </div>

        <div id="backupStatus" style="margin-top: 12px;"></div>
    </div>

    <!-- 동기화 섹션 -->
    <div class="form-section" style="margin-bottom: 24px;">
        <div class="form-section-title">
            <i class="bi bi-cloud-download"></i>
            2단계: 데이터 가져오기
        </div>
        <p style="color: var(--apple-text-secondary); margin-bottom: 16px;">
            god4u의 교적 데이터를 이 시스템으로 가져옵니다.
        </p>

        <div class="apple-alert success" style="background: #dbeafe; color: #1e40af; margin-bottom: 20px;">
            <i class="bi bi-shield-check"></i>
            <strong>안전 모드:</strong> god4u 데이터는 변경되지 않습니다. 읽기만 합니다.
        </div>

        <button onclick="syncFromGod4u()" class="btn-submit" style="font-size: 16px; padding: 16px 32px;">
            <i class="bi bi-cloud-download"></i> god4u에서 가져오기
        </button>
    </div>

    <!-- 진행 상황 -->
    <div class="form-section" id="progressCard" style="display: none;">
        <div class="form-section-title">
            <i class="bi bi-hourglass-split"></i>
            진행 상황
        </div>
        <div style="background: #f0f0f5; border-radius: 12px; overflow: hidden; margin-bottom: 16px;">
            <div id="progressBar" style="height: 8px; background: linear-gradient(90deg, #0071e3, #5856d6); width: 0%; transition: width 0.3s ease;"></div>
        </div>
        <div id="progressText" style="text-align: center; font-weight: 500; color: var(--apple-blue); margin-bottom: 16px;">0%</div>
        <div id="progressLog" style="background: #1d1d1f; color: #f5f5f7; padding: 16px; border-radius: var(--apple-radius-sm); max-height: 300px; overflow-y: auto; font-family: 'SF Mono', Monaco, monospace; font-size: 13px; line-height: 1.6;">
        </div>
    </div>
</div>

<script>
function getCookies() {
    return {
        "ASP.NET_SessionId": document.getElementById('sessionId').value.trim(),
        "pastorinfo": document.getElementById('pastorinfo').value.trim(),
        "AUTOLOGIN": "YES"
    };
}

function log(message, type = 'info') {
    const logDiv = document.getElementById('progressLog');
    const time = new Date().toLocaleTimeString();
    const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#74c0fc';
    logDiv.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
    logDiv.scrollTop = logDiv.scrollHeight;
}

function showProgress() {
    document.getElementById('progressCard').style.display = 'block';
    document.getElementById('progressLog').innerHTML = '';
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressText').textContent = '0%';
}

function updateProgress(percent) {
    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('progressText').textContent = percent + '%';
}

async function testConnection() {
    const cookies = getCookies();
    const statusEl = document.getElementById('connectionStatus');

    if (!cookies['ASP.NET_SessionId'] || !cookies['pastorinfo']) {
        statusEl.innerHTML = '<span style="color: #dc2626;"><i class="bi bi-x-circle"></i> 쿠키를 입력하세요</span>';
        return;
    }

    statusEl.innerHTML = '<span style="color: var(--apple-blue);"><i class="bi bi-hourglass-split"></i> 연결 중...</span>';

    try {
        const resp = await fetch('/api/sync/god4u-to-registry', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({cookies: cookies, test_only: true})
        });

        if (resp.ok) {
            statusEl.innerHTML = '<span style="color: #16a34a;"><i class="bi bi-check-circle"></i> 연결 성공</span>';
        } else {
            statusEl.innerHTML = '<span style="color: #dc2626;"><i class="bi bi-x-circle"></i> 연결 실패</span>';
        }
    } catch (e) {
        statusEl.innerHTML = '<span style="color: #dc2626;"><i class="bi bi-x-circle"></i> 오류: ' + e.message + '</span>';
    }
}

async function backupGod4u() {
    const cookies = getCookies();
    const statusEl = document.getElementById('backupStatus');

    if (!cookies['ASP.NET_SessionId']) {
        statusEl.innerHTML = '<div style="color: #dc2626;"><i class="bi bi-exclamation-circle"></i> god4u 쿠키를 먼저 입력하세요</div>';
        return;
    }

    showProgress();
    log('god4u 백업 시작...');
    updateProgress(10);

    try {
        const resp = await fetch('/api/sync/backup-god4u', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({cookies: cookies})
        });

        if (resp.ok) {
            const blob = await resp.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `god4u_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();

            updateProgress(100);
            log('백업 완료! 파일이 다운로드됩니다.', 'success');
            statusEl.innerHTML = '<div style="color: #16a34a;"><i class="bi bi-check-circle"></i> god4u 백업 완료</div>';
        } else {
            const data = await resp.json();
            log('백업 실패: ' + data.error, 'error');
        }
    } catch (e) {
        log('오류: ' + e.message, 'error');
    }
}

async function backupRegistry() {
    showProgress();
    log('church-registry 백업 시작...');

    try {
        const resp = await fetch('/api/members');
        if (resp.ok) {
            const data = await resp.json();
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `registry_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();

            updateProgress(100);
            log('church-registry 백업 완료!', 'success');
        }
    } catch (e) {
        log('오류: ' + e.message, 'error');
    }
}

async function syncFromGod4u() {
    const cookies = getCookies();
    if (!cookies['ASP.NET_SessionId']) {
        alert('god4u 쿠키를 먼저 입력하세요.');
        return;
    }

    if (!confirm('god4u 데이터를 church-registry로 가져옵니다. 계속하시겠습니까?')) {
        return;
    }

    showProgress();
    log('god4u → church-registry 동기화 시작...');
    updateProgress(10);

    try {
        const resp = await fetch('/api/sync/god4u-to-registry', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({cookies: cookies})
        });

        updateProgress(90);
        const data = await resp.json();

        if (resp.ok) {
            updateProgress(100);
            log(`동기화 완료!`, 'success');
            log(`- 신규 생성: ${data.results.created}명`, 'success');
            log(`- 업데이트: ${data.results.updated}명`, 'success');
            log(`- 실패: ${data.results.failed}명`, data.results.failed > 0 ? 'error' : 'info');
        } else {
            log('동기화 실패: ' + data.error, 'error');
        }
    } catch (e) {
        log('오류: ' + e.message, 'error');
    }
}
</script>
{% endblock %}
