{% extends "base.html" %}

{% block title %}{{ member.name }} - 교인 정보{% endblock %}

{% block content %}
<div class="container">
    <!-- 페이지 헤더 -->
    <div class="page-header">
        <a href="{{ url_for('member_list') }}" class="btn-cancel">
            <i class="bi bi-arrow-left"></i> 목록으로
        </a>
    </div>

    <!-- 프로필 헤더 + 메모 -->
    <div class="form-section" style="margin-bottom: 24px;">
        <div style="display: flex; gap: 24px; align-items: flex-start;">
            <!-- 프로필 정보 -->
            <div class="detail-header" style="flex: 1;">
                <div class="detail-avatar">
                    {% if member.photo_url %}
                    <img src="{{ member.photo_url }}" alt="{{ member.name }}">
                    {% else %}
                    {{ member.name[0] }}
                    {% endif %}
                </div>
                <div class="detail-title">
                    <h1>
                        {{ member.display_name }}
                        <span class="status-badge status-{{ member.status_class }}" style="font-size: 14px; vertical-align: middle;">
                            {{ member.status_display }}
                        </span>
                    </h1>
                    <p style="color: var(--apple-text-secondary); margin: 0;">
                        {% if member.registration_number %}등록번호: {{ member.registration_number }} · {% endif %}
                        {{ member.group.name if member.group else '그룹 없음' }}
                        {% if member.registration_date %}
                        · {{ member.registration_date.strftime('%Y년 %m월 %d일') }} 등록
                        {% endif %}
                    </p>
                    <div class="detail-actions">
                        <a href="{{ url_for('member_edit', member_id=member.id) }}" class="apple-btn apple-btn-primary">
                            <i class="bi bi-pencil"></i> 수정
                        </a>
                        <button type="button" class="apple-btn apple-btn-secondary" onclick="showDeleteModal()">
                            <i class="bi bi-trash"></i> 삭제
                        </button>
                        {% if member.phone %}
                        <a href="tel:{{ member.phone }}" class="icon-btn" title="전화하기">
                            <i class="bi bi-telephone"></i>
                        </a>
                        {% endif %}
                        {% if member.email %}
                        <a href="mailto:{{ member.email }}" class="icon-btn" title="이메일 보내기">
                            <i class="bi bi-envelope"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 메모 영역 (프로필 오른쪽) -->
            <div style="flex: 0 0 300px; min-width: 280px;">
                <div style="background: #fef9e7; border: 1px solid #f9e79f; border-radius: 12px; padding: 16px; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: 600; font-size: 13px; color: #b7950b;">
                            <i class="bi bi-sticky"></i> 메모
                        </span>
                        <button type="button" onclick="toggleMemoEdit()" style="background: none; border: none; cursor: pointer; color: #b7950b; font-size: 12px;">
                            <i class="bi bi-pencil-square" id="memoEditIcon"></i>
                        </button>
                    </div>
                    <!-- 메모 표시 (읽기 모드) -->
                    <div id="memoDisplay" style="font-size: 14px; color: #5d4e37; line-height: 1.6; white-space: pre-wrap; max-height: 120px; overflow-y: auto;">{{ member.notes or '메모가 없습니다. 클릭하여 추가하세요.' }}</div>
                    <!-- 메모 편집 (편집 모드) -->
                    <div id="memoEdit" style="display: none;">
                        <textarea id="memoTextarea" style="width: 100%; height: 100px; border: 1px solid #ddd; border-radius: 8px; padding: 8px; font-size: 14px; resize: none; font-family: inherit;">{{ member.notes or '' }}</textarea>
                        <div style="margin-top: 8px; display: flex; gap: 8px; justify-content: flex-end;">
                            <button type="button" onclick="cancelMemoEdit()" style="padding: 4px 12px; border: 1px solid #ddd; background: white; border-radius: 6px; font-size: 13px; cursor: pointer;">취소</button>
                            <button type="button" onclick="saveMemo()" style="padding: 4px 12px; border: none; background: #b7950b; color: white; border-radius: 6px; font-size: 13px; cursor: pointer;">저장</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="two-column">
        <!-- 기본 정보 -->
        <div class="form-section">
            <div class="form-section-title">
                <i class="bi bi-person"></i>
                기본 정보
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">이름</div>
                    <div class="info-value">{{ member.display_name }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">전화번호</div>
                    <div class="info-value">
                        {% if member.phone %}
                        <a href="tel:{{ member.phone }}" style="color: var(--apple-blue); text-decoration: none;">
                            {{ member.phone }}
                        </a>
                        {% else %}-{% endif %}
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">이메일</div>
                    <div class="info-value">
                        {% if member.email %}
                        <a href="mailto:{{ member.email }}" style="color: var(--apple-blue); text-decoration: none;">
                            {{ member.email }}
                        </a>
                        {% else %}-{% endif %}
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">주소</div>
                    <div class="info-value">{{ member.address or '-' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">생년월일</div>
                    <div class="info-value">
                        {% if member.birth_date %}
                            {{ member.birth_date.strftime('%Y년 %m월 %d일') }}
                            {% if member.age is not none %}
                            <span style="color: var(--apple-blue); font-weight: 600;">({{ member.age }}세)</span>
                            {% endif %}
                        {% else %}-{% endif %}
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">성별</div>
                    <div class="info-value">{{ member.gender or '-' }}</div>
                </div>
            </div>
        </div>

        <!-- 교회 정보 -->
        <div class="form-section">
            <div class="form-section-title">
                <i class="bi bi-building"></i>
                교회 등록 정보
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">등록번호</div>
                    <div class="info-value">{{ member.registration_number or '-' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">등록일</div>
                    <div class="info-value">
                        {% if member.registration_date %}
                            {{ member.registration_date.strftime('%Y년 %m월 %d일') }}
                            {% if member.is_newcomer %}
                            <span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 4px;">새가족</span>
                            {% endif %}
                        {% else %}-{% endif %}
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">직분</div>
                    <div class="info-value">{{ member.member_type or '-' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">교회학교</div>
                    <div class="info-value">{{ member.department or '-' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">신급</div>
                    <div class="info-value">{{ member.faith_level or '-' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">세례일</div>
                    <div class="info-value">{{ member.baptism_date.strftime('%Y년 %m월 %d일') if member.baptism_date else '-' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">이전 교회</div>
                    <div class="info-value">{{ member.previous_church or '-' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">이전 교회 주소</div>
                    <div class="info-value">{{ member.previous_church_address or '-' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">인도자</div>
                    <div class="info-value">{{ member.referrer or '-' }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 교회 조직 정보 -->
    <div class="form-section" style="margin-top: 24px;">
        <div class="form-section-title">
            <i class="bi bi-diagram-3"></i>
            교회 조직 정보
        </div>
        <div class="info-grid" style="grid-template-columns: repeat(4, 1fr);">
            <div class="info-item">
                <div class="info-label">교구</div>
                <div class="info-value">{{ member.district or '-' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">구역</div>
                <div class="info-value">{{ member.section or '-' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">속회</div>
                <div class="info-value">{{ member.cell_group or '-' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">선교회</div>
                <div class="info-value">{{ member.mission_group or '-' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">바나바</div>
                <div class="info-value">{{ member.barnabas or '-' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">소속 그룹</div>
                <div class="info-value">{{ member.group.name if member.group else '-' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">직분 상세</div>
                <div class="info-value">{{ member.position_detail or '-' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">출석 상태</div>
                <div class="info-value">
                    {% if member.attendance_status %}
                    <span class="status-badge {% if member.attendance_status == '예배출석' %}status-active{% elif '결석' in member.attendance_status %}status-inactive{% else %}status-newcomer{% endif %}">
                        {{ member.attendance_status }}
                    </span>
                    {% else %}-{% endif %}
                </div>
            </div>
        </div>

        <!-- 추가 정보 (마지막 심방일, 직업 등) -->
        <div class="info-grid" style="grid-template-columns: repeat(4, 1fr); margin-top: 16px; padding-top: 16px; border-top: 1px solid #f0f0f5;">
            <div class="info-item">
                <div class="info-label">마지막 심방일</div>
                <div class="info-value">
                    {% if member.last_visit_date %}
                        {{ member.last_visit_date.strftime('%Y년 %m월 %d일') }}
                    {% else %}-{% endif %}
                </div>
            </div>
            <div class="info-item">
                <div class="info-label">직업</div>
                <div class="info-value">{{ member.occupation or '-' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">집 전화</div>
                <div class="info-value">{{ member.tel or '-' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">우편번호</div>
                <div class="info-value">{{ member.zipcode or '-' }}</div>
            </div>
        </div>

    </div>

    <!-- 가족 관계 -->
    <div class="form-section" style="margin-top: 24px;">
        <div class="form-section-title" style="display: flex; justify-content: space-between; align-items: center;">
            <span>
                <i class="bi bi-people"></i>
                가족 관계
            </span>
            <button type="button" class="apple-btn apple-btn-secondary" onclick="showAddFamilyModal()" style="font-size: 13px; padding: 6px 12px;">
                <i class="bi bi-plus-lg"></i> 관계 추가
            </button>
        </div>

        <div id="familyRelationships">
            <!-- JavaScript로 로드 -->
            <div style="text-align: center; padding: 40px; color: var(--apple-text-secondary);">
                <i class="bi bi-hourglass-split"></i> 로딩 중...
            </div>
        </div>
    </div>

    <!-- 활동 기록 -->
    <div class="form-section" style="margin-top: 24px;">
        <div class="tab-nav">
            <a href="#" class="tab-link active" data-tab="attendance">
                <i class="bi bi-calendar-check"></i> 출석
            </a>
            <a href="#" class="tab-link" data-tab="visits">
                <i class="bi bi-house-heart"></i> 심방
            </a>
            <a href="#" class="tab-link" data-tab="offerings">
                <i class="bi bi-wallet2"></i> 헌금
            </a>
        </div>

        <!-- 출석 탭 -->
        <div id="tab-attendance" class="tab-content-panel">
            {% if member.attendance_records %}
            <div class="apple-table-wrapper">
                <table class="apple-table">
                    <thead>
                        <tr>
                            <th>날짜</th>
                            <th>예배 유형</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in member.attendance_records[-10:]|reverse %}
                        <tr>
                            <td>{{ record.date.strftime('%Y-%m-%d') }}</td>
                            <td><span class="status-badge status-active">{{ record.service_type or '주일예배' }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="bi bi-calendar-x"></i>
                <h3>출석 기록이 없습니다</h3>
                <p>아직 출석 기록이 등록되지 않았습니다</p>
            </div>
            {% endif %}
        </div>

        <!-- 심방 탭 -->
        <div id="tab-visits" class="tab-content-panel" style="display: none;">
            {% if member.visit_records %}
            <div class="apple-table-wrapper">
                <table class="apple-table">
                    <thead>
                        <tr>
                            <th>날짜</th>
                            <th>방문자</th>
                            <th>메모</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in member.visit_records[-10:]|reverse %}
                        <tr>
                            <td>{{ record.visit_date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ record.visitor_name or '-' }}</td>
                            <td>{{ record.notes or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="bi bi-house"></i>
                <h3>심방 기록이 없습니다</h3>
                <p>아직 심방 기록이 등록되지 않았습니다</p>
            </div>
            {% endif %}
        </div>

        <!-- 헌금 탭 -->
        <div id="tab-offerings" class="tab-content-panel" style="display: none;">
            {% if member.offering_records %}
            <div class="apple-table-wrapper">
                <table class="apple-table">
                    <thead>
                        <tr>
                            <th>날짜</th>
                            <th>헌금 유형</th>
                            <th style="text-align: right;">금액</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in member.offering_records[-10:]|reverse %}
                        <tr>
                            <td>{{ record.date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ record.offering_type or '헌금' }}</td>
                            <td style="text-align: right; font-weight: 600; color: var(--apple-blue);">
                                {{ '{:,}'.format(record.amount) }}원
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="bi bi-wallet"></i>
                <h3>헌금 기록이 없습니다</h3>
                <p>아직 헌금 기록이 등록되지 않았습니다</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 삭제 확인 모달 -->
<div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: var(--apple-radius); padding: 32px; max-width: 400px; margin: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 12px;">교인 삭제</h3>
        <p style="color: var(--apple-text-secondary); margin-bottom: 8px;">
            <strong>{{ member.name }}</strong> 교인을 정말 삭제하시겠습니까?
        </p>
        <p style="color: #dc2626; font-size: 14px; margin-bottom: 24px;">
            이 작업은 되돌릴 수 없습니다.
        </p>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" class="btn-cancel" onclick="hideDeleteModal()">취소</button>
            <form action="{{ url_for('member_delete', member_id=member.id) }}" method="POST" style="margin: 0;">
                <button type="submit" class="btn-submit" style="background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%); box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);">
                    <i class="bi bi-trash"></i> 삭제
                </button>
            </form>
        </div>
    </div>
</div>

<script>
// 탭 전환
document.querySelectorAll('.tab-link').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const tabId = this.dataset.tab;

        // 탭 링크 활성화
        document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');

        // 탭 패널 전환
        document.querySelectorAll('.tab-content-panel').forEach(p => p.style.display = 'none');
        document.getElementById('tab-' + tabId).style.display = 'block';
    });
});

// 삭제 모달
function showDeleteModal() {
    document.getElementById('deleteModal').style.display = 'flex';
}

function hideDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

// 모달 바깥 클릭 시 닫기
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) hideDeleteModal();
});

// ===== 가족 관계 기능 =====
const MEMBER_ID = {{ member.id }};

// 가족 관계 로드
async function loadFamilyRelationships() {
    try {
        const resp = await fetch(`/api/members/${MEMBER_ID}/family`);
        const data = await resp.json();
        renderFamilyRelationships(data);
    } catch (e) {
        document.getElementById('familyRelationships').innerHTML = `
            <div class="empty-state">
                <i class="bi bi-exclamation-circle"></i>
                <p>가족 관계를 불러오지 못했습니다</p>
            </div>
        `;
    }
}

function renderFamilyRelationships(data) {
    const container = document.getElementById('familyRelationships');

    const hasAnyRelation = data.spouse || data.parents.length > 0 || data.children.length > 0 ||
        data.siblings.length > 0 || (data.in_laws && data.in_laws.length > 0) ||
        (data.grandparents && data.grandparents.length > 0) || (data.grandchildren && data.grandchildren.length > 0) ||
        (data.extended && data.extended.length > 0);

    if (!hasAnyRelation) {
        container.innerHTML = `
            <div class="empty-state" style="padding: 40px;">
                <i class="bi bi-people" style="font-size: 48px; color: #d1d5db;"></i>
                <h3 style="margin: 16px 0 8px;">등록된 가족 관계가 없습니다</h3>
                <p style="color: var(--apple-text-secondary);">위의 "관계 추가" 버튼을 눌러 가족을 등록하세요</p>
            </div>
        `;
        return;
    }

    let html = '<div style="display: flex; flex-direction: column; gap: 24px;">';

    // 배우자
    if (data.spouse) {
        html += `
            <div>
                <div style="font-size: 13px; font-weight: 600; color: var(--apple-text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                    <i class="bi bi-heart" style="color: #ec4899;"></i> 배우자
                </div>
                ${renderFamilyCard(data.spouse, 'spouse')}
            </div>
        `;
    }

    // 부모
    if (data.parents.length > 0) {
        html += `
            <div>
                <div style="font-size: 13px; font-weight: 600; color: var(--apple-text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                    <i class="bi bi-person-heart" style="color: #8b5cf6;"></i> 부모
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                    ${data.parents.map(p => renderFamilyCard(p, 'parent')).join('')}
                </div>
            </div>
        `;
    }

    // 자녀
    if (data.children.length > 0) {
        html += `
            <div>
                <div style="font-size: 13px; font-weight: 600; color: var(--apple-text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                    <i class="bi bi-person" style="color: #10b981;"></i> 자녀
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                    ${data.children.map(c => renderFamilyCard(c, 'child')).join('')}
                </div>
            </div>
        `;
    }

    // 형제자매
    if (data.siblings.length > 0) {
        html += `
            <div>
                <div style="font-size: 13px; font-weight: 600; color: var(--apple-text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                    <i class="bi bi-people" style="color: #f59e0b;"></i> 형제자매
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                    ${data.siblings.map(s => renderFamilyCard(s, 'sibling')).join('')}
                </div>
            </div>
        `;
    }

    // 인척 (시댁/처가/형제자매 배우자)
    if (data.in_laws && data.in_laws.length > 0) {
        html += `
            <div>
                <div style="font-size: 13px; font-weight: 600; color: var(--apple-text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                    <i class="bi bi-link-45deg" style="color: #06b6d4;"></i> 인척 (시댁/처가/동서)
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                    ${data.in_laws.map(i => renderFamilyCard(i, 'in_law')).join('')}
                </div>
            </div>
        `;
    }

    // 조부모
    if (data.grandparents && data.grandparents.length > 0) {
        html += `
            <div>
                <div style="font-size: 13px; font-weight: 600; color: var(--apple-text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                    <i class="bi bi-house" style="color: #78716c;"></i> 조부모
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                    ${data.grandparents.map(g => renderFamilyCard(g, 'grandparent')).join('')}
                </div>
            </div>
        `;
    }

    // 손자녀
    if (data.grandchildren && data.grandchildren.length > 0) {
        html += `
            <div>
                <div style="font-size: 13px; font-weight: 600; color: var(--apple-text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                    <i class="bi bi-emoji-smile" style="color: #f472b6;"></i> 손자녀
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                    ${data.grandchildren.map(g => renderFamilyCard(g, 'grandchild')).join('')}
                </div>
            </div>
        `;
    }

    // 확대가족 (삼촌/고모/조카/사촌 등)
    if (data.extended && data.extended.length > 0) {
        html += `
            <div>
                <div style="font-size: 13px; font-weight: 600; color: var(--apple-text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                    <i class="bi bi-diagram-3" style="color: #a855f7;"></i> 친척 (삼촌/고모/조카/사촌)
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                    ${data.extended.map(e => renderFamilyCard(e, 'extended')).join('')}
                </div>
            </div>
        `;
    }

    // 대가족 그룹 정보
    if (data.family_group) {
        html += `
            <div style="margin-top: 8px; padding: 12px 16px; background: #f0f9ff; border-radius: 8px; border: 1px solid #bae6fd;">
                <span style="color: #0369a1; font-weight: 500;">
                    <i class="bi bi-house-heart"></i> ${data.family_group.name}
                </span>
                <span style="color: #64748b; margin-left: 8px;">(${data.family_group.member_count}명)</span>
            </div>
        `;
    }

    html += '</div>';
    container.innerHTML = html;
}

function renderFamilyCard(member, relationType) {
    const avatar = member.photo_url
        ? `<img src="${member.photo_url}" alt="${member.name}" style="width: 100%; height: 100%; object-fit: cover;">`
        : member.name[0];

    const avatarBg = {
        'spouse': 'linear-gradient(135deg, #ec4899 0%, #be185d 100%)',
        'parent': 'linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%)',
        'child': 'linear-gradient(135deg, #10b981 0%, #047857 100%)',
        'sibling': 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
        'in_law': 'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)',
        'grandparent': 'linear-gradient(135deg, #78716c 0%, #57534e 100%)',
        'grandchild': 'linear-gradient(135deg, #f472b6 0%, #ec4899 100%)',
        'extended': 'linear-gradient(135deg, #a855f7 0%, #9333ea 100%)'
    }[relationType] || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';

    return `
        <div style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: #fafafa; border-radius: 12px; position: relative; transition: all 0.2s ease;"
             onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='#fafafa'">
            <a href="/members/${member.id}" style="display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit; flex: 1;">
                <div style="width: 44px; height: 44px; border-radius: 50%; background: ${avatarBg}; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; flex-shrink: 0; overflow: hidden;">
                    ${avatar}
                </div>
                <div style="min-width: 0; flex: 1;">
                    <div style="font-weight: 600; color: var(--apple-text); font-size: 15px;">
                        ${member.name}
                        ${member.member_type ? `<span style="font-weight: 400; color: var(--apple-text-secondary);"> ${member.member_type}</span>` : ''}
                    </div>
                    <div style="font-size: 13px; color: var(--apple-text-secondary);">
                        ${member.relationship_detail || ''}
                        ${member.age ? ` · ${member.age}세` : ''}
                    </div>
                </div>
            </a>
            <button onclick="deleteRelationship(${member.relationship_id})"
                    style="position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; border: none; background: transparent; color: #9ca3af; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0.5; transition: all 0.2s;"
                    onmouseover="this.style.opacity='1'; this.style.color='#ef4444'"
                    onmouseout="this.style.opacity='0.5'; this.style.color='#9ca3af'"
                    title="관계 삭제">
                <i class="bi bi-x-lg" style="font-size: 12px;"></i>
            </button>
        </div>
    `;
}

// 가족 관계 삭제
async function deleteRelationship(relationshipId) {
    if (!confirm('이 가족 관계를 삭제하시겠습니까?')) return;

    try {
        const resp = await fetch(`/api/family-relationships/${relationshipId}`, {
            method: 'DELETE'
        });

        if (resp.ok) {
            loadFamilyRelationships();
        } else {
            const data = await resp.json();
            alert(data.error || '삭제에 실패했습니다');
        }
    } catch (e) {
        alert('오류가 발생했습니다: ' + e.message);
    }
}

// 가족 관계 추가 모달
function showAddFamilyModal() {
    document.getElementById('addFamilyModal').style.display = 'flex';
    document.getElementById('memberSearch').value = '';
    document.getElementById('searchResults').innerHTML = '';
}

function hideAddFamilyModal() {
    document.getElementById('addFamilyModal').style.display = 'none';
}

// 교인 검색
let searchTimeout;
function searchMembers(query) {
    clearTimeout(searchTimeout);
    if (query.length < 1) {
        document.getElementById('searchResults').innerHTML = '';
        return;
    }

    searchTimeout = setTimeout(async () => {
        try {
            const resp = await fetch(`/api/members?search=${encodeURIComponent(query)}&limit=10`);
            const members = await resp.json();

            const resultsHtml = members
                .filter(m => m.id !== MEMBER_ID)
                .map(m => `
                    <div onclick="selectMember(${m.id}, '${m.name}', '${m.member_type || ''}')"
                         style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #f3f4f6;"
                         onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                        <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; overflow: hidden;">
                            ${m.photo_url ? `<img src="${m.photo_url}" style="width:100%;height:100%;object-fit:cover;">` : m.name[0]}
                        </div>
                        <div>
                            <div style="font-weight: 500;">${m.name} ${m.member_type || ''}</div>
                            <div style="font-size: 12px; color: #9ca3af;">${m.phone || ''}</div>
                        </div>
                    </div>
                `).join('');

            document.getElementById('searchResults').innerHTML = resultsHtml || '<div style="padding: 16px; color: #9ca3af; text-align: center;">검색 결과가 없습니다</div>';
        } catch (e) {
            console.error(e);
        }
    }, 300);
}

function selectMember(id, name, memberType) {
    document.getElementById('selectedMemberId').value = id;
    document.getElementById('memberSearch').value = `${name} ${memberType}`.trim();
    document.getElementById('searchResults').innerHTML = '';
}

// 가족 관계 저장
async function saveFamilyRelationship() {
    const relatedMemberId = document.getElementById('selectedMemberId').value;
    const relationshipType = document.getElementById('relationshipType').value;
    const detail = document.getElementById('relationshipDetail').value;

    if (!relatedMemberId) {
        alert('가족 구성원을 선택하세요');
        return;
    }

    try {
        const resp = await fetch(`/api/members/${MEMBER_ID}/family`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                related_member_id: parseInt(relatedMemberId),
                relationship_type: relationshipType,
                detail: detail || null
            })
        });

        const data = await resp.json();

        if (resp.ok) {
            hideAddFamilyModal();
            loadFamilyRelationships();
        } else {
            alert(data.error || '저장에 실패했습니다');
        }
    } catch (e) {
        alert('오류가 발생했습니다: ' + e.message);
    }
}

// 페이지 로드 시 가족 관계 로드
document.addEventListener('DOMContentLoaded', loadFamilyRelationships);

// ===== 메모 편집 기능 =====
let memoOriginalValue = '';

function toggleMemoEdit() {
    const displayEl = document.getElementById('memoDisplay');
    const editEl = document.getElementById('memoEdit');
    const textareaEl = document.getElementById('memoTextarea');
    const iconEl = document.getElementById('memoEditIcon');

    if (editEl.style.display === 'none') {
        // 편집 모드로 전환
        memoOriginalValue = textareaEl.value;
        displayEl.style.display = 'none';
        editEl.style.display = 'block';
        textareaEl.focus();
        iconEl.className = 'bi bi-x-lg';
    } else {
        // 읽기 모드로 전환
        cancelMemoEdit();
    }
}

function cancelMemoEdit() {
    const displayEl = document.getElementById('memoDisplay');
    const editEl = document.getElementById('memoEdit');
    const textareaEl = document.getElementById('memoTextarea');
    const iconEl = document.getElementById('memoEditIcon');

    textareaEl.value = memoOriginalValue;
    displayEl.style.display = 'block';
    editEl.style.display = 'none';
    iconEl.className = 'bi bi-pencil-square';
}

async function saveMemo() {
    const textareaEl = document.getElementById('memoTextarea');
    const displayEl = document.getElementById('memoDisplay');
    const editEl = document.getElementById('memoEdit');
    const iconEl = document.getElementById('memoEditIcon');
    const notes = textareaEl.value.trim();

    try {
        const resp = await fetch(`/api/members/${MEMBER_ID}/notes`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ notes: notes })
        });

        const data = await resp.json();

        if (resp.ok) {
            displayEl.textContent = notes || '메모가 없습니다. 클릭하여 추가하세요.';
            memoOriginalValue = notes;
            displayEl.style.display = 'block';
            editEl.style.display = 'none';
            iconEl.className = 'bi bi-pencil-square';
        } else {
            alert(data.error || '저장에 실패했습니다');
        }
    } catch (e) {
        alert('오류가 발생했습니다: ' + e.message);
    }
}
</script>

<!-- 가족 관계 추가 모달 -->
<div id="addFamilyModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 16px; padding: 28px; max-width: 440px; width: 90%; margin: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h3 style="font-size: 20px; font-weight: 600; margin: 0;">가족 관계 추가</h3>
            <button onclick="hideAddFamilyModal()" style="border: none; background: none; font-size: 24px; color: #9ca3af; cursor: pointer; padding: 4px;">&times;</button>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px;">가족 구성원 검색</label>
            <input type="text" id="memberSearch" placeholder="이름으로 검색..."
                   oninput="searchMembers(this.value)"
                   style="width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 15px; box-sizing: border-box;">
            <input type="hidden" id="selectedMemberId">
            <div id="searchResults" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 10px 10px; display: none;"
                 onfocus="this.style.display='block'"></div>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px;">관계 유형</label>
            <select id="relationshipType" style="width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 15px; background: white;">
                <option value="spouse">배우자</option>
                <option value="parent">부모 (내가 이 사람의 부모)</option>
                <option value="child">자녀 (내가 이 사람의 자녀)</option>
                <option value="sibling">형제자매</option>
                <option value="in_law">인척 (시댁/처가/동서)</option>
                <option value="grandparent">조부모 (내가 이 사람의 조부모)</option>
                <option value="grandchild">손자녀 (내가 이 사람의 손자녀)</option>
                <option value="extended">친척 (삼촌/고모/조카/사촌)</option>
            </select>
        </div>

        <div style="margin-bottom: 24px;">
            <label style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px;">상세 관계 (선택)</label>
            <select id="relationshipDetail" style="width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 15px; background: white; max-height: 300px;">
                <option value="">선택하세요</option>
                <optgroup label="배우자">
                    <option value="남편">남편</option>
                    <option value="아내">아내</option>
                </optgroup>
                <optgroup label="부모">
                    <option value="아버지">아버지</option>
                    <option value="어머니">어머니</option>
                </optgroup>
                <optgroup label="자녀">
                    <option value="아들">아들</option>
                    <option value="딸">딸</option>
                </optgroup>
                <optgroup label="형제자매">
                    <option value="형">형</option>
                    <option value="오빠">오빠</option>
                    <option value="누나">누나</option>
                    <option value="언니">언니</option>
                    <option value="남동생">남동생</option>
                    <option value="여동생">여동생</option>
                </optgroup>
                <optgroup label="조부모">
                    <option value="할아버지">할아버지</option>
                    <option value="할머니">할머니</option>
                    <option value="외할아버지">외할아버지</option>
                    <option value="외할머니">외할머니</option>
                </optgroup>
                <optgroup label="손자녀">
                    <option value="손자">손자</option>
                    <option value="손녀">손녀</option>
                    <option value="외손자">외손자</option>
                    <option value="외손녀">외손녀</option>
                </optgroup>
                <optgroup label="시댁">
                    <option value="시아버지">시아버지</option>
                    <option value="시어머니">시어머니</option>
                    <option value="시형">시형 (남편의 형)</option>
                    <option value="시동생">시동생 (남편의 남동생)</option>
                    <option value="시누이">시누이 (남편의 여형제)</option>
                </optgroup>
                <optgroup label="처가">
                    <option value="장인">장인</option>
                    <option value="장모">장모</option>
                    <option value="처남">처남 (아내의 남형제)</option>
                    <option value="처형">처형 (아내의 언니)</option>
                    <option value="처제">처제 (아내의 여동생)</option>
                </optgroup>
                <optgroup label="형제자매의 배우자">
                    <option value="형수">형수 (형의 아내)</option>
                    <option value="제수">제수 (남동생의 아내)</option>
                    <option value="올케">올케 (남형제의 아내)</option>
                    <option value="매형">매형 (누나/언니의 남편)</option>
                    <option value="매부">매부 (여동생의 남편)</option>
                    <option value="동서">동서</option>
                </optgroup>
                <optgroup label="자녀의 배우자">
                    <option value="며느리">며느리</option>
                    <option value="사위">사위</option>
                </optgroup>
                <optgroup label="사돈">
                    <option value="사돈">사돈</option>
                    <option value="바깥사돈">바깥사돈</option>
                    <option value="안사돈">안사돈</option>
                </optgroup>
                <optgroup label="삼촌/고모/이모">
                    <option value="삼촌">삼촌</option>
                    <option value="큰아버지">큰아버지</option>
                    <option value="작은아버지">작은아버지</option>
                    <option value="고모">고모</option>
                    <option value="외삼촌">외삼촌</option>
                    <option value="이모">이모</option>
                    <option value="숙모">숙모 (삼촌의 아내)</option>
                    <option value="고모부">고모부</option>
                    <option value="이모부">이모부</option>
                </optgroup>
                <optgroup label="조카">
                    <option value="조카">조카</option>
                    <option value="조카아들">조카아들 (생질)</option>
                    <option value="조카딸">조카딸 (생질녀)</option>
                    <option value="외조카">외조카</option>
                </optgroup>
                <optgroup label="사촌">
                    <option value="사촌">사촌</option>
                    <option value="사촌형">사촌형</option>
                    <option value="사촌누나">사촌누나</option>
                    <option value="사촌동생">사촌동생</option>
                    <option value="고종사촌">고종사촌 (고모의 자녀)</option>
                    <option value="이종사촌">이종사촌 (이모의 자녀)</option>
                    <option value="외사촌">외사촌 (외삼촌의 자녀)</option>
                </optgroup>
            </select>
        </div>

        <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" onclick="hideAddFamilyModal()" class="btn-cancel">취소</button>
            <button type="button" onclick="saveFamilyRelationship()" class="btn-submit">
                <i class="bi bi-plus-lg"></i> 추가
            </button>
        </div>
    </div>
</div>

<script>
// 검색 결과 표시/숨김
document.getElementById('memberSearch').addEventListener('focus', function() {
    const results = document.getElementById('searchResults');
    if (results.innerHTML.trim()) {
        results.style.display = 'block';
    }
});

document.addEventListener('click', function(e) {
    const results = document.getElementById('searchResults');
    const search = document.getElementById('memberSearch');
    if (!results.contains(e.target) && e.target !== search) {
        results.style.display = 'none';
    }
});

document.getElementById('memberSearch').addEventListener('input', function() {
    document.getElementById('searchResults').style.display = 'block';
});

// 모달 바깥 클릭 시 닫기
document.getElementById('addFamilyModal').addEventListener('click', function(e) {
    if (e.target === this) hideAddFamilyModal();
});
</script>
{% endblock %}
