{% extends "base.html" %}

{% block title %}{{ member.name }} - 교인 정보{% endblock %}

{% block content %}
<div class="container">
    <!-- 페이지 헤더 -->
    <div class="page-header">
        <a href="{{ url_for('member_list') }}" class="btn-cancel">
            <i class="bi bi-arrow-left"></i> 목록으로
        </a>
    </div>

    <!-- 프로필 헤더 -->
    <div class="form-section" style="margin-bottom: 24px;">
        <div class="detail-header">
            <div class="detail-avatar">
                {% if member.photo_url %}
                <img src="{{ member.photo_url }}" alt="{{ member.name }}">
                {% else %}
                {{ member.name[0] }}
                {% endif %}
            </div>
            <div class="detail-title">
                <h1>
                    {{ member.display_name }}
                    <span class="status-badge status-{{ member.status }}" style="font-size: 14px; vertical-align: middle;">
                        {% if member.status == 'active' %}활동
                        {% elif member.status == 'inactive' %}비활동
                        {% else %}새신자{% endif %}
                    </span>
                </h1>
                <p style="color: var(--apple-text-secondary); margin: 0;">
                    {% if member.registration_number %}등록번호: {{ member.registration_number }} · {% endif %}
                    {{ member.group.name if member.group else '그룹 없음' }}
                    {% if member.registration_date %}
                    · {{ member.registration_date.strftime('%Y년 %m월 %d일') }} 등록
                    {% endif %}
                </p>
                <div class="detail-actions">
                    <a href="{{ url_for('member_edit', member_id=member.id) }}" class="apple-btn apple-btn-primary">
                        <i class="bi bi-pencil"></i> 수정
                    </a>
                    <button type="button" class="apple-btn apple-btn-secondary" onclick="showDeleteModal()">
                        <i class="bi bi-trash"></i> 삭제
                    </button>
                    {% if member.phone %}
                    <a href="tel:{{ member.phone }}" class="icon-btn" title="전화하기">
                        <i class="bi bi-telephone"></i>
                    </a>
                    {% endif %}
                    {% if member.email %}
                    <a href="mailto:{{ member.email }}" class="icon-btn" title="이메일 보내기">
                        <i class="bi bi-envelope"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="two-column">
        <!-- 기본 정보 -->
        <div class="form-section">
            <div class="form-section-title">
                <i class="bi bi-person"></i>
                기본 정보
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">이름</div>
                    <div class="info-value">{{ member.display_name }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">전화번호</div>
                    <div class="info-value">
                        {% if member.phone %}
                        <a href="tel:{{ member.phone }}" style="color: var(--apple-blue); text-decoration: none;">
                            {{ member.phone }}
                        </a>
                        {% else %}-{% endif %}
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">이메일</div>
                    <div class="info-value">
                        {% if member.email %}
                        <a href="mailto:{{ member.email }}" style="color: var(--apple-blue); text-decoration: none;">
                            {{ member.email }}
                        </a>
                        {% else %}-{% endif %}
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">주소</div>
                    <div class="info-value">{{ member.address or '-' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">생년월일</div>
                    <div class="info-value">
                        {% if member.birth_date %}
                            {{ member.birth_date.strftime('%Y년 %m월 %d일') }}
                            {% if member.age is not none %}
                            <span style="color: var(--apple-blue); font-weight: 600;">({{ member.age }}세)</span>
                            {% endif %}
                        {% else %}-{% endif %}
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">성별</div>
                    <div class="info-value">{{ member.gender or '-' }}</div>
                </div>
            </div>
        </div>

        <!-- 교회 정보 -->
        <div class="form-section">
            <div class="form-section-title">
                <i class="bi bi-building"></i>
                교회 등록 정보
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">등록번호</div>
                    <div class="info-value">{{ member.registration_number or '-' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">등록일</div>
                    <div class="info-value">
                        {% if member.registration_date %}
                            {{ member.registration_date.strftime('%Y년 %m월 %d일') }}
                            {% if member.is_newcomer %}
                            <span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 4px;">새가족</span>
                            {% endif %}
                        {% else %}-{% endif %}
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">직분</div>
                    <div class="info-value">{{ member.member_type or '-' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">교회학교</div>
                    <div class="info-value">{{ member.department or '-' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">신급</div>
                    <div class="info-value">{{ member.faith_level or '-' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">세례일</div>
                    <div class="info-value">{{ member.baptism_date.strftime('%Y년 %m월 %d일') if member.baptism_date else '-' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">이전 교회</div>
                    <div class="info-value">{{ member.previous_church or '-' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">이전 교회 주소</div>
                    <div class="info-value">{{ member.previous_church_address or '-' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">인도자</div>
                    <div class="info-value">{{ member.referrer or '-' }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 교회 조직 정보 -->
    <div class="form-section" style="margin-top: 24px;">
        <div class="form-section-title">
            <i class="bi bi-diagram-3"></i>
            교회 조직 정보
        </div>
        <div class="info-grid" style="grid-template-columns: repeat(4, 1fr);">
            <div class="info-item">
                <div class="info-label">교구</div>
                <div class="info-value">{{ member.district or '-' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">속회</div>
                <div class="info-value">{{ member.cell_group or '-' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">선교회</div>
                <div class="info-value">{{ member.mission_group or '-' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">바나바</div>
                <div class="info-value">{{ member.barnabas or '-' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">소속 그룹</div>
                <div class="info-value">{{ member.group.name if member.group else '-' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">가족</div>
                <div class="info-value">
                    {% if member.family %}
                        {{ member.family.family_name }}
                        {% if member.family_role %}({{ member.family_role }}){% endif %}
                    {% else %}-{% endif %}
                </div>
            </div>
        </div>

        {% if member.notes %}
        <div style="margin-top: 20px; padding: 16px; background: #f9f9fb; border-radius: var(--apple-radius-sm);">
            <div class="info-label" style="margin-bottom: 8px;">메모 (등록동기/기타사항)</div>
            <p style="margin: 0; color: var(--apple-text); line-height: 1.6; white-space: pre-wrap;">{{ member.notes }}</p>
        </div>
        {% endif %}
    </div>

    <!-- 가족 사항 -->
    {% if member.family and member.family.members|length > 1 %}
    <div class="form-section" style="margin-top: 24px;">
        <div class="form-section-title">
            <i class="bi bi-people"></i>
            가족 사항
        </div>
        <div class="family-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px;">
            {% for family_member in member.family.members %}
            <a href="{{ url_for('member_detail', member_id=family_member.id) }}"
               class="family-card"
               style="display: flex; align-items: center; gap: 12px; padding: 16px; background: {% if family_member.id == member.id %}linear-gradient(135deg, #667eea15 0%, #764ba215 100%){% else %}#fafafa{% endif %}; border-radius: var(--apple-radius-sm); text-decoration: none; color: inherit; transition: all 0.2s ease; border: 1px solid {% if family_member.id == member.id %}#667eea30{% else %}transparent{% endif %};">
                <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; flex-shrink: 0; overflow: hidden;">
                    {% if family_member.photo_url %}
                    <img src="{{ family_member.photo_url }}" alt="{{ family_member.name }}" style="width: 100%; height: 100%; object-fit: cover;">
                    {% else %}
                    {{ family_member.name[0] }}
                    {% endif %}
                </div>
                <div style="min-width: 0;">
                    <div style="font-weight: 600; color: var(--apple-text); font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        {{ family_member.name }}
                        {% if family_member.member_type %}<span style="font-weight: 400; color: var(--apple-text-secondary);"> {{ family_member.member_type }}</span>{% endif %}
                    </div>
                    <div style="font-size: 13px; color: var(--apple-text-secondary);">
                        {% if family_member.id == member.id %}
                        <span style="color: var(--apple-blue); font-weight: 500;">본인</span>
                        {% else %}
                        {{ family_member.family_role or '-' }}
                        {% endif %}
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- 활동 기록 -->
    <div class="form-section" style="margin-top: 24px;">
        <div class="tab-nav">
            <a href="#" class="tab-link active" data-tab="attendance">
                <i class="bi bi-calendar-check"></i> 출석
            </a>
            <a href="#" class="tab-link" data-tab="visits">
                <i class="bi bi-house-heart"></i> 심방
            </a>
            <a href="#" class="tab-link" data-tab="offerings">
                <i class="bi bi-wallet2"></i> 헌금
            </a>
        </div>

        <!-- 출석 탭 -->
        <div id="tab-attendance" class="tab-content-panel">
            {% if member.attendance_records %}
            <div class="apple-table-wrapper">
                <table class="apple-table">
                    <thead>
                        <tr>
                            <th>날짜</th>
                            <th>예배 유형</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in member.attendance_records[-10:]|reverse %}
                        <tr>
                            <td>{{ record.date.strftime('%Y-%m-%d') }}</td>
                            <td><span class="status-badge status-active">{{ record.service_type or '주일예배' }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="bi bi-calendar-x"></i>
                <h3>출석 기록이 없습니다</h3>
                <p>아직 출석 기록이 등록되지 않았습니다</p>
            </div>
            {% endif %}
        </div>

        <!-- 심방 탭 -->
        <div id="tab-visits" class="tab-content-panel" style="display: none;">
            {% if member.visit_records %}
            <div class="apple-table-wrapper">
                <table class="apple-table">
                    <thead>
                        <tr>
                            <th>날짜</th>
                            <th>방문자</th>
                            <th>메모</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in member.visit_records[-10:]|reverse %}
                        <tr>
                            <td>{{ record.visit_date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ record.visitor_name or '-' }}</td>
                            <td>{{ record.notes or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="bi bi-house"></i>
                <h3>심방 기록이 없습니다</h3>
                <p>아직 심방 기록이 등록되지 않았습니다</p>
            </div>
            {% endif %}
        </div>

        <!-- 헌금 탭 -->
        <div id="tab-offerings" class="tab-content-panel" style="display: none;">
            {% if member.offering_records %}
            <div class="apple-table-wrapper">
                <table class="apple-table">
                    <thead>
                        <tr>
                            <th>날짜</th>
                            <th>헌금 유형</th>
                            <th style="text-align: right;">금액</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in member.offering_records[-10:]|reverse %}
                        <tr>
                            <td>{{ record.date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ record.offering_type or '헌금' }}</td>
                            <td style="text-align: right; font-weight: 600; color: var(--apple-blue);">
                                {{ '{:,}'.format(record.amount) }}원
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="bi bi-wallet"></i>
                <h3>헌금 기록이 없습니다</h3>
                <p>아직 헌금 기록이 등록되지 않았습니다</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 삭제 확인 모달 -->
<div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: var(--apple-radius); padding: 32px; max-width: 400px; margin: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 12px;">교인 삭제</h3>
        <p style="color: var(--apple-text-secondary); margin-bottom: 8px;">
            <strong>{{ member.name }}</strong> 교인을 정말 삭제하시겠습니까?
        </p>
        <p style="color: #dc2626; font-size: 14px; margin-bottom: 24px;">
            이 작업은 되돌릴 수 없습니다.
        </p>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" class="btn-cancel" onclick="hideDeleteModal()">취소</button>
            <form action="{{ url_for('member_delete', member_id=member.id) }}" method="POST" style="margin: 0;">
                <button type="submit" class="btn-submit" style="background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%); box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);">
                    <i class="bi bi-trash"></i> 삭제
                </button>
            </form>
        </div>
    </div>
</div>

<script>
// 탭 전환
document.querySelectorAll('.tab-link').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const tabId = this.dataset.tab;

        // 탭 링크 활성화
        document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');

        // 탭 패널 전환
        document.querySelectorAll('.tab-content-panel').forEach(p => p.style.display = 'none');
        document.getElementById('tab-' + tabId).style.display = 'block';
    });
});

// 삭제 모달
function showDeleteModal() {
    document.getElementById('deleteModal').style.display = 'flex';
}

function hideDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

// 모달 바깥 클릭 시 닫기
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) hideDeleteModal();
});
</script>
{% endblock %}
