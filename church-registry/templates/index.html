{% extends "base.html" %}

{% block title %}AI êµì  ê´€ë¦¬{% endblock %}

{% block content %}
<div class="container-fluid h-100">
    <div class="row h-100">
        <!-- ì‚¬ì´ë“œë°” (ê¸°ì¡´ ë©”ë‰´) -->
        <div class="col-md-3 col-lg-2 d-none d-md-block bg-light sidebar py-3">
            <h6 class="sidebar-heading px-3 mb-3 text-muted">
                <i class="bi bi-grid"></i> ë°”ë¡œê°€ê¸°
            </h6>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('member_list') }}">
                        <i class="bi bi-people"></i> êµì¸ ëª©ë¡
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('group_list') }}">
                        <i class="bi bi-diagram-3"></i> ê·¸ë£¹ ê´€ë¦¬
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('attendance_list') }}">
                        <i class="bi bi-calendar-check"></i> ì¶œì„ ì²´í¬
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('visit_list') }}">
                        <i class="bi bi-journal-text"></i> ì‹¬ë°© ê¸°ë¡
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('offering_list') }}">
                        <i class="bi bi-wallet2"></i> í—Œê¸ˆ ê¸°ë¡
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('newcomer_list') }}">
                        <i class="bi bi-person-plus"></i> ìƒˆì‹ ì
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('birthday_list') }}">
                        <i class="bi bi-cake2"></i> ìƒì¼ì
                    </a>
                </li>
            </ul>

            <hr>

            <h6 class="sidebar-heading px-3 mb-3 text-muted">
                <i class="bi bi-lightbulb"></i> ì˜ˆì‹œ ì§ˆë¬¸
            </h6>
            <div class="px-3">
                <button class="btn btn-outline-secondary btn-sm w-100 mb-2 text-start example-btn" data-message="ìƒˆì‹ ì ëª©ë¡ ë³´ì—¬ì¤˜">
                    ìƒˆì‹ ì ëª©ë¡ ë³´ì—¬ì¤˜
                </button>
                <button class="btn btn-outline-secondary btn-sm w-100 mb-2 text-start example-btn" data-message="ì´ë²ˆ ë‹¬ ìƒì¼ì ì•Œë ¤ì¤˜">
                    ì´ë²ˆ ë‹¬ ìƒì¼ì
                </button>
                <button class="btn btn-outline-secondary btn-sm w-100 mb-2 text-start example-btn" data-message="ì‹¬ë°© ì¶”ì²œí•´ì¤˜">
                    ì‹¬ë°© ì¶”ì²œí•´ì¤˜
                </button>
                <button class="btn btn-outline-secondary btn-sm w-100 mb-2 text-start example-btn" data-message="ì „ì²´ í†µê³„ ë³´ì—¬ì¤˜">
                    ì „ì²´ í†µê³„
                </button>
                <button class="btn btn-outline-secondary btn-sm w-100 mb-2 text-start example-btn" data-message="3ì£¼ ì´ìƒ ê²°ì„ì">
                    ì¥ê¸° ê²°ì„ì
                </button>
            </div>
        </div>

        <!-- ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
        <div class="col-md-9 col-lg-10 ms-sm-auto px-0 d-flex flex-column" style="height: calc(100vh - 56px);">
            <!-- ì±„íŒ… í—¤ë” -->
            <div class="chat-header bg-primary text-white p-3">
                <h5 class="mb-0">
                    <i class="bi bi-chat-dots"></i> AI êµì  ê´€ë¦¬ ì–´ì‹œìŠ¤í„´íŠ¸
                </h5>
                <small>ìì—°ì–´ë¡œ êµì¸ ë“±ë¡, ê²€ìƒ‰, ì‹¬ë°© ê¸°ë¡ ë“±ì„ ê´€ë¦¬í•˜ì„¸ìš”</small>
            </div>

            <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
            <div id="chat-messages" class="flex-grow-1 overflow-auto p-3" style="background: #f8f9fa;">
                <!-- í™˜ì˜ ë©”ì‹œì§€ -->
                <div class="message assistant-message mb-3">
                    <div class="message-content bg-white p-3 rounded shadow-sm" style="max-width: 80%;">
                        <p class="mb-2">ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹ AI êµì  ê´€ë¦¬ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.</p>
                        <p class="mb-2">ì €ì—ê²Œ ìì—°ì–´ë¡œ ë§ì”€í•´ì£¼ì‹œë©´ êµì¸ ë“±ë¡, ê²€ìƒ‰, ì‹¬ë°© ê¸°ë¡ ë“±ì„ ë„ì™€ë“œë¦½ë‹ˆë‹¤.</p>
                        <p class="mb-0"><strong>ì˜ˆì‹œ:</strong></p>
                        <ul class="mb-0 ps-3">
                            <li>"í™ê¸¸ë™ ì§‘ì‚¬ë‹˜ ë“±ë¡í•´ì¤˜, ì „í™”ë²ˆí˜¸ 010-1234-5678"</li>
                            <li>"ê¹€ì˜í¬ ê¶Œì‚¬ë‹˜ ì •ë³´ ì•Œë ¤ì¤˜"</li>
                            <li>"ì´ë²ˆ ì£¼ ì‹¬ë°© ê°ˆ ë¶„ ì¶”ì²œí•´ì¤˜"</li>
                            <li>"ìƒˆì‹ ì ì¤‘ ì‹¬ë°© ì•ˆ ê°„ ë¶„"</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- ì…ë ¥ ì˜ì—­ -->
            <div class="chat-input border-top bg-white p-3">
                <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                <div id="image-preview" class="mb-2 d-none">
                    <div class="position-relative d-inline-block">
                        <img id="preview-img" src="" alt="ì²¨ë¶€ ì´ë¯¸ì§€" class="rounded" style="max-height: 100px;">
                        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0" id="remove-image">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>

                <form id="chat-form" class="d-flex gap-2">
                    <!-- íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ -->
                    <input type="file" id="image-input" accept="image/*" class="d-none">
                    <button type="button" class="btn btn-outline-secondary" id="attach-btn" title="ì‚¬ì§„ ì²¨ë¶€">
                        <i class="bi bi-image"></i>
                    </button>

                    <!-- ë©”ì‹œì§€ ì…ë ¥ -->
                    <input type="text" id="message-input" class="form-control"
                           placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ: í™ê¸¸ë™ ì§‘ì‚¬ë‹˜ ë“±ë¡í•´ì¤˜)" autofocus>

                    <!-- ì „ì†¡ ë²„íŠ¼ -->
                    <button type="submit" class="btn btn-primary" id="send-btn">
                        <i class="bi bi-send"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.sidebar {
    position: sticky;
    top: 56px;
    height: calc(100vh - 56px);
    overflow-y: auto;
}

.message {
    display: flex;
}

.user-message {
    justify-content: flex-end;
}

.user-message .message-content {
    background-color: #0d6efd !important;
    color: white;
}

.assistant-message .message-content {
    background-color: white;
}

.message-content {
    max-width: 80%;
    word-wrap: break-word;
}

.message-content pre {
    background: #f1f1f1;
    padding: 10px;
    border-radius: 5px;
    overflow-x: auto;
}

.message-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
}

.message-content th, .message-content td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}

.message-content th {
    background-color: #f8f9fa;
}

.typing-indicator {
    display: flex;
    gap: 4px;
    padding: 10px;
}

.typing-indicator span {
    width: 8px;
    height: 8px;
    background: #999;
    border-radius: 50%;
    animation: typing 1s infinite ease-in-out;
}

.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
    0%, 100% { opacity: 0.3; transform: translateY(0); }
    50% { opacity: 1; transform: translateY(-4px); }
}

#chat-messages {
    scroll-behavior: smooth;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatMessages = document.getElementById('chat-messages');
    const imageInput = document.getElementById('image-input');
    const attachBtn = document.getElementById('attach-btn');
    const imagePreview = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');
    const removeImageBtn = document.getElementById('remove-image');

    let currentImage = null;

    // ì˜ˆì‹œ ë²„íŠ¼ í´ë¦­
    document.querySelectorAll('.example-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            messageInput.value = this.dataset.message;
            messageInput.focus();
        });
    });

    // íŒŒì¼ ì²¨ë¶€ ë²„íŠ¼
    attachBtn.addEventListener('click', () => imageInput.click());

    // ì´ë¯¸ì§€ ì„ íƒ
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImage = e.target.result.split(',')[1]; // base64 ë°ì´í„°ë§Œ
                previewImg.src = e.target.result;
                imagePreview.classList.remove('d-none');
            };
            reader.readAsDataURL(file);
        }
    });

    // ì´ë¯¸ì§€ ì œê±°
    removeImageBtn.addEventListener('click', function() {
        currentImage = null;
        imageInput.value = '';
        imagePreview.classList.add('d-none');
    });

    // ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
    function addMessage(content, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'assistant-message'} mb-3`;

        const contentDiv = document.createElement('div');
        contentDiv.className = `message-content p-3 rounded shadow-sm`;

        // ë§ˆí¬ë‹¤ìš´ ê¸°ë³¸ ë³€í™˜ (ê°„ë‹¨íˆ)
        let html = content
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n/g, '<br>')
            .replace(/- (.*?)(<br>|$)/g, '<li>$1</li>')
            .replace(/<li>/g, '<ul><li>')
            .replace(/<\/li>(?!<li>)/g, '</li></ul>');

        contentDiv.innerHTML = html;
        messageDiv.appendChild(contentDiv);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        return messageDiv;
    }

    // ë¡œë”© í‘œì‹œ
    function showTyping() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message assistant-message mb-3';
        typingDiv.id = 'typing-indicator';
        typingDiv.innerHTML = `
            <div class="message-content bg-white p-3 rounded shadow-sm">
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTyping() {
        const typing = document.getElementById('typing-indicator');
        if (typing) typing.remove();
    }

    // í¼ ì œì¶œ
    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const message = messageInput.value.trim();
        if (!message && !currentImage) return;

        // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
        if (message) {
            addMessage(message, true);
        }
        if (currentImage) {
            const imgMsg = document.createElement('div');
            imgMsg.className = 'message user-message mb-3';
            imgMsg.innerHTML = `
                <div class="message-content p-2 rounded shadow-sm">
                    <img src="data:image/jpeg;base64,${currentImage}" class="rounded" style="max-width: 200px;">
                </div>
            `;
            chatMessages.appendChild(imgMsg);
        }

        // ì…ë ¥ ì´ˆê¸°í™”
        messageInput.value = '';
        const imageData = currentImage;
        currentImage = null;
        imageInput.value = '';
        imagePreview.classList.add('d-none');

        // ë¡œë”© í‘œì‹œ
        showTyping();

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    image: imageData
                })
            });

            const data = await response.json();
            hideTyping();

            if (data.error) {
                addMessage('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error);
            } else {
                addMessage(data.response);
            }
        } catch (error) {
            hideTyping();
            addMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
    });

    // Enter í‚¤ë¡œ ì „ì†¡ (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.dispatchEvent(new Event('submit'));
        }
    });
});
</script>
{% endblock %}
