{% extends "base.html" %}

{% block title %}AI êµì  ê´€ë¦¬{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
    <div id="chat-messages" class="chat-messages">
        <!-- í™˜ì˜ ë©”ì‹œì§€ -->
        <div class="welcome-section">
            <div class="welcome-icon">
                <i class="bi bi-chat-dots"></i>
            </div>
            <h1>AI êµì  ê´€ë¦¬</h1>
            <p>ìì—°ì–´ë¡œ êµì¸ ì •ë³´ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</p>

            <div class="quick-actions">
                <!-- ë¹ ë¥¸ ì‹¤í–‰ ë²„íŠ¼ ì˜ì—­ (í•„ìš”ì‹œ ì¶”ê°€) -->
            </div>

            <div class="upload-section">
                <p class="upload-hint">íŒŒì¼ë¡œ ì¼ê´„ ë“±ë¡í•˜ê¸°</p>
                <div class="upload-buttons">
                    <button class="upload-btn" id="upload-excel-btn">
                        <i class="bi bi-file-earmark-excel"></i>
                        ì—‘ì…€ íŒŒì¼ ë¶„ì„
                    </button>
                    <button class="upload-btn" id="upload-card-btn">
                        <i class="bi bi-person-vcard"></i>
                        ëª…í•¨/ë“±ë¡ì¹´ë“œ ë¶„ì„
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì…ë ¥ ì˜ì—­ -->
    <div class="chat-input-wrapper">
        <div class="chat-input-container">
            <!-- íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° -->
            <div id="file-preview" class="file-preview hidden">
                <div class="preview-content">
                    <img id="preview-img" src="" alt="ì²¨ë¶€ ì´ë¯¸ì§€" class="preview-image hidden">
                    <div id="preview-file" class="preview-file hidden">
                        <i class="bi bi-file-earmark-excel"></i>
                        <span id="preview-filename"></span>
                    </div>
                </div>
                <button type="button" class="remove-file" id="remove-file">
                    <i class="bi bi-x"></i>
                </button>
            </div>

            <form id="chat-form" class="chat-form">
                <input type="file" id="image-input" accept="image/*" class="hidden">
                <input type="file" id="excel-input" accept=".xlsx,.xls" class="hidden">

                <button type="button" class="attach-btn" id="attach-btn" title="íŒŒì¼ ì²¨ë¶€">
                    <i class="bi bi-plus-circle"></i>
                </button>

                <input type="text" id="message-input" class="message-input"
                       placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autofocus>

                <button type="submit" class="send-btn" id="send-btn">
                    <i class="bi bi-arrow-up"></i>
                </button>
            </form>
        </div>
        <p class="input-hint">ì˜ˆ: "í™ê¸¸ë™ ì§‘ì‚¬ë‹˜ ë“±ë¡í•´ì¤˜" | ì—‘ì…€ì´ë‚˜ ì‚¬ì§„ì„ ì²¨ë¶€í•˜ë©´ ìë™ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤</p>
    </div>
</div>

<!-- íŒŒì¼ ì²¨ë¶€ ë©”ë‰´ -->
<div id="attach-menu" class="attach-menu hidden">
    <button class="attach-menu-item" id="attach-image">
        <i class="bi bi-image"></i>
        ì‚¬ì§„ ì²¨ë¶€
    </button>
    <button class="attach-menu-item" id="attach-excel">
        <i class="bi bi-file-earmark-excel"></i>
        ì—‘ì…€ íŒŒì¼
    </button>
</div>

<!-- ë¶„ì„ ê²°ê³¼ ëª¨ë‹¬ -->
<div id="analysis-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">ë¶„ì„ ê²°ê³¼</h3>
            <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body" id="modal-body">
            <!-- ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë¨ -->
        </div>
        <div class="modal-footer">
            <button class="modal-btn secondary" id="modal-cancel">ì·¨ì†Œ</button>
            <button class="modal-btn primary" id="modal-confirm">ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>
</div>

<style>
.chat-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 52px);
    max-width: 900px;
    margin: 0 auto;
    padding: 0;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 40px 24px;
    display: flex;
    flex-direction: column;
    gap: 24px;
}

/* í™˜ì˜ ì„¹ì…˜ */
.welcome-section {
    text-align: center;
    padding: 40px 20px;
    animation: fadeIn 0.6s ease;
}

.welcome-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 24px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    color: white;
    box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
}

.welcome-section h1 {
    font-size: 32px;
    font-weight: 700;
    color: var(--apple-text);
    margin-bottom: 8px;
}

.welcome-section p {
    font-size: 18px;
    color: var(--apple-text-secondary);
    margin-bottom: 32px;
}

.quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
    max-width: 600px;
    margin: 0 auto 40px;
}

.quick-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 14px 24px;
    background: white;
    border: 1px solid var(--apple-border);
    border-radius: 100px;
    font-size: 15px;
    font-weight: 500;
    font-family: inherit;
    color: var(--apple-text);
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.quick-btn:hover {
    background: var(--apple-blue);
    color: white;
    border-color: var(--apple-blue);
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 113, 227, 0.3);
}

.quick-btn i {
    font-size: 18px;
}

/* ì—…ë¡œë“œ ì„¹ì…˜ */
.upload-section {
    padding-top: 24px;
    border-top: 1px solid var(--apple-border);
}

.upload-hint {
    font-size: 14px;
    color: var(--apple-text-secondary);
    margin-bottom: 16px;
}

.upload-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
}

.upload-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    border: none;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 500;
    font-family: inherit;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 16px rgba(17, 153, 142, 0.3);
}

.upload-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4);
}

/* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
.message {
    display: flex;
    gap: 12px;
    animation: slideUp 0.3s ease;
    max-width: 85%;
}

.message.user {
    flex-direction: row-reverse;
    align-self: flex-end;
}

.message.assistant {
    align-self: flex-start;
}

.message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
}

.message.user .message-avatar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.message.assistant .message-avatar {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
}

.message-content {
    padding: 16px 20px;
    border-radius: 20px;
    font-size: 15px;
    line-height: 1.6;
    word-break: keep-all;
}

.message.user .message-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-bottom-right-radius: 6px;
}

.message.assistant .message-content {
    background: white;
    color: var(--apple-text);
    border: 1px solid var(--apple-border);
    border-bottom-left-radius: 6px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
}

.message-content img {
    max-width: 200px;
    border-radius: 12px;
}

/* ë¶„ì„ ê²°ê³¼ ì¹´ë“œ */
.analysis-card {
    background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
    border-radius: 16px;
    padding: 20px;
    margin-top: 12px;
}

.analysis-card h4 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--apple-text);
}

.analysis-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    font-size: 14px;
}

.analysis-item:last-child {
    border-bottom: none;
}

.analysis-label {
    color: var(--apple-text-secondary);
}

.analysis-value {
    font-weight: 500;
    color: var(--apple-text);
}

.analysis-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
}

.analysis-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 500;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s;
}

.analysis-btn.primary {
    background: var(--apple-blue);
    color: white;
}

.analysis-btn.secondary {
    background: rgba(0,0,0,0.05);
    color: var(--apple-text);
}

/* íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° */
.typing-indicator {
    display: flex;
    gap: 6px;
    padding: 8px 0;
}

.typing-indicator span {
    width: 8px;
    height: 8px;
    background: var(--apple-text-secondary);
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out;
}

.typing-indicator span:nth-child(1) { animation-delay: 0s; }
.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

@keyframes bounce {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1.2); opacity: 1; }
}

/* ì…ë ¥ ì˜ì—­ */
.chat-input-wrapper {
    padding: 20px 24px 32px;
    background: linear-gradient(to top, var(--apple-bg) 80%, transparent);
}

.chat-input-container {
    max-width: 800px;
    margin: 0 auto;
}

.file-preview {
    margin-bottom: 12px;
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: white;
    border-radius: 12px;
    border: 1px solid var(--apple-border);
}

.file-preview.hidden {
    display: none;
}

.preview-image {
    max-height: 80px;
    border-radius: 8px;
}

.preview-file {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--apple-text);
}

.preview-file i {
    font-size: 24px;
    color: #217346;
}

.remove-file {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 24px;
    height: 24px;
    background: #ff3b30;
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

.chat-form {
    display: flex;
    align-items: center;
    gap: 12px;
    background: white;
    padding: 8px 8px 8px 20px;
    border-radius: 28px;
    border: 1px solid var(--apple-border);
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
    transition: all 0.2s ease;
}

.chat-form:focus-within {
    border-color: var(--apple-blue);
    box-shadow: 0 4px 24px rgba(0, 113, 227, 0.15);
}

.attach-btn {
    width: 40px;
    height: 40px;
    background: none;
    border: none;
    color: var(--apple-blue);
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
    flex-shrink: 0;
}

.attach-btn:hover {
    transform: scale(1.1);
}

.message-input {
    flex: 1;
    border: none;
    outline: none;
    font-size: 16px;
    font-family: inherit;
    background: transparent;
    color: var(--apple-text);
    min-width: 0;
}

.message-input::placeholder {
    color: var(--apple-text-secondary);
}

.send-btn {
    width: 44px;
    height: 44px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.send-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
}

.input-hint {
    text-align: center;
    font-size: 12px;
    color: var(--apple-text-secondary);
    margin-top: 12px;
}

/* ì²¨ë¶€ ë©”ë‰´ */
.attach-menu {
    position: fixed;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    padding: 8px;
    z-index: 1000;
}

.attach-menu.hidden {
    display: none;
}

.attach-menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    padding: 12px 16px;
    background: none;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    color: var(--apple-text);
    cursor: pointer;
    transition: background 0.2s;
}

.attach-menu-item:hover {
    background: rgba(0,0,0,0.05);
}

.attach-menu-item i {
    font-size: 20px;
    color: var(--apple-blue);
}

/* ëª¨ë‹¬ */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 20px;
}

.modal.hidden {
    display: none;
}

.modal-content {
    background: white;
    border-radius: 20px;
    width: 100%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    animation: modalIn 0.3s ease;
}

@keyframes modalIn {
    from {
        opacity: 0;
        transform: scale(0.95) translateY(20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--apple-border);
}

.modal-header h3 {
    font-size: 18px;
    font-weight: 600;
}

.modal-close {
    width: 32px;
    height: 32px;
    background: rgba(0,0,0,0.05);
    border: none;
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-body {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
}

.modal-footer {
    display: flex;
    gap: 12px;
    padding: 20px 24px;
    border-top: 1px solid var(--apple-border);
}

.modal-btn {
    flex: 1;
    padding: 14px;
    border: none;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 500;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s;
}

.modal-btn.primary {
    background: var(--apple-blue);
    color: white;
}

.modal-btn.primary:hover {
    background: var(--apple-blue-hover);
}

.modal-btn.secondary {
    background: rgba(0,0,0,0.05);
    color: var(--apple-text);
}

/* ì—‘ì…€ ë¶„ì„ ê²°ê³¼ í…Œì´ë¸” */
.excel-preview {
    margin-top: 16px;
    overflow-x: auto;
}

.excel-preview table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.excel-preview th, .excel-preview td {
    padding: 10px 12px;
    text-align: left;
    border-bottom: 1px solid var(--apple-border);
}

.excel-preview th {
    background: #f5f5f7;
    font-weight: 600;
    position: sticky;
    top: 0;
}

.excel-preview tr:hover {
    background: #f9f9fb;
}

.mapping-info {
    background: #e8f4fd;
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 16px;
}

.mapping-info p {
    margin: 0;
    font-size: 14px;
    color: #1a73e8;
}

.hidden {
    display: none !important;
}

/* ì• ë‹ˆë©”ì´ì…˜ */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ë°˜ì‘í˜• */
@media (max-width: 640px) {
    .welcome-section h1 {
        font-size: 26px;
    }

    .welcome-section p {
        font-size: 16px;
    }

    .quick-btn {
        padding: 12px 18px;
        font-size: 14px;
    }

    .upload-buttons {
        flex-direction: column;
    }

    .message {
        max-width: 92%;
    }

    .message-content {
        padding: 14px 16px;
        font-size: 14px;
    }

    .chat-form {
        padding: 6px 6px 6px 16px;
    }

    .send-btn {
        width: 40px;
        height: 40px;
    }

    .modal-content {
        max-height: 90vh;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatMessages = document.getElementById('chat-messages');
    const imageInput = document.getElementById('image-input');
    const excelInput = document.getElementById('excel-input');
    const attachBtn = document.getElementById('attach-btn');
    const attachMenu = document.getElementById('attach-menu');
    const filePreview = document.getElementById('file-preview');
    const previewImg = document.getElementById('preview-img');
    const previewFile = document.getElementById('preview-file');
    const previewFilename = document.getElementById('preview-filename');
    const removeFileBtn = document.getElementById('remove-file');
    const welcomeSection = document.querySelector('.welcome-section');

    // ëª¨ë‹¬
    const modal = document.getElementById('analysis-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalClose = document.getElementById('modal-close');
    const modalCancel = document.getElementById('modal-cancel');
    const modalConfirm = document.getElementById('modal-confirm');

    let currentFile = null;
    let currentFileType = null; // 'image' or 'excel'
    let currentAnalysis = null;

    // ë¹ ë¥¸ ì•¡ì…˜ ë²„íŠ¼
    document.querySelectorAll('.quick-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            messageInput.value = this.dataset.message;
            chatForm.dispatchEvent(new Event('submit'));
        });
    });

    // ì—…ë¡œë“œ ë²„íŠ¼
    document.getElementById('upload-excel-btn').addEventListener('click', () => excelInput.click());
    document.getElementById('upload-card-btn').addEventListener('click', () => imageInput.click());

    // ì²¨ë¶€ ë²„íŠ¼ í´ë¦­
    attachBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        const rect = attachBtn.getBoundingClientRect();
        attachMenu.style.left = rect.left + 'px';
        attachMenu.style.bottom = (window.innerHeight - rect.top + 10) + 'px';
        attachMenu.classList.toggle('hidden');
    });

    document.addEventListener('click', () => attachMenu.classList.add('hidden'));

    document.getElementById('attach-image').addEventListener('click', () => {
        imageInput.click();
        attachMenu.classList.add('hidden');
    });

    document.getElementById('attach-excel').addEventListener('click', () => {
        excelInput.click();
        attachMenu.classList.add('hidden');
    });

    // ì´ë¯¸ì§€ ì„ íƒ
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            currentFileType = 'image';
            const reader = new FileReader();
            reader.onload = function(e) {
                currentFile = e.target.result.split(',')[1];
                previewImg.src = e.target.result;
                previewImg.classList.remove('hidden');
                previewFile.classList.add('hidden');
                filePreview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    });

    // ì—‘ì…€ ì„ íƒ
    excelInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            currentFileType = 'excel';
            currentFile = file;
            previewFilename.textContent = file.name;
            previewFile.classList.remove('hidden');
            previewImg.classList.add('hidden');
            filePreview.classList.remove('hidden');
        }
    });

    // íŒŒì¼ ì œê±°
    removeFileBtn.addEventListener('click', function() {
        currentFile = null;
        currentFileType = null;
        imageInput.value = '';
        excelInput.value = '';
        filePreview.classList.add('hidden');
    });

    // ëª¨ë‹¬ ë‹«ê¸°
    modalClose.addEventListener('click', () => modal.classList.add('hidden'));
    modalCancel.addEventListener('click', () => modal.classList.add('hidden'));
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.classList.add('hidden');
    });

    // ë©”ì‹œì§€ ì¶”ê°€
    function addMessage(content, isUser = false, isRaw = false) {
        if (welcomeSection) {
            welcomeSection.style.display = 'none';
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;

        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.innerHTML = isUser ? '<i class="bi bi-person"></i>' : '<i class="bi bi-robot"></i>';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';

        if (isRaw) {
            contentDiv.innerHTML = content;
        } else {
            let html = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>')
                .replace(/- (.*?)(<br>|$)/g, 'â€¢ $1$2');
            contentDiv.innerHTML = html;
        }

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(contentDiv);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        return messageDiv;
    }

    // íƒ€ì´í•‘ í‘œì‹œ
    function showTyping() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message assistant';
        typingDiv.id = 'typing-indicator';
        typingDiv.innerHTML = `
            <div class="message-avatar"><i class="bi bi-robot"></i></div>
            <div class="message-content">
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTyping() {
        const typing = document.getElementById('typing-indicator');
        if (typing) typing.remove();
    }

    // ì—‘ì…€ ë¶„ì„
    async function analyzeExcel(file) {
        showTyping();
        addMessage(`<img src="" alt="ì—‘ì…€ íŒŒì¼"><br><strong>${file.name}</strong> ë¶„ì„ ì¤‘...`, false, true);

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/api/analyze-excel', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            hideTyping();

            if (data.error) {
                addMessage('ì—‘ì…€ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error);
                return;
            }

            currentAnalysis = {
                type: 'excel',
                file: file,
                data: data.analysis
            };

            // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
            const analysis = data.analysis;
            let resultHtml = `
                <div class="analysis-card">
                    <h4>ğŸ“Š ì—‘ì…€ ë¶„ì„ ì™„ë£Œ</h4>
                    <p style="margin-bottom: 16px; color: var(--apple-text-secondary);">${analysis.analysis}</p>
                    <div class="analysis-item">
                        <span class="analysis-label">ì´ ë°ì´í„° í–‰</span>
                        <span class="analysis-value">${analysis.total_rows}ëª…</span>
                    </div>
                    <div class="analysis-item">
                        <span class="analysis-label">ê°ì§€ëœ í•„ë“œ</span>
                        <span class="analysis-value">${Object.keys(analysis.mapping).filter(k => analysis.mapping[k] !== null).join(', ')}</span>
                    </div>
            `;

            if (analysis.sample_data && analysis.sample_data.length > 0) {
                resultHtml += `<h4 style="margin-top: 16px;">ìƒ˜í”Œ ë°ì´í„°</h4>`;
                analysis.sample_data.slice(0, 3).forEach(sample => {
                    resultHtml += `<div class="analysis-item">
                        <span class="analysis-label">${sample.name || 'ì´ë¦„ ì—†ìŒ'}</span>
                        <span class="analysis-value">${sample.phone || '-'}</span>
                    </div>`;
                });
            }

            resultHtml += `
                    <div class="analysis-actions">
                        <button class="analysis-btn secondary" onclick="cancelAnalysis()">ì·¨ì†Œ</button>
                        <button class="analysis-btn primary" onclick="confirmExcelImport()">ì „ì²´ ${analysis.total_rows}ëª… ë“±ë¡</button>
                    </div>
                </div>
            `;

            addMessage(resultHtml, false, true);

        } catch (error) {
            hideTyping();
            addMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ì´ë¯¸ì§€ ë¶„ì„
    async function analyzeImage(imageData) {
        showTyping();

        try {
            const response = await fetch('/api/analyze-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageData })
            });

            const data = await response.json();
            hideTyping();

            if (data.error) {
                addMessage('ì´ë¯¸ì§€ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error);
                return;
            }

            currentAnalysis = {
                type: 'image',
                imageData: imageData,
                data: data.analysis
            };

            const analysis = data.analysis;
            const extracted = analysis.extracted || {};

            let resultHtml = `
                <div class="analysis-card">
                    <h4>ğŸ“· ì´ë¯¸ì§€ ë¶„ì„ ì™„ë£Œ</h4>
                    <p style="margin-bottom: 16px; color: var(--apple-text-secondary);">${analysis.description}</p>
            `;

            if (analysis.type === 'portrait') {
                resultHtml += `<p>ì¸ë¬¼ ì‚¬ì§„ì…ë‹ˆë‹¤. êµì¸ í”„ë¡œí•„ë¡œ ë“±ë¡í•˜ë ¤ë©´ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>`;
            } else {
                // ì¶”ì¶œëœ ì •ë³´ í‘œì‹œ - ê¸°ë³¸ ì •ë³´
                const basicFields = [
                    ['ì´ë¦„', extracted.name],
                    ['ì „í™”ë²ˆí˜¸', extracted.phone],
                    ['ì£¼ì†Œ', extracted.address],
                    ['ìƒë…„ì›”ì¼', extracted.birth_date],
                    ['ì„±ë³„', extracted.gender],
                    ['ë“±ë¡ë²ˆí˜¸', extracted.registration_number]
                ];

                // êµíšŒ ê´€ë ¨ ì •ë³´
                const churchFields = [
                    ['ì´ì „êµíšŒ', extracted.previous_church],
                    ['ì´ì „êµíšŒ ì£¼ì†Œ', extracted.previous_church_address],
                    ['êµêµ¬', extracted.district],
                    ['ì†íšŒ', extracted.cell_group],
                    ['ì„ êµíšŒ', extracted.mission_group],
                    ['ë°”ë‚˜ë°”', extracted.barnabas],
                    ['ì¸ë„ì', extracted.referrer],
                    ['ì‹ ê¸‰', extracted.faith_level],
                    ['ì„¸ë¡€ì—°ë„', extracted.baptism_year],
                    ['ì„¸ë¡€êµíšŒ', extracted.baptism_church],
                    ['ë“±ë¡ë™ê¸°', extracted.registration_reason]
                ];

                // ê¸°íƒ€ ì •ë³´
                const otherFields = [
                    ['ì´ë©”ì¼', extracted.email],
                    ['ì§ì¥', extracted.company],
                    ['ì§ì±…', extracted.position],
                    ['ë©”ëª¨', extracted.notes]
                ];

                const allFields = [...basicFields, ...churchFields, ...otherFields];

                allFields.forEach(([label, value]) => {
                    if (value) {
                        // ë©”ëª¨ëŠ” ì—¬ëŸ¬ ì¤„ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¤„ë°”ê¿ˆ ì²˜ë¦¬
                        const displayValue = label === 'ë©”ëª¨' ? value.replace(/\n/g, '<br>') : value;
                        resultHtml += `<div class="analysis-item">
                            <span class="analysis-label">${label}</span>
                            <span class="analysis-value">${displayValue}</span>
                        </div>`;
                    }
                });

                if (extracted.name) {
                    resultHtml += `
                        <div class="analysis-actions">
                            <button class="analysis-btn secondary" onclick="cancelAnalysis()">ì·¨ì†Œ</button>
                            <button class="analysis-btn primary" onclick="confirmImageImport()">ì´ ì •ë³´ë¡œ ë“±ë¡</button>
                        </div>
                    `;
                }
            }

            resultHtml += `</div>`;
            addMessage(resultHtml, false, true);

        } catch (error) {
            hideTyping();
            addMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
    window.cancelAnalysis = function() {
        currentAnalysis = null;
        addMessage('ë¶„ì„ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    };

    window.confirmExcelImport = async function() {
        if (!currentAnalysis || currentAnalysis.type !== 'excel') return;

        showTyping();

        const formData = new FormData();
        formData.append('file', currentAnalysis.file);
        formData.append('mapping', JSON.stringify(currentAnalysis.data));

        try {
            const response = await fetch('/api/import-analyzed', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            hideTyping();

            if (data.error) {
                addMessage('ê°€ì ¸ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error);
            } else {
                addMessage(`âœ… **ë“±ë¡ ì™„ë£Œ!**\n\nâ€¢ ë“±ë¡: ${data.imported}ëª…\nâ€¢ ì¤‘ë³µ ìŠ¤í‚µ: ${data.skipped}ëª…${data.errors.length > 0 ? '\nâ€¢ ì˜¤ë¥˜: ' + data.errors.length + 'ê±´' : ''}`);
            }

            currentAnalysis = null;

        } catch (error) {
            hideTyping();
            addMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    };

    window.confirmImageImport = async function() {
        if (!currentAnalysis || currentAnalysis.type !== 'image') return;

        const extracted = currentAnalysis.data.extracted;
        if (!extracted.name) {
            addMessage('ì´ë¦„ ì •ë³´ê°€ ì—†ì–´ ë“±ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ì±„íŒ…ìœ¼ë¡œ ë“±ë¡ ìš”ì²­ - ëª¨ë“  í•„ë“œ í¬í•¨
        let registerMsg = `${extracted.name} ë“±ë¡í•´ì¤˜`;

        // ê¸°ë³¸ ì •ë³´
        if (extracted.phone) registerMsg += `, ì „í™”ë²ˆí˜¸ ${extracted.phone}`;
        if (extracted.gender) registerMsg += `, ì„±ë³„ ${extracted.gender}`;
        if (extracted.birth_date) registerMsg += `, ìƒë…„ì›”ì¼ ${extracted.birth_date}`;
        if (extracted.address) registerMsg += `, ì£¼ì†Œ ${extracted.address}`;

        // êµíšŒ ê´€ë ¨ ì •ë³´
        if (extracted.registration_number) registerMsg += `, ë“±ë¡ë²ˆí˜¸ ${extracted.registration_number}`;
        if (extracted.previous_church) registerMsg += `, ì´ì „êµíšŒ ${extracted.previous_church}`;
        if (extracted.previous_church_address) registerMsg += `, ì´ì „êµíšŒì£¼ì†Œ ${extracted.previous_church_address}`;
        if (extracted.district) registerMsg += `, êµêµ¬ ${extracted.district}`;
        if (extracted.cell_group) registerMsg += `, ì†íšŒ ${extracted.cell_group}`;
        if (extracted.mission_group) registerMsg += `, ì„ êµíšŒ ${extracted.mission_group}`;
        if (extracted.barnabas) registerMsg += `, ë°”ë‚˜ë°” ${extracted.barnabas}`;
        if (extracted.referrer) registerMsg += `, ì¸ë„ì ${extracted.referrer}`;
        if (extracted.faith_level) registerMsg += `, ì‹ ê¸‰ ${extracted.faith_level}`;

        // ë©”ëª¨ (ì—¬ëŸ¬ ì¤„ì¸ ê²½ìš° í•œ ì¤„ë¡œ)
        if (extracted.notes) {
            const notesOneLine = extracted.notes.replace(/\n/g, ' / ');
            registerMsg += `, ë©”ëª¨ ${notesOneLine}`;
        }

        messageInput.value = registerMsg;
        chatForm.dispatchEvent(new Event('submit'));
        currentAnalysis = null;
    };

    // í¼ ì œì¶œ
    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const message = messageInput.value.trim();

        // íŒŒì¼ì´ ìˆìœ¼ë©´ ë¶„ì„
        if (currentFile && currentFileType) {
            if (currentFileType === 'excel') {
                addMessage(`ğŸ“ ${currentFile.name}`, true);
                analyzeExcel(currentFile);
            } else if (currentFileType === 'image') {
                addMessage(`<img src="data:image/jpeg;base64,${currentFile}" style="max-width: 200px; border-radius: 12px;">`, true, true);
                analyzeImage(currentFile);
            }

            currentFile = null;
            currentFileType = null;
            imageInput.value = '';
            excelInput.value = '';
            filePreview.classList.add('hidden');
            messageInput.value = '';
            return;
        }

        if (!message) return;

        addMessage(message, true);
        messageInput.value = '';
        showTyping();

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message })
            });

            const data = await response.json();
            hideTyping();

            if (data.error) {
                addMessage('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error);
            } else {
                addMessage(data.response);
            }
        } catch (error) {
            hideTyping();
            addMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
    });

    // Enterë¡œ ì „ì†¡ (í•œê¸€ ì¡°í•© ì¤‘ì—ëŠ” ë¬´ì‹œ)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
            e.preventDefault();
            chatForm.dispatchEvent(new Event('submit'));
        }
    });
});
</script>
{% endblock %}
